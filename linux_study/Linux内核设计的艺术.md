# 从开机加电到执行main()函数之前的过程
## 启动BIOS，准备实模式下的中断向量表和中断服务程序
### BIOS的启动原理
0xFFFF0!!!
将CPU硬件逻辑设计为加电瞬间强行将CS的值置为0xF000、IP的值置为0xFFF0，这样CS:IP就指向0xFFFF0这个地址位置

注意：这是一个纯硬件完成的动作。BIOS程序的入口地址就是0xFFFF0！
也就是说，BIOS程序的第一条指令就设计在这个位置

### BIOS程序的具体运行过程
BIOS如何运行也是一本很厚的书，该文本仅讨论操作系统相关知识，故暂略

### BIOS在内存中加载中断向量表和中断服务程序
IP寄存器指向BIOS程序内存中的入口地址后，直接执行BIOS程序，BIOS除了开机自检外，做的比较重要的一件事就是
- BIOS 在内存的最开始位置（0x00000 到 0x003FF）设置中断向量表，(中断向量表中共每个中断向量占4字节，其中两个字节是CS值，两个字节是IP值)。每个中断向量都指向一个具体的中断服务程序
- 在紧挨着它的位置用256字节的内存空间构建BIOS数据区(0x00400~0x004FF)
- 并在大约57KB以后的位置(0x0E05B)加载了8KB左右的与中断向量表相应的若干中断服务程序


## 加载操作系统内核程序并为保护模式做准备
对于Linux 0.11操作系统而言，计算机将分为3批逐次加载操作系统的内核代码

- 第一批由BIOS中断int 0x19(即中断向量表的0x19，对应第25个中断向量)把第一扇区bootsect的内容加载到内存
- 第二批、第三批在bootsect的指挥下，分别把其中的4个扇区和随后的240个扇区的内容加载至内存

### 加载第一部分内核代码 -- 引导程序
在BIOS完成自检，并让CPU接受到一个int 0x19中断，CPU接收到这个中断后，会立即在中断向量表找到int 0x19
接下来，中断向量把CPU指向0x0E6F2，这个位置就是int 0x19相对应的中断服务程序的入口地址，即“启动加载服务程序的”入口地址，这个中断服务程序的作用就是把硬盘第一个扇区中的程序(512B)加载到内存中的指定位置。
这个中断服务程序的功能是BIOS事先设计好的，代码是固定的，与Linux操作系统无关

```shell
# 这段BIOS程序要做的就是找到硬盘并加载第一扇区
```

硬盘第一扇区（启动扇区）的程序就是bootsect/boot
第一扇区中的程序由bootsect.s中的汇编程序编写而成，`这是计算机自开机以来，内存中第一次有Linux操作系统自己的代码`


### 加载第二部分内核代码 -- setup
bootsect也就是引导程序的作用就是把第二批和第三批程序陆续加载到内存中的适当位置，因此bootsect首先做的工作就是规划内存

#### 内存规划
实模式下，寻址的最大范围是1MB。为了规划内存，bootsect首先设计如下代码
```asm
//代码路径 boot/bootsect.s
    。global begtext, begdata,
```

#### 将setup程序加载到内存中
加载setup这个程序，要借助BIOS提供的int 0x13中断向量所指向的中断服务程序(也就是磁盘服务程序)来完成。

加载setup程序是做的内存规划中，SS:SP指向的位置0x9FF00，这与setup程序的起始位置还有很大的距离，即便setup加载进来后，系统仍有足够的内存空间用来执行数据压栈操作；这里操作系统设计者进行过精密测算

#### 加载第三部分内核代码 -- system模块
仍使用BIOS提供的int 0x13中断，bootsect程序执行第三批程序的载入工作，即将系统模块（system）载入内存

之后执行由main函数开始的使用C语言编写的操作系统内核程序，和加载setup程序不同的是，这次一次加载240个扇区，而非之前的4个扇区

为了防止加载期间用户误认为机器故障而执行不适当操作，会在屏幕显示一段“Load System”以提示用户计算机此时正在加载系统
- 使用汇编代码实现
- 从体系结构的角度看，显示器也是一个外设，所以还要用到其他的BIOS中断

bootsect借着BIOS中断int 0x13，将240个扇区的system模块记载到内存
- 加载工作由bootsect调用read_it子程序完成
    - read_it子程序将第六扇区开始的约240个扇区的system模块加载至内存的SYSSEG(0x10000)处往后的120KB空间中

bootsect主体工作做完后，需要再次确定根设备号

经过一系列检测，确认计算机中实际安装的硬盘驱动器为根设备，并将信息吸入机器系统数据（后续的main函数一开始就用机器系统数据中的这个信息设置根设备，并为"根文件系统"加载奠定基础）





## head.s开始执行
在执行main函数之前，先要执行三个由汇编代码生成的程序，即
- bootsect
- setup
- head


简化步骤：
- (中断向量表->中断服务)加载bootsect到0x07C00，然后复制到0x90000
- 加载setup到0x90200
- 加载head.s
    - 将head.s汇编成目标代码
    - 将用C语言编写的内核程序编译成目标代码
    - 然后链接成systemd模块（system模块里面既有内核程序，又有head程序）

