# CKAè¯¦è§£



## Kubernetesæ¦‚è¿°

### ä¼ ç»Ÿè¿ç»´ç—›ç‚¹



- **è™šæ‹Ÿæœºèµ„æºæµªè´¹**
- **è¿ç»´ç®¡ç†å¤æ‚**
- **æ‰©ç¼©å®¹ä½æ•ˆ**
- **æœåŠ¡éš”ç¦»å·®**



åœ¨ä¼ ç»ŸæœåŠ¡ç®¡ç†æ¨¡å¼ä¸‹ï¼Œä¸ºäº†é¿å…æœåŠ¡é—´ç¯å¢ƒç›¸äº’å¹²æ‰°ï¼Œé€šå¸¸é‡‡ç”¨**ä¸€å°è™šæ‹Ÿæœºåªéƒ¨ç½²ä¸€ä¸ªæœåŠ¡æˆ–ä¸€ç»„å¼ºç›¸å…³æœåŠ¡**çš„ç­–ç•¥ï¼Œå€ŸåŠ©è™šæ‹Ÿæœºçº§åˆ«çš„éš”ç¦»æ¥ä¿éšœæœåŠ¡ç¨³å®šè¿è¡Œã€‚
 ç„¶è€Œï¼Œè¿™ç§æ–¹å¼çš„**ä»£ä»·å·¨å¤§**ï¼š

- **èµ„æºæµªè´¹**ï¼šæ¯ä¸ªè™šæ‹Ÿæœºéƒ½éœ€è¦å•ç‹¬åˆ†é…å†…æ ¸å’Œç³»ç»Ÿèµ„æºï¼Œé€ æˆå¤§é‡å†—ä½™ã€‚
- **è¿ç»´å¤æ‚**ï¼šæœåŠ¡çš„éƒ¨ç½²ã€æ‰©å®¹ã€è®¿é—®æ§åˆ¶ã€æƒé™ç®¡ç†ç­‰æ“ä½œé«˜åº¦ä¾èµ–äººå·¥å¹²é¢„ï¼Œæ•ˆç‡ä½ä¸‹ä¸”æ˜“å‡ºé”™ã€‚



Kubernetes æ­£æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œè®¾è®¡çš„ã€‚ 



### Kubernetesæ˜¯ä»€ä¹ˆï¼Ÿ

é¢å‘åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„â€œäº‘åŸç”Ÿæ“ä½œç³»ç»Ÿâ€ã€‚



### Kubernetesè¦è§£å†³çš„é—®é¢˜

è¿è¡Œåœ¨å¤§è§„æ¨¡é›†ç¾¤ä¸­çš„å„ç§ä»»åŠ¡ä¹‹é—´ï¼Œå®é™…å­˜åœ¨å„ç§å„æ ·çš„å…³ç³»ã€‚è¿™äº›å…³ç³»çš„å¤„ç†ï¼Œæ‰æ˜¯ä½œä¸šç¼–æ’å’Œç®¡ç†ç³»ç»Ÿæœ€å›°éš¾çš„åœ°æ–¹

å…¶å®è¿™ç§ä»»åŠ¡ä¸ä»»åŠ¡ä¹‹é—´çš„å…³ç³»ï¼Œåœ¨æˆ‘ä»¬å¹³å¸¸çš„å„ç§æŠ€æœ¯åœºæ™¯ä¸­éšå¤„å¯è§ã€‚æ¯”å¦‚ï¼š

- ä¸€ä¸ªwebåº”ç”¨ä¸æ•°æ®åº“ä¹‹é—´çš„è®¿é—®å…³ç³»
- ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨å’Œå®ƒåç«¯æœåŠ¡ä¹‹é—´çš„ä»£ç†å…³ç³»
- ä¸€ä¸ªé—¨æˆ·åº”ç”¨ä¸æˆæƒç»„ä»¶ä¹‹é—´çš„è°ƒç”¨å…³ç³»



Kubernetesè¢«è¦æ±‚èƒ½å¤Ÿå¤„ç†å‰é¢æåˆ°çš„æ‰€æœ‰ç±»å‹çš„å…³ç³»ï¼Œç”šè‡³è¿˜è¦èƒ½å¤Ÿæ”¯æŒæœªæ¥å¯èƒ½å‡ºç°çš„æ›´å¤šç§ç±»çš„å…³ç³»

Kubernetesé¡¹ç›®æœ€ä¸»è¦çš„è®¾è®¡æ€æƒ³æ˜¯ï¼Œä»æ›´å®è§‚çš„è§’åº¦ï¼Œä»¥ç»Ÿä¸€çš„æ–¹å¼æ¥å®šä¹‰ä»»åŠ¡ä¹‹é—´çš„å„ç§å…³ç³»ï¼Œå¹¶ä¸”ä¸ºå°†æ¥æ”¯æŒæ›´å¤šç§ç±»çš„å…³ç³»ç•™æœ‰ä½™åœ°

| å…³ç³»ç±»å‹                  | ç›¸å…³å¯¹è±¡                                              |
| ------------------------- | ----------------------------------------------------- |
| **ä¸é…ç½®çš„å…³ç³»**          | ConfigMapã€Secret                                     |
| **ä¸å­˜å‚¨çš„å…³ç³»**          | PVã€PVCã€StorageClass                                 |
| **ä¸è®¿é—®è·¯å¾„çš„å…³ç³»**      | Serviceã€Ingressã€NetworkPolicy                       |
| **ä¸è®¡ç®—èµ„æºçš„å…³ç³»**      | Deploymentã€HPAã€Affinityã€ResourceQuota              |
| **ä¸èº«ä»½æƒé™çš„å…³ç³»**      | ServiceAccountã€RBACï¼ˆRole/RoleBindingï¼‰              |
| **ä¸ç”Ÿå‘½å‘¨æœŸæ§åˆ¶çš„å…³ç³»**  | LivenessProbeã€StartupProbeã€Jobã€CronJob             |
| **ä¸ç½‘ç»œç­–ç•¥/å®‰å…¨çš„å…³ç³»** | NetworkPolicyã€PodSecurityPolicyï¼ˆå·²åºŸå¼ƒï¼Œæ›¿ä»£ä¸ºPSAï¼‰ |
| **ä¸å¤–éƒ¨é›†æˆ/æ‰©å±•çš„å…³ç³»** | CRDã€Webhookã€Operatorã€Controller                    |



- Kubernetes çš„**è®¾è®¡ç›®çš„**å¯ä»¥æ¦‚æ‹¬ä¸ºä¸¤å¤§éƒ¨åˆ†ï¼š

  1. **åŸºäºåº”ç”¨è¿è¡Œå½¢æ€ï¼Œæä¾›å¯¹ Pod ç”Ÿå‘½å‘¨æœŸçš„ç»Ÿä¸€ç®¡ç†èƒ½åŠ›** â€”â€” ä½¿åº”ç”¨å…·å¤‡å£°æ˜å¼ã€å¯ç¼–æ’ã€å¯ä¼¸ç¼©ã€å¯æ¢å¤çš„è¿è¡Œä¿éšœã€‚
  2. **å›´ç»• Pod å»ºæ¨¡å¹¶ç®¡ç†å…¶ä¸å¤–éƒ¨ç¯å¢ƒçš„æ‰€æœ‰åŠ¨æ€å…³ç³»** â€”â€” åŒ…æ‹¬ä¸é…ç½®ã€å­˜å‚¨ã€ç½‘ç»œã€è®¿é—®ç­–ç•¥ã€å®‰å…¨æƒé™ã€èµ„æºè°ƒåº¦ç­‰å„ç±»åŸºç¡€è®¾æ–½èƒ½åŠ›çš„è¿æ¥ä¸æ²»ç†ï¼ŒåŒæ—¶ä¸ºæœªæ¥æ›´å¤šå…³ç³»é¢„ç•™ç»Ÿä¸€æ‰©å±•å…¥å£ã€‚

  

### Kubernetesæ¶æ„



![alt text](D:\git_repository\cyber_security_learning\markdown_img\image15.png)



Kubernetes æ˜¯è¿è¡Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šçš„ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿå†…æ ¸ï¼Œå®ƒå°†ä¸€ç»„æ™®é€šç‰©ç†æˆ–è™šæ‹ŸæœºæŠ½è±¡ä¸ºä¸€ä¸ªç»Ÿä¸€çš„èµ„æºæ± ã€‚ç›¸æ¯”ä¼ ç»Ÿæ“ä½œç³»ç»Ÿï¼ŒKubernetes å®ç°äº†å®¹å™¨ç²’åº¦çš„èµ„æºè°ƒåº¦ã€æœåŠ¡æ²»ç†ã€è‡ªæ„ˆæ¢å¤ç­‰èƒ½åŠ›ï¼ŒæŸç§ç¨‹åº¦ä¸Šï¼Œå®ƒæ˜¯é¢å‘ç°ä»£äº‘åº”ç”¨çš„æ›´é«˜ä¸€çº§â€˜æ“ä½œç³»ç»Ÿã€‚

å°±åƒä¼ ç»Ÿæ“ä½œç³»ç»Ÿè°ƒåº¦è¿›ç¨‹å’Œçº¿ç¨‹ä¸€æ ·ï¼ŒKubernetes è°ƒåº¦çš„æ˜¯ Podï¼›å®ƒä¸ä»…è°ƒåº¦ï¼Œè¿˜è´Ÿè´£çŠ¶æ€ç®¡ç†ã€æœåŠ¡å‘ç°ã€æ»šåŠ¨å‡çº§ç­‰ï¼Œæ˜¯ç°ä»£äº‘åŸç”Ÿåº”ç”¨è¿è¡Œçš„ç»Ÿä¸€ç®¡ç†å¹³å°ã€‚



Kubernetes**é›†ç¾¤åˆ†ä¸ºä¸¤ä¸ªè§’è‰²**ï¼Œåˆ†åˆ«æ˜¯MasterèŠ‚ç‚¹å’ŒWorkerèŠ‚ç‚¹

åœ¨ Kubernetes ä¸­ï¼ŒMaster èŠ‚ç‚¹è´Ÿè´£ç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼Œå› æ­¤è¢«ç§°ä¸ºæ§åˆ¶å¹³é¢ï¼ˆControl Planeï¼‰ã€‚å®ƒè´Ÿè´£è°ƒåº¦ã€é›†ç¾¤çŠ¶æ€ç»´æŠ¤ã€èµ„æºåè°ƒç­‰æ ¸å¿ƒä»»åŠ¡ã€‚è€Œé›†ç¾¤ä¸­å®é™…è¿è¡Œç”¨æˆ·åº”ç”¨ï¼ˆå¦‚ Web æœåŠ¡ã€æ•°æ®åº“ã€åå°ä»»åŠ¡ç­‰ï¼‰çš„ Podï¼Œé€šå¸¸è°ƒåº¦éƒ¨ç½²åœ¨ Worker èŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå«æ•°æ®å¹³é¢ã€‚

```ABAP
å¯ä»¥ç†è§£ä¸ºï¼šMaster æ˜¯ Kubernetes çš„â€˜å¤§è„‘â€™ï¼Œè€Œ Worker æ˜¯â€˜æ‰‹å’Œè„šâ€™ï¼Œæ§åˆ¶å¹³é¢åšå†³ç­–ï¼Œæ•°æ®å¹³é¢å»æ‰§è¡Œè¿™äº›å†³ç­–ã€‚
```



### MasterèŠ‚ç‚¹ä»‹ç»

#### **ApiServer**

**API Server æ˜¯ Kubernetes çš„â€œå‰é—¨â€å’Œâ€œå¤§è„‘â€**

- æ‰€æœ‰ç»„ä»¶ï¼ˆcontroller-managerã€schedulerã€kubeletã€kubectlï¼‰éƒ½**ä¸èƒ½ç»•è¿‡ API Server**è¿›è¡Œé€šä¿¡ï¼›
- å®ƒæ˜¯**å”¯ä¸€å…è®¸è¯»å†™ etcd çš„ç»„ä»¶**ï¼›
- å®ƒæ˜¯æ•´ä¸ªé›†ç¾¤çš„**çŠ¶æ€æ€»çº¿**ï¼Œç»´æŒç€â€œ**æœŸæœ›çŠ¶æ€**â€ï¼ˆç”¨æˆ·æäº¤ï¼‰å’Œâ€œ**å®é™…çŠ¶æ€**â€ï¼ˆç»„ä»¶ä¸ŠæŠ¥ï¼‰çš„ä¸€è‡´æ€§ã€‚



**API Server ç”¨äºæ„å»ºKuberneteså®‰å…¨è¾¹ç•Œ**

åœ¨ Kubernetes ä¸­ï¼ŒAPI Server æ˜¯é›†ç¾¤ä¸­æ‰€æœ‰é€šä¿¡çš„å”¯ä¸€å…¥å£ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€ç»´æŠ¤ API Server çš„è¯ä¹¦ä½“ç³»ã€‚ç»„ä»¶é€šè¿‡ TLS æˆ– Token æ–¹å¼ä¸ API Server å»ºç«‹é€šä¿¡ï¼Œè€Œ API Server åˆ™ç»Ÿä¸€è´Ÿè´£æ‰€æœ‰è¯·æ±‚çš„è®¤è¯ã€æˆæƒå’Œå‡†å…¥æ§åˆ¶ï¼Œä»è€Œæ„å»ºèµ· Kubernetes å®‰å…¨è¾¹ç•Œçš„æ ¸å¿ƒæ¡†æ¶



**æä¾› Watch æœºåˆ¶ä»¥å®ç°å®æ—¶å˜æ›´æ¨é€**

- kube-apiserver æ”¯æŒç»„ä»¶å‘èµ· `watch` è¯·æ±‚ï¼Œå®ƒä¼šå°† etcd ä¸­çš„å˜æ›´ä»¥æµå¼äº‹ä»¶æ¨é€å‡ºå»ï¼›
- æ‰€æœ‰ controllerã€kubeletã€operator ç­‰ç»„ä»¶éƒ½ä¾èµ–è¿™ä¸ªæœºåˆ¶è¿›è¡ŒçŠ¶æ€ç›‘å¬ã€‚



#### Scheduler

**Kubernetes Scheduler** æ˜¯æ§åˆ¶é¢ç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£å°†å°šæœªåˆ†é…èŠ‚ç‚¹çš„ Pod ç»‘å®šåˆ°é›†ç¾¤ä¸­æœ€åˆé€‚çš„èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚

å®ƒçš„æœ¬è´¨æ˜¯ä¸€ä¸ª **å†³ç­–å™¨**ï¼šæ ¹æ® Pod çš„èµ„æºéœ€æ±‚ã€è°ƒåº¦ç­–ç•¥å’Œé›†ç¾¤çš„å½“å‰çŠ¶æ€ï¼Œåšå‡ºâ€œ**æ”¾å“ªå„¿è¿è¡Œæœ€åˆé€‚**â€çš„å†³ç­–ã€‚



#### Controller-Manager

**Kube-controller-manager** æ˜¯ Kubernetes çš„è‡ªåŠ¨åŒ–æ‰§è¡Œå¼•æ“ã€‚å®ƒé€šè¿‡ä¸€ç³»åˆ—æ§åˆ¶å™¨ï¼Œå›´ç»•é›†ç¾¤ä¸­å„ç§èµ„æºï¼ˆPodã€Nodeã€PVCã€Deployment ç­‰ï¼‰æŒç»­æ‰§è¡ŒçŠ¶æ€å¯¹æ¯”å’Œçº åæ“ä½œã€‚åªè¦ç”¨æˆ·å£°æ˜äº†æœŸæœ›ï¼Œæ§åˆ¶å™¨å°±ä¼šè‡ªåŠ¨ã€æŒç»­åœ°å°†å®é™…çŠ¶æ€å‘ç›®æ ‡çŠ¶æ€é€¼è¿‘ï¼Œä»è€Œå®ç°çœŸæ­£çš„è‡ªæ„ˆã€è‡ªåŠ¨æ‰©ç¼©ã€æ»šåŠ¨æ›´æ–°ç­‰é«˜çº§åŠŸèƒ½



#### etcd

`etcd` æ˜¯ Kubernetes çš„å”¯ä¸€æŒä¹…åŒ–å­˜å‚¨åç«¯ï¼Œè´Ÿè´£ä¿å­˜æ•´ä¸ªé›†ç¾¤çš„æ‰€æœ‰çŠ¶æ€æ•°æ®ï¼ˆå…ƒæ•°æ®ï¼‰ã€‚





### WorkerèŠ‚ç‚¹ä»‹ç»

#### Kuber-proxy

`kube-proxy` æ˜¯ Kubernetes ä¸­ç”¨äºå®ç° `Service` è™šæ‹Ÿ IPï¼ˆClusterIPï¼‰è®¿é—®èƒ½åŠ›çš„ç»„ä»¶ã€‚å®ƒé€šè¿‡ç›‘å¬é›†ç¾¤ä¸­çš„ `Service` å’Œ `Endpoints` å˜åŒ–ï¼Œç”Ÿæˆç½‘ç»œè½¬å‘è§„åˆ™ï¼ˆåŸºäº `iptables` æˆ– `ipvs`ï¼‰ï¼Œå¹¶å°†è¿™äº›è§„åˆ™åŠ è½½åˆ° Linux å†…æ ¸ç½‘ç»œæ ˆä¸­ï¼Œå®ç°å®¢æˆ·ç«¯è®¿é—® `Service IP` æ—¶ï¼Œèƒ½å¤Ÿè‡ªåŠ¨è´Ÿè½½å‡è¡¡è½¬å‘åˆ°åç«¯ Podã€‚



 **å·¥ä½œæœºåˆ¶ï¼šæ ¸å¿ƒæµç¨‹**

1. **Watch API Server**
   - ç›‘å¬ `Service` å’Œ `Endpoints` çš„å˜åŒ–
2. **ç”Ÿæˆè§„åˆ™**
   - æ ¹æ®ç›‘å¬åˆ°çš„èµ„æºï¼Œæ„é€ è½¬å‘è§„åˆ™ï¼ˆå¦‚ iptables æˆ– IPVSï¼‰
3. **ä¸‹å‘åˆ°å†…æ ¸**
   - åˆ©ç”¨ Linux å†…æ ¸å®ç°æ•°æ®åŒ…è½¬å‘ï¼ˆiptables æˆ– IPVS æ¨¡å—ï¼‰



 **kube-proxy ä¸æ˜¯ Service çš„åˆ›å»ºè€…ï¼Œè€Œæ˜¯è½¬å‘è§„åˆ™çš„ç”Ÿæˆè€…**

- Service å’Œ Endpoints ç”± kube-apiserver ç®¡ç†ï¼›
- kube-proxy åªæ˜¯**æ ¹æ®å®ƒä»¬ç”Ÿæˆè½¬å‘è§„åˆ™**ï¼›
- å®ƒå¹¶ä¸ç›´æ¥åˆ›å»ºç½‘ç»œè®¾å¤‡æˆ–è™šæ‹Ÿæ¥å£ã€‚



#### kubelet

kubelet æ˜¯ Kubernetes æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„æ ¸å¿ƒ agentï¼Œè´Ÿè´£ä¸ API Server é€šä¿¡ï¼Œå¹¶é€šè¿‡è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶ï¼ˆå¦‚ containerdã€Dockerï¼‰æ¥ç®¡ç†è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰ Pod çš„ç”Ÿå‘½å‘¨æœŸã€‚



### Kubernetes å…¸å‹å·¥ä½œæµï¼šä» Deployment åˆ°åº”ç”¨å¯¹å¤–è®¿é—®

**åˆ›å»º Deploymentï¼ˆæè¿°æœŸæœ›çŠ¶æ€ï¼‰**

- ç”¨æˆ·ä½¿ç”¨ YAML å®šä¹‰ Deployment èµ„æºï¼ŒæŒ‡å®šå‰¯æœ¬æ•°ã€é•œåƒã€ç«¯å£ç­‰ã€‚
- ä½¿ç”¨**Kubectl**å®¢æˆ·ç«¯å·¥å…·å°†ä¿¡æ¯æäº¤ç»™ **Kubernetes API Server**ã€‚
- **API Server** è®°å½•åˆ° **etcd**ã€‚
- **Controller Manager** ç›‘æ§åˆ°æœŸæœ›å‰¯æœ¬ 3ã€‚



**è°ƒåº¦åˆ°å…·ä½“ Node**

- **Kube-Scheduler** ç›‘å¬æœªè°ƒåº¦çš„ Podã€‚
- é€‰æ‹©åˆé€‚çš„ Nodeï¼ˆåŸºäºèµ„æºã€æ±¡ç‚¹ã€äº²å’Œæ€§ç­‰ï¼‰ã€‚
- å°†è°ƒåº¦ç»“æœåŒæ­¥åˆ°**API Server**ï¼Œç„¶åæ›´æ–°åˆ° **etcd**ã€‚



**Node æœ¬åœ°åˆ›å»º Pod**

- **Kubelet** ç›‘å¬åˆ°è‡ªå·± Node ä¸Šåˆ†é…çš„ Podã€‚

- è°ƒç”¨ **Container Runtime** æ‹‰å–é•œåƒï¼Œåˆ›å»ºå®¹å™¨ã€‚

- è®¾ç½® **cgroupã€namespace** å®ç°èµ„æºéš”ç¦»ã€‚



**åŠ å…¥å®¹å™¨ç½‘ç»œï¼ˆCNIï¼‰**

- **Kubelet** è°ƒç”¨ **CNI æ’ä»¶**ï¼ˆå¦‚ Calico/Flannelï¼‰ï¼š
  - åˆ†é… Pod IPã€‚
  - å°† Pod æ¥å…¥ Overlay ç½‘ç»œã€‚
  - ç”Ÿæˆè·¯ç”±è§„åˆ™ï¼Œä¿éšœ Pod åˆ° Pod é€šä¿¡ã€‚



**é€šè¿‡ Service æš´éœ²è®¿é—®å…¥å£**

- åˆ›å»º Service èµ„æºï¼Œ**kubectl**å°†serviceèµ„æºå‘é€ç»™**apiServer**ï¼Œ**åœ¨apiserverä¸Šç”Ÿæˆèµ„æºå¯¹è±¡**
- **Kube-Proxy** ç›‘å¬ Service å˜åŒ–ï¼Œé…ç½® iptables æˆ– IPVS è§„åˆ™ï¼Œå®ç° **è´Ÿè½½å‡è¡¡**ã€‚



**DNS åç§°è§£æï¼ˆCoreDNSï¼‰**

- CoreDNS ç›‘å¬ Service èµ„æºï¼Œè‡ªåŠ¨ç”Ÿæˆè§£æè®°å½•ï¼š
  - ä¾‹å¦‚ `my-app-svc.default.svc.cluster.local` è§£æä¸º ClusterIPã€‚
- Pod å†…è§£ææ—¶ï¼š
  - æŸ¥è¯¢ CoreDNSã€‚
  - è¿”å› ClusterIPã€‚





### Kubernetesæ‰©å±•æ¥å£

Kubernetesæä¾›äº†ä¸‰ä¸ªç‰¹å®šåŠŸèƒ½çš„æ¥å£,kubernetesé€šè¿‡è°ƒç”¨è¿™å‡ ä¸ªæ¥å£ï¼Œæ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ã€‚

- **å®¹å™¨è¿è¡Œæ—¶æ¥å£CRI**: Container Runtime Interface 

  - CRI é¦–æ¬¡å‘å¸ƒäº2016å¹´12æœˆçš„Kubernetes 1.5 ç‰ˆæœ¬ã€‚ 

  - åœ¨æ­¤ç‰ˆæœ¬ä¹‹å‰ï¼ŒKubernetes ç›´æ¥ä¸ Docker é€šä¿¡ï¼Œæ²¡æœ‰æ ‡å‡†åŒ–çš„æ¥å£ã€‚ 

  - ä» Kubernetes 1.5 å¼€å§‹ï¼ŒCRI æˆä¸º Kubernetes ä¸å®¹å™¨è¿è¡Œæ—¶äº¤äº’çš„æ ‡å‡†æ¥å£ï¼Œä½¿å¾— Kubernetes  å¯ä»¥ä¸å„ç§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œé€šä¿¡ï¼Œä»è€Œå¢åŠ äº†çµæ´»æ€§å’Œå¯ç§»æ¤æ€§ã€‚

  - kubernetes å¯¹äºå®¹å™¨çš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯é¢„ç•™äº†å®¹å™¨æ¥å£ï¼Œåªè¦ç¬¦åˆCRIæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥ä½¿ç”¨

- **å®¹å™¨ç½‘ç»œæ¥å£CN**I: Container Network Interface
  - kubernetes å¯¹äºç½‘ç»œçš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯é¢„ç•™äº†ç½‘ç»œæ¥å£ï¼Œåªè¦ç¬¦åˆCNIæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥ä½¿ç”¨
- **å®¹å™¨å­˜å‚¨æ¥å£CSI:** Container Storage Interface
  - kubernetes å¯¹äºå­˜å‚¨çš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯é¢„ç•™äº†å­˜å‚¨æ¥å£ï¼Œåªè¦ç¬¦åˆCSIæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥ä½¿ç”¨ æ­¤æ¥å£éå¿…é¡»



### Kubernetesä¸­çš„é€šä¿¡

åœ¨ Kubernetes ä¸­ï¼ŒProtobuf å’Œ JSON æ˜¯ä¸¤ç§**åºåˆ—åŒ–åè®®**ï¼Œåˆ†åˆ«ç”¨äºå†…éƒ¨ç»„ä»¶é«˜æ•ˆé€šä¿¡å’Œå¤–éƒ¨ç”¨æˆ·äº¤äº’ã€‚è€Œè¿™äº›åºåˆ—åŒ–åçš„æ•°æ®ï¼Œé€šå¸¸é€šè¿‡ HTTP æˆ– HTTP/2 åè®®ä¼ è¾“ã€‚

åœ¨ Kubernetes ä¸­ï¼Œkubectl é»˜è®¤é€šè¿‡ HTTP/1.1 ä¸ API Server é€šä¿¡ï¼Œè€Œå†…éƒ¨ç»„ä»¶åˆ™é€šå¸¸é€šè¿‡æ”¯æŒ HTTP/2 çš„ client-go ä¸ API Server é€šä¿¡ã€‚å½“å®ƒä»¬ä½¿ç”¨ Watch æœºåˆ¶ç›‘å¬èµ„æºå˜åŒ–æ—¶ï¼Œä¸è®ºæ˜¯ HTTP/1.1 è¿˜æ˜¯ HTTP/2ï¼Œéƒ½èƒ½å»ºç«‹æµå¼å“åº”ï¼Œåªä¸è¿‡ HTTP/2 åœ¨æ€§èƒ½ä¸Šæ›´ä¼˜

```ABAP
åºåˆ—åŒ–ï¼šæŠŠç¨‹åºä¸­çš„æ•°æ®ç»“æ„æˆ–å¯¹è±¡è½¬æ¢ä¸ºå¯ä»¥å­˜å‚¨æˆ–ä¼ è¾“çš„æ ¼å¼ï¼ˆå¦‚å­—ç¬¦ä¸²æˆ–äºŒè¿›åˆ¶æµï¼‰çš„è¿‡ç¨‹ã€‚
```



**Kubernetes çš„ API é€šä¿¡æœ€å¸¸ä½¿ç”¨çš„æ˜¯ï¼š**

- **HTTP/1.1**ï¼ˆé»˜è®¤æœ€å¹¿æ³›æ”¯æŒï¼‰
- **HTTP/2**ï¼ˆåœ¨ä½¿ç”¨ gRPC æˆ– Watch æ—¶æ”¯æŒï¼Œæå‡å¤šè·¯å¤ç”¨æ€§èƒ½ï¼‰

ä¾‹å¦‚ï¼š

- `kubelet` ä¸ `kube-apiserver` ä½¿ç”¨ **HTTP/2 + Protobuf**
- `kubectl` ä¸ `kube-apiserver` ä½¿ç”¨ **HTTP/1.1 + JSON**



#### é€šä¿¡ä¸­çš„å®‰å…¨æœºåˆ¶

**Kubernetesé›†ç¾¤ä¸­æœ‰ä¸‰å¥—CAæœºåˆ¶**

- **etcd-ca**        ETCDé›†ç¾¤å†…éƒ¨çš„TLSé€šä¿¡
- **kubernetes-ca**    Kubernetesé›†ç¾¤å†…éƒ¨èŠ‚ç‚¹é—´çš„åŒå‘TLSé€šä¿¡
- **front-proxy-ca**    Kubernetesé›†ç¾¤ä¸å¤–éƒ¨æ‰©å±•æœåŠ¡ç®€å•åŒå‘TLSé€šä¿¡





### Kerbernetesçš„è¿ç»´å·¥ä½œ

- **ä¸šåŠ¡çš„è¿è¡Œ**ï¼šåº”ç”¨å‘å¸ƒä¸éƒ¨ç½²
  - ä¸»è¦åŒ…æ‹¬ï¼šé•œåƒæ„å»ºï¼ŒPodç¼–æ’ï¼ˆDeploymentï¼ŒStatefulSetç­‰ï¼‰ï¼ŒCICDæµç¨‹

- **å¤–éƒ¨ç”¨æˆ·çš„è®¿é—®**ï¼šæµé‡å…¥å£ä¸æœåŠ¡æ²»ç†
  - ä¸»è¦åŒ…æ‹¬ï¼šIngress/Nginxï¼ŒLoadBalancerï¼ŒGatewayAPIï¼ŒæœåŠ¡å‘ç°ï¼Œæ¢å¤å‘å¸ƒï¼Œé™æµç†”æ–­ç­‰
- **è°ƒåº¦ä¸šåŠ¡è¿è¡Œæ‰€éœ€èµ„æº**ï¼šèµ„æºç¼–æ’ä¸è°ƒåº¦
  - ä¸»è¦åŒ…æ‹¬ï¼šèŠ‚ç‚¹è°ƒåº¦ï¼ˆPod Schedulingï¼‰ã€äº²å’Œæ€§ï¼ˆAffinityï¼‰ã€Taint/Tolerationã€èµ„æºé™åˆ¶ã€HPA/VPA
- **è¿ç»´ä¿éšœæœåŠ¡**ï¼šå¯è§‚æµ‹æ€§
  - ä¸»è¦åŒ…æ‹¬ï¼šæ—¥å¿—ï¼ŒæŒ‡æ ‡ç›‘æ§ï¼Œé“¾è·¯è·Ÿè¸ª



---

## 1. HPA

### 1.1 ä»€ä¹ˆæ˜¯ HPAï¼Ÿ

**HPAï¼ˆHorizontal Pod Autoscalerï¼Œæ°´å¹³è‡ªåŠ¨æ‰©ç¼©å®¹ï¼‰**  

æ˜¯ Kubernetes ä¸­ç”¨äº **æ ¹æ®è¿è¡Œæ—¶è´Ÿè½½æƒ…å†µï¼Œè‡ªåŠ¨è°ƒæ•´ Pod å‰¯æœ¬æ•°é‡** çš„æ§åˆ¶å™¨ã€‚

- **Horizontalï¼ˆæ°´å¹³ï¼‰**ï¼šé€šè¿‡å¢åŠ  / å‡å°‘ Pod å‰¯æœ¬æ•°æ¥åº”å¯¹è´Ÿè½½å˜åŒ–
- **Autoscaler**ï¼šç”±ç³»ç»Ÿè‡ªåŠ¨å®Œæˆæ‰©ç¼©å®¹å†³ç­–ä¸æ‰§è¡Œ
- **æ§åˆ¶ç›®æ ‡**ï¼šDeploymentã€ReplicaSetã€StatefulSet ç­‰æ”¯æŒ `scale` å­èµ„æºçš„å·¥ä½œè´Ÿè½½

ä¸€å¥è¯æ¦‚æ‹¬ï¼š

> **HPA è´Ÿè´£å†³å®šï¼šç°åœ¨è¿™ä¸ªåº”ç”¨ï¼Œéœ€è¦å¤šå°‘ä¸ª Pod æ‰â€œåˆšåˆšå¥½â€ã€‚**



---

### 1.2 HPA è§£å†³çš„æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Ÿ

åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œä¸šåŠ¡è´Ÿè½½å¾€å¾€å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- è¯·æ±‚é‡éšæ—¶é—´æ³¢åŠ¨
- é«˜å³°ä¸ä½è°·å·®å¼‚å·¨å¤§
- é™æ€å‰¯æœ¬æ•°éš¾ä»¥é•¿æœŸé€‚é…

HPA è§£å†³çš„æ˜¯ï¼š

- **é«˜å³°æœŸå‰¯æœ¬ä¸è¶³ â†’ æ‰©å®¹**
- **ä½è°·æœŸå‰¯æœ¬æµªè´¹ â†’ ç¼©å®¹**

ç›®æ ‡ä¸æ˜¯â€œè·‘å¾—æœ€å¿«â€ï¼Œè€Œæ˜¯ï¼š

> **åœ¨è´Ÿè½½å˜åŒ–ä¸­ï¼Œä¿æŒç³»ç»Ÿç¨³å®šã€èµ„æºå¯æ§ã€æˆæœ¬åˆç†ã€‚**



---

### 1.3 HPA çš„æ§åˆ¶æ¨¡å‹

#### 1.3.1 HPA ä½¿ç”¨çš„æ¨¡å‹ï¼šæ¯”ä¾‹æ§åˆ¶

HPA çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

> **æ ¹æ®å½“å‰è´Ÿè½½ä¸ç›®æ ‡è´Ÿè½½ä¹‹é—´çš„ â€œæ¯”ä¾‹å…³ç³»â€ï¼Œè®¡ç®—ä¸€ä¸ªâ€œç†æƒ³å‰¯æœ¬æ•°â€ã€‚**

è¿™æ˜¯ä¸€ç§å…¸å‹çš„æ§åˆ¶ç†è®ºä¸­çš„ **P æ§åˆ¶ï¼ˆProportional Controlï¼‰**



---

#### 1.3.2 HPA çš„æ ¸å¿ƒè®¡ç®—å…¬å¼ï¼ˆå¿…é¡»è®°ä½ï¼‰

ä»¥ CPU åˆ©ç”¨ç‡ä¸ºä¾‹ï¼ŒHPA çš„æ ¸å¿ƒå…¬å¼æ˜¯ï¼š
```ABAP
desiredReplicas = currentReplicas Ã— ( currentMetricValue / targetMetricValue )
```
å…¶ä¸­ï¼š

- `currentReplicas`ï¼šå½“å‰ Pod å‰¯æœ¬æ•°
- `currentMetricValue`ï¼šå½“å‰å¹³å‡æŒ‡æ ‡å€¼
- `targetMetricValue`ï¼šæœŸæœ›çš„ç›®æ ‡æŒ‡æ ‡å€¼



---

#### 1.3.3 CPU åˆ©ç”¨ç‡æ˜¯æ€ä¹ˆå®šä¹‰çš„ï¼Ÿï¼ˆå…³é”®ï¼‰

**CPU åˆ©ç”¨ç‡ â‰  CPU ä½¿ç”¨ç‡**

åœ¨ HPA ä¸­ï¼š
```ABAP
CPU åˆ©ç”¨ç‡ = å®é™… CPU ä½¿ç”¨é‡ / CPU request
```
è€Œä¸æ˜¯ï¼š
```ABAP
CPU ä½¿ç”¨é‡ / èŠ‚ç‚¹æ€» CPU
```



---

**ä¸€ä¸ªå®Œæ•´çš„è®¡ç®—ä¾‹å­**

å‡è®¾ï¼š

- å½“å‰å‰¯æœ¬æ•°ï¼š4

- æ¯ä¸ª Podï¼š
    - `cpu.request = 200m`
    - å®é™…ä½¿ç”¨ `300m`

- HPA ç›®æ ‡ï¼š
    - `targetCPUUtilization = 80%`

è®¡ç®—è¿‡ç¨‹ï¼š
```go
å• Pod åˆ©ç”¨ç‡ = 300 / 200 = 150%
å½“å‰å¹³å‡åˆ©ç”¨ç‡ = 150%
```
ä»£å…¥å…¬å¼ï¼š
```go
desiredReplicas = 4 Ã— (150 / 80) = 7.5 â†’ 8
```
HPA ä¼šå°†å‰¯æœ¬æ•°è°ƒæ•´ä¸º 8



---

#### 1.3.4 HPA ä½¿ç”¨â€œå¹³å‡å€¼â€

HPA åœ¨è¿›è¡Œæ‰©ç¼©å®¹å†³ç­–æ—¶ï¼Œ**å¹¶ä¸æ˜¯çœ‹æŸä¸€ä¸ª Pod çš„æŒ‡æ ‡å€¼**ï¼Œ  
è€Œæ˜¯å¯¹ **æ‰€æœ‰å¯ç”¨ Pod çš„æŒ‡æ ‡åšèšåˆè®¡ç®—**ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯ï¼š

> **å¹³å‡å€¼ï¼ˆaverageï¼‰**

è¿™ä¸æ˜¯ä¸€ä¸ªå®ç°ç»†èŠ‚ï¼Œè€Œæ˜¯ **HPA æ§åˆ¶æ¨¡å‹çš„æ ¸å¿ƒè®¾è®¡é€‰æ‹©**ã€‚



---

#### 1.3.5 HPA åˆ°åº•åœ¨â€œå¹³å‡â€ä»€ä¹ˆï¼Ÿ

ä»¥æœ€å¸¸è§çš„ **CPU åˆ©ç”¨ç‡ HPA** ä¸ºä¾‹ï¼ŒHPA çš„è®¡ç®—è¿‡ç¨‹å¯ä»¥æ‹†æˆä¸‰æ­¥ï¼š



**ç¬¬ä¸€æ­¥ï¼šè®¡ç®—æ¯ä¸ª Pod çš„ CPU åˆ©ç”¨ç‡**

```go
Pod CPU åˆ©ç”¨ç‡ = å®é™… CPU ä½¿ç”¨é‡ / CPU request
```


**ç¬¬äºŒæ­¥ï¼šå¯¹æ‰€æœ‰ Pod çš„åˆ©ç”¨ç‡æ±‚å¹³å‡å€¼**

```go
å¹³å‡ CPU åˆ©ç”¨ç‡ = (Pod1 åˆ©ç”¨ç‡ + Pod2 åˆ©ç”¨ç‡ + ... + PodN åˆ©ç”¨ç‡) / N
```


**ç¬¬ä¸‰æ­¥ï¼šç”¨â€œå¹³å‡å€¼â€å‚ä¸æ¯”ä¾‹æ§åˆ¶å…¬å¼**

```go
desiredReplicas = currentReplicas Ã— ( å¹³å‡CPUåˆ©ç”¨ç‡ / targetCPUåˆ©ç”¨ç‡ )
```


**æ³¨æ„å…³é”®ç‚¹**ï¼š  

> HPA ä½¿ç”¨çš„æ˜¯ **â€œå¹³å‡åˆ©ç”¨ç‡â€**ï¼Œä¸æ˜¯æœ€å¤§å€¼ã€ä¹Ÿä¸æ˜¯æœ€å°å€¼ã€‚



---

#### 1.3.6 ä¸€ä¸ªå®Œæ•´ã€ç›´è§‚çš„è®¡ç®—ç¤ºä¾‹

**åœºæ™¯è®¾å®š**

- å½“å‰å‰¯æœ¬æ•°ï¼š`4`
- æ¯ä¸ª Podï¼š
    - `cpu.request = 200m`

- HPA ç›®æ ‡ï¼š
    - `targetCPUUtilization = 80%`



**å„ Pod çš„å®é™…ä½¿ç”¨æƒ…å†µ**

| Pod   | CPU ä½¿ç”¨ | åˆ©ç”¨ç‡ |
| ----- | -------- | ------ |
| Pod-1 | 300m     | 150%   |
| Pod-2 | 100m     | 50%    |
| Pod-3 | 100m     | 50%    |
| Pod-4 | 100m     | 50%    |



**HPA çš„å¹³å‡å€¼è®¡ç®—**

```go
å¹³å‡åˆ©ç”¨ç‡ = (150% + 50% + 50% + 50%) / 4 = 75%
```


**ä¸ target å¯¹æ¯”**

```go
75% < 80%
```
>  **ç»“è®ºï¼šHPA ä¸æ‰©å®¹**



---

### 1.4 HPA è¡Œä¸ºæ§åˆ¶çš„ä¸‰å¤§æ ¸å¿ƒæœºåˆ¶

ä» Kubernetes `autoscaling/v2` å¼€å§‹ï¼ŒHPA çš„è¡Œä¸ºæ§åˆ¶è¢«ç³»ç»ŸåŒ–åœ°æ‹†æˆä¸‰éƒ¨åˆ†ï¼š

- **åŒæ­¥å‘¨æœŸï¼ˆSync Periodï¼‰**
- **ç¨³å®šçª—å£ï¼ˆStabilization Windowï¼‰**
- **æ‰©ç¼©ç­–ç•¥ï¼ˆScaling Policiesï¼‰**



#### 1.4.1 åŒæ­¥å‘¨æœŸ

HPA Controller çš„å·¥ä½œæ–¹å¼æ˜¯ï¼š
```ABAP
æ¯éš”ä¸€ä¸ª sync å‘¨æœŸï¼š
  - æ‹‰å–æŒ‡æ ‡
  - è®¡ç®— desiredReplicas
  - å†³å®šæ˜¯å¦è°ƒæ•´å‰¯æœ¬æ•°
```
> é»˜è®¤ sync å‘¨æœŸæ˜¯ **15 ç§’**ï¼ˆå¯é€šè¿‡ controller å‚æ•°è°ƒæ•´ï¼‰ã€‚



---

#### 1.4.2 ç¨³å®šçª—å£ï¼ˆStabilization Windowï¼‰ï¼šé˜²æŠ–çš„æ ¸å¿ƒ

**ä»€ä¹ˆæ˜¯ç¨³å®šçª—å£ï¼Ÿ**

ç¨³å®šçª—å£çš„å«ä¹‰æ˜¯ï¼š

> **åœ¨ä¸€æ®µæ—¶é—´å†…ï¼Œå¯¹å†å²è®¡ç®—ç»“æœè¿›è¡Œâ€œå›çœ‹â€ï¼Œ  
> é€‰æ‹©ä¸€ä¸ªæ›´ç¨³å®šçš„å‰¯æœ¬æ•°å†³ç­–ã€‚**

å®ƒçš„ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š**é˜²æ­¢æŒ‡æ ‡çŸ­æ—¶é—´æŠ–åŠ¨å¯¼è‡´é¢‘ç¹æ‰©ç¼©ã€‚**



---

**ç¨³å®šçª—å£åˆ†ä¸ºä¸¤ç±»**

| ç±»å‹                                   | ä½œç”¨                   |
| -------------------------------------- | ---------------------- |
| `scaleUp.stabilizationWindowSeconds`   | æ§åˆ¶æ‰©å®¹æ˜¯å¦è¦â€œç­‰ç­‰çœ‹â€ |
| `scaleDown.stabilizationWindowSeconds` | æ§åˆ¶ç¼©å®¹æ˜¯å¦è¦â€œç¼“ä¸€ç¼“â€ |



---

**ç¨³å®šçª—å£çš„ç›´è§‚è§£é‡Š**

**å¯¹äºæ‰©å®¹ï¼ˆscaleUpï¼‰**

- åœ¨çª—å£æ—¶é—´å†…ï¼š

    - å– **æœ€å¤§** çš„ `desiredReplicas`

- å«ä¹‰æ˜¯ï¼š

>**åªè¦æœ€è¿‘ä¸€æ®µæ—¶é—´â€œæœ‰ä¸€æ¬¡å¾ˆå¿™â€ï¼Œå°±åˆ«ç¼©å›å»**

---
**å¯¹äºç¼©å®¹ï¼ˆscaleDownï¼‰**

- åœ¨çª—å£æ—¶é—´å†…ï¼š

    - å– **æœ€å°** çš„ `desiredReplicas`

- å«ä¹‰æ˜¯ï¼š

> **åªæœ‰æŒç»­ä¸€æ®µæ—¶é—´éƒ½ä¸å¿™ï¼Œæ‰å…è®¸ç¼©å®¹**

è¿™æ˜¯ä¸€ç§**æ˜æ˜¾åå‘ç¨³å®šæ€§çš„ä¿å®ˆç­–ç•¥**ã€‚



---

#### 1.4.3 HPA ç¨³å®šæ€§çš„çœŸå®å·¥ä½œæ¨¡å‹

HPA controller å†…éƒ¨é€»è¾‘å¯ä»¥æŠ½è±¡æˆ **ä¸‰æ­¥**ï¼š

**æ¯ä¸ª sync å‘¨æœŸéƒ½ä¼šç®—ä¸€ä¸ª desiredReplicas**

```go
æ¯ 15sï¼ˆé»˜è®¤ï¼‰ï¼š
  desired = f(metrics)
```


**HPA ä¼šæŠŠè¿™äº›ç»“æœâ€œè®°ä¸‹æ¥â€ï¼ˆåœ¨å†…å­˜ä¸­ï¼‰**

åœ¨ç¨³å®šçª—å£å†…ï¼ŒHPA ä¼šç»´æŠ¤ä¸€ä¸ª **recommendation å†å²åˆ—è¡¨**ï¼š
```go
history = [
  (t1, desired=10),
  (t2, desired=9),
  (t3, desired=7),
  (t4, desired=8),
  ...
]
```
**è¿™ä¸ªåˆ—è¡¨åªä¿å­˜â€œçª—å£æ—¶é—´å†…â€çš„è®°å½•**ï¼Œè¶…è¿‡çª—å£çš„ä¼šè¢«ä¸¢å¼ƒã€‚



**åœ¨æ‰§è¡Œæ‰© / ç¼©ä¹‹å‰ï¼Œåšä¸€ä¸ªâ€œæå…¶ä¿å®ˆçš„é€‰æ‹©â€**

**å¯¹ scaleDownï¼ˆç¼©å®¹ï¼‰ï¼š**
```go
allowedDesired = max(history)
```
**ä¸æ˜¯ minï¼Œæ˜¯ max**

ä¹Ÿå°±æ˜¯è¯´ï¼š

> **åªè¦æœ€è¿‘ä¸€æ®µæ—¶é—´å†…â€œæœ‰ä¸€æ¬¡è®¤ä¸ºä¸èƒ½ç¼©é‚£ä¹ˆå¤šâ€ï¼Œé‚£å°±æŒ‰æœ€ä¿å®ˆçš„æ¥ï¼Œä¸ç¼©ã€‚



**å¯¹ scaleUpï¼ˆæ‰©å®¹ï¼‰ï¼š**

```go
allowedDesired = min(history)
```
> åŒæ ·æ˜¯ä¿å®ˆæ–¹å‘ï¼ˆé˜²æ­¢ç¬æ—¶å†²é«˜ï¼‰



---

#### 1.4.4 HPA çš„çœŸå®è®¡ç®—é“¾è·¯ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

æˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥æ¥ï¼Œå¯¹åº”ä½ è¿™ä¸ªé…ç½®åœºæ™¯ï¼š

> - target CPU = 50%
> - minReplicas = 1
> - maxReplicas = 4
> - scaleDown.stabilizationWindowSeconds = 30s
> - HPA sync period = 15sï¼ˆé»˜è®¤ï¼‰



**ç¬¬ä¸€æ­¥ï¼šæ¯ 15s è®¡ç®—ä¸€æ¬¡ desiredReplicas**

å‡è®¾å½“å‰å‰¯æœ¬æ•°æ˜¯ `2`ï¼Œæ¯æ¬¡ HPA éƒ½ä¼šç®—ï¼š

```
desiredReplicas = currentReplicas Ã— currentCPU / targetCPU
```

ä¾‹å¦‚ï¼š

| æ—¶é—´  | CPU åˆ©ç”¨ç‡ | desiredReplicas          |
| ----- | ---------- | ------------------------ |
| T0    | 45%        | 2 Ã— 0.45 / 0.5 = 1.8 â†’ 2 |
| T+15s | 40%        | 2 Ã— 0.40 / 0.5 = 1.6 â†’ 2 |
| T+30s | 30%        | 2 Ã— 0.30 / 0.5 = 1.2 â†’ 1 |

ğŸ“Œ **æ³¨æ„ï¼šè¿™é‡Œæ¯æ¬¡å…ˆç®—å‡ºä¸€ä¸ªâ€œæœŸæœ›å‰¯æœ¬æ•°â€**



---

**ç¬¬äºŒæ­¥ï¼šç¨³å®šçª—å£ä¿å­˜çš„æ˜¯è¿™äº›â€œæœŸæœ›å‰¯æœ¬æ•°â€**

åœ¨ `scaleDown.stabilizationWindowSeconds = 30s` çš„æƒ…å†µä¸‹ï¼š

- çª—å£å†…å¯èƒ½ä¿å­˜ï¼š

  ```ABAP
  desiredReplicas history = [2, 2, 1]
  ```



----

**ç¬¬ä¸‰æ­¥ï¼šç¼©å®¹æ—¶ï¼Œå–â€œæœ€ä¿å®ˆå€¼â€**

å¯¹äº **scaleDownï¼ˆç¼©å®¹ï¼‰**ï¼š

> **HPA å–å†å² `desiredReplicas` çš„æœ€å¤§å€¼**

```
allowedDesired = max([2, 2, 1]) = 2
```

ğŸ‘‰ **ç»“æœï¼šä¸ç¼©å®¹**



---

#### 1.4.5 HPA çš„çœŸå®è®¡ç®—é“¾è·¯ï¼ˆè¿™æ˜¯æ ¸å¿ƒï¼‰

**å¿…é¡»æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼š**

> **åœ¨æ•´ä¸ªç¨³å®šçª—å£å†…ï¼Œæ‰€æœ‰è®¡ç®—ç»“æœéƒ½â€œå…è®¸ç¼©å®¹â€**

ä¾‹å¦‚ï¼š

| æ—¶é—´  | CPU  | desiredReplicas |
| ----- | ---- | --------------- |
| T0    | 30%  | 1               |
| T+15s | 25%  | 1               |
| T+30s | 28%  | 1               |

æ­¤æ—¶ï¼š

```
history = [1, 1, 1]
allowedDesired = max(...) = 1
```

ğŸ‘‰ **HPA æ‰ä¼šå…è®¸ä» 2 ç¼©åˆ° 1**



---





## 2. Requestä¸Limit



### Podèµ„æºé™åˆ¶,                            

kubernetes å¯ä»¥æ”¯æŒåœ¨**å®¹å™¨çº§**åŠ**namespaceçº§**åˆ†åˆ«å®ç°èµ„æºé™åˆ¶



Kubernetes å·²ç»å¯¹Podåšäº†ç›¸åº”çš„èµ„æºé…é¢è®¾ç½®ï¼Œè¿™äº›èµ„æºä¸»è¦ä½“ç°åœ¨ï¼šCPUå’Œå†…å­˜ã€å­˜å‚¨ï¼Œå› ä¸ºå­˜å‚¨ åœ¨k8sä¸­æœ‰ä¸“é—¨çš„èµ„æºå¯¹è±¡ï¼ˆPV,PVCï¼‰æ¥è¿›è¡Œç®¡æ§ï¼Œæ‰€ä»¥å½“å‰çš„podèµ„æºé™åˆ¶ï¼Œä¸»è¦æŒ‡çš„è®¡ç®—èµ„æºï¼Œå³**CPUå’Œå†…å­˜ã€‚**



ä¸ºäº†æ–¹ä¾¿ä¸k8sçš„å…¶ä»–å•ç‹¬çš„èµ„æºå¯¹è±¡åŒºåˆ†å¼€æ¥ï¼Œä¸€èˆ¬å°†**CPUå’Œå†…å­˜**å…¶ç§°ä¸º**è®¡ç®—èµ„æº**ã€‚

å¦‚æœè¿è¡Œçš„Podä½¿ç”¨çš„èµ„æºè¶…è¿‡å®¿ä¸»æœºçš„æœ€å¤§å¯ç”¨èµ„æº,ä¼šå¯¼è‡´**OOM**å’Œ**Podé©±é€**åˆ°å…¶å®ƒå®¿ä¸»æœº



##### å¯é™åˆ¶çš„èµ„æºå•ä½

å¸¸è§åœ¨å®¹å™¨çº§åˆ«çš„CPUå’Œå†…å­˜çš„é™åˆ¶



- **CPU**
  - ç‰¹ç‚¹ï¼šæ˜¯ä¸€ç§å¯å‹ç¼©èµ„æºï¼Œcpuèµ„æºæ˜¯æ”¯æŒæŠ¢å çš„
  - å•ä½ï¼šCPUçš„èµ„æºå•ä½æ˜¯CPU(Core)çš„æ•°é‡,æ˜¯ä¸€ä¸ªç»å¯¹
  - å¤§å°ï¼šåœ¨Kubernetesä¸­é€šå¸¸ä»¥åƒåˆ†ä¹‹ä¸€çš„CPU(Core)ä¸ºæœ€å°å•ä½ï¼Œç”¨æ¯« m è¡¨ç¤º,å³**ä¸€ä¸ªCPUæ ¸å¿ƒè¡¨ç¤ºä¸º1000m**
  - ç»éªŒï¼š**ä¸€ä¸ªèµ„æºå ç”¨ä¸å¤šçš„å®¹å™¨å ç”¨çš„CPU**é€šå¸¸åœ¨100~300mï¼Œå³**0.1-0.3ä¸ªCPU**
  - æ³¨æ„ï¼šmi ä»£è¡¨æ˜¯1024è¿›åˆ¶çš„



- **å†…å­˜**
  - ç‰¹ç‚¹ï¼šæ˜¯ä¸å¯å‹ç¼©èµ„æºï¼Œå½“podèµ„æºæ‰©å±•çš„æ—¶å€™ï¼Œå¦‚æœnodeä¸Šèµ„æºä¸å¤Ÿï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿèµ„æºæŠ¢å ï¼Œ æˆ–è€…OOMé—®é¢˜
  - å•ä½ï¼šå†…å­˜çš„èµ„æºä»¥å­—èŠ‚æ•°ä¸ºå•ä½ï¼Œæ˜¯ä¸€ä¸ªç»å¯¹å€¼
  - å¤§å°ï¼šå†…å­˜é…é¢å¯¹äºç»å¤§å¤šæ•°å®¹å™¨æ¥è¯´å¾ˆé‡è¦ï¼Œåœ¨Kubernetesä¸­é€šå¸¸ä»¥Mi,Giä¸ºå•ä½æ¥åˆ†é…ã€‚é€šå¸¸ åˆ†é…ç½®1G,2G,æœ€å¤š16Gæˆ–32G
  - æ³¨æ„ï¼šå¦‚æœå†…å­˜åˆ†é…ä¸è¶³,å¯èƒ½ä¼šå‡ºç°OOMç°è±¡ï¼ˆJavaç¨‹åºå¸¸è§ï¼‰



- **æ³¨æ„**
  - CPUå±äºå¯å‹ç¼©ï¼ˆcompressibleï¼‰å‹èµ„æºï¼Œå³èµ„æºé¢åº¦å¯æŒ‰éœ€æ”¶ç¼©
  - å†…å­˜ï¼ˆå½“å‰ï¼‰åˆ™æ˜¯ä¸å¯å‹ç¼©å‹èµ„æºï¼Œå¯¹å…¶æ‰§è¡Œæ”¶ç¼©æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æŸç§ç¨‹åº¦çš„é—®é¢˜ï¼Œä¾‹å¦‚è¿›ç¨‹å´©æºƒ ç­‰ã€‚



- **Extended Resources æ‰©å±•èµ„æºé™åˆ¶ï¼ˆå¸¸è§ï¼šGPUèµ„æºï¼‰**
  - æ‰€æœ‰ä¸å±äºkubernetes.ioåŸŸçš„èµ„æº,ä¸ºæ‰©å±•èµ„æº,å¦‚:"**nvidia.com/gpu**"
  - kubernetes ä¹Ÿæ”¯æŒé’ˆåˆ°æ‰©å±•èµ„æºé™åˆ¶





##### é…é¢é™åˆ¶å‚æ•°

Kubernetesä¸­ï¼Œå¯¹äºæ¯ç§èµ„æºçš„é…é¢é™å®šéƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼š**Requestså’ŒLimits**

![image-20241218152631838](D:\git_repository\cyber_security_learning\markdown_img\image-20241218152631838-1747388053526-1.png)





- **èµ„æºéœ€æ±‚Requests**
  - ä¸šåŠ¡è¿è¡Œæ—¶èµ„æºé¢„ç•™çš„æœ€å°ä½¿ç”¨é‡ï¼Œå³æ‰€éœ€èµ„æºçš„**æœ€ä½ä¸‹é™**ï¼Œ**è¯¥å‚æ•°çš„å€¼å¿…é¡»æ»¡è¶³ï¼Œè‹¥ä¸æ»¡è¶³ï¼Œä¸šåŠ¡æ— æ³•è¿è¡Œ**ã€‚
  - å®¹å™¨è¿è¡Œæ—¶å¯èƒ½ç”¨ä¸åˆ°è¿™äº›é¢åº¦çš„èµ„æºï¼Œä½†ç”¨åˆ°æ—¶å¿…é¡»ç¡®ä¿æœ‰ç›¸åº”æ•°é‡çš„èµ„æºå¯ç”¨
  - èµ„æºéœ€æ±‚çš„å®šä¹‰ä¼šå½±å“è°ƒåº¦å™¨çš„å†³ç­–,åªä¼šå°†Podè°ƒåº¦è‡³æ»¡è¶³æ‰€æœ‰å®¹å™¨æ€»çš„èµ„æºéœ€æ±‚çš„èŠ‚ç‚¹
  - å½“èµ„æºä¸è¶³æ—¶ï¼Œ**å®é™…ä½¿ç”¨çš„èµ„æºè¶…å‡º Requests çš„éƒ¨åˆ†ï¼Œå¯èƒ½ä¼šè¢«å›æ”¶**
  - **ä¸èƒ½è¶…è¿‡å¯¹åº”çš„limitså€¼**
  - **ä¸èƒ½è¶…è¿‡ç‰©ç†èŠ‚ç‚¹å¯ç”¨åˆ†é…çš„èµ„æºå€¼**



- **èµ„æºé™åˆ¶ Limits**
  - è¿è¡Œæ—¶èµ„æºå…è®¸ä½¿ç”¨æœ€å¤§å¯ç”¨é‡ï¼Œå³æ‰€éœ€èµ„æºçš„æœ€é«˜ä¸Šé™ï¼Œè¯¥å‚æ•°çš„å€¼ä¸èƒ½è¢«çªç ´ï¼Œè¶…å‡ºè¯¥é¢åº¦çš„èµ„æºä½¿ç”¨è¯·æ±‚é€šå¸¸ä¼šè¢«æ‹’ç»
  - **è¯¥é™åˆ¶éœ€è¦å¤§äºç­‰äºrequestsçš„å€¼**ï¼Œä½†ç³»ç»Ÿåœ¨å…¶æŸé¡¹èµ„æºç´§å¼ æ—¶ï¼Œä¼šä»å®¹å™¨é‚£é‡Œå›æ”¶å…¶ä½¿ç”¨çš„è¶…å‡º å…¶requestså€¼çš„é‚£éƒ¨åˆ†
  - é’ˆå¯¹å†…å­˜è€Œè¨€,ä¸ºé˜²æ­¢ä¸Šé¢å›æ”¶æƒ…å†µçš„å‘ç”Ÿ,ä¸€èˆ¬**å»ºè®®å°†å†…å­˜çš„ Requests å’Œ Limits è®¾ä¸ºç›¸åŒ**
  - èµ„æºé™åˆ¶**Limit**çš„å®šä¹‰**ä¸å½±å“è°ƒåº¦å™¨çš„å†³ç­–**
  - ä¸èƒ½ä½äºå¯¹åº”çš„limitså€¼
  - å¯ä»¥è¶…è¿‡ç‰©ç†èŠ‚ç‚¹å¯ç”¨åˆ†é…çš„èµ„æºå€¼
  - **æç¤º:ä¸ºä¿è¯æ€§èƒ½,ç”Ÿäº§æ¨èRequestså’ŒLimitsè®¾ç½®ä¸ºç›¸åŒçš„å€¼**



##### k8sèµ„æºæŸ¥çœ‹

è¦å®ç°èµ„æºé™åˆ¶,éœ€è¦å…ˆ**å®‰è£…metrics-server**

```bash
[root@master1 ~]# curl -LO https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

#é»˜è®¤æ–‡ä»¶éœ€è¦ä¿®æ”¹æ‰èƒ½å·¥ä½œ,å› ä¸ºé»˜è®¤éœ€è¦å†…éƒ¨è¯ä¹¦éªŒè¯å’Œé•œåƒåœ°å€k8s.gcr.ioæ‰€ä»¥ä¿®æ”¹
# vim components.yaml
spec:
      containers:
      - args:
        - --cert-dir=/tmp
        - --secure-port=10250
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s
        - --kubelet-insecure-tls
        #image: registry.cn-hangzhou.aliyuncs.com/google_containers/metricsserver:v0.7.1 # å¯ä»¥æ·»åŠ å›½å†…æº
        image: registry.k8s.io/metrics-server/metrics-server:v0.7.2
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /livez
            port: https
            scheme: HTTPS
          periodSeconds: 10
        name: metrics-server
        ports:
        - containerPort: 10250
          name: https
          protocol: TCP
          
[root@master1 yaml]# kubectl apply -f components.yaml 
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created


root@master1 yaml]#kubectl get pod -n kube-system metrics-server-b79d5c976-hqrct 
NAME                             READY   STATUS    RESTARTS   AGE
metrics-server-b79d5c976-hqrct   1/1     Running   0          60s
[root@master1 yaml]#kubectl top node
NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
master1   62m          3%     910Mi           49%       
node1     30m          1%     669Mi           36%       
node2     20m          1%     927Mi           50%       
node3     27m          1%     715Mi           39% 
```



### metrics-serverè§£è¯»

**metrics-serveré‡‡é›†æŒ‡æ ‡çš„å…¨è¿‡ç¨‹ï¼Œå’Œè¿™ä¸ªè¿‡ç¨‹ä¸­çš„é‡ç‚¹èµ„æº**

-  `APIService` å¯¹è±¡
- `deployment`å¯¹è±¡

metrics-server çš„ API æ˜¯é€šè¿‡åˆ›å»º `APIService` å¯¹è±¡ï¼Œæ³¨å†Œåˆ° kube-apiserver çš„èšåˆå±‚ï¼ˆkube-aggregatorï¼‰ä¸­ã€‚

**å…·ä½“è¡Œä¸ºæ˜¯ï¼š**

- ç”¨æˆ·åˆ›å»ºapièµ„æºï¼Œç„¶åè¯¥èµ„æºä¿å­˜åœ¨ etcd ä¸­ï¼Œ å¹¶ä¸”è¢« apiserver watch ç›‘å¬

- kube-apiserver **WATCH ç›‘å¬** `apiservice` èµ„æºå¯¹è±¡ã€‚

  èšåˆå±‚ï¼ˆAggregation Layerï¼‰æœ¬è´¨ä¸Šæ˜¯ **kube-apiserver å†…ç½®çš„ä¸€ä¸ª HTTP åå‘ä»£ç†åŠŸèƒ½æ¨¡å—**ã€‚

  å®ƒé€šè¿‡ Shared Informer **watch APIService èµ„æºå˜åŒ–**ã€‚

  **è‡ªåŠ¨å°† APIService ä¸­å£°æ˜çš„ API è·¯å¾„ï¼ˆå¦‚ `/apis/metrics.k8s.io/v1beta1`ï¼‰æ³¨å†Œè¿› HTTP è·¯ç”±è¡¨**ï¼Œä»è€ŒæŒ‚è½½æˆä¸ºå¯è®¿é—® APIã€‚

- è§£æ `apiservice.spec.service.name` å’Œ `service.namespace`ï¼Œ
   **é€šè¿‡ Kubernetes Service åå‘ä»£ç†åˆ°å¯¹åº”æ‰©å±• API Serverï¼ˆå¦‚ metrics-serverï¼‰**ã€‚

- **HTTP/HTTPS ä»£ç†è¯·æ±‚åˆ°æ‰©å±• API Server**ï¼Œä»è€ŒæŠŠå®ƒæä¾›çš„ API åˆå¹¶åˆ°è‡ªå·±çš„ `/apis/...` è·¯å¾„ç©ºé—´é‡Œã€‚

**æ€»ç»“ï¼š**

kube-apiserver å†…ç½®çš„èšåˆå±‚æ˜¯ä¸€ä¸ª **"åå‘ä»£ç†å’Œè·¯ç”±æœºåˆ¶"**ï¼Œ å®ƒé€šè¿‡ **ç›‘å¬ APIService èµ„æºå¯¹è±¡**ï¼Œ **è§£æå‡ºç›®æ ‡æ‰©å±• API Server çš„ Service åœ°å€**ï¼Œ ç„¶åæŠŠå¤–éƒ¨è¯·æ±‚ **ä»£ç†åˆ°çœŸæ­£æä¾›è¯¥ API çš„æœåŠ¡ä¸Š**ï¼ˆå¦‚ metrics-serverï¼‰ï¼Œ è¿™æ ·å®¢æˆ·ç«¯è®¿é—®æ—¶å°±åƒè®¿é—® kube-apiserver è‡ªå·±æä¾›çš„ API ä¸€æ ·æ— æ„ŸçŸ¥ã€‚

```bash
# apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io
# æŸ¥çœ‹metrics-serverçš„apiserverå¯¹è±¡
[root@master1 ~]# kubectl get apiservices.apiregistration.k8s.io -n kube-system v1beta1.metrics.k8s.io 
NAME                     SERVICE                      AVAILABLE   AGE
v1beta1.metrics.k8s.io   kube-system/metrics-server   True        6d1h

# æŸ¥çœ‹èµ„æºæ¸…å•
[root@master1 ~]# kubectl get apiservices.apiregistration.k8s.io -n kube-system v1beta1.metrics.k8s.io -o yaml
apiVersion: apiregistration.k8s.io/v1
kind: APIService
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"apiregistration.k8s.io/v1","kind":"APIService","metadata":{"annotations":{},"labels":{"k8s-app":"metrics-server"},"name":"v1beta1.metrics.k8s.io"},"spec":{"group":"metrics.k8s.io","groupPriorityMinimum":100,"insecureSkipTLSVerify":true,"service":{"name":"metrics-server","namespace":"kube-system"},"version":"v1beta1","versionPriority":100}}
  creationTimestamp: "2025-05-02T06:13:47Z"
  labels:
    k8s-app: metrics-server
  name: v1beta1.metrics.k8s.io
  resourceVersion: "348056"
  uid: d7c94e84-00a7-47e1-a16a-dbc3c41017b4
spec:
  group: metrics.k8s.io
  groupPriorityMinimum: 100
  insecureSkipTLSVerify: true     # è·³è¿‡äº†front-proxy-caçš„éªŒè¯ï¼Œæµ‹è¯•ç¯å¢ƒä½¿ç”¨ï¼Œç”Ÿäº§ç¯å¢ƒä¸å®‰å…¨
  # insecureSkipTLSVerify: false
  # caBundle: <base64-encoded front-proxy-ca.crt>
  service:
    name: metrics-server
    namespace: kube-system
    port: 443
  version: v1beta1
  versionPriority: 100
```

metrics-server é€šè¿‡HTTPSä¼šå‘æ¯ä¸ªèŠ‚ç‚¹çš„ kubelet çš„10250ç«¯å£å‘å‡ºè¯·æ±‚ï¼Œè®¿é—® `/stats/summary` æ¥å£ï¼ˆè¿™äº›APIç”±kubeleté€šè¿‡cAdvisoræä¾›æ•°æ®ï¼‰ï¼Œè¿™æ˜¯é‡‡é›† **Pod å’Œ Node çš„ CPU/å†…å­˜ç­‰èµ„æºä½¿ç”¨æƒ…å†µ** çš„å…³é”®æ•°æ®æºã€‚

#### metrics-serverçš„æ•°æ®é‡‡é›†è¿‡ç¨‹

**CPU å’Œ Memory çš„æ•°æ®æ¥æº**

- **æ•°æ®æº**æ˜¯ **Kubelet çš„ `/metrics/resource` æˆ– `/stats/summary` æ¥å£**ã€‚
- Kubelet æœ¬èº«ä¼šä» **cAdvisor**ï¼ˆå†…ç½®åœ¨ Kubelet é‡Œï¼‰ è·å–èŠ‚ç‚¹ä¸Š **Pod å’Œå®¹å™¨çš„èµ„æºæŒ‡æ ‡**ã€‚

```css
Linux Kernel (cgroups, /proc)
     â†“
cAdvisorï¼ˆKubeletå†…ç½®ï¼‰
     â†“
Kubelet /stats/summary æˆ– /metrics/resource
     â†“
metrics-server è®¿é—®è¿™äº›æ¥å£
```

**è¯¦ç»†æŒ‡æ ‡é‡‡é›†é“¾è·¯**

| é‡‡é›†é˜¶æ®µ                        | è¯´æ˜                                                         |
| ------------------------------- | ------------------------------------------------------------ |
| **Kubelet é‡‡é›†**                | Kubelet ä» cAdvisor è¯»å–æœ¬æœºèŠ‚ç‚¹ä¸Šæ‰€æœ‰ Pod å’Œå®¹å™¨çš„èµ„æºä½¿ç”¨æƒ…å†µï¼ˆCPUã€å†…å­˜ï¼‰ |
| **metrics-server è®¿é—® Kubelet** | metrics-server è°ƒç”¨æ¯ä¸ª Node çš„ Kubelet `/stats/summary` æ¥å£ |
| **ä¸ŠæŠ¥åˆ° kube-apiserver**       | metrics-server èšåˆæ•°æ®åé€šè¿‡ Aggregation Layer æä¾› `/apis/metrics.k8s.io/v1beta1` æ¥å£ |
| **kubectl top æŸ¥è¯¢**            | kubectl top é€šè¿‡è°ƒç”¨ kube-apiserver è¿™ä¸ªèšåˆæ¥å£è¿”å›å®æ—¶æŒ‡æ ‡ |

**metrics-server ä¼šè½®è¯¢æ¯ä¸ª Node ä¸Šçš„ kubelet**

- metrics-server ä¼šå®šæœŸå‘æ¯ä¸ª node çš„ kubelet å‘èµ· HTTPS è¯·æ±‚ï¼š

```http
https://<node-ip>:10250/stats/summary
```

**metrics-server é€šè¿‡ kube-apiserver è°ƒç”¨æ ‡å‡† API è·å– Node åˆ—è¡¨ï¼š**

```http
GET /api/v1/nodes
```

**è¿”å›æ¯ä¸ª Node çš„çŠ¶æ€ä¿¡æ¯ï¼ˆåŒ…æ‹¬åœ°å€ï¼‰ï¼š**

```json
"status": {
  "addresses": [
    {
      "type": "InternalIP",
      "address": "192.168.1.10"
    }
  ]
}
```

**ç„¶åä½¿ç”¨ InternalIP + é»˜è®¤ kubelet ç«¯å£ 10250 ç»„è£… URL2**

```http
https://192.168.1.10:10250/stats/summary
```

**metrics-server å¦‚ä½•è®¿é—® kubeletï¼ˆæƒé™ä¸å®‰å…¨ï¼‰**

- **è¿æ¥ç«¯å£ï¼š** kubelet çš„ HTTPS API serverï¼Œé»˜è®¤ 10250

- **è®¤è¯æ–¹å¼ï¼š**

  - metrics-server ä½¿ç”¨å®ƒè‡ªå·±çš„ ServiceAccount
  - kubelet å¿…é¡»å…è®¸è¿™ä¸ªèº«ä»½è®¿é—® `/stats/summary`

- **kubelet å¯åŠ¨å‚æ•°ä¸­éœ€å…è®¸ï¼š**

  ```bash
  --read-only-port=0
  --authentication-token-webhook=true
  --authorization-mode=Webhook
  ```

**kubelet å¯åŠ¨å‚æ•°å¿…é¡»å¼€å¯ï¼š**

```bash
--authentication-token-webhook=true
--authorization-mode=Webhook
```

| å‚æ•°                                  | å«ä¹‰                                                         |
| ------------------------------------- | ------------------------------------------------------------ |
| `--authentication-token-webhook=true` | å‘Šè¯‰ kubeletï¼šé‡åˆ° Bearer Token æ—¶ï¼Œè¯·å›å¤´å» apiserver è¯¢é—®æ˜¯å¦æœ‰æ•ˆ |
| `--authorization-mode=Webhook`        | å†æ¬¡è®© kubelet å»é—® apiserverï¼šè¿™ä¸ªè¯·æ±‚çš„èº«ä»½æœ‰æƒé™å—ï¼Ÿ      |

```bash
# metrics-serverçš„podï¼Œä¸kubeleté€šä¿¡ï¼Œéœ€è¦Kubernetes-caè¯ä¹¦éªŒè¯kubeletçš„å®¢æˆ·ç«¯è¯ä¹¦
# æŸ¥çœ‹metrics-serverçš„pod
[root@master1 ~]# kubectl get pod -n kube-system metrics-server-6b66984b5c-76n6k 
NAME                              READY   STATUS    RESTARTS   AGE
metrics-server-6b66984b5c-76n6k   1/1     Running   0          4d

# æŸ¥çœ‹èµ„æºæ¸…å•
[root@master1 ~]# kubectl get pod -n kube-system metrics-server-6b66984b5c-76n6k -o yaml
apiVersion: v1
kind: Pod
metadata:
  annotations:
    cni.projectcalico.org/containerID: 6b5f240b002dce5021d1b18c5e1ccfee524869a947a3ef8
117a7d99f302f969f
    cni.projectcalico.org/podIP: 10.200.200.1/32
    cni.projectcalico.org/podIPs: 10.200.200.1/32
  creationTimestamp: "2025-05-04T07:31:19Z"
  generateName: metrics-server-6b66984b5c-
  labels:
    k8s-app: metrics-server
    pod-template-hash: 6b66984b5c
  name: metrics-server-6b66984b5c-76n6k
  namespace: kube-system
  ownerReferences:
  - apiVersion: apps/v1
    blockOwnerDeletion: true
    controller: true
    kind: ReplicaSet
    name: metrics-server-6b66984b5c
    uid: b9dc4666-3d11-47ef-8253-8941829d4767
  resourceVersion: "348040"
  uid: 2ae17462-194f-47d0-b21c-f541ab005445
spec:
  containers:
  - args:
    - --cert-dir=/tmp
    - --secure-port=10250
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    - --kubelet-use-node-status-port
    - --metric-resolution=15s
    - --kubelet-insecure-tls    # è¿™é‡Œä¸å®‰å…¨ï¼Œç”Ÿäº§ç¯å¢ƒä¸å»ºè®®
    # - --kubelet-certificate-authority=/etc/kubernetes/pki/ca.crt
    image: harbor.magedu.mysticalrecluse.com/k8simage/metrics-server:v0.7.2
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 3
      httpGet:
        path: /livez
        port: https
        scheme: HTTPS
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 1
    name: metrics-server
    ports:
    - containerPort: 10250
      name: https
      protocol: TCP
    readinessProbe:
      failureThreshold: 3
      httpGet:
        path: /readyz
        port: https
        scheme: HTTPS
      initialDelaySeconds: 20
      periodSeconds: 10
      successThreshold: 1
      timeoutSeconds: 1
    resources:
      requests:
        cpu: 100m
        memory: 200Mi
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop:
        - ALL
      readOnlyRootFilesystem: true
      runAsNonRoot: true
      runAsUser: 1000
      seccompProfile:
        type: RuntimeDefault
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /tmp
      name: tmp-dir
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: kube-api-access-zvfff
      readOnly: true
  dnsPolicy: ClusterFirst
  enableServiceLinks: true
  nodeName: work2.mystical.org
  nodeSelector:
    kubernetes.io/os: linux
  preemptionPolicy: PreemptLowerPriority
  priority: 2000000000
  priorityClassName: system-cluster-critical
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: metrics-server
  serviceAccountName: metrics-server
  terminationGracePeriodSeconds: 30
  tolerations:
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  volumes:
  - emptyDir: {}
    name: tmp-dir
  - name: kube-api-access-zvfff
    projected:
      defaultMode: 420
      sources:
      - serviceAccountToken:
          expirationSeconds: 3607
          path: token
      - configMap:
          items:
          - key: ca.crt
            path: ca.crt
          name: kube-root-ca.crt
      - downwardAPI:
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
            path: namespace
```



##### èµ„æºé™åˆ¶å®ç°

èŒƒä¾‹ï¼šlimitså’Œrequestså€¼å¤§å°

```yaml
# [root@master1 yaml]# cat pod-limit-request.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-limit-request
spec:
  containers:
  - name: pod-limit-request-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    imagePullPolicy: IfNotPresent
    resources:
      requests:
        memory: "500Mi"
        cpu: "250m"
      limits:
        memory: "500Mi"
        cpu: "250m"

```



##### å‹åŠ›æµ‹è¯•

```yaml
# cat pod-stress.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-stress
spec:
  containers:
  - name: pod-stress
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/stress-ng
    imagePullPolicy: IfNotPresent
    command: ["/usr/bin/stress-ng", "-c 2", "--metrics-brief"]
    resources:
      requests:
        memory: 128Mi
        cpu: 200m
      limits:
        memory: 256Mi
        cpu: 500m

# æŸ¥çœ‹
[root@master1 yaml]#kubectl exec pod-stress -- top
Mem: 1853284K used, 120644K free, 4744K shrd, 55064K buff, 832920K cached
CPU:  24% usr   0% sys   0% nic  74% idle   0% io   0% irq   0% sirq
Load average: 0.35 0.30 0.17 3/513 14
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
    8     1 root     R     6904   0%   1  13% {stress-ng-cpu} /usr/bin/stress-ng
    7     1 root     R     6904   0%   0  12% {stress-ng-cpu} /usr/bin/stress-ng
    1     0 root     S     6264   0%   1   0% /usr/bin/stress-ng -c 2 --metrics-
q   9     0 root     R     1520   0%   0   0% top
```





##### åŸºäºNamespaceçº§åˆ«çš„èµ„æºé™åˆ¶

åœ¨ **Kubernetes ä¸­åŸºäº Namespace çº§åˆ«çš„èµ„æºé™åˆ¶**ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ **ResourceQuota** å’Œ **LimitRange** æ¥å®ç°å¯¹å‘½åç©ºé—´ä¸­èµ„æºçš„ä½¿ç”¨é™åˆ¶ã€‚



**èµ„æºé™åˆ¶çš„å®ç°æ–¹å¼**

| **æ–¹å¼**          | **å¯¹è±¡**       | **é™åˆ¶ç±»å‹**                   | **å…¸å‹é™åˆ¶å†…å®¹**                             |
| ----------------- | -------------- | ------------------------------ | -------------------------------------------- |
| **ResourceQuota** | **Namespace**  | **å‘½åç©ºé—´çº§åˆ«çš„èµ„æºæ€»é‡é™åˆ¶** | é™åˆ¶ Namespace ä¸­ Podã€CPUã€å†…å­˜ã€å­˜å‚¨çš„æ€»é‡ |
| **LimitRange**    | **Pod å’Œå®¹å™¨** | **å•ä¸ª Pod/å®¹å™¨çš„èµ„æºé™åˆ¶**    | é™åˆ¶æ¯ä¸ª Pod/å®¹å™¨çš„ CPU å’Œå†…å­˜çš„æœ€å°å’Œæœ€å¤§å€¼ |

------



**èµ„æºé™åˆ¶çš„å·¥ä½œæœºåˆ¶**

**1ï¸âƒ£ ResourceQuota (é™åˆ¶ Namespace èµ„æºæ€»é‡)**

- **ä½œç”¨èŒƒå›´**ï¼š
  é™åˆ¶æ•´ä¸ª Namespace ä¸­çš„èµ„æºæ€»é‡ï¼ŒåŒ…æ‹¬ Pod æ•°é‡ã€CPUã€å†…å­˜å’Œå­˜å‚¨ã€‚
- **å¸¸è§çš„é™åˆ¶é¡¹ç›®**ï¼š
  - Pod æ€»æ•° (`pods`)
  - å®¹å™¨çš„æ€» CPU è¯·æ±‚ (`requests.cpu`) å’Œæ€»é™åˆ¶ (`limits.cpu`)
  - å®¹å™¨çš„æ€»å†…å­˜è¯·æ±‚ (`requests.memory`) å’Œæ€»é™åˆ¶ (`limits.memory`)
  - PersistentVolumeClaim (PVC) çš„æ€»å­˜å‚¨ä½¿ç”¨é‡ (`requests.storage`)
- **å…¸å‹åœºæ™¯**ï¼š
  é™åˆ¶ä¸€ä¸ªé¡¹ç›®å›¢é˜Ÿåœ¨å…¶ Namespace ä¸­æœ€å¤šåªèƒ½ä½¿ç”¨ 10 ä¸ª Podï¼ŒCPU æ€»é‡ä¸è¶…è¿‡ 10 æ ¸ï¼Œå†…å­˜æ€»é‡ä¸è¶…è¿‡ 32GiBã€‚



**2ï¸âƒ£ LimitRange (é™åˆ¶å•ä¸ª Pod å’Œå®¹å™¨çš„èµ„æº)**

- **ä½œç”¨èŒƒå›´**ï¼š
  é™åˆ¶ **æ¯ä¸ª Pod æˆ–æ¯ä¸ªå®¹å™¨** çš„ CPU å’Œå†…å­˜çš„æœ€å¤§ã€æœ€å°å€¼ã€‚
- **å¸¸è§çš„é™åˆ¶é¡¹ç›®**ï¼š
  - å®¹å™¨çš„æœ€å° CPU è¯·æ±‚ (`min.cpu`) å’Œæœ€å¤§é™åˆ¶ (`max.cpu`)
  - å®¹å™¨çš„æœ€å°å†…å­˜è¯·æ±‚ (`min.memory`) å’Œæœ€å¤§é™åˆ¶ (`max.memory`)
- **å…¸å‹åœºæ™¯**ï¼š
  æ¯ä¸ª Pod ä¸­çš„å®¹å™¨éƒ½å¿…é¡»è¯·æ±‚æœ€å°‘ 100m çš„ CPUï¼Œä½†æœ€å¤šä¸èƒ½è¶…è¿‡ 2 æ ¸ CPUï¼Œæœ€å°‘ 200Mi çš„å†…å­˜ï¼Œæœ€å¤šä¸èƒ½è¶…è¿‡ 2GiB çš„å†…å­˜ã€‚



**ResourceQuotaç¤ºä¾‹ï¼ˆå‘½åç©ºé—´çš„èµ„æºæ€»é‡é™åˆ¶ï¼‰**

é™åˆ¶ **æ•´ä¸ªå‘½åç©ºé—´ä¸­çš„ Pod æ•°é‡ã€CPU å’Œå†…å­˜ä½¿ç”¨é‡**ã€‚

```yaml
# cat resource-quota.yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: namespace-quota
  namespace: my-namespace
spec:
  hard:
    pods: "10"                    # é™åˆ¶å‘½åç©ºé—´ä¸­æœ€å¤šæœ‰ 10 ä¸ª Pod
    requests.cpu: "10"            # æ‰€æœ‰ Pod çš„ CPU è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡ 10 æ ¸
    requests.memory: "32Gi"       # æ‰€æœ‰ Pod çš„å†…å­˜è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡ 32Gi
    limits.cpu: "20"              # æ‰€æœ‰ Pod ä¸­ CPU é™åˆ¶çš„æ€»å’Œä¸èƒ½è¶…è¿‡ 20 æ ¸
    limits.memory: "64Gi"         # æ‰€æœ‰ Pod ä¸­å†…å­˜é™åˆ¶çš„æ€»å’Œä¸èƒ½è¶…è¿‡ 64Gi
    persistentvolumeclaims: "5"   # é™åˆ¶ Namespace ä¸­çš„ PVC æ•°é‡ä¸º 5 ä¸ª
    requests.storage: "100Gi"     # é™åˆ¶æ‰€æœ‰ PVC è¯·æ±‚çš„å­˜å‚¨æ€»é‡ä¸º 100Gi

```



**LimitRangeç¤ºä¾‹ï¼ˆPodå’Œå®¹å™¨çš„èµ„æºé™åˆ¶ï¼‰**

ä¸º **å•ä¸ª Pod å’Œå®¹å™¨** é™åˆ¶å…¶ CPU å’Œå†…å­˜çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚

```yaml
cat limit-range.yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: container-limit-range
  namespace: my-namespace
spec:
  limits:
  - type: Pod                # ä½œç”¨èŒƒå›´ä¸ºPOd
    max:                     # maxï¼šæŒ‡å®š Pod æ€»çš„ CPU å’Œå†…å­˜ä¸Šé™ï¼ŒCPU ä¸èƒ½è¶…è¿‡ 2 æ ¸ï¼Œå†…å­˜ä¸èƒ½è¶…è¿‡ 4Giã€‚
      cpu: "2"               # æ¯ä¸ª Pod çš„æœ€å¤§ CPU é™åˆ¶ä¸º 2 æ ¸
      memory: "4Gi"          # æ¯ä¸ª Pod çš„æœ€å¤§å†…å­˜é™åˆ¶ä¸º 4 GiB
    min:                     # minï¼šæŒ‡å®š Pod çš„æœ€å°èµ„æºè¯·æ±‚ï¼ŒCPU ä¸ä½äº 250mï¼Œå†…å­˜ä¸ä½äº 128Miã€‚
      cpu: "250m"            # æ¯ä¸ª Pod çš„æœ€å° CPU è¯·æ±‚ä¸º 250m
      memory: "128Mi"        # æ¯ä¸ª Pod çš„æœ€å°å†…å­˜è¯·æ±‚ä¸º 128Mi
  - type: Container          # type: Containerï¼šä½œç”¨èŒƒå›´ä¸º Pod å†…çš„æ¯ä¸ªå®¹å™¨
    default:
      cpu: "500m"            # æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ CPU è¯·æ±‚ä¸º 500m
      memory: "512Mi"        # æ¯ä¸ªå®¹å™¨çš„é»˜è®¤å†…å­˜è¯·æ±‚ä¸º 512Mi
    defaultRequest:
      cpu: "250m"            # å¦‚æœæœªæŒ‡å®šè¯·æ±‚ï¼Œé»˜è®¤ CPU è¯·æ±‚ä¸º 250m
      memory: "256Mi"        # å¦‚æœæœªæŒ‡å®šè¯·æ±‚ï¼Œé»˜è®¤å†…å­˜è¯·æ±‚ä¸º 256Mi
    max:
      cpu: "1"               # æ¯ä¸ªå®¹å™¨çš„æœ€å¤§ CPU é™åˆ¶ä¸º 1 æ ¸
      memory: "2Gi"          # æ¯ä¸ªå®¹å™¨çš„æœ€å¤§å†…å­˜é™åˆ¶ä¸º 2GiB
    min:
      cpu: "100m"            # æ¯ä¸ªå®¹å™¨çš„æœ€å° CPU è¯·æ±‚ä¸º 100m
      memory: "128Mi"        # æ¯ä¸ªå®¹å™¨çš„æœ€å°å†…å­˜è¯·æ±‚ä¸º 128Mi

```







## 3. Podä¼˜å…ˆçº§

é¦–å…ˆéœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œä¼˜å…ˆçº§å’ŒæŠ¢å æœºåˆ¶ï¼Œè§£å†³çš„æ˜¯ **Pod è°ƒåº¦å¤±è´¥æ—¶è¯¥æ€ä¹ˆåŠçš„é—®é¢˜**ã€‚

æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ä¸€ä¸ª Pod è°ƒåº¦å¤±è´¥åï¼Œå®ƒå°±ä¼šè¢«æš‚æ—¶â€œæç½®â€èµ·æ¥ï¼Œç›´åˆ° Pod è¢«æ›´æ–°ï¼Œæˆ–è€…é›†ç¾¤çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œè°ƒåº¦å™¨æ‰ä¼šå¯¹è¿™ä¸ª Pod è¿›è¡Œé‡æ–°è°ƒåº¦ã€‚

ä½†åœ¨æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›çš„æ˜¯è¿™æ ·ä¸€ä¸ªåœºæ™¯ã€‚å½“ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„ Pod è°ƒåº¦å¤±è´¥åï¼Œè¯¥ Pod å¹¶ä¸ä¼šè¢«â€œæç½®â€ï¼Œè€Œæ˜¯ä¼šâ€œæŒ¤èµ°â€æŸä¸ª Node ä¸Šçš„ä¸€äº›ä½ä¼˜å…ˆçº§çš„ Pod ã€‚è¿™æ ·å°±å¯ä»¥ä¿è¯è¿™ä¸ªé«˜ä¼˜å…ˆçº§ Pod çš„è°ƒåº¦æˆåŠŸã€‚è¿™ä¸ªç‰¹æ€§ï¼Œå…¶å®ä¹Ÿæ˜¯ä¸€ç›´ä»¥æ¥å°±å­˜åœ¨äº Borg ä»¥åŠ Mesos ç­‰é¡¹ç›®é‡Œçš„ä¸€ä¸ªåŸºæœ¬åŠŸèƒ½ã€‚

åœ¨ Kubernetes é‡Œï¼Œä¼˜å…ˆçº§å’ŒæŠ¢å æœºåˆ¶æ˜¯åœ¨ 1.10 ç‰ˆæœ¬åæ‰é€æ­¥å¯ç”¨çš„ã€‚è¦ä½¿ç”¨è¿™ä¸ªæœºåˆ¶ï¼Œä½ é¦–å…ˆéœ€è¦åœ¨ Kubernetes é‡Œæäº¤ä¸€ä¸ª **PriorityClass** çš„å®šä¹‰ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
apiVersion: scheduling.k8s.io/v1beta1
kind: PriorityClass
metadata:
  name: high-priority
value: 1000000
globalDefault: false
description: "This priority class should be used for high priority service pods only."
```

ä¸Šé¢è¿™ä¸ª YAML æ–‡ä»¶ï¼Œå®šä¹‰çš„æ˜¯ä¸€ä¸ªåå« high-priority çš„ PriorityClassï¼Œå…¶ä¸­ value çš„å€¼æ˜¯ 1000000 ï¼ˆä¸€ç™¾ä¸‡ï¼‰

**Kubernetes è§„å®šï¼Œä¼˜å…ˆçº§æ˜¯ä¸€ä¸ª 32 bit çš„æ•´æ•°ï¼Œæœ€å¤§å€¼ä¸è¶…è¿‡ 1000000000ï¼ˆ10 äº¿ï¼Œ1 billionï¼‰ï¼Œå¹¶ä¸”å€¼è¶Šå¤§ä»£è¡¨ä¼˜å…ˆçº§è¶Šé«˜**ã€‚è€Œè¶…å‡º 10 äº¿çš„å€¼ï¼Œå…¶å®æ˜¯è¢« Kubernetes ä¿ç•™ä¸‹æ¥åˆ†é…ç»™ç³»ç»Ÿ Pod ä½¿ç”¨çš„ã€‚æ˜¾ç„¶ï¼Œè¿™æ ·åšçš„ç›®çš„ï¼Œå°±æ˜¯ä¿è¯ç³»ç»Ÿ Pod ä¸ä¼šè¢«ç”¨æˆ·æŠ¢å æ‰ã€‚

è€Œä¸€æ—¦ä¸Šè¿° YAML æ–‡ä»¶é‡Œçš„ **globalDefault è¢«è®¾ç½®ä¸º true çš„è¯**ï¼Œ**é‚£å°±æ„å‘³ç€è¿™ä¸ª PriorityClass çš„å€¼ä¼šæˆä¸ºç³»ç»Ÿçš„é»˜è®¤å€¼**ã€‚è€Œå¦‚æœè¿™ä¸ªå€¼æ˜¯ falseï¼Œå°±è¡¨ç¤ºæˆ‘ä»¬åªå¸Œæœ›å£°æ˜ä½¿ç”¨è¯¥ PriorityClass çš„ Pod æ‹¥æœ‰å€¼ä¸º 1000000 çš„ä¼˜å…ˆçº§ï¼Œè€Œå¯¹äºæ²¡æœ‰å£°æ˜ PriorityClass çš„ Pod æ¥è¯´ï¼Œå®ƒä»¬çš„ä¼˜å…ˆçº§å°±æ˜¯ 0ã€‚

åœ¨åˆ›å»ºäº† PriorityClass å¯¹è±¡ä¹‹åï¼ŒPod å°±å¯ä»¥å£°æ˜ä½¿ç”¨å®ƒäº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: nginx
  labels:
    env: test
spec:
  containers:
  - name: nginx
    image: nginx
    imagePullPolicy: IfNotPresent
  priorityClassName: high-priority
```

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ª Pod é€šè¿‡ priorityClassName å­—æ®µï¼Œå£°æ˜äº†è¦ä½¿ç”¨åå« high-priority çš„ PriorityClassã€‚å½“è¿™ä¸ª Pod è¢«æäº¤ç»™ Kubernetes ä¹‹åï¼ŒKubernetes çš„ PriorityAdmissionController å°±ä¼šè‡ªåŠ¨å°†è¿™ä¸ª Pod çš„ spec.priority å­—æ®µè®¾ç½®ä¸º 1000000ã€‚

è°ƒåº¦å™¨é‡Œç»´æŠ¤ç€ä¸€ä¸ªè°ƒåº¦é˜Ÿåˆ—ã€‚æ‰€ä»¥ï¼Œå½“ Pod æ‹¥æœ‰äº†ä¼˜å…ˆçº§ä¹‹åï¼Œé«˜ä¼˜å…ˆçº§çš„ Pod å°±å¯èƒ½ä¼šæ¯”ä½ä¼˜å…ˆçº§çš„ Pod æå‰å‡ºé˜Ÿï¼Œä»è€Œå°½æ—©å®Œæˆè°ƒåº¦è¿‡ç¨‹ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯â€œä¼˜å…ˆçº§â€è¿™ä¸ªæ¦‚å¿µåœ¨ Kubernetes é‡Œçš„ä¸»è¦ä½“ç°ã€‚

```ABAP
å½“ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„ Pod è°ƒåº¦å¤±è´¥çš„æ—¶å€™ï¼Œè°ƒåº¦å™¨çš„æŠ¢å èƒ½åŠ›å°±ä¼šè¢«è§¦å‘ã€‚è¿™æ—¶ï¼Œè°ƒåº¦å™¨å°±ä¼šè¯•å›¾ä»å½“å‰é›†ç¾¤é‡Œå¯»æ‰¾ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½¿å¾—å½“è¿™ä¸ªèŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªä½ä¼˜å…ˆçº§ Pod è¢«åˆ é™¤åï¼Œå¾…è°ƒåº¦çš„é«˜ä¼˜å…ˆçº§ Pod å°±å¯ä»¥è¢«è°ƒåº¦åˆ°è¿™ä¸ªèŠ‚ç‚¹ä¸Šã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå°±æ˜¯â€œæŠ¢å â€è¿™ä¸ªæ¦‚å¿µåœ¨ Kubernetes é‡Œçš„ä¸»è¦ä½“ç°
```



**å®˜æ–¹é»˜è®¤ PriorityClass å¯¹ç…§è¡¨ï¼š**

| PriorityClass åç§°        | å€¼ï¼ˆvalueï¼‰                   | ç”¨é€”                                                        |
| ------------------------- | ----------------------------- | ----------------------------------------------------------- |
| `system-cluster-critical` | `2000001000`                  | é›†ç¾¤çº§å…³é”®ç»„ä»¶ï¼ˆå¦‚ `kube-apiserver`, `controller-manager`ï¼‰ |
| `system-node-critical`    | `2000000000`                  | èŠ‚ç‚¹çº§å…³é”®ç»„ä»¶ï¼ˆå¦‚ `kubelet`, `kube-proxy`ï¼‰                |
| ç”¨æˆ·è‡ªå®šä¹‰                | é€šå¸¸ä» `0` æˆ– `1000000000` èµ· | åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œè¶Šé«˜è¶Šä¼˜å…ˆ                                    |





## 4. Service

### Serviceæ˜¯ä»€ä¹ˆ

Service æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª**å››å±‚çš„åå‘ä»£ç†**ï¼Œé›†ç¾¤å†…å’Œå¤–çš„å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å¦‚ä¸‹æµç¨‹æœ€ç»ˆå®ç°è®¿é—®Podåº”ç”¨

```ABAP
é›†ç¾¤å†…éƒ¨Client --> serviceç½‘ç»œ --> Podç½‘ç»œ --> å®¹å™¨åº”ç”¨
é›†ç¾¤å¤–éƒ¨Client --> é›†ç¾¤å†…èŠ‚ç‚¹ç½‘ç»œ --> serviceç½‘ç»œ --> Podç½‘ç»œ --> å®¹å™¨åº”ç”¨

Kubernetesç½‘ç»œ
Podç½‘ç»œ     ----  cni
Serviceç½‘ç»œ ----  kubeproxy
nodeç½‘ç»œ    ----  å®¿ä¸»æœºç½‘ç»œ
```



**Service æ ¸å¿ƒåŠŸèƒ½**

- æœåŠ¡å‘ç°: åˆ©ç”¨æ ‡ç­¾é€‰æ‹©å™¨ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­ç­›é€‰ç¬¦åˆçš„æ¡ä»¶çš„Pod, ä»é¢å®ç°å‘ç°ä¸€ç»„æä¾› äº†ç›¸åŒæœåŠ¡çš„Pod
- è´Ÿè½½å‡è¡¡: Serviceä½œä¸ºæµé‡å…¥å£å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œå…¶å…¥å£ä¸ºClusterIP, è¿™ç»„ç­›é€‰å‡ºçš„Podçš„IPåœ°å€ï¼Œå°† ä½œä¸ºè¯¥Serviceçš„åç«¯æœåŠ¡å™¨
- åç§°è§£æ: åˆ©ç”¨Cluster DNSï¼Œä¸ºè¯¥ç»„Podæ‰€ä»£è¡¨çš„æœåŠ¡æä¾›ä¸€ä¸ªåç§°, åœ¨DNSä¸­ å¯¹äºæ¯ä¸ªServiceï¼Œ è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªAã€PTRå’ŒSRVè®°å½•



**Endpoints**

å½“åˆ›å»º Serviceèµ„æºçš„æ—¶å€™ï¼Œæœ€é‡è¦çš„å°±æ˜¯ä¸ºServiceæŒ‡å®šèƒ½å¤Ÿæä¾›æœåŠ¡çš„æ ‡ç­¾é€‰æ‹©å™¨

Service Controllerå°±ä¼šæ ¹æ®æ ‡ç­¾é€‰æ‹©å™¨ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒåçš„**Endpoint**èµ„æºå¯¹è±¡ï¼ŒKubernetesæ–°ç‰ˆä¸­è¿˜å¢åŠ äº†**endpointslices**èµ„æº

- Endpoint Controllerä½¿ç”¨Endpointçš„æ ‡ç­¾é€‰æ‹©å™¨(ç»§æ‰¿è‡ªServiceæ ‡ç­¾é€‰æ‹©å™¨)ï¼Œç­›é€‰ç¬¦åˆæ¡ä»¶(åŒ…æ‹¬ ç¬¦åˆæ ‡ç­¾é€‰æ‹©å™¨æ¡ä»¶å’Œå¤„äºReady çŠ¶æ€)çš„podèµ„æº
- Endpoint Controller å°†ç¬¦åˆè¦æ±‚çš„podèµ„æºç»‘å®šåˆ°Endpointä¸Šï¼Œå¹¶å‘ŠçŸ¥ç»™Serviceèµ„æºè°å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡
- Service ä¼šè‡ªåŠ¨è·å–ä¸€ä¸ªå›ºå®šçš„ **cluster IP**å‘å¤–æä¾›ç”±Endpointæä¾›çš„æœåŠ¡èµ„æº
- Service å…¶å®å°±æ˜¯ä¸ºåŠ¨æ€çš„ä¸€ç»„ pod èµ„æºå¯¹è±¡æä¾›ä¸€ä¸ªå›ºå®šçš„è®¿é—®å…¥å£ã€‚å³ Serviceå®ç°äº†åç«¯Pod åº”ç”¨æœåŠ¡çš„



![image-20241223151136366](../markdown_img/image-20241223151136366.png)





- æ¯åˆ›å»ºä¸€ä¸ªService ,è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå’Œä¹‹åŒåçš„API èµ„æºç±»å‹ Endpoints
- Endpointsè´Ÿè´£ç»´æŠ¤ç”±ç›¸å…³Serviceæ ‡ç­¾é€‰æ‹©å™¨åŒ¹é…çš„Podå¯¹è±¡
- Endpointså¯¹è±¡ä¸Šä¿å­˜ServiceåŒ¹é…åˆ°çš„æ‰€æœ‰Podçš„IPå’ŒPortä¿¡æ¯,ç§°ä¹‹ä¸ºç«¯ç‚¹
- ETCDæ˜¯K/Væ•°æ®åº“, è€Œä¸€ä¸ª**Endpointså¯¹è±¡å¯¹åº”ä¸€ä¸ªKey**,æ‰€æœ‰**åç«¯Podç«¯ç‚¹ä¿¡æ¯ä¸ºå…¶Value**
- å½“ä¸€ä¸ªEndpointså¯¹è±¡å¯¹åº”åç«¯æ¯ä¸ªPodçš„æ¯æ¬¡å˜åŠ¨ï¼Œéƒ½éœ€æ›´æ–°æ•´ä¸ªEndpointså¯¹è±¡ï¼Œå¹¶å°†æ–°çš„ Endpointså¯¹è±¡é‡æ–°ä¿å­˜è‡³API Serverå’ŒETCD
- æ­¤å¤–è¿˜éœ€è¦å°†è¯¥å¯¹è±¡åŒæ­¥è‡³æ¯ä¸ªèŠ‚ç‚¹çš„kube-proxy
- åœ¨ETCDä¸­çš„å¯¹è±¡é»˜è®¤æœ€å¤§ä¸º1.5MB,ä¸€ä¸ªEndpointså¯¹è±¡è‡³å¤šå¯ä»¥å­˜å‚¨5000ä¸ªå·¦å³çš„ç«¯ç‚¹ä¿¡æ¯,è¿™æ„ å‘³ç€å¹³å‡æ¯ç«¯ç‚¹å 300KB



**Serviceç±»å‹**

å¯¹äºKubernetes å¯ä»¥å®ç°å†…éƒ¨æœåŠ¡çš„è‡ªç”±é€šä¿¡,ä¹Ÿå¯ä»¥å°†å¹³å°å†…éƒ¨çš„æœåŠ¡å‘å¸ƒåˆ°å¤–éƒ¨ç¯å¢ƒ

Serviceä¸»è¦æœ‰å››ç§ç±»å‹ï¼Œå®ç°ä¸åŒçš„ç½‘ç»œé€šä¿¡åŠŸèƒ½

- ClusterIP
- NodePort
- LoadBalancer
- ExternalName



| ç±»å‹         | è§£æ                                                         |
| ------------ | ------------------------------------------------------------ |
| ClusterIP    | æ­¤ä¸ºServiceçš„é»˜è®¤ç±»å‹<br />ä¸º**é›†ç¾¤å†…éƒ¨çš„å®¢æˆ·ç«¯è®¿é—®**,åŒ…æ‹¬èŠ‚ç‚¹å’ŒPodç­‰ï¼Œ**å¤–éƒ¨ç½‘ç»œæ— æ³•è®¿é—®**<br />In client --> clusterIP: ServicePort (Service) --> PodIP: PodPort |
| NodePort     | æœ¬è´¨ä¸Š**åœ¨ClusterIPæ¨¡å¼åŸºç¡€ä¸Š,å†å¤šåŠ äº†ä¸€å±‚ç«¯å£æ˜ å°„çš„å°è£…**,ç›¸å½“äºå¢å¼ºç‰ˆçš„ ClusterIP<br />é€šè¿‡NodeIP:NodePortå¯¹å¤–éƒ¨ç½‘ç»œæä¾›æœåŠ¡ï¼Œé»˜è®¤**éšæœºç«¯å£èŒƒå›´30000~32767**, å¯æŒ‡å®šä¸ºå›ºå®šç«¯å£<br />NodePortæ˜¯ä¸€ä¸ªéšæœºçš„ç«¯å£ï¼Œä»¥é˜²æ­¢ç«¯å£å†²çª,åœ¨**æ‰€æœ‰å®‰è£…kube-proxyçš„èŠ‚ç‚¹ ä¸Šéƒ½ä¼šæ‰“å¼€æ­¤ç›¸åŒçš„ç«¯å£**<br />å¯é€šè¿‡è®¿é—®ClusterIPå®ç°é›†ç¾¤å†…éƒ¨è®¿é—®,ä¹Ÿå¯ä»¥é€šè¿‡NodeIP:NortPortçš„æ–¹å¼å® ç°ä»é›†ç¾¤å¤–éƒ¨è‡³å†…éƒ¨çš„è®¿é—®<br />Ex Client --> NodeIP:NodePort (Service) --> PodIP:PodPort |
| LoadBalancer | åŸºäºNodePortåŸºç¡€ä¹‹ä¸Š**ï¼Œä½¿ç”¨é›†ç¾¤å¤–éƒ¨çš„è¿è¥å•†è´Ÿè½½å‡è¡¡å™¨æ–¹å¼å®ç°å¯¹å¤–æä¾›** æœåŠ¡,å¢å¼ºç‰ˆçš„NodePort<br/>åŸºäºäº‘è¿è¥å•†IaaSäº‘åˆ›å»ºä¸€ä¸ªKubernetesäº‘ï¼Œäº‘å¹³å°ä¹Ÿæ”¯æŒLBaaS(Load Balance as a Service)äº§å“æœåŠ¡<br/>Masterå€ŸåŠ©cloud-managerå‘LBaaSçš„APIè¯·æ±‚åŠ¨æ€åˆ›å»ºè½¯ä»¶LB,å³æ”¯æŒå’ŒKubernetes API Server è¿›è¡Œäº¤äº’<br/>å¦‚æœæ²¡æœ‰äº‘æœåŠ¡,å°†æ— æ³•è·å–EXTERNAL-IP,æ˜¾ç¤ºPendingçŠ¶æ€,åˆ™é™çº§ä¸º NodePortç±»å‹<br/>Ex Client --> LB_IP:LB_PORT --> NodeIP:NodePort(Service)--> PodIP:PodPort |
| ExternalName | å½“Kubernetesé›†ç¾¤éœ€è¦è®¿é—®é›†ç¾¤å¤–éƒ¨æœåŠ¡æ—¶ï¼Œéœ€è¦é€šè¿‡externalName**å°†å¤–éƒ¨ä¸»æœºå¼•å…¥åˆ°é›†ç¾¤å†…éƒ¨**<br />å¤–éƒ¨ä¸»æœºåä»¥ DNSæ–¹å¼è§£æä¸ºä¸€ä¸ª CNAMEè®°å½•ç»™Kubernetesé›†ç¾¤çš„å…¶ä»–ä¸»æœºæ¥ä½¿ç”¨<br />**è¿™ç§Serviceæ—¢æ²¡æœ‰ClusterIPï¼Œä¹Ÿæ²¡æœ‰NodePort.è€Œä¸”ä¾èµ–äºå†…éƒ¨çš„CoreDNSåŠŸèƒ½**<br />In client -->Cluster ServiceName --> CName --> External Service Name |





## 5. Ingress

Ingress æ˜¯ Kubernetes ä¸­ç”¨æ¥ç®¡ç†å¤–éƒ¨ **HTTP/HTTPS** æµé‡è¿›å…¥é›†ç¾¤çš„ API å¯¹è±¡ï¼Œé…åˆ Ingress Controller å®ç°åŸºäºåŸŸåã€è·¯å¾„ç­‰è§„åˆ™çš„ä¸ƒå±‚åå‘ä»£ç†è·¯ç”±åŠŸèƒ½ã€‚



**ingress ä¸»è¦åŒ…å«ä¸¤ä¸ªç»„ä»¶Ingress APIå’ŒIngress Controller**

ingress å…¶å…·å¤‡äº†åŠ¨æ€æ›´æ–°å¹¶åŠ è½½æ–°é…ç½®çš„ç‰¹æ€§ã€‚è€Œä¸”ingressæœ¬èº«æ˜¯ä¸å…·å¤‡å®ç°é›†ç¾¤å†…å¤–æµé‡é€šä¿¡çš„åŠŸèƒ½çš„ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡ controlleræ¥å®ç°çš„ã€‚**Ingress Controlleræœ¬èº«æ˜¯è¿è¡Œäºé›†ç¾¤ä¸­çš„Podèµ„æºå¯¹è±¡**

| ç»„ä»¶               | è§£æ                                                         |
| ------------------ | ------------------------------------------------------------ |
| Ingress API        | Kubernetesä¸Šçš„æ ‡å‡†APIèµ„æºç±»å‹ä¹‹ä¸€ ä»…å®šä¹‰äº†æŠ½è±¡è·¯ç”±é…ç½®ä¿¡æ¯ï¼Œåªæ˜¯å…ƒæ•°æ®ï¼Œéœ€è¦ç”±ç›¸åº”çš„æ§åˆ¶å™¨åŠ¨æ€åŠ è½½ å°†ä»£ç†é…ç½®æŠ½è±¡æˆä¸€ä¸ªIngresså¯¹è±¡ï¼Œæ¯ä¸ªæœåŠ¡å¯¹åº”ä¸€ä¸ªyamlé…ç½®æ–‡ä»¶ è´Ÿè´£ä»¥k8sæ ‡å‡†çš„èµ„æºæ ¼å¼å®šä¹‰æµé‡è°ƒåº¦ã€è·¯ç”±ç­‰è§„åˆ™ å±äºåç§°ç©ºé—´çº§èµ„æº,å®Œæˆå°†åŒä¸€ä¸ªåç©ºé—´çš„serviceèµ„æºè¿›è¡Œæš´éœ² |
| Ingress Controller | ä¸ƒå±‚åå‘ä»£ç†æœåŠ¡ç¨‹åº éœ€è¦ç›‘è§†ï¼ˆwatchï¼‰API Serverä¸Š Ingressèµ„æºçš„å˜åŠ¨ï¼Œå¹¶ç”Ÿæˆå…·ä½“åº”ç”¨çš„è‡ªèº«çš„é… ç½®æ–‡ä»¶æ ¼å¼ï¼Œå³å°†æ–°åŠ å…¥çš„Ingressè½¬åŒ–æˆåå‘ä»£ç†çš„é…ç½®æ–‡ä»¶å¹¶åŠ¨æ€åŠ è½½ä½¿ä¹‹ç”Ÿæ•ˆï¼Œæœ€ç»ˆå¹¶æ®æ­¤å®Œæˆæµé‡è½¬å‘ <br />Ingress Controlleréä¸ºå†…ç½®çš„æ§åˆ¶å™¨ï¼Œéœ€è¦é¢å¤–è‡ªè¡Œéƒ¨ç½² <br />é€šå¸¸ä»¥Podå½¢å¼è¿è¡ŒäºKubernetesé›†ç¾¤ä¹‹ä¸Š ä¸€èˆ¬åº”è¯¥ç”±ä¸“ç”¨çš„LB Serviceè´Ÿè´£ä¸ºå…¶æ¥å…¥é›†ç¾¤å¤–éƒ¨æµé‡ |



#### Ingress è®¿é—®è¿‡ç¨‹

- ä»å¤–éƒ¨æµé‡è°ƒåº¦åˆ°kubernetesä¸­Ingress serviceï¼Œæœ‰å¤šç§å®ç°æ–¹æ¡ˆï¼Œæ¯”å¦‚ä½¿ç”¨èŠ‚ç‚¹ç½‘ç»œä¸­çš„ EXTERNAL-IPæˆ–è€…NodePortæ–¹å¼
- ä»serviceè°ƒåº¦åˆ°ingress-controller
- ingress-controlleræ ¹æ®ingress Pod ä¸­çš„å®šä¹‰ï¼Œæ¯”å¦‚è™šæ‹Ÿä¸»æœºæˆ–è€…åç«¯çš„url
- æ ¹æ®è™šæ‹Ÿä¸»æœºåç›´æ¥è°ƒåº¦åˆ°åç«¯çš„ä¸€ç»„åº”ç”¨podä¸­

![image-20250104101257362](../markdown_img/image-20250104101257362.png)

æ³¨æ„ï¼š

- æ•´ä¸ªæµç¨‹ä¸­æ¶‰åŠåˆ°äº†ä¸¤å¤„serviceå†…å®¹
- service ingress-nginx æ˜¯å¸®åŠ© ingress controller Pod æ¥å…¥å¤–éƒ¨æµé‡çš„
- **åç«¯çš„æœåŠ¡å¯¹åº”çš„service**åªèµ·åˆ°å¸®åŠ© ingress controller Pod æ‰¾åˆ°å…·ä½“çš„æœåŠ¡çš„Podï¼Œå³**åªç”¨äºæœåŠ¡å‘ç°** ï¼Œè€Œ**æµé‡ä¸éœ€è¦ç»è¿‡åç«¯æœåŠ¡çš„Service**ï¼Œç›´æ¥ä»ingress controller Podè½¬åˆ°è‡³å…·ä½“çš„Pod
- è™šçº¿è¡¨ç¤ºserviceå¯¹åç«¯çš„åº”ç”¨è¿›è¡Œåˆ†ç»„ï¼Œå®çº¿è¡¨ç¤ºingresså®é™…çš„è®¿é—®æµå‘



#### è¡¥å……ï¼šä¸‰ç§ `pathType` åŠå…¶å«ä¹‰ä¸ä½¿ç”¨æ–¹å¼

1ï¸âƒ£ `Exact`

- **å«ä¹‰**ï¼šå®Œå…¨åŒ¹é…è·¯å¾„ï¼Œåªæœ‰è¯·æ±‚è·¯å¾„ä¸è§„åˆ™ä¸­çš„è·¯å¾„ **å®Œå…¨ä¸€è‡´** æ‰ä¼šè¢«åŒ¹é…ã€‚
- **åœºæ™¯**ï¼šé€‚ç”¨äºéœ€è¦ç²¾ç¡®æ§åˆ¶çš„ API å…¥å£ç­‰æƒ…å†µã€‚

**ç¤ºä¾‹ï¼š**

```yaml
path: /app
pathType: Exact
```

| è¯·æ±‚è·¯å¾„  | æ˜¯å¦åŒ¹é… |
| --------- | -------- |
| `/app`    | âœ… æ˜¯     |
| `/app/`   | âŒ å¦     |
| `/app/v1` | âŒ å¦     |



2ï¸âƒ£ `Prefix`

- **å«ä¹‰**ï¼šåŒ¹é…ä»¥æŒ‡å®šè·¯å¾„ä¸ºå‰ç¼€çš„è¯·æ±‚è·¯å¾„ï¼Œä¸”è·¯å¾„åˆ†æ®µï¼ˆä»¥ `/` åˆ†éš”ï¼‰å¿…é¡»å®Œæ•´åŒ¹é…ã€‚
- **è¿™æ˜¯ä½¿ç”¨æœ€å¹¿æ³›çš„ç±»å‹**ã€‚

**ç¤ºä¾‹ï¼š**

```yaml
path: /app
pathType: Prefix
```

| è¯·æ±‚è·¯å¾„       | æ˜¯å¦åŒ¹é… |
| -------------- | -------- |
| `/app`         | âœ… æ˜¯     |
| `/app/`        | âœ… æ˜¯     |
| `/app/page`    | âœ… æ˜¯     |
| `/application` | âŒ å¦     |

æ³¨æ„ï¼š**`/app/page`** âœ… æ˜¯å› ä¸ºå®ƒæ˜¯ä»¥ `/app` è¿™ä¸ªæ®µå¼€å¤´ï¼Œè€Œ `/application` âŒ æ˜¯å› ä¸ºæ•´ä¸ªæ®µä¸åŒ¹é…ã€‚



3ï¸âƒ£ `ImplementationSpecific`

- **å«ä¹‰**ï¼šç”± Ingress Controller è‡ªå·±å†³å®šå¦‚ä½•åŒ¹é…è·¯å¾„ï¼Œè¡Œä¸º **å¯èƒ½å› æ§åˆ¶å™¨ä¸åŒè€Œå¼‚**ã€‚
- **ä¸æ¨èç”Ÿäº§ä½¿ç”¨**ï¼Œå®¹æ˜“å‡ºç°ä¸ä¸€è‡´è¡Œä¸ºã€‚

 **ç¤ºä¾‹ï¼š**

```
path: /app
pathType: ImplementationSpecific
```

| è¯·æ±‚è·¯å¾„    | æ˜¯å¦åŒ¹é… |
| ----------- | -------- |
| `/app`      | å¯èƒ½æ˜¯   |
| `/app2`     | å¯èƒ½ä¹Ÿæ˜¯ |
| `/app/test` | å¯èƒ½æ˜¯   |

å–å†³äºä½ ç”¨çš„æ˜¯å“ªä¸ª Ingress Controllerï¼Œä¾‹å¦‚ NGINXã€Traefikã€HAProxy ç­‰éƒ½å®ç°ç•¥æœ‰ä¸åŒã€‚





## 6. GatewayAPI

Gateway API æ˜¯ Kubernetes Ingress æ¨¡å‹çš„ä¸‹ä¸€ä»£æ ‡å‡†ã€‚å®ƒé€šè¿‡å°† Gatewayï¼ˆå…¥å£å®šä¹‰ï¼‰å’Œ Routeï¼ˆæµé‡è§„åˆ™ï¼‰è§£è€¦ï¼Œæ”¯æŒå¤šåè®®ï¼ˆHTTPã€TCPã€UDPã€TLSï¼‰ï¼Œå…è®¸å¤šç§Ÿæˆ·åä½œç®¡ç†ï¼Œæä¾›æ ‡å‡†çš„çŠ¶æ€åé¦ˆå’Œæ›´ä¸°å¯Œçš„è·¯ç”±èƒ½åŠ›ã€‚ç›¸æ¯” Ingressï¼ŒGateway API æ›´åŠ çµæ´»ã€å¯æ‰©å±•ï¼Œé€‚åˆå¤æ‚ä¼ä¸šç¯å¢ƒä¸­çš„æµé‡æ²»ç†å’Œç½‘å…³ç®¡ç†éœ€æ±‚ã€‚



**Gateway API è§£å†³äº†å“ªäº› Ingress çš„å±€é™ï¼Ÿ**

| èƒ½åŠ›/ç‰¹ç‚¹          | Ingressï¼ˆV1ï¼‰                            | Gateway APIï¼ˆV2ï¼‰                           |
| ------------------ | ---------------------------------------- | ------------------------------------------- |
| **åè®®æ”¯æŒ**       | ä¸»è¦æ˜¯ HTTP/HTTPS                        | æ”¯æŒ HTTPã€HTTPSã€TCPã€UDPã€TLS             |
| **èµ„æºç²’åº¦**       | å…¥å£+è·¯ç”± æ··åœ¨ä¸€ä¸ªèµ„æºé‡Œ                 | å…¥å£å’Œè·¯ç”±è§£è€¦ï¼ˆGateway + Routeï¼‰           |
| **å¤šç§Ÿæˆ·ç®¡ç†**     | ä¸å¥½æ§åˆ¶ï¼Œå•ä¸€ IngressClass              | Gateway ç‹¬ç«‹ï¼ŒRoute å¯åˆ†å›¢é˜Ÿç®¡ç†            |
| **è´Ÿè½½å‡è¡¡ç­–ç•¥**   | å—é™                                     | æ›´ä¸°å¯Œï¼Œæ¯”å¦‚ headerã€methodã€SNI åˆ†æµ       |
| **è·¨å‘½åç©ºé—´è·¯ç”±** | ä¸æ”¯æŒ(è¯­æ³•æ”¯æŒï¼Œå¤§éƒ¨åˆ†controllerä¸æ”¯æŒ) | âœ… æ”¯æŒè·¨å‘½åç©ºé—´ç®¡ç†                        |
| **å¯è§‚æµ‹æ€§**       | ä¾èµ–æ§åˆ¶å™¨                               | å®šä¹‰æ ‡å‡†çš„çŠ¶æ€åé¦ˆ                          |
| **æ ‡å‡†åŒ–**         | Controller è‡ªå®šä¹‰è¾ƒå¤š                    | æä¾›ç»Ÿä¸€ API è§„èŒƒï¼Œè·¨ Controller å…¼å®¹æ€§æ›´å¥½ |



![image-20250320135332678](../markdown_img/image-20250320135332678.png)



å¦‚ä¸Šå›¾ï¼šGateway API æŠŠäººå‘˜è§’è‰²åˆ†ä¸º3ç±»

1. **Infrastructure Provider**ï¼šåŸºç¡€è®¾æ–½æä¾›è€…ï¼Œä¸»è¦è´Ÿè´£GatewayClassï¼ŒæŠŠGateway Controller å’Œ Gateway å…³è”èµ·æ¥ï¼Œè´Ÿè´£æ•´ä¸ªåº•å±‚è®¾æ–½çš„æä¾›ï¼Œç»™Gateway æä¾› gatewayClassName
2. **Cluster Operator**ï¼šé›†ç¾¤æ“ä½œè€…ï¼Œä¸»è¦è´Ÿè´£ Gatewayï¼Œ**ç±»ä¼¼åå‘ä»£ç†çš„å‰ç«¯**
3. **Application Develops**ï¼šåº”ç”¨å¼€å‘è€…ï¼Œè´Ÿè´£å¼€å‘ä¸šåŠ¡ Serviceï¼Œ**ç±»ä¼¼åå‘ä»£ç†çš„åç«¯**



### Gateway-API-æµé‡åˆ†å‘æµç¨‹

#### A Simple Gateway

![image-20250320141009871](D:\git_repository\cyber_security_learning\markdown_img\image-20250320141009871-1746761050480-1.png)

**1ï¸âƒ£ å®¢æˆ·ç«¯è¯·æ±‚**

å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚æµè§ˆå™¨æˆ– API è°ƒç”¨ï¼‰å‘æŸä¸ªåŸŸåæˆ– IP å‘èµ· HTTP/S è¯·æ±‚ã€‚

**2ï¸âƒ£ è´Ÿè½½å‡è¡¡ï¼ˆGatewayï¼‰**

**Gateway** ç»„ä»¶å……å½“äº†æ•´ä¸ªç³»ç»Ÿçš„å…¥å£ï¼Œé€šå¸¸å¯¹åº”ä¸€ä¸ª **Load Balancer**ï¼ˆè´Ÿè½½å‡è¡¡å™¨ï¼‰æˆ–è€… Kubernetes å†…éƒ¨çš„ `Gateway` èµ„æºã€‚

- Gateway çš„ä½œç”¨
  - ç›‘å¬å¤–éƒ¨è¯·æ±‚ï¼ˆé€šå¸¸æ˜¯ HTTP æˆ– HTTPSï¼‰
  - å°†åŒ¹é…çš„æµé‡è½¬å‘ç»™é€‚å½“çš„ **HTTPRoute**
  - å¯ç»‘å®šå¤šä¸ª `HTTPRoute` èµ„æºï¼Œå¤„ç†ä¸åŒè·¯å¾„çš„æµé‡

**Gateway é…ç½®ç¤ºä¾‹**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: foo-gateway
  namespace: default
spec:
  gatewayClassName: nginx
  listeners:
    - protocol: HTTP
      port: 80
      name: http
      allowedRoutes:
        namespaces:
          from: All	
```

- **gatewayClassName: nginx** â†’ è¯´æ˜ä½¿ç”¨ Nginx Gateway Controller å¤„ç†æµé‡

- **listeners.port: 80** â†’ ç›‘å¬ HTTP 80 ç«¯å£

- **allowedRoutes** â†’ å…è®¸æ‰€æœ‰å‘½åç©ºé—´çš„ `HTTPRoute` å…³è”è¯¥ `Gateway`

**3ï¸âƒ£ è·¯ç”±åŒ¹é…ï¼ˆHTTPRouteï¼‰**

**HTTPRoute** è´Ÿè´£å®šä¹‰æµé‡çš„è½¬å‘è§„åˆ™ï¼Œä¾‹å¦‚ï¼š

- **è·¯å¾„åŒ¹é…ï¼ˆPath Matchingï¼‰**
- **ä¸»æœºåŒ¹é…ï¼ˆHost Matchingï¼‰**
- **æµé‡æƒé‡ï¼ˆTraffic Splittingï¼‰**

**HTTPRoute é…ç½®ç¤ºä¾‹**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: foo-route
  namespace: default
spec:
  parentRefs:
    - name: foo-gateway  # ç»‘å®š Gateway
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: "/"  # åŒ¹é…æ‰€æœ‰æµé‡
      backendRefs:
        - name: foo-svc  # æŒ‡å®š Service
          port: 80
```

- **`parentRefs: foo-gateway`** â†’ è¯´æ˜è¯¥ HTTPRoute ç»‘å®šåˆ° `foo-gateway`
- **`matches: path: "/"`** â†’ è¯´æ˜åŒ¹é…æ‰€æœ‰è¯·æ±‚è·¯å¾„
- **`backendRefs: foo-svc`** â†’ æŒ‡å®šæµé‡è½¬å‘åˆ° `foo-svc` Service

**4ï¸âƒ£ Service å‘ç°**

Gateway å‘ç° `foo-svc` Serviceï¼Œå¹¶å°†æµé‡è½¬å‘ç»™è¯¥ Serviceã€‚

- Service çš„ä½œç”¨
  - è´Ÿè´£è´Ÿè½½å‡è¡¡ï¼Œå°†è¯·æ±‚è½¬å‘ç»™ Pod
  - é€šè¿‡ `selector` é€‰æ‹©åŒ¹é…çš„ Pod

**Service é…ç½®ç¤ºä¾‹**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: foo-svc
  namespace: default
spec:
  selector:
    app: foo
  ports:
    - port: 80
      targetPort: 8080  # è½¬å‘åˆ° Pod çš„ 8080 ç«¯å£
```

- **selector: app=foo** â†’ é€‰æ‹©æ ‡ç­¾ä¸º `app=foo` çš„ Pod
- **port: 80 â†’ targetPort: 8080** â†’ Service ç›‘å¬ 80 ç«¯å£ï¼Œä½†å®é™…è½¬å‘ç»™ Pod çš„ 8080 ç«¯å£

**5ï¸âƒ£ è¿›å…¥ Pod**

æœ€ç»ˆï¼Œæµé‡ä¼šè¢«è·¯ç”±åˆ° **ç¬¦åˆ `app=foo` é€‰æ‹©å™¨çš„ Pod**ï¼ŒPod ä¸Šçš„åº”ç”¨ç¨‹åºå¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”ã€‚

```ABAP
æ³¨æ„ï¼šå’ŒIngressç›¸åŒï¼Œä» Gateway API æ¥æ”¶è¯·æ±‚ä¼šç›´æ¥å‘å¾€åç«¯ Podï¼ŒServiceåœ¨è¿™é‡Œç”¨ä½œæœåŠ¡å‘ç°
```



### è¡¥å……ï¼š**ä¸ºä»€ä¹ˆ Gateway å’Œ HTTPRoute éƒ½è¦æ±‚ Hostname**

- **Gateway ä¸Šçš„ `hostname`**
   é™åˆ¶äº†å…¥å£èƒ½æ¥å—çš„**å®¢æˆ·ç«¯è¯·æ±‚çš„åŸŸåèŒƒå›´**ï¼ˆSNI æˆ– HTTP Host å¤´ï¼‰ã€‚
  - ä½œç”¨ï¼š**å…¥å£é™åˆ¶**
    - â€œå“ªäº›åŸŸåçš„æµé‡å¯ä»¥è¿›å…¥è¿™ä¸ª Gateway Listenerï¼Ÿâ€
    - æ¯”å¦‚ï¼šåªå…è®¸ `*.example.com`
- **HTTPRoute ä¸Šçš„ `hostname`**
   **å£°æ˜è·¯ç”±è§„åˆ™å¤„ç†å“ªäº› Hostname çš„æµé‡**ï¼ˆäºŒæ¬¡è¿‡æ»¤æˆ–ç²¾ç¡®åŒ¹é…ï¼‰ã€‚
  - ä½œç”¨ï¼š**è·¯ç”±åŒ¹é…**
    - â€œè¿›å…¥ Gateway åï¼Œå“ªäº›åŸŸåçš„æµé‡å½’è¿™ä¸ª Route å¤„ç†ï¼Ÿâ€
    - æ¯”å¦‚ï¼š`app.example.com`



#### çœŸå®ç¤ºä¾‹

**1. Gatewayï¼ˆå…¥å£é™åˆ¶ï¼‰**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: shared-gateway
spec:
  listeners:
  - name: https
    protocol: HTTPS
    port: 443
    hostname: "*.example.com"
```

- è¡¨ç¤ºï¼š**åªå…è®¸ `\*.example.com` çš„æµé‡è¿›å…¥ Gateway**



**2. HTTPRoute-Aï¼ˆapp1 ä¸“å±ï¼‰**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: app1-route
spec:
  hostnames:
    - "app1.example.com"
```

- è¡¨ç¤ºï¼šåªå¤„ç† `app1.example.com` çš„æµé‡****



**3. HTTPRoute-Bï¼ˆapp2 ä¸“å±ï¼‰**

```yaml
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: app2-route
spec:
  hostnames:
    - "app2.example.com"
```

- è¡¨ç¤ºï¼š**åªå¤„ç† `app2.example.com` çš„æµé‡**





## 7. PVC

#### å­˜å‚¨æœºåˆ¶

Container ä¸­çš„æ–‡ä»¶åœ¨ç£ç›˜ä¸Šæ˜¯ä¸´æ—¶å­˜æ”¾çš„ï¼Œè¿™ç»™ Container ä¸­è¿è¡Œçš„è¾ƒé‡è¦çš„åº”ç”¨ç¨‹åºå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚

- å½“å®¹å™¨å´©æºƒæ—¶ã€‚ kubelet å¯èƒ½ä¼šé‡æ–°åˆ›å»ºå®¹å™¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®¹å™¨æ¼‚ç§»è‡³æ–°çš„å®¿ä¸»æœºï¼Œå®¹å™¨ä¼šä»¥å¹²å‡€çš„çŠ¶æ€é‡å»ºã€‚å¯¼è‡´æ•°æ®ä¸¢å¤±
- åœ¨åŒä¸€ Pod ä¸­è¿è¡Œå¤šä¸ªå®¹å™¨éœ€è¦å…±äº«æ•°æ®



Kubernetes å·ï¼ˆVolumeï¼‰ è¿™ä¸€æŠ½è±¡æ¦‚å¿µèƒ½å¤Ÿè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜



**Kubernetes å­˜å‚¨æ¶æ„**

å­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€ scheduler

æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜ç¡®

![image-20241225150025215](../markdown_img/image-20241225150025215.png)



**Controller-Managerä¸­çš„ç»„ä»¶**

- **Attach/Detach Controller**
  - **èŒè´£**ï¼šç®¡ç†â€œè¿œç¨‹å­˜å‚¨å·â€ï¼ˆå¦‚ iSCSIã€NFSã€äº‘ç›˜ç­‰ï¼‰ä¸èŠ‚ç‚¹ä¹‹é—´çš„â€œæŒ‚è½½å£°æ˜â€ã€‚
  - **ä½œç”¨**ï¼šå†³å®šå°†å·â€œé™„åŠ â€åˆ°å“ªä¸ªèŠ‚ç‚¹æˆ–â€œå¸è½½â€ä»å“ªä¸ªèŠ‚ç‚¹ç§»é™¤ã€‚
  - **ä¸¾ä¾‹**ï¼šåœ¨é˜¿é‡Œäº‘ã€AWSã€GCE ç­‰äº‘ç›˜å­˜å‚¨ï¼Œ**å…ˆ Attach åˆ° Nodeï¼Œå†æŒ‚è½½ç»™ Pod**ã€‚

- **PersistentVolume Controller**
  - **èŒè´£**ï¼šç®¡ç† **PVï¼ˆPersistent Volumeï¼‰** ä¸ **PVCï¼ˆPersistent Volume Claimï¼‰** çš„**ç”Ÿå‘½å‘¨æœŸå’Œç»‘å®šå…³ç³»**ã€‚
  - **ä½œç”¨**ï¼šè‡ªåŠ¨ç»‘å®šç¬¦åˆ PVC éœ€æ±‚çš„ PVï¼Œæˆ–æ ¹æ® StorageClass åŠ¨æ€åˆ›å»º PVã€‚

- **VolumeBinding Controller**
  - **èŒè´£**ï¼šåœ¨ **Pod è°ƒåº¦ä¹‹å‰** é¢„å…ˆç¡®å®š PVC ä¸ PV çš„ç»‘å®šå…³ç³»ã€‚
  - **ä½œç”¨**ï¼šè§£å†³å·è°ƒåº¦ä¸ Pod è°ƒåº¦çš„ä¸€è‡´æ€§é—®é¢˜ï¼Œä¿è¯å·å’Œ Pod è°ƒåº¦åˆ°åŒä¸€èŠ‚ç‚¹æˆ–å¯è®¿é—®çš„èŠ‚ç‚¹

- **PVC Protection Controller**
  - **èŒè´£**ï¼šé˜²æ­¢æ­£åœ¨è¢« Pod ä½¿ç”¨çš„ PVC è¢«è¯¯åˆ ã€‚
  - **ä½œç”¨**ï¼šä¿è¯å·çš„å®‰å…¨æ€§å’Œæ•°æ®å®Œæ•´æ€§ã€‚

- **StorageClass Controllerï¼ˆå¦‚æœä½¿ç”¨ï¼‰**
  - **èŒè´£**ï¼šç®¡ç†å­˜å‚¨ç­–ç•¥ï¼ˆå¦‚å­˜å‚¨ç±»å‹ã€æ€§èƒ½ç­‰çº§ã€å›æ”¶ç­–ç•¥ï¼‰
  - **ä½œç”¨**ï¼šæ ¹æ® PVC è¯·æ±‚è‡ªåŠ¨é€‰æ‹©æˆ–åˆ›å»ºç¬¦åˆç­–ç•¥çš„å­˜å‚¨å·ã€‚



**kubeletä¸­çš„å­˜å‚¨ç»„ä»¶**

- **Volume Manager (Kubelet å†…éƒ¨æ¨¡å—)**
  - **èŒè´£**ï¼šç®¡ç†èŠ‚ç‚¹ä¸Šçš„å·æŒ‚è½½ã€å¸è½½ã€æ ¼å¼åŒ–ç­‰æ“ä½œã€‚
  - **ä½œç”¨**ï¼š
    - **æ„ŸçŸ¥ Pod ç”Ÿå‘½å‘¨æœŸ**ï¼›
    - **åè°ƒå·ä¸èŠ‚ç‚¹çš„å…³ç³»**ï¼›
    - **é©±åŠ¨æŒ‚è½½æ“ä½œï¼ˆé€šè¿‡æ’ä»¶ï¼‰**

- **Volume Plugin**

  - **In-Tree Plugin**ï¼šKubeletå†…ç½®äº†In-Treeçš„æ’ä»¶é€»è¾‘ï¼ˆé€æ­¥åºŸå¼ƒï¼‰
  - **CSI Plugin**: Kubeletä½œä¸ºå®¢æˆ·ç«¯ï¼Œè°ƒç”¨ç”¨ç‹¬ç«‹éƒ¨ç½²çš„ CSI æ’ä»¶ DaemonSetï¼ˆæ¯”å¦‚ ceph-csiã€nfs-csiï¼‰

  ```ABAP
  æ— è®ºæ˜¯å†…ç½®æ’ä»¶è¿˜æ˜¯ CSI æ’ä»¶ï¼Œkubelet ç»Ÿä¸€è´Ÿè´£è°ƒç”¨
  ```

  - **ä½œç”¨**
    - **Node Plugin** æä¾›æŒ‚è½½æ“ä½œæ¥å£ï¼›
    - **Controller Plugin** æä¾›å·åˆ›å»ºã€åˆ é™¤ã€æ‰©å®¹ç­‰æ¥å£ã€‚



**CSIæ’ä»¶çš„å…¸å‹æ¶æ„**

- **Node Pluginï¼ˆDaemonSetï¼‰**ï¼šè¿è¡Œåœ¨æ¯ä¸ª Node ä¸Šï¼Œæä¾›æŒ‚è½½/å¸è½½æ“ä½œèƒ½åŠ›ã€‚

- **Controller Pluginï¼ˆDeployment/StatefulSetï¼‰**ï¼šé›†ç¾¤çº§åˆ«ï¼Œæä¾›å·åˆ›å»ºã€åˆ é™¤ã€å¿«ç…§ç­‰æ§åˆ¶æ“ä½œã€‚

- **ç¤ºä¾‹**

  ```bash
  ceph-csi-cephfs-nodeplugin-xxxxx   # Node DaemonSet
  ceph-csi-cephfs-provisioner-xxxxx  # Controller Deployment
  ```

  

#### å­˜å‚¨å…¨é“¾è·¯æ¶æ„äº¤äº’å›¾

![image-20241229204254515](../markdown_img/image-20241229204254515.png)



#### å®Œæ•´ã€å‡†ç¡®çš„ **Kubernetes å­˜å‚¨äº¤äº’æµç¨‹ï¼ˆæ§åˆ¶é¢ + æ•°æ®é¢ï¼‰**

**1ï¸âƒ£ ç”¨æˆ·æäº¤ PVC å’Œ Pod**

- ç”¨æˆ·é€šè¿‡ `kubectl apply` æäº¤ **PVC å’Œ Pod å®šä¹‰**ã€‚
- **kube-apiserver** æ¥æ”¶åˆ°è¿™äº›èµ„æºï¼Œå¹¶æŒä¹…åŒ–åˆ° etcdã€‚

**2ï¸âƒ£ PV Controller ç›‘å¬ PVC**

- **PV Controllerï¼ˆController-Managerï¼‰** å‘ç° PVC æœªç»‘å®šã€‚

  - å¦‚æœ PVC ç»‘å®šäº† StorageClassï¼Œåˆ™ **è°ƒç”¨ CSI Controller Plugin çš„ `CreateVolume` æ¥å£** åˆ›å»ºç‰©ç†å­˜å‚¨å·ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹
    - **PV Controller è°ƒç”¨ CSI Controller Pluginï¼ˆCreateVolumeï¼‰**
      - CSI Controller Plugin **å¹¶ä¸ç›´æ¥åˆ›å»ºå­˜å‚¨æ•°æ®**ï¼Œå®ƒè°ƒç”¨çš„æ˜¯ï¼š
        - Ceph é›†ç¾¤ API
        - NFS Provisioner API
        - AWS EBS API
      - **å­˜å‚¨ç³»ç»Ÿ** è´Ÿè´£å®é™…åˆ†é…å·æˆ–åˆ›å»ºåç«¯å­˜å‚¨èµ„æº
    - **CSI Controller Plugin å°†çŠ¶æ€è¿”å› PV Controller**
      - æ¯”å¦‚ï¼Œè¿”å›å· IDã€å®¹é‡ç­‰ä¿¡æ¯
    - **PV Controller åˆ›å»º PV èµ„æºå£°æ˜**
      - åŒ…å«å­˜å‚¨å· IDã€StorageClassã€å®¹é‡ç­‰æè¿°ä¿¡æ¯
      - åŒæ­¥åˆ° kube-apiserver

  ```ABAP
  PV Controller å‘èµ·è¯·æ±‚ â†’ CSI Controller Plugin è°ƒç”¨å­˜å‚¨ç³»ç»Ÿ â†’ è¿”å›ç»“æœç»™ PV Controller â†’ PV Controller åˆ›å»º PV èµ„æº
  
  è¿™é‡Œ PV Controller æ˜¯è¯·æ±‚çš„å‘èµ·è€…ï¼Œ
  CSI Controller Plugin æ˜¯æ‰§è¡Œè€…ï¼Œ
  å­˜å‚¨ç³»ç»Ÿæ˜¯æœ€ç»ˆæä¾›è€…ã€‚
  ```

**3ï¸âƒ£ VolumeBinding Controller ç»‘å®š PVC å’Œ PV**

- **VolumeBinding Controllerï¼ˆController-Managerï¼‰** å‘ç°æœ‰å¯ç”¨çš„ PVC å’Œ PVã€‚
  - å°† **PVC å’Œ PV è¿›è¡Œç»‘å®š**ã€‚
  - æ›´æ–° PVC çš„ `spec.volumeName` å­—æ®µã€‚
  - ç»‘å®šä¿¡æ¯åŒæ­¥å› kube-apiserverã€‚

**4ï¸âƒ£ Scheduler è°ƒåº¦ Pod åˆ°èŠ‚ç‚¹**

- Scheduler å‘ç° Pod ç»‘å®šäº† PVCï¼Œ**ç»“åˆ PVC é€‰æ‹©åˆé€‚çš„ Node**ï¼ˆæ¯”å¦‚åŸºäºå­˜å‚¨äº²å’Œæ€§ï¼‰ã€‚
- Pod è¢«è°ƒåº¦åˆ°ç›®æ ‡ Nodeã€‚

**5ï¸âƒ£ Attach/Detach Controller ä»‹å…¥ï¼ˆé’ˆå¯¹è¿œç¨‹å­˜å‚¨ï¼‰**

- å¦‚æœä½¿ç”¨çš„æ˜¯ **è¿œç¨‹å­˜å‚¨**ï¼ˆå¦‚ iSCSIã€EBSã€NFSï¼‰ï¼Œ
   **Attach/Detach Controllerï¼ˆController-Managerï¼‰** ä¼šï¼š
  - æ ‡è®°éœ€è¦å°†å·â€œé™„åŠ ï¼ˆAttachï¼‰â€åˆ°ç›®æ ‡ Nodeã€‚
  - è¿™ä¸ªæ“ä½œæœ€ç»ˆä¹Ÿæ˜¯é€šè¿‡ **CSI Controller Plugin** è°ƒç”¨ `ControllerPublishVolume`ã€‚
- è¿™ä¸€é˜¶æ®µçš„ç›®çš„æ˜¯ **è®©äº‘å¹³å°æˆ–å­˜å‚¨ç³»ç»Ÿå°†å·ä¸ Node ç»‘å®š**ï¼ˆåœ¨ Node ä¸Šâ€œçœ‹å¾—è§â€è¿™ä¸ªå·ï¼‰ã€‚

```ABAP
â€œAttach/Detach Controller çš„ä½œç”¨æ˜¯è®© Node èƒ½å¤Ÿçœ‹åˆ°è¿œç¨‹å­˜å‚¨å·ï¼Œè¿™æ · Node æ‰èƒ½åç»­å®ŒæˆæŒ‚è½½ã€‚
```

**6ï¸âƒ£ Kubelet - VolumeManager å¯åŠ¨æŒ‚è½½**

- Pod è¢«æ‹‰èµ·ä¹‹å‰ï¼Œ**Kubelet çš„ VolumeManager å‘ç°æŒ‚è½½éœ€æ±‚**ã€‚
- Kubelet é€šè¿‡ **CSI Node Pluginï¼ˆDaemonSetï¼‰** è°ƒç”¨ï¼š
  - `NodeStageVolume`ï¼ˆé¢„æŒ‚è½½åˆ° Nodeï¼‰
  - `NodePublishVolume`ï¼ˆæœ€ç»ˆæŒ‚è½½åˆ° Pod çš„ç›®å½•ï¼‰



#### PV-Persistent-Volumeå®šä¹‰

å·¥ä½œä¸­çš„å­˜å‚¨èµ„æºä¸€èˆ¬éƒ½æ˜¯ç‹¬ç«‹äºPodçš„ï¼Œå°†ä¹‹ç§°ä¸ºèµ„æºå¯¹è±¡Persistent Volume(PV)ï¼Œæ˜¯ç”±ç®¡ç†å‘˜è®¾ç½®çš„å­˜å‚¨ï¼Œå®ƒæ˜¯kubernetesé›†ç¾¤çš„ä¸€éƒ¨åˆ†ï¼ŒPV æ˜¯ Volume ä¹‹ç±»çš„å·æ’ä»¶ï¼Œ**ä½†å…·æœ‰ç‹¬ç«‹äºä½¿ç”¨ PV çš„ Pod  çš„ç”Ÿå‘½å‘¨æœŸ**



**Persistent Volume è·Ÿ Volumeç±»ä¼¼ï¼ŒåŒºåˆ«å°±æ˜¯ï¼š**

- PV æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œè´Ÿè´£å°†å­˜å‚¨ç©ºé—´å¼•å…¥åˆ°é›†ç¾¤ä¸­ï¼Œé€šå¸¸ç”±ç®¡ç†å‘˜å®šä¹‰
- PV å°±æ˜¯Kubernetesé›†ç¾¤ä¸­çš„ç½‘ç»œå­˜å‚¨ï¼Œä¸å±äºNamespaceã€Nodeã€Podç­‰èµ„æºï¼Œä½†å¯ä»¥è¢«å®ƒä»¬è®¿é—®
- **PV å±äºKubernetes æ•´ä¸ªé›†ç¾¤,å³å¯ä»¥è¢«æ‰€æœ‰é›†ç¾¤çš„Podè®¿é—®**
- **PVæ˜¯ç‹¬ç«‹çš„ç½‘ç»œå­˜å‚¨èµ„æºå¯¹è±¡ï¼Œæœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸ**
- PV æ”¯æŒå¾ˆå¤šç§volumeç±»å‹,PVå¯¹è±¡å¯ä»¥æœ‰å¾ˆå¤šå¸¸è§çš„ç±»å‹ï¼šæœ¬åœ°ç£ç›˜ã€NFSã€åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ...



#### PVC-Persistent-Volume-Claimå®šä¹‰

Persistent Volume Claim(PVC) æ˜¯ä¸€ä¸ªç½‘ç»œå­˜å‚¨æœåŠ¡çš„**è¯·æ±‚**ã€‚

**PVC å±äºåç§°ç©ºé—´çº§åˆ«çš„èµ„æº**ï¼Œåªèƒ½è¢«åŒä¸€ä¸ªåç§°ç©ºé—´çš„Podå¼•ç”¨

ç”±ç”¨æˆ·å®šä¹‰ï¼Œç”¨äºåœ¨ç©ºé—²çš„PVä¸­ç”³è¯·ä½¿ç”¨ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„PVä¹‹ä¸€ï¼Œä¸é€‰å®šçš„PVæ˜¯â€œä¸€å¯¹ä¸€â€çš„å…³ç³»

ç”¨æˆ·åœ¨Podä¸Š**é€šè¿‡pvcæ’ä»¶**è¯·æ±‚ç»‘å®šä½¿ç”¨å®šä¹‰å¥½çš„PVCèµ„æº

Podèƒ½å¤Ÿç”³è¯·ç‰¹å®šçš„CPUå’ŒMEMèµ„æºï¼Œä½†æ˜¯Podåªèƒ½é€šè¿‡PVCåˆ°PVä¸Šè¯·æ±‚ä¸€å—ç‹¬ç«‹å¤§å°çš„ç½‘ç»œå­˜å‚¨ç©º é—´ï¼Œè€ŒPVC å¯ä»¥åŠ¨æ€çš„æ ¹æ®ç”¨æˆ·è¯·æ±‚å»ç”³è¯·PVèµ„æºï¼Œä¸ä»…ä»…æ¶‰åŠåˆ°å­˜å‚¨ç©ºé—´ï¼Œè¿˜æœ‰å¯¹åº”èµ„æºçš„è®¿é—®æ¨¡ å¼ï¼Œå¯¹äºçœŸæ­£ä½¿ç”¨å­˜å‚¨çš„ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒåº•å±‚çš„å­˜å‚¨å®ç°ç»†èŠ‚ï¼Œåªéœ€è¦ç›´æ¥ä½¿ç”¨ PVC å³å¯ã€‚



#### Podã€PVã€PVC å…³ç³»

![image-20241228172519330](../markdown_img/image-20241228172519330.png)



Â·**å‰æï¼š**

- å­˜å‚¨ç®¡ç†å‘˜é…ç½®å„ç§ç±»å‹çš„PVå¯¹è±¡
- Podã€PVC å¿…é¡»åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´



**ç”¨æˆ·éœ€è¦å­˜å‚¨èµ„æºçš„æ—¶å€™ï¼š**

- ç”¨æˆ·æ ¹æ®èµ„æºéœ€æ±‚åˆ›å»ºPVCï¼Œç”±PVCè‡ªåŠ¨åŒ¹é…(æƒé™ã€å®¹é‡)åˆé€‚çš„PVå¯¹è±¡
- PVC å…è®¸ç”¨æˆ·æŒ‰éœ€æŒ‡å®šæœŸæœ›çš„å­˜å‚¨ç‰¹æ€§ï¼Œå¹¶ä»¥ä¹‹ä¸ºæ¡ä»¶ï¼ŒæŒ‰ç‰¹å®šçš„æ¡ä»¶é¡ºåºè¿›è¡ŒPVçš„è¿‡æ»¤ 
  - VolumeMode â†’ LabelSelector â†’ StorageClassName â†’ AccessMode â†’ Size 
- åœ¨Podå†…éƒ¨é€šè¿‡ PVC å°† PV ç»‘å®šåˆ°å½“å‰çš„ç©ºé—´ï¼Œè¿›è¡Œä½¿ç”¨
- å¦‚æœç”¨æˆ·ä¸å†ä½¿ç”¨å­˜å‚¨èµ„æºï¼Œè§£ç»‘ PVC å’Œ Pod å³å¯



## 8. storageClass

#### storageClassè¯´æ˜

å¯¹äº PV å’Œ PVC çš„ä½¿ç”¨æ•´ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œä¸ä»…éœ€è¦è‡ªå·±å®šä¹‰PVå’ŒPVCè¿˜éœ€è¦å°†å…¶ä¸Podè¿›è¡Œå…³è”ï¼Œè€Œä¸”å¯¹äºPVå’ŒPVCçš„é€‚é…æˆ‘ä»¬ä¹Ÿè¦åšå¥½å‰æè§„åˆ’ï¼Œè€Œç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¿™ç§ç¹ççš„äº‹æƒ…æ˜¯æœ‰æ‚–äºæˆ‘ä»¬ä½¿ ç”¨kubernetesçš„åŸåˆ™çš„ï¼Œè€Œä¸”è¿™ç§æ–¹å¼åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸”ä¸åŒçš„åº”ç”¨ç¨‹åºå¯¹äº å­˜å‚¨æ€§èƒ½çš„è¦æ±‚å¯èƒ½ä¹Ÿä¸å°½ç›¸åŒï¼Œæ¯”å¦‚è¯»å†™é€Ÿåº¦ã€å¹¶å‘æ€§èƒ½ç­‰ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦å¯¹å­˜å‚¨çš„å¹¶å‘åº¦è¦æ±‚æ¯”è¾ƒé«˜ï¼Œè€Œå¦å¤–ä¸€ä¸ªåº”ç”¨å¯¹è¯»å†™é€Ÿåº¦åˆè¦æ±‚æ¯”è¾ƒé«˜ï¼Œç‰¹åˆ«æ˜¯å¯¹äº StatefulSet ç±»å‹çš„åº”ç”¨ç®€å•çš„æ¥ä½¿ç”¨é™æ€çš„ PV å°±å¾ˆä¸åˆé€‚äº†ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ç”¨åˆ°**åŠ¨æ€ PV**ã€‚



Kubernetes å¼•å…¥äº†ä¸€ä¸ª**æ–°çš„èµ„æºå¯¹è±¡ï¼šStorageClass**ï¼Œé€šè¿‡ StorageClass çš„å®šä¹‰ï¼Œç®¡ç†å‘˜å¯ä»¥å°†å­˜å‚¨èµ„æºå®šä¹‰ä¸ºæŸç§ç±»å‹çš„èµ„æºï¼Œæ¯”å¦‚å­˜å‚¨è´¨é‡ã€å¿«é€Ÿå­˜å‚¨ã€æ…¢é€Ÿå­˜å‚¨ç­‰ï¼Œä¸ºäº†æ»¡è¶³ä¸åŒç”¨æˆ·çš„å¤šç§å¤šæ ·çš„ éœ€æ±‚ï¼Œç”¨æˆ·æ ¹æ® StorageClass çš„æè¿°å°±å¯ä»¥éå¸¸ç›´è§‚çš„çŸ¥é“å„ç§å­˜å‚¨èµ„æºçš„å…·ä½“ç‰¹æ€§äº†ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®åº”ç”¨çš„ç‰¹æ€§å»ç”³è¯·åˆé€‚çš„å­˜å‚¨èµ„æºäº†ã€‚

æ‰€ä»¥,StorageClassæä¾›äº†ä¸€ç§èµ„æºä½¿ç”¨çš„æè¿°æ–¹å¼ï¼Œä½¿å¾—ç®¡ç†å‘˜èƒ½å¤Ÿæè¿°æä¾›çš„å­˜å‚¨çš„æœåŠ¡è´¨é‡å’Œç­‰çº§ï¼Œè¿›è€Œåšå‡ºä¸åŒçº§åˆ«çš„å­˜å‚¨æœåŠ¡å’Œåç«¯ç­–ç•¥ã€‚

StorageClass ç”¨äºå®šä¹‰ä¸åŒçš„å­˜å‚¨é…ç½®å’Œå±æ€§ï¼Œä»¥ä¾› PersistentVolumeï¼ˆPVï¼‰çš„åŠ¨æ€åˆ›å»ºå’Œç®¡ç†ã€‚å®ƒä¸ºå¼€å‘äººå‘˜å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ç§åœ¨ä¸åŒçš„å­˜å‚¨æä¾›å•†ä¹‹é—´æŠ½è±¡å‡ºå­˜å‚¨é…ç½®çš„æ–¹å¼ã€‚

**åœ¨ Kubernetes ä¸­ï¼ŒStorageClass æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œè€Œä¸æ˜¯åç§°ç©ºé—´çº§åˆ«ã€‚**

PVCå’ŒPVå¯ä»¥å±äºæŸä¸ªSCï¼Œä¹Ÿå¯ä»¥ä¸å±äºä»»ä½•SC,PVCåªèƒ½å¤Ÿåœ¨åŒä¸€ä¸ªstorageClassä¸­è¿‡æ»¤PV



**èƒ½å»ºç«‹ç»‘å®šå…³ç³»çš„PVCå’ŒPVä¸€å®šæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š**

- äºŒè€…éš¶å±äºåŒä¸ªSC
- äºŒè€…éƒ½ä¸å±äºä»»ä½•SC



**StorageClassè¿™ä¸ªAPIå¯¹è±¡å¯ä»¥è‡ªåŠ¨åˆ›å»ºPVçš„æœºåˆ¶,å³:Dynamic Provisioning**



**StorageClasså¯¹è±¡ä¼šå®šä¹‰ä¸‹é¢ä¸¤éƒ¨åˆ†å†…å®¹:**

- PVçš„å±æ€§.æ¯”å¦‚,å­˜å‚¨ç±»å‹,Volumeçš„å¤§å°ç­‰
- åˆ›å»ºè¿™ç§PVéœ€è¦ç”¨åˆ°çš„å­˜å‚¨æ’ä»¶

æä¾›ä»¥ä¸Šä¸¤ä¸ªä¿¡æ¯,Kuberneteså°±èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·æäº¤çš„PVC,æ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„StorageClass,ä¹‹å Kuberneteså°±ä¼šè°ƒç”¨è¯¥StorageClasså£°æ˜çš„å­˜å‚¨æ’ä»¶,è¿›è€Œåˆ›å»ºå‡ºéœ€è¦çš„PV.



è¦ä½¿ç”¨ StorageClassï¼Œå°±å¾—**å®‰è£…å¯¹åº”çš„è‡ªåŠ¨é…ç½®ç¨‹åº**ï¼Œæ¯”å¦‚å­˜å‚¨åç«¯ä½¿ç”¨çš„æ˜¯ nfsï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åˆ° ä¸€ä¸ª nfs-client çš„è‡ªåŠ¨é…ç½®ç¨‹åºï¼Œä¹Ÿç§°ä¸º Provisionerï¼Œè¿™ä¸ªç¨‹åºä½¿ç”¨å·²ç»é…ç½®å¥½çš„ nfs æœåŠ¡å™¨ï¼Œæ¥è‡ªåŠ¨ åˆ›å»ºæŒä¹…å· PVã€‚



#### storageClass-API

æ¯ä¸ª StorageClass éƒ½åŒ…å« **provisioner** ã€ **parameters** å’Œ **reclaimPolicy** å­—æ®µï¼Œ è¿™äº›å­—æ®µä¼šåœ¨ StorageClass éœ€è¦åŠ¨æ€åˆ¶å¤‡ PersistentVolume æ—¶ä¼šä½¿ç”¨åˆ°ã€‚

StorageClass å¯¹è±¡çš„å‘½åå¾ˆé‡è¦ï¼Œç”¨æˆ·ä½¿ç”¨è¿™ä¸ªå‘½åæ¥è¯·æ±‚ç”Ÿæˆä¸€ä¸ªç‰¹å®šçš„ç±»ã€‚ å½“åˆ›å»º StorageClass  å¯¹è±¡æ—¶ï¼Œç®¡ç†å‘˜è®¾ç½® StorageClass å¯¹è±¡çš„å‘½åå’Œå…¶ä»–å‚æ•°ã€‚

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
reclaimPolicy: Retain
# å…è®¸ PVC è¿›è¡Œåœ¨çº¿æ‰©å®¹ï¼Œå³åœ¨ä¸åˆ é™¤ PVC çš„æƒ…å†µä¸‹ï¼Œè°ƒæ•´å­˜å‚¨å¤§å°
# é€‚ç”¨äºæ”¯æŒåœ¨çº¿æ‰©å®¹çš„å­˜å‚¨æä¾›ç¨‹åºï¼Œå¦‚ AWS EBSã€GCE Persistent Diskã€Ceph RBD ç­‰ã€‚
# ä»…é€‚ç”¨äº æ”¯æŒåŠ¨æ€å­˜å‚¨æ‰©å®¹çš„å­˜å‚¨æä¾›å•†ã€‚
# æŸäº›å­˜å‚¨ï¼ˆå¦‚æœ¬åœ°å­˜å‚¨ï¼‰ä¸æ”¯æŒæ‰©å±•ï¼Œå³ä½¿è®¾ç½® allowVolumeExpansion: true ä¹Ÿæ— æ•ˆã€‚
# æ‰©å®¹åï¼ŒPod å¯èƒ½éœ€è¦é‡æ–°æŒ‚è½½ PVC æ‰èƒ½ç”Ÿæ•ˆã€‚
allowVolumeExpansion: true
mountOptions:
- discard   # discard é€‰é¡¹ç”¨äº TRIM æ“ä½œï¼Œé€‚ç”¨äºæ”¯æŒ SSD ç¡¬ç›˜ çš„å­˜å‚¨ç³»ç»Ÿã€‚
            # å½“ Kubernetes é‡Šæ”¾å—å­˜å‚¨ä¸Šçš„ç©ºé—´æ—¶ï¼Œdiscard å…è®¸æ“ä½œç³»ç»Ÿé€šçŸ¥å­˜å‚¨è®¾å¤‡ï¼Œé‡Šæ”¾å·²åˆ é™¤çš„æ•°æ®å—ï¼Œä»è€Œæé«˜å­˜å‚¨æ•ˆç‡å’Œ               æ€§èƒ½ã€‚
            # âœ… é€‚ç”¨äº SSD å­˜å‚¨ï¼ˆå¦‚ AWS EBS gp3ã€GCE PD SSDã€Ceph RBDï¼‰
            # âŒ ä¸é€‚ç”¨äºæœºæ¢°ç¡¬ç›˜ï¼ˆHDDï¼‰ï¼ŒHDD ä¸æ”¯æŒ TRIMã€‚
volumeBindingMode: Immediate | WaitForFirstConsumerï¼ˆå»¶è¿Ÿç»‘å®šï¼Œåªæœ‰Podå‡†å¤‡å¥½æ‰ç»‘å®šï¼‰
# å¦‚æœä½¿ç”¨ SSD å­˜å‚¨ï¼Œå»ºè®® discard é€‰é¡¹ã€‚
# å¦‚æœéœ€è¦ä¿è¯å­˜å‚¨æ€§èƒ½ï¼Œä½¿ç”¨ guaranteedReadWriteLatency: "true"ã€‚



# ç®¡ç†å‘˜å¯ä»¥ä¸ºæ²¡æœ‰ç”³è¯·ç»‘å®šåˆ°ç‰¹å®šStorageClassçš„PVCæŒ‡å®šä¸€ä¸ªé»˜è®¤çš„å­˜å‚¨ç±»
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
  - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 8Gi
  storageClassName: standard
  selector:
    matchLabels:
      release: "stable"
    matchExpressions:
      - {key: environment, operator: In, values: [dev]}
```



##### è¡¥å……ï¼šKubernetes **Persistent Volume (PV) ç»‘å®šæ¨¡å¼ (`volumeBindingMode`)** 

**volumeBindingMode: Immediate**

**å·¥ä½œæœºåˆ¶**

- **PV å’Œ PVC ä¼šç«‹å³ç»‘å®š**ï¼Œæ— è®º Pod æ˜¯å¦å·²åˆ›å»ºã€‚
- **PVC ç»‘å®šåï¼ŒPV å¯èƒ½ä¼šè¢«è°ƒåº¦åˆ°ä¸ Pod è¿è¡Œçš„èŠ‚ç‚¹ä¸åŒ¹é…çš„å­˜å‚¨ä¸Š**ã€‚
- é€‚ç”¨äº **å…±äº«å­˜å‚¨ï¼ˆNetworked Storageï¼‰ï¼Œå¦‚ NFSã€Cephã€EBSï¼ˆéæœ¬åœ°å­˜å‚¨ï¼‰**ï¼Œå› ä¸ºè¿™äº›å­˜å‚¨ä¸ä¾èµ–ç‰¹å®šèŠ‚ç‚¹ã€‚

**ä½¿ç”¨åœºæ™¯**

âœ… **ç½‘ç»œå­˜å‚¨ (NFS, Ceph, AWS EBS, GCE Persistent Disk)**

- è¿™äº›å­˜å‚¨å¯ä»¥è·¨å¤šä¸ªèŠ‚ç‚¹è®¿é—®ï¼Œå› æ­¤ PVC ç«‹å³ç»‘å®šåï¼Œä¸ä¼šå½±å“ Pod çš„è°ƒåº¦ã€‚

âŒ **æœ¬åœ°å­˜å‚¨ (HostPath, Local SSD, Node-specific Storage)**

- ç”±äº PVC å¯èƒ½ç»‘å®šåˆ°ä¸åˆé€‚çš„ PVï¼Œå¯¼è‡´ Pod æ— æ³•æ­£ç¡®è°ƒåº¦ã€‚



**volumeBindingMode: WaitForFirstConsumer**

**å·¥ä½œæœºåˆ¶**

- **PVC ä¸ä¼šç«‹å³ç»‘å®š PVï¼Œç›´åˆ° Pod è¢«è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹ã€‚**
- **å­˜å‚¨è°ƒåº¦ä¼šåœ¨ Pod ç»‘å®šèŠ‚ç‚¹åè¿›è¡Œ**ï¼Œç¡®ä¿å­˜å‚¨å’Œè®¡ç®—èŠ‚ç‚¹åŒ¹é…ã€‚
- é€‚ç”¨äº **æœ¬åœ°å­˜å‚¨ï¼ˆLocal Storage, SSD, Node-specific Storage, EBS GP3/IO2ç­‰ï¼‰**ã€‚

**ä½¿ç”¨åœºæ™¯**

âœ… **æœ¬åœ°å­˜å‚¨ (Local SSD, Local Persistent Volumes)**

- åªæœ‰åœ¨ Pod ç¡®å®šè¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹åï¼ŒPVC æ‰ç»‘å®šåˆ°è¯¥èŠ‚ç‚¹çš„ PVï¼Œé˜²æ­¢å­˜å‚¨å’Œè®¡ç®—ä¸åŒ¹é…çš„é—®é¢˜ã€‚

âœ… **Kubernetes èµ„æºè°ƒåº¦ä¼˜åŒ–**

- å…è®¸ Kubernetes **åœ¨è°ƒåº¦ Pod æ—¶ç»¼åˆè€ƒè™‘å­˜å‚¨ä½ç½®**ï¼Œå‡å°‘æ•°æ®ä¼ è¾“å»¶è¿Ÿã€‚

âŒ **å…±äº«å­˜å‚¨ (NFS, Ceph, AWS EBS)**

- è¿™äº›å­˜å‚¨æ²¡æœ‰èŠ‚ç‚¹é™åˆ¶ï¼Œä¸éœ€è¦å»¶è¿Ÿç»‘å®š



**`Immediate` vs `WaitForFirstConsumer` å¯¹æ¯”æ€»ç»“**

| ç»‘å®šæ¨¡å¼               | ç»‘å®šæ—¶é—´                             | é€‚ç”¨å­˜å‚¨ç±»å‹                          | é€‚ç”¨åœºæ™¯                                         | ä¸»è¦é—®é¢˜                                |
| ---------------------- | ------------------------------------ | ------------------------------------- | ------------------------------------------------ | --------------------------------------- |
| `Immediate`            | PVC ç«‹å³ç»‘å®š PV                      | å…±äº«å­˜å‚¨ (NFS, Ceph, AWS EBS, GCE PD) | **äº‘å­˜å‚¨ã€ç½‘ç»œå­˜å‚¨**ï¼ŒPVC å¯ä»¥æå‰ç»‘å®š           | **æœ¬åœ°å­˜å‚¨å¯èƒ½å¯¼è‡´ PVC ç»‘å®šåˆ°é”™è¯¯èŠ‚ç‚¹** |
| `WaitForFirstConsumer` | **Pod è¿è¡Œåœ¨å“ªä¸ªèŠ‚ç‚¹ï¼ŒPVC æ‰ä¼šç»‘å®š** | æœ¬åœ°å­˜å‚¨ (Local SSD, NVMe, EBS GP3)   | **æœ¬åœ°å­˜å‚¨æˆ–é«˜æ€§èƒ½ SSD**ï¼Œç¡®ä¿å­˜å‚¨ä¸è®¡ç®—èŠ‚ç‚¹ä¸€è‡´ | **Pod éœ€è¦å…ˆè°ƒåº¦ï¼ŒPVC æ‰èƒ½ç»‘å®š**        |



#### å­˜å‚¨åˆ¶å¤‡å™¨

æ¯ä¸ª StorageClass éƒ½æœ‰**ä¸€ä¸ªåˆ¶å¤‡å™¨ï¼ˆProvisionerï¼‰**ï¼Œç”¨äºæä¾›å­˜å‚¨é©±åŠ¨ï¼Œç”¨æ¥å†³å®šä½¿ç”¨å“ªä¸ªå·æ’ä»¶åˆ¶å¤‡ PVã€‚ **è¯¥å­—æ®µå¿…é¡»æŒ‡å®š**

| å·æ’ä»¶         | å†…ç½®åˆ¶å¤‡å™¨ |                           é…ç½®ç¤ºä¾‹                           |
| :------------- | :--------: | :----------------------------------------------------------: |
| AzureFile      |     âœ“      | [Azure File](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#azure-file) |
| CephFS         |     -      |                              -                               |
| FC             |     -      |                              -                               |
| FlexVolume     |     -      |                              -                               |
| iSCSI          |     -      |                              -                               |
| Local          |     -      | [Local](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#local) |
| NFS            |     -      | [NFS](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#nfs) |
| PortworxVolume |     âœ“      | [Portworx Volume](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#portworx-volume) |
| RBD            |     âœ“      | [Ceph RBD](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#ceph-rbd) |
| VsphereVolume  |     âœ“      | [vSphere](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#vsphere) |





## 9. Sidecar

### emptyDir

ä¸€ä¸ªemptyDir volumeåœ¨podè¢«è°ƒåº¦åˆ°æŸä¸ªNodeæ—¶å€™è‡ªåŠ¨åˆ›å»ºçš„ï¼Œæ— éœ€æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•ã€‚ é€‚ç”¨äºåœ¨ä¸€ä¸ª**Podä¸­ä¸åŒå®¹å™¨é—´çš„ä¸´æ—¶æ•°æ®çš„å…±äº«**



**emptyDir æ•°æ®å­˜æ”¾åœ¨å®¿ä¸»æœºçš„è·¯å¾„å¦‚ä¸‹**

```bash
/var/lib/kubelet/pods/<pod_id>/volumes/kubernetes.io~empty-dir/<volume_name>/<FILE>

#æ³¨æ„ï¼šæ­¤ç›®å½•éšç€Podåˆ é™¤ï¼Œä¹Ÿä¼šéšä¹‹åˆ é™¤ï¼Œä¸èƒ½å®ç°æŒä¹…åŒ–

# æŸ¥çœ‹podæ‰€åœ¨èŠ‚ç‚¹
[root@master1 pods]#kubectl get pods -o wide
NAME                     READY   STATUS    RESTARTS        AGE   IP             NODE    NOMINATED NODE   READINESS GATES
myweb-565cb68445-btlj8   1/1     Running   1 (7h25m ago)   24h   10.244.2.56    node2   <none>           <none>
myweb-565cb68445-c8drb   1/1     Running   1 (7h26m ago)   24h   10.244.1.104   node1   <none>           <none>
myweb-565cb68445-lj7bq   1/1     Running   1 (7h25m ago)   24h   10.244.3.111   node3   <none>           <none>

# æŸ¥çœ‹podèŠ‚ç‚¹ä¸ŠemptyDiræ•°æ®å­˜æ”¾çš„è·¯å¾„
[root@master1 pods]#ssh 10.0.0.203 ls /var/lib/kubelet/pods/
242cc64b-4330-4c00-ba80-9228f2186367
4a737c21-36e2-413d-a53f-ce65b9b4698e
9fe61621-a076-4d35-add9-c329ca6b12db
eed8a3fa-73e0-4a1e-b897-4235d77cae66

# æŸ¥çœ‹å¯¹åº”çš„podçš„uid
[root@master1 pods]#kubectl get pod myweb-565cb68445-btlj8 -o yaml|grep -i uid
    uid: 4db8879a-ee0d-48d3-8b7e-675581eb4fa2
  uid: eed8a3fa-73e0-4a1e-b897-4235d77cae66      # -------- åŒ¹é…ä¸Šé¢çš„è·¯å¾„uid
```



**emptyDir ç‰¹ç‚¹å¦‚ä¸‹ï¼š**

- æ­¤ä¸º**é»˜è®¤å­˜å‚¨ç±»å‹**
- æ­¤æ–¹å¼åªèƒ½ä¸´æ—¶å­˜æ”¾æ•°æ®ï¼Œä¸èƒ½å®ç°æ•°æ®æŒä¹…åŒ–
- è·ŸéšPodåˆå§‹åŒ–è€Œæ¥ï¼Œå¼€å§‹æ˜¯ç©ºæ•°æ®å·
- Pod è¢«åˆ é™¤ï¼ŒemptyDirå¯¹åº”çš„å®¿ä¸»æœºç›®å½•ä¹Ÿè¢«åˆ é™¤ï¼Œå½“ç„¶ç›®å½•å†…çš„æ•°æ®éšä¹‹æ°¸ä¹…æ¶ˆé™¤
- emptyDir æ•°æ®å·ä»‹è´¨ç§ç±»è·Ÿå½“å‰ä¸»æœºçš„ç£ç›˜ä¸€æ ·ã€‚
- emptyDir ä¸»æœºå¯ä»¥ä¸ºåŒä¸€ä¸ªPodå†…å¤šä¸ªå®¹å™¨å…±äº«
- emptyDir å®¹å™¨æ•°æ®çš„ä¸´æ—¶å­˜å‚¨ç›®å½•ä¸»è¦ç”¨äºæ•°æ®ç¼“å­˜å’Œ**åŒä¸€ä¸ªPodå†…çš„å¤šä¸ªå®¹å™¨å…±äº«ä½¿ç”¨**



**emptyDirå±æ€§è§£æ**

```bash
kubectl explain pod.spec.volumes.emptyDir
    medium       # æŒ‡å®šåª’ä»‹ç±»å‹ï¼Œä¸»è¦æœ‰defaultå’Œmemoryä¸¤ç§
                 # é»˜è®¤æƒ…å†µä¸‹ï¼ŒemptyDirå·æ”¯æŒèŠ‚ç‚¹ä¸Šçš„ä»»ä½•ä»‹è´¨ï¼ŒSSDã€ç£ç›˜æˆ–ç½‘ç»œå­˜å‚¨ï¼Œå…·ä½“å–å†³äºè‡ªèº«æ‰€åœ¨Nodeçš„ç¯å¢ƒ
                 # å°†å­—æ®µè®¾ç½®ä¸ºMemoryï¼Œè®©K8Sä½¿ç”¨tmpfsï¼Œè™½ç„¶tmpfså¿«ï¼Œä½†æ˜¯Podé‡å¯æ—¶ï¼Œæ•°æ®ä¼šè¢«æ¸…é™¤ï¼Œå¹¶ä¸”è®¾ç½®çš„å¤§å°ä¼šè¢«è®¡å…¥                    # Containerçš„å†…å­˜é™åˆ¶å½“ä¸­
    sizeLimit    # å½“å‰å­˜å‚¨å·çš„ç©ºé—²é™åˆ¶ï¼Œé»˜è®¤å€¼ä¸ºnilè¡¨ç¤ºä¸é™åˆ¶
    
kubectl explain pod.spec.containers.volumeMounts
    mountPath    # æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„è·¯å¾„,æ­¤ç›®å½•ä¼šè‡ªåŠ¨ç”Ÿæˆ
    name         # æŒ‡å®šæŒ‚è½½çš„volumesåç§°
    readOnly     # æ˜¯å¦åªè¯»æŒ‚è½½
    subPath      # æ˜¯å¦æŒ‚è½½å­ç›®å½•çš„è·¯,é»˜è®¤ä¸æŒ‚è½½å­ç›®å½•
```





## 10. ConfigMap

### ConfigMapçš„ä½œç”¨

**ConfigMap** æ˜¯ Kubernetes ä¸­ç”¨äºå°†é…ç½®ä¿¡æ¯ï¼ˆé€šå¸¸æ˜¯çº¯æ–‡æœ¬ï¼‰ä¼ å…¥å®¹å™¨çš„æœºåˆ¶ï¼Œç”¨æ¥è§£è€¦ä»£ç å’Œé…ç½®ã€‚

- åŠ¨æœºï¼šé…ç½®ä¸å†™æ­»åœ¨é•œåƒé‡Œï¼ˆå¯ä¿®æ”¹ã€å¯å¤ç”¨ï¼‰
- åº”ç”¨åœºæ™¯ï¼šç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ã€å¯åŠ¨å‚æ•°ã€è„šæœ¬ã€è¯ä¹¦ç­‰



### æ¸…å•æ–‡ä»¶åŸºæœ¬ç»“æ„ç»„æˆ

ConfigMap æ˜¯ä¸€ç»„ key-value ç»„æˆçš„é…ç½®èµ„æºã€‚

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: my-config
data:
  key1: value1
  key2: |
    multi-line
    value block
```

è¯´æ˜ï¼š

- æ¯ä¸€ä¸ª `key` éƒ½å¯ä»¥æ˜¯ä¸€ä¸ªç‹¬ç«‹é…ç½®é¡¹
- `value` å¯ä»¥æ˜¯ä¸€è¡Œå­—ç¬¦ä¸²ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šè¡Œé…ç½®å†…å®¹



### `data` å­—æ®µçš„ä½¿ç”¨æ–¹å¼

ConfigMap **ä» Kubernetes è§’åº¦**æœ‰**ä¸¤ç§æ³¨å…¥æ–¹å¼**ï¼š

| åˆ†ç±»                    | å…·ä½“è¡¨ç°                             | é€‚ç”¨åœºæ™¯                           |
| ----------------------- | ------------------------------------ | ---------------------------------- |
| **1. ä½œä¸ºç¯å¢ƒå˜é‡æ³¨å…¥** | `envFrom` / `env`                    | é€‚åˆå°‘é‡ã€ç®€å•ã€é”®å€¼å‹é…ç½®         |
| **2. ä½œä¸ºæ–‡ä»¶æŒ‚è½½æ³¨å…¥** | `volumes.configMap` + `volumeMounts` | é€‚åˆé…ç½®æ–‡ä»¶ã€è„šæœ¬ã€å‚æ•°æ®µã€è¯ä¹¦ç­‰ |



### è€ƒè¯•é‡ç‚¹ï¼šimmutableå­—æ®µ

**å½“ `ConfigMap` è®¾ç½®äº† `immutable: true` åï¼š**

Deployment **åŠ è½½ä¿®æ”¹åçš„ ConfigMap** åªæœ‰ä¸¤ç§æ–¹æ³•ï¼š

1. **ä¿®æ”¹ ConfigMap åç§°**
   - åˆ›å»ºä¸€ä¸ªæ–°çš„ ConfigMapï¼ˆä½¿ç”¨æ–°åç§°ï¼‰ï¼›
   - åŒæ­¥ä¿®æ”¹ Deployment ä¸­æŒ‚è½½çš„ `configMap.name` å­—æ®µï¼›
   - é‡æ–°éƒ¨ç½²æˆ– `rollout restart` Deploymentï¼›
   - **ä¸ä¼šä¸­æ–­æœåŠ¡**ï¼Œæ¨èæ–¹å¼ã€‚
2. **åˆ é™¤å¹¶é‡å»º Deployment**
   - åˆ é™¤åŸ Deploymentï¼›
   - ä¿è¯ ConfigMap åœ¨æ­¤ä¹‹å‰å·²ç»æ›´æ–°ï¼›
   - é‡æ–°åˆ›å»º Deploymentï¼›
   - **ä¼šå½±å“æœåŠ¡å¯ç”¨æ€§**ï¼Œä»…é€‚ç”¨äºéç”Ÿäº§æˆ–å¯å®¹å¿åœºæ™¯ã€‚



## 11. helm

![image-20250324193356822](../markdown_img/image-20250324193356822.png)



### Helm ç›¸å…³æ¦‚å¿µ

- **Helm**ï¼šHelmçš„å®¢æˆ·ç«¯å·¥å…·ï¼Œè´Ÿè´£å’ŒAPI Server é€šä¿¡

  Helm å’Œkubectlç±»ä¼¼ï¼Œä¹Ÿæ˜¯Kubernetes API Serverçš„å‘½ä»¤è¡Œå®¢æˆ·ç«¯å·¥å…·

  æ”¯æŒkubeconfigè®¤è¯æ–‡ä»¶

  éœ€è¦äº‹å…ˆä»ä»“åº“æˆ–æœ¬åœ°åŠ è½½åˆ°è¦ä½¿ç”¨ç›®æ ‡Chartï¼Œå¹¶åŸºäºChartå®Œæˆåº”ç”¨ç®¡ç†ï¼ŒChartå¯ç¼“å­˜äºHelmæœ¬åœ°ä¸»æœºä¸Š
  æ”¯æŒä»“åº“ç®¡ç†å’ŒåŒ…ç®¡ç†çš„å„ç±»å¸¸ç”¨æ“ä½œï¼Œä¾‹å¦‚Chartä»“åº“çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ï¼Œä»¥åŠChartåŒ…çš„åˆ¶ä½œã€ å‘å¸ƒã€æœç´¢ã€ä¸‹è½½ç­‰

- **Chart**ï¼šæ‰“åŒ…æ–‡ä»¶ï¼Œå°†æ‰€æœ‰ç›¸å…³çš„èµ„æºæ¸…å•æ–‡ä»¶YAMLçš„æ‰“åŒ…æ–‡ä»¶

  Chart  æ˜¯ä¸€ç§æ‰“åŒ…æ ¼å¼ï¼Œæ–‡ä»¶åç¼€ä¸ºtar.gzæˆ–è€… tgzï¼Œä»£è¡¨ç€å¯ç”±Helmç®¡ç†çš„æœ‰ç€ç‰¹å®šæ ¼å¼çš„ç¨‹åºåŒ…ï¼Œç±»ä¼¼äºRPMï¼ŒDEBåŒ…æ ¼å¼

  Chart åŒ…å«äº†åº”ç”¨æ‰€éœ€çš„èµ„æºç›¸å…³çš„å„ç§yaml/jsoné…ç½®æ¸…å•æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼šdeployment,service ç­‰ï¼Œä½†ä¸åŒ…å«å®¹å™¨çš„é•œåƒ

  Chart å¯ä»¥ä½¿ç”¨é»˜è®¤é…ç½®ï¼Œæˆ–è€…å®šåˆ¶ç”¨æˆ·è‡ªå·²çš„é…ç½®è¿›è¡Œå®‰è£…åº”ç”¨

  Chart ä¸­çš„èµ„æºé…ç½®æ–‡ä»¶é€šå¸¸ä»¥æ¨¡æ¿(go template)å½¢å¼å®šä¹‰ï¼Œåœ¨éƒ¨ç½²æ—¶ï¼Œç”¨æˆ·å¯é€šè¿‡å‘æ¨¡æ¿å‚æ•°èµ‹å€¼å®ç°å®šåˆ¶åŒ–å®‰è£…çš„ç›®çš„

  Chart ä¸­å„æ¨¡æ¿å‚æ•°é€šå¸¸ä¹Ÿæœ‰**é»˜è®¤å€¼**ï¼Œè¿™äº›é»˜è®¤å€¼å®šä¹‰åœ¨ChartåŒ…é‡Œä¸€ä¸ªåä¸º**`values.yml`**çš„æ–‡ä»¶ä¸­

- **Release**ï¼šè¡¨ç¤ºåŸºäºchartéƒ¨ç½²çš„ä¸€ä¸ªå®ä¾‹ã€‚é€šè¿‡chartéƒ¨ç½²çš„åº”ç”¨éƒ½ä¼šç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„Release,å³ä½¿åŒä¸€ä¸ªchartéƒ¨ç½²å¤šæ¬¡ä¹Ÿä¼šäº§ç”Ÿå¤šä¸ªRelease.å°†è¿™äº›releaseåº”ç”¨éƒ¨ç½²å®Œæˆåï¼Œä¹Ÿä¼šè®°å½•éƒ¨ç½²çš„ä¸€ä¸ªç‰ˆæœ¬ï¼Œç»´æŠ¤äº†ä¸€ä¸ªreleaseç‰ˆæœ¬çŠ¶æ€,åŸºäºæ­¤å¯ä»¥å®ç°ç‰ˆæœ¬å›æ»šç­‰æ“ä½œ

- **Repository**ï¼šchartåŒ…å­˜æ”¾çš„ä»“åº“ï¼Œç›¸å½“äºAPTå’ŒYUMä»“åº“



### ä½¿ç”¨Helméƒ¨ç½²åº”ç”¨æµç¨‹

- å®‰è£… helm å·¥å…·

- æŸ¥æ‰¾åˆé€‚çš„ chart ä»“åº“

- é…ç½® chart ä»“åº“

- å®šä½ chart

- é€šè¿‡å‘Chartä¸­æ¨¡æ¿æ–‡ä»¶ä¸­å­—ä¸²èµ‹å€¼å®Œæˆå…¶å®ä¾‹åŒ–ï¼Œå³æ¨¡æ¿æ¸²æŸ“ï¼Œ å®ä¾‹åŒ–çš„ç»“æœå°±å¯ä»¥éƒ¨ç½²åˆ°ç›®æ ‡ Kubernetesä¸Š

  æ¨¡æ¿å­—ä¸²çš„å®šåˆ¶æ–¹å¼ä¸‰ç§ï¼š

  - é»˜è®¤ä½¿ç”¨ chart ä¸­çš„ **values.yaml ä¸­å®šä¹‰çš„é»˜è®¤å€¼**
  - ç›´æ¥åœ¨helm installçš„å‘½ä»¤è¡Œï¼Œ**é€šè¿‡--seté€‰é¡¹è¿›è¡Œ**
  - è‡ªå®šä¹‰values.yamlï¼Œ**ç”±helm install -f values.yaml å‘½ä»¤åŠ è½½è¯¥æ–‡ä»¶**

- åŒä¸€ä¸ªchart å¯ä»¥éƒ¨ç½²å‡ºæ¥çš„å¤šä¸ªä¸åŒçš„å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ç§°ä¸ºä¸€ä¸ªrelease

  Chart å’Œ Release çš„å…³ç³»ï¼Œç›¸å½“äºOOPå¼€å‘ä¸­çš„Classå’Œå¯¹è±¡çš„å…³ç³»,ç›¸å½“äºimageå’Œcontainer

  åº”ç”¨release å®‰è£…å‘½ä»¤ï¼šhelm install 



### äºŒè¿›åˆ¶å®‰è£… Helm

```bash
# åœ¨kubernetesçš„ç®¡ç†èŠ‚ç‚¹éƒ¨ç½²
[root@master1 ~]# wget -P /usr/local/src https://get.helm.sh/helm-v3.17.2-linux-amd64.tar.gz
[root@master1 ~]# tar xf /usr/local/src/helm-v3.17.2-linux-amd64.tar.gz -C /usr/local/
[root@master1 ~]# ls /usr/local/linux-amd64/
helm  LICENSE  README.md
[root@master1 ~]# ln -s /usr/local/linux-amd64/helm /usr/local/bin/

# helm-v3ç‰ˆæœ¬æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹
[root@master1 ~]#helm version
version.BuildInfo{Version:"v3.17.2", GitCommit:"cc0bbbd6d6276b83880042c1ecb34087e84d41eb", GitTreeState:"clean", GoVersion:"go1.23.7"}

# Helmå‘½ä»¤è¡¥ä¼š,é‡æ–°ç™»å½•ç”Ÿæ•ˆ
# æ–¹æ³•1
[root@master1 ~]# echo 'source <(helm completion bash)' >> .bashrc && exit

# æ–¹æ³•2
[root@master1 ~]# helm completion bash > /etc/bash_completion.d/helm  && exit
```



### Helm å‘½ä»¤ç”¨æ³•è¯´æ˜

#### **å¸¸ç”¨çš„ helmå‘½ä»¤åˆ†ç±»**

- **Repostory ç®¡ç†**

  repo å‘½ä»¤ï¼Œæ”¯æŒ repository çš„`add`ã€`list`ã€`remove`ã€`update` å’Œ `index` ç­‰å­å‘½ä»¤

- **Chart ç®¡ç†**

  `create`ã€`package`ã€`pull`ã€`push`ã€`dependency`ã€`search`ã€`show` å’Œ `verify` ç­‰æ“ä½œ

- **Release ç®¡ç†**

  `install`ã€`upgrade`ã€`get`ã€`list`ã€`history`ã€`status`ã€`rollback `å’Œ `uninstall` ç­‰æ“ä½œ



#### **Helmå¸¸è§å­å‘½ä»¤**

```bash
version          # æŸ¥çœ‹helmå®¢æˆ·ç«¯ç‰ˆæœ¬
repo             # æ·»åŠ ã€åˆ—å‡ºã€ç§»é™¤ã€æ›´æ–°å’Œç´¢å¼•chartä»“åº“ï¼Œç›¸å½“äºapt/yumä»“åº“,å¯ç”¨å­å‘½ä»¤:addã€indexã€listã€removeã€update
search           # æ ¹æ®å…³é”®å­—æœç´¢chartåŒ…
show             # æŸ¥çœ‹chartåŒ…çš„åŸºæœ¬ä¿¡æ¯å’Œè¯¦ç»†ä¿¡æ¯ï¼Œå¯ç”¨å­å‘½ä»¤:allã€chartã€readmeã€values
pull             # ä»è¿œç¨‹ä»“åº“ä¸­æ‹‰å–chartåŒ…å¹¶è§£å‹åˆ°æœ¬åœ°ï¼Œé€šè¿‡é€‰é¡¹ --untar è§£å‹,é»˜è®¤ä¸è§£å‹
create           # åˆ›å»ºä¸€ä¸ªchartåŒ…å¹¶æŒ‡å®šchartåŒ…åå­—
install          # é€šè¿‡chartåŒ…å®‰è£…ä¸€ä¸ªreleaseå®ä¾‹
list             # åˆ—å‡ºreleaseå®ä¾‹å
upgrade          # æ›´æ–°ä¸€ä¸ªreleaseå®ä¾‹
rollback         # ä»ä¹‹å‰ç‰ˆæœ¬å›æ»šreleaseå®ä¾‹ï¼Œä¹Ÿå¯æŒ‡å®šè¦å›æ»šçš„ç‰ˆæœ¬å·
uninstall        # å¸è½½ä¸€ä¸ªreleaseå®ä¾‹
history          # è·å–releaseå†å²ï¼Œç”¨æ³•:helm history releaseå®ä¾‹å
package          # å°†chartç›®å½•æ‰“åŒ…æˆchartå­˜æ¡£æ–‡ä»¶.tgzä¸­
get              # ä¸‹è½½ä¸€ä¸ªrelease,å¯ç”¨å­å‘½ä»¤:allã€hooksã€manifestã€notesã€values
status           # æ˜¾ç¤ºreleaseå®ä¾‹çš„çŠ¶æ€ï¼Œæ˜¾ç¤ºå·²å‘½åç‰ˆæœ¬çš„çŠ¶æ€
template         # æœ¬åœ°æ¸²æŸ“æ¨¡ç‰ˆ
```



#### **Helm å¸¸è§å‘½ä»¤ç”¨æ³•**

```bash
# ä»“åº“ç®¡ç†
helm repo list    # åˆ—å‡ºå·²æ·»åŠ çš„ä»“åº“
helm repo add [REPO_NAME] [URL]  # æ·»åŠ è¿œç¨‹ä»“åº“å¹¶å‘½å,å¦‚ä¸‹ç¤ºä¾‹
helm repo add myharbor https://harbor.wangxiaochun.com/chartrepo/myweb --username admin --password 123456
helm repo remove [REPO1 [REPO2 ...]]   # åˆ é™¤ä»“åº“
helm repo update                       # æ›´æ–°ä»“åº“,ç›¸å½“äºapt update
helm search hub  [KEYWORD]             # ä»artifacthubç½‘ç«™æœç´¢,æ— éœ€é…ç½®æœ¬åœ°ä»“åº“,ç›¸å½“äºdocker search
helm search repo [KEYWORD]             # æœ¬åœ°ä»“åº“æœç´¢,éœ€è¦é…ç½®æœ¬åœ°ä»“åº“æ‰èƒ½æœç´¢,ç›¸å½“äºapt search
helm search repo [KEYWORD] --versions  # æ˜¾ç¤ºæ‰€æœ‰ç‰ˆæœ¬
helm show chart [CHART]                # æŸ¥çœ‹chartåŒ…çš„ä¿¡æ¯,ç±»ä¼¼äºapt info
helm show values [CHART]               # æŸ¥çœ‹chartåŒ…çš„values.yamlæ–‡ä»¶å†…å®¹

# æ‹‰å–chartåˆ°æœ¬åœ°
helm pull repo/chartname               # ä¸‹è½½chartsåˆ°å½“å‰ç›®å½•ä¸‹ï¼Œè¡¨ç°ä¸ºtgzæ–‡ä»¶,é»˜è®¤æœ€æ–°ç‰ˆæœ¬ï¼Œç›¸å½“äºwget  
helm pull chart_URL                    # ç›´æ¥ä¸‹è½½ï¼Œé»˜è®¤ä¸º.tgzæ–‡ä»¶
helm pull myrepo/myapp --version 1.2.3 --untar      # ç›´æ¥ä¸‹è½½æŒ‡å®šç‰ˆæœ¬çš„chartåŒ…å¹¶è§£å‹ç¼©

# åˆ›å»ºchartç›®å½•ç»“æ„
helm create NAME

# æ£€æŸ¥è¯­æ³•
helm lint [PATH]  #é»˜è®¤æ£€æŸ¥å½“å‰ç›®å½•

# å®‰è£…
helm install [NAME] [CHART] [--version <string> ]    # å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„chart
helm install [CHART] --generate-name                 # è‡ªåŠ¨ç”Ÿæˆ  RELEASE_NAME
helm install --set KEY1=VALUE1 --set KEY2=VALUE2  RELEASE_NAME CHART ...    #æŒ‡å®šå±æ€§å®ç°å®šåˆ¶é…ç½®
helm install -f values.yaml  RELEASE_NAME CHART..... # å¼•ç”¨æ–‡ä»¶å®ç°å®šåˆ¶é…ç½®
helm install --debug --dry-run RELEASE_NAME CHART    # è°ƒè¯•å¹¶ä¸æ‰§è¡Œï¼Œå¯ä»¥æŸ¥çœ‹åˆ°æ‰§è¡Œçš„æ¸²æŸ“ç»“æœ

# åˆ é™¤
helm uninstall RELEASE_NAME                          # å¸è½½RELEASE


# æŸ¥çœ‹
helm list                                            # åˆ—å‡ºå®‰è£…çš„release
helm status RELEASE_NAME                             # æŸ¥çœ‹RELEASEçš„çŠ¶æ€
helm get notes RELEASE_NAME -n NAMESPACE             # æŸ¥çœ‹RELEASEçš„è¯´æ˜
helm get values RELEASE_NAME -n NAMESPACE > values.yaml   # æŸ¥çœ‹RELEASEçš„ç”Ÿæˆå€¼ï¼Œå¯ä»¥å¯¼å‡ºæ–¹ä¾¿ä»¥åä½¿ç”¨
helm get manifest RELEASE_NAME -n NAMESPACE          # æŸ¥çœ‹RELEASEçš„ç”Ÿæˆçš„èµ„æºæ¸…å•æ–‡ä»¶

# å‡ä»·å’Œå›æ»š
helm upgrade RELEASE_NAME CHART --set key=newvalue       # release æ›´æ–°
helm upgrade RELEASE_NAME CHART -f mychart/values.yaml   # release æ›´æ–°
helm rollback RELEASE_NAME [REVISION]                    # release å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼Œå¦‚æœä¸æŒ‡å®šç‰ˆæœ¬ï¼Œé»˜è®¤å›æ»šè‡³ä¸Šä¸€ç‰ˆæœ¬
helm history RELEASE_NAME                                # æŸ¥çœ‹å†å²

# æ‰“åŒ…
helm package mychart/ #å°†æŒ‡å®šç›®å½•çš„chartæ‰“åŒ…ä¸º.tgzåˆ°å½“å‰ç›®å½•ä¸‹

# æœ¬åœ°æ¸²æŸ“
helm template prometheus prometheus-community/prometheus \
  --namespace monitoring \
  --values custom-values.yaml \
  > manifests/prometheus.yaml
```



#### ç›´æ¥ä½¿ç”¨helmçš„é—®é¢˜

- **å°è£…åº¦é«˜ï¼šç”¨æˆ·åªçœ‹åˆ°äº† Chart åå’Œ Values**

- **æ¸²æŸ“ä¸åº”ç”¨ä¸€ä½“ï¼Œä¸å¯é¢„å®¡**
  - Helm **ä¸€å£æ°”æ¸²æŸ“å¹¶åº”ç”¨åˆ°é›†ç¾¤**ï¼Œæ²¡æœ‰ä¸­é—´è¿‡ç¨‹æš´éœ²ã€‚
  - æ— æ³•åšåˆ°**æå‰æŸ¥çœ‹æ¸²æŸ“ç»“æœ**ï¼Œä¹Ÿæ— æ³•è½»æ˜“**è®©å›¢é˜Ÿä»£ç å®¡æŸ¥**ã€‚
  - ä¾‹å¦‚ï¼Œé”™è¯¯çš„ `values.yaml` å¯èƒ½ä¼šå¯¼è‡´ï¼šéƒ¨ç½²æ— æ•ˆé…ç½®
    - é”€æ¯ç°æœ‰èµ„æº
    - æš´éœ²ç«¯å£æˆ–æ•æ„Ÿæ•°æ®
- **å˜æ›´ä¸æ˜“è¿½è¸ª**
  - ç›´æ¥è¿è¡Œ `helm upgrade` æ²¡æœ‰ Git è®°å½•ã€‚
  - å˜æ›´ **åªä¿ç•™åœ¨ Helm Release Secret é‡Œ**ï¼Œè€Œä¸æ˜¯ Gitã€‚
  - å›¢é˜Ÿæ— æ³•æ–¹ä¾¿åœ° **å®¡è®¡** æˆ– **å›æ»š** åˆ°ä¹‹å‰çš„æŸä¸ª YAML ç‰ˆæœ¬ã€‚
- **å¯¹ç¯å¢ƒè¦æ±‚é«˜**
  - Helm ç‰ˆæœ¬ã€æ’ä»¶ã€å®¢æˆ·ç«¯ç¯å¢ƒä¸ä¸€è‡´ï¼Œä¼šé€ æˆ**è¡Œä¸ºä¸ä¸€è‡´**ã€‚
  - CI/CD ç¯å¢ƒä¹Ÿè¦é…ç½® Helmï¼Œè€Œç›´æ¥ç”¨ YAML åˆ™åªä¾èµ– `kubectl`ã€‚



**æ€»ç»“å¯¹æ¯”**

| Helm ç›´æ¥éƒ¨ç½²                    | é¢„æ¸²æŸ“å GitOps æˆ– Kubectl éƒ¨ç½² |
| -------------------------------- | ------------------------------- |
| ä¸€æ­¥åˆ°é›†ç¾¤ï¼Œä¸å¯é¢„å®¡             | æ¸²æŸ“ç»“æœå¯è§ï¼Œå…ˆå®¡æŸ¥å†éƒ¨ç½²      |
| å˜æ›´åªå­˜åœ¨äº Helm Release Secret | å˜æ›´å­˜æ¡£åœ¨ Gitï¼Œç‰ˆæœ¬å¯å›æº¯      |
| æ¸²æŸ“é€»è¾‘ä¸é€æ˜                   | æ¸²æŸ“ YAML é€æ˜å¯å®¡è®¡            |
| ä¾èµ– Helm ç‰ˆæœ¬å’Œç¯å¢ƒ             | åªéœ€ kubectl ç¯å¢ƒ               |



#### ç›®å‰**å¤§è§„æ¨¡ç”Ÿäº§å®è·µä¸­æ¨èçš„æœ€ä½³æ¨¡å¼**

**Helm åšåŒ…ç®¡ç†**

- ä¿ç•™ Helm Chart ä½œä¸º**å®˜æ–¹äº¤ä»˜ç‰©**ã€‚
- å¯ä»¥**ç»Ÿä¸€ç»´æŠ¤ä¾èµ–**ã€**å‚æ•°åŒ–é…ç½®**ã€**ç‰ˆæœ¬æ§åˆ¶**ã€‚
- å›¢é˜Ÿä¸éœ€è¦é‡å¤å†™ä¸€å †è£¸ YAMLã€‚

**Template + GitOps åšéƒ¨ç½²äº¤ä»˜**

- **è§£è€¦ Helm å®¢æˆ·ç«¯**ï¼Œé¿å…ä¾èµ–æœ¬åœ°ç¯å¢ƒã€‚
- **å…¨é‡ YAML å¯è¯»å¯å®¡è®¡**ï¼Œç¬¦åˆå®‰å…¨å’Œåˆè§„è¦æ±‚ã€‚
- **GitOps è‡ªåŠ¨åŒ–**ï¼Œä¿éšœéƒ¨ç½²æµç¨‹ä¸€è‡´å¯å›æº¯ã€‚
- **CI/CD é›†æˆ**ï¼Œå›¢é˜Ÿæå‰åœ¨ PR é˜¶æ®µå‘ç°é—®é¢˜ã€‚



#### å…³äº`crds.install=false`çš„è§£é‡Š

`crds.install=false`çš„å«ä¹‰ï¼š**è·³è¿‡ Helm è‡ªåŠ¨å®‰è£… CRD**



**è·³è¿‡ Helm è‡ªåŠ¨å®‰è£… CRDçš„åŸå› **

- **CRD é€šå¸¸æ˜¯å…¨å±€å”¯ä¸€èµ„æº**ï¼Œ**æ‰€æœ‰å‘½åç©ºé—´å…±äº«**ã€‚
   é¢‘ç¹æ‰§è¡Œ `helm upgrade` æˆ–å¤šæ¬¡å®‰è£…ä¼š**åå¤å®‰è£…æˆ–å‡çº§ CRD**ï¼Œæœ‰ç ´åé£é™©ã€‚

- **æœ‰äº›ä¼ä¸šæ›´å¸Œæœ›**ï¼š

  - **å•ç‹¬ç®¡ç† CRD ç”Ÿå‘½å‘¨æœŸ**ï¼ˆæ¯”å¦‚ç”¨ `kubectl apply` æˆ–ä¸“é—¨çš„ CRD Chartï¼‰ã€‚

  - **é˜²æ­¢è¯¯æ“ä½œ**ç ´åå·²æœ‰ CRD æˆ– Custom Resource æ•°æ®ã€‚



#### å®é™…å·¥ä½œæµç¤ºä¾‹

**æ‰‹åŠ¨æˆ– CI é˜¶æ®µå®‰è£… CRD**

```bash
kubectl apply -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/crds.yaml
```

**è·³è¿‡ CRD å®‰è£…éƒ¨ç½² Chart**

```bash
helm install argo argo/argo-cd --set crds.install=false
```





## 12. CRD



### CRDå®šåˆ¶èµ„æº

#### CRDè¯´æ˜

ä¸ºäº†åœ¨k8sä¸Šèƒ½å¤Ÿæ­£å¸¸çš„è¿è¡Œæ‰€éœ€çš„æœåŠ¡ï¼Œéœ€è¦éµå¾ªä»¥ä¸‹æ–¹å¼æ¥åˆ›å»ºç›¸å…³èµ„æºï¼š

- åˆç†çš„åˆ†æä¸šåŠ¡éœ€æ±‚
- æ¢³ç†ä¸šåŠ¡éœ€æ±‚çš„ç›¸å…³åŠŸèƒ½
- å®šåˆ¶ä¸åŒåŠŸèƒ½çš„èµ„æºé…ç½®æ–‡ä»¶
- åº”ç”¨èµ„æºé…ç½®æ–‡ä»¶ï¼Œå®Œå–„ä¸šåŠ¡ç¯å¢ƒã€‚

å½“å‰æ‰€æœ‰çš„æ“ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯åœ¨k8så†…ç½®çš„æœ‰é™çš„èµ„æºå¯¹è±¡ä¸­è¿›è¡Œç›¸å…³çš„æ“ä½œï¼Œè¿™äº›èµ„æºå¯¹è±¡é€‚ç”¨äºé€šç”¨çš„ ä¸šåŠ¡åœºæ™¯ï¼Œè€Œåœ¨æˆ‘ä»¬çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¤šå¤šå°‘å°‘çš„ä¼šæ¶‰åŠåˆ°ç‰¹æ®ŠåŠŸèƒ½çš„èµ„æºå¯¹è±¡ã€‚

æ¯”å¦‚ï¼šç›‘æ§åœºæ™¯éœ€è¦ç›‘æ§çš„æ•°æ®ã€æ—¥å¿—åœºæ™¯éœ€è¦æ”¶é›†çš„æ—¥å¿—ã€æµé‡åœºæ™¯éœ€è¦ä¼ é€’çš„æ•°æ®ç­‰ç­‰

ä¸ºäº†é«˜æ•ˆçš„å®šåˆ¶æˆ‘ä»¬éœ€è¦çš„ç¯å¢ƒï¼Œé‚£ä¹ˆéœ€è¦æ‹¥æœ‰ä¸€äº›ä¸“ç”¨çš„èµ„æºæ–¹ä¾¿æˆ‘ä»¬æ¥ä½¿ç”¨ï¼Œè€Œåœ¨k8sä¹‹ä¸Šæä¾›äº†ä¸€ä¸ªä¸“ç”¨çš„æ¥å£ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬è‡ªå·±æ¥å®šåˆ¶éœ€è¦çš„èµ„æºã€‚



**æ‰©å±•Kubernetes APIå¸¸ç”¨æ–¹å¼ï¼š**

- äºŒæ¬¡å¼€å‘ API Server æºç ,é€‚åˆåœ¨æ·»åŠ æ–°çš„**æ ¸å¿ƒç±»å‹**æ—¶é‡‡ç”¨
- å¼€å‘è‡ªå®šä¹‰API Serverå¹¶èšåˆè‡³ä¸»API Server ,å¯Œäºå¼¹æ€§ä½†ä»£ç å·¥ä½œé‡å¤§
- ä½¿ç”¨CRD( Custom Resource Definition )è‡ªå®šä¹‰èµ„æºç±»å‹ , æ˜“ç”¨ä½†é™åˆ¶è¾ƒå¤šï¼Œå¯¹åº”çš„æ§åˆ¶å™¨è¿˜éœ€å†è‡ªè¡Œå¼€å‘

![image-20250324173232195](D:\git_repository\cyber_security_learning\markdown_img\image-20250324173232195.png)

ç¤ºä¾‹: æŸ¥çœ‹calico è‡ªå®šä¹‰çš„èµ„æºCRD

```bash
# calicoç¯å¢ƒåˆ›å»ºçš„æ—¶å€™ï¼Œå°±ç”¨åˆ°äº†å¾ˆå¤šCRDå¯¹è±¡ï¼Œè€Œä¸”æˆ‘ä»¬ä¸ºäº†è®©CRDèƒ½å¤Ÿç”Ÿæ•ˆï¼Œè¯¥è½¯ä»¶è¿˜æä¾›äº†ä¸€ä¸ªcontrollerçš„CRDæ§åˆ¶å™¨ã€‚è¿™ä¸ªæ§åˆ¶å™¨å°±æ˜¯å°†CRDå¯¹è±¡è½¬æ¢ä¸ºçœŸæ­£æœ‰æ„ä¹‰çš„ç°å®çš„ä»£ç ã€‚
[root@master1 statefulset]#kubectl get pod -n kube-system |grep -i calico
calico-kube-controllers-77d59654f4-rwl4p       1/1     Running   22 (8h ago)   41d
calico-node-7xpvt                              1/1     Running   25 (8h ago)   41d
calico-node-8tn8p                              1/1     Running   22 (8h ago)   41d
calico-node-qqmsz                              1/1     Running   24 (8h ago)   41d
calico-node-wzdrm                              1/1     Running   24 (8h ago)   41d
```



##### CRDç®€ä»‹

èµ„æºï¼ˆResourceï¼‰ æ˜¯ Kubernetes API ä¸­çš„ä¸€ä¸ªç«¯ç‚¹ï¼Œ å…¶ä¸­å­˜å‚¨çš„æ˜¯æŸä¸ªç±»åˆ«çš„ API å¯¹è±¡ çš„ä¸€ä¸ªé›†åˆã€‚ ä¾‹å¦‚å†…ç½®çš„ pods èµ„æºåŒ…å«ä¸€ç»„ Pod å¯¹è±¡

å®šåˆ¶èµ„æºï¼ˆCustom Resourceï¼‰ æ˜¯å¯¹ Kubernetes API çš„æ‰©å±•ï¼Œä¸ä¸€å®šåœ¨é»˜è®¤çš„ Kubernetes å®‰è£…ä¸­å°±å¯ç”¨ã€‚å®šåˆ¶èµ„æºæ‰€ä»£è¡¨çš„æ˜¯å¯¹ç‰¹å®š Kubernetes å®‰è£…çš„ä¸€ç§å®šåˆ¶ã€‚ ä¸è¿‡ï¼Œå¾ˆå¤š Kubernetes æ ¸å¿ƒåŠŸèƒ½ç°åœ¨éƒ½ç”¨å®šåˆ¶èµ„æºæ¥å®ç°ï¼Œè¿™ä½¿å¾— Kubernetes æ›´åŠ æ¨¡å—åŒ–ã€‚

CRD( Custom Resource Definition ) å®šåˆ¶èµ„æºå¯ä»¥é€šè¿‡åŠ¨æ€æ³¨å†Œçš„æ–¹å¼åœ¨è¿è¡Œä¸­çš„é›†ç¾¤å†…æˆ–å‡ºç°æˆ–æ¶ˆå¤±ï¼Œé›†ç¾¤ç®¡ç†å‘˜å¯ä»¥ç‹¬ç«‹äºé›†ç¾¤æ›´æ–°å®šåˆ¶èµ„æºã€‚ä¸€æ—¦æŸå®šåˆ¶èµ„æºè¢«å®‰è£…ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨ kubectl æ¥åˆ›å»º å’Œè®¿é—®å…¶ä¸­çš„å¯¹è±¡ï¼Œå°±åƒä»–ä»¬ä¸º pods è¿™ç§å†…ç½®èµ„æºæ‰€åšçš„ä¸€æ ·ã€‚

CRD åŠŸèƒ½æ˜¯åœ¨ Kubernetes 1.7 ç‰ˆæœ¬è¢«å¼•å…¥çš„ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚æ·»åŠ è‡ªå®šä¹‰çš„ Kubernetes å¯¹è±¡èµ„æºã€‚

![image-20250324173658794](D:\git_repository\cyber_security_learning\markdown_img\image-20250324173658794.png)

##### å®šåˆ¶CRDçš„æ§åˆ¶å™¨

å°±å®šåˆ¶èµ„æºæœ¬èº«è€Œè¨€ï¼Œå®ƒåªèƒ½ç”¨æ¥å­˜å–ç»“æ„åŒ–çš„æ•°æ®ã€‚ å½“ä½ å°†**å®šåˆ¶èµ„æº**ä¸**å®šåˆ¶æ§åˆ¶å™¨**ï¼ˆCustom  Controllerï¼‰ ç›¸ç»“åˆæ—¶ï¼Œå®šåˆ¶èµ„æºå°±èƒ½å¤Ÿ æä¾›çœŸæ­£çš„å£°æ˜å¼ APIï¼ˆDeclarative APIï¼‰ã€‚

ä½¿ç”¨å£°æ˜å¼ APIï¼Œ ä½ å¯ä»¥å£°æ˜æˆ–è€…è®¾å®šä½ çš„èµ„æºçš„æœŸæœ›çŠ¶æ€ï¼Œå¹¶å°è¯•è®© Kubernetes å¯¹è±¡çš„å½“å‰çŠ¶æ€åŒ æ­¥åˆ°å…¶æœŸæœ›çŠ¶æ€ã€‚æ§åˆ¶å™¨è´Ÿè´£å°†ç»“æ„åŒ–çš„æ•°æ®è§£é‡Šä¸ºç”¨æˆ·æ‰€æœŸæœ›çŠ¶æ€çš„è®°å½•ï¼Œå¹¶æŒç»­åœ°ç»´æŠ¤è¯¥çŠ¶æ€ã€‚

**èµ„æºå¯¹è±¡çš„å®šåˆ¶æ–¹å¼:**

- åœ¨ç°æœ‰çš„æ§åˆ¶å™¨åŸºç¡€ä¸Šï¼Œæ‰©å±•èµ„æºå¯¹è±¡
- ä»0å¼€å§‹å®šåˆ¶èµ„æºå¯¹è±¡å’Œèµ„æºå¯¹è±¡æ§åˆ¶å™¨ï¼Œæ­¤æ–¹å¼éœ€è¦å…·æœ‰ç¼–ç¨‹è¯­è¨€çš„å¼€å‘èƒ½åŠ›

é€šå¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªCRDä¼šç»“åˆå¯¹åº”çš„Controllerï¼Œå¹¶æ·»åŠ ä¸€äº›å…¶å®ƒèµ„æºï¼Œç»„æˆä¸€ä¸ªä¸“å±åº”ç”¨çš„ **Operator**ï¼Œæ¥è§£å†³ç‰¹å®šåº”ç”¨çš„åŠŸèƒ½





## 13. NetworkPolicy

### NetWork-Policy

#### NetWork-Policyç®€ä»‹

- æ ‡å‡†çš„ API èµ„æºç±»å‹
- ç”±ç½‘ç»œæ’ä»¶è´Ÿè´£è½¬æ¢ä¸ºèŠ‚ç‚¹ä¸Šçš„iptables Filterè§„åˆ™ï¼Œå·²å®šä¹‰ Pod é—´çš„é€šä¿¡è®¸å¯
- ä¸»è¦é’ˆå¯¹ TCPã€UDPçš„ SCTP åè®®ï¼Œå®ç°åœ¨ IPåœ°å€ æˆ–è€… Portå±‚é¢ è¿›è¡Œæµé‡æ§åˆ¶
- **NetworkPolicy å°±æ˜¯é’ˆå¯¹ä¸€ç»„ Pod è¿›è¡Œç®¡æ§ï¼Œè¦ä¹ˆæ˜¯ç®¡æ§è‡ªå·±èƒ½å¤Ÿè®¿é—®è°ï¼ˆEgressï¼‰ï¼Œè¦ä¹ˆæ˜¯ç®¡æ§è°èƒ½è®¿é—®æˆ‘ï¼ˆIngressï¼‰**
  - NetworkPolicy ä¸æ˜¯è®¾ç½®åœ¨é›†ç¾¤å…¨å±€çš„ï¼Œå®ƒæ˜¯ **ä½œç”¨äºè¢«é€‰ä¸­çš„ä¸€ç»„ Pod**ï¼ˆé€šè¿‡ `podSelector`ï¼‰ã€‚
  - å°±åƒä½ ç»™æŸäº› Pod è£…äº†é˜²ç«å¢™ï¼Œå®ƒä»¬èƒ½ä¸èƒ½è®¿é—®åˆ«äººã€èƒ½ä¸èƒ½è¢«åˆ«äººè®¿é—®ï¼Œå…¨çœ‹ä½ åœ¨ Policy é‡Œæ€ä¹ˆå†™ã€‚



#### Network-Policyçš„åŠŸèƒ½

- é’ˆå¯¹ä¸€ç»„Podï¼Œå®šä¹‰å…¶åŒå¯¹ç«¯å®ä½“é€šä¿¡æ—¶ï¼Œåœ¨å…¥å‘ï¼ˆIngressï¼‰æˆ–/å’Œ å‡ºå‘ï¼ˆEgressï¼‰æµé‡ä¸Šçš„æ§åˆ¶è§„åˆ™
- æè¿°å¯¹ç«¯å®ä½“çš„æ–¹æ³•æœ‰å¦‚ä¸‹å‡ ç§
  - ä¸€ç»„ Pod å¯¹è±¡ï¼Œé€šå¸¸åŸºäºæ ‡ç­¾é€‰æ‹©å™¨å®šä¹‰ç­›é€‰æ¡ä»¶
  - å•ä¸ªæˆ–ä¸€ç»„åç§°ç©ºé—´
  - IPåœ°å€å—ï¼ˆä½† Pod åŒå…¶æ‰€åœ¨çš„èŠ‚ç‚¹é—´çš„é€šä¿¡ä¸å—é™åˆ¶ï¼‰
- Network Policy çš„å…·ä½“å®ç°ä¾èµ–äº Network Plugin



#### Network-Policyçš„ç”Ÿæ•ˆæœºåˆ¶

- é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ç»„Podä¸Šçš„å‡ºå‘å’Œå…¥å‘æµé‡å‡è¢«å…è®¸
- åŒä¸€æ–¹å‘ä¸Šï¼Œé€‚ç”¨äºä¸€ç»„Podçš„å¤šä¸ªè§„åˆ™çš„ç”Ÿæ•ˆéµå¾ªåŠ æ³•æœºåˆ¶
  - ä¸€ç»„Podä¸Šï¼Œå¤šä¸ªIngressç­–ç•¥ç›¸åŠ æ‰€ç”Ÿæˆçš„é›†åˆï¼ˆå¹¶é›†ï¼‰æ˜¯ä¸ºæœ€ç»ˆç”Ÿæ•ˆçš„æ•ˆæœ
  - ä¸€ç»„Podä¸Šï¼Œå¤šä¸ªEgressç­–ç•¥ç›¸åŒæ‰€ç”Ÿæˆçš„é›†åˆæ˜¯ä¸ºæœ€ç»ˆç”Ÿæ•ˆçš„ç­–ç•¥	

- è‹¥åŒæ—¶å®šä¹‰äº†Ingresså’ŒEgressè§„åˆ™ï¼Œé’ˆå¯¹ä¸€ä¸ªå¯¹ç«¯ï¼ŒåŒå‘ç­–ç•¥éƒ½ä¸ºâ€œè®¸å¯â€ï¼Œé€šä¿¡æ‰èƒ½çœŸå®å®ç°



#### Network-Policyèµ„æºè§„èŒƒ

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: ...
  namespace: ...          # NetworkPolicyæ˜¯åç§°ç©ºé—´çº§åˆ«çš„èµ„æº
spec:
  egress:                 # å‡ºå‘æµé‡æ§åˆ¶è§„åˆ™ï¼Œé»˜è®¤å¼€æ”¾
    to:                   # å‡ºå‘æµé‡æ§åˆ¶è§„åˆ™ï¼Œé»˜è®¤ä¸ºå¼€æ”¾ï¼›æµé‡ç›®æ ‡çš„è¡¨ç¤ºæ–¹å¼ä¸Ingress.fromç›¸åŒ 
    ports:                # å‡ºå‘æµé‡çš„ç›®æ ‡ç«¯å£ï¼›æµé‡ç›®æ ‡ç«¯å£çš„è¡¨ç¤ºæ–¹å¼ä¸Ingress.portsç›¸åŒ
  ingress:                # å…¥å‘æµé‡æ§åˆ¶è§„åˆ™ï¼Œé»˜è®¤å¼€æ”¾
    from:                 # å…¥å‘æµé‡æºï¼Œå¤šä¸ªåˆ—è¡¨é¡¹ä¹‹é—´ä¸º"æˆ–"é€»è¾‘ï¼›æœªç»™å®šä»»ä½•å€¼æˆ–æœªå®šä¹‰è¯¥å­—æ®µï¼Œå°†åŒ¹é…æ‰€æœ‰æµé‡æºï¼›
                          # å®šä¹‰äº†è¯¥å­—æ®µä¸”è‡³å°‘å­˜åœ¨ä¸€ä¸ªitemï¼Œåˆ™è¡¨ç¤ºä»…å…è®¸æŒ‡å®šçš„æµé‡æº
      ipBlock:            # æºIPåœ°å€æ®µï¼Œé€šå¸¸æ˜¯ç½‘ç»œåœ°å€ï¼›ä¸æ”¯æŒåŒNamespaceSelectoræˆ–podSeletoråŒæ—¶ä½¿ç”¨ï¼›
        cidr:             # CIDRæ ¼å¼çš„ç½‘ç»œåœ°å€
        except:           # è¦æ’é™¤çš„åœ°å€åˆ—è¡¨ï¼Œå¯ä»¥æ˜¯CIDRæ ¼å¼çš„å­ç½‘åœ°å€
      namespaceSelector:  # namespaceæ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºè¡¨ç¤ºæºè‡ªåŒ¹é…åˆ°çš„Namespaceå†…çš„æ‰€æœ‰æµé‡
      podSelector:        # podæ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºè¡¨ç¤ºæºè‡ªåŒ¹é…åˆ°çš„Podä¸Šçš„æ‰€æœ‰æµé‡ï¼›å¯ä»¥åŒnamespaceSelectoråŒæ—¶ä½¿ç”¨
                          # ç”¨äºåŒ¹é…é€‰å®šçš„namespaceä¸­çš„pod
    ports:                # å…¥å‘æµé‡çš„ç›®æ ‡ç«¯å£ï¼Œå³æµé‡æºè¦è®¿é—®çš„ç›®æ ‡ç«¯å£ï¼Œç”Ÿæ•ˆæœºåˆ¶åŒfrom
      port:               # ç«¯å£ï¼ŒåŒendPortå­—æ®µåŒæ—¶ä½¿ç”¨æ—¶ï¼Œè¡¨ç¤ºç«¯å£èŒƒå›´çš„èµ·å§‹ç«¯å£å·
      endpoint:           # ç«¯å£å·ï¼šåŒportå­—æ®µåŒæ—¶ä½¿ç”¨æ—¶ï¼Œè¡¨ç¤ºç«¯å£èŒƒå›´çš„ç»“æŸç«¯å£å·
      protocol:           # åè®®ï¼Œä»…æ”¯æŒTCPã€UDPå’ŒSCTPï¼Œé»˜è®¤ä¸ºTCP
  podSelector:            # Podæ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºé€‰å®šæµé‡è§„åˆ™é€‚ç”¨çš„å¯¹è±¡ï¼Œå¿…é€‰å­—æ®µ
  policyTypes:            # è§„åˆ™ç±»å‹ï¼Œæ”¯æŒIngressï¼ŒEgressï¼Œé»˜è®¤åœ¨ä¸¤ä¸ªæ–¹å‘ä¸ŠåŒæ—¶ç”Ÿæ•ˆ
```



#### Network-Policyèµ„æºç¤ºä¾‹

```yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-all-ingress
spec:
  podSelector: {}
  ingress:            
  - {}     # æ­¤å¤„ï¼Œé…ç½®äº†Ingresså­—æ®µï¼Œä¸”æ·»åŠ äº†ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ï¼Œè¡¨ç¤ºä»…å…è®¸åŒ¹é…åˆ°çš„æµé‡æºï¼Œè€Œä¸€ä¸ªä¸ºç©ºçš„å…ƒç´ åˆ™è¡¨ç¤ºåŒ¹é…æ‰€æœ‰æµé‡æº
  policyTypes:
  - Ingress
```

```yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
spec:
  podSelector: {}
  # ingress:
  ingress: []  # æ­¤å¤„ï¼Œä¸åŒ¹é…ingresså­—æ®µï¼Œæˆ–ä½¿ç”¨å¦‚ä¸‹ä¸¤ç§æ–¹å¼ä¹‹ä¸€ï¼Œæ„ä¹‰ç›¸åŒï¼›å®ƒä»¬è¡¨ç¤ºä¸åŒ¹é…ä»»ä½•æµé‡æºï¼šingress:|ingress:[]
  policyTypes:
  - ingress
```

```yaml
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-selector-ingresses
  namespace: default
spec:
  podSelector: {}
  ingress:
  - from:  # ç¬¬ä¸€ä¸ªfromä¸­ä¸¤ä¸ªåˆ—è¡¨å…ƒç´ namespaceSelectorå’ŒipBlockï¼Œå®ƒä»¬æ˜¯å¹¶åˆ—å…³ç³»ï¼Œå³åŒ¹é…ä¸¤ä¸ªè§„åˆ™ï¼Œå› æ­¤å–æˆ–
    - namespaceSelector:
      matchExpressions:
      - key: kubernetes.io/metadata.name
        operator: in
        values: ["default", "kuber-system", "monitor"]  # å¦‚æœåŒä¸€åç§°ç©ºé—´ä¸­ï¼Œæ²¡æœ‰åŒ¹é…è‡ªå·±çš„åç§°ç©ºé—´ï¼Œåˆ™åç§°ç©ºé—´å†…éƒ¨æ—                                                            æ³•é€šä¿¡
    - ipBlock:
      cidr: 192.168.10.0/24
    ports: []  # portsä¸ºç©ºï¼Œè¡¨ç¤ºå…¨åŒ¹é…
  - from:  # ç¬¬äºŒä¸ªfromä¸­æ˜¯ç¬¬ä¸€ä¸ªåˆ—è¡¨å…ƒç´ ä¸­çš„å­—æ®µå…ƒç´ namespaceSelectorå’ŒpodSelector,å³ä¸€ä¸ªåŒ¹é…è§„åˆ™ä¸¤ä¸ªæ¡ä»¶ï¼Œå› æ­¤å–ä¸
    - namespaceSelector:   # ä¸¤ä¸ªfromå½¼æ­¤é—´æ˜¯æˆ–é€»è¾‘
        matchLabels:
          kubernetes.io/metadata.name: demo
      podSelector:
        matchExpressions:
        - key: app
          operator: in
          values: ["demoapp","nginx"]
    ports:
    - port: 80
      protocol: TCP
  policyTypes:
  - ingress
```

