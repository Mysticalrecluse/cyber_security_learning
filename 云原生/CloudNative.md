# CloudNative



## ä»€ä¹ˆæ˜¯äº‘åŽŸç”Ÿï¼ˆCloud Nativeï¼‰?



**äº‘åŽŸç”Ÿï¼ˆCloud Nativeï¼‰æ˜¯ä¸€ç§è®¾è®¡ç†å¿µå’ŒæŠ€æœ¯æž¶æž„**ï¼Œæ—¨åœ¨å……åˆ†åˆ©ç”¨äº‘çŽ¯å¢ƒçš„ä¼˜åŠ¿ï¼Œæ¥å¼€å‘ã€éƒ¨ç½²å’Œç®¡ç†**é«˜æ•ˆã€å¼¹æ€§ã€å¯æ‰©å±•å’Œè‡ªåŠ¨åŒ–çš„çŽ°ä»£åŒ–åº”ç”¨ç¨‹åº**ã€‚

äº‘åŽŸç”Ÿçš„æ ¸å¿ƒç›®æ ‡æ˜¯è®©åº”ç”¨ç¨‹åºèƒ½å¤Ÿ**åŠ¨æ€è°ƒæ•´èµ„æº**ï¼Œå®žçŽ°**é«˜å¯ç”¨æ€§**ã€**é«˜å¯æ‰©å±•æ€§**å’Œ**çµæ´»æ€§**ã€‚äº‘åŽŸç”Ÿçš„å®žçŽ°é€šå¸¸ä¾èµ–äºŽ**å®¹å™¨åŒ–æŠ€æœ¯ï¼ˆå¦‚Dockerï¼‰**ã€**ç¼–æŽ’ç³»ç»Ÿï¼ˆå¦‚Kubernetesï¼‰**ã€**å¾®æœåŠ¡æž¶æž„**å’Œ**æŒç»­äº¤ä»˜/é›†æˆï¼ˆCI/CDï¼‰**ç­‰æŠ€æœ¯ã€‚





## äº‘åŽŸç”Ÿçš„æ ¸å¿ƒæ€æƒ³



**æ¾è€¦åˆçš„æž¶æž„**

- ä¼ ç»Ÿçš„â€œå•ä½“åº”ç”¨â€ä¸Žâ€œäº‘åŽŸç”Ÿåº”ç”¨â€æœ€å¤§çš„åŒºåˆ«æ˜¯ï¼Œäº‘åŽŸç”Ÿåº”ç”¨é€šè¿‡**å¾®æœåŠ¡**å°†æ¯ä¸ªæ¨¡å—ç‹¬ç«‹éƒ¨ç½²ã€ç‹¬ç«‹æ‰©ç¼©ã€‚
- äº‘åŽŸç”Ÿåº”ç”¨**æ¯ä¸ªæœåŠ¡æ¨¡å—ç‹¬ç«‹å¼€å‘ã€ç‹¬ç«‹æµ‹è¯•ã€ç‹¬ç«‹éƒ¨ç½²**ï¼Œäº’ä¸å½±å“ã€‚

**å£°æ˜Žå¼çš„API**

- äº‘åŽŸç”Ÿä½¿ç”¨**å£°æ˜Žå¼API**ï¼ˆDeclarative APIï¼‰ç®¡ç†åŸºç¡€æž¶æž„å’ŒæœåŠ¡ã€‚
- ä¾‹å¦‚ï¼ŒKubernetesä¸­çš„**YAMLæ–‡ä»¶**å°±æ˜¯å£°æ˜Žå¼APIçš„å…¸åž‹ç¤ºä¾‹ï¼Œç”¨æˆ·åªéœ€è¦å£°æ˜ŽæœŸæœ›çš„çŠ¶æ€ï¼Œè€Œä¸éœ€è¦å…³å¿ƒå¦‚ä½•å®žçŽ°ã€‚

**è‡ªåŠ¨åŒ–è¿ç»´ (Self-Healing)**

- äº‘åŽŸç”Ÿåº”ç”¨ä¾èµ–**è‡ªåŠ¨åŒ–ç›‘æŽ§å’Œå‘Šè­¦ç³»ç»Ÿ**ã€‚
- Kubernetesä¸­çš„**é‡å¯ç­–ç•¥ã€å¥åº·æ£€æŸ¥ï¼ˆhealth checkï¼‰ã€å°±ç»ªæŽ¢é’ˆï¼ˆreadiness probeï¼‰**ï¼Œéƒ½å¯ä»¥å®žçŽ°è‡ªåŠ¨æ¢å¤å’Œä¿®å¤ã€‚
- åœ¨å®¹å™¨å¤±è´¥ã€å´©æºƒæ—¶ï¼ŒKubernetesä¼š**è‡ªåŠ¨é‡å»ºPod**ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

**å¼¹æ€§å’Œè‡ªé€‚åº”èƒ½åŠ›**

- äº‘åŽŸç”Ÿåº”ç”¨å…·å¤‡**è‡ªåŠ¨æ‰©å®¹å’Œç¼©å®¹**çš„èƒ½åŠ›ã€‚
- å½“æµé‡æ¿€å¢žæ—¶ï¼ŒKuberneteså¯ä»¥åœ¨å‡ ç§’é’Ÿå†…**è‡ªåŠ¨æ‰©å±•Podæ•°é‡**ï¼Œå½“æµé‡ä¸‹é™æ—¶ï¼ŒPodæ•°é‡ä¼šè‡ªåŠ¨å‡å°‘ï¼Œé™ä½Žæˆæœ¬ã€‚

**åŸºç¡€è®¾æ–½å³ä»£ç  (IaC)**

- äº‘åŽŸç”Ÿå¼ºè°ƒ**ä¸€åˆ‡åŸºç¡€è®¾æ–½å’Œé…ç½®éƒ½è¦ä»¥ä»£ç çš„å½¢å¼å­˜åœ¨**ï¼Œè¿™ä½¿å¾—çŽ¯å¢ƒçš„åˆ›å»ºã€å˜æ›´å’Œé”€æ¯éƒ½å˜å¾—å¯è‡ªåŠ¨åŒ–ã€‚
- ä½¿ç”¨çš„å·¥å…·æœ‰**Terraform**ã€**Ansible**ã€**Helm**ç­‰ã€‚

**å¯è§‚æµ‹æ€§**

- åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œå¿…é¡»ç¡®ä¿ç³»ç»Ÿçš„**æ—¥å¿—ï¼ˆlogï¼‰**ã€**æŒ‡æ ‡ï¼ˆmetricsï¼‰\**å’Œ\**è¿½è¸ªï¼ˆtracingï¼‰**ã€‚
- ä½¿ç”¨Prometheusã€Grafanaç­‰å·¥å…·ï¼Œå¯ä»¥ç›´è§‚åœ°äº†è§£äº‘åŽŸç”Ÿç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€ï¼Œæ£€æµ‹ç“¶é¢ˆå’Œæ•…éšœç‚¹ã€‚





## äº‘åŽŸç”Ÿçš„å››å¤§æŠ€æœ¯åŸºçŸ³



**å®¹å™¨åŒ– (Containerization)**

- å®¹å™¨æ˜¯äº‘åŽŸç”Ÿçš„æœ€æ ¸å¿ƒæŠ€æœ¯ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªä¸Žæ“ä½œç³»ç»Ÿéš”ç¦»çš„è¿è¡ŒçŽ¯å¢ƒï¼Œä¾¿äºŽ**è·¨å¹³å°éƒ¨ç½²**ã€‚
- **Docker** å’Œ **OCI å®¹å™¨**ï¼ˆå¦‚containerdã€Podmanï¼‰ç­‰å·¥å…·å°±æ˜¯å®¹å™¨åŒ–çš„å…¸åž‹ä»£è¡¨ã€‚
- **å¥½å¤„**ï¼šæ›´å¿«çš„å¯åŠ¨ã€æ›´é«˜çš„èµ„æºåˆ©ç”¨çŽ‡ã€çŽ¯å¢ƒä¸€è‡´æ€§å’Œé«˜å¯ç§»æ¤æ€§ã€‚

**åŠ¨æ€ç¼–æŽ’ (Orchestration)**

- å®¹å™¨åŒ–çš„åº”ç”¨éœ€è¦ä¸€ä¸ªè°ƒåº¦å™¨æ¥ç®¡ç†è¿™äº›å®¹å™¨çš„**è‡ªåŠ¨éƒ¨ç½²ã€æ‰©ç¼©å®¹å’Œæ•…éšœä¿®å¤**ã€‚
- **Kubernetes**ï¼ˆK8sï¼‰å°±æ˜¯è¿™ç§è°ƒåº¦å™¨çš„ä»£è¡¨ã€‚
- Kuberneteså¯ä»¥ç®¡ç†**å¤šé›†ç¾¤çš„å¤šèŠ‚ç‚¹åˆ†å¸ƒå¼æœåŠ¡**ï¼Œä»¥å®žçŽ°è·¨äº‘å¹³å°çš„é«˜å¯ç”¨éƒ¨ç½²ã€‚

**å¾®æœåŠ¡æž¶æž„ (Microservices)**

- å°†åŽŸæœ¬çš„å•ä½“åº”ç”¨æ‹†è§£æˆå¤šä¸ª**å¯ç‹¬ç«‹å¼€å‘å’Œéƒ¨ç½²çš„å¾®æœåŠ¡**ï¼Œè¿™äº›å¾®æœåŠ¡é€šè¿‡**APIæˆ–æ¶ˆæ¯é˜Ÿåˆ—**è¿›è¡Œé€šä¿¡ã€‚
- å„å¾®æœåŠ¡å¯ä»¥å•ç‹¬éƒ¨ç½²ã€æ‰©å®¹ã€å›žæ»šã€å‡çº§ï¼Œè€Œä¸å½±å“å…¶ä»–æ¨¡å—ã€‚

**æŒç»­äº¤ä»˜å’ŒæŒç»­é›†æˆ (CI/CD)**

- **CI/CD**ä½¿å¾—å¼€å‘äººå‘˜çš„ä»£ç å˜æ›´èƒ½å¤Ÿè¢«**è‡ªåŠ¨åŒ–æž„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²**ã€‚
- ä½¿ç”¨çš„å·¥å…·æœ‰**Jenkins**ã€**GitLab CI/CD** å’Œ **ArgoCD** ç­‰ã€‚
- CI/CDæµæ°´çº¿å¯åœ¨å¼€å‘åˆ°ç”Ÿäº§çš„è¿‡ç¨‹ä¸­è¿›è¡Œ**è‡ªåŠ¨åŒ–éªŒè¯ã€å›žæ»šå’Œç›‘æŽ§**ã€‚





## äº‘åŽŸç”Ÿçš„å…³é”®æŠ€æœ¯æ ˆ



| **é¢†åŸŸ**       | **æŠ€æœ¯**             | **ä½œç”¨**                             |
| -------------- | -------------------- | ------------------------------------ |
| **å®¹å™¨åŒ–**     | Docker, Podman       | æä¾›æ ‡å‡†çš„å®¹å™¨åŒ–è¿è¡ŒçŽ¯å¢ƒ             |
| **å®¹å™¨ç¼–æŽ’**   | Kubernetes (K8s)     | ç®¡ç†å’Œç¼–æŽ’å®¹å™¨ï¼Œæä¾›æ‰©ç¼©å®¹å’Œè‡ªæ„ˆèƒ½åŠ› |
| **å¾®æœåŠ¡**     | Spring Boot, Istio   | æ”¯æŒå¾®æœåŠ¡æž¶æž„                       |
| **CI/CD**      | Jenkins, GitLab CI   | æŒç»­äº¤ä»˜å’ŒæŒç»­é›†æˆ                   |
| **ç›‘æŽ§ä¸Žæ—¥å¿—** | Prometheus, Grafana  | ç›‘æŽ§ã€æ—¥å¿—ã€å‘Šè­¦ç³»ç»Ÿ                 |
| **ç½‘ç»œç®¡ç†**   | Calico, Flannel      | å®¹å™¨ç½‘ç»œ                             |
| **æœåŠ¡ç½‘æ ¼**   | Istio, Linkerd       | ç®¡ç†å¾®æœåŠ¡çš„é€šä¿¡ï¼Œæä¾›å¯è§‚å¯Ÿæ€§       |
| **å­˜å‚¨**       | Ceph, Rook, Longhorn | æä¾›äº‘åŽŸç”Ÿçš„åˆ†å¸ƒå¼å­˜å‚¨è§£å†³æ–¹æ¡ˆ       |
| **é…ç½®ç®¡ç†**   | Helm, Ansible        | ç®¡ç†åº”ç”¨å’Œé›†ç¾¤çš„é…ç½®                 |

------





## äº‘åŽŸç”Ÿçš„å®žé™…åœºæ™¯



1. **ç”µå•†å¤§ä¿ƒé”€**
   - ä¿ƒé”€æ´»åŠ¨æµé‡é«˜å³°ï¼Œä½¿ç”¨Kubernetesçš„**HPAï¼ˆæ°´å¹³è‡ªåŠ¨æ‰©å±•ï¼‰**æ¥åŠ¨æ€æ‰©å±•æœåŠ¡å®žä¾‹ã€‚
   - æ—¥å¸¸æµé‡ä½Žæ—¶ï¼ŒPodæ•°é‡å‡å°‘ï¼Œ**èŠ‚çœè®¡ç®—èµ„æº**ã€‚
2. **é‡‘èžæ”¯ä»˜ç³»ç»Ÿ**
   - **å¾®æœåŠ¡æž¶æž„**å¯å°†æ”¯ä»˜ç³»ç»Ÿæ‹†åˆ†ä¸ºå¤šä¸ªæœåŠ¡ï¼šç”¨æˆ·æœåŠ¡ã€æ”¯ä»˜æœåŠ¡ã€è®¢å•æœåŠ¡ç­‰ã€‚
   - **æœåŠ¡ç½‘æ ¼ï¼ˆå¦‚Istioï¼‰**å®žçŽ°å¾®æœåŠ¡çš„æµé‡æ²»ç†ã€ç†”æ–­ã€æµé‡é™æµå’Œåˆ†å¸ƒå¼è¿½è¸ªã€‚
3. **DevOpså¹³å°**
   - ä½¿ç”¨**Jenkins + Docker + Kubernetes**ï¼Œæž„å»ºCI/CDæµæ°´çº¿ï¼Œè‡ªåŠ¨åŒ–éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒã€‚
   - **GitOps**ä½¿ç”¨**ArgoCD**ï¼Œå°†ä»£ç æäº¤åˆ°GitåŽï¼Œè‡ªåŠ¨å®Œæˆéƒ¨ç½²ã€‚





## äº‘åŽŸç”Ÿçš„ä¼˜åŠ¿



| **ä¼˜åŠ¿**         | **æè¿°**                                       |
| ---------------- | ---------------------------------------------- |
| **æ•æ·æ€§**       | é€šè¿‡CI/CDæµæ°´çº¿å®žçŽ°å¿«é€Ÿçš„è¿­ä»£å‘å¸ƒ              |
| **å¼¹æ€§æ‰©å±•**     | åŠ¨æ€æ‰©ç¼©å®¹ï¼Œæµé‡é«˜å³°æœŸè‡ªåŠ¨æ‰©å±•ï¼Œä½Žå³°æœŸç¼©å®¹     |
| **é«˜å¯ç”¨æ€§**     | æ•…éšœèŠ‚ç‚¹è‡ªåŠ¨æ¢å¤ï¼Œé¿å…å®•æœº                     |
| **å¤šäº‘/æ··åˆäº‘**  | æ”¯æŒè·¨äº‘éƒ¨ç½²ï¼Œé¿å…å•ä¸€äº‘æœåŠ¡å•†çš„é”å®š           |
| **èµ„æºåˆ©ç”¨çŽ‡é«˜** | ä½¿ç”¨å®¹å™¨åŒ–å’ŒKubernetesçš„èµ„æºè°ƒåº¦å®žçŽ°èµ„æºæœ€ä¼˜åŒ– |



## äº‘åŽŸç”Ÿå®˜ç½‘

``````
https://www.cncf.io/
``````









# Docker



## è®¤è¯†Docker

- åŸºäºŽLinuxå†…æ ¸çš„**Cgroup**ï¼Œ**Namespace**ï¼Œä»¥åŠ**Union FS**ç­‰æŠ€æœ¯ï¼Œå¯¹è¿›ç¨‹è¿›è¡Œå°è£…éš”ç¦»ï¼Œå±žäºŽæ“ä½œç³»ç»Ÿå±‚é¢çš„è™šæ‹ŸåŒ–æŠ€æœ¯ï¼Œç”±äºŽéš”ç¦»çš„è¿›ç¨‹ç‹¬ç«‹äºŽå®¿ä¸»å’Œå…¶ä»–çš„éš”ç¦»çš„è¿›ç¨‹ï¼Œå› æ­¤ä¹Ÿç§°å…¶ä¸ºå®¹å™¨



- æœ€åˆå®žçŽ°æ˜¯åŸºäºŽ**LXC**ï¼Œä»Ž0.7ä»¥åŽå¼€å§‹åŽ»é™¤LXC,ï¼Œè½¬è€Œä½¿ç”¨è‡ªè¡Œå¼€å‘çš„**Libcontainer**ï¼Œä»Ž1.11å¼€å§‹ï¼Œåˆ™è¿›ä¸€æ­¥æ¼”è¿›ä¸ºä½¿ç”¨**Runc**å’Œ**Containerd**ã€‚



- Dockeråœ¨å®¹å™¨çš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œäº†è¿›ä¸€æ­¥å°è£…ï¼Œä»Žæ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œäº’è”åˆ°è¿›ç¨‹éš”ç¦»ç­‰ç­‰ï¼Œæžå¤§çš„ç®€åŒ–äº†å®¹å™¨çš„åˆ›å»ºå’Œç»´æŠ¤ï¼Œä½¿å¾—DockeræŠ€æœ¯æ¯”è™šæ‹ŸæœºæŠ€æœ¯æ›´ä¸ºè½»ä¾¿ã€å¿«æ·ã€‚





### ä¸ºä»€ä¹ˆè¦ç”¨Docker



![image-20250103094450293](D:\git_repository\cyber_security_learning\markdown_img\image-20250103094450293.png)



- **æ›´é«˜æ•ˆåœ°åˆ©ç”¨ç³»ç»Ÿèµ„æº**

  ```ABAP
  ç›¸å¯¹äºŽè™šæ‹Ÿæœºè¿˜è¯´ï¼Œè™šæ‹Ÿæœºæ˜¯è¦è™šæ‹Ÿæ“ä½œç³»ç»Ÿï¼Œè€Œæ“ä½œç³»ç»Ÿæœ¬èº«æ˜¯æœ‰å¼€é”€çš„ï¼Œé€šå¸¸ä¸€å¼€æœºå‡ ç™¾Må†…å­˜å°±æ²¡äº†ã€‚
  å®¹å™¨æŠ€æœ¯åŸºäºŽLinux Kernelçš„Namespaceå’ŒCGroupæŠ€æœ¯ï¼Œå®ƒå…±äº«hostçš„Kernelï¼Œå®ƒä¸éœ€è¦é¢å¤–å ç”¨å¾ˆå¤šèµ„æºæ¥æ¨¡æ‹Ÿæ“ä½œç³»ç»Ÿ
  ä»Žæ•´ä½“æ¥çœ‹ï¼Œä¼ä¸šçš„æ‰€æœ‰èµ„æºæ˜¯ç»™åº”ç”¨ä½¿ç”¨çš„ï¼Œå®¹å™¨æœ€ç»ˆæ˜¯è·‘åº”ç”¨çš„ï¼Œæ‰€ä»¥å®ƒæ•´ä½“çš„èµ„æºåˆ©ç”¨çŽ‡æ˜¯é«˜çš„
  ```

  

- **æ›´å¿«é€Ÿçš„å¯åŠ¨é€Ÿåº¦**

  ```ABAP
  æ­£å› ä¸ºå®¹å™¨ä¸éœ€è¦æ¨¡æ‹Ÿä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œå› æ­¤å®ƒæ²¡æœ‰æ“ä½œç³»ç»Ÿçš„å¯åŠ¨æ—¶é—´ï¼Œå®ƒæ²¡æœ‰bootï¼Œæ‰€ä»¥å®ƒå¯åŠ¨æ›´å¿«
  ```

  

- **ä¸€è‡´çš„è¿è¡ŒçŽ¯å¢ƒ**

  ```ABAP
  åˆå› ä¸ºå®ƒæœ‰Namespaceè¿™ä¸ªæŠ€æœ¯ï¼Œæœ‰äº†OverlayFSè¿™ä¸ªæŠ€æœ¯ï¼Œä½¿å¾—è¿™ä¸ªå®¹å™¨å¯ä»¥æž„å»ºæˆé•œåƒï¼Œå¯ä»¥è¢«åˆ†å‘åˆ°ä¸åŒçŽ¯å¢ƒ
  å½“ä½ è¿è¡Œè¿™ä¸ªé•œåƒï¼Œæœ¬è´¨ä¸Šæ˜¯æŠŠè¿™ä¸ªé•œåƒé‡æ”¾äº†ä¸€éï¼Œæ‰€ä»¥åœ¨æµ‹è¯•çŽ¯å¢ƒèƒ½å¤Ÿè¿è¡Œçš„ç¨‹åºï¼Œåœ¨å…¶ä»–çŽ¯å¢ƒä¸€å®šä¹Ÿèƒ½è¿è¡Œ
  å› ä¸ºå®¹å™¨åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œé‡Œé¢æä¾›äº†ä¸€ä¸ªå®Œå…¨å°è£…æŽ‰ï¼Œè·Ÿå¤–é¢éš”ç¦»çš„çŽ¯å¢ƒï¼Œæ—¢ç„¶æ˜¯éš”ç¦»çŽ¯å¢ƒï¼Œå®ƒå°±ä»¿ä½›æ˜¯ä¸€ä¸ªç®±å­ï¼Œè¿™ä¸ªç®±å­åœ¨è¿™é‡Œæ‰“å¼€å’Œåˆ«çš„åœ°æ–¹æ‰“å¼€å®ƒé‡Œé¢çš„ä¸œè¥¿ä¸€å®šæ˜¯ä¸€æ ·çš„ï¼Œå®ƒè‡ªèº«èƒ½å¤Ÿæä¾›ä¸€è‡´çš„è¿è¡ŒçŽ¯å¢ƒ
  ```

  

- **æŒç»­äº¤ä»˜å’Œéƒ¨ç½²**

  ```ABAP
  æœ‰äº†ä¸€è‡´æ€§çš„è¿è¡ŒçŽ¯å¢ƒï¼Œå°±å¾ˆå®¹æ˜“è¿ç§»ã€‚è€Œæœ‰äº†ä¸€è‡´æ€§è¿è¡ŒçŽ¯å¢ƒçš„ç‰¹æ€§ï¼ŒæŒç»­äº¤ä»˜å’ŒæŒç»­éƒ¨ç½²å°±å¾ˆç®€å•äº†ã€‚æŒç»­éƒ¨ç½²æ— éžå°±æ˜¯å°†è¿™ä¸ªç›’å­åœ¨ä¸åŒçš„æˆ¿é—´æ‰“å¼€ä¸€éï¼Œè¿™å°±æ˜¯æŒç»­éƒ¨ç½²
  ```

  

- **æ›´è½»æ¾åœ°è¿ç§»**

- **æ›´è½»æ¾åœ°ç»´æŠ¤å’Œæ‰©å±•**





### Dockerä¸‰å¤§æŠ€æœ¯



- **NameSpace**
- **Cgroup**
- **OverlayFS**







### Dockerç»„ä»¶åŠå…¶å…³ç³»



#### Dockerç»„ä»¶

- **Docker Client**
- **Dockerd**
- **Containerd**
- **Containerd-shim**
- **Runc**





#### Dockerç»„ä»¶è¯¦è§£



##### Dockerd (Docker Daemon)

- è´Ÿè´£æŽ¥æ”¶å’Œè§£æžæ¥è‡ª Docker å®¢æˆ·ç«¯ï¼ˆ`docker` CLI æˆ– APIï¼‰çš„è¯·æ±‚
- æ˜¯ Docker çš„æ ¸å¿ƒå®ˆæŠ¤è¿›ç¨‹ï¼Œä¸»è¦è´Ÿè´£
  - å®¹å™¨ç”Ÿå‘½å‘¨æœŸç®¡ç†
  - ç½‘ç»œå’Œå­˜å‚¨çš„ç®¡ç†
  - ä¸Žå…¶ä»–ç»„ä»¶ï¼ˆå¦‚ `containerd`ï¼‰çš„é€šä¿¡



##### Containerd

- æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„å®¹å™¨è¿è¡Œæ—¶å®ˆæŠ¤è¿›ç¨‹ï¼Œç”¨äºŽç®¡ç†å®¹å™¨ç”Ÿå‘½å‘¨æœŸ
- æ”¶ `dockerd` çš„è¯·æ±‚åŽï¼Œè´Ÿè´£æ›´åº•å±‚çš„æ“ä½œï¼Œæ¯”å¦‚
  - æ‹‰å–å’Œç®¡ç†å®¹å™¨é•œåƒã€‚
  - åˆ›å»ºå’Œåˆ é™¤å®¹å™¨ã€‚
  - å¤„ç†å®¹å™¨çš„è¿è¡ŒçŠ¶æ€ã€‚
  - ä¸Ž `runc` äº¤äº’æ¥åˆ›å»ºå’Œç®¡ç†å®¹å™¨çš„å…·ä½“è¿è¡ŒçŽ¯å¢ƒã€‚



##### Containerd-shim

- **äº†è§£****`containerd-shim`**
  - **`containerd-shim` æ˜¯ `containerd` çš„ä¸€éƒ¨åˆ†**ï¼Œå®ƒç”± `containerd` åˆ›å»ºå’Œç®¡ç†ï¼Œç”¨äºŽå¤„ç†å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸåŠç›¸å…³æ“ä½œ

- **ä½œç”¨**

  - å®ƒ`containerd-shim` æ˜¯ `containerd` çš„ä¸€ä¸ªç‹¬ç«‹è¿›ç¨‹ï¼Œä¸ºæ¯ä¸ªè¿è¡Œçš„å®¹å™¨æä¾›éš”ç¦»å±‚
    - é€šè¿‡ `containerd-shim`ï¼Œæ¯ä¸ªå®¹å™¨éƒ½å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œæ— éœ€ä¾èµ– `dockerd`ã€‚

- **å¯åŠ¨ `containerd-shim`**

  - å½“ `containerd` æŽ¥æ”¶åˆ°åˆ›å»ºå®¹å™¨çš„è¯·æ±‚æ—¶ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„ `containerd-shim` è¿›ç¨‹ã€‚
  - æ¯ä¸ªå®¹å™¨éƒ½ä¼šå¯¹åº”ä¸€ä¸ªç‹¬ç«‹çš„ `containerd-shim`ã€‚

- **ä¸»è¦èŒè´£**

  - **ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**: é€šè¿‡ä¸Žè¿è¡Œæ—¶ï¼ˆå¦‚ `runc`ï¼‰äº¤äº’ï¼ŒæŽ§åˆ¶å®¹å™¨çš„åˆ›å»ºã€å¯åŠ¨ã€åœæ­¢ç­‰ã€‚
  - **æ ‡å‡†è¾“å…¥/è¾“å‡ºå¤„ç†**: å¤„ç†å®¹å™¨çš„ `stdin`ã€`stdout`ã€`stderr` ç®¡é“ã€‚
  - **ä¿¡å·è½¬å‘**: å°†ä¸»æœºçš„ä¿¡å·ï¼ˆå¦‚ `SIGTERM`ï¼‰è½¬å‘ç»™å®¹å™¨çš„ä¸»è¿›ç¨‹
  - **èµ„æºç›‘æŽ§**: é€šè¿‡ä¸Ž cgroup çš„äº¤äº’ï¼Œç›‘æŽ§å’Œé™åˆ¶å®¹å™¨çš„èµ„æºä½¿ç”¨

- **å…³äºŽç‹¬ç«‹è¿›ç¨‹çš„è§£è¯»**

  - å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç‹¬ç«‹äºŽ `containerd`ï¼š
    - å¦‚æžœ `containerd` å´©æºƒæˆ–é‡å¯ï¼Œå®¹å™¨ä¸ä¼šå—å½±å“ã€‚
    - é€šè¿‡ `containerd-shim`ï¼Œæ¯ä¸ªå®¹å™¨éƒ½æœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ç®¡ç†å®ƒã€‚
  - æä¾›æ›´ç»†ç²’åº¦çš„è¿›ç¨‹ç®¡ç†ï¼š
    - æ¯ä¸ªå®¹å™¨çš„ `containerd-shim` æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œç¡®ä¿å®¹å™¨è¿›ç¨‹éš”ç¦»ï¼Œä¸å—å…¶ä»–å®¹å™¨å½±å“ã€‚

- **ä¸Ž `runc` çš„å…³ç³»**:

  - `containerd-shim` æ˜¯ `containerd` ä¸Žè¿è¡Œæ—¶ï¼ˆå¦‚ `runc`ï¼‰ä¹‹é—´çš„**æ¡¥æ¢**ã€‚

  - å®ƒè°ƒç”¨ `runc` æ¥å®žé™…æ‰§è¡Œå®¹å™¨åˆ›å»ºã€è¿è¡Œã€æš‚åœç­‰æ“ä½œã€‚



##### runc

- æ˜¯ä¸€ä¸ªè½»é‡çº§å·¥å…·ï¼Œç”¨äºŽæŒ‰ç…§ OCIï¼ˆOpen Container Initiativeï¼‰æ ‡å‡†åˆ›å»ºå’Œè¿è¡Œå®¹å™¨
- ä¸»è¦èŒè´£ï¼š
  - ä½¿ç”¨ Linux å†…æ ¸çš„ **`namespace`** å’Œ **`cgroup`** åŠŸèƒ½éš”ç¦»å®¹å™¨ã€‚
  - æ‰§è¡Œå®¹å™¨è¿›ç¨‹çš„åˆå§‹åŒ–





#### å·¥ä½œæµç¨‹æ‹†è§£



**åˆ›å»ºå®¹å™¨**

1. **`docker` CLI**:

   - ç”¨æˆ·é€šè¿‡ `docker` CLI å‘èµ·å®¹å™¨åˆ›å»ºè¯·æ±‚ï¼ˆå¦‚ `docker run`ï¼‰ã€‚

   - CLI å°†è¯·æ±‚å‘é€åˆ° `dockerd`ã€‚

2. **`dockerd`**:

   - æŽ¥æ”¶è¯·æ±‚åŽï¼Œè§£æžç”¨æˆ·çš„éœ€æ±‚ï¼ˆå¦‚é•œåƒåã€èµ„æºé™åˆ¶ç­‰ï¼‰ã€‚

   - å°†è¯·æ±‚è½¬å‘ç»™ `containerd`ã€‚

3. **`containerd`**:

   - æ‹‰å–é•œåƒï¼ˆå¦‚æžœé•œåƒå°šæœªæœ¬åœ°å­˜åœ¨ï¼‰ã€‚

   - åˆ›å»ºå®¹å™¨ç›¸å…³çš„**å…ƒæ•°æ®**ã€‚

   - è°ƒç”¨ `runc` æ¥è®¾ç½®å®¹å™¨çš„è¿è¡ŒçŽ¯å¢ƒã€‚

3. **`runc`**:

   - ä½¿ç”¨ Linux çš„ **`namespace`** éš”ç¦»æ–‡ä»¶ç³»ç»Ÿã€è¿›ç¨‹ã€ç½‘ç»œç­‰èµ„æºã€‚

   - ä½¿ç”¨ **`cgroup`** æŽ§åˆ¶å®¹å™¨çš„ CPUã€å†…å­˜ã€ç£ç›˜ç­‰èµ„æºä½¿ç”¨ã€‚

   - å¯åŠ¨å®¹å™¨è¿›ç¨‹ã€‚

   

```ABAP
docker CLI --> dockerd --> containerd --> containerd-shim --> runc
```





### å®¹å™¨æ ‡å‡†



#### **Open Container Initiativeï¼ˆOCIï¼‰**

**Open Container Initiative (OCI)** æ˜¯ç”± **Linux Foundation** äºŽ 2015 å¹´åˆ›å»ºçš„ä¸€ä¸ªå¼€æ”¾æ²»ç†ç»“æž„ï¼Œæ—¨åœ¨ä¸ºå®¹å™¨æ ¼å¼å’Œè¿è¡Œæ—¶åˆ¶å®šå¼€æ”¾çš„è¡Œä¸šæ ‡å‡†ã€‚**OCI çš„ç›®æ ‡æ˜¯è§£å†³å®¹å™¨ç”Ÿæ€ç³»ç»Ÿä¸­å­˜åœ¨çš„å…¼å®¹æ€§å’Œå¯ç§»æ¤æ€§é—®é¢˜**ï¼ŒæŽ¨åŠ¨ä¸åŒå®¹å™¨å¹³å°ä¹‹é—´çš„äº’æ“ä½œæ€§ã€‚



**OCI æˆç«‹çš„èƒŒæ™¯**

åœ¨ OCI æˆç«‹ä¹‹å‰ï¼Œå®¹å™¨æŠ€æœ¯ç¼ºä¹ç»Ÿä¸€çš„æ ‡å‡†ï¼Œå…·ä½“è¡¨çŽ°ä¸ºï¼š

- å„å¤§å¹³å°ï¼ˆå¦‚ Dockerã€CoreOS rkt ç­‰ï¼‰ä½¿ç”¨ä¸åŒçš„é•œåƒæ ¼å¼å’Œè¿è¡Œæ—¶å®žçŽ°ï¼Œå¯¼è‡´å·¥å…·ä¹‹é—´æ— æ³•å…¼å®¹ã€‚

- å¼€å‘è€…åœ¨ä¸€ä¸ªå¹³å°ä¸Šæž„å»ºçš„å®¹å™¨ï¼Œå¯èƒ½æ— æ³•åœ¨å…¶ä»–å¹³å°æ— ç¼è¿è¡Œã€‚

ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼ŒDocker å°†å…¶ **å®¹å™¨è¿è¡Œæ—¶è§„èŒƒ**ï¼ˆlibcontainerï¼‰å’Œ **é•œåƒæ ¼å¼è§„èŒƒ** æçŒ®ç»™ OCIï¼Œæˆä¸ºè¯¥ç»„ç»‡çš„å¥ åŸºã€‚





#### OCI çš„æ ¸å¿ƒè§„èŒƒ



OCI ç›®å‰æœ‰ä¸‰ä¸ªä¸»è¦è§„èŒƒï¼š

1. **OCI è¿è¡Œæ—¶è§„èŒƒ (Runtime Specification)ï¼š**

   - å®šä¹‰æ–‡ä»¶ç³»ç»ŸåŒ…å¦‚ä½•è§£åŽ‹è‡³ç¡¬ç›˜
   - å®šä¹‰å®¹å™¨çš„è¿è¡Œæ–¹å¼ã€‚
   - æè¿°å®¹å™¨çš„é…ç½®æ–‡ä»¶æ ¼å¼å’Œç”Ÿå‘½å‘¨æœŸã€‚
   - æ¶‰åŠä½Žå±‚å®žçŽ°ç»†èŠ‚ï¼Œå¦‚ Linux çš„ namespacesï¼ˆå‘½åç©ºé—´ï¼‰ã€cgroupsï¼ˆæŽ§åˆ¶ç»„ï¼‰ã€æ–‡ä»¶ç³»ç»Ÿå’ŒæŒ‚è½½ç‚¹ã€‚
   - å®žçŽ°ï¼š
     - **runc** æ˜¯ OCI è¿è¡Œæ—¶è§„èŒƒçš„å‚è€ƒå®žçŽ°ï¼Œä¹Ÿæ˜¯è®¸å¤šå®¹å™¨å¼•æ“Žä½¿ç”¨çš„æ ¸å¿ƒç»„ä»¶ã€‚
     - Runcä¾æ‰˜äºŽNamespaceå’ŒCgroupæŠ€æœ¯ï¼ˆè¿™ä¸¤ä¸ªæŠ€æœ¯å’ŒDockeræ²¡æœ‰ä»»ä½•å…³ç³»ï¼‰

2. **OCI é•œåƒè§„èŒƒ (Image Specification)ï¼š**

   - æ ‡å‡†åŒ–å®¹å™¨é•œåƒçš„æ ¼å¼ã€‚
   - æè¿°é•œåƒçš„æ‰“åŒ…ã€åˆ†å‘å’Œåˆ†å±‚ç»“æž„ã€‚
   - ç¡®ä¿ä¸åŒå®¹å™¨å¼•æ“Žå’Œé•œåƒä»“åº“ä¹‹é—´çš„å…¼å®¹æ€§ã€‚
   - å®žçŽ°ï¼š
     - Dockerã€Podman å’Œ Buildah ç­‰å·¥å…·å‡éµå¾ª OCI é•œåƒè§„èŒƒã€‚

   ```ABAP
   Dockerçš„åˆ›ä¸¾ï¼šåŸºäºŽOverlayFSï¼ŒæŠŠä»¥å‰è™šæ‹Ÿæœºé•œåƒè¿™ç§æ•´ä¸ªäºŒè¿›åˆ¶åŒ…æ‰åœ¨ä¸€èµ·çš„æ¨¡å¼ï¼Œé€šè¿‡Dockerfileè¿™ç§åˆ†å±‚çš„æ–¹å¼ï¼Œä½¿å¾—å®¹å™¨å˜å¾—æ›´æœ‰è°ƒç†ï¼›å®¹å™¨é•œåƒåˆ†ä¸ºå¾ˆå¤šå±‚ï¼Œæ¯ä¸€å±‚åˆ†å‘çš„æ—¶å€™ï¼Œå¯ä»¥åŽ»å¹¶è¡Œåˆ†å‘ï¼Œè€Œä¸”æ¯ä¸€å±‚æœ‰è‡ªå·±çš„checksumï¼Œå½“checksumä¸€è‡´ï¼ˆä¹Ÿå°±æ˜¯æ²¡å‘ç”Ÿå˜åŒ–ï¼‰çš„æ—¶å€™ï¼Œå®ƒæ˜¯è®¤ç¼“å­˜çš„
   
   æ¯”å¦‚æœ‰ä¸€ä¸ª2Gçš„é•œåƒï¼Œåˆ†äº†10å±‚ï¼Œåªæœ‰æœ€ä¸Šé¢çš„å‡ Mæ˜¯ä½ çš„å¢žé‡ï¼ˆä¹Ÿå°±æ˜¯æ¯æ¬¡æ›´æ–°ç‰ˆæœ¬ï¼Œå˜æ›´åœ¨å‡ å…†ï¼‰ï¼Œå½“ä½ docker pullçš„æ—¶å€™ï¼Œå¦‚æžœæœ¬åœ°å·²ç»æœ‰è€ç‰ˆæœ¬çš„ï¼Œå½“ä½ Pullæ–°ç‰ˆæœ¬çš„æ—¶å€™ï¼Œä¼šç›´æŽ¥åˆ©ç”¨ç¼“å­˜ï¼Œè€ŒåªPullæ›´æ–°çš„å‡ å…†ã€‚
   
   é€šè¿‡ä¸Šè¿°æ–¹å¼ï¼Œå·§å¦™çš„è§£å†³äº†ä¸šç•Œä¸€ç›´å¤´ç—›çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯åº”ç”¨å¦‚ä½•åˆ†å‘çš„é—®é¢˜ï¼Œåœ¨æœ€å¤§ç¨‹åº¦ä¸Šåšåˆ°äº†å¤ç”¨
   å¤šä¸ªå®¹å™¨å¯ä»¥å…±äº«ç›¸åŒçš„é•œåƒå±‚ï¼Œè€Œä¸éœ€è¦ä¸ºæ¯ä¸ªå®¹å™¨å•ç‹¬å­˜å‚¨ä¸€ä»½é•œåƒ
   ```

   

3. **OCI åˆ†å‘è§„èŒƒ (Distribution Specification)ï¼š**

   - å®šä¹‰å®¹å™¨é•œåƒåŠå…¶å·¥ä»¶çš„åˆ†å‘æ–¹å¼ã€‚
   - æä¾›æ ‡å‡† API ç”¨äºŽé•œåƒçš„å‘çŽ°ã€æ‹‰å–å’ŒæŽ¨é€ã€‚
   - åŸºäºŽ Docker çš„ Registry HTTP API V2ã€‚





### Dockerå®‰è£…





### Dockeré…ç½®ä¼˜åŒ–





## Dockerå‘½ä»¤





## Dockeré•œåƒåˆ¶ä½œ





## å®¹å™¨æ•°æ®ç®¡ç†





## å®¹å™¨ç½‘ç»œç®¡ç†





## ä»“åº“ç®¡ç†





## Composeå•æœºç¼–æŽ’









# CICD













# Prometheus







# å¾®æœåŠ¡





# Kubernetes



## Kubernetsé€»è¾‘æž¶æž„

![alt text](images/image15.png)



## Kubernetesç»„ä»¶



### Kubernetesç»„ä»¶é—´å®‰å…¨é€šä¿¡

![alt text](images/image28.png)



**Kubernetesé›†ç¾¤ä¸­æœ‰ä¸‰å¥—CAæœºåˆ¶**

- **etcd-ca**        ETCDé›†ç¾¤å†…éƒ¨çš„TLSé€šä¿¡
- **kubernetes-ca**    Kubernetesé›†ç¾¤å†…éƒ¨èŠ‚ç‚¹é—´çš„åŒå‘TLSé€šä¿¡
- **front-proxy-ca**    Kubernetesé›†ç¾¤ä¸Žå¤–éƒ¨æ‰©å±•æœåŠ¡ç®€å•åŒå‘TLSé€šä¿¡





#### è¯¦è§£Kubernetes-ca



**ç”¨é€”**ï¼šKubernetes é›†ç¾¤å†…éƒ¨çš„åŒå‘ TLS é€šä¿¡



**ä½œç”¨å’Œåœºæ™¯**

- **kubernetes-ca** æ˜¯ Kubernetes é›†ç¾¤çš„**ä¸»CA**ï¼Œä¸º**é›†ç¾¤æ ¸å¿ƒç»„ä»¶çš„å†…éƒ¨åŒå‘é€šä¿¡**æä¾› TLS è¯ä¹¦ã€‚
- å®ƒç¡®ä¿**é›†ç¾¤ä¸­çš„å„ä¸ªæ ¸å¿ƒç»„ä»¶ä¹‹é—´çš„åŒå‘ TLS é€šä¿¡æ˜¯å®‰å…¨çš„**ã€‚
- ç»„ä»¶é€šè¿‡ **kubernetes-ca** ç­¾å‘çš„è¯ä¹¦æ¥**éªŒè¯å½¼æ­¤çš„èº«ä»½**ï¼Œå¹¶ä¸”**æ‰€æœ‰çš„é€šä¿¡å†…å®¹éƒ½ä¼šåŠ å¯†**ã€‚
- ä¸»è¦ç”¨äºŽ**Kubernetes æŽ§åˆ¶å¹³é¢ç»„ä»¶ã€å·¥ä½œèŠ‚ç‚¹å’Œå®¢æˆ·ç«¯**ä¹‹é—´çš„é€šä¿¡ã€‚



**ä¸»è¦å—æŽ§çš„ç»„ä»¶å’Œé€šä¿¡åœºæ™¯**

| **é€šä¿¡ç»„ä»¶1**      | **é€šä¿¡ç»„ä»¶2**               | **ä½¿ç”¨çš„è¯ä¹¦**        | **ä½¿ç”¨çš„CA**      |
| ------------------ | --------------------------- | --------------------- | ----------------- |
| **kube-apiserver** | **kubelet**                 | kubelet-client.crt    | **kubernetes-ca** |
| **kube-apiserver** | **kube-scheduler**          | scheduler-client.crt  | **kubernetes-ca** |
| **kube-apiserver** | **kube-controller-manager** | controller-client.crt | **kubernetes-ca** |
| **kube-apiserver** | **kubectlå®¢æˆ·ç«¯**           | kubectl.crt           | **kubernetes-ca** |
| **kube-apiserver** | **etcd**                    | etcd-client.crt       | **kubernetes-ca** |
| **kube-apiserver** | **service-account token**   | service-account.crt   | **kubernetes-ca** |
| **kubelet**        | **kube-apiserver**          | kubelet-server.crt    | **kubernetes-ca** |
| **kube-proxy**     | **kube-apiserver**          | kube-proxy-client.crt | **kubernetes-ca** |

> **ç¤ºä¾‹è§£é‡Šï¼š**

- **kube-apiserver å’Œ kubelet ä¹‹é—´çš„é€šä¿¡**ï¼š

  - kube-apiserver éœ€è¦ä½¿ç”¨å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆ`kubelet-client.crt`ï¼‰é€šè¿‡åŒå‘TLSé€šä¿¡è®¿é—®å·¥ä½œèŠ‚ç‚¹çš„ kubelet APIã€‚
  - kubelet ä¹Ÿä¼šä½¿ç”¨æœåŠ¡å™¨è¯ä¹¦ï¼ˆ`kubelet-server.crt`ï¼‰æ¥ç¡®è®¤è‡ªå·±çš„èº«ä»½ã€‚
  - è¿™äº›è¯ä¹¦éƒ½ç”± **kubernetes-ca** ç­¾å‘ã€‚

- **kubectl å’Œ kube-apiserver çš„é€šä¿¡**ï¼š

  - ç”¨æˆ·çš„ kubectl å‘½ä»¤è¡Œå·¥å…·é€šè¿‡ TLS è¿žæŽ¥åˆ° kube-apiserverï¼Œ**kubectl** ä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦ï¼ˆæˆ– KubeConfig æ–‡ä»¶ï¼‰ç”±**kubernetes-ca** ç­¾å‘ã€‚
  - è¿™ç¡®ä¿äº†**kubectl çš„ç”¨æˆ·èº«ä»½éªŒè¯**å’Œ**ä¸Ž API Server çš„é€šä¿¡åŠ å¯†**ã€‚

  

**å…¸åž‹è¯ä¹¦**

- **kubernetes-ca.crt**ï¼šæ ¹ CA è¯ä¹¦ï¼Œæ‰€æœ‰çš„å­è¯ä¹¦éƒ½ç”±å®ƒç­¾å‘ã€‚
- **kube-apiserver.crt**ï¼škube-apiserver çš„æœåŠ¡å™¨è¯ä¹¦ã€‚
- **kube-apiserver-key.pem**ï¼škube-apiserver è¯ä¹¦çš„ç§é’¥ã€‚
- **kubelet.crt** å’Œ **kubelet-key.pem**ï¼škubelet æœåŠ¡å™¨è¯ä¹¦å’Œç§é’¥ã€‚
- **kube-controller-manager.crt**ï¼šcontroller manager ä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚
- **kube-scheduler.crt**ï¼šscheduler ä½¿ç”¨çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚
- **kube-proxy.crt**ï¼škube-proxy ç»„ä»¶çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚



####  Front-proxy-ca

**ç”¨é€”ï¼š**ç”¨äºŽ Kubernetes çš„ API èšåˆå±‚çš„ TLS é€šä¿¡



**ä½œç”¨å’Œåœºæ™¯**

- **front-proxy-ca** æ˜¯ä¸ºäº†æ”¯æŒ**Kubernetesçš„APIèšåˆå±‚**ï¼Œç¡®ä¿èšåˆå±‚ç»„ä»¶ï¼ˆå¦‚`metrics-server`å’Œ`custom-apis`ï¼‰çš„é€šä¿¡å®‰å…¨ã€‚
- å®ƒçš„ä¸»è¦ç›®çš„æ˜¯**ä¸ºAPIä»£ç†å’Œæ‰©å±•APIæœåŠ¡å™¨ï¼ˆå¦‚Aggregator Serverï¼‰ä¹‹é—´çš„åŒå‘é€šä¿¡æä¾›TLSåŠ å¯†å’Œèº«ä»½éªŒè¯**ã€‚
- è¿™ä½¿å¾—å¤–éƒ¨çš„ API å¯ä»¥æ— ç¼åœ°é›†æˆåˆ°Kubernetes APIä¸­ã€‚

> **API èšåˆå±‚çš„åœºæ™¯ï¼š**

- **metrics-server** æ˜¯ä¸€ä¸ªå¸¸è§çš„ç¤ºä¾‹ã€‚
- ç”¨æˆ·è°ƒç”¨ `kubectl top nodes` å‘½ä»¤ï¼Œkube-apiserver éœ€è¦**è½¬å‘è¯·æ±‚åˆ°metrics-server**ã€‚
- è¿™æ—¶ï¼Œkube-apiserver ä¼šä½¿ç”¨**front-proxy-client.crt** ä¸Ž**metrics-server**é€šä¿¡ï¼Œç¡®ä¿æ•°æ®æ˜¯åŠ å¯†çš„ï¼Œå¹¶èƒ½**éªŒè¯metrics-serverçš„èº«ä»½**ã€‚





**ä¸»è¦å—æŽ§çš„ç»„ä»¶å’Œé€šä¿¡åœºæ™¯**

| **é€šä¿¡ç»„ä»¶1**      | **é€šä¿¡ç»„ä»¶2**          | **ä½¿ç”¨çš„è¯ä¹¦**         | **ä½¿ç”¨çš„CA**       |
| ------------------ | ---------------------- | ---------------------- | ------------------ |
| **kube-apiserver** | **APIèšåˆå±‚**          | front-proxy-client.crt | **front-proxy-ca** |
| **kube-apiserver** | **metrics-server**     | metrics-server.crt     | **front-proxy-ca** |
| **kube-apiserver** | **Custom API Service** | custom-api.crt         | **front-proxy-ca** |

> **ç¤ºä¾‹è§£é‡Šï¼š**

- **kube-apiserver å’Œ metrics-server çš„é€šä¿¡**ï¼š
  - kube-apiserver é€šè¿‡ TLS è¯·æ±‚ metrics-serverã€‚
  - metrics-server ä½¿ç”¨**front-proxy-ca** é¢å‘çš„è¯ä¹¦ï¼ˆå¦‚`metrics-server.crt`ï¼‰æ¥éªŒè¯è‡ªå·±çš„èº«ä»½ã€‚
  - **kube-apiserver ä¹Ÿä¼šä½¿ç”¨`front-proxy-client.crt` è¿›è¡Œè®¤è¯å’Œé€šä¿¡**ã€‚
- **kube-apiserver å’Œ Custom API Service çš„é€šä¿¡**ï¼š
  - ç”¨æˆ·å¯èƒ½ä¼šåœ¨é›†ç¾¤ä¸­éƒ¨ç½²ä¸€ä¸ª**è‡ªå®šä¹‰ API æ‰©å±•**ã€‚
  - è¿™æ—¶ï¼Œkube-apiserver ä½¿ç”¨**front-proxy-client.crt** è¿žæŽ¥åˆ°**Aggregator Server**ï¼Œå¹¶é€šè¿‡TLSé€šä¿¡ä¸Žæ‰©å±•APIæœåŠ¡é€šä¿¡ã€‚





**å…¸åž‹è¯ä¹¦**

- **front-proxy-ca.crt**ï¼šå‰ç«¯ä»£ç†CAçš„æ ¹è¯ä¹¦ã€‚
- **front-proxy-client.crt**ï¼škube-apiserver è¿žæŽ¥ API èšåˆå±‚ï¼ˆå¦‚ metrics-serverï¼‰çš„è¯ä¹¦ã€‚
- **front-proxy-client-key.pem**ï¼škube-apiserver ä½¿ç”¨çš„å‰ç«¯ä»£ç†çš„ç§é’¥ã€‚



#### APIèšåˆå™¨æ˜¯ä»€ä¹ˆï¼Ÿ

API èšåˆå™¨æ˜¯ **kube-apiserver çš„ä¸€ä¸ªé€»è¾‘ç»„ä»¶**ï¼Œå®ƒçš„ä¸»è¦èŒè´£æ˜¯ï¼š

- **å°†ç¬¬ä¸‰æ–¹ API æœåŠ¡å’Œ Kubernetes è‡ªèº«çš„ API è¿›è¡Œèšåˆ**ã€‚
- **ç»Ÿä¸€æš´éœ² API ç«¯ç‚¹**ï¼Œä½¿å®¢æˆ·ç«¯ï¼ˆä¾‹å¦‚ `kubectl`ï¼‰å¯ä»¥åƒæ“ä½œåŽŸç”Ÿèµ„æºï¼ˆå¦‚Podã€Serviceï¼‰ä¸€æ ·æ“ä½œè‡ªå®šä¹‰çš„ API èµ„æºã€‚
- é€šè¿‡ `kubectl get`ã€`kubectl describe` ç­‰å‘½ä»¤ç®¡ç†è¿™äº›**éžåŽŸç”Ÿèµ„æº**ã€‚
- **å°†å¤šä¸ª API æ‰©å±•çš„è·¯å¾„æŒ‚è½½åˆ° kube-apiserver** çš„ URL ç»“æž„ä¸­ï¼Œé€šå¸¸è·¯å¾„æ˜¯ `/apis/{API_GROUP}/{VERSION}/{RESOURCE}`ã€‚





**APIèšåˆå™¨çš„ä½ç½®å’Œä½œç”¨**

åœ¨ Kubernetes æž¶æž„ä¸­ï¼ŒAPI èšåˆå™¨æ˜¯**kube-apiserverçš„ä¸€éƒ¨åˆ†**ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒAPI èšåˆå™¨ä¸Ž kube-apiserver æ˜¯ä¸€ä½“çš„ã€‚

```lua
+------------------------------------------------------+
|                   kube-apiserver                     |
|                                                      |
|   +----------------+  +---------------------------+  |
|   | åŽŸç”Ÿ API èµ„æº  |  |   è‡ªå®šä¹‰ API èšåˆå±‚      |  |
|   | (pods, svc)    |  | (metrics-server, custom)  |  |
|   +----------------+  +---------------------------+  |
|                                                      |
+------------------------------------------------------+
                          |
                          |
         +------------------------------------+
         |           API èšåˆå™¨                |
         +------------------------------------+
                          |
                          |
         +----------------+      +------------------+
         | å¤–éƒ¨ API æœåŠ¡   |      | è‡ªå®šä¹‰APIæœåŠ¡    |
         +----------------+      +------------------+
```

------

**å…·ä½“çš„å·¥ä½œæµç¨‹**

1. **è¯·æ±‚çš„å‘èµ·**ï¼šå®¢æˆ·ç«¯ï¼ˆå¦‚ `kubectl top nodes`ï¼‰å‘èµ· API è¯·æ±‚ï¼Œè·¯å¾„ä¸º `/apis/metrics.k8s.io/v1beta1/nodes`ã€‚
2. **kube-apiserver è·¯ç”±**ï¼škube-apiserver è¯†åˆ«åˆ° `/apis/metrics.k8s.io/` æ˜¯**è‡ªå®šä¹‰APIè·¯å¾„**ï¼ŒäºŽæ˜¯å°†è¯·æ±‚è½¬å‘åˆ°**APIèšåˆå™¨**ã€‚
3. APIèšåˆå™¨å·¥ä½œï¼š
   - APIèšåˆå™¨é€šè¿‡**front-proxy-client.crt** è¯ä¹¦ä¸Ž**å¤–éƒ¨çš„æ‰©å±•APIæœåŠ¡å™¨**é€šä¿¡ã€‚
   - å°†è¯·æ±‚è½¬å‘åˆ°**æ‰©å±•APIæœåŠ¡**ï¼Œå¦‚**metrics-server**ã€‚
4. æ•°æ®è¿”å›žï¼š
   - æ‰©å±• API æœåŠ¡ï¼ˆå¦‚ metrics-serverï¼‰å¤„ç†è¯·æ±‚ï¼Œå¹¶è¿”å›ž**ç›‘æŽ§æ•°æ®**ã€‚
   - API èšåˆå™¨å°†æ•°æ®è¿”å›žç»™ kube-apiserverï¼Œæœ€ç»ˆè¿”å›žç»™ `kubectl`ã€‚





## Kubernetes ç‰ˆæœ¬

**é€šå¸¸æ¯å¹´æ›´æ–°å››ä¸ªå¤§ç‰ˆæœ¬,ä»Žv1.22åŽå·²ç»ä¿®æ”¹ä¸ºæ¯å¹´å‘å¸ƒ3ä¸ªå¤§ç‰ˆæœ¬** 

Kubernetes çš„ç‰ˆæœ¬ä»¥ X.Y.Z æ¨¡å¼å‘½åï¼Œå…¶ä¸­ X æ˜¯ä¸»ç‰ˆæœ¬å·ï¼ŒY æ˜¯å°ç‰ˆæœ¬å·ï¼ŒZ æ˜¯è¡¥ä¸ç‰ˆæœ¬å·ã€‚

 Kubernetes ä¸€æ¬¡æ”¯æŒä¸‰ä¸ªå°ç‰ˆæœ¬ï¼Œä¹Ÿå°±æ˜¯åªæ”¯æŒåŒ…å«å½“å‰çš„å‘å¸ƒç‰ˆæœ¬å’Œä¸¤ä¸ªä¹‹å‰çš„ç‰ˆæœ¬ã€‚ 

å‚é˜… GitHub ä¸Šçš„  Kubernetes Release é¡µé¢ä»¥èŽ·å–æœ€æ–°çš„å‘å¸ƒä¿¡æ¯ã€‚





## Kubernetesæ‰©å±•æŽ¥å£
![alt text](images/image16.png)



Kubernetesæä¾›äº†ä¸‰ä¸ªç‰¹å®šåŠŸèƒ½çš„æŽ¥å£,kubernetesé€šè¿‡è°ƒç”¨è¿™å‡ ä¸ªæŽ¥å£ï¼Œæ¥å®Œæˆç›¸åº”çš„åŠŸèƒ½ã€‚

- **å®¹å™¨è¿è¡Œæ—¶æŽ¥å£CRI**: Container Runtime Interface 

  - CRI é¦–æ¬¡å‘å¸ƒäºŽ2016å¹´12æœˆçš„Kubernetes 1.5 ç‰ˆæœ¬ã€‚ 

  - åœ¨æ­¤ç‰ˆæœ¬ä¹‹å‰ï¼ŒKubernetes ç›´æŽ¥ä¸Ž Docker é€šä¿¡ï¼Œæ²¡æœ‰æ ‡å‡†åŒ–çš„æŽ¥å£ã€‚ 

  - ä»Ž Kubernetes 1.5 å¼€å§‹ï¼ŒCRI æˆä¸º Kubernetes ä¸Žå®¹å™¨è¿è¡Œæ—¶äº¤äº’çš„æ ‡å‡†æŽ¥å£ï¼Œä½¿å¾— Kubernetes  å¯ä»¥ä¸Žå„ç§å®¹å™¨è¿è¡Œæ—¶è¿›è¡Œé€šä¿¡ï¼Œä»Žè€Œå¢žåŠ äº†çµæ´»æ€§å’Œå¯ç§»æ¤æ€§ã€‚

  - kubernetes å¯¹äºŽå®¹å™¨çš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯é¢„ç•™äº†å®¹å™¨æŽ¥å£ï¼Œåªè¦ç¬¦åˆCRIæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥ä½¿ç”¨

![alt text](images/image17.png)
![alt text](images/image18.png)



#### æ‰©å±•ï¼šdockershim æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆå®ƒä¼šæ¶ˆå¤±

``````
åœ¨ Kubernetes çš„æ—©æœŸï¼Œæˆ‘ä»¬åªæ”¯æŒä¸€ä¸ªå®¹å™¨è¿è¡Œæ—¶ã€‚é‚£ä¸ªè¿è¡Œæ—¶æ˜¯ Docker Engineã€‚å½“æ—¶ï¼Œæ²¡æœ‰å¤ªå¤šå…¶ä»–é€‰æ‹©ï¼ŒDocker æ˜¯å¤„ç†å®¹å™¨çš„ä¸»è¦å·¥å…·ï¼Œæ‰€ä»¥è¿™ä¸æ˜¯ä¸ªæœ‰äº‰è®®çš„é€‰æ‹©ã€‚æœ€ç»ˆï¼Œæˆ‘ä»¬å¼€å§‹æ·»åŠ æ›´å¤šçš„å®¹å™¨è¿è¡Œæ—¶ï¼Œæ¯”å¦‚ rkt å’Œ hypernetesï¼Œå¾ˆæ˜Žæ˜¾ Kubernetes ç”¨æˆ·å¸Œæœ›é€‰æ‹©æœ€é€‚åˆä»–ä»¬çš„è¿è¡Œæ—¶ã€‚å› æ­¤ Kubernetes éœ€è¦ç§æ–¹æ³•ï¼Œæ¥å…è®¸é›†ç¾¤æ“ä½œè€…çµæ´»åœ°ä½¿ç”¨ä»–ä»¬é€‰æ‹©çš„ä»»ä½•è¿è¡Œæ—¶ã€‚

å‘å¸ƒCRI[1]ï¼ˆContainer Runtime Interfaceï¼Œå®¹å™¨è¿è¡Œæ—¶æŽ¥å£ï¼‰å°±æ˜¯ä¸ºäº†æä¾›è¿™ç§çµæ´»æ€§ã€‚CRI çš„å¼•å…¥å¯¹é¡¹ç›®å’Œç”¨æˆ·æ¥è¯´éƒ½å¾ˆæ£’ï¼Œä½†å®ƒä¹Ÿå¼•å…¥äº†ä¸€ä¸ªé—®é¢˜ï¼šDocker Engine ä½œä¸ºå®¹å™¨è¿è¡Œæ—¶çš„ä½¿ç”¨æ—©äºŽ CRIï¼ŒDocker Engine ä¸Ž CRI ä¸å…¼å®¹ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¼•å…¥äº†ä¸€ä¸ªå°è½¯ä»¶åž«ç‰‡ï¼ˆ"shim"ï¼Œdockershimï¼‰ä½œä¸º kubelet ç»„ä»¶çš„ä¸€éƒ¨åˆ†ï¼Œä¸“é—¨ç”¨äºŽå¡«è¡¥ Docker Engine å’Œ CRI ä¹‹é—´çš„ç©ºç™½ï¼Œå…è®¸é›†ç¾¤è¿è¥å•†ç»§ç»­ä½¿ç”¨ Docker Engine ä½œä¸ºä»–ä»¬çš„å®¹å™¨è¿è¡Œæ—¶ï¼ŒåŸºæœ¬ä¸Šä¸ä¼šç»™ä¸­æ–­ã€‚

ç„¶è€Œï¼Œè¿™ä¸ªå°å°çš„è½¯ä»¶åž«ç‰‡ä»Žæ¥å°±ä¸æ˜¯æ°¸ä¹…çš„è§£å†³æ–¹æ¡ˆã€‚å¤šå¹´æ¥ï¼Œå®ƒçš„å­˜åœ¨ç»™ kubelet æœ¬èº«å¸¦æ¥äº†è®¸å¤šä¸å¿…è¦çš„å¤æ‚æ€§ã€‚ç”±äºŽè¿™ä¸ªåž«ç‰‡ï¼ŒDocker çš„ä¸€äº›é›†æˆå®žçŽ°ä¸ä¸€è‡´ï¼Œå¯¼è‡´ç»´æŠ¤äººå‘˜çš„è´Ÿæ‹…å¢žåŠ ï¼Œå¹¶ä¸”ç»´æŠ¤ç‰¹å®šäºŽä¾›åº”å•†çš„ä»£ç ä¸ç¬¦åˆæˆ‘ä»¬çš„å¼€æºç†å¿µã€‚ä¸ºäº†å‡å°‘è¿™ç§ç»´æŠ¤è´Ÿæ‹…ï¼Œå¹¶å‘ä¸€ä¸ªæ”¯æŒå¼€æ”¾æ ‡å‡†çš„æ›´å…·åä½œæ€§çš„ç¤¾åŒºå‘å±•ï¼ŒKEP-2221 èŽ·å¼•å…¥[2]ï¼Œå®ƒå»ºè®®åŽ»æŽ‰ dockershimã€‚éšç€ Kubernetes v1.20 çš„å‘å¸ƒï¼Œè¿™ä¸€å¼ƒç”¨æˆä¸º
æ­£å¼ã€‚

æˆ‘ä»¬æ²¡æœ‰å¾ˆå¥½åœ°ä¼ è¾¾è¿™ä¸€ç‚¹ï¼Œä¸å¹¸çš„æ˜¯ï¼Œå¼ƒç”¨å£°æ˜Žå¯¼è‡´äº†ç¤¾åŒºå†…çš„ä¸€äº›ææ…Œã€‚å¯¹äºŽ Docker ä½œä¸ºä¸€å®¶å…¬å¸æ¥è¯´è¿™æ„å‘³ç€ä»€ä¹ˆï¼Œç”± Docker æž„å»ºçš„å®¹å™¨é•œåƒèƒ½å¦è¿è¡Œï¼Œä»¥åŠ Docker Engine å®žé™…æ˜¯ä»€ä¹ˆå¯¼è‡´äº†ç¤¾äº¤åª’ä½“ä¸Šçš„ä¸€åœºå¤§ç«ã€‚è¿™æ˜¯æˆ‘ä»¬çš„è¿‡å¤±ï¼›æˆ‘ä»¬åº”è¯¥æ›´æ¸…æ¥šåœ°æ²Ÿé€šå½“æ—¶å‘ç”Ÿäº†ä»€ä¹ˆä»¥åŠåŽŸå› ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å‘å¸ƒäº†ä¸€ä¸ªåšå®¢[3]å’Œç›¸å…³çš„å¸¸è§é—®é¢˜[4]ï¼Œä»¥å‡è½»ç¤¾åŒºçš„ææƒ§ï¼Œå¹¶çº æ­£ä¸€äº›å…³äºŽ Docker æ˜¯ä»€ä¹ˆï¼Œä»¥åŠå®¹
å™¨å¦‚ä½•åœ¨ Kubernetes ä¸­å·¥ä½œçš„è¯¯è§£ã€‚ç”±äºŽç¤¾åŒºçš„å…³æ³¨ï¼ŒDocker å’Œ Mirantis å…±åŒåŒæ„ä»¥cridocker[5]çš„å½¢å¼ç»§ç»­æ”¯æŒ dockershim ä»£ç ï¼Œå…è®¸ä½ åœ¨éœ€è¦æ—¶ç»§ç»­ä½¿ç”¨ Docker Engine ä½œä¸ºä½ çš„å®¹å™¨è¿è¡Œæ—¶ã€‚ä¸ºäº†è®©é‚£äº›æƒ³å°è¯•å…¶ä»–è¿è¡Œæ—¶ï¼ˆå¦‚ containerd æˆ– cri-oï¼‰çš„ç”¨æˆ·æ„Ÿå…´è¶£ï¼Œç¼–å†™äº†è¿ç§»æ–‡æ¡£[6]ã€‚

æˆ‘ä»¬åŽæ¥å¯¹ç¤¾åŒºè¿›è¡Œäº†è°ƒæŸ¥[7]ï¼Œå‘çŽ°ä»ç„¶æœ‰è®¸å¤šç”¨æˆ·æœ‰é—®é¢˜å’Œé¡¾è™‘[8]ã€‚ä½œä¸ºå›žåº”ï¼ŒKubernetes ç»´æŠ¤è€…å’ŒCNCF è‡´åŠ›äºŽé€šè¿‡æ‰©å±•æ–‡æ¡£å’Œå…¶ä»–ç¨‹åºæ¥è§£å†³è¿™äº›é—®é¢˜ã€‚äº‹å®žä¸Šï¼Œè¿™ç¯‡åšæ–‡å°±æ˜¯è¿™ä¸ªè®¡åˆ’çš„ä¸€éƒ¨åˆ†ã€‚éšç€å¦‚æ­¤å¤šçš„æœ€ç»ˆç”¨æˆ·æˆåŠŸåœ°è¿ç§»åˆ°å…¶ä»–è¿è¡Œæ—¶ï¼Œä»¥åŠæ–‡æ¡£çš„æ”¹è¿›ï¼Œæˆ‘ä»¬ç›¸ä¿¡çŽ°åœ¨æ¯ä¸ªäººéƒ½æœ‰äº†è¿ç§»çš„é“è·¯

æ— è®ºæ˜¯ä½œä¸ºå·¥å…·è¿˜æ˜¯ä½œä¸ºå…¬å¸ï¼ŒDocker éƒ½ä¸ä¼šæ¶ˆå¤±ã€‚å®ƒæ˜¯äº‘åŽŸç”Ÿç¤¾åŒºå’Œ Kubernetes é¡¹ç›®åŽ†å²çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚æ²¡æœ‰ä»–ä»¬æˆ‘ä»¬ä¸ä¼šæœ‰ä»Šå¤©ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä»Ž kubelet ä¸­ç§»é™¤ dockershim æœ€ç»ˆå¯¹ç¤¾åŒºã€ç”Ÿæ€ç³»ç»Ÿã€é¡¹ç›®å’Œæ•´ä¸ªå¼€æºéƒ½æœ‰å¥½å¤„ã€‚è¿™æ˜¯æˆ‘ä»¬æ‰€æœ‰äººä¸€èµ·æ”¯æŒå¼€æ”¾æ ‡å‡†çš„æœºä¼šï¼Œæˆ‘ä»¬å¾ˆé«˜å…´åœ¨ Docker å’Œç¤¾åŒºçš„å¸®åŠ©ä¸‹è¿™æ ·åšã€‚
``````



- æ–¹å¼1: Containerd 
  - é»˜è®¤æƒ…å†µä¸‹,Kubernetesåœ¨åˆ›å»ºé›†ç¾¤çš„æ—¶å€™,ä½¿ç”¨çš„å°±æ˜¯Containerd æ–¹å¼ã€‚ 
- æ–¹å¼2: Docker 
  - Docker Engine æ²¡æœ‰å®žçŽ° CRIï¼Œ è€Œè¿™æ˜¯å®¹å™¨è¿è¡Œæ—¶åœ¨ Kubernetes ä¸­å·¥ä½œæ‰€éœ€è¦çš„ã€‚  å› æ­¤å¿…é¡»å®‰è£…ä¸€ä¸ªé¢å¤–çš„æœåŠ¡,æ—©æœŸä½¿ç”¨ç”±k8sæä¾›çš„dockershim,ä½†å®ƒåœ¨ 1.24 ç‰ˆæœ¬ä»Ž kubelet ä¸­è¢« ç§»é™¤ è¿˜å¯ä»¥å€ŸåŠ©äºŽMirantisç»´æŠ¤çš„cri-dockerdæ’ä»¶æ–¹å¼æ¥å®žçŽ°Kubernetesé›†ç¾¤çš„åˆ›å»ºã€‚ cri-dockerd é¡¹ç›®ç«™ç‚¹:  https://github.com/Mirantis/cri-dockerd 
- æ–¹å¼3: CRI-O 
  - 2016å¹´æˆç«‹,2019å¹´4æœˆ8å·åŠ å…¥CNCFå­µåŒ–ã€‚ CRI-Oçš„æ–¹å¼æ˜¯Kubernetesåˆ›å»ºå®¹å™¨æœ€ç›´æŽ¥çš„ä¸€ç§æ–¹å¼ åœ¨åˆ›å»ºé›†ç¾¤çš„æ—¶å€™,éœ€è¦å€ŸåŠ©äºŽcri-oæ’ä»¶çš„æ–¹å¼æ¥å®žçŽ°Kubernetesé›†ç¾¤çš„åˆ›å»ºã€‚

![alt text](images/image19.png)
![alt text](images/image20.png)


- **å®¹å™¨ç½‘ç»œæŽ¥å£CN**I: Container Network Interface
  - kubernetes å¯¹äºŽç½‘ç»œçš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯é¢„ç•™äº†ç½‘ç»œæŽ¥å£ï¼Œåªè¦ç¬¦åˆCNIæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥ä½¿ç”¨
- **å®¹å™¨å­˜å‚¨æŽ¥å£CSI:** Container Storage Interface
  - kubernetes å¯¹äºŽå­˜å‚¨çš„è§£å†³æ–¹æ¡ˆï¼Œåªæ˜¯é¢„ç•™äº†å­˜å‚¨æŽ¥å£ï¼Œåªè¦ç¬¦åˆCSIæ ‡å‡†çš„è§£å†³æ–¹æ¡ˆéƒ½å¯ä»¥ä½¿ç”¨ æ­¤æŽ¥å£éžå¿…é¡»





## Kubernetesé›†ç¾¤éƒ¨ç½²



### Kubernetes é›†ç¾¤ç»„ä»¶è¿è¡Œæ¨¡å¼

#### **ç‹¬ç«‹ç»„ä»¶æ¨¡å¼** 

- å„å…³é”®ç»„ä»¶éƒ½ä»¥äºŒè¿›åˆ¶æ–¹å¼éƒ¨ç½²äºŽä¸»æœºèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä»¥å®ˆæŠ¤è¿›ç¨‹å½¢å¼è¿è¡Œ 
- å„é™„ä»¶Add-ons åˆ™ä»¥Podå½¢å¼è¿è¡Œ 
- éœ€è¦å®žçŽ°å„ç§è¯ä¹¦çš„ç”³è¯·é¢å‘
-  éƒ¨ç½²è¿‡ç¨‹ç¹çå¤æ‚

![alt text](images/image21.png)



#### **é™æ€Podæ¨¡å¼**

- **kubeletå’Œå®¹å™¨è¿è¡Œæ—¶dockerä»¥äºŒè¿›åˆ¶éƒ¨ç½²ï¼Œè¿è¡Œä¸ºå®ˆæŠ¤è¿›ç¨‹**
- é™¤æ­¤ä¹‹å¤–æ‰€æœ‰ç»„ä»¶ä¸ºPod æ–¹å¼è¿è¡Œ

- æŽ§åˆ¶å¹³å°å„ç»„ä»¶ä»¥é™æ€Podå¯¹è±¡è¿è¡ŒäºŽMasterä¸»æœºä¹‹ä¸Š
- é™æ€Podç”±kubeletæ‰€æŽ§åˆ¶å®žçŽ°åˆ›å»ºç®¡ç†,è€Œæ— éœ€ä¾èµ–kube-apiserverç­‰æŽ§åˆ¶å¹³å°ç»„ä»¶
- kube-proxyç­‰åˆ™ä»¥Podå½¢å¼è¿è¡Œ
- ç›¸å…³podæ—©æœŸæ˜¯ä»Žä»“åº“k8s.gcr.ioä¸‹è½½é•œåƒï¼Œæ–°ç‰ˆæ”¹ä¸ºä»“åº“registry.k8s.io
- ä½¿ç”¨kuberneteså®˜æ–¹æä¾›çš„kubeadmå·¥å…·å®žçŽ°kubernetesé›†ç¾¤æ–¹ä¾¿å¿«é€Ÿçš„éƒ¨ç½²

![alt text](images/image22.png)



### åŸºäºŽKubeadmå’Œ Docker éƒ¨ç½² kubernetes é«˜å¯ç”¨é›†ç¾¤


![alt text](images/image23.png)


å‚è€ƒæ–‡æ¡£ï¼š

``````
https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/ https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/
https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/
https://github.com/kubernetes/kubeadm/blob/master/docs/design/design_v1.10.md
``````



kubeadmæ˜¯Kubernetesç¤¾åŒºæä¾›çš„é›†ç¾¤æž„å»ºå·¥å…·

- è´Ÿè´£æ‰§è¡Œæž„å»ºä¸€ä¸ªæœ€å°åŒ–å¯ç”¨é›†ç¾¤å¹¶å°†å…¶å¯åŠ¨ç­‰å¿…è¦çš„åŸºæœ¬æ­¥éª¤
- Kubernetesé›†ç¾¤å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†å·¥å…·ï¼Œå¯ç”¨äºŽå®žçŽ°é›†ç¾¤çš„éƒ¨ç½²ã€å‡çº§/é™çº§åŠå¸è½½ç­‰
- kubeadmä»…å…³å¿ƒå¦‚ä½•åˆå§‹åŒ–å¹¶æ‹‰èµ·ä¸€ä¸ªé›†ç¾¤ï¼Œå…¶èŒè´£ä»…é™äºŽä¸‹å›¾ä¸­èƒŒæ™¯è“è‰²çš„éƒ¨åˆ†
- è“è‰²çš„éƒ¨åˆ†ä»¥å¤–çš„å…¶å®ƒç»„ä»¶è¿˜éœ€è¦è‡ªè¡Œéƒ¨ç½² 

![alt text](images/image24.png)

æ³¨æ„ï¼šåœ¨kubeadmæ–¹å¼å®‰è£…æ—¶ï¼ŒKubernetes çš„æ‰€æœ‰ç»„ä»¶ä¸­é™¤kubelet æ˜¯ä»¥ä¼ ç»ŸæœåŠ¡è¿›ç¨‹çš„æ–¹å¼è¿è¡Œï¼Œå…¶å®ƒéƒ½ä»¥å®¹å™¨è¿è¡Œ



#### éƒ¨ç½²çŽ¯å¢ƒè¯´æ˜Ž

![alt text](images/image25.png)



| IP         | ä¸»æœºå           | è§’è‰²                                      |
| ---------- | ---------------- | ----------------------------------------- |
| 10.0.0.101 | master1.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 1ï¼ŒMasterå’Œetcd            |
| 10.0.0.102 | master2.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 2ï¼ŒMasterå’Œetcd            |
| 10.0.0.103 | master3.wang.org | K8s é›†ç¾¤ä¸»èŠ‚ç‚¹ 3ï¼ŒMasterå’Œetcd            |
| 10.0.0.104 | node1.wang.org   | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 1                        |
| 10.0.0.105 | node2.wang.org   | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 2                        |
| 10.0.0.106 | node3.wang.org   | K8s é›†ç¾¤å·¥ä½œèŠ‚ç‚¹ 3                        |
| 10.0.0.107 | ha1.wang.org     | K8s ä¸»èŠ‚ç‚¹è®¿é—®å…¥å£ 1,æä¾›é«˜å¯ç”¨åŠè´Ÿè½½å‡è¡¡ |
| 10.0.0.108 | ha2.wang.org     | K8s ä¸»èŠ‚ç‚¹è®¿é—®å…¥å£ 2,æä¾›é«˜å¯ç”¨åŠè´Ÿè½½å‡è¡¡ |
| 10.0.0.109 | harbor.wang.org  | å®¹å™¨é•œåƒä»“åº“                              |
| 10.0.0.100 | kubeapi.wang.org | VIPï¼Œåœ¨ha1å’Œha2ä¸»æœºå®žçŽ°                   |

æ³¨æ„ï¼š MasterèŠ‚ç‚¹å†…å­˜è‡³å°‘2Gä»¥ä¸Šï¼Œå¦åˆ™åœ¨åˆå§‹åŒ–æ—¶ä¼šå‡ºé”™



#### ç½‘ç»œåœ°å€è§„åˆ’

``````bash
ç‰©ç†ä¸»æœºç½‘ç»œ        10.0.0.0/24 
é›†ç¾¤podç½‘ç»œ        --pod-network-cidr=10.244.0.0/16
åº”ç”¨serviceç½‘ç»œ    --service-cidr=10.96.0.0/12 
``````

![alt text](images/image26.png)



#### åŸºäºŽ kubeadm å’Œ Docker å®žçŽ°Kuberenetesé›†ç¾¤æµç¨‹è¯´æ˜Ž

- æ¯ä¸ªèŠ‚ç‚¹ä¸»æœºçš„åˆå§‹çŽ¯å¢ƒå‡†å¤‡
- å‡†å¤‡ä»£ç†æœåŠ¡,ä»¥ä¾¿è®¿é—®k8s.gcr.ioï¼Œæˆ–æ ¹æ®éƒ¨ç½²è¿‡ç¨‹æç¤ºçš„æ–¹æ³•èŽ·å–ç›¸åº”çš„Iå›½å†…é•œåƒçš„imageï¼ˆå¯é€‰ï¼‰
- Kubernetesé›†ç¾¤APIè®¿é—®å…¥å£çš„é«˜å¯ç”¨å’Œharborï¼ˆå¯é€‰ï¼‰
- **åœ¨æ‰€æœ‰Masterå’ŒNodeèŠ‚ç‚¹éƒ½å®‰è£…å®¹å™¨è¿è¡Œæ—¶ Docker**
- **åœ¨æ‰€æœ‰èŠ‚ç‚¹å®‰è£…å’Œé…ç½® cri-dockerd(kubernetes-v1.24ç‰ˆæœ¬ä»¥åŽéœ€è¦)**
- **åœ¨æ‰€æœ‰Masterå’ŒNodeèŠ‚ç‚¹éƒ½å®‰è£…kubeadm ã€kubeletã€kubectl(é›†ç¾¤ç®¡ç†å·¥å…·,åœ¨nodeèŠ‚ç‚¹å¯ ä¸å®‰è£…)**
- **åœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹è¿è¡Œ kubeadm init åˆå§‹åŒ–å‘½ä»¤ ,å¹¶éªŒè¯ master èŠ‚ç‚¹çŠ¶æ€**
- **åœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹å®‰è£…é…ç½®CNIè§„èŒƒçš„ç½‘ç»œæ’ä»¶**
- åœ¨å…¶å®ƒmasterèŠ‚ç‚¹è¿è¡Œkubeadm join å‘½ä»¤åŠ å…¥åˆ°æŽ§åˆ¶å¹³é¢é›†ç¾¤ä¸­å®žçŽ°é«˜å¯ç”¨(æµ‹è¯•çŽ¯å¢ƒå¯é€‰)
- **åœ¨æ‰€æœ‰ node èŠ‚ç‚¹ä½¿ç”¨ kubeadm join å‘½ä»¤åŠ å…¥é›†ç¾¤ , å¹¶éªŒè¯ node èŠ‚ç‚¹çŠ¶æ€**
- åˆ›å»º pod å¹¶å¯åŠ¨å®¹å™¨æµ‹è¯•è®¿é—® ï¼Œå¹¶æµ‹è¯•ç½‘ç»œé€šä¿¡



#### åˆå§‹çŽ¯å¢ƒå‡†å¤‡

- ç¡¬ä»¶å‡†å¤‡çŽ¯å¢ƒ: æ¯ä¸ªä¸»æœºè‡³å°‘2Gä»¥ä¸Šå†…å­˜,CPU2æ ¸ä»¥ä¸Š
- æ“ä½œç³»ç»Ÿ: æœ€å°åŒ–å®‰è£…æ”¯æŒKubernetesçš„Linuxç³»ç»Ÿ
- å”¯ä¸€çš„ä¸»æœºåï¼ŒMACåœ°å€ä»¥åŠproduct_uuidå’Œä¸»æœºåè§£æž
- ä¿è¯å„ä¸ªèŠ‚ç‚¹ç½‘ç»œé…ç½®æ­£ç¡®,å¹¶ä¸”ä¿è¯é€šä¿¡æ­£å¸¸
- ç¦ç”¨ swap 
- ç¦ç”¨ SELinux
- æ”¾è¡ŒKubernetesä½¿ç”¨åˆ°çš„ç›¸å…³ç«¯å£æˆ–ç¦ç”¨firewalld/iptables
- é…ç½®æ­£ç¡®çš„æ—¶åŒºå’Œæ—¶é—´åŒæ­¥
- å†…æ ¸å‚æ•°ä¼˜åŒ– 
- æ‰€æœ‰èŠ‚ç‚¹å®žçŽ°åŸºäºŽ ssh key éªŒè¯(å¯é€‰)



**æ£€æŸ¥æ¯å°æœºå™¨çš„product_uuidï¼Œproject_uuidè¦å…·å¤‡å”¯ä¸€æ€§**

``````bash
[root@ubuntu2204 ~]#cat /sys/class/dmi/id/product_uuid
e0c84d56-f33b-6754-eab2-d5e7cb846dc1
 
[root@rocky8 ~]#cat /sys/class/dmi/id/product_uuid
10324d56-9c12-c716-dfa1-196e5242b4d3
``````





**æ¯å¤©æœºå™¨ä¸Šè®¾ç½®hostname,å¹¶é…ç½®/etc/hosts**

``````
# cat >> /etc/hosts <<EOF
10.0.0.100 kubeapi kubeapi.wang.org 
10.0.0.101 master1 master1.wang.org
10.0.0.102 master2 master2.wang.org
10.0.0.103 master3 master3.wang.org
10.0.0.104 node1 node1.wang.org
10.0.0.105 node2 node2.wang.org
10.0.0.106 node3 node3.wang.org
10.0.0.107 ha1 ha1.wang.org
10.0.0.108 ha2 ha2.wang.org
10.0.0.109 harbor harbor.wang.org
EOF
``````



**ä½¿ç”¨sshæ‰“é€šæ¯å°æœºå™¨**

``````bash
ssh-keygen

ssh-copy-id 127.0.0.1

for i in {101..108}; do scp -r .ssh 10.0.0.$i:/root/; done
``````



**è®¾ç½®æ¯å°ä¸»æœºçš„ä¸»æœºå**

``````bash
for i in {1..3} ;do ssh 10.0.0.10$i hostnamectl set-hostname master$i;done
for i in {4..6} ;do ssh 10.0.0.10$i hostnamectl set-hostname node$(($i-3));done
ssh 10.0.0.107 hostnamectl set-hostname ha1
ssh 10.0.0.108 hostnamectl set-hostname ha2

``````



**å®žçŽ°ä¸»æœºæ—¶é—´åŒæ­¥**

``````bash
timedatectl set-timezone Asia/Shanghai

apt update
apt install  chrony -y

vim /etc/chrony/chrony.conf
 #åŠ ä¸‹é¢ä¸€è¡Œ
pool ntp.aliyun.com        iburst maxsources 2
pool ntp.ubuntu.com        iburst maxsources 4
pool 0.ubuntu.pool.ntp.org iburst maxsources 1
pool 1.ubuntu.pool.ntp.org iburst maxsources 1
pool 2.ubuntu.pool.ntp.org iburst maxsources 2

systemctl enable chrony
systemctl restart chrony
``````



 **å…³é—­SELinux**

``````bash
 ~# setenforce 0
 ~# sed -i 's#^\(SELINUX=\).*#\1disabled#' /etc/sysconfig/selinux
``````



**å…³é—­é˜²ç«å¢™**

``````bash
# Rocky
systemctl disable --now firewalld 

# Ubuntu
systemctl disable --now ufw
``````



 **ç¦ç”¨ Swap è®¾å¤‡**

``````bash
#æ–¹æ³•1
~# swapoff -a
~# sed -i  '/swap/s/^/#/' /etc/fstab
~# for i in {101..106};do ssh 10.0.0.$i "sed -i  '/swap/s/^/#/' /etc/fstab"; ssh 10.0.0.$i swapoff -a ; done

#æ–¹æ³•2
~# systemctl stop  swap.img.swap
~# systemctl mask swap.img.swap æˆ–è€… systemctl mask swap.target
 
#æ–¹æ³•3
~# systemctl mask swap.img.swap æˆ–è€… systemctl mask swap.target
~# reboot

#ç¡®è®¤æ˜¯å¦ç¦ç”¨swap
~# systemctl -t swap 
~# swapon -s 

``````



**å†…æ ¸ä¼˜åŒ–**  

æ ¹æ®ç¡¬ä»¶å’Œä¸šåŠ¡éœ€æ±‚,å¯¹å†…æ ¸å‚æ•°åšç›¸åº”çš„ä¼˜åŒ– 

æ³¨æ„:å®‰è£…dockeræ—¶ä¼šè‡ªåŠ¨ä¿®æ”¹å†…æ ¸å‚æ•°





#### å®žçŽ°é«˜å¯ç”¨çš„åå‘ä»£ç†



**å®žçŽ° keepalived**

åœ¨ä¸¤å°ä¸»æœºha1å’Œha2 æŒ‰ä¸‹é¢æ­¥éª¤éƒ¨ç½²å’Œé…ç½® keepalived

``````bash
[root@ha1 ~]#apt update && apt -y install keepalived 

#keepalivedé…ç½®
[root@ha1 ~]#cp  /usr/share/doc/keepalived/samples/keepalived.conf.vrrp /etc/keepalived/keepalived.conf

[root@ha1 ~]#vim /etc/keepalived/keepalived.conf

! Configuration File for keepalived
global_defs {
  notification_email {
    acassen
  }
  notification_email_from Alexandre.Cassen@firewall.loc
  smtp_server 192.168.200.1
  smtp_connect_timeout 30
  router_id ha1.wang.org  #æŒ‡å®šrouter_id,#åœ¨ha2ä¸Šä¸ºha2.wang.org
}
vrrp_script check_haproxy {
   script "/etc/keepalived/check_haproxy.sh"
   interval 1
   weight -30
   fall 3
   rise 2
   timeout 2
}
vrrp_instance VI_1 {
   state MASTER              #åœ¨ha2ä¸Šä¸ºBACKUP        
   interface eth0
   garp_master_delay 10
   smtp_alert
   virtual_router_id 66      #æŒ‡å®šè™šæ‹Ÿè·¯ç”±å™¨ID,ha1å’Œha2æ­¤å€¼å¿…é¡»ç›¸åŒ
   priority 100              #åœ¨ha2ä¸Šä¸º80          
   advert_int 1
   authentication {
       auth_type PASS
       auth_pass 123456      #æŒ‡å®šéªŒè¯å¯†ç ,ha1å’Œha2æ­¤å€¼å¿…é¡»ç›¸åŒ  
   }
   virtual_ipaddress {
       10.0.0.100/24 dev eth0  label eth0:1  #æŒ‡å®šVIP,ha1å’Œha2æ­¤å€¼å¿…é¡»ç›¸åŒ
   }
   track_script {
       check_haproxy 
   }
}
 [root@ha1 ~]#cat /etc/keepalived/check_haproxy.sh
 #!/bin/bash
 /usr/bin/killall -0 haproxy  || systemctl restart haproxy
 [root@ha1 ~]#chmod +x /etc/keepalived/check_haproxy.sh
 [root@ha1 ~]#hostname -I
 10.0.0.107 
[root@ha1 ~]#systemctl start keepalived.service 
#éªŒè¯keepalivedæœåŠ¡æ˜¯å¦æ­£å¸¸
``````





**å®žçŽ° Haproxy**

é€šè¿‡ Harproxy å®žçŽ° kubernetes Api-serverçš„å››å±‚åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡åŠŸèƒ½

``````bash
#åœ¨ä¸¤å°ä¸»æœºha1å’Œha2éƒ½æ‰§è¡Œä¸‹é¢æ“ä½œ
[root@ha1 ~]#cat >> /etc/sysctl.conf <<EOF
net.ipv4.ip_nonlocal_bind = 1
EOF
root@ha1 ~]#sysctl -p 

#å®‰è£…é…ç½®haproxy
[root@ha1 ~]#apt -y install haproxy
[root@ha1 ~]#vim /etc/haproxy/haproxy.cfg 
[root@ha1 ~]#cat /etc/haproxy/haproxy.cfg

global
	log /dev/log	local0
	log /dev/log	local1 notice
	chroot /var/lib/haproxy
	stats socket /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
	stats timeout 30s
	user haproxy
	group haproxy
	daemon

	# Default SSL material locations
	ca-base /etc/ssl/certs
	crt-base /etc/ssl/private

	# See: https://ssl-config.mozilla.org/#server=haproxy&server-version=2.0.3&config=intermediate
        ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
        ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
        ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

defaults
	log	global
	mode	http
	option	httplog
	option	dontlognull
        timeout connect 5000
        timeout client  50000
        timeout server  50000
	errorfile 400 /etc/haproxy/errors/400.http
	errorfile 403 /etc/haproxy/errors/403.http
	errorfile 408 /etc/haproxy/errors/408.http
	errorfile 500 /etc/haproxy/errors/500.http
	errorfile 502 /etc/haproxy/errors/502.http
	errorfile 503 /etc/haproxy/errors/503.http
	errorfile 504 /etc/haproxy/errors/504.http

##########æ·»åŠ ä»¥ä¸‹å†…å®¹######################

listen stats
    mode http
    bind 0.0.0.0:8888
    stats enable
    log global
    stats uri /status
    stats auth admin:123456

listen  kubernetes-api-6443
    bind 10.0.0.100:6443
    mode tcp 
    server master1 10.0.0.101:6443 check inter 3s fall 3 rise 3 
    server master2 10.0.0.102:6443 check inter 3s fall 3 rise 3 
    server master3 10.0.0.103:6443 check inter 3s fall 3 rise 3 
``````



æµè§ˆå™¨è®¿é—®ï¼š http://ha2.wang.org:8888/status ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢ç•Œé¢


![alt text](images/image27.png)



#### åœ¨masterå’Œworkerä¸Šå®‰è£…docker

``````bash
# master
wget https://www.mysticalrecluse.com/script/Shell/install_docker_offline.sh
bash install_docker_offline.sh
``````



####  æ‰€æœ‰ä¸»æœºå®‰è£… cri-dockerd(v1.24ä»¥åŽç‰ˆæœ¬)

```````bash
wget https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.14/cri-dockerd_0.3.14.3-0.ubuntu-jammy_amd64.deb

# å¦‚æžœå‡ºçŽ°ä¾èµ–é—®é¢˜ï¼Œä½¿ç”¨è¯¥å‘½ä»¤ä¿®å¤
apt --fix-broken install -y

# å¦‚æžœå‡ºçŽ°å¦‚ä¸‹æŠ¥é”™
[root@ubuntu2204 ~]#systemctl status cri-docker.service 
â—‹ cri-docker.service - CRI Interface for Docker Application Container Engine
     Loaded: loaded (/lib/systemd/system/cri-docker.service; enabled; vendor preset: enabled)
     Active: inactive (dead)
TriggeredBy: Ã— cri-docker.socket
       Docs: https://docs.mirantis.com

12æœˆ 15 16:23:19 master2 systemd[1]: Dependency failed for CRI Interface for Docker Application Container Engine.
12æœˆ 15 16:23:19 master2 systemd[1]: cri-docker.service: Job cri-docker.service/start failed with result 'dependency'.

# è§£å†³æ–¹æ³•ï¼šæ·»åŠ dockerç»„
groupadd docker

# é‡å¯cri-docker
systemctl restart cri-docker.service
systemctl status cri-docker.service
```````





#### æ‰€æœ‰ä¸»æœºé…ç½® cri-dockerd(v1.24ä»¥åŽç‰ˆæœ¬

``````bash
# vim /lib/systemd/system/cri-docker.service
ExecStart=/usr/bin/cri-dockerd --container-runtime-endpoint fd:// --pod-infra-container-image registry.aliyuncs.com/google_containers/pause:3.9
``````





#### æ‰€æœ‰ master å’Œ node èŠ‚ç‚¹å®‰è£…kubeadmç­‰ç›¸å…³åŒ…

æ‰€æœ‰ master å’Œ node èŠ‚ç‚¹éƒ½å®‰è£…kubeadm, kubelet,kubectl ç›¸å…³åŒ…

æ³¨æ„: nodeèŠ‚ç‚¹å¯ä»¥ä¸å®‰è£…ç®¡ç†å·¥å…· kubectl åŒ…,ä½†ä¾èµ–å…³ç³»ä¼šè‡ªåŠ¨å®‰è£…



``````bash
# cat install_k8s.sh
#!/bin/bash
apt update && apt-get install -y apt-transport-https
curl -fsSL https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/deb/Release.key | gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.30/deb/ /" | tee /etc/apt/sources.list.d/kubernetes.list
apt-get update
apt-get install -y kubelet kubeadm kubectl
``````





#### åœ¨ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹è¿è¡Œ kubeadm init åˆå§‹åŒ–å‘½ä»¤

``````
K8S_RELEASE_VERSION=1.30.2 && kubeadm init --control-plane-endpoint kubeapi.wang.org --kubernetes-version=v${K8S_RELEASE_VERSION} --pod-network-cidr 10.244.0.0/16 --service-cidr 10.96.0.0/12 --image-repository registry.aliyuncs.com/google_containers --token-ttl=0 --upload-certs --cri-socket=unix:///run/cri-dockerd.sock
``````



**å®Œæ•´å‘½ä»¤**

``````bash
K8S_RELEASE_VERSION=1.30.2 && kubeadm init --control-plane-endpoint master1.mystical.org --kubernetes-version=v${K8S_RELEASE_VERSION} --pod-network-cidr 10.244.0.0/16 --service-cidr 10.96.0.0/12 --image-repository registry.aliyuncs.com/google_containers --token-ttl=0 --upload-certs --cri-socket=unix:///run/cri-dockerd.sock
``````



**é€ä¸ªå­—æ®µçš„è¯¦ç»†è§£é‡Š**

1ï¸âƒ£ `K8S_RELEASE_VERSION=1.30.2`

- **å«ä¹‰**ï¼šå®šä¹‰ä¸€ä¸ªçŽ¯å¢ƒå˜é‡ `K8S_RELEASE_VERSION`ï¼Œç”¨äºŽæŒ‡å®š Kubernetes ç‰ˆæœ¬ã€‚

- **ä½œç”¨**ï¼šåœ¨ `kubeadm init` å‘½ä»¤ä¸­ï¼Œé€šè¿‡ `${K8S_RELEASE_VERSION}` å¼•ç”¨è¿™ä¸ªå˜é‡ï¼Œç®€åŒ–ç‰ˆæœ¬æŽ§åˆ¶ï¼Œä¾¿äºŽæ›´æ–° Kubernetes ç‰ˆæœ¬ã€‚

- ç¤ºä¾‹ï¼š

  ```
  bashCopy codeK8S_RELEASE_VERSION=1.30.2
  echo $K8S_RELEASE_VERSION  # è¾“å‡º 1.30.2
  ```



2ï¸âƒ£ **`kubeadm init`**

- **å«ä¹‰**ï¼š`kubeadm init` å‘½ä»¤ç”¨äºŽåˆå§‹åŒ– Kubernetes æŽ§åˆ¶å¹³é¢ï¼ˆMaster èŠ‚ç‚¹ï¼‰ã€‚
- **ä½œç”¨**ï¼šè¯¥å‘½ä»¤åœ¨æŽ§åˆ¶èŠ‚ç‚¹ä¸Šè¿è¡Œï¼Œåˆå§‹åŒ– Kubernetes é›†ç¾¤ï¼Œç”Ÿæˆ tokenã€è¯ä¹¦å’Œ Kubeconfig æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆ `kubeadm join` å‘½ä»¤ï¼Œä»¥ä¾¿å…¶ä»–èŠ‚ç‚¹åŠ å…¥é›†ç¾¤ã€‚



3ï¸âƒ£ **`--control-plane-endpoint kubeapi.wang.org`**

- **å«ä¹‰**ï¼šè®¾ç½® Kubernetes æŽ§åˆ¶å¹³é¢çš„**é«˜å¯ç”¨å…¥å£åœ°å€**ã€‚
- ä½œç”¨ï¼š
  - å¦‚æžœä½ æœ‰å¤šä¸ª master æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œéœ€è¦ä¸ºè¿™äº›æŽ§åˆ¶å¹³é¢æä¾›ä¸€ä¸ª**ç»Ÿä¸€çš„è®¿é—®å…¥å£**ã€‚
  - è¿™ä¸ªæŽ§åˆ¶å¹³é¢å…¥å£ï¼ˆ`kubeapi.wang.org`ï¼‰é€šå¸¸æ˜¯ä¸€ä¸ª **VIP (è™šæ‹ŸIP)**ï¼Œæˆ–è€…æ˜¯ä¸€ä¸ªå¯ä»¥è´Ÿè½½å‡è¡¡åˆ°å¤šä¸ªæŽ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„ FQDNã€‚
  - è¿™æ ·ï¼ŒKubernetes é›†ç¾¤å†…çš„ kubelet åªéœ€è¿žæŽ¥è¿™ä¸ªåŸŸåï¼Œ**ä¸éœ€è¦çŸ¥é“å…·ä½“çš„æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹çš„ IP**ã€‚
- ç¤ºä¾‹ï¼š
  - å¦‚æžœä½ æœ‰ 3 å°æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ï¼Œ`10.0.0.1, 10.0.0.2, 10.0.0.3`ï¼Œé‚£ä¹ˆä½ å¯ä»¥è®¾ç½®ä¸€ä¸ª VIP ä¾‹å¦‚ `10.0.0.100` å¹¶å°†åŸŸå `kubeapi.wang.org` è§£æžä¸º `10.0.0.100`ã€‚
  - é€šè¿‡ **Keepalived** å’Œ **HAProxy**ï¼Œå¯ä»¥å°†è¯·æ±‚ä»Ž `10.0.0.100` è½¬å‘åˆ° 3 å°æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸­çš„ä»»æ„ä¸€ä¸ªã€‚



4ï¸âƒ£ **`--kubernetes-version=v${K8S_RELEASE_VERSION}`**

- **å«ä¹‰**ï¼šæŒ‡å®šè¦å®‰è£…çš„ Kubernetes ç‰ˆæœ¬ã€‚

- **ä½œç”¨**ï¼šå¼ºåˆ¶ kubeadm ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬çš„ Kubernetes ç»„ä»¶ã€‚

- ç¤ºä¾‹ï¼š

  ```bash
  --kubernetes-version=v1.30.2
  ```



5ï¸âƒ£ **`--pod-network-cidr 10.244.0.0/16`**

- **å«ä¹‰**ï¼šè®¾ç½® Pod ç½‘ç»œçš„ CIDR åœ°å€æ®µã€‚
- ä½œç”¨ï¼š
  - åœ¨ Kubernetes é›†ç¾¤ä¸­ï¼Œæ¯ä¸ª Pod éƒ½éœ€è¦æœ‰ä¸€ä¸ªå”¯ä¸€çš„ IP åœ°å€ã€‚
  - `--pod-network-cidr` æŒ‡å®šäº†**Pod IP åœ°å€æ®µ**ã€‚
  - è¯¥ IP åœ°å€æ®µè¢« CNIï¼ˆå¦‚ Flannelã€Calicoã€Weaveï¼‰ä½¿ç”¨ï¼Œé€šå¸¸ä¸ä¸ŽæœåŠ¡å™¨çš„æœ¬åœ° IP åœ°å€å†²çªã€‚
- æ³¨æ„äº‹é¡¹ï¼š
  - Flannel é€šå¸¸ä½¿ç”¨ `10.244.0.0/16`ã€‚
  - Calico é»˜è®¤ä½¿ç”¨ `192.168.0.0/16`ã€‚
- ç¤ºä¾‹ï¼š
  - `--pod-network-cidr=10.244.0.0/16` è¡¨ç¤º Pod IP åœ°å€çš„èŒƒå›´æ˜¯ `10.244.0.0 - 10.244.255.255`ã€‚



6ï¸âƒ£ **`--service-cidr 10.96.0.0/12`**

- **å«ä¹‰**ï¼šæŒ‡å®š Service çš„è™šæ‹Ÿ IP åœ°å€æ®µã€‚

- ä½œç”¨ï¼š

  - åœ¨ Kubernetes ä¸­ï¼ŒService æ˜¯ä¸€ç§é›†ç¾¤å†…çš„**è™šæ‹Ÿ IP**ï¼Œè¿™äº› IP ä¸ä¸Žç‰©ç†ä¸»æœº IP å†²çªã€‚
  - è¿™ä¸ª IP æ®µç”± kube-proxy å’Œ iptables ç»´æŠ¤ã€‚

- æ³¨æ„äº‹é¡¹ï¼š

  - Service IP åªèƒ½åœ¨**é›†ç¾¤å†…éƒ¨è®¿é—®**ã€‚
  - é€šå¸¸ä¸ä¸Žç‰©ç†ç½‘ç»œ IP æ®µå†²çªã€‚
  - ä¸€èˆ¬æ˜¯ `10.96.0.0/12`ï¼Œè¡¨ç¤º `10.96.0.0 - 10.111.255.255` è¿™ä¸ªèŒƒå›´ã€‚

- ç¤ºä¾‹ï¼š

  ```bash
  --service-cidr=10.96.0.0/12
  ```





7ï¸âƒ£ **`--image-repository registry.aliyuncs.com/google_containers`**

- **å«ä¹‰**ï¼šæŒ‡å®š Kubernetes ç»„ä»¶é•œåƒçš„æ‹‰å–åœ°å€ã€‚

- ä½œç”¨ï¼š

  - ç”±äºŽå›½å†…æ— æ³•ç›´æŽ¥è®¿é—® **Google å®¹å™¨é•œåƒä»“åº“ (gcr.io)**ï¼Œæ‰€ä»¥ç”¨é˜¿é‡Œäº‘çš„é•œåƒæºã€‚
  - `registry.aliyuncs.com/google_containers` æ˜¯å›½å†…å¸¸ç”¨çš„é•œåƒæºï¼ŒåŒ…å«æ‰€æœ‰ Kubernetes ç›¸å…³çš„é•œåƒã€‚

- ç¤ºä¾‹ï¼š

  ```bash
  --image-repository registry.aliyuncs.com/google_containers
  ```





8ï¸âƒ£ **`--token-ttl=0`**

- **å«ä¹‰**ï¼šè®¾ç½® kubeadm join å‘½ä»¤ä¸­ Token çš„æœ‰æ•ˆæ—¶é—´ã€‚

- ä½œç”¨ï¼š

  - é»˜è®¤çš„ token è¿‡æœŸæ—¶é—´æ˜¯ 24 å°æ—¶ã€‚
  - é€šè¿‡ `--token-ttl=0`ï¼Œè¡¨ç¤ºç”Ÿæˆçš„ token**æ°¸ä¸è¿‡æœŸ**ã€‚
  - é€‚ç”¨äºŽé•¿æ—¶é—´éƒ¨ç½²èŠ‚ç‚¹ï¼Œæˆ–è€…éœ€è¦ä¸€æ®µæ—¶é—´å†…å¤šæ¬¡åŠ å…¥æ–°èŠ‚ç‚¹çš„åœºæ™¯ã€‚

- ç¤ºä¾‹ï¼š

  ```bash
  --token-ttl=0
  ```





9ï¸âƒ£ **`--upload-certs`**

- **å«ä¹‰**ï¼šå°†è¯ä¹¦ä¸Šä¼ åˆ°é›†ç¾¤ä¸­çš„æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ã€‚

- ä½œç”¨ï¼š

  - åœ¨é«˜å¯ç”¨é›†ç¾¤ä¸­ï¼ŒæŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¹‹é—´éœ€è¦å…±äº«è¯ä¹¦ã€‚
  - kubeadm ä¼šå°†è¯ä¹¦åŠ å¯†å­˜å‚¨åœ¨ **Kubernetes Secret** ä¸­ã€‚
  - é€šè¿‡è¿™ä¸ªå‚æ•°ï¼Œ**å…è®¸å…¶ä»–æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸‹è½½è¿™äº›è¯ä¹¦**ã€‚

- ç¤ºä¾‹ï¼š

  ```
  --upload-certs
  ```





ðŸ”Ÿ **`--cri-socket=unix:///run/cri-dockerd.sock`**

- **å«ä¹‰**ï¼šæŒ‡å®š Kubelet è¿žæŽ¥çš„ CRIï¼ˆå®¹å™¨è¿è¡Œæ—¶æŽ¥å£ï¼‰ã€‚

- ä½œç”¨ï¼š

  - Kubernetes æ”¯æŒå¤šä¸ª CRIï¼Œå¦‚ **containerd**ã€**cri-o** å’Œ **Docker**ã€‚
  - cri-dockerd æ˜¯ä¸€ä¸ªä¸“é—¨çš„ Docker CRI æ’ä»¶ã€‚
  - æ­¤é€‰é¡¹å‘Šè¯‰ Kubernetesï¼š**å°† Kubelet è¿žæŽ¥åˆ° /run/cri-dockerd.sock**ã€‚

- æ³¨æ„ï¼š

  - å¦‚æžœæœªæŒ‡å®šæ­¤é€‰é¡¹ï¼ŒKubelet å°†å°è¯•è‡ªåŠ¨æ£€æµ‹ CRIã€‚
  - cri-dockerd æ˜¯ç”¨äºŽä»Ž Docker è½¬æ¢åˆ° Containerd çš„ä¸´æ—¶è§£å†³æ–¹æ¡ˆã€‚

- ç¤ºä¾‹ï¼š

  ```bash
  --cri-socket=unix:///run/cri-dockerd.sock
  ```





**æ€»ç»“**

| é€‰é¡¹                       | å«ä¹‰                 | ç¤ºä¾‹                           |
| -------------------------- | -------------------- | ------------------------------ |
| `--control-plane-endpoint` | æŽ§åˆ¶å¹³é¢çš„é«˜å¯ç”¨å…¥å£ | `kubeapi.feng.org`             |
| `--kubernetes-version`     | æŒ‡å®š Kubernetes ç‰ˆæœ¬ | `v1.30.2`                      |
| `--pod-network-cidr`       | æŒ‡å®š Pod IP åœ°å€æ®µ   | `10.244.0.0/16`                |
| `--service-cidr`           | Service IP åœ°å€æ®µ    | `10.96.0.0/12`                 |
| `--image-repository`       | å®¹å™¨é•œåƒä»“åº“         | `registry.aliyuncs.com`        |
| `--token-ttl`              | kubeadm token æœ‰æ•ˆæœŸ | `0` è¡¨ç¤ºæ°¸ä¸è¿‡æœŸ               |
| `--upload-certs`           | ä¸Šä¼ æŽ§åˆ¶å¹³é¢è¯ä¹¦     | **å¯ç”¨è¯ä¹¦å…±äº«**               |
| `--cri-socket`             | å®¹å™¨è¿è¡Œæ—¶æŽ¥å£ (CRI) | `unix:///run/cri-dockerd.sock` |



å¦‚æžœè¿è¡Œå‡ºçŽ°é—®é¢˜ï¼Œéœ€è¦é‡ç½®ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤

``````
kubeadm reset -f
``````



#### å°†å…¶ä»–çš„masterå’Œworkerä¸»æœºåŠ å…¥é›†ç¾¤



æ‰§è¡Œä¸Šè¿°åˆå§‹åŒ–å‘½ä»¤åŽï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æžœ

``````bash
############ è¿™éƒ¨åˆ†æ˜¯æŽˆæƒkubectlå‘½ä»¤ #######################################################
o start using your cluster, you need to run the following as a regular user:

  mkdir -p $HOME/.kube
  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
  sudo chown $(id -u):$(id -g) $HOME/.kube/config

Alternatively, if you are the root user, you can run:

  export KUBECONFIG=/etc/kubernetes/admin.conf

You should now deploy a pod network to the cluster.
Run "kubectl apply -f [podnetwork].yaml" with one of the options listed at:
  https://kubernetes.io/docs/concepts/cluster-administration/addons/

You can now join any number of the control-plane node running the following command on each as root:

############## è¿™éƒ¨åˆ†æ˜¯masterèŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤###############################

  kubeadm join kubeapi.wang.org:6443 --token jizd9o.tjfoyvdoisbklfi5 \
	--discovery-token-ca-cert-hash sha256:c27e15a7a39394b6d64e419b60df835f9dedb7b015a92c1d9285effa1fbea600 \
	--control-plane --certificate-key 9fa84696a800c6b995a9249972c1dd76735701e5ea2ae05191c9f612a0d1252c --cri-socket=unix:///run/cri-dockerd.sock # åŽé¢è¿½åŠ  --cri-socket=unix:///run/cri-dockerd.sock

Please note that the certificate-key gives access to cluster sensitive data, keep it secret!
As a safeguard, uploaded-certs will be deleted in two hours; If necessary, you can use
"kubeadm init phase upload-certs --upload-certs" to reload certs afterward.

Then you can join any number of worker nodes by running the following on each as root:

############## è¿™éƒ¨åˆ†æ˜¯workerèŠ‚ç‚¹åŠ å…¥é›†ç¾¤çš„å‘½ä»¤###############################

kubeadm join kubeapi.wang.org:6443 --token jizd9o.tjfoyvdoisbklfi5 \
	--discovery-token-ca-cert-hash sha256:c27e15a7a39394b6d64e419b60df835f9dedb7b015a92c1d9285effa1fbea600 --cri-socket=unix:///run/cri-dockerd.sock # åŽé¢è¿½åŠ  --cri-socket=unix:///run/cri-dockerd.sock
``````



æ ¹æ®ä¸Šè¿°æŒ‡ä»¤åŠ masterä¸»æœºå’Œå…¶ä»–workerä¸»æœºåŠ å…¥é›†ç¾¤



#### å®‰è£…ç½‘ç»œæ’ä»¶flanny

``````bash
wget https://mirror.ghproxy.com/https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml

# è¦ç¡®ä¿dockerå¯ä»¥æ‹‰å–é•œåƒï¼Œå»ºè®®å¼€ä»£ç†
kubectl apply -f kube-flannel.yml
``````



#### æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ

``````bash
[root@ubuntu2204 ~]#kubectl get nodes
NAME      STATUS   ROLES           AGE   VERSION
master1   Ready    control-plane   97m   v1.30.8
master2   Ready    control-plane   94m   v1.30.8
master3   Ready    control-plane   93m   v1.30.8
node1     Ready    <none>          92m   v1.30.8
node2     Ready    <none>          92m   v1.30.8
node3     Ready    <none>          92m   v1.30.8

``````



#### å¯ç”¨è‡ªåŠ¨è¡¥å…¨è„šæœ¬

``````bash
# ä¸´æ—¶è¡¥å…¨å‘½ä»¤
source <(kubectl completion bash)


# ç”¨æˆ·æ°¸ä¹…è¡¥å…¨ï¼Œæ¯æ¬¡ç™»å½•éƒ½ç”Ÿæ•ˆ
echo 'source <(kubectl completion bash)' >> ~/.bashrc
source ~/.bashrc
``````





## Kubernetesèµ„æºå¯¹è±¡å’ŒPodèµ„æº



**æœ¬ç« å†…å®¹**

- **èµ„æºå¯¹è±¡**
- **åç§°ç©ºé—´**
- **Podèµ„æº**
- **Podå·¥ä½œæœºåˆ¶**



### èµ„æºå¯¹è±¡

#### Kuberneteså¸¸è§èµ„æºå¯¹è±¡

![alt text](images/image29.png)



#### Kubernetesä¸­èµ„æºå¯¹è±¡çš„åˆ†ç±»



**ç‹¬ç«‹å­˜åœ¨çš„èµ„æº**

Kubernetes ç³»ç»Ÿå°†ä¸€åˆ‡äº‹ç‰©éƒ½ç§°ä¸ºèµ„æºå¯¹è±¡, ç›¸å½“äºŽé¢å‘å¯¹è±¡çš„æ€æƒ³ 

æœ‰ä¸€äº›ç‹¬ç«‹å­˜åœ¨,å³ä¸ä¾èµ–äºŽå…¶å®ƒå¯¹è±¡å­˜åœ¨çš„èµ„æºç±»åž‹, Kubernetes æä¾›äº†å•ç‹¬çš„ API èµ„æºï¼Œå…¶**éµå¾ª  REST é£Žæ ¼**ç»„ç»‡å¹¶ç®¡ç†è¿™äº›èµ„æºå¯¹è±¡

å¯¹è¿™äº›API èµ„æºç±»åž‹æ”¯æŒä½¿ç”¨æ ‡å‡†çš„ HTTP æ–¹æ³•(POST,PUT,PATCH,DELETE å’Œ GET)å¯¹èµ„æºè¿›è¡Œå¢žã€åˆ ã€ æ”¹å’ŒæŸ¥ã€‚



**ä¸èƒ½ç‹¬ç«‹å­˜åœ¨çš„èµ„æº**

ä¹Ÿæœ‰ä¸€äº›èµ„æºKubernetes  ä¸­å¹¶æ²¡æœ‰æä¾›å¯¹åº”ç‹¬ç«‹çš„APIèµ„æºç±»åž‹,ä¸èƒ½ç‹¬ç«‹åˆ›å»º,éœ€è¦ä¾é™„å…¶å®ƒèµ„æºçš„å­˜ åœ¨, æ¯”å¦‚: Label,emptyDirç­‰



```ABAP
åœ¨ Kubernetes ç³»ç»Ÿä¸­ï¼Œèµ„æºä»£è¡¨äº†å¯¹è±¡çš„é›†åˆï¼Œä¾‹å¦‚ï¼šPod èµ„æºå¯ç”¨äºŽæè¿°æ‰€æœ‰ Podç±»åž‹çš„å¯¹è±¡ã€‚å¯¹ è±¡å®žè´¨æ˜¯èµ„æºç±»åž‹ç”Ÿæˆçš„å®žä¾‹ã€‚
```



 

**Kubernetes çš„API  èµ„æºåˆ†ä¸ºä¸¤ç§:**

- å†…ç½®API èµ„æº: Kubernetes å®‰è£…åŽè‡ªèº«å…·æœ‰çš„è‡ªå®šä¹‰çš„API èµ„æº: 
- ç”¨æˆ·è‡ªå®šä¹‰çš„API,ç§°ä¸ºCRD(Custom Resource Definition),å¯ä»¥é€šè¿‡å®‰è£…ä¸€äº›ç»„ä»¶ç”Ÿæˆ



**ä»Žèµ„æºçš„ä¸»è¦åŠŸèƒ½ä¸ŠKubernetes çš„èµ„æºå¯¹è±¡åˆ†ä¸º**

- Workloads(å·¥ä½œè´Ÿè½½)
- Service,LoadBalancing and Networking(æœåŠ¡å‘çŽ°å’Œè´Ÿè½½å‡è¡¡)
- å­˜å‚¨å’Œé…ç½®(Storage&Configuration)
- Cluster Admin(é›†ç¾¤ç®¡ç†)
- Policies&Scheduling(ç­–ç•¥å’Œè°ƒåº¦)
-  Metadata(å…ƒæ•°æ®)



**K8Sèµ„æºè¿˜å¯ä»¥æŒ‰é€‚ç”¨èŒƒå›´åˆ†ä¸º:åç§°ç©ºé—´çº§åˆ«ã€é›†ç¾¤çº§åˆ«ã€å…ƒæ•°æ®ç±»åž‹**

- **åç§°ç©ºé—´çº§åˆ«**
  - ä»…åœ¨æ­¤åç§°ä¸­ç”Ÿæ•ˆã€‚ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬ä¹‹å‰é€šè¿‡ kubeadm åŽ»å®‰è£…æˆ‘ä»¬K8S é›†ç¾¤çš„æ—¶ å€™ï¼Œä»–ä¼šé»˜è®¤æŠŠæ‰€æœ‰ç»„ä»¶æ”¾åˆ° kube-system è¿™ä¸ªåç§°ç©ºé—´ä¸‹åŽ»è¿è¡Œï¼Œç„¶åŽæˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤ kubectl get pod çš„æ—¶å€™ä¼šçœ‹åˆ°å®ƒèŽ·å–ä¸åˆ°ï¼Œå¯¹åº”çš„æˆ‘ä»¬ç³»ç»Ÿä¸€äº› pod çš„ä¿¡æ¯ï¼ŒåŽŸå› æ˜¯é»˜è®¤æƒ…å†µ ä¸‹è¯¥å‘½ä»¤ä»€ä¹ˆéƒ½ä¸åŠ çš„è¯ç›¸å½“äºŽæ˜¯ kubectl get pod -n default ï¼Œä½†æ˜¯æˆ‘ä»¬çš„  K8S æœ¬èº«ç»„ä»¶ä»– æ˜¯æ”¾åœ¨æˆ‘ä»¬çš„ kube-system åç§°ç©ºé—´ä¸‹çš„ï¼Œæ‰€æœ‰è¿™ç§æƒ…å†µæˆ‘ä»¬ä¼šå‘çŽ°ï¼Œåœ¨  kube-system åç§°ç©ºé—´ ä¸‹çš„èµ„æºæˆ‘ä»¬åœ¨å…¶ä»–åç§°ç©ºé—´ä¸­æ˜¯çœ‹ä¸è§çš„ã€‚è¿™å°±æ˜¯å…¸åž‹çš„åç§°ç©ºé—´çº§åˆ«èµ„æºã€‚



- **é›†ç¾¤çº§åˆ«**
  - æ¯”å¦‚ã€role ç­‰ç­‰ï¼Œè¿™éƒ½æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œä¸ç®¡åœ¨ä»€ä¹ˆåç§°ç©ºé—´ä¸‹åŽ»å®šä¹‰ï¼Œåœ¨å…¶ä»–çš„å ç§°ç©ºé—´ä¸‹éƒ½èƒ½å¤Ÿçœ‹å¾—åˆ°ï¼Œå…¶å®žä»–åœ¨å®šä¹‰çš„æ—¶å€™éƒ½æ²¡æœ‰åŽ»æŒ‡å®šæ‰€è°“çš„åç§°ç©ºé—´ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸€æ—¦ç»è¿‡ å®šä¹‰ä»¥åŽåœ¨å…¨é›†ç¾¤ä¸­éƒ½èƒ½å¤Ÿè¢«å¯è§ä»¥åŠè°ƒç”¨ï¼Œè¿™ç§çº§åˆ«å‘¢æˆ‘ä»¬å°±æŠŠå®ƒé›†ç¾¤çº§åˆ«ä¸‹çš„åç§°ç©ºé—´ï¼Œå¹¶ä¸” æŠŠè¿™ç§ä¸œè¥¿å«åšé›†ç¾¤çº§åˆ«çš„èµ„æº



- **å…ƒæ•°æ®åž‹**
  - è´Ÿè´£æä¾›ä¸€ç§æŒ‡æ ‡ï¼Œæºæ•°æ®ç±»åž‹å®ƒä¸åƒæˆ‘ä»¬çš„åç§°ç©ºé—´çº§åˆ«å’Œé›†ç¾¤çº§åˆ«ï¼Œå…¶å®žå®ƒä¹Ÿå¯ä»¥ å½’å±žåœ¨è¿™ä¸¤è€…ä¹‹é—´ï¼Œä½†æ˜¯å®ƒåˆæœ‰è‡ªå·±çš„ç‰¹ç‚¹æ‰€ä»¥æˆ‘ä»¬å°†ä»–æ‹¿å‡ºæ¥è¿›è¡Œå•ç‹¬çš„åˆ†ç±»ã€‚æ¯”å¦‚å‰é¢è®²è¿‡çš„  HPA ä»–å°±æ˜¯å¯ä»¥é€šè¿‡æˆ‘ä»¬çš„ CPU è¿›è¡Œå¹³æ»‘æ‰©å±•ï¼Œä»–å°±æ˜¯å…¸åž‹çš„æºæ•°æ®åž‹ã€‚é€šè¿‡æˆ‘ä»¬çš„æŒ‡æ ‡è¿›è¡Œæ“ ä½œã€‚



#### èµ„æºåŠå…¶åœ¨ API ä¸­çš„ç»„ç»‡å½¢å¼

Kubernetes åˆ©ç”¨æ ‡å‡†çš„ **RESTful æœ¯è¯­**æ¥æè¿°å…¶ API æ¦‚å¿µ

- **èµ„æºç±»åž‹**ï¼šæ˜¯æŒ‡åœ¨ URL ä¸­ä½¿ç”¨çš„åç§°ï¼Œå¦‚ Podã€Namespace å’Œ Service ç­‰ï¼Œå…¶ URL æ ¼å¼ ä¸º"**/GROUP/VERSION/RESOURCE**"ï¼Œç¤ºä¾‹ï¼š/apps/v1/deployment

- æ‰€æœ‰èµ„æºç±»åž‹éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ JSON è¡¨ç¤ºæ ¼å¼ï¼š**kind(ç§ç±»)**ï¼Œåœ¨ K8s ä¸­ç”¨æˆ·åˆ›å»ºå¯¹è±¡å¿…é¡»ä»¥ JSONæ ¼ å¼æäº¤å¯¹è±¡çš„é…ç½®ä¿¡æ¯
- éš¶å±žäºŽåŒä¸€èµ„æºç±»åž‹çš„å¯¹è±¡ç»„æˆçš„åˆ—è¡¨ç§°ä¸º **collection(é›†åˆ)**ï¼Œå¦‚ PodList
-   æŸç§ç±»åž‹çš„å•ä¸ªå®žä¾‹ç§°ä¸º**"resource"(èµ„æº)**æˆ–**"object"(å¯¹è±¡)**ï¼Œå¦‚è¿è¡Œçš„åä¸º pod-test çš„ Pod å¯¹è±¡



**APIç¾¤ç»„**

Kubernetes å°† API åˆ†å‰²ä¸ºå¤šä¸ªé€»è¾‘ç»„åˆï¼Œç§°ä¸ºAPI ç¾¤ç»„ï¼Œä¸åŒçš„ç¾¤ç»„æ”¯æŒå•ç‹¬å¯ç”¨æˆ–ç¦ç”¨ï¼Œå¹¶å¯ä»¥å†æ¬¡ åˆ†è§£ã€‚ç¾¤ç»„åŒ–ç®¡ç†çš„ API ä½¿å¾—å…¶å¯ä»¥æ›´è½»æ¾çš„è¿›è¡Œæ‰©å±•ã€‚å½“å‰ K8s é›†ç¾¤ç³»ç»Ÿä¸Šçš„ API server ä¸Šçš„ç›¸å…³ä¿¡ æ¯å¯ä»¥ä½¿ç”¨ kubectl api-versions èŽ·å–ã€‚é…ç½®èµ„æºæ¸…å•æ—¶ä¼šä½¿ç”¨ API ç¾¤ç»„

```bash
#æ˜¾ç¤ºAPIç¾¤ç»„,ç»“æžœæ ¼å¼ä¸º: GROUP_NAME/VERSOIN,åŒä¸€ä¸ªç»„å¯ä»¥æœ‰å¤šç‰ˆæœ¬å¹¶å­˜
#GROUP_NAMEï¼šAPIç¾¤ç»„åï¼Œå¦‚æžœçœç•¥è¡¨ç¤ºå±žäºŽcoreæ ¸å¿ƒç»„
#VERSION:v1,ç»è¿‡éªŒè¯çš„ç¨³å®šç‰ˆæœ¬ï¼Œå¯ä»¥ç”Ÿäº§çŽ¯å¢ƒä½¿ç”¨,å¦‚:apps/v1
#alpha:å†…æµ‹,å¯èƒ½åŒ…å«é”™è¯¯ï¼Œç”Ÿäº§ä¸å»ºè®®ä½¿ç”¨
#beta: å…¬æµ‹ï¼Œå­˜åœ¨å˜åŠ¨çš„å¯èƒ½æˆ–è€…æ½œåœ¨çš„é—®é¢˜ï¼Œç”Ÿäº§ä¸å»ºè®®ä½¿ç”¨,å¦‚:autoscaling/v2beta2
```

Kubernetes çš„ API ä»¥å±‚çº§ç»“æž„ç»„ç»‡åœ¨ä¸€èµ·

- Objectï¼šèµ„æºåž‹å¯¹è±¡ï¼Œè¡¨çŽ°ä¸º **http urlä¸­path**
- éžObjectï¼šéžèµ„æºåž‹å¯¹è±¡ï¼Œkubernetesç‰¹æœ‰ï¼Œä¾‹å¦‚: /healthz



Objectèµ„æºåž‹å¯¹è±¡å¯¹åº”çš„ API ç¾¤ç»„å¯ä»¥å½’ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š

- **æ ¸å¿ƒç¾¤ç»„(core group)ï¼š**

  -  åœ¨èµ„æºçš„é…ç½®ä¿¡æ¯ apiVersion å­—æ®µä¸­å¼•ç”¨æ—¶å¯ä»¥ä¸ç”¨æŒ‡å®šè·¯å¾„,å¦‚:"apiVersion: v1
  - **REST è·¯å¾„ä¸º /api/v1**

  ```bash
  # RESTfulé£Žæ ¼çš„URLæ ¼å¼ 
  https://API_SERVER:HOST/api/v1/namespaces/<NS_NAME>/<RESOURCE_NANE>/<OBJECT_NAME>
  
  #defaultåç§°ç©ºé—´ä¸‹çš„mypodçš„Podèµ„æºï¼ŒURLè·¯å¾„ç›´æŽ¥è®¿é—®
  curl https://API_SERVER:HOST/api/vl/namespaces/default/pods/mypod
  ```

  æ‰©å±•ï¼š**kubectl get --raw ä½œç”¨è¯¦è§£**

  - **ç›´æŽ¥è®¿é—® Kubernetes API**

    - `kubectl get --raw` ä¸åƒ `kubectl get pods` è¿™æ ·çš„å‘½ä»¤ä¼šå¯¹æ•°æ®åšé¢å¤–çš„å¤„ç†
    - å®ƒçš„æ•ˆæžœå’Œä»¥ä¸‹å‘½ä»¤å‡ ä¹Žä¸€è‡´ï¼š

    ```bash
    curl -k -H "Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" \
      https://<API_SERVER>:6443/api/v1/namespaces/default/pods/myapp-7b94444f8d-66d4h
    ```

  - **è¿”å›žçš„æ˜¯å®Œæ•´çš„åŽŸå§‹ JSON æ ¼å¼çš„å“åº”**

    - `kubectl get pods` é€šå¸¸ä¼šè¾“å‡ºè¡¨æ ¼æ•°æ®ï¼š

    ```bash
    NAME                          READY   STATUS    RESTARTS   AGE
    myapp-7b94444f8d-66d4h        1/1     Running   0          10m
    ```

    - ä½†æ˜¯ `kubectl get --raw` è¿”å›žçš„åˆ™æ˜¯ **åŽŸå§‹çš„ JSON æ ¼å¼**ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š

    ```json
    {
      "kind": "Pod",
      "apiVersion": "v1",
      "metadata": {
        "name": "myapp-7b94444f8d-66d4h",
        "namespace": "default",
        "uid": "12345678-1234-1234-1234-123456789abc",
        "creationTimestamp": "2024-12-15T10:00:00Z"
      },
      "spec": {
        "containers": [
          {
            "name": "myapp",
            "image": "nginx:1.26.0",
            "ports": [
              {
                "containerPort": 80,
                "protocol": "TCP"
              }
            ]
          }
        ]
      },
      "status": {
        "phase": "Running",
        "conditions": [
          {
            "type": "Initialized",
            "status": "True"
          },
          {
            "type": "Ready",
            "status": "True"
          },
          {
            "type": "ContainersReady",
            "status": "True"
          }
        ]
      }
    }
    
    ```

  - **å¸¸è§ä½¿ç”¨åœºæ™¯**

    - **æŸ¥çœ‹ Kubernetes çš„æ‰€æœ‰APIèµ„æº**

    ```bash
    kubectl get --raw="/apis"
    # è¿™ä¼šåˆ—å‡ºå½“å‰ Kubernetes é›†ç¾¤ä¸­å¯ç”¨çš„ API ç‰ˆæœ¬å’Œèµ„æº
    ```

    - **èŽ·å–ç‰¹å®špodçš„è¯¦ç»†ä¿¡æ¯**

    ```bash
    kubectl get --raw="/api/v1/namespaces/default/pods/myapp-7b94444f8d-66d4h"
    # è§£é‡Šï¼šè¿”å›žè¿™ä¸ª pod çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ¯” kubectl get pod myapp-7b94444f8d-66d4h -o json æä¾›æ›´å¤šçš„APIå…ƒæ•°æ®ä¿¡æ¯ã€‚
    ```

    -  **èŽ·å– Kube-Proxy çš„å¥åº·æ£€æŸ¥**

    ```bash
    kubectl get --raw="/healthz"
    # è¿”å›žå­—ç¬¦ä¸²
    ```

    - **æŸ¥çœ‹æ‰€æœ‰ Kubernetes ç‰ˆæœ¬API**

    ```bash
    kubectl get --raw="/version"
    # è¿”å›žjsonæ•°æ®
    ```

    - **è®¿é—® webhook è¯·æ±‚æ—¥å¿—**

    ```bash
    kubectl get --raw="/logs"
    ```

- **å‘½åçš„ç¾¤ç»„(named group)**

  - å³æœ‰åç§°çš„ç¾¤ç»„
  -  REST è·¯å¾„ä¸º `/apis/$GROUP_NAME/$VERSION` , å¦‚ `/apis/apps/v1`

  ```bash
  https://API_SERVER:HOST/apis/GROUP_NANE/VERSION/namespaces/<NS_MTNE>/<RESOURCE_NAME>/<0B3ECT_NNE
  /apis/<GROUP_NAME>/<VERSION>/<NAMESPACE>/default/deployments/
  /apis/<GROUP_NAME>/<VERSION>/<NAMESPACE>/default/deployments/<PODNAME>
   
  #ç¤ºä¾‹ï¼š 
  kubectl get --raw="/apis/apps/v1/namespaces/kube-system/deployments/coredns" | jq
  ```

  

#### è®¿é—® Kubernetes REST API

```bash
# è¿™ä¸ªTOKENåœ¨åŽé¢å­¦ä¹ åˆ›å»ºSAçš„æ—¶å€™ä¼šå­¦ä¹ å¦‚ä½•å¾—åˆ°
#TOKEN=$(echo ZXlKaGJHY2lw==|base64 -d)

#åˆ©ç”¨ä¸Šé¢ç”Ÿæˆçš„TOEKNæ‰èƒ½è®¿é—®
curl -s  --cacert /etc/kubernetes/pki/ca.crt -H "Authorization: Bearer ${TOKEN}" https://kubeapi.wang.org:6443
```



#### æŸ¥çœ‹èµ„æºå¯¹è±¡çš„å‘½ä»¤

##### æŸ¥çœ‹èµ„æºç±»åž‹

```bash
[root@ubuntu2204 ~]# kubectl api-resources 

NAME                                SHORTNAMES   APIVERSION                        NAMESPACED   KIND
bindings                                         v1                                true         Binding
componentstatuses                   cs           v1                                false        ComponentStatus
#configmaps                          cm           v1                                true         ConfigMap
#endpoints                           ep           v1                                true         Endpoints
events                              ev           v1                                true         Event
#limitranges                         limits       v1                                true         LimitRange
#namespaces                          ns           v1                                false        Namespace
#nodes                               no           v1                                false        Node
#persistentvolumeclaims              pvc          v1                                true         PersistentVolumeClaim
#persistentvolumes                   pv           v1                                false        PersistentVolume
#pods                                po           v1                                true         Pod
#podtemplates                                     v1                                true         PodTemplate
#replicationcontrollers              rc           v1                                true         ReplicationController
resourcequotas                      quota        v1                                true         ResourceQuota
#secrets                                          v1                                true         Secret
#serviceaccounts                     sa           v1                                true         ServiceAccount
#services                            svc          v1                                true         Service
mutatingwebhookconfigurations                    admissionregistration.k8s.io/v1   false        MutatingWebhookConfiguration
validatingadmissionpolicies                      admissionregistration.k8s.io/v1   false        ValidatingAdmissionPolicy
validatingadmissionpolicybindings                admissionregistration.k8s.io/v1   false        ValidatingAdmissionPolicyBinding
validatingwebhookconfigurations                  admissionregistration.k8s.io/v1   false        ValidatingWebhookConfiguration
customresourcedefinitions           crd,crds     apiextensions.k8s.io/v1           false        CustomResourceDefinition
apiservices                                      apiregistration.k8s.io/v1         false        APIService
controllerrevisions                              apps/v1                           true         ControllerRevision
#daemonsets                          ds           apps/v1                           true         DaemonSet
#deployments                         deploy       apps/v1                           true         Deployment
#replicasets                         rs           apps/v1                           true         ReplicaSet
#statefulsets                        sts          apps/v1                           true         StatefulSet
selfsubjectreviews                               authentication.k8s.io/v1          false        SelfSubjectReview
tokenreviews                                     authentication.k8s.io/v1          false        TokenReview
localsubjectaccessreviews                        authorization.k8s.io/v1           true         LocalSubjectAccessReview
selfsubjectaccessreviews                         authorization.k8s.io/v1           false        SelfSubjectAccessReview
selfsubjectrulesreviews                          authorization.k8s.io/v1           false        SelfSubjectRulesReview
subjectaccessreviews                             authorization.k8s.io/v1           false        SubjectAccessReview
horizontalpodautoscalers            hpa          autoscaling/v2                    true         HorizontalPodAutoscaler
#cronjobs                            cj           batch/v1                          true         CronJob
#jobs                                             batch/v1                          true         Job
certificatesigningrequests          csr          certificates.k8s.io/v1            false        CertificateSigningRequest
leases                                           coordination.k8s.io/v1            true         Lease
endpointslices                                   discovery.k8s.io/v1               true         EndpointSlice
events                              ev           events.k8s.io/v1                  true         Event
flowschemas                                      flowcontrol.apiserver.k8s.io/v1   false        FlowSchema
prioritylevelconfigurations                      flowcontrol.apiserver.k8s.io/v1   false        PriorityLevelConfiguration
ingressclasses                                   networking.k8s.io/v1              false        IngressClass
#ingresses                           ing          networking.k8s.io/v1              true         Ingress
networkpolicies                     netpol       networking.k8s.io/v1              true         NetworkPolicy
runtimeclasses                                   node.k8s.io/v1                    false        RuntimeClass
poddisruptionbudgets                pdb          policy/v1                         true         PodDisruptionBudget
#clusterrolebindings                              rbac.authorization.k8s.io/v1      false        #ClusterRoleBinding
#clusterroles                                     rbac.authorization.k8s.io/v1      false        ClusterRole
#rolebindings                                     rbac.authorization.k8s.io/v1      true         RoleBinding
#roles                                            rbac.authorization.k8s.io/v1      true         Role
priorityclasses                     pc           scheduling.k8s.io/v1              false        PriorityClass
csidrivers                                       storage.k8s.io/v1                 false        CSIDriver
csinodes                                         storage.k8s.io/v1                 false        CSINode
csistoragecapacities                             storage.k8s.io/v1                 true         CSIStorageCapacity
#storageclasses                      sc           storage.k8s.io/v1                 false        StorageClass
volumeattachments                                storage.k8s.io/v1                 false        VolumeAttachment
```



##### æŸ¥çœ‹æ‰€æœ‰èµ„æº

```bash
[root@ubuntu2204 ~]# kubectl get all -A

NAMESPACE      NAME                                  READY   STATUS    RESTARTS        AGE
default        pod/myapp-7b94444f8d-66d4h            1/1     Running   0               161m
default        pod/myapp-7b94444f8d-nctmp            1/1     Running   0               161m
default        pod/myapp-7b94444f8d-tnj2j            1/1     Running   0               161m
kube-flannel   pod/kube-flannel-ds-8c9x7             1/1     Running   0               3h42m
kube-flannel   pod/kube-flannel-ds-8xd9g             1/1     Running   0               3h42m
kube-flannel   pod/kube-flannel-ds-lgtbb             1/1     Running   0               3h42m
kube-flannel   pod/kube-flannel-ds-q2fvl             1/1     Running   0               3h42m
kube-flannel   pod/kube-flannel-ds-wdmsn             1/1     Running   0               3h42m
kube-flannel   pod/kube-flannel-ds-wfmst             1/1     Running   0               3h42m
kube-system    pod/coredns-cb4864fb5-4tsg8           1/1     Running   0               4h13m
kube-system    pod/coredns-cb4864fb5-kpzdd           1/1     Running   0               4h13m
kube-system    pod/etcd-master1                      1/1     Running   1 (3h45m ago)   4h13m
kube-system    pod/etcd-master2                      1/1     Running   1 (3h43m ago)   4h10m
kube-system    pod/etcd-master3                      1/1     Running   1 (3h43m ago)   4h8m
kube-system    pod/kube-apiserver-master1            1/1     Running   1 (3h45m ago)   4h13m
kube-system    pod/kube-apiserver-master2            1/1     Running   1 (3h43m ago)   4h10m
kube-system    pod/kube-apiserver-master3            1/1     Running   1               4h8m
kube-system    pod/kube-controller-manager-master1   1/1     Running   1 (3h45m ago)   4h13m
kube-system    pod/kube-controller-manager-master2   1/1     Running   1 (3h43m ago)   4h10m
kube-system    pod/kube-controller-manager-master3   1/1     Running   1               4h8m
kube-system    pod/kube-proxy-42n9v                  1/1     Running   1               4h8m
kube-system    pod/kube-proxy-4ckkx                  1/1     Running   1 (3h43m ago)   4h7m
kube-system    pod/kube-proxy-755mw                  1/1     Running   1 (3h45m ago)   4h13m
kube-system    pod/kube-proxy-c977c                  1/1     Running   1 (3h43m ago)   4h7m
kube-system    pod/kube-proxy-htdr6                  1/1     Running   1 (3h43m ago)   4h8m
kube-system    pod/kube-proxy-nxqr6                  1/1     Running   1 (3h43m ago)   4h10m
kube-system    pod/kube-scheduler-master1            1/1     Running   1 (3h45m ago)   4h13m
kube-system    pod/kube-scheduler-master2            1/1     Running   1 (3h43m ago)   4h10m
kube-system    pod/kube-scheduler-master3            1/1     Running   1 (3h43m ago)   4h8m


```



##### æŸ¥çœ‹CRD

```bash
[root@master1 ~]# kubectl get crd
NAME                                                  CREATED AT
bgpconfigurations.crd.projectcalico.org               2023-07-22T12:10:37Z             
bgpfilters.crd.projectcalico.org                      2023-07-22T12:10:37Z                  
bgppeers.crd.projectcalico.org                        2023-07-22T12:10:37Z                    
blockaffinities.crd.projectcalico.org                 2023-07-22T12:10:37Z            
caliconodestatuses.crd.projectcalico.org              2023-07-22T12:10:37Z
clusterinformations.crd.projectcalico.org             2023-07-22T12:10:37Z 
felixconfigurations.crd.projectcalico.org             2023-07-22T12:10:37Z
globalnetworkpolicies.crd.projectcalico.org           2023-07-22T12:10:37Z
globalnetworksets.crd.projectcalico.org               2023-07-22T12:10:37Z
hostendpoints.crd.projectcalico.org                   2023-07-22T12:10:37Z  
```



##### æŸ¥çœ‹æŒ‡å®šAPI Groupçš„èµ„æº

```bash
[root@ubuntu2204 ~]# kubectl api-resources --api-group apps
NAME                  SHORTNAMES   APIVERSION   NAMESPACED   KIND
controllerrevisions                apps/v1      true         ControllerRevision
daemonsets            ds           apps/v1      true         DaemonSet
deployments           deploy       apps/v1      true         Deployment
replicasets           rs           apps/v1      true         ReplicaSet
statefulsets          sts          apps/v1      true         StatefulSet
```



#### ç”¨ä»£ç†è®¿é—®è®¿é—®APIServer

```bash
# å‰å°å¯åŠ¨ä¸€ä¸ªä»£ç†
[root@master1 ~]#kubectl proxy --port=8081
Starting to serve on 127.0.0.1:8081

#åœ¨å¦ä¸€ä¸ªç»ˆç«¯æ‰§è¡Œä¸‹é¢
#ä½¿ç”¨ jq å‘½ä»¤(json æ•°æ®å¤„ç†çš„å‘½ä»¤è¡Œå·¥å…·)å¤„ç†ç»“æžœï¼š
[root@master1 ~]#curl -s 127.0.0.1:8081/api/  | jq .kind
"APIVersions"

# æŸ¥çœ‹ç‰ˆæœ¬
[root@master1 ~]#curl -s 127.0.0.1:8081/version  | jq 
{
  "major": "1",
  "minor": "30",
  "gitVersion": "v1.30.2",
  "gitCommit": "39683505b630ff2121012f3c5b16215a1449d5ed",
  "gitTreeState": "clean",
  "buildDate": "2024-06-11T20:21:00Z",
  "goVersion": "go1.22.4",
  "compiler": "gc",
  "platform": "linux/amd64"
}
```



### èµ„æºæ¸…å•æ ¼å¼

#### èµ„æºé…ç½®æ¸…å•ä»‹ç»

èµ„æºé…ç½®æ¸…å•çš„æ ¼å¼é‡‡ç”¨ Yaml æ ¼å¼

ç¬¬ä¸€çº§å­—æ®µåä¸€èˆ¬åŒ…æ‹¬: **apiVersion**ã€**kind**ã€**metadata**ã€**spec**ã€**status** äº”ä¸ªå­—æ®µ

å­—æ®µåé‡‡æœ‰å°é©¼å³°å‘½åæ³•,è€Œå€¼ä¸€èˆ¬é‡‡ç”¨å¤§é©¼å³°å‘½ä»¤æ³•



**ç¬¬ä¸€çº§å­—æ®µç®€ä»‹**

- apiVersionã€kind å’Œ metadata å­—æ®µçš„åŠŸèƒ½åŸºæœ¬ç›¸åŒ
- spec ç”¨äºŽè§„å®šèµ„æºçš„æœŸæœ›çŠ¶æ€ï¼Œè€Œèµ„æºçš„åµŒå¥—å±žæ€§æ˜¯æœ‰å¾ˆå¤§å·®åˆ«çš„ã€‚
- statuså­—æ®µåˆ™è®°å½•æ´»åŠ¨å¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼Œå…¶è¦ä¸Ž spec ä¸­å®šä¹‰çš„çŠ¶æ€ç›¸åŒï¼Œæˆ–è€…å¤„äºŽæ­£è½¬æ¢ä¸ºä¸Žå…¶ç›¸åŒçš„ è¿‡ç¨‹ä¸­ã€‚
- ç”¨æˆ·å¯ä»¥ä½¿ç”¨ `kubectl get TYPE/NAME -o yaml/json` å‘½ä»¤æ¥èŽ·å–ä»»ä½•ä¸€ä¸ªå¯¹è±¡çš„yaml æˆ–è€… json æ ¼å¼ çš„é…ç½®æ¸…å•



**èµ„æºæ¸…å•ç¤ºä¾‹**

```yaml
# kubectl get namespace kube-system -o yaml
apiVersion: v1
kind: Namespace
metadata:
  creationTimestamp: "2020-02-22T07:56:11Z"
  labels:
    kubernetes.io/metadata.name: kube-system
  name: kube-system
  resourceVersion: "7"
  uid: a176ab46-ab7b-4737-ab52-2e53ca1d1d46
spec:
  finalizers:- kubernetes
status:
  phase: Active
  
  
# kubectl get namespace kube-system -o json
{
 "apiVersion": "v1",
 "kind": "Namespace",
 "metadata": {
 "creationTimestamp": "2020-02-22T07:56:11Z",
 "labels": {
 "kubernetes.io/metadata.name": "kube-system"
        },
 "name": "kube-system",
 "resourceVersion": "7",
 "uid": "a176ab46-ab7b-4737-ab52-2e53ca1d1d46"
    },
 "spec": {
 "finalizers": [
 "kubernetes"
        ]
    },
 "status": {
 "phase": "Active"
    }
}
```



#### apiVersionå’Œkind

apiVersionå’Œkind æè¿°ç±»åž‹çš„å…ƒæ•°æ®

- **apiVersion**ï¼šAPIç‰ˆæœ¬,ç”¨äºŽå¯¹åŒä¸€èµ„æºå¯¹è±¡çš„ä¸åŒç‰ˆæœ¬è¿›è¡Œå¹¶è¡Œç®¡ç†ï¼Œä¸»è¦æœ‰ alphaã€betalã€ stable
  - æ ¼å¼ï¼šç»„å/ç‰ˆæœ¬
  - æŸ¥çœ‹å‘½ä»¤ï¼škubectl api-versionsï¼Œå¯ä»¥çœ‹åˆ°å½“å‰å…±æœ‰27+ä¸ªåˆ†ç»„å’Œç‰ˆæœ¬
- **kind**ï¼šèµ„æºç±»åž‹,kubernetesçš„ä¸“ç”¨èµ„æºå¯¹è±¡
  - æŸ¥çœ‹å‘½ä»¤ï¼š kubectl api-resources  [--api-group=]ï¼Œå¯ä»¥çœ‹åˆ°å½“å‰å…±æœ‰50+ç§èµ„æºå¯¹è±¡å’Œå¯¹åº”çš„ APIVERSION ç‰ˆæœ¬ä¿¡æ¯



#### metadata åµŒå¥—å­—æ®µ

metadata å­—æ®µç”¨äºŽæè¿°å¯¹è±¡çš„å…ƒæ•°æ®,å³å±žæ€§ä¿¡æ¯ï¼Œå…¶å†…åµŒå¤šä¸ªç”¨äºŽå®šä¹‰èµ„æºçš„å…ƒæ•°æ®ï¼Œå¦‚ **name** å’Œ  **labels** ç­‰ã€‚è¿™äº›å­—æ®µå¯ä»¥åˆ†ä¸ºå¿…é€‰å­—æ®µå’Œå¯é€‰å­—æ®µ



**å¿…é€‰å­—æ®µï¼š**

- **name**: è®¾å®šå½“å‰å¯¹è±¡çš„åç§°ï¼Œåç§°ç©ºé—´é—´çº§çš„èµ„æºåœ¨å…¶æ‰€å±žçš„åç§°ç©ºé—´çš„åŒä¸€ç±»åž‹ä¸­å¿…é¡»å”¯ä¸€
- **namespace**: æŒ‡å®šå½“å‰å¯¹è±¡éš¶å±žçš„åç§°ç©ºé—´ï¼Œé»˜è®¤å€¼ä¸º defaultï¼Œå®žçŽ°èµ„æºéš”ç¦»
- **uid**: å½“å‰å¯¹è±¡çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œç”¨äºŽåŒºåˆ«"å·²åˆ é™¤"å’Œ"é‡æ–°åˆ›å»º"çš„åŒä¸€ä¸ªåç§°çš„å¯¹è±¡,ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨ç”Ÿ æˆ



**å¯é€‰å­—æ®µï¼š**

- **labels**: è®¾å®šç”¨äºŽæ ‡è¯†å½“å‰å¯¹è±¡çš„æ ‡ç­¾ï¼Œé”®å€¼æ•°æ®ï¼Œæ ¼å¼ï¼škey1: value1 ,å¸¸ç”¨ä½œæ ‡ç­¾é€‰æ‹©å™¨çš„æŒ‘é€‰æ¡ä»¶
- **annotation**: éžæ ‡è¯†åž‹é”®å€¼æ•°æ®ï¼Œæ ¼å¼ï¼škey1: value1,ç”¨æ¥ä½œä¸ºæŒ‘é€‰æ¡ä»¶ï¼Œç”¨äºŽ labels çš„è¡¥å……ï¼Œä¸æ”¯æŒæ ‡ç­¾é€‰æ‹©å™¨çš„é€‰æ‹©
- **resourceVersion**:å½“å‰å¯¹è±¡çš„å†…éƒ¨ç‰ˆæœ¬æ ‡è¯†ï¼Œç”¨æ¥è®©å®¢æˆ·ç«¯ç¡®å®šå¯¹è±¡çš„å˜åŠ¨ä¸Žå¦
- **generation**: æ ‡è¯†å½“å‰å¯¹è±¡ç›®æ ‡çŠ¶æ€çš„ä»£åˆ«
- **creationTimestamp**: å½“å‰å¯¹è±¡åˆ›å»ºæ—¥æœŸçš„æ—¶é—´æˆ³
- **deletionTimestamp**: å½“å‰å¯¹è±¡åˆ é™¤æ—¥æœŸçš„æ—¶é—´æˆ³



####  spec å’Œ status å­—æ®µ

å®šä¹‰èµ„æºé…ç½®æ¸…å•æ—¶ï¼Œspec æ˜¯å¿…é¡»çš„å­—æ®µã€‚ç”¨äºŽæè¿°å¯¹è±¡çš„ç›®æ ‡çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æœŸæœ›å¯¹è±¡æ‰€è¡¨çŽ°å‡ºæ¥çš„ç‰¹å¾ã€‚

**spec å­—æ®µ**

- Specification è§„æ ¼å­—æ®µ
- æ­¤å­—æ®µå¯¹äºŽä¸åŒçš„å¯¹è±¡ç±»åž‹æ¥è¯´å„ä¸ç›¸åŒï¼Œå…·ä½“å­—æ®µå«ä¹‰åŠæ‰€æŽ¥å—çš„æ•°æ®ç±»åž‹éœ€è¦å‚ç…§ Kubernets  API æ‰‹å†Œä¸­çš„è¯´æ˜Žè¿›è¡ŒèŽ·å–ã€‚å¯é€šè¿‡å‘½ä»¤  **kubectl explain KIND.spec** èŽ·å–å…·ä½“å¸®åŠ©



**status å­—æ®µ**

- æ­¤å­—æ®µè®°å½•å¯¹è±¡çš„å½“å‰å®žé™…è¿è¡Œçš„çŠ¶æ€ï¼Œç”± Kubernetes ç³»ç»Ÿè´Ÿè´£æ›´æ–°ï¼Œç”¨æˆ·ä¸èƒ½æ‰‹åŠ¨å®šä¹‰ã€‚
- Master èŠ‚ç‚¹çš„ controller manager é€šè¿‡ç›¸åº”çš„æŽ§åˆ¶å™¨ç»„ä»¶åŠ¨æ€ç®¡ç†å¹¶ç¡®ä¿å¯¹è±¡çš„å®žé™…è½¬æ€åŒ¹é…ç”¨ æˆ·æ‰€æœŸæœ›çš„çŠ¶æ€ã€‚æ¯”å¦‚:Deployment æ˜¯ä¸€ç§æè¿°é›†ç¾¤ä¸­è¿è¡Œåº”ç”¨çš„èµ„æºå¯¹è±¡ï¼Œå› æ­¤ï¼Œåˆ›å»º  Deployment ç±»åž‹å¯¹è±¡æ—¶ï¼Œéœ€è¦ä¸ºç›®æ ‡ Deployment å¯¹è±¡è®¾å®š specï¼ŒæŒ‡å®šæœŸæœ›éœ€è¦è¿è¡Œçš„ Pod å‰¯ æœ¬æ•°é‡ã€ä½¿ç”¨çš„æ ‡ç­¾é€‰æ‹©å™¨ä»¥åŠ Pod æ¨¡æ¿ç­‰ã€‚åœ¨åˆ›å»ºæ—¶ï¼ŒKubernetes ç›¸å…³ç»„ä»¶è¯»å–å¾…åˆ›å»ºçš„  Deployment å¯¹è±¡çš„ specä»¥åŠç³»ç»Ÿä¸Šç›¸åº”çš„æ´»åŠ¨å¯¹è±¡çš„å½“å‰çŠ¶æ€ï¼Œå¿…è¦æ—¶å¯¹æ´»åŠ¨çš„å¯¹è±¡æ›´æ–°ä»¥ç¡® ä¿ status å­—æ®µå»åˆ spec å­—æ®µä¸­æœŸæœ›çš„çŠ¶æ€ã€‚
- **æ³¨æ„ï¼š**æ•°æ®ç±»çš„èµ„æºå¯¹è±¡æ— spec, Status å­—æ®µï¼Œæ¯”å¦‚ï¼šconfigmapsï¼Œsecrets ï¼Œ endpoints ç­‰



#### ä½¿ç”¨å‘½ä»¤ç”Ÿæˆæ¸…å•æ–‡ä»¶

``````yaml
# ä¸æ‰§è¡Œï¼Œè€Œæ˜¯ç”Ÿäº§å¯¹åº”çš„æ¸…å•æ–‡æœ¬å†…å®¹è¾“å‡ºåˆ°ç»ˆç«¯
kubectl create deployment myapp --image registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v1.0 --replicas 3 --dry-run=client -o yaml

apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: myapp
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: myapp
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v1.0
        name: myapp
        resources: {}
status: {}


# å°†å…¶è¾“å…¥åˆ°æ–‡ä»¶
kubectl create deployment myapp --image registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v1.0 --replicas 3 --dry-run=client -o yaml > myapp.yaml

# å¾—åˆ°èµ„æºæ¸…å•åŽï¼Œå¯ä»¥æ ¹æ®éœ€æ±‚è¿›è¡Œæ›´æ”¹
``````



#### åŸºäºŽçŽ°æœ‰èµ„æºç”Ÿæˆæ¸…å•æ–‡ä»¶

```yaml
# æŸ¥çœ‹çŽ°æœ‰Servicesèµ„æº
[root@master1 ~]# kubectl get services
NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
kubernetes   ClusterIP   10.96.0.1       <none>        443/TCP        7h4m
myapp        NodePort    10.98.161.155   <none>        80:31021/TCP   5h29m

# åŸºäºŽmyappï¼Œè¾“å‡ºå®ƒçš„èµ„æºæ¸…å•æ–‡ä»¶
[root@master1 ~]# kubectl get services myapp -o yaml
apiVersion: v1
kind: Service
metadata:
  creationTimestamp: "2024-12-15T12:03:41Z"
  labels:
    app: myapp
  name: myapp
  namespace: default
  resourceVersion: "13753"
  uid: e9d14260-ef75-4256-8887-200867c3d60a
spec:
  clusterIP: 10.98.161.155
  clusterIPs:
  - 10.98.161.155
  externalTrafficPolicy: Cluster
  internalTrafficPolicy: Cluster
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - name: 80-80
    nodePort: 31021
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: myapp
  sessionAffinity: None
  type: NodePort
status:
  loadBalancer: {}
```



#### èµ„æºæ¸…å•æ ¼å¼æ–‡æ¡£å¸®åŠ©Explain

```bash
[root@master1 ~]#kubectl explain pod
KIND:       Pod
VERSION:    v1

DESCRIPTION:
    Pod is a collection of containers that can run on a host. This resource is
    created by clients and scheduled onto hosts.
    
FIELDS:
  apiVersion	<string>
    APIVersion defines the versioned schema of this representation of an object.
    Servers should convert recognized schemas to the latest internal value, and
    may reject unrecognized values. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

  kind	<string>
    Kind is a string value representing the REST resource this object
    represents. Servers may infer this from the endpoint the client submits
    requests to. Cannot be updated. In CamelCase. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

  metadata	<ObjectMeta>
    Standard object's metadata. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

  spec	<PodSpec>
    Specification of the desired behavior of the pod. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status

  status	<PodStatus>
    Most recently observed status of the pod. This data may not be up to date.
    Populated by the system. Read-only. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status

# é€’è¿›æŸ¥è¯¢
[root@master1 ~]#kubectl explain pod.spec
KIND:       Pod
VERSION:    v1

FIELD: spec <PodSpec>


DESCRIPTION:
    Specification of the desired behavior of the pod. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status
    PodSpec is a description of a pod.
    
FIELDS:
  activeDeadlineSeconds	<integer>
    Optional duration in seconds the pod may be active on the node relative to
    StartTime before the system will actively try to mark it failed and kill
    associated containers. Value must be a positive integer.

  affinity	<Affinity>
    If specified, the pod's scheduling constraints

  automountServiceAccountToken	<boolean>
    AutomountServiceAccountToken indicates whether a service account token
    should be automatically mounted.

  containers	<[]Container> -required-
    List of containers belonging to the pod. Containers cannot currently be
    added or removed. There must be at least one container in a Pod. Cannot be
    updated.

  dnsConfig	<PodDNSConfig>
    Specifies the DNS parameters of a pod. Parameters specified here will be
    merged to the generated DNS configuration based on DNSPolicy.
...
```





#### èµ„æºå¯¹è±¡çš„ç®¡ç†æ–¹å¼

kubectl å‘½ä»¤å¯åˆ†ä¸ºä¸‰ç±»å‘½ä»¤ï¼š

- **æŒ‡ä»¤å¼å‘½ä»¤(imperative command)**

  - æŒ‡ä»¤å¼å‘½ä»¤åŒ…æ‹¬**kubectl run/expose/delete/ge**tç­‰å‘½ä»¤
  - é€‚åˆå®Œæˆä¸€æ¬¡æ€§çš„æ“ä½œä»»åŠ¡

  

- **æŒ‡ä»¤å¼å¯¹è±¡é…ç½®(imperative object configuration)**

  - æŒ‡ä»¤å¼å¯¹è±¡é…ç½®ç®¡ç†åŒ…æ‹¬**kubectl create/delete/get/replace/edit**ç­‰
  - åŸºäºŽèµ„æºé…ç½®æ–‡ä»¶æ‰§è¡Œå¯¹è±¡ç®¡ç†æ“ä½œï¼Œä½†åªèƒ½ç‹¬ç«‹å¼•ç”¨æ¯ä¸ªé…ç½®æ¸…å•æ–‡ä»¶
  - **æ­¤æ–¹å¼æ²¡æœ‰å¹‚ç­‰æ€§,é‡å¤æ‰§è¡Œå¯èƒ½ä¼šå‡ºé”™,ç”Ÿäº§ä¸æŽ¨èä½¿ç”¨**

  

- **å£°æ˜Žå¼å¯¹è±¡é…ç½®(declarative object configration)**

  - åŸºäºŽèµ„æºé…ç½®æ–‡ä»¶æ‰§è¡Œå¯¹è±¡ç®¡ç†æ“ä½œ
  - å¯ç›´æŽ¥å¼•ç”¨ç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®æ¸…å•æ–‡ä»¶ï¼Œä¹Ÿå¯ç›´æŽ¥ä½œç”¨äºŽå•ä¸ªé…ç½®æ–‡ä»¶
  - èµ„æºå¯¹è±¡çš„åˆ›å»ºã€åˆ é™¤åŠä¿®æ”¹æ“ä½œå…¨éƒ¨é€šè¿‡å‘½ä»¤**kubectl apply/patch**ç­‰æ¥å®Œæˆï¼Œå¹¶ä¸”æ¯æ¬¡æ“ä½œ æ—¶ï¼Œæä¾›ç»™å‘½ä»¤çš„é…ç½®ä¿¡æ¯éƒ½å°†ä¿å­˜äºŽå¯¹è±¡çš„æ³¨é‡Šä¿¡æ¯(kubectl.kubernetes.io/last-applied configuration)ä¸­ï¼Œ

  

  ```bash
  kubectl apply -f /path/file -f .....    #åŠ è½½æŒ‡å®šæ–‡ä»¶
  kubectl apply -f /path                  #åŠ è½½æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰ä»¥.yaml,.yml,.jsonåŽç¼€çš„æ–‡ä»¶
  kubectl apply -f /path -f /path1/path2  # ä¸æ”¯æŒé€’å½’ï¼Œæ‰€ä»¥å¦‚æžœç›®å½•ä¸‹æœ‰å­ç›®å½•ï¼Œéœ€è¦å¤šä¸ª-fåˆ†åˆ«åŠ è½½
  kubectl apply -f URL                    #åŠ è½½URLçš„æ–‡ä»¶
  ```

  



### åç§°ç©ºé—´



#### åç§°ç©ºé—´è¯´æ˜Ž

![alt text](images\image30.png)



Kubernetes çš„èµ„æºå·¥ä½œçš„æœ‰æ•ˆèŒƒå›´åˆ†æˆä¸¤ç§çº§åˆ«:

- **é›†ç¾¤çº§åˆ«**: é’ˆå¯¹æ•´ä¸ªKubernetesé›†ç¾¤å†…éƒ½æœ‰æ•ˆ
  - 
- **åç§°ç©ºé—´çº§åˆ«**: åªé’ˆå¯¹æŒ‡å®šåç§°ç©ºé—´å†…æœ‰æ•ˆ,è€Œä¸å±žäºŽä»»åŠ¡åç§°ç©ºé—´



##### **åç§°ç©ºé—´çš„ä½œç”¨**

- åç§°ç©ºé—´ Namespace ç”¨äºŽå°†é›†ç¾¤åˆ†éš”ä¸ºå¤šä¸ªéš”ç¦»çš„é€»è¾‘åˆ†åŒºä»¥é…ç½®ç»™ä¸åŒçš„ç”¨æˆ·ã€ç§Ÿæˆ·ã€çŽ¯å¢ƒæˆ–è€…é¡¹ç›®ä½¿ç”¨ã€‚
- åç§°ç©ºé—´é™å®šäº†èµ„æºå¯¹è±¡å·¥ä½œåœ¨æŒ‡å®šçš„åç§°èŒƒå›´å†…çš„ä½œç”¨åŸŸ
- **æ³¨æ„: åç§°ç©ºé—´æœ¬èº«æ˜¯ Kubernetes é›†ç¾¤çº§åˆ«çš„èµ„æº**



##### **åç§°ç©ºé—´çš„ä½¿ç”¨åœºæ™¯**

- **çŽ¯å¢ƒç®¡ç†**ï¼šéœ€è¦åœ¨åŒä¸€Kubernetesé›†ç¾¤ä¸Šéš”ç¦»ç ”å‘ã€é¢„å‘å’Œç”Ÿäº§ç­‰ä¸€ç±»çš„çŽ¯å¢ƒæ—¶ï¼Œå¯ä»¥é€šè¿‡åç§°ç©ºé—´è¿›è¡Œ
- **éš”ç¦»**ï¼šå¤šä¸ªé¡¹ç›®å›¢é˜Ÿçš„ä¸åŒäº§å“çº¿éœ€è¦éƒ¨ç½²äºŽåŒä¸€Kubernetesé›†ç¾¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨åç§°ç©ºé—´è¿›è¡Œéš”ç¦»
- **èµ„æºæŽ§åˆ¶**ï¼šåç§°ç©ºé—´å¯ç”¨ä½œèµ„æºé…é¢çš„æ‰¿è½½å•ä½ï¼Œä»Žè€Œé™åˆ¶å…¶å†…éƒ¨æ‰€æœ‰åº”ç”¨å¯ä»¥ä½¿ç”¨çš„CPU/Memory/PVå„è‡ª çš„èµ„æºæ€»å’Œ
  - éœ€è¦åœ¨äº§å“çº¿æˆ–å›¢é˜Ÿç­‰éš”ç¦»ç›®æ ‡ä¸Šåˆ†é…å„è‡ªæ€»ä½“å¯ç”¨çš„ç³»ç»Ÿèµ„æºæ—¶ï¼Œå¯é€šè¿‡åç§°ç©ºé—´å®žçŽ°
- **æƒé™æŽ§åˆ¶**ï¼šåŸºäºŽRBACé‰´æƒä½“ç³»ï¼Œèƒ½å¤Ÿåœ¨åç§°ç©ºé—´çº§åˆ«è¿›è¡Œæƒé™é…ç½®
- **æé«˜é›†ç¾¤æ€§èƒ½**ï¼šè¿›è¡Œèµ„æºæœç´¢æ—¶ï¼Œåç§°ç©ºé—´æœ‰åˆ©äºŽKubernetes APIç¼©å°æŸ¥æ‰¾èŒƒå›´ï¼Œä»Žè€Œå¯¹å‡å°‘æœç´¢å»¶è¿Ÿå’Œæå‡æ€§èƒ½ æœ‰ä¸€å®šçš„å¸®åŠ©





##### **åç§°ç©ºé—´åˆ†ç±»**ï¼ˆ**ä¸¤ç±»**ï¼‰

- **ç³»ç»Ÿçº§åç§°ç©ºé—´**
  - ç”±Kubernetesé›†ç¾¤é»˜è®¤åˆ›å»ºï¼Œä¸»è¦ç”¨æ¥éš”ç¦»ç³»ç»Ÿçº§çš„èµ„æºå¯¹è±¡ æ‰€æœ‰çš„ç³»ç»Ÿçº§åç§°ç©ºé—´å‡ä¸èƒ½è¿›è¡Œåˆ é™¤æ“ä½œï¼ˆå³ä½¿åˆ é™¤ä¹Ÿä¼šè‡ªåŠ¨é‡å»ºï¼‰ **é™¤defaultå¤–ï¼Œå…¶å®ƒä¸‰ä¸ªç³»ç»Ÿçº§åç§°ç©ºé—´**ä¸åº”è¯¥ç”¨ä½œä¸šåŠ¡åº”ç”¨çš„éƒ¨ç½²ç›®æ ‡
  - **default**ï¼šä¸ºä»»ä½•åç§°ç©ºé—´çº§åˆ«çš„èµ„æºæä¾›çš„é»˜è®¤çš„åç§°ç©ºé—´
  - **kuhe-system**ï¼šKubernetesé›†ç¾¤è‡ªèº«ç»„ä»¶åŠå…¶å®ƒç³»ç»Ÿçº§ç»„ä»¶ä½¿ç”¨çš„åç§°ç©ºé—´ï¼ŒKubernetesè‡ªèº«çš„ å…³é”®ç»„ä»¶å‡éƒ¨ç½²åœ¨è¯¥åç§°ç©ºé—´ä¸­
  - **kube-public**ï¼šå…¬ä¼—å¼€æ”¾çš„åç§°ç©ºé—´ï¼Œæ‰€æœ‰ç”¨æˆ·ï¼ˆåŒ…æ‹¬Anonymousï¼‰éƒ½å¯ä»¥è¯»å–å†…éƒ¨çš„èµ„æº,é€šå¸¸ä¸ºç©º
  - **kube-node-lease**ï¼šèŠ‚ç‚¹ç§Ÿçº¦èµ„æºæ‰€ç”¨çš„åç§°ç©ºé—´
    - åˆ†å¸ƒå¼ç³»ç»Ÿé€šå¸¸ä½¿ç”¨â€œç§Ÿçº¦(Leqse)â€æœºåˆ¶æ¥é”å®šå…±äº«èµ„æºå¹¶åè°ƒé›†ç¾¤æˆå‘˜ä¹‹é—´çš„æ´»åŠ¨ Kubernetesä¸Šçš„ç§Ÿçº¦æ¦‚å¿µç”±APIç¾¤ç»„coordination.k8s.ioç¾¤ç»„ä¸‹çš„Leaseèµ„æºæ‰€æ‰¿è½½ï¼Œä»¥æ”¯æ’‘ç³»ç»Ÿ çº§åˆ«çš„åŠŸèƒ½éœ€æ±‚ï¼Œä¾‹å¦‚èŠ‚ç‚¹å¿ƒè·³( node heartbeats)å’Œç»„ä»¶çº§çš„é¢†å¯¼é€‰ä¸¾ç­‰ Kubernetesé›†ç¾¤çš„æ¯ä¸ªç®¡ç†ç»„ä»¶åœ¨è¯¥åç§°ç©ºé—´ä¸‹éƒ½æœ‰ä¸€ä¸ªä¸ŽåŒåçš„Ieaseèµ„æºå¯¹è±¡ 
    - `~# kubectl -n kube-node-lease get lease`



- **è‡ªå®šä¹‰åç§°ç©ºé—´**
  - ç”±ç”¨æˆ·æŒ‰éœ€åˆ›å»º
  - æ¯”å¦‚: æ ¹æ®é¡¹ç›®å’Œåœºæ™¯, åˆ†åˆ«åˆ›å»ºå¯¹åº”ä¸åŒçš„åç§°ç©ºé—´





#### æŸ¥çœ‹åç§°ç©ºé—´åŠèµ„æºå¯¹è±¡

```bash
[root@master1 ~]#kubectl get ns
NAME              STATUS   AGE
default           Active   65m
kube-flannel      Active   63m
kube-node-lease   Active   65m
kube-public       Active   65m
kube-system  
Active   65m


[root@master1 ~]#kubectl get ns default -o yaml
apiVersion: v1
kind: Namespace
metadata:
  creationTimestamp: "2024-12-16T05:34:09Z"
  labels:
    kubernetes.io/metadata.name: default
  name: default
  resourceVersion: "42"
  uid: b650835c-84e8-464a-84af-4955cb56285e
spec:
  finalizers:
  - kubernetes
status:
  phase: Active
  
  
# æŸ¥çœ‹æŒ‡å®šä¿¡æ¯
[root@master1 ~]#kubectl get ns default -o jsonpath={.metadata.name}
default

[root@master1 ~]#kubectl get ns default -o jsonpath={.apiVersion}
v1

# æŸ¥çœ‹é»˜è®¤åç§°ä¸‹çš„èµ„æº
[root@master1 ~]# kubectl get all
NAME                         READY   STATUS    RESTARTS   AGE
pod/myapp-7b94444f8d-9xld5   1/1     Running   0          61m
pod/myapp-7b94444f8d-dhkdj   1/1     Running   0          61m
pod/myapp-7b94444f8d-ssp7z   1/1     Running   0          61m

NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
service/kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP   69m

NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/myapp   3/3     3            3           61m

NAME                               DESIRED   CURRENT   READY   AGE
replicaset.apps/myapp-7b94444f8d   3         3         3       61m

# æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´çš„èµ„æº
[root@master1 ~]# kubectl get all -n kube-system 
NAME                                  READY   STATUS    RESTARTS   AGE
pod/coredns-cb4864fb5-5rbqf           1/1     Running   0          70m
pod/coredns-cb4864fb5-mzd84           1/1     Running   0          70m
pod/etcd-master1                      1/1     Running   0          70m
pod/kube-apiserver-master1            1/1     Running   0          70m
pod/kube-controller-manager-master1   1/1     Running   0          70m
pod/kube-proxy-h2kx8                  1/1     Running   0          68m
pod/kube-proxy-kklfd                  1/1     Running   0          68m
pod/kube-proxy-kmzqq                  1/1     Running   0          70m
pod/kube-proxy-vlvhj                  1/1     Running   0          69m
pod/kube-scheduler-master1            1/1     Running   0          70m

NAME               TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
service/kube-dns   ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   70m

NAME                        DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
daemonset.apps/kube-proxy   4         4         4       4            4           kubernetes.io/os=linux   70m

NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/coredns   2/2     2            2           70m

NAME                                DESIRED   CURRENT   READY   AGE
replicaset.apps/coredns-cb4864fb5   2         2         2       70m


```



#### åˆ›å»ºNamespaceèµ„æº



##### **æŒ‡ä»¤å¼å‘½ä»¤åˆ›å»º**

ä½¿ç”¨æŒ‡ä»¤å¼å‘½ä»¤ `kubectl create` å¯ä»¥ç›´æŽ¥åˆ›å»ºåç§°ç©ºé—´ï¼Œåªéœ€æŒ‡å®šåç§°ç©ºé—´åç§°

```bash
[root@master1 ~]# kubectl create ns ns-mystical
namespace/ns-mystical created

[root@master1 ~]# kubectl get ns ns-mystical 
NAME          STATUS   AGE
ns-mystical   Active   8s
```

**æ³¨æ„**ï¼šå®žé™…ç”Ÿäº§ä¸­ä¸å»ºè®®ä½¿ç”¨æŒ‡ä»¤å¼å‘½ä»¤å’Œé…ç½®ï¼Œç›´æŽ¥ä½¿ç”¨å£°æ˜Žå¼å°±å¯ä»¥ã€‚



##### **æŒ‡ä»¤å¼é…ç½®åˆ›å»º**

`kubectl create -f </path/to/namespace-obj.yaml `å®žçŽ°åˆ›å»º

æ­¤æ–¹å¼ç”Ÿäº§ä¸å»ºè®®ä½¿ç”¨,æ‰§è¡Œæ­¤å‘½ä»¤éœ€è¦æŒ‡å®šçš„namespaceä¸å­˜åœ¨

```bash
[root@master1 ~]#vim namespace-test1.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: namespace-test1

# åˆ›å»º
[root@master1 ~]#kubectl create -f namespace-test1.yaml 
namespace/namespace-test1 created

# æŸ¥çœ‹
[root@master1 ~]#kubectl get ns namespace-test1 
NAME              STATUS   AGE
namespace-test1   Active   8s
```



##### å£°æ˜Žå¼é…ç½®åˆ›å»º

Namespace æ˜¯ Kubernetes API çš„æ ‡å‡†èµ„æºç±»åž‹ä¹‹ä¸€ï¼Œå…¶é…ç½®ä¸»è¦æœ‰ kindã€apiVolumeã€metadata å’Œ spec ç­‰ä¸€çº§å­—æ®µç»„æˆã€‚ä½¿ç”¨ kubectl create/apply -f /path/to/namespace-obj.yaml å‘½ä»¤å°±å¯ä»¥ åˆ›å»ºåç§°ç©ºé—´èµ„æº

```bash
[root@master1 ~]#vim namespace-test2.yaml 

[root@master1 ~]#cat namespace-test2.yaml 
apiVersion: v1
kind: Namespace
metadata:
  name: namespace-test2
  
[root@master1 ~]#kubectl apply -f namespace-test2.yaml 
namespace/namespace-test2 created

[root@master1 ~]#kubectl get namespaces namespace-test2 
NAME              STATUS   AGE
namespace-test2   Active   16s

# ä½¿ç”¨å‘½ä»¤ç”Ÿæˆå£°æ˜Žå¼yamlæ–‡ä»¶
[root@master1 ~]# kubectl create ns stage --dry-run=client -o yaml > stage-ns.yaml
[root@master1 ~]# cat stage-ns.yaml 
apiVersion: v1
kind: Namespace
metadata:
  creationTimestamp: null
  name: stage
spec: {}
status: {}
```



#### åˆ é™¤Namespaceèµ„æº

æ³¨æ„: **åˆ é™¤ Namespace ä¼šçº§è”åˆ é™¤æ­¤åç§°ç©ºé—´çš„æ‰€æœ‰èµ„æº**,éžå¸¸å±é™©

```bash
[root@master1 ~]#kubectl delete namespaces namespace-test1 
namespace "namespace-test1" deleted

[root@master1 ~]#kubectl delete -f namespace-test2.yaml 
namespace "namespace-test2" deleted

# åœ¨æŒ‡å®šåç§°ç©ºé—´ä¸‹åˆ›å»ºèµ„æº
[root@master1 ~]#kubectl apply -f myapp.yaml -n ns-mystical 
deployment.apps/myapp created

# æŸ¥çœ‹æŒ‡å®šåç§°ç©ºé—´(ns-mystical)ä¸‹çš„æŒ‡å®šèµ„æº(pod)
[root@master1 ~]#kubectl get pod -n ns-mystical 
NAME                     READY   STATUS    RESTARTS   AGE
myapp-7b94444f8d-6ms2c   1/1     Running   0          23s
myapp-7b94444f8d-c9g6n   1/1     Running   0          23s
myapp-7b94444f8d-l5bgb   1/1     Running   0          23s

# åˆ é™¤æŒ‡å®šåç§°ç©ºé—´
[root@master1 ~]#kubectl delete namespaces ns-mystical 
namespace "ns-mystical" deleted

# æ‰€æœ‰æ­¤åç§°ç©ºé—´ä¸‹çš„èµ„æºéƒ½è¢«åˆ é™¤
[root@master1 ~]#kubectl get -n ns-mystical all
No resources found in ns-mystical namespace.
```





#### åˆ é™¤æŒ‡å®šåç§°ç©ºé—´çš„èµ„æº 

ä½¿ç”¨ kubectl ç®¡ç†èµ„æºæ—¶ï¼Œå¦‚æžœæä¾›äº†åç§°ç©ºé—´é€‰é¡¹ï¼Œå°±è¡¨ç¤ºæ­¤ç®¡ç†æ“ä½œä»…é’ˆå¯¹æŒ‡å®šåç§°ç©ºé—´è¿›è¡Œï¼Œè€Œ åˆ é™¤ Namespace èµ„æºåˆ™ä¼šçº§è”åˆ é™¤å…¶åŒ…å«çš„æ‰€æœ‰å…¶ä»–èµ„æºå¯¹è±¡

| å‘½ä»¤æ ¼å¼                        | åŠŸèƒ½                                   |
| ------------------------------- | -------------------------------------- |
| kubectl delete TYPE RESOURCE -n | åˆ é™¤æŒ‡å®šåç§°ç©ºé—´å†…çš„æŒ‡å®šèµ„æº           |
| kubectl delete TYPE --all -n    | åˆ é™¤æŒ‡å®šåç§°ç©ºé—´å†…çš„æŒ‡å®šç±»åž‹çš„æ‰€æœ‰èµ„æº |
| kubectl delete all -n           | åˆ é™¤æŒ‡å®šåç§°ç©ºé—´å†…çš„æ‰€æœ‰èµ„æº           |
| kubectl delete all --all        | åˆ é™¤æ‰€æœ‰åç§°ç©ºé—´ä¸­çš„æ‰€æœ‰èµ„æº           |



### Podèµ„æº



#### Podèµ„æºåŸºç¡€

Pod æ˜¯ Kubernetes API ä¸­æœ€å¸¸è§æœ€æ ¸å¿ƒèµ„æºç±»åž‹

**Pod æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨çš„é›†åˆ**ï¼Œå› è€Œä¹Ÿå¯ç§°ä¸ºå®¹å™¨é›†ï¼Œä½†å´æ˜¯Kubernetesè°ƒåº¦ã€éƒ¨ç½²å’Œè¿è¡Œåº”ç”¨çš„åŽŸå­å•å…ƒ

- åŒä¸€Podå†…çš„æ‰€æœ‰å®¹å™¨éƒ½å°†è¿è¡ŒäºŽç”±Scheduleré€‰å®šçš„åŒä¸€ä¸ªworkerèŠ‚ç‚¹ä¸Š
- åœ¨åŒä¸€ä¸ªpodå†…çš„å®¹å™¨å…±äº«çš„**å­˜å‚¨èµ„æº**ã€**ç½‘ç»œåè®®æ ˆ**åŠå®¹å™¨çš„**è¿è¡ŒæŽ§åˆ¶ç­–ç•¥**ç­‰
- æ¯ä¸ªPodä¸­çš„å®¹å™¨ä¾èµ–äºŽä¸€ä¸ªç‰¹æ®Šåä¸º**pauseå®¹å™¨**äº‹å…ˆåˆ›å»ºå‡ºå¯è¢«å„åº”ç”¨å®¹å™¨å…±äº«çš„**åŸºç¡€çŽ¯å¢ƒ**ï¼ŒåŒ…æ‹¬ Networkã€IPCå’ŒUTSåç§°ç©ºé—´å…±äº«ç»™Podä¸­å„ä¸ªå®¹å™¨ï¼ŒPIDåç§°ç©ºé—´ä¹Ÿå¯ä»¥å…±äº«ï¼Œä½†éœ€è¦ç”¨æˆ·æ˜¾å¼å®š ä¹‰,**Mountå’ŒUseræ˜¯ä¸å…±äº«çš„**,æ¯ä¸ªå®¹å™¨æœ‰ç‹¬ç«‹çš„Mount,Userçš„åç§°ç©ºé—´


![alt text](images/image31.png)



Podçš„ç»„æˆå½¢å¼æœ‰ä¸¤ç§

- **å•å®¹å™¨Pod**ï¼šé™¤Pauseå®¹å™¨å¤–,ä»…å«æœ‰ä¸€ä¸ªå®¹å™¨
- **å¤šå®¹å™¨Pod**ï¼šé™¤Pauseå®¹å™¨å¤–ï¼Œå«æœ‰å¤šä¸ªå…·æœ‰â€œè¶…äº²å¯†â€å…³ç³»çš„å®¹å™¨ï¼Œä¸€èˆ¬ç”±ä¸»å®¹å™¨å’Œè¾…åŠ©å®¹å™¨ï¼ˆæ¯” å¦‚ï¼š**sidecarå®¹å™¨**ï¼‰æž„æˆ



**Podèµ„æºåˆ†ç±»**

- **è‡ªä¸»å¼ Pod**
  - ç”±ç”¨æˆ·ç›´æŽ¥å®šä¹‰å¹¶æäº¤ç»™API Serveråˆ›å»ºçš„Pods
- **ç”±Workload Controllerç®¡æŽ§çš„ Pod**
  - æ¯”å¦‚: ç”±DeploymentæŽ§åˆ¶å™¨ç®¡ç†çš„Pod
- **é™æ€ Pod**
  - ç”±kubeletåŠ è½½é…ç½®ä¿¡æ¯åŽï¼Œè‡ªåŠ¨åœ¨å¯¹åº”çš„èŠ‚ç‚¹ä¸Šåˆ›å»ºçš„Pod
  - ç”¨äºŽå®žçŽ°MasterèŠ‚ç‚¹ä¸Šçš„ç³»ç»Ÿç»„ä»¶API Server ã€Controller-Manager ã€Scheduler å’ŒEtcdåŠŸèƒ½çš„ Pod
  - ç›¸å…³é…ç½®å­˜æ”¾åœ¨æŽ§åˆ¶èŠ‚ç‚¹çš„ **`/etc/kubernetes/manifests`** ç›®å½•ä¸‹



**æ€»ç»“ï¼š**

- Podä¸­æœ€å°‘æœ‰2ä¸ªå®¹å™¨
- Pod = **Pauseå®¹å™¨** + ä¸šåŠ¡å®¹å™¨



Podçš„ç®¡ç†é“¾

``````ABAP
# è‡ªå®šä¹‰podåˆ›å»ºæµç¨‹
kuebctl --> apiserver --> kubelet --> docker runc --> podå®¹å™¨

# åœ¨/etc/kubernetes/manifestsç›®å½•ä¸‹çš„yamlæ–‡ä»¶ï¼Œä¸éœ€è¦apiserverç®¡ç†ï¼Œä¼šç›´æŽ¥è¯»å–yamlæ–‡æœ¬æ‰§è¡Œåˆ›å»ºpod

# é™æ€podåˆ›å»ºæµç¨‹
/etc/kubernetes/mainfestsç›®å½•ä¸‹yamlæ–‡ä»¶ ---> kubelet --> docker runc --> ETCD | ApiServer Pod ...
``````



```bash
[root@master1 manifests]#ll /etc/kubernetes/manifests/
æ€»è®¡ 24
drwxrwxr-x 2 root root 4096 12æœˆ 16 13:33 ./
drwxrwxr-x 4 root root 4096 12æœˆ 16 13:33 ../
-rw------- 1 root root 2408 12æœˆ 16 13:33 etcd.yaml
-rw------- 1 root root 4046 12æœˆ 16 13:33 kube-apiserver.yaml
-rw------- 1 root root 3567 12æœˆ 16 13:33 kube-controller-manager.yaml
-rw-r--r-- 1 root root    0 12æœˆ 10 20:09 .kubelet-keep
-rw------- 1 root root 1487 12æœˆ 16 13:33 kube-scheduler.yaml
```





#### è‡ªä¸»å¼Pod



##### æŒ‡ä»¤å¼å‘½ä»¤åˆ›å»ºPod

é€šè¿‡kubectl å‘½ä»¤è¡Œå·¥å…·æŒ‡å®šé€‰é¡¹åˆ›å»º Podï¼Œé€‚åˆ**ä¸´æ—¶æ€§**å·¥ä½œ

åŸºæœ¬è¯­æ³•

```bash
kubectl run NAME --image=image [--port=port] [--replicas=replicas] 

kubectl run NAME --image=image [--env="key=value"] [--port=port] [--dryrun=server|client] [--overrides=inline-json] [--command] -- [COMMAND] [args...] [options]

#å‚æ•°è¯¦è§£
--image='' #æŒ‡å®šå®¹å™¨è¦è¿è¡Œçš„é•œåƒ
--port='' #è®¾å®šå®¹å™¨æš´éœ²çš„ç«¯å£
--dry-run=true #ä»¥æ¨¡æ‹Ÿçš„æ–¹å¼æ¥è¿›è¡Œæ‰§è¡Œå‘½ä»¤
--env=[] #æ‰§è¡Œçš„æ—¶å€™ï¼Œå‘å¯¹è±¡ä¸­ä¼ å…¥ä¸€äº›å˜é‡
--labels='' #è®¾å®špodå¯¹è±¡çš„æ ‡ç­¾
--limits='cpu=200m,memory=512Mi' #è®¾å®šå®¹å™¨å¯åŠ¨åŽçš„èµ„æºé…ç½®
--replicas=n #è®¾å®špodçš„å‰¯æœ¬æ•°é‡,æ–°ç‰ˆä¸å†æ”¯æŒ
--command=false     #è®¾ä¸ºtrueï¼Œå°† -- åŽé¢çš„å­—ç¬¦ä¸²åšä¸ºå‘½ä»¤ä»£æ›¿å®¹å™¨é»˜è®¤çš„å¯åŠ¨å‘½ä»¤ï¼Œè€Œéžåšä¸ºé»˜
è®¤å¯åŠ¨å‘½ä»¤çš„å‚æ•°
-it            #æ‰“å¼€äº¤äº’ç»ˆç«¯
--rm           #å³å‡ºå³åˆ é™¤å®¹å™¨
--restart=Never #ä¸ä¼šé‡å¯
```



ç¤ºä¾‹

```bash
#åˆå§‹åŒ–ä¸€ä¸ªPodå¯¹è±¡ï¼ŒåŒ…å«ä¸€ä¸ªnginxå®¹å™¨
[root@master1 manifests]#kubectl run myapp-pod --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v1.0
pod/myapp-pod created

#åˆ›å»ºBusyboxçš„Pod,é»˜è®¤busyboxæ²¡æœ‰å‰å°è¿›ç¨‹,éœ€è¦æŒ‡å®šå‰å°ç¨‹åºæ‰èƒ½æŒç»§è¿è¡Œ
[root@master1 manifests]#kubectl run busbox --image busybox:1.30 -- sleep 3600
pod/busbox created

[root@master1 manifests]#kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
busbox                   1/1     Running   0          17s

# è¿›å…¥å®¹å™¨
[root@master1 manifests]#kubectl exec -it busbox -- sh
/ # 

# è¿è¡Œpodæ—¶å®šä¹‰ä¸€ä¸ªå˜é‡
[root@master1 manifests]#kubectl run busybox --image busybox:1.30 --env="NAME=mystical" -- sleep 3600
pod/busybox created

[root@master1 manifests]#kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
busybox                  1/1     Running   0          8s
myapp-7b94444f8d-9xld5   1/1     Running   0          133m
myapp-7b94444f8d-dhkdj   1/1     Running   0          133m
myapp-7b94444f8d-ssp7z   1/1     Running   0          133m
myapp-pod                1/1     Running   0          8m28s

[root@master1 manifests]#kubectl exec -it busybox -- sh
/ # echo $NAME
mystical
```



#### podèµ„æºæ¸…å•è¯´æ˜Ž



##### yamlæ ¼å¼çš„Podæ¸…å•æ–‡ä»¶-æžç®€ç‰ˆ

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: myapp2
  namespace: m58-namespace
spec:
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v1.0
    name: myapp2
```



##### yamlæ ¼å¼çš„Podæ¸…å•æ–‡ä»¶å®žä¾‹-å®Œæ•´ç‰ˆ

```yaml
# yamlæ ¼å¼çš„Podå®šä¹‰æ–‡ä»¶å®Œæ•´å†…å®¹
apiVersion: v1
kind: Pod
metadata:
  name: string
  namespace: string
  labels:
    name: string
  annotations:
    name: string
spec:
  initContainers:
  - name: string
    image: string
    imagePullPolicy: Always  # Options: Always, Never, IfNotPresent
    command: 
      - string
    args: 
      - string
  containers:
  - name: string
    image: string
    imagePullPolicy: Always  # Options: Always, Never, IfNotPresent
    command: 
      - string
    args: 
      - string
    workingDir: string
    volumeMounts:
    - name: string
      mountPath: string
      readOnly: true  # Options: true, false
    ports:
    - name: string
      containerPort: 80  # Replace with the correct port
      hostPort: 80  # Replace with the correct port
      protocol: TCP  # Options: TCP, UDP, SCTP
    env:
    - name: string
      value: string
    resources:
      limits:
        cpu: "500m"  # Replace with actual limit
        memory: "128Mi"  # Replace with actual limit
      requests:
        cpu: "250m"  # Replace with actual request
        memory: "64Mi"  # Replace with actual request
    startupProbe:
      httpGet:
        path: /healthz
        port: 80  # Replace with actual port
    livenessProbe:
      exec:
        command: 
          - string
      httpGet:
        path: /healthz
        port: 80  # Replace with actual port
        host: localhost  # Replace with actual host
        scheme: HTTP  # Options: HTTP, HTTPS
        httpHeaders:
        - name: string
          value: string
      tcpSocket:
        port: 80  # Replace with actual port
      initialDelaySeconds: 10
      timeoutSeconds: 5
      periodSeconds: 10
      successThreshold: 1
      failureThreshold: 3
    securityContext:
      privileged: false  # Options: true, false
  restartPolicy: Always  # Options: Always, Never, OnFailure
  nodeSelector: 
    disktype: ssd  # Example node selector
  nodeName: string  # Replace with actual node name
  imagePullSecrets:
  - name: my-secret  # Replace with actual secret name
  hostNetwork: false  # Options: true, false
  volumes: 
  - name: empty-volume
    emptyDir: {}
  - name: host-path-volume
    hostPath:
      path: /data/volume  # Replace with actual path
  - name: secret-volume
    secret:
      secretName: string  # Replace with actual secret name
      items:     
      - key: string
        path: string
  - name: configmap-volume
    configMap:
      name: string  # Replace with actual ConfigMap name
      items:
      - key: string
        path: string
```



##### æ›´æ–°Podèµ„æº

```bash
# æ–¹æ³•1
# å¯¼å‡ºé…ç½®
# kubectl get pods pod-test1 -o yaml pod-test1-update.yaml

# ç¼–è¯‘å¯¼å‡ºçš„é…ç½®æ¸…å•
[root@master1 ~]# vim myapp-pod-update.yaml 
apiVersion: v1
kind: Pod
metadata:
  creationTimestamp: "2024-12-16T07:47:09Z"
  labels:
    run: myapp-pod
  name: myapp-pod
  namespace: default
  resourceVersion: "13553"
  uid: 6e9fe649-9761-4d71-a7f9-9e8423e105b4
spec:
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:1.0  # æ”¹ä¸ºmyapp:2.0
    imagePullPolicy: IfNotPresent
...

# æ›´æ–°
kubectl replace -f myapp-pod-update.yaml # replaceä¸å»ºè®®ä½¿ç”¨ï¼Œæ²¡æœ‰å¹‚ç­‰æ€§ï¼Œå»ºè®®apply

# éªŒè¯æ˜¯å¦ä¿®æ”¹
[root@master1 ~]# kubectl describe -f myapp-pod-update.yaml
...
Events:
  Type    Reason     Age                  From               Message
  ----    ------     ----                 ----               -------
  Normal  Scheduled  48m                  default-scheduler  Successfully assigned default/myapp-pod to node1
  Normal  Pulled     48m                  kubelet            Container image "registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v1.0" already present on machine
  Normal  Pulling    5m23s                kubelet            Pulling image "registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v2.0"
  Normal  Pulled     5m12s                kubelet            Successfully pulled image "registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v2.0" in 10.467s (10.468s including waiting). Image size: 23012239 bytes.
  Normal  Killing    60s (x2 over 5m23s)  kubelet            Container myapp-pod definition changed, will be restarted
  Normal  Pulling    60s                  kubelet            Pulling image "registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v3.0"
  Normal  Created    43s (x3 over 48m)    kubelet            Created container myapp-pod
  Normal  Pulled     43s                  kubelet            Successfully pulled image "registry.cn-beijing.aliyuncs.com/wangxiaochun/myapp:v3.0" in 16.971s (16.971s including waiting). Image size: 23012239 bytes.
  Normal  Started    42s (x3 over 48m)    kubelet            Started container myapp-pod

```



##### å£°æ˜Žå¼å¯¹è±¡ç®¡ç†æ–¹å¼

**åˆ›å»º Pod èµ„æºå¯¹è±¡**

```bash
[root@master1 yaml]#kubectl apply -f pod-test1.yaml 
pod/pod-test1 created

[root@master1 yaml]#kubectl get -f pod-test1.yaml -o wide
NAME       READY   STATUS   RESTARTS   AGE   IP           NODE               
NOMINATED NODE   READINESS GATES
pod-test1   1/1     Running   0         5m8s   172.16.3.13   node1.wang.org   
<none>           <none>

[root@master1 ~]#curl 172.16.3.13 -I
HTTP/1.1 200 OK
Server: nginx/1.21.5
Date: Tue, 01 Mar 2022 04:32:32 GMT
Content-Type: text/html
Content-Length: 615
Last-Modified: Tue, 28 Dec 2021 15:28:38 GMT
Connection: keep-alive
ETag: "61cb2d26-267"
Accept-Ranges: bytes
```



**æ›´æ–°åº”ç”¨ç‰ˆæœ¬**

```bash
# æ›´æ–°å¯¹è±¡çš„æ“ä½œï¼Œå¯ä»¥ç›´æŽ¥åœ¨åŽŸæœ‰çš„èµ„æºæ¸…å•æ–‡ä»¶ä¸Šä¿®æ”¹åŽå†æ‰§è¡Œkubectl apply
# ç”Ÿäº§çŽ¯å¢ƒä¸‹ï¼Œå»ºè®®ä½¿ç”¨ï¼Œå…·æœ‰å¹‚ç­‰æ€§
[root@master1 yaml]#vim pod-test1.yaml
[root@master1 yaml]#cat pod-test1.yaml
apiVersion: v1
kind: Pod      
metadata:       
 name: pod-test1 
 labels:      
   app: test1  
   version: v1.0
spec:         
 containers:  
  - name: nginx-web01
   image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0 #ä¿®æ”¹æ­¤è¡Œ
   
#åº”ç”¨æ›´æ–°
[root@master1 yaml]#kubectl apply -f pod-test1.yaml 
pod/pod-test1 configured
```



#### PodæŸ¥çœ‹çŠ¶æ€

å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹Pod çŠ¶æ€

```bash
kubectl get pod <pod_name> [(-o|--output=)json|yaml|jsonpath] [-n namespace]
kubectl describe pod <pod_name> [-n namespace]
```



èŒƒä¾‹

``````bash
#æŸ¥çœ‹å½“å‰åç§°ç©ºé—´çš„æ‰€æœ‰pod
[root@master1 ~]# kubectl get pod

#æŸ¥çœ‹æ‰€æœ‰ç©ºé—´çš„æ‰€æœ‰pod
[root@master1 ~]# kubectl get pod -A

#æŸ¥çœ‹æŒ‡å®špodå½“å‰çŠ¶æ€ä¿¡æ¯
[root@master1 yaml]# kubectl get -f pod-test1.yaml 
[root@master1 ~]# kubectl get pod pod-test1 
[root@master1 ~]# kubectl get po pod-test1 #æ”¯æŒç¼©å†™po
NAME       READY   STATUS   RESTARTS   AGE
pod-test1   1/1     Running   0         67s

#æŒç»­æŸ¥çœ‹podçŠ¶æ€
# kubectl get pods pod-test1 -w

#æŸ¥çœ‹æ‰©å±•ä¿¡æ¯
[root@master1 ~]#kubectl get pod pod-test1 -o wide
NAME       READY   STATUS   RESTARTS   AGE   IP           NODE               
NOMINATED NODE   READINESS GATES
pod-test1   1/1     Running   0         88s   172.16.3.12   node1.wang.org   
<none>           <none>

#é€šè¿‡ -o yaml çš„æ–¹å¼æ¥è¿›è¡ŒæŸ¥çœ‹yamlæ ¼å¼çš„è¯¦ç»†ä¿¡æ¯
[root@master1 ~]#kubectl get pod pod-test -o yaml
apiVersion: v1
kind: Pod
metadata:
 annotations:
   kubectl.kubernetes.io/last-applied-configuration: |
......

#æŸ¥çœ‹podä¸Šé¢çš„label
[root@master1 ~]#kubectl get pod pod-test1 --show-labels
NAME       READY   STATUS   RESTARTS       AGE   LABELS
pod-test1   1/1     Running   7 (7h4m ago)   14d   app=test1,version=v2.0
``````



#### æŸ¥çœ‹Podä¸­æŒ‡å®šå®¹å™¨åº”ç”¨çš„æ—¥å¿—

```bash
kubectl logs [-f] (POD | TYPE/NAME) [-c CONTAINER] [options]
# é€‰é¡¹

-p å‰ä¸€ä¸ªå·²é€€å‡ºçš„å®¹å™¨çš„æ—¥å¿—
--all-containers=true æ‰€æœ‰å®¹å™¨
--tail=N æœ€åŽNä¸ªæ—¥å¿—

# ç¤ºä¾‹
[root@master1 ~]#kubectl logs myapp-pod 
10.244.0.0 - - [16/Dec/2024:16:34:39 +0800] "GET / HTTP/1.1" 200 31 "-" "curl/7.81.0"

# è¿›å…¥å®¹å™¨å†…æ‰§è¡Œæ“ä½œ
[root@master1 ~]#kubectl exec myapp-pod -- ps aux
PID   USER     TIME  COMMAND
    1 root      0:00 nginx: master process nginx -g daemon off;
    7 nginx     0:00 nginx: worker process
    8 root      0:00 ps aux
```



####  è¿›å…¥Pod æ‰§è¡Œå‘½ä»¤

```bash
kubectl exec (POD | TYPE/NAME) [-c CONTAINER] [flags] -- COMMAND [args...] [options]
```

èŒƒä¾‹

```bash
# äº¤äº’å¼æ‰§è¡Œ
[root@master1 ~]#kubectl exec -it myapp-pod -- sh
/ # ps aux
PID   USER     TIME  COMMAND
    1 root      0:00 nginx: master process nginx -g daemon off;
    7 nginx     0:00 nginx: worker process
   14 root      0:00 sh
   20 root      0:00 ps aux
```



#### åˆ é™¤ Pod

åˆ é™¤èµ„æºå¯¹è±¡æŽ¨èä½¿ç”¨æŒ‡ä»¤å¼ç®¡ç†å‘½ä»¤ `kubectl delete`

```bash
kubectl delete pod <pod_name> ... [--force --grace-period=0]
```



èŒƒä¾‹

```bash
#ä¼˜é›…åˆ é™¤
[root@master1 ~]#kubectl delete pod pod-test1

#ç«‹å³åˆ é™¤
[root@master1 ~]#kubectl delete pod pod-test1 --force --grace-period=0
warning: Immediate deletion does not wait for confirmation that the running 
resource has been terminated. The resource may continue to run on the cluster 
indefinitely.
pod "pod-test1" force deleted

#åˆ é™¤å¤šä¸ªèµ„æº
[root@master1 yaml]#kubectl delete -f pod-test1.yaml -f /data/kubernetes/yaml/pod-test2.yaml

#åˆ é™¤æ‰€æœ‰pod
[root@master1 ~]#kubectl get po|cut -d" " -f1 | tail -n +2 |xargs kubectl delete pod

#å¿«é€Ÿåˆ é™¤æ‰€æœ‰pod
[root@master1 ~]#kubectl get pod|awk 'NR!=1{print $1}'|xargs -i kubectl delete pod {} --force --grace-period=0
```



#### åˆ›å»ºå®šåˆ¶çš„Pod

kubernets æ”¯æŒå¤šç§å®šåˆ¶ Pod çš„å®žçŽ°æ–¹æ³•

- å¯¹äºŽä¸åŒåº”ç”¨çš„Pod,é‡æ–°å®šåˆ¶å¯¹åº”çš„é•œåƒ
- å¯åŠ¨å®¹å™¨æ—¶æŒ‡å®šenvçŽ¯å¢ƒå˜é‡
- å¯åŠ¨å®¹å™¨çš„æŒ‡å®šcommandå’Œargs
- å°†é…ç½®ä¿¡æ¯åŸºäºŽå·èµ„æºå¯¹è±¡ï¼Œå†å°†å…¶åŠ è½½åˆ°å®¹å™¨ï¼Œæ¯”å¦‚ï¼šconfigMapå’Œsecretç­‰



#####  åˆ©ç”¨çŽ¯å¢ƒå˜é‡`env`å®žçŽ°å®¹å™¨ä¼ å‚

åœ¨å®¹å™¨ä¸ŠåµŒå¥—ä½¿ç”¨envå­—æ®µ

- æ¯ä¸ªçŽ¯å¢ƒå˜é‡éœ€è¦é€šè¿‡`pod.spec.containers.env.name`ç»™å‡ºæŒ‡å®šçš„åç§°
- ä¼ é€’çš„å€¼åˆ™å®šä¹‰åœ¨`pod.spec.containers.env.value`å­—æ®µä¸Š



ç¤ºä¾‹ï¼šå®žçŽ°LAMPçš„åº”ç”¨wordpress

```bash
# mysql
[root@master1 lamp]# vim pod-mysql.yaml
[root@master1 lamp]# cat pod-mysql.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: mydb
  namespace: default
spec:
  containers:
  - name: mysql
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/mysql:8.0.29-oracle
    env:
    - name: MYSQL_ROOT_PASSWORD
      value: "654321"
    - name: MYSQL_DATABASE
      value: wordpress
    - name: MYSQL_USER
      value: wpuser
    - name: MYSQL_PASSWORD
      value: "123456
   
# æŸ¥çœ‹MySQLå¯¹åº”Podçš„IP
[root@master1 lamp]#kubectl apply -f pod-mysql.yaml
pod/mydb created

[root@master1 lamp]#kubectl get pods mydb -o wide
NAME   READY   STATUS    RESTARTS   AGE     IP           NODE    NOMINATED NODE   READINESS GATES
mydb   1/1     Running   0          2m44s   10.244.2.6   node2   <none>           <none>


# wordpress
[root@master1 lamp]#vim pod-wordpress.yaml
[root@master1 lamp]#cat pod-wordpress.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: wordpress
  namespace: default
spec:
  hostNetwork: true
  containers:
  - name: wordpress
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/wordpress:php8.2-apache
    env:
    - name: WORDPRESS_DB_HOST
      value: 10.244.2.6
    - name: WORDPRESS_DB_NAME
      value: wordpress
    - name: WORDPRESS_DB_USER
      value: wpuser
    - name: WORDPRESS_DB_PASSWORD
      value: "123456"

[root@master1 lamp]#kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS      AGE     IP           NODE    NOMINATED NODE   READINESS GATES
myapp-7b94444f8d-9xld5   1/1     Running   0             4h16m   10.244.1.2   node1   <none>           <none>
myapp-7b94444f8d-dhkdj   1/1     Running   0             4h16m   10.244.2.2   node2   <none>           <none>
myapp-7b94444f8d-ssp7z   1/1     Running   0             4h16m   10.244.3.4   node3   <none>           <none>
myapp-pod                1/1     Running   2 (84m ago)   131m    10.244.1.5   node1   <none>           <none>
mydb                     1/1     Running   0             48m     10.244.2.6   node2   <none>           <none>
wordpress                1/1     Running   0             5m22s   10.0.0.202   node1   <none>           <none>
```

![alt text](images\image32.png)



##### åˆ©ç”¨`command`å’Œ`args`å­—æ®µä¼ é€’å®¹å™¨çš„å¯åŠ¨å‘½ä»¤å’Œå‚æ•°

Podé…ç½®ä¸­ï¼Œspec.containers[].commandå­—æ®µèƒ½å¤Ÿåœ¨å®¹å™¨ä¸ŠæŒ‡å®šæ›¿ä»£é•œåƒé»˜è®¤è¿è¡Œçš„åº”ç”¨ç¨‹åºï¼Œä¸”å¯ åŒæ—¶ä½¿ç”¨spec.containers[].argså­—æ®µè¿›è¡Œå‚æ•°ä¼ é€’ï¼Œå®ƒä»¬å°†è¦†ç›–é•œåƒä¸­çš„é»˜è®¤å®šä¹‰çš„å‚æ•°ã€‚

- è‹¥ä»…å®šä¹‰äº†commandå­—æ®µæ—¶ï¼Œå…¶å€¼å°†è¦†ç›–é•œåƒä¸­å®šä¹‰çš„ç¨‹åºåŠå‚æ•°ã€‚
- è‹¥ä»…æ˜¯å®šä¹‰äº†argså­—æ®µï¼Œè¯¥å­—æ®µå€¼å°†ä½œä¸ºå‚æ•°ä¼ é€’ç»™é•œåƒä¸­é»˜è®¤æŒ‡å®šè¿è¡Œçš„åº”ç”¨ç¨‹åº
- **æ³¨æ„: argsä¸­ä½¿ç”¨çŽ¯å¢ƒå˜é‡,éœ€è¦ä½¿ç”¨æ ¼å¼: $(çŽ¯å¢ƒå˜é‡å)**



**æ·»åŠ è¿è¡Œå‘½ä»¤å’Œå‚æ•°**

```bash
[root@master1 yaml]#cat pod-with-cmd-and-args.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-with-cmd-and-args
spec:
  containers:
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    command: ['/bin/sh','-c']
    args: ['python3 /usr/local/bin/demo.py -p 8080']
    
[root@master1 yaml]#kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS      AGE   IP           NODE    NOMINATED NODE   READINESS GATES
myapp-7b94444f8d-66d4h   1/1     Running   1 (12m ago)   29h   10.244.4.4   node2   <none>           <none>
myapp-7b94444f8d-nctmp   1/1     Running   1 (12m ago)   29h   10.244.3.5   node1   <none>           <none>
myapp-7b94444f8d-tnj2j   1/1     Running   1 (12m ago)   29h   10.244.5.3   node3   <none>           <none>
pod-with-cmd-and-args    1/1     Running   1 (12m ago)   60m   10.244.3.4   node1   <none>           <none>

[root@master1 yaml]#curl 10.244.3.4:8080
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: pod-with-cmd-and-args, ServerIP: 10.244.3.4!
```



**æ·»åŠ è¿è¡Œå‘½ä»¤ï¼Œå‚æ•°å’ŒçŽ¯å¢ƒå˜é‡**

```bash
[root@master1 yaml]#cat pod-with-cmd-and-args.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-with-cmd-and-args
spec:
  containers:
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    command: ['/bin/sh','-c']
    args: ['python3 /usr/local/bin/demo.py -p $port']
    env:
    - name: port
      value: "8888"
      
[root@master1 yaml]#kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS      AGE   IP           NODE    NOMINATED NODE   READINESS GATES
myapp-7b94444f8d-66d4h   1/1     Running   1 (29m ago)   29h   10.244.4.4   node2   <none>           <none>
myapp-7b94444f8d-nctmp   1/1     Running   1 (29m ago)   29h   10.244.3.5   node1   <none>           <none>
myapp-7b94444f8d-tnj2j   1/1     Running   1 (29m ago)   29h   10.244.5.3   node3   <none>           <none>
pod-with-cmd-and-args    1/1     Running   0             59s   10.244.5.4   node3   <none>           <none>
      
[root@master1 yaml]#curl 10.244.5.4:8888
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: pod-with-cmd-and-args, ServerIP: 10.244.5.4!
```

 

##### ä½¿ç”¨å®¿ä¸»æœºç½‘ç»œå®žçŽ°å®¹å™¨çš„å¤–éƒ¨è®¿é—®

é»˜è®¤å®¹å™¨ä½¿ç”¨ç§æœ‰çš„ç‹¬ç«‹ç½‘æ®µï¼Œæ— æ³•ä»Žé›†ç¾¤å¤–ç›´æŽ¥è®¿é—®ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢ä¸¤ç§æ–¹å¼å®žçŽ°å¤–éƒ¨è®¿é—®

- è®©å®¹å™¨ç›´æŽ¥ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œåœ°å€ï¼Œå³å®¹å™¨ä½¿ç”¨hostçš„ç½‘è·¯æ¨¡åž‹
- è®©å®¹å™¨é€šè¿‡å®¿ä¸»æœºçš„ç«¯å£æ˜ å°„å®žçŽ°ï¼Œå³DNAT

æ³¨æ„ï¼šéƒ½è¦é¿å…ç«¯å£å†²çª



```bash
[root@master1 yaml]#cat pod-hostnetwork.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-hostnetwork-demo
spec:
  hostNetwork: true
  containers:
  - name: demo-env
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    env:
    - name: PORT
      value: "9999"
      
[root@master1 yaml]#kubectl apply -f pod-hostnetwork.yaml 
pod/pod-hostnetwork-demo created

[root@master1 yaml]#kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS      AGE     IP           NODE    NOMINATED NODE   READINESS GATES
myapp-7b94444f8d-66d4h   1/1     Running   1 (35m ago)   29h     10.244.4.4   node2   <none>           <none>
myapp-7b94444f8d-nctmp   1/1     Running   1 (35m ago)   29h     10.244.3.5   node1   <none>           <none>
myapp-7b94444f8d-tnj2j   1/1     Running   1 (35m ago)   29h     10.244.5.3   node3   <none>           <none>
pod-hostnetwork-demo     1/1     Running   0             21s     10.0.0.105   node2   <none>           <none>
pod-with-cmd-and-args    1/1     Running   0             7m33s   10.244.5.4   node3   <none>           <none>

[root@master1 yaml]#curl 10.0.0.105:9999
kubernetes pod-test v0.1!! ClientIP: 10.0.0.101, ServerName: node2, ServerIP: 10.0.0.105!
```



ä½¿ç”¨å®¹å™¨æ‰€åœ¨å®¿ä¸»æœºæŒ‡å®šçš„ç«¯å£

```bash
# ä½¿ç”¨ç«¯å£æ˜ å°„
[root@master1 yaml]#cat pod-hostport.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-hostport-demo
spec:
  containers:
  - name: demo-env
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    env:
    - name: PORT
      value: "9999"
    ports:                           # ä½¿ç”¨å®¿ä¸»æœºæŒ‡å®šç«¯å£
    - name: http                     # ä¸æ”¯æŒå¤§å†™å­—æ¯
      containerPort: 9999            # ä½¿ç”¨ä¸Šé¢å˜é‡ç›¸åŒçš„ç«¯å£
      hostPort: 8888


# æœ¬è´¨ä¸Šå°±æ˜¯é€šè¿‡å®¿ä¸»æœºçš„DNATç­–ç•¥å®žçŽ°
[root@master1 yaml]#ssh 10.0.0.104 iptables -vnL -t nat |grep DNAT|grep 8888
    1    60 DNAT       tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8888 to:10.244.3.6:9999

[root@master1 yaml]#iptables --version
iptables v1.8.7 (nf_tables)

# è¿™é‡Œçš„ (nf_tables) è¡¨ç¤º iptables æ˜¯åœ¨ nftables æ¡†æž¶ä¸­å®žçŽ°çš„
# iptables å®žé™…ä¸Šæ˜¯ä¸€ä¸ªå¯¹ nftables çš„å°è£…
```





#### ä¸´æ—¶å®¹å™¨

#####  äº†è§£ä¸´æ—¶å®¹å™¨

Pod æ˜¯ Kubernetes åº”ç”¨ç¨‹åºçš„åŸºæœ¬æž„å»ºå—ã€‚ ç”±äºŽ Pod æ˜¯ä¸€æ¬¡æ€§ä¸”å¯æ›¿æ¢çš„ï¼Œå› æ­¤ä¸€æ—¦ Pod åˆ›å»ºï¼Œå°± æ— æ³•å°†å®¹å™¨åŠ å…¥åˆ° Pod ä¸­ã€‚ å–è€Œä»£ä¹‹çš„æ˜¯ï¼Œé€šå¸¸ä½¿ç”¨ Deployment ä»¥å—æŽ§çš„æ–¹å¼æ¥åˆ é™¤å¹¶æ›¿æ¢ Podã€‚

æœ‰æ—¶æœ‰å¿…è¦æ£€æŸ¥çŽ°æœ‰ Pod çš„çŠ¶æ€ã€‚ä¾‹å¦‚ï¼Œå¯¹äºŽéš¾ä»¥å¤çŽ°çš„æ•…éšœè¿›è¡ŒæŽ’æŸ¥ã€‚ åœ¨è¿™äº›åœºæ™¯ä¸­ï¼Œå¯ä»¥åœ¨çŽ°æœ‰  Pod ä¸­è¿è¡Œä¸´æ—¶å®¹å™¨æ¥æ£€æŸ¥å…¶çŠ¶æ€å¹¶è¿è¡Œä»»æ„å‘½ä»¤ã€‚

Kubernetes v1.16æŽ¨å‡ºä¸´æ—¶å®¹å™¨, Kubernetes v1.25ç¨³å®šå¯ç”¨, å°±æ˜¯åœ¨åŽŸæœ‰çš„Pod ä¸Šï¼Œæ·»åŠ ä¸€ä¸ª**ä¸´æ—¶çš„ Containerï¼Œè¿™ä¸ªContainerå¯ä»¥åŒ…å«æˆ‘ä»¬æŽ’æŸ¥é—®é¢˜æ‰€æœ‰çš„å·¥å…·**, æ¯”å¦‚: ipã€ssã€psã€pstreeã€topã€killã€ topã€jstatã€jmapç­‰







### Podå·¥ä½œæœºåˆ¶



#### PodåŸºæœ¬åŽŸç†

![image-20241217182330834](D:\git_repository\cyber_security_learning\markdown_img\image-20241217182330834.png)

##### Pauseå®¹å™¨

**ä»€ä¹ˆæ˜¯ pause å®¹å™¨ï¼Ÿ**

- **pause å®¹å™¨** æ˜¯æ¯ä¸ª Pod ä¸­çš„ä¸€ä¸ªâ€œåŸºç¡€â€æˆ–â€œè¾…åŠ©â€å®¹å™¨ï¼Œä½œä¸º **â€œPodçš„åŸºç¡€çŽ¯å¢ƒâ€**ã€‚
- **pause å®¹å™¨çš„æ ¸å¿ƒç›®çš„æ˜¯**ï¼š
  1. ä½œä¸º Pod ä¸­æ‰€æœ‰å…¶ä»–å®¹å™¨çš„â€œ**æ ¹å‘½åç©ºé—´**â€ï¼ˆåŒ…æ‹¬ç½‘ç»œã€PIDã€IPCã€ç”¨æˆ·å‘½åç©ºé—´ç­‰ï¼‰ã€‚
  2. æä¾›ä¸€ä¸ª**ç®¡ç†æ‰€æœ‰å®¹å™¨çš„çˆ¶å®¹å™¨**ã€‚
  3. å……å½“**ç½‘ç»œæ ˆçš„å®¿ä¸»**ï¼Œå³å°† Pod çš„ IP åœ°å€åˆ†é…åˆ° pause å®¹å™¨ã€‚
  4. **é˜²æ­¢å­¤å„¿è¿›ç¨‹**ï¼špause å®¹å™¨è´Ÿè´£å›žæ”¶ Pod ä¸­å­è¿›ç¨‹ï¼ˆå³åƒµå°¸è¿›ç¨‹ï¼‰ï¼Œé˜²æ­¢å­¤å„¿è¿›ç¨‹æ®‹ç•™ã€‚
  5. **ç»Ÿä¸€ç®¡ç†ç”Ÿå‘½å‘¨æœŸ**ï¼šå½“ Pod è¢«é”€æ¯æ—¶ï¼Œ**æ‰€æœ‰ä¸Ž pause å®¹å™¨å…±äº«å‘½åç©ºé—´çš„å®¹å™¨**ä¹Ÿä¼šè¢«é”€æ¯ã€‚



ðŸŸ¢ **pause å®¹å™¨çš„ä¸»è¦ä½œç”¨**

| **ä½œç”¨**          | **æè¿°**                                                     |
| ----------------- | ------------------------------------------------------------ |
| **ç½‘ç»œå‘½åç©ºé—´**  | Pod ä¸­çš„ç½‘ç»œæ ˆæ˜¯ pause å®¹å™¨çš„ç½‘ç»œæ ˆï¼Œæ‰€æœ‰å…¶ä»–å®¹å™¨ä¸Žå®ƒå…±äº« IP åœ°å€ã€ç«¯å£å’Œç½‘ç»œå‘½åç©ºé—´ã€‚ |
| **PID å‘½åç©ºé—´**  | Pod å†…çš„æ‰€æœ‰å®¹å™¨ä¸Ž pause å®¹å™¨å…±äº«ä¸€ä¸ª PID å‘½åç©ºé—´ï¼ŒPod å†…çš„è¿›ç¨‹èƒ½â€œçœ‹åˆ°â€å½¼æ­¤çš„è¿›ç¨‹åˆ—è¡¨ã€‚ |
| **IPC å‘½åç©ºé—´**  | å®¹å™¨ä¹‹é—´çš„è¿›ç¨‹é€šä¿¡ï¼ˆå¦‚ä¿¡å·ã€ä¿¡å·é‡ï¼‰æ˜¯é€šè¿‡ IPC å®žçŽ°çš„ï¼ŒPod ä¸­çš„ IPC å‘½åç©ºé—´ç”± pause å®¹å™¨æä¾›ã€‚ |
| **Volume å·ç®¡ç†** | å¦‚æžœ Pod ä¸­æœ‰æŒ‚è½½å·ï¼Œå·çš„è·¯å¾„é€šå¸¸å…ˆæŒ‚è½½åˆ° pause å®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå…¶ä»–å®¹å™¨å…±äº«è¿™ä¸ªè·¯å¾„ã€‚ |
| **åƒµå°¸è¿›ç¨‹å›žæ”¶**  | å¦‚æžœ Pod å†…çš„æŸä¸ªå®¹å™¨å†…çš„å­è¿›ç¨‹é€€å‡ºï¼Œè¿™ä¸ªåƒµå°¸è¿›ç¨‹ä¸ä¼šç›´æŽ¥è¢«å®¿ä¸»æœºçš„ init è¿›ç¨‹ (PID 1) å›žæ”¶ï¼Œè€Œæ˜¯ç”± pause å®¹å™¨å›žæ”¶ã€‚ |
| **çˆ¶è¿›ç¨‹ä½œç”¨**    | pause å®¹å™¨çš„ PID å§‹ç»ˆæ˜¯ Pod ä¸­çš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ (PID=1)ï¼Œæ‰€æœ‰å…¶ä»–è¿›ç¨‹ï¼ˆå³ä¸šåŠ¡å®¹å™¨çš„è¿›ç¨‹ï¼‰éƒ½æ˜¯ pause å®¹å™¨çš„â€œå­è¿›ç¨‹â€ã€‚ |





ðŸŸ¢ **å®žé™…çš„æœºåˆ¶ï¼ˆæ·±å…¥å‰–æžï¼‰**

- 1ï¸âƒ£ å½“ kubelet å¯åŠ¨ä¸€ä¸ª Pod æ—¶ï¼š
  - **pause å®¹å™¨é¦–å…ˆå¯åŠ¨**ï¼Œè¿™æ˜¯ Pod çš„ç¬¬ä¸€ä¸ªå®¹å™¨ã€‚
  - å¯åŠ¨ pause å®¹å™¨çš„åŽŸå› æ˜¯ï¼šå®ƒä¼šåˆ›å»º**PID å‘½åç©ºé—´ã€ç½‘ç»œå‘½åç©ºé—´ã€IPC å‘½åç©ºé—´å’Œ UTS å‘½åç©ºé—´**ã€‚
  - pause å®¹å™¨çš„ PID åœ¨ Pod å‘½åç©ºé—´ä¸­æ˜¯ **1**ï¼Œå³**PID=1**ã€‚
- 2ï¸âƒ£ å½“å…¶ä»–ä¸šåŠ¡å®¹å™¨å¯åŠ¨æ—¶ï¼š
  - ä¸šåŠ¡å®¹å™¨ä¸ä¼šä»Ž pause å®¹å™¨ fork() å‡ºæ¥ï¼Œè€Œæ˜¯**containerd æˆ– dockerd** å¯åŠ¨çš„ã€‚
  - ä¸šåŠ¡å®¹å™¨å’Œ pause å®¹å™¨**å…±äº« pause å®¹å™¨çš„å‘½åç©ºé—´**ï¼ˆç½‘ç»œã€IPCã€PIDã€Volume ç­‰ï¼‰ï¼Œè¿™å°±æ˜¯â€œå…±äº«â€å‘½åç©ºé—´çš„å«ä¹‰ã€‚
  - **ä»Ž PID è§†è§’çœ‹**ï¼Œæ‰€æœ‰ä¸šåŠ¡å®¹å™¨ä¸­çš„è¿›ç¨‹éƒ½å±žäºŽ pause å®¹å™¨çš„å­è¿›ç¨‹ã€‚



ðŸŸ¢ **ä¸ºä»€ä¹ˆéœ€è¦ pause å®¹å™¨ï¼Ÿ**

- **ç»Ÿä¸€å‘½åç©ºé—´**ï¼š
  - Pod ä¸­çš„å¤šä¸ªä¸šåŠ¡å®¹å™¨å…±äº«**ç½‘ç»œå‘½åç©ºé—´**ï¼Œè¿™ä½¿å¾—å®ƒä»¬å…±äº«ä¸€ä¸ª IP åœ°å€ï¼ˆPod IPï¼‰ã€‚
  - é€šè¿‡ pause å®¹å™¨çš„ PID 1ï¼Œæ‰€æœ‰ä¸šåŠ¡å®¹å™¨å¯ä»¥å…±äº«åŒä¸€ä¸ª PID å‘½åç©ºé—´ã€‚
- **è´Ÿè´£å›žæ”¶å­è¿›ç¨‹**ï¼š
  - **å›žæ”¶åƒµå°¸è¿›ç¨‹**ï¼šå¦‚æžœä¸šåŠ¡å®¹å™¨å†…éƒ¨çš„è¿›ç¨‹ (PID) ç»ˆæ­¢ï¼Œä¼šæˆä¸ºåƒµå°¸è¿›ç¨‹ï¼Œç³»ç»Ÿçš„ init è¿›ç¨‹é€šå¸¸è´Ÿè´£å›žæ”¶åƒµå°¸è¿›ç¨‹ã€‚
  - åœ¨ Pod ä¸­ï¼Œ**pause å®¹å™¨å°±æ˜¯ Pod ä¸­çš„ "init è¿›ç¨‹"**ï¼Œè´Ÿè´£å›žæ”¶ä¸šåŠ¡å®¹å™¨ä¸­çš„åƒµå°¸è¿›ç¨‹ã€‚
- **ç½‘ç»œæ ˆçš„åŸºç¡€**ï¼š
  - é€šè¿‡ pause å®¹å™¨çš„ç½‘ç»œå‘½åç©ºé—´ï¼ŒPod ä¸­çš„æ¯ä¸ªä¸šåŠ¡å®¹å™¨å…±äº«ä¸€ä¸ª IP åœ°å€å’Œç«¯å£ç©ºé—´ã€‚



**ðŸŸ¢podé€šä¿¡æœºåˆ¶**

- Podå†…å¤šå®¹å™¨é€šä¿¡ï¼šå®¹å™¨ä»¶é€šä¿¡ï¼ˆå®¹å™¨æ¨¡åž‹ï¼‰å€ŸåŠ©äºŽpauseå®¹å™¨å®žçŽ°
- å•èŠ‚ç‚¹å†…å¤šPodé€šä¿¡ï¼šä¸»æœºé—´å®¹å™¨é€šä¿¡ï¼ˆhostæ¨¡åž‹ï¼‰ï¼Œåˆ©ç”¨kube-proxyå®žçŽ°
- å¤šèŠ‚ç‚¹å†…å¤šPodé€šä¿¡ï¼šè·¨ä¸»æœºç½‘ç»œè§£å†³æ–¹æ¡ˆï¼ˆoverlayæ¨¡åž‹ï¼‰ï¼Œåˆ©ç”¨ç½‘ç»œæ’ä»¶flannelï¼Œcalicoç­‰å®žçŽ°



##### é™æ€Podå’ŒåŠ¨æ€Pod

åŸºäºŽæŽ§åˆ¶çš„ç‰¹æ€§Pod ä¸»è¦æœ‰ä¸¤ç±»ï¼š**é™æ€pod**å’Œ**åŠ¨æ€pod**

- åŠ¨æ€Pod

  - ä¹‹å‰åˆ›å»ºç®¡ç†çš„podéƒ½æ˜¯åŠ¨æ€podï¼Œä¹Ÿæ˜¯åº”ç”¨æœ€å¹¿æ³›çš„pod
  - åŠ¨æ€Pod ç›´æŽ¥è¢«é›†ç¾¤ä¸­çš„API Server è¿›è¡Œç®¡ç†

- é™æ€pod

  - ç”±ç‰¹å®šèŠ‚ç‚¹ä¸Šçš„kubeletè¿›ç¨‹æ¥ç®¡ç†,å¯¹äºŽ**API Server åªèƒ½æŸ¥çœ‹ï¼Œè€Œä¸èƒ½ç®¡ç†**ã€‚

  - åœ¨æœ¬è´¨ä¸Šä¸ŽåŠ¨æ€podæ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯åœ¨äºŽé™æ€podåªèƒ½åœ¨ç‰¹å®šçš„èŠ‚ç‚¹ä¸Šè¿è¡Œ

  - kubelet é»˜è®¤ä¼šåŠ è½½**/etc/kubernetes/manifests/*.yaml** ä»Žè€Œç”Ÿæˆçš„é™æ€Pod

  - é™æ€podå®žçŽ°æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼š**é…ç½®æ–‡ä»¶**æˆ–è€…**httpæ–¹å¼**ã€‚

    - é…ç½®æ–‡ä»¶

      æ‰€è°“çš„é…ç½®æ–‡ä»¶çš„æ–¹å¼ï¼Œå…¶å®žå°±æ˜¯åœ¨ç‰¹å®šçš„ç›®å½•ä¸‹å­˜æ”¾æˆ‘ä»¬å®šåˆ¶å¥½çš„èµ„æºå¯¹è±¡æ–‡ä»¶ï¼Œç„¶åŽèŠ‚ç‚¹ä¸Šçš„ kubeletæœåŠ¡å‘¨æœŸæ€§çš„æ£€æŸ¥è¯¥ç›®å½•ä¸‹çš„æ‰€æœ‰å†…å®¹ï¼Œå¯¹é™æ€podè¿›è¡Œå¢žåˆ æ”¹æŸ¥ã€‚å…¶é…ç½®æ–¹å¼ä¸»è¦æœ‰ä¸¤ æ­¥ 

      1 å®šåˆ¶kubeletæœåŠ¡å®šæœŸæ£€æŸ¥é…ç½®ç›®å½• 

      2 å¢žåˆ å®šåˆ¶èµ„æºæ–‡ä»¶ 

    - httpæ–¹å¼

      1 å‡†å¤‡httpæ–¹å¼æä¾›èµ„æºæ–‡ä»¶çš„webç«™ç‚¹ 

      2 å·¥ä½œèŠ‚ç‚¹çš„kubeleté…ç½®â€“manifest-url=<èµ„æºæ–‡ä»¶çš„urlä¸‹è½½åœ°å€>

  ```bash
  # æŸ¥æ‰¾é™æ€æ–‡ä»¶é…ç½®è·¯å¾„çš„è¿‡ç¨‹
  [root@master1 net.d]#systemctl status kubelet.service 
  â— kubelet.service - kubelet: The Kubernetes Node Agent
       Loaded: loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)
      Drop-In: /usr/lib/systemd/system/kubelet.service.d
               â””â”€10-kubeadm.conf
       Active: active (running) since Tue 2024-12-17 14:20:02 CST; 6h ago
         Docs: https://kubernetes.io/docs/
     Main PID: 815 (kubelet)
        Tasks: 13 (limit: 2196)
       Memory: 68.4M
          CPU: 3min 13ms
       CGroup: /system.slice/kubelet.service
               â””â”€815 /usr/bin/kubelet --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig
               
  # åŸºäºŽä¸Šè¿°çš„loaded (/lib/systemd/system/kubelet.service; enabled; vendor preset: enabled)
  [root@master1 net.d]#cat /lib/systemd/system/kubelet.service.d/10-kubeadm.conf 
  # Note: This dropin only works with kubeadm and kubelet v1.11+
  [Service]
  Environment="KUBELET_KUBECONFIG_ARGS=--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.conf --kubeconfig=/etc/kubernetes/kubelet.conf"
  Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"
  # This is a file that "kubeadm init" and "kubeadm join" generates at runtime, populating the KUBELET_KUBEADM_ARGS variable dynamically
  EnvironmentFile=-/var/lib/kubelet/kubeadm-flags.env
  # This is a file that the user can use for overrides of the kubelet args as a last resort. Preferably, the user should use
  # the .NodeRegistration.KubeletExtraArgs object in the configuration files instead. KUBELET_EXTRA_ARGS should be sourced from this file.
  EnvironmentFile=-/etc/default/kubelet
  ExecStart=
  ExecStart=/usr/bin/kubelet $KUBELET_KUBECONFIG_ARGS $KUBELET_CONFIG_ARGS $KUBELET_KUBEADM_ARGS $KUBELET_EXTRA_ARGS
  
  # æ‰¾åˆ°Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"è¿™æ ·ï¼Œè¯´æ˜Žkubeletçš„é…ç½®å‚æ•°ä¸»è¦æ˜¯åœ¨/var/lib/kubelet/config.yamlæ–‡ä»¶ä¸­å®šä¹‰
  
  [root@master1 net.d]#cat /var/lib/kubelet/config.yaml|grep static
  staticPodPath: /etc/kubernetes/manifests
  
  # è¿™ä¸ªå°±æ˜¯é™æ€podçš„ä¸“ç”¨ç›®å½•
  
  ```



#### Podç®¡ç†æœºåˆ¶

![image-20241217210820679](D:\git_repository\cyber_security_learning\markdown_img\image-20241217210820679.png)



#### Podåˆ›å»ºæµç¨‹

å®¢æˆ·ç«¯ä½¿ç”¨kubectlåˆ›å»ºpodï¼Œéœ€è¦å…ˆé€šçŸ¥API Serverï¼Œè€Œkubectlèƒ½é€šçŸ¥API Serveræ˜¯å› ä¸ºé…ç½®ä¸­ï¼Œè®°å½•äº†API Serverçš„åœ°å€

```bash
[root@master1 .kube]#grep server ~/.kube/config 
    server: https://master1.mystical.org:6443
    
# hostä¸­è®°å½•äº†master1.mystical.orgå¯¹åº”çš„ip
[root@master1 .kube]#cat /etc/hosts
127.0.0.1 localhost
127.0.1.1 ubuntu2204

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

10.0.0.201 master1 master1.mystical.org
10.0.0.202 node1 node1.mystical.org
10.0.0.203 node2 node2.mystical.org
10.0.0.204 node3 node3.mystical.org

```

##### ðŸŒ **1. å…¥å£ï¼škubectl å‘½ä»¤çš„å‘èµ·**

**å‘½ä»¤ç¤ºä¾‹**ï¼š

```bash
kubectl run nginx --image=nginx --replicas=1
```

**æ“ä½œè¿‡ç¨‹**

1. kubectl å‘èµ·è¯·æ±‚ï¼š

   - kubectl å°†è¯·æ±‚æ‰“åŒ…ä¸ºä¸€ä¸ª **HTTP REST è¯·æ±‚**ï¼Œå¹¶å‘é€åˆ° **Kubernetes API Server**ã€‚
   - é€šè¿‡ `kubectl` å‘½ä»¤ï¼ŒAPI Server æŽ¥æ”¶åˆ°**POSTè¯·æ±‚**ï¼Œå…¶ä¸­åŒ…å«äº† **Podçš„å®šä¹‰ä¿¡æ¯**ï¼ˆYAML/JSON æ ¼å¼çš„PodManifestï¼‰ã€‚

   

##### ðŸ“¡ **2. API Server å¤„ç†è¯·æ±‚**

**API Serverçš„ä½œç”¨**ï¼š

1. éªŒè¯è¯·æ±‚ï¼š

   - è¿›è¡Œèº«ä»½éªŒè¯ï¼ˆAuthenticationï¼‰å’Œæƒé™éªŒè¯ï¼ˆAuthorizationï¼‰ã€‚
   - ä¾‹å¦‚ï¼Œæ£€æŸ¥è¯·æ±‚çš„ç”¨æˆ·æ˜¯å¦å…·æœ‰åˆ›å»ºPodçš„æƒé™ã€‚

   

2. è¯·æ±‚åˆæ³•æ€§æ ¡éªŒï¼š

   - é€šè¿‡ **Admission Controllers** è¿›è¡Œä¸€ç³»åˆ—çš„è§„åˆ™æ£€æŸ¥ï¼ˆæ¯”å¦‚èµ„æºé…é¢ã€Podè°ƒåº¦é™åˆ¶ç­‰ï¼‰ã€‚
   - Admission Controller å¯ä»¥æ‹’ç»ä¸ç¬¦åˆè§„èŒƒçš„Podã€‚

   

3. å¯¹è±¡åºåˆ—åŒ–å’ŒæŒä¹…åŒ–ï¼š

   - æ£€æŸ¥è¯·æ±‚çš„YAML/JSONå®šä¹‰æ˜¯å¦ç¬¦åˆ **Pod Schema**ã€‚
   - å¦‚æžœæ£€æŸ¥é€šè¿‡ï¼Œå°†å…¶å­˜å‚¨åˆ° **etcd** ä¸­ã€‚
   - é€šè¿‡ `apiserver` çš„ **etcd client** å°†Podä¿¡æ¯åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶æ•°æ®ï¼Œå¹¶å­˜å‚¨åˆ°etcdçš„**å­˜å‚¨è·¯å¾„** `/registry/pods/{namespace}/{pod-name}` ä¸­ã€‚

   

##### ðŸ“¦ **3. etcd å­˜å‚¨ Pod å®šä¹‰**

**etcdçš„ä½œç”¨**ï¼š

1. æ•°æ®å­˜å‚¨ï¼š
   - etcd å­˜å‚¨çš„æ˜¯**å®Œæ•´çš„Podçš„å®šä¹‰**ï¼Œå¦‚é•œåƒã€CPU/å†…å­˜é…é¢ã€çŽ¯å¢ƒå˜é‡ç­‰ã€‚
   - etcd æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„é”®å€¼å­˜å‚¨ï¼Œæ‰€æœ‰çš„K8sèµ„æºï¼ˆPodã€Serviceã€ConfigMapï¼‰éƒ½ä»¥è·¯å¾„çš„å½¢å¼å­˜å‚¨ã€‚
2. æ•°æ®å˜æ›´è§¦å‘é€šçŸ¥ï¼š
   - etcd ä½œä¸ºä¸€ä¸ª**å‘å¸ƒ/è®¢é˜…ç³»ç»Ÿ**ï¼Œä¸€æ—¦æ–°çš„Podå®šä¹‰è¢«å­˜å‚¨ï¼Œæ‰€æœ‰ç›‘å¬è¯¥è·¯å¾„çš„æŽ§åˆ¶å™¨ï¼ˆå¦‚**Controller-Manager** å’Œ **Scheduler**ï¼‰éƒ½ä¼šè¢«**Watchäº‹ä»¶**è§¦å‘ã€‚



##### âš™ï¸ **4. Scheduler è°ƒåº¦ Pod**

**Schedulerçš„ä½œç”¨**ï¼š

1. **ç›‘å¬Podçš„å˜æ›´**ï¼š
   - Scheduler ç›‘å¬ `/registry/pods/` ç›®å½•çš„å˜æ›´ã€‚
   - ç›‘å¬åˆ°ä¸€ä¸ª**æœªç»‘å®šNodeçš„Pod**ï¼Œå³ `.spec.nodeName == null`ï¼Œåˆ™å¯åŠ¨è°ƒåº¦ã€‚
2. **è°ƒåº¦å†³ç­–**ï¼š
   - Scheduler ä¼šä»Žæ‰€æœ‰**å¯ç”¨çš„Nodeä¸­é€‰æ‹©ä¸€ä¸ªæœ€ä¼˜çš„Node**æ¥è¿è¡Œè¿™ä¸ªPodã€‚
   - Schedulerä¼šè€ƒè™‘ä»¥ä¸‹å› ç´ ï¼š
     - **èµ„æºçº¦æŸ**ï¼šNodeçš„CPUã€å†…å­˜æ˜¯å¦è¶³å¤Ÿã€‚
     - **äº²å’Œæ€§/åäº²å’Œæ€§**ï¼šPodçš„äº²å’Œæ€§å’Œåäº²å’Œæ€§è§„åˆ™ã€‚
     - **æ±¡ç‚¹å’Œå®¹å¿åº¦**ï¼šèŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰æ±¡ç‚¹ã€‚
     - **èŠ‚ç‚¹å¥åº·çŠ¶æ€**ï¼šèŠ‚ç‚¹æ˜¯å¦Readyã€‚
3. **å†™å›žè°ƒåº¦ç»“æžœ**ï¼š
   - Scheduler å°†è°ƒåº¦çš„ç»“æžœï¼ˆ`spec.nodeName: node01`ï¼‰å›žå†™åˆ° etcdï¼Œé€šçŸ¥API Serverã€‚



##### ðŸ”„ **5. Kubelet ç›‘æŽ§ Pod å˜æ›´**

**Kubeletçš„ä½œç”¨**ï¼š

1. **ç›‘å¬ API Server çš„äº‹ä»¶**ï¼š
   - Kubelet ç›‘å¬ `/registry/pods/{namespace}/{pod-name}` ç›®å½•çš„å˜æ›´ã€‚
   - ä¸€æ—¦æœ‰å˜æ›´ï¼ŒKubeletä¼šå‘çŽ°è‡ªå·±éœ€è¦åœ¨æœ¬èŠ‚ç‚¹ä¸Š**æ‹‰å–ä¸€ä¸ªæ–°çš„Pod**ã€‚
2. **åˆ›å»ºPodæ²™ç®±ï¼ˆPauseå®¹å™¨ï¼‰**ï¼š
   - Kubelet ä½¿ç”¨ **container runtime (Docker/Containerd/CRI-O)** åˆ›å»ºä¸€ä¸ª**pauseå®¹å™¨**ã€‚
   - pause å®¹å™¨çš„ä½œç”¨ï¼š
     - **ç½‘ç»œå‘½åç©ºé—´**ï¼šå…¶ä»–å®¹å™¨ä¼šå’Œpauseå®¹å™¨å…±äº«ç½‘ç»œå‘½åç©ºé—´ã€‚
     - **PIDå‘½åç©ºé—´**ï¼šå…±äº«è¿›ç¨‹å‘½åç©ºé—´ã€‚
     - **æ•°æ®å·ç®¡ç†**ï¼šæŒ‚è½½Podå®šä¹‰çš„å·åˆ°pauseå®¹å™¨ä¸Šï¼Œå…¶ä»–å®¹å™¨å…±äº«ã€‚
3. **åˆ›å»ºPodä¸­çš„ä¸šåŠ¡å®¹å™¨**ï¼š
   - **container runtime** æ‹‰å–é•œåƒï¼ˆå¦‚ nginx:latestï¼‰ï¼Œå¹¶åœ¨ pause å®¹å™¨çš„**ç½‘ç»œå’ŒPIDå‘½åç©ºé—´ä¸­è¿è¡Œä¸šåŠ¡å®¹å™¨**ã€‚
   - è¿™ä¸ªè¿‡ç¨‹åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªé˜¶æ®µï¼š
     - **æ‹‰å–é•œåƒ**ï¼šä»Ž**é•œåƒä»“åº“**ä¸­æ‹‰å–é•œåƒï¼ˆdocker hubã€Harborç­‰ï¼‰ã€‚
     - **è§£åŽ‹é•œåƒ**ï¼šè§£åŽ‹ tar æ–‡ä»¶ï¼ŒåŠ è½½å®¹å™¨æ–‡ä»¶ç³»ç»Ÿã€‚
     - **å¯åŠ¨å®¹å™¨**ï¼šè°ƒç”¨ `runc` å¯åŠ¨å®¹å™¨ï¼Œå’Œ pause å®¹å™¨å…±äº«å‘½åç©ºé—´ã€‚



##### ðŸ“Š **6. å®¹å™¨çŠ¶æ€åŒæ­¥å›ž API Server**

**Kubeletçš„åé¦ˆæœºåˆ¶**ï¼š

1. **Kubelet æ±‡æŠ¥PodçŠ¶æ€**ï¼š
   - Pod å¯åŠ¨å®ŒæˆåŽï¼ŒKubelet ä¼šå°†Podçš„çŠ¶æ€åŒæ­¥å›žAPI Serverã€‚
   - API Serverå°†è¿™äº›çŠ¶æ€å†™å…¥ etcdï¼ŒçŠ¶æ€è·¯å¾„æ˜¯ `/registry/pods/{namespace}/{pod-name}`ã€‚
   - ç”¨æˆ·å¯ä»¥é€šè¿‡ `kubectl get pods` æŸ¥çœ‹Podçš„çŠ¶æ€ã€‚
2. **å®¹å™¨å¥åº·æ£€æŸ¥å’ŒLiveness Probe**ï¼š
   - Kubelet å®šæœŸæ£€æŸ¥Podçš„å¥åº·çŠ¶æ€ã€‚
   - å¦‚æžœå®¹å™¨çš„Liveness Probeå¤±è´¥ï¼ŒKubeletä¼š**é‡å¯å®¹å™¨**ã€‚



##### æµç¨‹å›¾ï¼ˆå¯è§†åŒ–ç†è§£ï¼‰

```scss
       kubectl run 
           â”‚
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  API Server     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚  (èº«ä»½éªŒè¯ã€è¯·æ±‚éªŒè¯)
           â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  etcd å­˜å‚¨      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
   (é€šçŸ¥)  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â””â”€â–¶â”‚ Scheduler è°ƒåº¦  â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
               é€‰æ‹©æœ€ä½³èŠ‚ç‚¹
                      â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚ etcd å­˜å‚¨ â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
               (ç›‘å¬é€šçŸ¥)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚    Kubelet      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      (åœ¨èŠ‚ç‚¹ä¸Šå¯åŠ¨Pod)

```



##### ðŸš€ **é¢è¯•å›žç­”ç¤ºä¾‹**

> **é¢è¯•å®˜é—®**ï¼šKubernetes Pod æ˜¯å¦‚ä½•åˆ›å»ºçš„ï¼Ÿ **å›žç­”æ€è·¯**ï¼š

1. **kubectl run** å°†YAML/JSONè¯·æ±‚å‘åˆ° **API Server**ã€‚
2. **API Server** éªŒè¯è¯·æ±‚ï¼Œå°†Podå®šä¹‰å†™å…¥ **etcd**ã€‚
3. **Scheduler** ç›‘å¬åˆ°**etcdå˜æ›´**ï¼Œè°ƒåº¦Podåˆ°**æœ€ä½³Node**ã€‚
4. **Kubelet** ç›‘å¬åˆ°Podå®šä¹‰ï¼Œå¯åŠ¨**Pauseå®¹å™¨å’Œä¸šåŠ¡å®¹å™¨**ã€‚
5. **Kubelet** åé¦ˆPodçŠ¶æ€ï¼Œç”¨æˆ·å¯é€šè¿‡ `kubectl get pods` æŸ¥çœ‹çŠ¶æ€ã€‚



##### æ³¨æ„äº‹é¡¹

1. **etcd ç›‘å¬ API Server**ï¼š
   å½“ç”¨æˆ·é€šè¿‡ `kubectl` åˆ›å»ºã€æ›´æ–°æˆ–åˆ é™¤ Pod èµ„æºæ—¶ï¼Œè¿™äº›æ›´æ”¹ä¼šå­˜å‚¨åˆ° **etcd**ã€‚
2. **API Server ç›‘å¬ etcd**ï¼š
   **API Server ç›‘å¬ etcd ä¸­çš„å˜åŒ–**ï¼Œå¹¶å°†å˜åŒ–é€šçŸ¥ Kubelet å’Œ Controller Managerã€‚
3. **Kubelet ç›‘å¬ API Server**ï¼š
   Kubelet é€šè¿‡ Watch API ä»Ž API Server èŽ·å–å…¶æ‰€åœ¨ Node ä¸Šçš„ Pod åˆ—è¡¨ï¼Œå¹¶åœ¨æœ¬åœ°å¯åŠ¨æˆ–ç»ˆæ­¢ç›¸åº”çš„ Podã€‚

> ðŸ“ **Kubelet åªèƒ½é€šè¿‡ API Server æ¥ä¸Ž etcd é—´æŽ¥é€šä¿¡**ã€‚
> è¿™æ˜¯ä¸ºäº†ç¡®ä¿æ‰€æœ‰æ•°æ®çš„æ“ä½œéƒ½ç”± API Server ç»Ÿä¸€æŽ§åˆ¶å’ŒéªŒè¯ã€‚





##### Podåˆ›å»ºæµç¨‹è‡ªè¿°ï¼ˆé¢è¯•å¿…èƒŒï¼‰



- å½“ä½¿ç”¨ `kubectl apply -f pod.yaml` æ—¶ï¼Œkubectl ä¼šå°† YAML æ–‡ä»¶ä¸­çš„**Kubernetes èµ„æºå¯¹è±¡**ï¼ˆPodï¼‰è½¬æ¢ä¸º**JSON æ ¼å¼çš„è¯·æ±‚ä½“**ï¼Œå¹¶é€šè¿‡ **HTTP POST** å‘é€åˆ° API Server
  - **kubectl ä½œä¸ºå®¢æˆ·ç«¯**ï¼Œä¼šå°† YAML æ–‡ä»¶è½¬æ¢ä¸º**RESTful API è¯·æ±‚**ï¼ŒAPI Server å……å½“**æœåŠ¡ç«¯**ã€‚
  - ä½¿ç”¨çš„æ˜¯ **HTTP/2**ï¼Œå¹¶ä¸”éœ€è¦èº«ä»½è®¤è¯å’Œæƒé™æŽ§åˆ¶ï¼ˆRBACï¼‰ã€‚
  - API Server ä¼š**å…ˆå°† Pod èµ„æºä¿å­˜åœ¨å†…å­˜ä¸­ï¼ˆWatch Cacheï¼‰**ï¼Œå¹¶å¼‚æ­¥å†™å…¥ etcdã€‚



- API Serveré€šè¿‡gRPCä¸Žetcdé€šä¿¡ï¼Œå°†Podçš„æ•°æ®æŒä¹…åŒ–åˆ°etcdï¼Œ**æ­¤æ—¶Podçš„çŠ¶æ€æ˜¯Pending**ï¼Œå› ä¸ºæ­¤æ—¶Podè¿˜æœªè¢«è°ƒåº¦åˆ°æŸä¸ªèŠ‚ç‚¹



- Scheduler é€šè¿‡ **watch æœºåˆ¶ç›‘å¬ API Server ä¸­çš„ Pending Pods**ã€‚å¹¶é€šè¿‡é¢„é€‰è¿‡æ»¤ï¼Œä¼˜é€‰æ‰“åˆ†ï¼Œé€‰æ‹©å‡ºæœ€é€‚åˆçš„èŠ‚ç‚¹ï¼Œå¹¶å°†Podé€šè¿‡POSTè¯·æ±‚bindingåˆ°è¿™ä¸ªç›®æ ‡èŠ‚ç‚¹ä¸Š



- API Server å°† Pod çš„çŠ¶æ€ä»Ž `Pending` å˜ä¸º `Scheduled`ã€‚å¹¶ä½¿ç”¨**PUT è¯·æ±‚** æ›´æ–° Pod çš„çŠ¶æ€ï¼Œå¹¶åŒæ­¥åˆ° etcdã€‚åŒæ—¶**API Server é€šè¿‡ Watch æœºåˆ¶å°† Pod å˜æ›´äº‹ä»¶æŽ¨é€ç»™ Kubelet**ã€‚



- Kubelet æ”¶åˆ° API Server å‘é€çš„ Pod æ•°æ®åŽï¼ŒKubelet ä½¿ç”¨**CRIï¼ˆContainer Runtime Interfaceï¼‰è°ƒç”¨ containerd**ã€‚containerd è°ƒç”¨**runc**ï¼Œåˆ›å»º Pod çš„ Linux å®¹å™¨ã€‚Pod è¿›å…¥**Running**çŠ¶æ€ã€‚







#### Podçš„ç”Ÿå‘½å‘¨æœŸ



![image-20241218091558622](D:\git_repository\cyber_security_learning\markdown_img\image-20241218091558622.png)



- åˆ›å»ºæŒ‡ä»¤é€åˆ°apiserver
- é€šçŸ¥Scheduleè°ƒåº¦æ­¤è¯·æ±‚åˆ°åˆé€‚çš„èŠ‚ç‚¹
- **initå®¹å™¨**
  - åˆå§‹åŒ–å®¹å™¨ï¼ˆä¸€æ¬¡æ€§å®¹å™¨ï¼Œåˆå§‹åŒ–ç»“æŸï¼Œè¯¥å®¹å™¨å°±é€€å‡ºäº†ï¼‰ï¼Œç‹¬ç«‹äºŽä¸»å®¹å™¨ä¹‹å¤–ï¼Œå³å’Œä¸»å®¹å™¨æ˜¯éš”ç¦»çš„
  - Podå¯ä»¥æ‹¥æœ‰ä»»æ„æ•°é‡çš„initå®¹å™¨ï¼Œinité¡ºåºæ‰§è¡Œï¼Œæœ€åŽä¸€ä¸ªæ‰§è¡Œå®ŒæˆåŽï¼Œæ‰å¯åŠ¨ä¸»å®¹å™¨
  - initå®¹å™¨ä¸æ”¯æŒæŽ¢é’ˆæ£€æµ‹åŠŸèƒ½
    - å®ƒä¸»è¦æ˜¯ä¸ºäº†ä¸»å®¹å™¨å‡†å¤‡è¿è¡ŒçŽ¯å¢ƒçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼šç»™ä¸»å®¹å™¨å‡†å¤‡é…ç½®æ–‡ä»¶ï¼Œå‘ä¸»å®¹å™¨çš„å­˜å‚¨å†™å…¥æ•°æ®ï¼Œç„¶åŽå°†å­˜å‚¨å·æŒ‚è½½åˆ°ä¸»å®¹å™¨ä¸Šï¼Œä¸‹è½½ç›¸å…³èµ„æºï¼Œç›‘æµ‹ä¸»å®¹å™¨ä¾èµ–æœåŠ¡ç­‰
- **å¯åŠ¨åŽé’©å­PostStartï¼ˆPost Start Hookï¼‰**: ä¸Žä¸»å®¹å™¨åŒæ—¶å¯åŠ¨
- çŠ¶æ€ç›‘æµ‹
- **Startup probeï¼šå¯åŠ¨æŽ¢é’ˆ**ï¼šå¯åŠ¨æŽ¢é’ˆç”¨æ¥æŽ¢æµ‹è¿™ä¸ªæœåŠ¡æ˜¯å¦èµ·æ¥çš„ï¼Œå¦‚æžœæŽ¢é’ˆæ£€æŸ¥å¤±è´¥ï¼Œä¼šè®¤ä¸ºè¯¥å®¹å™¨ä¸å¥åº·ï¼Œå› æ­¤ä¼šé‡æ–°å¯åŠ¨å®¹å™¨ï¼Œå¦‚æžœå¥åº·ï¼Œå°±ä¼šè¿›å…¥ä¸‹ä¸€æ­¥
  - å¯åŠ¨æŽ¢é’ˆåªæ£€æµ‹å®¹å™¨æ˜¯å¦å¯åŠ¨ï¼Œå®¹å™¨å¯åŠ¨åŽï¼ŒåŽç»­ä¸å†æ£€æŸ¥
- **Liveiness probeï¼ˆå­˜æ´»æŽ¢é’ˆï¼‰**ï¼šåˆ¤æ–­å½“å‰Podæ˜¯å¦å¤„äºŽå­˜æ´»çŠ¶æ€ï¼Œæ˜¯Readinesså­˜æ´»çš„å‰æï¼Œå¯¹åº”READYçŠ¶æ€çš„m/nçš„nå€¼
- **Readiness Probeï¼ˆå°±ç»ªæŽ¢é’ˆ**ï¼‰ï¼šåˆ¤æ–­å½“å‰Podçš„ä¸»åº”ç”¨å®¹å™¨æ˜¯å¦å¯ä»¥æ­£å¸¸å¯¹å¤–æä¾›æœåŠ¡ï¼Œåªæœ‰Liveinessä¸ºå­˜æ´»ï¼ŒReadiness
  - Liveness probeå’ŒReadiness ProbeæŒç»­å®¹å™¨ç»ˆèº«ï¼Œåªè¦å®¹å™¨åœ¨å¯åŠ¨ï¼Œä¼šä¸æ–­åœ°æŽ¢æµ‹ï¼Œå¦‚æžœå®¹å™¨å‡ºæ•…éšœï¼Œå¯ä»¥è¿›è¡Œä¸€äº›æ“ä½œ
  - ä¸‰ä¸ªæŽ¢é’ˆå°±æ˜¯ç”¨æ¥æ£€æµ‹å®¹å™¨å¥åº·æ€§çš„



- Serviceå…³è”Pod
- æŽ¥æ”¶ç”¨æˆ·è¯·æ±‚





#### å…³é—­Podæµç¨‹



![image-20241218092215630](D:\git_repository\cyber_security_learning\markdown_img\image-20241218092215630.png)





Kubernetes ä¸­çš„ **Pod å…³é—­æµç¨‹**ï¼ˆPod Terminationï¼‰æ˜¯ä¸€ä¸ª**å¤šé˜¶æ®µçš„æœ‰åºè¿‡ç¨‹**ï¼Œå…¶ç›®çš„æ˜¯åœ¨**ä¼˜é›…å…³é—­ï¼ˆGraceful Terminationï¼‰\**å’Œ\**å¼ºåˆ¶åˆ é™¤ï¼ˆForce Deletionï¼‰\**ä¹‹é—´å–å¾—å¹³è¡¡ã€‚è¿™ä¸ªæµç¨‹æ¶‰åŠ\**è´Ÿè½½å‡è¡¡å™¨ï¼ˆService ä»£ç†ï¼‰ã€preStop é’©å­ã€API Serverã€Kubeletã€etcdã€containerd å’Œ runc** ç­‰å¤šä¸ªç»„ä»¶çš„åä½œã€‚



æ•´ä¸ªæµç¨‹å¯åˆ†ä¸º**5 ä¸ªä¸»è¦é˜¶æ®µ**ï¼š



##### é˜¶æ®µ 1ï¼šè¯·æ±‚åˆ é™¤ Pod

**å‘èµ·åˆ é™¤è¯·æ±‚**ï¼š

- é€šè¿‡ `kubectl delete pod <pod-name>`ï¼Œkubectl å‘ API Server å‘èµ·ä¸€ä¸ª**DELETE è¯·æ±‚**ã€‚

- è¿™æ—¶ï¼ŒAPI Server ä¼š**ç«‹å³**å°† Pod çš„**çŠ¶æ€æ ‡è®°ä¸º Terminating**ã€‚

- API è¯·æ±‚ç¤ºä¾‹ï¼š

  ```http
  DELETE /api/v1/namespaces/default/pods/nginx-pod
  ```

**ä½“é¢ç»ˆæ­¢æœŸï¼ˆgraceful termination periodï¼‰è®¾ç½®**ï¼š

- å½“æ‰§è¡Œ `kubectl delete` æ—¶ï¼Œå¯ä»¥é€šè¿‡ `--grace-period=<seconds>` æŒ‡å®š**ä½“é¢ç»ˆæ­¢é™æœŸ**ã€‚

- å¦‚æžœæœªæŒ‡å®šï¼Œé»˜è®¤ä¸º 30 ç§’ã€‚

- etcd å­˜å‚¨çš„çŠ¶æ€ï¼š

  ```ABAP
  /registry/pods/default/nginx-pod
  {
    "status": {
      "phase": "Terminating"
    }
  }
  ```

**é€šçŸ¥ Controller å’Œ Service**ï¼š

- API Server é€šè¿‡**watch æœºåˆ¶**é€šçŸ¥ **Controller Manager** å’Œ **Service ä»£ç†ï¼ˆä¾‹å¦‚ kube-proxyï¼‰**ã€‚
- **Service ä»£ç†ï¼ˆä¾‹å¦‚ kube-proxyï¼‰**ä¼šå°† Pod ä»Ž **Endpoints** ä¸­åˆ é™¤ï¼Œä»Žè€Œä¸å†å°†æµé‡è·¯ç”±åˆ°è¯¥ Pod





##### é˜¶æ®µ 2ï¼šé€šçŸ¥ Kubelet

**Watch æœºåˆ¶é€šçŸ¥ Kubelet**ï¼š

- API Server å‘ Node ä¸Šçš„ Kubelet å‘é€ä¸€ä¸ª**Pod å˜æ›´äº‹ä»¶**ï¼Œæ ‡è¯†è¯¥ Pod å¤„äºŽ **Terminating** çŠ¶æ€ã€‚

- watch URLï¼š

  ```http
  GET /api/v1/nodes/<node-name>/pods?watch=true
  ```

**Kubelet å¤„ç† Pod å˜æ›´**ï¼š

- Kubelet åœ¨æ”¶åˆ°å˜æ›´äº‹ä»¶åŽï¼Œ**æ£€æŸ¥ Pod çš„ä½“é¢ç»ˆæ­¢é™æœŸï¼ˆgraceful termination periodï¼‰**ã€‚
- Kubelet ç¡®ä¿ Pod åœ¨**å®½é™æœŸå†…åœæ­¢è¿è¡Œ**ã€‚
- **æ³¨æ„**ï¼šåœ¨æ­¤æœŸé—´ï¼ŒPod å¯èƒ½ä»åœ¨è¿è¡Œï¼Œç›´åˆ° **preStop é’©å­**å’Œ**å®¹å™¨è¢«åœæ­¢**



##### **é˜¶æ®µ 3ï¼šæ‰§è¡Œ preStop é’©å­å’Œç»ˆæ­¢å®¹å™¨**

**æ‰§è¡Œ preStop é’©å­**ï¼š

- å¦‚æžœåœ¨ Pod çš„ YAML ä¸­å®šä¹‰äº†**preStop é’©å­**ï¼ŒKubelet ä¼š**åŒæ­¥æ‰§è¡Œ preStop é’©å­**ã€‚

- preStop æ˜¯**é˜»å¡žæ“ä½œ**ï¼Œå³åœ¨ preStop é’©å­è¿è¡Œå®Œæˆå‰ï¼ŒPod ä¸ä¼šè¿›å…¥ç»ˆæ­¢é˜¶æ®µã€‚

- **ï¼ï¼preStopé’©å­å’ŒSIGTERMåŒæ­¥æ‰§è¡Œ**

- ç¤ºä¾‹ Pod å®šä¹‰ï¼š

  ```yaml
  lifecycle:
    preStop:
      exec:
        command: ["/bin/sh", "-c", "echo 'Goodbye, world!' > /tmp/goodbye.txt"]
  ```

**åœæ­¢å®¹å™¨**ï¼š

- preStop é’©å­æ‰§è¡Œå®Œæ¯•åŽï¼ŒKubelet è°ƒç”¨ **containerd** å’Œ **runc** åœæ­¢ Pod ä¸­çš„å®¹å™¨ã€‚

- é€šè¿‡è°ƒç”¨ CRI gRPCï¼ŒKubelet æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

  1. **åœæ­¢ä¿¡å·**ï¼šå‘é€**SIGTERM** ä¿¡å·ç»™ Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚
  2. **ç­‰å¾…ä½“é¢ç»ˆæ­¢é™æœŸ**ï¼šç­‰å¾…å®½é™æœŸï¼ˆé»˜è®¤ 30 ç§’ï¼‰å†…çš„ç»ˆæ­¢ã€‚
  3. æ‰§è¡Œ preStop é’©å­
  4. **å¼ºåˆ¶ç»ˆæ­¢**ï¼šå¦‚æžœè¶…æ—¶ï¼ŒKubelet ä¼šå‘å®¹å™¨å‘é€**SIGKILL**ï¼Œå¼ºåˆ¶ç»ˆæ­¢å®¹å™¨ã€‚

- æµç¨‹æ‘˜è¦ï¼š

  ```rust
  Kubelet --> containerd --> runc --> SIGTERM (å®½é™æœŸ)
  Kubelet --> containerd --> runc --> SIGKILL (å¼ºåˆ¶æ€æ­»)
  ```



##### **é˜¶æ®µ 4ï¼šç§»é™¤ Pod Endpointsï¼ˆä»Žè´Ÿè½½å‡è¡¡ä¸­åˆ é™¤ï¼‰**

**æ›´æ–° Service Endpoints**ï¼š

- prestopé’©å­å’ŒKubeletå‘Podå‘é€SIGTERMä»¥åŠé€šè¿‡**Endpoints Controller**å’Œ**kube-proxy**å°† Pod ä»Ž Service çš„ Endpoints ä¸­ç§»é™¤ã€‚è¿™ä¸‰ä¸ªæ“ä½œåŒæ­¥æ‰§è¡Œ

- åœ¨ä½“é¢ç»ˆæ­¢é™æœŸçš„**å¼€å§‹æ—¶**ï¼ŒAPI Server å°±ä¼šé€šè¿‡**Endpoints Controller**å’Œ**kube-proxy**å°† Pod ä»Ž Service çš„ Endpoints ä¸­ç§»é™¤ã€‚
- **åŽŸå› **ï¼šå³ä½¿ Pod ä»åœ¨è¿è¡Œï¼Œä½†ä¸ºäº†é˜²æ­¢å‘é€åˆ°å³å°†è¢«ç»ˆæ­¢çš„ Pod çš„æµé‡ï¼Œæå‰å°†å…¶ä»Žæµé‡è·¯å¾„ä¸­åˆ é™¤ã€‚

**Service è´Ÿè½½å‡è¡¡æ›´æ–°**ï¼š

- kube-proxy ç›‘å¬ Endpoints å˜æ›´ï¼ˆ**watch /api/v1/endpoints**ï¼‰ã€‚
- kube-proxy åœ¨ iptables ä¸­**åˆ é™¤ç›¸å…³çš„è§„åˆ™**ï¼Œä»¥é˜²æ­¢æ–°æµé‡å‘é€åˆ°è¯¥ Podã€‚



##### é˜¶æ®µ 5ï¼šä»Ž etcd ä¸­åˆ é™¤ Pod

**Kubelet å‘ API Server å‘é€åˆ é™¤è¯·æ±‚**ï¼š

- å¦‚æžœ Kubelet å‘çŽ° Pod è¿›ç¨‹å·²å®Œå…¨ç»ˆæ­¢ï¼ˆæ‰€æœ‰å®¹å™¨éƒ½å·²å…³é—­ï¼‰ï¼ŒKubelet å‘ API Server å‘é€ **DELETE è¯·æ±‚**ã€‚

- API è¯·æ±‚ç¤ºä¾‹ï¼š

  ```http
  DELETE /api/v1/namespaces/default/pods/nginx-pod
  ```

**API Server é€šçŸ¥ etcd åˆ é™¤ Pod**ï¼š

- API Server é€šè¿‡ gRPC è°ƒç”¨ etcd åˆ é™¤ä¸Ž Pod ç›¸å…³çš„

  å­˜å‚¨è·¯å¾„ï¼š

  ```http
  DELETE /registry/pods/default/nginx-pod
  ```

**ä»Ž etcd ä¸­ç§»é™¤ Pod å¯¹è±¡**ï¼š

- Pod å¯¹è±¡ä»Ž etcd ä¸­è¢«ç‰©ç†åˆ é™¤ï¼Œæ‰€æœ‰ä¸Žä¹‹ç›¸å…³çš„**watch ç›‘å¬å™¨ï¼ˆKubelet, Controller, Schedulerï¼‰**éƒ½ä¼šç«‹å³æ”¶åˆ°äº‹ä»¶ã€‚



##### æ€»ç»“



**Pod å…³é—­æµç¨‹çš„çŠ¶æ€å˜åŒ–**

| **é˜¶æ®µ**   | **çŠ¶æ€**      | **æè¿°**                                    |
| ---------- | ------------- | ------------------------------------------- |
| **é˜¶æ®µ 1** | `Running`     | Pod å¤„äºŽæ­£å¸¸è¿è¡ŒçŠ¶æ€                        |
| **é˜¶æ®µ 2** | `Terminating` | `kubectl delete` è§¦å‘äº†åˆ é™¤äº‹ä»¶             |
| **é˜¶æ®µ 3** | `Terminating` | ä½“é¢ç»ˆæ­¢é™æœŸå†…ï¼ŒpreStop é’©å­å’Œ SIGTERM æ‰§è¡Œ |
| **é˜¶æ®µ 4** | `Terminating` | Pod ä»Ž Service çš„ Endpoints ä¸­è¢«åˆ é™¤        |
| **é˜¶æ®µ 5** | **å·²åˆ é™¤**    | ä½“é¢ç»ˆæ­¢é™æœŸç»“æŸï¼ŒPod å½»åº•è¢«æ¸…é™¤            |



**å¼ºåˆ¶åˆ é™¤ï¼ˆForce Deletionï¼‰æµç¨‹**

**å½“æŒ‡å®š `--grace-period=0` æ—¶ï¼Œæµç¨‹çš„å…³é”®å˜åŒ–å¦‚ä¸‹ï¼š**

| **ç»„ä»¶**              | **è¡Œä¸ºå˜åŒ–**         | **è§£é‡Š**                                   |
| --------------------- | -------------------- | ------------------------------------------ |
| **ä½“é¢ç»ˆæ­¢**          | **è·³è¿‡**             | ä¸æ‰§è¡Œå®½é™æœŸï¼Œç›´æŽ¥å‘å‡º**SIGKILL**          |
| **preStop é’©å­**      | **è·³è¿‡**             | ä¸ä¼šæ‰§è¡Œ preStop è„šæœ¬                      |
| **Service Endpoints** | **ç«‹å³åˆ é™¤**         | Pod ä¼šç«‹åˆ»è¢«ä»Ž Endpoints ä¸­åˆ é™¤            |
| **Pod ç»ˆæ­¢çŠ¶æ€**      | ç«‹å³ç»ˆæ­¢             | API Server å°† Pod ç«‹å³æ ‡è®°ä¸º `Terminating` |
| **Kubelet åˆ é™¤**      | **ç«‹å³å‘å‡º SIGKILL** | Kubelet ç›´æŽ¥è°ƒç”¨ SIGKILL                   |
| **Pod åˆ é™¤**          | **ç«‹å³åˆ é™¤**         | Kubelet ç›´æŽ¥è°ƒç”¨ API Server åˆ é™¤           |





**å…³é”®æ€»ç»“**

1. **ä¼˜é›…ç»ˆæ­¢**ï¼š
   - **å®½é™æœŸ**ï¼šä½“é¢ç»ˆæ­¢é™æœŸå†…ï¼ŒPod ä»Ž Service ä¸­è¢«ç§»é™¤ï¼ŒæŽ¥æ”¶ SIGTERMï¼Œå¹¶æ‰§è¡Œ preStop é’©å­ã€‚
   - **çŠ¶æ€å˜æ›´**ï¼šRunning â†’ Terminating â†’ åˆ é™¤ã€‚
   - **åˆ é™¤è¿‡ç¨‹**ï¼šå½“å®½é™æœŸè¶…æ—¶åŽï¼ŒPod è¢« SIGKILL ç»ˆæ­¢ï¼ŒKubelet å‘ API Server å‘é€åˆ é™¤è¯·æ±‚ã€‚
2. **å¼ºåˆ¶åˆ é™¤**ï¼š
   - **ç›´æŽ¥è·³è¿‡å®½é™æœŸ**ï¼Œä¸æ‰§è¡Œ preStop é’©å­ï¼Œç«‹å³å‘é€ SIGKILLã€‚
   - **ä»Žè´Ÿè½½å‡è¡¡ä¸­åˆ é™¤**ï¼šç«‹å³å°† Pod ä»Ž Endpoints ä¸­åˆ é™¤ã€‚





#### è®¾ç½®ç»ˆæ­¢å®½é™æœŸ

```bash
spec.terminationGracePeriodï¼Œé»˜è®¤ä¸º30s,æ­¤å€¼ä¸ºä¼˜é›…ç»ˆæ­¢å®½é™æœŸ

#åˆ é™¤å‘½ä»¤ï¼škubectl delete pod mypod --grace-period=5
#å¼ºåˆ¶åˆ é™¤ï¼škubectl delete pod mypod --grace-period=0 --force
```



èŒƒä¾‹

```bash
[root@master1 ~]#kubectl explain pod.spec.terminationGracePeriodSeconds
KIND:     Pod
VERSION: v1
FIELD:   terminationGracePeriodSeconds <integer>
DESCRIPTION:
     Optional duration in seconds the pod needs to terminate gracefully. May be
     decreased in delete request. Value must be non-negative integer. The value
     zero indicates stop immediately via the kill signal (no opportunity to shut
     down). If this value is nil, the default grace period will be used instead.
     The grace period is the duration in seconds after the processes running in
     the pod are sent a termination signal and the time when the processes are
     forcibly halted with a kill signal. Set this value longer than the expected
     cleanup time for your process. Defaults to 30 seconds.
```



ç¤ºä¾‹

```yaml
spec:
 terminationGracePeriodSeconds: 3600  # Pod çº§åˆ«è®¾ç½®ï¼Œç­‰ä»·äºŽ--grace-period=3600
 containers:
  - name: test
   image: ...
   ports:
    - name: liveness-port
     containerPort: 8080
     hostPort: 8080
   livenessProbe:
     httpGet:
       path: /healthz
         port: liveness-port
       failureThreshold: 1
       periodSeconds: 60
        # é‡è½½ Pod çº§åˆ«çš„ terminationGracePeriodSeconds
       terminationGracePeriodSeconds: 60
       
# è§£æžä¸Šè¿°ä¸¤ä¸ªterminationGracePeriodSecondsçš„å«ä¹‰ä¸ŽåŒºåˆ«
# ç¬¬ä¸€ä¸ªterminationGracePeriodSecondsï¼šå†³å®šäº†Kubelet åœ¨å‘é€ SIGKILL ä¿¡å·å‰çš„ç­‰å¾…æ—¶é—´ã€‚ -- Podçº§åˆ«
# ç¬¬äºŒä¸ªterminationGracePeriodSecondsï¼šåœ¨å®¹å™¨é‡å¯æ—¶ç”Ÿæ•ˆã€‚è§¦å‘ä¸‹åˆ—äº‹ä»¶æ—¶ï¼ŒKubeletä¼šé‡å¯æŸä¸ªç‰¹å®šå®¹å™¨ -- å®¹å™¨çº§åˆ«
# Liveness æŽ¢é’ˆå¤±è´¥ã€‚
# Kubelet å‘çŽ°å®¹å™¨çŠ¶æ€å¼‚å¸¸ï¼ˆä¾‹å¦‚ OOMã€CrashLoopBackOff ç­‰ï¼‰ã€‚
# å®¹å™¨çš„è‡ªæˆ‘å´©æºƒï¼ˆcontainerd å‘çŽ°å®¹å™¨è¿›ç¨‹é€€å‡ºï¼‰ã€‚

# è¡Œä¸ºå’Œä¿¡å·æµç¨‹ï¼š

# Kubelet å‘çŽ°Liveness æŽ¢é’ˆå¤±è´¥æˆ–å®¹å™¨éœ€è¦é‡å¯ã€‚
# Kubelet å‘ç‰¹å®šçš„å®¹å™¨å‘é€ SIGTERM ä¿¡å·ã€‚
# Kubelet ç­‰å¾… terminationGracePeriodSeconds ç§’ï¼Œé»˜è®¤æ˜¯ 30 ç§’ã€‚
# å¦‚æžœåœ¨å®½é™æœŸå†…å®¹å™¨æœªé€€å‡ºï¼ŒKubelet å‘å®¹å™¨å‘é€ SIGKILL ä¿¡å·ã€‚
# Kubelet é€šè¿‡ CRI gRPC è¯·æ±‚ containerd æ¥åˆ é™¤å’Œé‡å¯è¿™ä¸ªå®¹å™¨ã€‚
```



##### ç‰¹åˆ«è¯´æ˜Ž

```ABAP
å½“ Kubernetes åˆ é™¤ä¸€ä¸ª Pod æ—¶ï¼ŒKubelet å‘å®¹å™¨å‘é€ SIGTERM ä¿¡å·çš„åŒæ—¶ï¼Œæ‰§è¡Œ preStop é’©å­ã€‚è¿™ä¸¤ä¸ªåŠ¨ä½œæ˜¯åŒæ—¶è§¦å‘çš„ã€‚å®½é™æœŸï¼ˆgrace periodï¼‰ä»Žè¿™ä¸¤ä¸ªæ“ä½œå¼€å§‹æ—¶è®¡æ—¶ï¼Œè¿™æ„å‘³ç€ preStop å¿…é¡»åœ¨å®½é™æœŸå†…å®Œæˆï¼Œå¦åˆ™ Kubelet ä¼šåœ¨å®½é™æœŸç»“æŸæ—¶ç›´æŽ¥å‘å®¹å™¨å‘é€ SIGKILLï¼Œä¸è®º preStop æ˜¯å¦å®Œæˆã€‚

preStop è§¦å‘çš„å…·ä½“æ—¶é—´ç‚¹
è§¦å‘ç‚¹
preStop åœ¨Kubelet å‘é€ SIGTERM çš„åŒæ—¶è§¦å‘ã€‚
è¿™ä¸¤ä¸ªæ“ä½œï¼ˆå‘é€ SIGTERM å’Œ æ‰§è¡Œ preStop é’©å­ï¼‰æ˜¯å¹¶è¡Œçš„ï¼Œä¸ä¾èµ–å½¼æ­¤ã€‚

å¦‚æžœ preStop æœªèƒ½åœ¨å®½é™æœŸå†…å®Œæˆï¼ŒKubelet ä»ä¼šåœ¨å®½é™æœŸç»“æŸåŽå‘é€ SIGKILLï¼Œè¿™ä¼šç«‹å³ç»ˆæ­¢å®¹å™¨
å¦‚æžœ preStop æœ¬èº«çš„é€»è¾‘ä¾èµ–äºŽè¾ƒé•¿æ—¶é—´çš„ä»»åŠ¡ï¼ˆå¦‚æ•°æ®è¿ç§»ã€æŒä¹…åŒ–æ“ä½œï¼‰ï¼Œä½ éœ€è¦ç¡®ä¿ preStop é’©å­åœ¨å®½é™æœŸå†…å®Œæˆã€‚
```





#### ä¸¤ç§é’©å­PostStartå’ŒPreStop



æ ¹æ®ä¸Šé¢Podçš„å¯åŠ¨æµç¨‹ï¼Œå½“å®¹å™¨ä¸­çš„è¿›ç¨‹å¯åŠ¨å‰æˆ–è€…å®¹å™¨ä¸­çš„è¿›ç¨‹ç»ˆæ­¢ä¹‹å‰éƒ½ä¼šæœ‰ä¸€äº›é¢å¤–çš„åŠ¨ä½œæ‰§ è¡Œï¼Œè¿™æ˜¯ç”±kubeletæ‰€è®¾ç½®çš„ï¼Œåœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º **pod hookã€‚**



å¯¹äºŽPodçš„æµç¨‹å¯åŠ¨ï¼Œä¸»è¦æœ‰ä¸¤ç§é’©å­ï¼š

- **postStart**ï¼š**å®¹å™¨åˆ›å»ºå®ŒæˆåŽç«‹å³è¿è¡Œ**ï¼Œä¸ä¿è¯ä¸€å®šä¼šäºŽå®¹å™¨ä¸­ENTRYPOINTä¹‹å‰è¿è¡Œ,è€ŒInit  Containerå¯ä»¥å®žçŽ°
- **preStop**ï¼š**å®¹å™¨ç»ˆæ­¢æ“ä½œä¹‹å‰ç«‹å³è¿è¡Œ**ï¼Œåœ¨å…¶å®Œæˆå‰ä¼šé˜»å¡žåˆ é™¤å®¹å™¨çš„æ“ä½œè°ƒç”¨



##### Poststarté’©å­

```yaml
# cat pod-poststart.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-poststart
spec:
  containers:
    - name: busybox
      image: busybox:1.32.0
      lifecycle:
        postStart:
          exec:
            command: ["/bin/sh","-c","echo lifecycle poststart at $(date) > /tmp/poststart.log"]
      command: ['sh', '-c', 'echo The app is running at $(date) ! && sleep 3600']
      
# æŸ¥çœ‹podæ‰§è¡Œ      
#[root@master1 yaml]#kubectl logs pod-poststart
#The app is running at Wed Dec 18 03:34:41 UTC 2024 !

#[root@master1 yaml]#kubectl exec pod-poststart -- cat /tmp/poststart.log
#lifecycle poststart at Wed Dec 18 03:34:41 UTC 2024
```

```ABAP
åŸºäºŽä¸Šè¿°çŽ°è±¡ï¼Œå®¹å™¨å¯åŠ¨å’ŒPostStarté’©å­å‡½æ•°æ‰§è¡Œï¼Œå‡ ä¹Žæ˜¯åŒæ—¶çš„
```



##### Prestopé’©å­

**åŠŸèƒ½**ï¼šå®žçŽ°podå¯¹è±¡ç§»é™¤ä¹‹å‰ï¼Œéœ€è¦åšä¸€äº›æ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚:é‡Šæ”¾èµ„æºï¼Œè§£é”ç­‰

ç¤ºä¾‹

```yaml
#ç”±äºŽé»˜è®¤æƒ…å†µä¸‹ï¼Œåˆ é™¤çš„åŠ¨ä½œå’Œæ—¥å¿—æˆ‘ä»¬éƒ½æ²¡æœ‰åŠžæ³•çœ‹åˆ°ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨ä¸€ç§é—´æŽ¥çš„æ–¹æ³•ï¼Œåœ¨åˆ é™¤åŠ¨ä½œä¹‹å‰ï¼Œç»™æœ¬åœ°ç›®å½•åˆ›å»ºç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œè¾“å…¥ä¸€äº›å†…å®¹
# cat pod-prestop.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-prestop
spec:
  volumes:
  - name: vol-prestop
    hostPath:
      path: /tmp
  containers:
  - name: prestop-pod-container
    image: busybox:1.32.0
    volumeMounts:
    - name: vol-prestop
      mountPath: /tmp
    command: ['sh', '-c', 'echo The app is running at $(date) ! && sleep 3600']
    lifecycle:
      postStart:
        exec:
          command: ['/bin/sh', '-c', 'echo lifecycle poststart at $(date) > /tmp/poststart.log']
      preStop:
        exec:
          command: ['/bin/sh', '-c', 'echo lifecycle prestop at $(date) > /tmp/prestop.log']
```



#### PodçŠ¶æ€



##### Pod phaseé˜¶æ®µï¼ˆç›¸ä½ï¼‰

![image-20241218141357779](D:\git_repository\cyber_security_learning\markdown_img\image-20241218141357779.png)

| Value     | Description                                                  |
| --------- | ------------------------------------------------------------ |
| Pending   | Pod å·²è¢« Kubernetes é›†ç¾¤æŽ¥å—ï¼Œä½†ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨å°šæœªè®¾ç½®å¹¶å‡†å¤‡å¥½è¿è¡Œã€‚ è¿™ åŒ…æ‹¬ Pod ç­‰å¾…è°ƒåº¦æ‰€èŠ±è´¹çš„æ—¶é—´ä»¥åŠé€šè¿‡ç½‘ç»œä¸‹è½½å®¹å™¨é•œåƒæ‰€èŠ±è´¹çš„æ—¶é—´ã€‚ |
| Running   | Pod å·²ç»ç»‘å®šåˆ°ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”æ‰€æœ‰çš„å®¹å™¨éƒ½å·²ç»åˆ›å»ºã€‚ è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨ä»åœ¨è¿ è¡Œï¼Œæˆ–è€…æ­£åœ¨å¯åŠ¨æˆ–é‡æ–°å¯åŠ¨ã€‚ |
| Succeeded | Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²æˆåŠŸç»ˆæ­¢ï¼Œå¹¶ä¸”ä¸ä¼šé‡æ–°å¯åŠ¨ã€‚             |
| Failed    | Pod ä¸­çš„æ‰€æœ‰å®¹å™¨éƒ½å·²ç»ˆæ­¢ï¼Œå¹¶ä¸”è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨å› æ•…éšœè€Œç»ˆæ­¢ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå®¹ å™¨è¦ä¹ˆä»¥éžé›¶çŠ¶æ€é€€å‡ºï¼Œè¦ä¹ˆè¢«ç³»ç»Ÿç»ˆæ­¢ã€‚ |
| Unknown   | ç”±äºŽæŸç§åŽŸå› ï¼Œæ— æ³•èŽ·å– Pod çš„çŠ¶æ€ã€‚ æ­¤é˜¶æ®µé€šå¸¸æ˜¯ç”±äºŽä¸Ž Pod åº”è¿è¡Œçš„èŠ‚ç‚¹é€š ä¿¡æ—¶å‡ºçŽ°é”™è¯¯è€Œå‘ç”Ÿçš„ã€‚ |





##### Pod çš„å¯åŠ¨æµç¨‹çŠ¶æ€

| æµç¨‹çŠ¶æ€        | æè¿°                              |
| --------------- | --------------------------------- |
| PodScheduled    | Podè¢«è°ƒåº¦åˆ°æŸä¸€ä¸ªèŠ‚ç‚¹             |
| Ready           | å‡†å¤‡å°±ç»ªï¼ŒPodå¯ä»¥å¤„ç†è¯·æ±‚         |
| Initialized     | Podä¸­æ‰€æœ‰åˆå§‹initå®¹å™¨å¯åŠ¨å®Œæ¯•     |
| Unschedulable   | ç”±äºŽèµ„æºç­‰é™åˆ¶ï¼Œå¯¼è‡´podæ— æ³•è¢«è°ƒåº¦ |
| ContainersReady | Podä¸­æ‰€æœ‰çš„å®¹å™¨éƒ½å¯åŠ¨å®Œæ¯•äº†       |





##### Podé‡å¯ç­–ç•¥ï¼ˆé¢è¯•é¢˜ï¼‰



**æ³¨æ„ï¼šåŒä¸€ä¸ª Pod å†…æ‰€æœ‰å®¹å™¨åªèƒ½ä½¿ç”¨ç»Ÿä¸€çš„é‡å¯ç­–ç•¥**



| é‡å¯ç­–ç•¥  | æè¿°                                                         |
| --------- | ------------------------------------------------------------ |
| Always    | æ— è®ºé€€å‡ºç exit codeæ˜¯å¦ä¸º0ï¼Œéƒ½è¦é‡å¯ï¼Œå³åªè¦é€€å‡ºå°±é‡å¯ï¼Œå¹¶ä¸”é‡å¯æ¬¡æ•°å¹¶æ²¡æœ‰é™åˆ¶ï¼Œæ­¤ä¸ºé»˜è®¤å€¼ |
| OnFailure | å®¹å™¨ç»ˆæ­¢è¿è¡Œé€€å‡ºç exit codeä¸ä¸º0æ—¶æ‰é‡å¯,é‡å¯æ¬¡æ•°å¹¶æ²¡æœ‰é™åˆ¶  |
| Never     | æ— è®ºä½•ç§é€€å‡ºç exit code,Podéƒ½ä¸é‡å¯ã€‚ä¸»è¦é’ˆå¯¹Jobå’ŒCronJob    |



ç¤ºä¾‹ï¼š

```bash
[root@master1 tmp]#kubectl get pod myapp-pod -o yaml|grep restartPolicy
  restartPolicy: Always
```



#####  Pod é•œåƒæ‹‰å–çŠ¶æ€ï¼ˆé¢è¯•é¢˜ï¼‰

| æ‹‰å–ç­–ç•¥     | æè¿°                                                         |
| ------------ | ------------------------------------------------------------ |
| Always       | æ€»æ˜¯æ‹‰å–æ–°é•œåƒï¼Œæ³¨æ„ï¼šå¦‚æžœ**é•œåƒçš„Tagä¸ºlatest**ï¼Œæ‹‰å–ç­–ç•¥ä¸ºalwaysæˆ– ifNotPresent éƒ½ä¼šé‡æ–°æ‹‰å–é•œåƒ |
| IfNotPresent | æ­¤ä¸ºé»˜è®¤å€¼ï¼Œå¦‚æžœæœ¬åœ°ä¸å­˜åœ¨çš„è¯ï¼Œå†æ‹‰å–æ–°é•œåƒï¼Œä¾‹å¤–æƒ…å†µ:å¦‚æžœé•œåƒçš„Tagä¸º latestï¼Œä»ä¼šé‡æ–°æ‹‰å–é•œåƒ |
| Never        | åªä½¿ç”¨æœ¬åœ°çš„é•œåƒï¼Œä»Žä¸èŽ·å–æ–°é•œåƒ                             |



```bash
[root@master1 tmp]#kubectl get pod myapp-pod -o yaml|grep imagePullPolicy
    imagePullPolicy: IfNotPresent   # é»˜è®¤å€¼
```





##### PodçŠ¶æ€æ±‡æ€»

| çŠ¶æ€                       | æè¿°                                                         |
| -------------------------- | ------------------------------------------------------------ |
| Pending                    | APIserverå·²ç»åˆ›å»ºè¯¥podå¯¹è±¡ï¼Œä½†æ˜¯kubeletå¯åŠ¨å®¹å™¨ä¹‹å‰ï¼Œéƒ½å¤„äºŽPendingçŠ¶æ€ |
| Running                    | Podå†…æ‰€æœ‰çš„å®¹å™¨å·²åˆ›å»ºï¼Œä¸”**è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨å¤„äºŽè¿è¡ŒçŠ¶æ€**ï¼Œæ­£ åœ¨å¯åŠ¨æˆ–é‡å¯çŠ¶æ€ |
| Waiting                    | Pod ç­‰å¾…å¯åŠ¨ä¸­                                               |
| Terminating                | Pod æ­£åœ¨åˆ é™¤ï¼Œè‹¥è¶…è¿‡ç»ˆæ­¢å®½é™æœŸä»æ— æ³•åˆ é™¤ï¼Œå¯ä»¥å¼ºåˆ¶åˆ é™¤ kubectl delete pod  -n --grace-period=0 --force |
| Succeeded                  | æ‰€æœ‰å®¹å™¨å‡æˆåŠŸæ‰§è¡Œé€€å‡ºï¼Œä¸”ä¸ä¼šå†é‡å¯                         |
| Ready                      | Pod å·²ç»å‡†å¤‡å¥½,å¯ä»¥æä¾›æœåŠ¡                                  |
| Failed                     | Podå†…æ‰€æœ‰å®¹å™¨éƒ½å·²é€€å‡ºï¼Œå…¶ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨é€€å‡ºå¤±è´¥            |
| CrashLookBackOff           | æ›¾ç»å¯åŠ¨PodæˆåŠŸï¼Œä½†æ˜¯åŽæ¥å¼‚å¸¸æƒ…å†µä¸‹ï¼Œé‡å¯æ¬¡æ•°è¿‡å¤šå¯¼è‡´å¼‚å¸¸<br />**ç»ˆæ­¢Podé€€é¿ç®—æ³•**ï¼šç¬¬1æ¬¡0ç§’ç«‹åˆ»é‡å¯ï¼Œç¬¬äºŒæ¬¡10ç§’åŽé‡å¯ï¼Œç¬¬ä¸‰æ¬¡ 20ç§’åŽé‡å¯, ... ç¬¬6æ¬¡160ç§’åŽé‡å¯ï¼Œç¬¬7æ¬¡300ç§’åŽé‡å¯ï¼Œå¦‚ä»ç„¶ é‡å¯å¤±è´¥ï¼Œåˆ™ä¸º CrashLookBackOffçŠ¶æ€ |
| Error                      | å› ä¸ºé›†ç¾¤é…ç½®ã€å®‰å…¨é™åˆ¶ã€èµ„æºç­‰åŽŸå› å¯¼è‡´Pod å¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿ äº†é”™è¯¯ |
| Evicted                    | é›†ç¾¤èŠ‚ç‚¹ç³»ç»Ÿ**å†…å­˜æˆ–ç¡¬ç›˜èµ„æºä¸è¶³**å¯¼è‡´Podå‡ºçŽ°å¼‚å¸¸            |
| Completed                  | è¡¨ç¤ºPodå·²ç»æ‰§è¡Œå®Œæˆ,æ¯”å¦‚: **ä¸€æ¬¡æ€§çš„Jobæˆ–å‘¨æœŸæ€§çš„CronJob**ä¸­ çš„Podæ‰§è¡Œå®ŒæˆåŽ,ä¼šæ˜¾ç¤ºæ­¤çŠ¶æ€ |
| Unschedulable              | Pod ä¸èƒ½è°ƒåº¦åˆ°èŠ‚ç‚¹,ä¸€èˆ¬å¯èƒ½æ˜¯å› ä¸ºæ²¡æœ‰åˆé€‚çš„èŠ‚ç‚¹ä¸»æœº          |
| PodScheduled               | Pod æ­£åœ¨è¢«è°ƒåº¦è¿‡ç¨‹,ä½†æ­¤çŠ¶æ€çš„æ—¶é—´å¾ˆçŸ­                        |
| Initialized                | Podä¸­æ‰€æœ‰åˆå§‹initå®¹å™¨å¯åŠ¨å®Œæ¯•                                |
| ImagePullBackOff           | Podå¯¹åº”çš„é•œåƒæ‹‰å–å¤±è´¥                                        |
| InvalidImageName           | é•œåƒåç§°æ— æ•ˆå¯¼è‡´é•œåƒæ— æ³•ä¸‹è½½                                 |
| ImageInspectError          | é•œåƒæ£€æŸ¥é”™è¯¯ï¼Œé€šå¸¸å› ä¸ºé•œåƒä¸å®Œæ•´                             |
| ErrlmageNeverPull          | æ‹‰å–é•œåƒå› ç­–ç•¥ç¦æ­¢é”™è¯¯ï¼Œ**é•œåƒä»“åº“æƒé™æ‹’ç»æˆ–ç§æœ‰å¯¼è‡´**       |
| RegistryUnavailable        | é•œåƒä»“åº“æœåŠ¡ä¸å¯ç”¨ï¼Œæ¯”å¦‚:ç½‘ç»œåŽŸå› æˆ–ä»“åº“æœåŠ¡å™¨å®•æœº            |
| ErrImagePull               | é•œåƒæ‹‰å–é”™è¯¯ï¼Œå¯èƒ½æ˜¯å› ä¸ºè¶…æ—¶æˆ–æ‹‰å–è¢«å¼ºè¡Œç»ˆæ­¢                 |
| NetworkPluginNotReady      | ç½‘ç»œæ’ä»¶å¼‚å¸¸,ä¼šå¯¼è‡´æ–°å»ºå®¹å™¨å‡ºé”™,ä½†æ—§çš„å®¹å™¨ä¸å—å½±å“           |
| NodeLost                   | Podæ‰€åœ¨èŠ‚ç‚¹æ— æ³•è”ç³»                                          |
| CreateContainerConfigError | åˆ›å»ºå®¹å™¨é…ç½®é”™è¯¯                                             |
| CreateContainerError       | åˆ›å»ºå®¹å™¨é”™è¯¯                                                 |
| RunContainerError          | è¿è¡Œå®¹å™¨é”™è¯¯ï¼Œæ¯”å¦‚:å®¹å™¨ä¸­æ²¡æœ‰PIDä¸º1çš„å‰å°è¿›ç¨‹ç­‰åŽŸå›           |
| ContainersNotInitialized   | å®¹å™¨æ²¡æœ‰åˆå§‹åŒ–å®Œæˆ                                           |
| ContainersNotReady         | å®¹å™¨æ²¡æœ‰å‡†å¤‡å¥½                                               |
| ContainerCreating          | å®¹å™¨æ­£åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­                                           |
| PodInitializing            | å®¹å™¨æ­£åœ¨åˆå§‹åŒ–ä¸­                                             |
| DockerDaemonNotReady       | èŠ‚ç‚¹çš„DockeræœåŠ¡å¼‚å¸¸                                         |
|                            |                                                              |



#### Pod çš„å¥åº·çŠ¶æ€ç›‘æµ‹



##### Podçš„çŠ¶æ€ç›‘æŽ§

å®žé™…ä¸Šï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§å¯ä»¥åŠæ—¶çš„èŽ·å–å®¹å™¨çš„å„ç§è¿è¡ŒçŠ¶æ€æ•°æ®ï¼Œæ‰€ä»¥å¯¹äºŽå®¹å™¨ä»»åŠ¡ç¼–æŽ’çš„çŽ¯å¢ƒä¸‹ï¼Œä»–ä»¬éƒ½åº”è¯¥è€ƒè™‘åˆ°ä¸€ç§åœºæ™¯ï¼šä¸»åŠ¨çš„å°†å®¹å™¨è¿è¡Œçš„ç›¸å…³æ•°æ®æš´éœ²å‡ºæ¥ -- **æ•°æ®æš´éœ²æŽ¥å£**ã€‚æ¯”å¦‚ï¼šåŒ…å«å¤§é‡ metricæŒ‡æ ‡æ•°æ®çš„APIæŽ¥å£ã€‚



å¯¹äºŽkuberneteså†…éƒ¨çš„podçŽ¯å¢ƒæ¥è¯´ï¼Œå¸¸è§çš„è¿™äº›APIæŽ¥å£æœ‰ï¼š

![image-20241218150953385](D:\git_repository\cyber_security_learning\markdown_img\image-20241218150953385.png)



```bash
process health #çŠ¶æ€å¥åº·æ£€æµ‹æŽ¥å£
readiness #å®¹å™¨å¯è¯»çŠ¶æ€çš„æŽ¥å£
liveness #å®¹å™¨å­˜æ´»çŠ¶æ€çš„æŽ¥å£
metrics #ç›‘æŽ§æŒ‡æ ‡æŽ¥å£
tracing #å…¨é“¾è·¯ç›‘æŽ§çš„åŸ‹ç‚¹(æŽ¢é’ˆ)æŽ¥å£
logs #å®¹å™¨æ—¥å¿—æŽ¥å£
```





##### Pod çš„å¥åº·æ€§ç›‘æŽ§

Pod é€šè¿‡**æŽ¢é’ˆ**è¦åˆ¶å®žçŽ°Pod å¥åº·æ€§ç›‘æŽ§,å½“ä¸€æ—¦æ£€æµ‹å‡ºPodæ•…éšœæ—¶ï¼Œä¼š**é‡ç½®Pod**æˆ–**å°†Podä»ŽserviceåŽç«¯ endpointåˆ é™¤**ï¼Œä»Žè€Œå®žçŽ°æœåŠ¡çš„é«˜å¯ç”¨



**æŽ¢é’ˆç±»åž‹**

é’ˆå¯¹è¿è¡Œä¸­çš„å®¹å™¨ï¼Œ kubelet å¯ä»¥é€‰æ‹©æ˜¯å¦æ‰§è¡Œä»¥ä¸‹ä¸‰ç§æŽ¢é’ˆï¼Œä»¥åŠå¦‚ä½•é’ˆå¯¹æŽ¢æµ‹ç»“æžœä½œå‡ºååº”



![image-20241218151223781](D:\git_repository\cyber_security_learning\markdown_img\image-20241218151223781.png)

**è¿‡ç¨‹è¯¦è§£**



- åˆå§‹åˆšå¯åŠ¨å®¹å™¨çš„æ—¶å€™ï¼Œæœ‰ä¸ªåˆå§‹åŒ–æ—¶é—´ï¼ˆ**InitialDelaySeconds for Startup Probe**è¯¥æ—¶é—´å¯ä»¥è‡ªå·±å®šä¹‰ï¼‰ï¼Œç„¶åŽåœ¨æ‰§è¡Œ**Startup Probe** Execution
  - è¿™ç§å¯èƒ½ä½¿ç”¨çš„åœºæ™¯ï¼šjavaç¨‹åºå¯åŠ¨è¾ƒæ…¢ï¼Œå®¹å™¨å¯åŠ¨æ—¶é—´å¯èƒ½æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥éœ€è¦å®¹å™¨å¯åŠ¨ä¸€æ®µæ—¶é—´åŽï¼Œå†ä½¿ç”¨**Startup Probe**è¿›è¡ŒæŽ¢æµ‹ï¼Œå¦åˆ™å¯èƒ½å®¹å™¨è¿˜æœªå¯åŠ¨æˆåŠŸï¼ŒStartup Probeå°±å¼€å§‹æŽ¢æµ‹ï¼Œä¼šæŽ¢æµ‹å¤±è´¥
  - è€ŒStartup Probe**æŽ¢æµ‹å¤±è´¥**çš„ç»“æžœæ˜¯å®¹å™¨ä¼š**ç«‹å³é‡å¯**
  - **Startup ProbeåªæŽ¢æµ‹ä¸€æ¬¡ï¼ŒæŽ¢æµ‹æˆåŠŸåŽï¼ŒåŽç»­ä¸ä¼šå†æŽ¢æµ‹**

- å®¹å™¨å¯åŠ¨æˆåŠŸåŽï¼ŒåŽç»­ä¼šæœ‰ä¸¤ä¸ªæŽ¢é’ˆLivness Probeå’ŒReadiness Probeï¼Œåœ¨ä¸¤ä¸ªæŽ¢é’ˆä¹‹å‰ï¼Œåˆ†åˆ«æœ‰ä¸¤ä¸ªç­‰å¾…æ—¶é—´ï¼Œå³
  - Livness Probe ----- initialDelaySeconds for Liveness Probe
  - Readiness Probe ----- initialDelaySeconds for Readiness Probe
- å¦‚æžœLiveness Probeæ£€æµ‹å¤±è´¥ï¼Œä¼šé‡å¯å®¹å™¨
- å¦‚æžœReadiness ProbeæŽ¢æµ‹å¤±è´¥ï¼Œä¸ä¼šé‡å¯å®¹å™¨ï¼Œè€Œæ˜¯å°†å®¹å™¨ä»Žè°ƒåº¦åˆ—è¡¨ä¸­ç§»é™¤
  - ç”¨æˆ·é€šå¸¸æ˜¯é€šè¿‡serviceæ¥è®¿é—®åŽç«¯çš„Podï¼Œå¦‚æžœReadiness Probeæ£€æµ‹å¤±è´¥ï¼Œä¼šå°†å…¶ä»ŽServiceçš„åˆ—è¡¨ä¸­ç§»é™¤ï¼Œä½†æ˜¯Podä¸ä¼šé‡å¯
- å¦‚æžœLiveness Probeæ£€æµ‹æˆåŠŸåŽï¼Œä¼šæœ‰ä¸€ä¸ªç­‰å¾…çš„æ—¶é—´ï¼Œå³PeriodSecondsï¼Œç„¶åŽä¼šç»§ç»­æŽ¢æµ‹ï¼Œä¹Ÿå°±æ˜¯è¯´åŽç»­ä¼šå‘¨æœŸæ€§æŽ¢æµ‹ï¼Œæ¯è¿‡PeriodSecondsæ—¶é—´ï¼Œä¼šæŽ¢æµ‹ä¸€æ¬¡
- å¦‚æžœReadiness Probeæ£€æµ‹æˆåŠŸï¼Œä¹Ÿä¼šæœ‰ä¸€ä¸ªç­‰å¾…çš„äº‹ä»¶ï¼Œå³PeriodSecondsï¼Œç„¶åŽä¼šç»§ç»­æŽ¢æµ‹



##### é…ç½®æŽ¢é’ˆ

probeæœ‰å¾ˆå¤šé…ç½®å­—æ®µï¼Œå¯ä»¥ä½¿ç”¨è¿™äº›å­—æ®µç²¾ç¡®åœ°æŽ§åˆ¶å¯åŠ¨ï¼Œå­˜æ´»å’Œå°±ç»ªæ£€æµ‹çš„è¡Œä¸º

- `initialDelaySeconds`ï¼šå®¹å™¨å¯åŠ¨åŽè¦ç­‰åˆ°å¤šå°‘ç§’åŽï¼Œæ‰å¯åŠ¨**å¯åŠ¨**ï¼Œ**å­˜æ´»**ï¼Œ**å°±ç»ª**æŽ¢é’ˆï¼Œé»˜è®¤æ˜¯0ç§’ï¼Œæœ€å°å€¼æ˜¯0.
- `periodSeconds`ï¼šæ‰§è¡ŒæŽ¢æµ‹çš„æ—¶é—´é—´éš”ï¼ˆå•ä½æ˜¯ç§’ï¼‰ã€‚é»˜è®¤æ˜¯10ç§’ï¼Œæœ€å°å€¼æ˜¯1ã€‚
- `timeoutSeconds`ï¼šæŽ¢æµ‹è¶…æ—¶åŽï¼Œç­‰å¾…å¤šå°‘ç§’ã€‚é»˜è®¤å€¼æ˜¯1ç§’ï¼Œæœ€å°å€¼æ˜¯1
- `successThreshold`ï¼šæŽ¢é’ˆåœ¨å¤±è´¥åŽï¼Œè¢«è§†ä¸ºæˆåŠŸçš„æœ€å°è¿žç»­æˆåŠŸæ•°ã€‚é»˜è®¤å€¼æ˜¯1.å­˜æ´»å’Œå¯åŠ¨æŽ¢æµ‹çš„è¿™ä¸ªå€¼å¿…é¡»æ˜¯1ï¼Œæœ€å°å€¼æ˜¯1
- `failureThreshold`ï¼šå½“æŽ¢æµ‹å¤±è´¥æ—¶ï¼ŒKubernetesçš„é‡è¯•æ¬¡æ•°ã€‚å¯¹å­˜æ´»æŽ¢é’ˆè€Œè¨€ã€‚æ”¾å¼ƒå°±æ„å‘³ç€é‡æ–°å¯åŠ¨å®¹å™¨
  - å¯¹å°±ç»ªæŽ¢é’ˆè€Œè¨€ï¼Œæ”¾å¼ƒæ„å‘³ç€POdä¼šè¢«æ‰“ä¸Šæœªå°±ç»ªçš„æ ‡ç­¾ã€‚é»˜è®¤æ˜¯3ï¼Œæœ€å°å€¼æ˜¯1





![image-20241218151415616](D:\git_repository\cyber_security_learning\markdown_img\image-20241218151415616.png)

``````yaml
spec:
  containers:
  - name: string
    image: string
    livenessProbe:
      exec <Object>                    # å‘½ä»¤å¼æŽ¢é’ˆ
      httpGet <Object>                 # http GETç±»åž‹çš„æŽ¢é’ˆ
      tcpSocket <Object>               # tcp Socketç±»åž‹çš„æŽ¢é’ˆ
      initialDelaySeconds <integer>    # å‘èµ·åˆæ¬¡æŽ¢æµ‹è¯·æ±‚å‰çš„å»¶è¿Ÿæ—¶é•¿ï¼Œé»˜è®¤ä¸º0ï¼Œç”Ÿäº§æ ¹æ®æœåŠ¡èµ·å“¦å¤šåŠŸèƒ½æ—¶é•¿æ¥è®¾ç½®ï¼Œæ¯”å¦‚60s
      periodSeconds <integer>          # æ¯æ¬¡æŽ¢é’ˆè¯·æ±‚é—´éš”ï¼Œå³æŽ¢æµ‹çš„å‘¨æœŸï¼Œé»˜è®¤10sï¼Œå¦‚æžœPodä¼—å¤šï¼Œå¯é€‚å½“è®¾é•¿ï¼Œæ¯”å¦‚60s
      timeoutSeconds <integer>         # æŽ¢æµ‹çš„è¶…æ—¶æ—¶é•¿ï¼Œé»˜è®¤æ˜¯1s
      successThreshold <integer>       # è¿žç»­æˆåŠŸå‡ æ¬¡æ‰è¡¨ç¤ºçŠ¶æ€æ­£å¸¸ï¼Œé»˜è®¤å€¼æ˜¯1æ¬¡ï¼Œæ³¨æ„ï¼šlivenesså’Œstartupåªèƒ½æ˜¯1
      failureThreshold <integer>       # è¿žç»­å¤±è´¥å‡ æ¬¡æ‰è¡¨ç¤ºçŠ¶æ€å¼‚å¸¸ï¼Œé»˜è®¤å€¼æ˜¯3æ¬¡ï¼Œå³ä»ŽæˆåŠŸå˜ä¸ºå¤±è´¥çš„æ£€æŸ¥æ¬¡æ•°
``````



##### å®žçŽ°æŽ¢é’ˆçš„ä¸‰ç§æ–¹å¼

å¯¹äºŽPodä¸­å¤šå®¹å™¨çš„åœºæ™¯ï¼Œåªæœ‰æ‰€æœ‰å®¹å™¨å°±ç»ªï¼Œæ‰è®¤ä¸ºPodå°±ç»ª

kubelet å®šæœŸæ‰§è¡ŒLivenessProbeå’ŒReadinessProbeæŽ¢é’ˆæ¥è¯Šæ–­Podçš„å¥åº·çŠ¶å†µï¼ŒPodæŽ¢é’ˆçš„å®žçŽ°æ–¹å¼ æœ‰å¾ˆå¤šï¼Œå¸¸è§çš„æœ‰å¦‚ä¸‹ä¸‰ç§ï¼š

| ç›‘æµ‹çš„å®žçŽ°æ–¹å¼ | è§£æž                                                         |
| -------------- | ------------------------------------------------------------ |
| Exec           | ç›´æŽ¥æ‰§è¡ŒæŒ‡å®šçš„å‘½ä»¤ï¼Œ**æ ¹æ®**å‘½ä»¤ç»“æžœçš„**çŠ¶æ€ç $?åˆ¤æ–­æ˜¯å¦æˆåŠŸ**ï¼ŒæˆåŠŸåˆ™è¿”å›žè¡¨ç¤ºæŽ¢æµ‹æˆåŠŸ |
| TCPSocket      | æ ¹æ®ç›¸åº”TCPå¥—æŽ¥å­—è¿žæŽ¥å»ºç«‹çŠ¶æ€åˆ¤æ–­,å¦‚æžœ**ç«¯å£èƒ½æ­£å¸¸æ‰“å¼€**ï¼Œå³æˆåŠŸ |
| HTTPGet        | æ ¹æ®æŒ‡å®šHttp/HttpsæœåŠ¡URLçš„å“åº”ç ç»“æžœåˆ¤æ–­ï¼Œå½“**2xx, 3xxçš„å“åº”ç è¡¨ç¤ºæˆåŠŸ** |
| gRPC           | ä½¿ç”¨ gRPC æ‰§è¡Œä¸€ä¸ªè¿œç¨‹è¿‡ç¨‹è°ƒç”¨ã€‚ ç›®æ ‡åº”è¯¥å®žçŽ° gRPCå¥åº·æ£€æŸ¥ã€‚ å¦‚æžœ**å“åº”çš„çŠ¶æ€æ˜¯ "SERVING"**ï¼Œåˆ™è®¤ä¸ºè¯Šæ–­æˆåŠŸã€‚ gRPC æŽ¢é’ˆæ˜¯ä¸€ä¸ª Alpha ç‰¹æ€§ï¼Œåªæœ‰åœ¨ä½ å¯ç”¨ äº† "GRPCContainerProbe" ç‰¹æ€§é—¨æŽ§æ—¶æ‰èƒ½ä½¿ç”¨ |

![image-20241219155655923](D:\git_repository\cyber_security_learning\markdown_img\image-20241219155655923.png)

##### Execæ–¹å¼æ¡ˆä¾‹

exec å…¶å®žå°±æ˜¯å°è¯•é€šè¿‡åœ¨å®¹å™¨å†…éƒ¨æ¥æ‰§è¡Œä¸€ä¸ªå‘½ä»¤ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰§è¡ŒæˆåŠŸï¼Œå¦‚æžœæˆåŠŸï¼Œé‚£ä¹ˆè¯´æ˜Žè¯¥å¯¹è±¡ æ˜¯æ­£å¸¸çš„ï¼Œå¦åˆ™å°±æ˜¯å¤±è´¥çš„ã€‚

èŒƒä¾‹ï¼šstartup probe

```yaml
# cat pod-startup-exec.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-startup-exec
  namespace: default
  labels:
    app: pod-startup-exec
spec:
  containers:
  - name: pod-startup-exec-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    startupProbe:
      exec:
        command: ['/bin/sh', '-c', '["`$(curl -s 127.0.0.1/lives)" == "0k" ]']
      initialDelaySeconds: 60
      timeoutSeconds: 1
      periodSeconds: 5
      successThreshold: 1
      failureThreshold: 1
      
# å¯åŠ¨POd
kubectl apply -f pod-startup-exec.yaml

# æŸ¥çœ‹
[root@master1 yaml]#kubectl get pod 
NAME               READY   STATUS    RESTARTS      AGE
pod-startup-exec   0/1     Running   2 (12s ago)   3m28s

# è§£æžREADY 0/1
# EADY = å½“å‰â€œå¤„äºŽå°±ç»ª(Ready)çŠ¶æ€çš„å®¹å™¨æ•°â€ / Pod ä¸­çš„æ€»å®¹å™¨æ•°

# è¿™ä¸ªpodé‡Œçš„å®¹å™¨é‡Œçš„ç¨‹åºæ˜¯æ•…æ„ç¬¬ä¸€æ¬¡å¯åŠ¨ä¼šæœ‰ä¸€ä¸ªå»¶è¿Ÿï¼Œè¶…è¿‡1s,ï¼Œå› ä¸ºtimeoutSeconds: 1ï¼Œå› æ­¤ä¼šæ£€æµ‹å¤±è´¥ï¼Œunhealthyï¼Œå¯¼è‡´é‡å¯
# åŽç»­ä¼šå¾ªçŽ¯é‡å¯

# è§£å†³æ–¹æ¡ˆï¼šå°†è¶…æ—¶æ—¶é—´æ”¹ä¸º10
```



èŒƒä¾‹ï¼šlivenessProbe

```yaml
# cat pod-liveness-exec-cmd.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-exec-cmd
  namespace: default
spec:
  containers:
  - name: pod-liveness-exec-cmd-container
    image: busybox:1.32.0
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c", "touch /tmp/healthy; sleep 3; rm -f /tmp/healthy; sleep 3600"]
    livenessProbe:
      exec:
        command: ["test", "-e", "/tmp/healthy"]
      initialDelaySeconds: 1
      periodSeconds: 3
      
# åˆ›å»ºå®¹å™¨
kubectl apply -f pod-liveness-exec-cmd.yaml

# å®žæ—¶ç›‘æŽ§ï¼Œå‘çŽ°ä¸æ–­é‡å¯
[root@master1 yaml]#kubectl get pod pod-liveness-exec-cmd -w
NAME                    READY   STATUS    RESTARTS   AGE
pod-liveness-exec-cmd   1/1     Running   0          22s
pod-liveness-exec-cmd   1/1     Running   1 (1s ago)   55s
pod-liveness-exec-cmd   1/1     Running   2 (5s ago)   101s
pod-liveness-exec-cmd   1/1     Running   3 (1s ago)   2m19s
pod-liveness-exec-cmd   1/1     Running   4 (1s ago)   3m1s
pod-liveness-exec-cmd   1/1     Running   5 (0s ago)   3m42s
pod-liveness-exec-cmd   0/1     CrashLoopBackOff   5 (1s ago)   4m25s
pod-liveness-exec-cmd   1/1     Running            6 (85s ago)   5m49s
pod-liveness-exec-cmd   0/1     CrashLoopBackOff   6 (1s ago)    6m31s
pod-liveness-exec-cmd   1/1     Running            7 (2m50s ago)   9m20s
pod-liveness-exec-cmd   0/1     CrashLoopBackOff   7 (1s ago)      10m
pod-liveness-exec-cmd   1/1     Running            8 (5m5s ago)    15m
pod-liveness-exec-cmd   1/1     Running            9 (1s ago)      15m
pod-liveness-exec-cmd   0/1     CrashLoopBackOff   9 (1s ago)      16m
```



##### Tcpsocketæ–¹å¼æ¡ˆä¾‹

ä½¿ç”¨æ­¤é…ç½®ï¼Œ kubelet å°†å°è¯•åœ¨æŒ‡å®šç«¯å£ä¸Šæ‰“å¼€å®¹å™¨çš„å¥—æŽ¥å­—ã€‚å¦‚æžœå¯ä»¥å»ºç«‹è¿žæŽ¥ï¼Œå®¹å™¨è¢«è®¤ä¸ºæ˜¯å¥åº· çš„ï¼Œå¦‚æžœä¸èƒ½å°±è®¤ä¸ºæ˜¯å¤±è´¥çš„ï¼Œå®žé™…ä¸Šå°±æ˜¯**æ£€æŸ¥ç«¯å£**ã€‚

å¯¹äºŽ TCP æŽ¢æµ‹è€Œè¨€ï¼Œkubelet åœ¨èŠ‚ç‚¹ä¸Šï¼ˆä¸æ˜¯åœ¨ Pod é‡Œé¢ï¼‰å‘èµ·æŽ¢æµ‹è¿žæŽ¥ï¼Œ è¿™æ„å‘³ç€ä½ ä¸èƒ½åœ¨ host å‚æ•°ä¸Šé…ç½®æœåŠ¡åç§°ï¼Œå› ä¸º kubelet ä¸èƒ½è§£æžæœåŠ¡åç§°ã€‚



**livenessçš„TcpsocketæŽ¢é’ˆ**

```yaml
# cat pod-liveness-tcpsocket.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-tcpsocket
  namespace: default
spec:
  containers:
  - name: pod-liveness-tcpsocket-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    ports:
    - name: http           # ç»™æŒ‡å®šç«¯å£å®šä¹‰åˆ«å
      containerPort: 80
    securityContext:       # æ·»åŠ ç‰¹æƒï¼Œå¦åˆ™æ·»åŠ iptablesè§„åˆ™ä¼šæç¤ºï¼šgetsockopt failed strangely: Operation not permitted
      capabilities:
        add:
        - NET_ADMIN
    livenessProbe:
      tcpSocket:
        port: http        # å¼•ç”¨ä¸Šé¢ç«¯å£çš„å®šä¹‰
      periodSeconds: 5
      initialDelaySeconds: 5
      
# æ³¨æ„ï¼šç”±äºŽæ­¤é•œåƒåº”ç”¨å¯¹å¤–æš´éœ²çš„ç«¯å£æ˜¯80ç«¯å£ï¼Œæ‰€ä»¥è¦æŽ¢æµ‹80ç«¯å£

# æ¨¡æ‹ŸæŽ¢æµ‹å¤±è´¥ï¼Œæ·»åŠ é˜²ç«å¢™è§„åˆ™ï¼Œç¦æ­¢æŽ¢æµ‹
kubectl exec pod-liveness-tcpsocket -- iptables -A INPUT -p tcp --dport 80 -j REJECT

# æŸ¥çœ‹çŠ¶æ€å¼‚å¸¸
kubectl describe pod pod-liveness-tcpsocket
...
Events:
  Type     Reason     Age               From               Message
  ----     ------     ----              ----               -------
  Normal   Scheduled  98s               default-scheduler  Successfully assigned default/pod-liveness-tcpsocket to node1
  Normal   Pulled     98s               kubelet            Container image "registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1" already present on machine
  Normal   Created    98s               kubelet            Created container pod-liveness-tcpsocket-container
  Normal   Started    97s               kubelet            Started container pod-liveness-tcpsocket-container
  Warning  Unhealthy  3s (x3 over 13s)  kubelet            Liveness probe failed: dial tcp 10.244.1.15:80: connect: connection refused
  Normal   Killing    3s                kubelet            Container pod-liveness-tcpsocket-container failed liveness probe, will be restarted
  
# æ³¨æ„ï¼šlivenessProbeæŽ¢æµ‹å¤±è´¥ï¼Œä¼šé‡å¯å®¹å™¨ï¼Œè€Œé‡å¯å®¹å™¨å¹¶ä¸æ˜¯é‡æ–°åˆ›å»ºå®¹å™¨ï¼Œå› æ­¤å†…æ ¸ç›¸å…³åŠŸèƒ½æ— æ³•é‡ç½®ï¼Œä¹Ÿå°±å¯¼è‡´å³ä¾¿é‡å¯ï¼Œé˜²ç«å¢™è§„åˆ™ä»ç„¶åœ¨ï¼Œä¼šå¯¼è‡´æŽ¢æµ‹å¤±è´¥ï¼ŒåŽç»­ä¸æ–­é‡å¯
```



**Readinessçš„TcpsocketæŽ¢é’ˆ**

```yaml
# cat pod-readiness-tcpsocket.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-readiness-tcpsocket
  labels: 
    app: pod-readiness-tcpsocket
spec:
  containers:
  - name: pod-readiness-tcpsocket-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    readinessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 5
      periodSeconds: 10
    livenessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: pod-readiness-tcpsocket-svc
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: pod-readiness-tcpsocket     # æŒ‡å®šä¸Šé¢Podç›¸åŒçš„æ ‡ç­¾
    
# æŸ¥çœ‹Serviceçš„IP    
[root@master1 yaml]# kubectl get svc
NAME                          TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
kubernetes                    ClusterIP   10.96.0.1      <none>        443/TCP   25h
pod-readiness-tcpsocket-svc   ClusterIP   10.104.62.95   <none>        80/TCP    8s

# curl 10.104.62.95
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
...


# å°†readniessProbeä¸Šçš„æŽ¢æµ‹ç«¯å£æ”¹ä¸º8080ï¼Œå› ä¸ºæ²¡æœ‰æ‰“å¼€8080ç«¯å£ï¼Œå› æ­¤readinessProbeå¿…ç„¶å¤±è´¥
# cat pod-readiness-tcpsocket.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-readiness-tcpsocket
  labels: 
    app: pod-readiness-tcpsocket
spec:
  containers:
  - name: pod-readiness-tcpsocket-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    readinessProbe:
      tcpSocket:
        port: 8080                 # æ”¹ä¸º8080
      initialDelaySeconds: 5
      periodSeconds: 10
    livenessProbe:
      tcpSocket:
        port: 80
      initialDelaySeconds: 15
      periodSeconds: 20
---
apiVersion: v1
kind: Service
metadata:
  name: pod-readiness-tcpsocket-svc
spec:
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: pod-readiness-tcpsocket     # æŒ‡å®šä¸Šé¢Podç›¸åŒçš„æ ‡ç­¾
    
# åˆ›å»ºèµ„æº
[root@master1 yaml]#kubectl apply -f pod-readiness-tcpsocket.yaml 
pod/pod-readiness-tcpsocket created
service/pod-readiness-tcpsocket-svc created

# æŸ¥çœ‹çŠ¶æ€
[root@master1 yaml]#kubectl get pod
NAME                      READY   STATUS    RESTARTS   AGE
pod-readiness-tcpsocket   0/1     Running   0          4s
pod-startup-exec          1/1     Running   0          3h26m

[root@master1 yaml]#kubectl describe pod pod-readiness-tcpsocket 
...
Events:
  Type     Reason     Age               From               Message
  ----     ------     ----              ----               -------
  Normal   Scheduled  25s               default-scheduler  Successfully assigned default/pod-readiness-tcpsocket to node1
  Normal   Pulled     24s               kubelet            Container image "registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0" already present on machine
  Normal   Created    24s               kubelet            Created container pod-readiness-tcpsocket-container
  Normal   Started    24s               kubelet            Started container pod-readiness-tcpsocket-container
  Warning  Unhealthy  4s (x2 over 14s)  kubelet            Readiness probe failed: dial tcp 10.244.1.17:8080: connect: connection refused

# å¯ä»¥çœ‹åˆ°Readiness Probeå¤±è´¥
# è§‚å¯ŸServiceçš„ep
[root@master1 yaml]#kubectl get ep
NAME                          ENDPOINTS         AGE
kubernetes                    10.0.0.201:6443   25h
pod-readiness-tcpsocket-svc                     41s

# ç”±äºŽreadniessProbeæŽ¢æµ‹å¤±è´¥ï¼Œå› æ­¤å°†Podä»Žserviceçš„endponitsåˆ—è¡¨ç§»é™¤
```



##### HttpGetæ–¹å¼æ¡ˆä¾‹

HTTP æŽ¢æµ‹é€šè¿‡å¯¹å®¹å™¨å†…å®¹å¼€æ”¾çš„webæœåŠ¡ï¼Œè¿›è¡Œhttpæ–¹æ³•çš„è¯·æ±‚æŽ¢æµ‹ï¼Œå¦‚æžœ**æŽ¢æµ‹æˆåŠŸ(çŠ¶æ€ç ä¸º2XXå’Œ 3XX)**ï¼Œé‚£ä¹ˆè¡¨ç¤ºhttpæœåŠ¡æ˜¯æ­£å¸¸çš„ï¼Œå¦åˆ™å°±æ˜¯å¤±è´¥çš„ã€‚

HTTP Probes å…è®¸é’ˆ**å¯¹ httpGet é…ç½®é¢å¤–çš„å­—æ®µ**ï¼š

```yaml
#ç¤ºä¾‹:
httpHeaders:
  - name: user_agent
    value: curl

# å…¶ä»–å­—æ®µ
# hostï¼š è¿žæŽ¥ä½¿ç”¨çš„ä¸»æœºåï¼Œé»˜è®¤æ˜¯ Pod çš„ IPã€‚ä¹Ÿå¯ä»¥åœ¨ HTTP å¤´ä¸­è®¾ç½® â€œHostâ€ æ¥ä»£æ›¿ã€‚ä¸€èˆ¬ä¸é…ç½®æ­¤é¡¹
# scheme ï¼š ç”¨äºŽè®¾ç½®è¿žæŽ¥ä¸»æœºçš„æ–¹å¼ï¼ˆHTTP è¿˜æ˜¯ HTTPSï¼‰ã€‚é»˜è®¤æ˜¯ "HTTP"ã€‚ä¸€èˆ¬ä¸é…ç½®æ­¤é¡¹
# pathï¼š è®¿é—® HTTP æœåŠ¡çš„è·¯å¾„ã€‚é»˜è®¤å€¼ä¸º "/"ã€‚ä¸€èˆ¬ä¼šé…ç½®æ­¤é¡¹
# portï¼š è®¿é—®å®¹å™¨çš„ç«¯å£å·æˆ–è€…ç«¯å£åã€‚å¦‚æžœæ•°å­—å¿…é¡»åœ¨ 1ï½ž65535 ä¹‹é—´ã€‚ä¸€èˆ¬ä¼šé…ç½®æ­¤é¡¹
# httpHeadersï¼šè¯·æ±‚ä¸­è‡ªå®šä¹‰çš„ HTTP å¤´ã€‚HTTP å¤´å­—æ®µå…è®¸é‡å¤ã€‚ä¸€èˆ¬ä¸é…ç½®æ­¤é¡¹
```



**Livenessçš„httpGetæŽ¢é’ˆ**

```yaml
# cat pod-liveness-http.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-liveness-http
spec:
  containers:
  - name: pod-liveness-http-container
    image: busybox:1.32.0
    ports:
    - name: http
      containerPort: 80
    livenessProbe:
      httpGet:
        port: http
        path: /index.html
      initialDelaySeconds: 1
      periodSeconds: 3

# å¯ç”¨å®¹å™¨
kubectl apply -f pod-liveness-http.yaml
pod/pod-liveness-http created
```



 **Readiness çš„ httpGet æŽ¢é’ˆ**

é€šè¿‡readinessçš„å±žæ€§ï¼Œå°è¯•åˆ¤æ–­èµ„æºå¯¹è±¡æ˜¯å¦å‡†å¤‡å¥½äº†ç›¸å…³æœåŠ¡ï¼Œæ¥æŽ¥å—ç”¨æˆ·è¯·æ±‚ã€‚ å¦‚æžœreadinessæ£€æµ‹å¤±è´¥,ç›¸å…³çš„serviceä¼šå°†æ­¤podä»ŽEndpointsä¸­ç§»é™¤,ä½†ä¸ä¼šé‡å¯pod 

```yaml
# cat pod-readiness-http.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-readiness-http
spec:
  containers:
  - name: pod-readiness-http-container
    image: busybox:1.32.0
    ports:
    - name: http
      containerPort: 80
    readinessProbe:
      httpGet:
        port: http
        path: /index.html
      initialDelaySeconds: 1
      periodSeconds: 3
      
# åˆ›å»ºå®¹å™¨
kubectl apply -f pod-readiness-http.yaml

#å®žæ—¶ç›‘æŽ§
[root@master1 ~]#kubectl get pod -w
NAME                 READY   STATUS             RESTARTS     AGE
pod-readiness-http   0/1     CrashLoopBackOff   1 (26s ago)   43s
pod-readiness-http   0/1     Completed          2 (32s ago)   49s
```





#### podèµ„æºé™åˆ¶

kubernetes å¯ä»¥æ”¯æŒåœ¨**å®¹å™¨çº§**åŠ**namespaceçº§**åˆ†åˆ«å®žçŽ°èµ„æºé™åˆ¶



Kubernetes å·²ç»å¯¹Podåšäº†ç›¸åº”çš„èµ„æºé…é¢è®¾ç½®ï¼Œè¿™äº›èµ„æºä¸»è¦ä½“çŽ°åœ¨ï¼šCPUå’Œå†…å­˜ã€å­˜å‚¨ï¼Œå› ä¸ºå­˜å‚¨ åœ¨k8sä¸­æœ‰ä¸“é—¨çš„èµ„æºå¯¹è±¡ï¼ˆPV,PVCï¼‰æ¥è¿›è¡Œç®¡æŽ§ï¼Œæ‰€ä»¥å½“å‰çš„podèµ„æºé™åˆ¶ï¼Œä¸»è¦æŒ‡çš„è®¡ç®—èµ„æºï¼Œå³**CPUå’Œå†…å­˜ã€‚**



ä¸ºäº†æ–¹ä¾¿ä¸Žk8sçš„å…¶ä»–å•ç‹¬çš„èµ„æºå¯¹è±¡åŒºåˆ†å¼€æ¥ï¼Œä¸€èˆ¬å°†**CPUå’Œå†…å­˜**å…¶ç§°ä¸º**è®¡ç®—èµ„æº**ã€‚

å¦‚æžœè¿è¡Œçš„Podä½¿ç”¨çš„èµ„æºè¶…è¿‡å®¿ä¸»æœºçš„æœ€å¤§å¯ç”¨èµ„æº,ä¼šå¯¼è‡´**OOM**å’Œ**Podé©±é€**åˆ°å…¶å®ƒå®¿ä¸»æœº



##### å¯é™åˆ¶çš„èµ„æºå•ä½

å¸¸è§åœ¨å®¹å™¨çº§åˆ«çš„CPUå’Œå†…å­˜çš„é™åˆ¶



- **CPU**
  - ç‰¹ç‚¹ï¼šæ˜¯ä¸€ç§å¯åŽ‹ç¼©èµ„æºï¼Œcpuèµ„æºæ˜¯æ”¯æŒæŠ¢å çš„
  - å•ä½ï¼šCPUçš„èµ„æºå•ä½æ˜¯CPU(Core)çš„æ•°é‡,æ˜¯ä¸€ä¸ªç»å¯¹
  - å¤§å°ï¼šåœ¨Kubernetesä¸­é€šå¸¸ä»¥åƒåˆ†ä¹‹ä¸€çš„CPU(Core)ä¸ºæœ€å°å•ä½ï¼Œç”¨æ¯« m è¡¨ç¤º,å³**ä¸€ä¸ªCPUæ ¸å¿ƒè¡¨ç¤ºä¸º1000m**
  - ç»éªŒï¼š**ä¸€ä¸ªèµ„æºå ç”¨ä¸å¤šçš„å®¹å™¨å ç”¨çš„CPU**é€šå¸¸åœ¨100~300mï¼Œå³**0.1-0.3ä¸ªCPU**
  - æ³¨æ„ï¼šmi ä»£è¡¨æ˜¯1024è¿›åˆ¶çš„



- **å†…å­˜**
  - ç‰¹ç‚¹ï¼šæ˜¯ä¸å¯åŽ‹ç¼©èµ„æºï¼Œå½“podèµ„æºæ‰©å±•çš„æ—¶å€™ï¼Œå¦‚æžœnodeä¸Šèµ„æºä¸å¤Ÿï¼Œé‚£ä¹ˆå°±ä¼šå‘ç”Ÿèµ„æºæŠ¢å ï¼Œ æˆ–è€…OOMé—®é¢˜
  - å•ä½ï¼šå†…å­˜çš„èµ„æºä»¥å­—èŠ‚æ•°ä¸ºå•ä½ï¼Œæ˜¯ä¸€ä¸ªç»å¯¹å€¼
  - å¤§å°ï¼šå†…å­˜é…é¢å¯¹äºŽç»å¤§å¤šæ•°å®¹å™¨æ¥è¯´å¾ˆé‡è¦ï¼Œåœ¨Kubernetesä¸­é€šå¸¸ä»¥Mi,Giä¸ºå•ä½æ¥åˆ†é…ã€‚é€šå¸¸ åˆ†é…ç½®1G,2G,æœ€å¤š16Gæˆ–32G
  - æ³¨æ„ï¼šå¦‚æžœå†…å­˜åˆ†é…ä¸è¶³,å¯èƒ½ä¼šå‡ºçŽ°OOMçŽ°è±¡ï¼ˆJavaç¨‹åºå¸¸è§ï¼‰



- **æ³¨æ„**
  - CPUå±žäºŽå¯åŽ‹ç¼©ï¼ˆcompressibleï¼‰åž‹èµ„æºï¼Œå³èµ„æºé¢åº¦å¯æŒ‰éœ€æ”¶ç¼©
  - å†…å­˜ï¼ˆå½“å‰ï¼‰åˆ™æ˜¯ä¸å¯åŽ‹ç¼©åž‹èµ„æºï¼Œå¯¹å…¶æ‰§è¡Œæ”¶ç¼©æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æŸç§ç¨‹åº¦çš„é—®é¢˜ï¼Œä¾‹å¦‚è¿›ç¨‹å´©æºƒ ç­‰ã€‚



- **Extended Resources æ‰©å±•èµ„æºé™åˆ¶ï¼ˆå¸¸è§ï¼šGPUèµ„æºï¼‰**
  - æ‰€æœ‰ä¸å±žäºŽkubernetes.ioåŸŸçš„èµ„æº,ä¸ºæ‰©å±•èµ„æº,å¦‚:"**nvidia.com/gpu**"
  - kubernetes ä¹Ÿæ”¯æŒé’ˆåˆ°æ‰©å±•èµ„æºé™åˆ¶





##### é…é¢é™åˆ¶å‚æ•°

Kubernetesä¸­ï¼Œå¯¹äºŽæ¯ç§èµ„æºçš„é…é¢é™å®šéƒ½éœ€è¦ä¸¤ä¸ªå‚æ•°ï¼š**Requestså’ŒLimits**

![image-20241218152631838](D:\git_repository\cyber_security_learning\markdown_img\image-20241218152631838.png)





- **èµ„æºéœ€æ±‚Requests**
  - ä¸šåŠ¡è¿è¡Œæ—¶èµ„æºé¢„ç•™çš„æœ€å°ä½¿ç”¨é‡ï¼Œå³æ‰€éœ€èµ„æºçš„**æœ€ä½Žä¸‹é™**ï¼Œ**è¯¥å‚æ•°çš„å€¼å¿…é¡»æ»¡è¶³ï¼Œè‹¥ä¸æ»¡è¶³ï¼Œä¸šåŠ¡æ— æ³•è¿è¡Œ**ã€‚
  - å®¹å™¨è¿è¡Œæ—¶å¯èƒ½ç”¨ä¸åˆ°è¿™äº›é¢åº¦çš„èµ„æºï¼Œä½†ç”¨åˆ°æ—¶å¿…é¡»ç¡®ä¿æœ‰ç›¸åº”æ•°é‡çš„èµ„æºå¯ç”¨
  - èµ„æºéœ€æ±‚çš„å®šä¹‰ä¼šå½±å“è°ƒåº¦å™¨çš„å†³ç­–,åªä¼šå°†Podè°ƒåº¦è‡³æ»¡è¶³æ‰€æœ‰å®¹å™¨æ€»çš„èµ„æºéœ€æ±‚çš„èŠ‚ç‚¹
  - å½“èµ„æºä¸è¶³æ—¶ï¼Œ**å®žé™…ä½¿ç”¨çš„èµ„æºè¶…å‡º Requests çš„éƒ¨åˆ†ï¼Œå¯èƒ½ä¼šè¢«å›žæ”¶**
  - **ä¸èƒ½è¶…è¿‡å¯¹åº”çš„limitså€¼**
  - **ä¸èƒ½è¶…è¿‡ç‰©ç†èŠ‚ç‚¹å¯ç”¨åˆ†é…çš„èµ„æºå€¼**



- **èµ„æºé™åˆ¶ Limits**
  - è¿è¡Œæ—¶èµ„æºå…è®¸ä½¿ç”¨æœ€å¤§å¯ç”¨é‡ï¼Œå³æ‰€éœ€èµ„æºçš„æœ€é«˜ä¸Šé™ï¼Œè¯¥å‚æ•°çš„å€¼ä¸èƒ½è¢«çªç ´ï¼Œè¶…å‡ºè¯¥é¢åº¦çš„èµ„æºä½¿ç”¨è¯·æ±‚é€šå¸¸ä¼šè¢«æ‹’ç»
  - **è¯¥é™åˆ¶éœ€è¦å¤§äºŽç­‰äºŽrequestsçš„å€¼**ï¼Œä½†ç³»ç»Ÿåœ¨å…¶æŸé¡¹èµ„æºç´§å¼ æ—¶ï¼Œä¼šä»Žå®¹å™¨é‚£é‡Œå›žæ”¶å…¶ä½¿ç”¨çš„è¶…å‡º å…¶requestså€¼çš„é‚£éƒ¨åˆ†
  - é’ˆå¯¹å†…å­˜è€Œè¨€,ä¸ºé˜²æ­¢ä¸Šé¢å›žæ”¶æƒ…å†µçš„å‘ç”Ÿ,ä¸€èˆ¬**å»ºè®®å°†å†…å­˜çš„ Requests å’Œ Limits è®¾ä¸ºç›¸åŒ**
  - èµ„æºé™åˆ¶**Limit**çš„å®šä¹‰**ä¸å½±å“è°ƒåº¦å™¨çš„å†³ç­–**
  - ä¸èƒ½ä½ŽäºŽå¯¹åº”çš„limitså€¼
  - å¯ä»¥è¶…è¿‡ç‰©ç†èŠ‚ç‚¹å¯ç”¨åˆ†é…çš„èµ„æºå€¼
  - **æç¤º:ä¸ºä¿è¯æ€§èƒ½,ç”Ÿäº§æŽ¨èRequestså’ŒLimitsè®¾ç½®ä¸ºç›¸åŒçš„å€¼**



##### k8sèµ„æºæŸ¥çœ‹

è¦å®žçŽ°èµ„æºé™åˆ¶,éœ€è¦å…ˆ**å®‰è£…metrics-server**

```bash
[root@master1 ~]# curl -LO https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml

#é»˜è®¤æ–‡ä»¶éœ€è¦ä¿®æ”¹æ‰èƒ½å·¥ä½œ,å› ä¸ºé»˜è®¤éœ€è¦å†…éƒ¨è¯ä¹¦éªŒè¯å’Œé•œåƒåœ°å€k8s.gcr.ioæ‰€ä»¥ä¿®æ”¹
# vim components.yaml
spec:
      containers:
      - args:
        - --cert-dir=/tmp
        - --secure-port=10250
        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
        - --kubelet-use-node-status-port
        - --metric-resolution=15s
        - --kubelet-insecure-tls
        #image: registry.cn-hangzhou.aliyuncs.com/google_containers/metricsserver:v0.7.1 # å¯ä»¥æ·»åŠ å›½å†…æº
        image: registry.k8s.io/metrics-server/metrics-server:v0.7.2
        imagePullPolicy: IfNotPresent
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: /livez
            port: https
            scheme: HTTPS
          periodSeconds: 10
        name: metrics-server
        ports:
        - containerPort: 10250
          name: https
          protocol: TCP
          
[root@master1 yaml]# kubectl apply -f components.yaml 
serviceaccount/metrics-server created
clusterrole.rbac.authorization.k8s.io/system:aggregated-metrics-reader created
clusterrole.rbac.authorization.k8s.io/system:metrics-server created
rolebinding.rbac.authorization.k8s.io/metrics-server-auth-reader created
clusterrolebinding.rbac.authorization.k8s.io/metrics-server:system:auth-delegator created
clusterrolebinding.rbac.authorization.k8s.io/system:metrics-server created
service/metrics-server created
deployment.apps/metrics-server created
apiservice.apiregistration.k8s.io/v1beta1.metrics.k8s.io created


root@master1 yaml]#kubectl get pod -n kube-system metrics-server-b79d5c976-hqrct 
NAME                             READY   STATUS    RESTARTS   AGE
metrics-server-b79d5c976-hqrct   1/1     Running   0          60s
[root@master1 yaml]#kubectl top node
NAME      CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   
master1   62m          3%     910Mi           49%       
node1     30m          1%     669Mi           36%       
node2     20m          1%     927Mi           50%       
node3     27m          1%     715Mi           39% 
```



##### èµ„æºé™åˆ¶å®žçŽ°

èŒƒä¾‹ï¼šlimitså’Œrequestså€¼å¤§å°

```yaml
# [root@master1 yaml]# cat pod-limit-request.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-limit-request
spec:
  containers:
  - name: pod-limit-request-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    imagePullPolicy: IfNotPresent
    resources:
      requests:
        memory: "500Mi"
        cpu: "250m"
      limits:
        memory: "500Mi"
        cpu: "250m"

```



##### åŽ‹åŠ›æµ‹è¯•

```yaml
# cat pod-stress.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-stress
spec:
  containers:
  - name: pod-stress
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/stress-ng
    imagePullPolicy: IfNotPresent
    command: ["/usr/bin/stress-ng", "-c 2", "--metrics-brief"]
    resources:
      requests:
        memory: 128Mi
        cpu: 200m
      limits:
        memory: 256Mi
        cpu: 500m

# æŸ¥çœ‹
[root@master1 yaml]#kubectl exec pod-stress -- top
Mem: 1853284K used, 120644K free, 4744K shrd, 55064K buff, 832920K cached
CPU:  24% usr   0% sys   0% nic  74% idle   0% io   0% irq   0% sirq
Load average: 0.35 0.30 0.17 3/513 14
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
    8     1 root     R     6904   0%   1  13% {stress-ng-cpu} /usr/bin/stress-ng
    7     1 root     R     6904   0%   0  12% {stress-ng-cpu} /usr/bin/stress-ng
    1     0 root     S     6264   0%   1   0% /usr/bin/stress-ng -c 2 --metrics-
q   9     0 root     R     1520   0%   0   0% top
```





##### åŸºäºŽNamespaceçº§åˆ«çš„èµ„æºé™åˆ¶

åœ¨ **Kubernetes ä¸­åŸºäºŽ Namespace çº§åˆ«çš„èµ„æºé™åˆ¶**ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨ **ResourceQuota** å’Œ **LimitRange** æ¥å®žçŽ°å¯¹å‘½åç©ºé—´ä¸­èµ„æºçš„ä½¿ç”¨é™åˆ¶ã€‚



**èµ„æºé™åˆ¶çš„å®žçŽ°æ–¹å¼**

| **æ–¹å¼**          | **å¯¹è±¡**       | **é™åˆ¶ç±»åž‹**                   | **å…¸åž‹é™åˆ¶å†…å®¹**                             |
| ----------------- | -------------- | ------------------------------ | -------------------------------------------- |
| **ResourceQuota** | **Namespace**  | **å‘½åç©ºé—´çº§åˆ«çš„èµ„æºæ€»é‡é™åˆ¶** | é™åˆ¶ Namespace ä¸­ Podã€CPUã€å†…å­˜ã€å­˜å‚¨çš„æ€»é‡ |
| **LimitRange**    | **Pod å’Œå®¹å™¨** | **å•ä¸ª Pod/å®¹å™¨çš„èµ„æºé™åˆ¶**    | é™åˆ¶æ¯ä¸ª Pod/å®¹å™¨çš„ CPU å’Œå†…å­˜çš„æœ€å°å’Œæœ€å¤§å€¼ |

------



**èµ„æºé™åˆ¶çš„å·¥ä½œæœºåˆ¶**

**1ï¸âƒ£ ResourceQuota (é™åˆ¶ Namespace èµ„æºæ€»é‡)**

- **ä½œç”¨èŒƒå›´**ï¼š
  é™åˆ¶æ•´ä¸ª Namespace ä¸­çš„èµ„æºæ€»é‡ï¼ŒåŒ…æ‹¬ Pod æ•°é‡ã€CPUã€å†…å­˜å’Œå­˜å‚¨ã€‚
- **å¸¸è§çš„é™åˆ¶é¡¹ç›®**ï¼š
  - Pod æ€»æ•° (`pods`)
  - å®¹å™¨çš„æ€» CPU è¯·æ±‚ (`requests.cpu`) å’Œæ€»é™åˆ¶ (`limits.cpu`)
  - å®¹å™¨çš„æ€»å†…å­˜è¯·æ±‚ (`requests.memory`) å’Œæ€»é™åˆ¶ (`limits.memory`)
  - PersistentVolumeClaim (PVC) çš„æ€»å­˜å‚¨ä½¿ç”¨é‡ (`requests.storage`)
- **å…¸åž‹åœºæ™¯**ï¼š
  é™åˆ¶ä¸€ä¸ªé¡¹ç›®å›¢é˜Ÿåœ¨å…¶ Namespace ä¸­æœ€å¤šåªèƒ½ä½¿ç”¨ 10 ä¸ª Podï¼ŒCPU æ€»é‡ä¸è¶…è¿‡ 10 æ ¸ï¼Œå†…å­˜æ€»é‡ä¸è¶…è¿‡ 32GiBã€‚



**2ï¸âƒ£ LimitRange (é™åˆ¶å•ä¸ª Pod å’Œå®¹å™¨çš„èµ„æº)**

- **ä½œç”¨èŒƒå›´**ï¼š
  é™åˆ¶ **æ¯ä¸ª Pod æˆ–æ¯ä¸ªå®¹å™¨** çš„ CPU å’Œå†…å­˜çš„æœ€å¤§ã€æœ€å°å€¼ã€‚
- **å¸¸è§çš„é™åˆ¶é¡¹ç›®**ï¼š
  - å®¹å™¨çš„æœ€å° CPU è¯·æ±‚ (`min.cpu`) å’Œæœ€å¤§é™åˆ¶ (`max.cpu`)
  - å®¹å™¨çš„æœ€å°å†…å­˜è¯·æ±‚ (`min.memory`) å’Œæœ€å¤§é™åˆ¶ (`max.memory`)
- **å…¸åž‹åœºæ™¯**ï¼š
  æ¯ä¸ª Pod ä¸­çš„å®¹å™¨éƒ½å¿…é¡»è¯·æ±‚æœ€å°‘ 100m çš„ CPUï¼Œä½†æœ€å¤šä¸èƒ½è¶…è¿‡ 2 æ ¸ CPUï¼Œæœ€å°‘ 200Mi çš„å†…å­˜ï¼Œæœ€å¤šä¸èƒ½è¶…è¿‡ 2GiB çš„å†…å­˜ã€‚



**ResourceQuotaç¤ºä¾‹ï¼ˆå‘½åç©ºé—´çš„èµ„æºæ€»é‡é™åˆ¶ï¼‰**

é™åˆ¶ **æ•´ä¸ªå‘½åç©ºé—´ä¸­çš„ Pod æ•°é‡ã€CPU å’Œå†…å­˜ä½¿ç”¨é‡**ã€‚

```yaml
# cat resource-quota.yaml
apiVersion: v1
kind: ResourceQuota
metadata:
  name: namespace-quota
  namespace: my-namespace
spec:
  hard:
    pods: "10"                    # é™åˆ¶å‘½åç©ºé—´ä¸­æœ€å¤šæœ‰ 10 ä¸ª Pod
    requests.cpu: "10"            # æ‰€æœ‰ Pod çš„ CPU è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡ 10 æ ¸
    requests.memory: "32Gi"       # æ‰€æœ‰ Pod çš„å†…å­˜è¯·æ±‚æ€»å’Œä¸èƒ½è¶…è¿‡ 32Gi
    limits.cpu: "20"              # æ‰€æœ‰ Pod ä¸­ CPU é™åˆ¶çš„æ€»å’Œä¸èƒ½è¶…è¿‡ 20 æ ¸
    limits.memory: "64Gi"         # æ‰€æœ‰ Pod ä¸­å†…å­˜é™åˆ¶çš„æ€»å’Œä¸èƒ½è¶…è¿‡ 64Gi
    persistentvolumeclaims: "5"   # é™åˆ¶ Namespace ä¸­çš„ PVC æ•°é‡ä¸º 5 ä¸ª
    requests.storage: "100Gi"     # é™åˆ¶æ‰€æœ‰ PVC è¯·æ±‚çš„å­˜å‚¨æ€»é‡ä¸º 100Gi

```



**LimitRangeç¤ºä¾‹ï¼ˆPodå’Œå®¹å™¨çš„èµ„æºé™åˆ¶ï¼‰**

ä¸º **å•ä¸ª Pod å’Œå®¹å™¨** é™åˆ¶å…¶ CPU å’Œå†…å­˜çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚

```yaml
cat limit-range.yaml
apiVersion: v1
kind: LimitRange
metadata:
  name: container-limit-range
  namespace: my-namespace
spec:
  limits:
  - type: Pod                # ä½œç”¨èŒƒå›´ä¸ºPOd
    max:                     # maxï¼šæŒ‡å®š Pod æ€»çš„ CPU å’Œå†…å­˜ä¸Šé™ï¼ŒCPU ä¸èƒ½è¶…è¿‡ 2 æ ¸ï¼Œå†…å­˜ä¸èƒ½è¶…è¿‡ 4Giã€‚
      cpu: "2"               # æ¯ä¸ª Pod çš„æœ€å¤§ CPU é™åˆ¶ä¸º 2 æ ¸
      memory: "4Gi"          # æ¯ä¸ª Pod çš„æœ€å¤§å†…å­˜é™åˆ¶ä¸º 4 GiB
    min:                     # minï¼šæŒ‡å®š Pod çš„æœ€å°èµ„æºè¯·æ±‚ï¼ŒCPU ä¸ä½ŽäºŽ 250mï¼Œå†…å­˜ä¸ä½ŽäºŽ 128Miã€‚
      cpu: "250m"            # æ¯ä¸ª Pod çš„æœ€å° CPU è¯·æ±‚ä¸º 250m
      memory: "128Mi"        # æ¯ä¸ª Pod çš„æœ€å°å†…å­˜è¯·æ±‚ä¸º 128Mi
  - type: Container          # type: Containerï¼šä½œç”¨èŒƒå›´ä¸º Pod å†…çš„æ¯ä¸ªå®¹å™¨
    default:
      cpu: "500m"            # æ¯ä¸ªå®¹å™¨çš„é»˜è®¤ CPU è¯·æ±‚ä¸º 500m
      memory: "512Mi"        # æ¯ä¸ªå®¹å™¨çš„é»˜è®¤å†…å­˜è¯·æ±‚ä¸º 512Mi
    defaultRequest:
      cpu: "250m"            # å¦‚æžœæœªæŒ‡å®šè¯·æ±‚ï¼Œé»˜è®¤ CPU è¯·æ±‚ä¸º 250m
      memory: "256Mi"        # å¦‚æžœæœªæŒ‡å®šè¯·æ±‚ï¼Œé»˜è®¤å†…å­˜è¯·æ±‚ä¸º 256Mi
    max:
      cpu: "1"               # æ¯ä¸ªå®¹å™¨çš„æœ€å¤§ CPU é™åˆ¶ä¸º 1 æ ¸
      memory: "2Gi"          # æ¯ä¸ªå®¹å™¨çš„æœ€å¤§å†…å­˜é™åˆ¶ä¸º 2GiB
    min:
      cpu: "100m"            # æ¯ä¸ªå®¹å™¨çš„æœ€å° CPU è¯·æ±‚ä¸º 100m
      memory: "128Mi"        # æ¯ä¸ªå®¹å™¨çš„æœ€å°å†…å­˜è¯·æ±‚ä¸º 128Mi

```





#### Podå®‰å…¨

##### èµ„æºå®‰å…¨å±žæ€§

å®¹å™¨ä¸€èˆ¬æ˜¯åŸºäºŽ6ä¸ªå‘½åç©ºé—´å®žçŽ°èµ„æºçš„éš”ç¦»ï¼Œè€Œä¸€ä¸ª Pod å°±æ˜¯ä¸€ä¸ªå®¹å™¨é›†åˆï¼ŒåŒ…å«å¤šä¸ªå®¹å™¨

è¿™ä¸ªå‘½åç©ºé—´æ˜¯æŒ‰ç…§ä¸‹é¢æ–¹å¼æ¥ä½¿ç”¨çš„ï¼š

- å†…éƒ¨çš„æ‰€æœ‰å®¹å™¨å…±äº«åº•å±‚ pauseå®¹å™¨çš„ UTSï¼ŒNetwork ä¸¤ä¸ªåç§°ç©ºé—´èµ„æº
- å¯é€‰å…±äº«å‘½åç©ºé—´ï¼šIPCï¼ŒPID
- MNTå’ŒUSER ä¸¤ä¸ªå‘½åç©ºé—´é»˜è®¤æ²¡æœ‰å…±äº«,ä»Žè€Œå®žçŽ°åº”ç”¨çš„éš”ç¦»ã€‚



##### å®¹å™¨å®‰å…¨ä¸Šä¸‹æ–‡

podåœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæ¶‰åŠåˆ°å¤šç§åœºæ™¯(å¤šå®¹å™¨çš„å…³è”å…³ç³»)ï¼Œå°†è¿™ç§ç›¸å…³çš„ä½œç”¨å…³ç³»ç§°ä¸ºå®¹å™¨ä¸Šä¸‹æ–‡ï¼Œå…¶ ä¸­æœ‰ä¸€äº›æ¶‰åŠåˆ°æƒé™ã€é™åˆ¶ç­‰å®‰å…¨ç›¸å…³çš„å†…å®¹ï¼Œç§°å…¶ä¸ºå®‰å…¨ä¸Šä¸‹æ–‡ã€‚

å®‰å…¨ä¸Šä¸‹æ–‡æ˜¯ä¸€ç»„ç”¨äºŽå†³å®šå®¹å™¨æ˜¯å¦‚ä½•åˆ›å»ºå’Œè¿è¡Œçš„çº¦æŸæ¡ä»¶ï¼Œå®ƒä»¬ä»£è¡¨ç€åˆ›å»ºå’Œè¿è¡Œå®¹å™¨æ—¶ä½¿ç”¨çš„è¿è¡Œæ—¶å‚æ•°ã€‚

å®ƒæ ¹æ®çº¦æŸçš„ä½œç”¨èŒƒå›´ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªçº§åˆ«ï¼š

- Podçº§åˆ«ï¼šé’ˆå¯¹podèŒƒå›´å†…çš„æ‰€æœ‰å®¹å™¨
- å®¹å™¨çº§åˆ«ï¼šä»…é’ˆå¯¹podèŒƒå›´å†…çš„æŒ‡å®šå®¹å™¨
- PSPçº§åˆ«ï¼šPodSecurityPolicyï¼Œå…¨å±€çº§åˆ«çš„Podå®‰å…¨ç­–ç•¥ï¼Œæ¶‰åŠåˆ°å‡†å…¥æŽ§åˆ¶ç›¸å…³çŸ¥è¯†



Podå’Œå®¹å™¨çš„å®‰å…¨ä¸Šä¸‹æ–‡è®¾ç½®ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªæ–¹é¢

- å®¹å™¨è¿›ç¨‹è¿è¡Œèº«ä»½åŠèµ„æºè®¿é—®æƒé™
- Linux Capabilities
- è‡ªä¸»è®¿é—®æŽ§åˆ¶DAC
- seccompï¼šsecurecomputing modeï¼Œå®žçŽ°é™åˆ¶ç¨‹åºä½¿ç”¨æŸäº›ç³»ç»Ÿè°ƒç”¨
- AppArmorï¼šApplication Armor ä¸ŽSELinuxç±»ä¼¼ï¼Œå¯ä»¥é™åˆ¶ç¨‹åºçš„åŠŸèƒ½ï¼Œæ¯”å¦‚ç¨‹åºå¯ä»¥è¯»ã€å†™æˆ–è¿ è¡Œå“ªäº›æ–‡ä»¶ï¼Œæ˜¯å¦å¯ä»¥æ‰“å¼€ç«¯å£ç­‰
- SELinux
- Privilege Mode
- Privilege Escalation ç‰¹æƒæå‡



##### å®‰å…¨ä¸Šä¸‹æ–‡ç›¸å…³å±žæ€§

```bash
#Podçº§å®‰å…¨ä¸Šä¸‹æ–‡
~]#kubectl explain pod.spec.securityContext
#å®¹å™¨çº§å®‰å…¨ä¸Šä¸‹æ–‡
~]#kubectl explain pod.spec.containers.securityContext
apiVersion: v1
kind: Pod
metadata: {â€¦}
spec:
 securityContext:                        # Podçº§åˆ«çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œå¯¹å†…éƒ¨æ‰€æœ‰å®¹å™¨å‡æœ‰æ•ˆ
   runAsUser <integer>                   # ä»¥æŒ‡å®šçš„ç”¨æˆ·èº«ä»½è¿è¡Œå®¹å™¨è¿›ç¨‹ï¼Œé»˜è®¤ç”±é•œåƒä¸­çš„USERæŒ‡å®š
   runAsGroup <integer>                  # ä»¥æŒ‡å®šçš„ç”¨æˆ·ç»„è¿è¡Œå®¹å™¨è¿›ç¨‹ï¼Œé»˜è®¤ä½¿ç”¨çš„ç»„éšå®¹å™¨è¿è¡Œæ—¶
   supplementalGroups <[]integer>        # ä¸ºå®¹å™¨ä¸­1å·è¿›ç¨‹çš„ç”¨æˆ·æ·»åŠ çš„é™„åŠ ç»„ï¼›
   fsGroup <integer>                     # ä¸ºå®¹å™¨ä¸­çš„1å·è¿›ç¨‹é™„åŠ çš„ä¸€ä¸ªä¸“ç”¨ç»„ï¼Œå…¶åŠŸèƒ½ç±»ä¼¼äºŽsgid
   runAsNonRoot <boolean>                # æ˜¯å¦ä»¥éžrootèº«ä»½è¿è¡Œ
   seLinuxOptions <Object>               # SELinuxçš„ç›¸å…³é…ç½®
   sysctls <[]Object>                    # åº”ç”¨åˆ°å½“å‰Podä¸Šçš„åç§°æˆ–ç½‘ç»œç©ºé—´çº§åˆ«çš„sysctlå‚æ•°è®¾ç½®åˆ—è¡¨
   windowsOptions <Object>               # Windowså®¹å™¨ä¸“ç”¨çš„è®¾ç½®
 containers:
  - name: â€¦
   image: â€¦
   securityContext:                      # å®¹å™¨çº§åˆ«çš„å®‰å…¨ä¸Šä¸‹æ–‡ï¼Œä»…ç”Ÿæ•ˆäºŽå½“å‰å®¹å™¨
     runAsUser <integer>                 # ä»¥æŒ‡å®šçš„ç”¨æˆ·èº«ä»½è¿è¡Œå®¹å™¨è¿›ç¨‹
     runAsGroup <integer>                # ä»¥æŒ‡å®šçš„ç”¨æˆ·ç»„è¿è¡Œå®¹å™¨è¿›ç¨‹
     runAsNonRoot <boolean>              # æ˜¯å¦ä»¥éžrootèº«ä»½è¿è¡Œ
     allowPrivilegeEscalation <boolean>  # æ˜¯å¦å…è®¸ç‰¹æƒå‡çº§
     readOnlyRootFilesystem <boolean>    # æ˜¯å¦è®¾ç½®rootfsåªè¯»
     capabilities <Object>               # äºŽå½“å‰å®¹å™¨ä¸Šæ·»åŠ ï¼ˆaddï¼‰æˆ–åˆ é™¤ï¼ˆdropï¼‰çš„æ“ä½œå†…æ ¸æŸäº›èµ„æºçš„èƒ½åŠ›
       add <[]string>                    # æ·»åŠ ç”±åˆ—è¡¨æ ¼å¼å®šä¹‰çš„å„å†…æ ¸èƒ½åŠ›
       drop <[]string>                   # ç§»é™¤ç”±åˆ—è¡¨æ ¼å¼å®šä¹‰çš„å„å†…æ ¸èƒ½åŠ›
     privileged <boolean>                # æ˜¯å¦è¿è¡Œä¸ºç‰¹æƒå®¹å™¨
     procMount <string>                  # è®¾ç½®å®¹å™¨çš„procMountç±»åž‹ï¼Œé»˜è®¤ä¸ºDefaultProcMountï¼›
     readOnlyRootFilesystem <boolean>    # æ˜¯å¦å°†æ ¹æ–‡ä»¶ç³»ç»Ÿè®¾ç½®ä¸ºåªè¯»æ¨¡å¼
     seLinuxOptions <Object>             # SELinuxçš„ç›¸å…³é…ç½®
     windowsOptions <Object>             # windowså®¹å™¨ä¸“ç”¨çš„è®¾ç½®   
     
#æ³¨æ„ï¼šä¸Šé¢çš„å±žæ€§ä»…æ˜¯æœ€å¸¸ç”¨çš„å±žæ€§ï¼Œè€Œä¸æ˜¯æ‰€æœ‰çš„å±žæ€§
```



##### èµ„æºç­–ç•¥

**ç”¨æˆ·çº§åˆ«**

é»˜è®¤Podçš„å®¹å™¨è¿›ç¨‹æ˜¯ä»¥rootèº«ä»½è¿è¡Œï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢å±žæ€§æŒ‡å®šå…¶å®ƒç”¨æˆ·

ä½†æ­¤rootç”¨æˆ·åªå…·æœ‰å¯¹å®¹å™¨å†…çš„ç›¸å…³èµ„æºæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿç­‰æœ‰ç®¡ç†æƒé™ï¼Œå¯¹äºŽå®¿ä¸»æœºçš„å†…æ ¸ä¸å…·æœ‰ç®¡ç†æƒ é™ï¼Œå³æ˜¯ä¸ª**â€œä¼ª"rootç”¨æˆ·**

ç›¸å…³çš„å±žæ€§: 

- runAsUser
- runAsGroup



èŒƒä¾‹ï¼šé»˜è®¤rootèº«ä»½è¿è¡ŒPodå†…çš„è¿›ç¨‹

```yaml
# cat pod-test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-test
spec:
  containers:
  - name: pod-test
  image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
  
# kubectl apply -f pod-test.yaml

# æŸ¥çœ‹ç”¨æˆ·
# kubectl exec pod-test -- id
uid=0(root) gid=0(root) 
groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)

# æ³¨æ„ï¼šé»˜è®¤æƒ…å†µä¸‹ä¸€æ—¦Podåˆ›å»ºå¥½åŽï¼Œæ˜¯ä¸å…è®¸å¯¹ç”¨æˆ·å½’å±žæƒé™è¿›è¡Œä»»æ„ä¿®æ”¹çš„ï¼Œæ‰€ä»¥éœ€è¦ä¿®æ”¹çš„è¯ï¼Œå¿…é¡»å…ˆå…³é—­ï¼Œå†å¼€å¯
```



èŒƒä¾‹ï¼šæ·»åŠ å®‰å…¨ä¸Šä¸‹æ–‡å±žæ€§å®žçŽ°**æŒ‡å®šç”¨æˆ·èº«ä»½è¿è¡ŒPodå†…è¿›ç¨‹**

```yaml
# cat pod-securitycontext-runasuser.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-securitycontext-runasuser
  namespace: default
spec:
  containers:
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    env:
    - name: PORT
      value: "8080"
    securityContext:
      runasuser: 1001     # æŒ‡å®šè¿è¡Œèº«ä»½
      runAsGroup: 1001
```



##### èµ„æºèƒ½åŠ›

åœ¨ Linux ä¸­ï¼Œ**root ç”¨æˆ·ï¼ˆUID 0ï¼‰** é»˜è®¤æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œä½†åœ¨å®¹å™¨åŒ–çŽ¯å¢ƒï¼ˆå¦‚ Kubernetesï¼‰ä¸­ï¼Œä¸ºäº†**å®‰å…¨æ€§**ï¼Œå®¹å™¨é»˜è®¤ä¼šå‰¥å¤ºéƒ¨åˆ† `root` ç”¨æˆ·çš„ç‰¹æƒï¼Œç¡®ä¿å®¹å™¨æ— æ³•å¯¹å®¿ä¸»æœºé€ æˆå¨èƒã€‚

```bash
CAP_CHOWN                  #æ”¹å˜æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæ‰€å±žç»„   
CAP_MKNOD                  #mknod()ï¼Œåˆ›å»ºè®¾å¤‡æ–‡ä»¶  
CAP_NET_ADMIN              #ç½‘ç»œç®¡ç†æƒé™
CAP_SYS_TIME               #æ›´æ”¹ç³»ç»Ÿçš„æ—¶é’Ÿ
CAP_SYS_MODULE             #è£…è½½å¸è½½å†…æ ¸æ¨¡å—
CAP_NET_BIND_SERVERï¼š      #å…è®¸æ™®é€šç”¨æˆ·ç»‘å®š1024ä»¥å†…çš„ç‰¹æƒç«¯å£
CAP_SYS_ADMIN              #å¤§éƒ¨åˆ†çš„ç®¡ç†æƒé™,åŸºæœ¬ç›¸å½“äºŽrootæƒ
```



èŒƒä¾‹ï¼šé»˜è®¤èƒ½åŠ›æ— æ³•ç›´æŽ¥åˆ›å»ºiptablesè§„åˆ™

```yaml
# cat pod-securitycontext-capabailities.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-securitycontext-capabilities
  namespace: default
spec:
  containers:
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c"]
    args: ["/sbin/iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80 && /usr/bin/python3 /usr/local/bin/demo.py"]

# æ³¨æ„ï¼šå¯ä»¥åœ¨å®¹å™¨å†…éƒ¨é€šè¿‡command + argsè¿è¡Œä¸€ä¸ªè‡ªå®šä¹‰çš„å®¹å™¨å¯åŠ¨å‘½ä»¤

# åˆ›å»ºèµ„æº
kubectl apply -f pod-securitycontext-capabilities.yaml

# æ£€æŸ¥æ•ˆæžœ
kubectl get pod pod-securitycontext-capabilities
NAME                               READY   STATUS   RESTARTS     AGE
pod-securitycontext-capabilities   0/1     Error    2 (30s ago)   67s

[root@master1 ~]#kubectl logs pod-securitycontext-capabilities 
getsockopt failed strangely: Operation not permitted
#ç»“æžœæç¤ºï¼šå½“å®¹å™¨åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤æ˜¯ä»¥linuxç³»ç»Ÿæ™®é€šç”¨æˆ·å¯åŠ¨çš„ï¼Œæ‰€ä»¥æ™®é€šç”¨æˆ·æ˜¯æ²¡æœ‰æƒé™æ›´æ”¹ç³»ç»Ÿçº§åˆ«çš„å†…å®¹çš„ï¼Œæ‰€ä»¥å¯¼è‡´æˆ‘ä»¬æ›´æ”¹å‘½ä»¤æƒé™å¤±è´¥
```



èŒƒä¾‹ï¼šé€šè¿‡æ·»åŠ addæŒ‡ä»¤æ·»åŠ ç‰¹æƒ

```yaml
# cat pod-securitycontext-capabilities.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-securitycontext-capabilities
  namespace: default
spec:
  containers:
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c"]
    args: ["/sbin/iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80 && /usr/bin/python3 /usr/local/bin/demo.py"]
    # æ·»åŠ ä¸‹é¢ä¸‰è¡Œ
    securityContext:
      capailities:
        add: ['NET_ADMIN']
        
# æ³¨æ„ï¼šaddåŽé¢çš„æƒé™èƒ½åŠ›ä½¿ç”¨å•å¼•å·(''),ä¹Ÿå¯ä»¥ä½¿ç”¨åŒå¼•å·("")
```



èŒƒä¾‹: ä½¿ç”¨ drop æŒ‡ä»¤åˆ é™¤ç‰¹æƒ

```yaml
# cat pod-securitycontext-capabilities.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-securitycontext-capabilities
  namespace: default
spec:
  containers:
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
    command: ["/bin/sh", "-c"]
    args: ["/sbin/iptables -t nat -A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80 && /usr/bin/python3 /usr/local/bin/demo.py"]
    securityContext:
      capabilities:
        add: ['NET_ADMIN']
        drop: ['CHOWN'] # æ·»åŠ æ­¤è¡Œ
        
# åº”ç”¨é…ç½®
kubectl apply -f pod-securitycontext-capabilities.yaml

# éªŒè¯ç»“æžœ
#kubectl exec pod-securitycontext-capabilities   -- chown 1001:1001 /etc/hosts

#kubectl exec pod-securitycontext-capabilities   -- ls -l /etc/hosts
-rw-r--r--    1 root     root           228 Mar 17 07:22 /etc/hosts
#ç»“æžœæ˜¾ç¤ºï¼šæ–‡ä»¶æƒé™ä¸èƒ½éšæ„çš„æ›´æ”¹äº†
```



##### æ·»åŠ ç‰¹æƒæ¨¡å¼ï¼šPrivileged æ¨¡å¼

åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œå¦‚æžœéœ€è¦å®¹å™¨å…·å¤‡**å®Œå…¨çš„ root æƒé™**ï¼Œå¯ä»¥å°†å®¹å™¨è¿è¡Œåœ¨**ç‰¹æƒæ¨¡å¼**ä¸‹ï¼š

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: privileged-pod
spec:
  containers:
  - name: test-container
    image: nginx
    securityContext:
      privileged: true  # è¿è¡Œåœ¨ç‰¹æƒæ¨¡å¼
```

**æ³¨æ„**ï¼š

- `privileged: true` ä¼šæŽˆäºˆå®¹å™¨ **æ‰€æœ‰ Linux èƒ½åŠ›**ï¼ŒåŒ…æ‹¬ `SYS_ADMIN`ã€`NET_ADMIN` ç­‰ã€‚
- ç‰¹æƒæ¨¡å¼å¯èƒ½ä¼šå¼•å‘**å®‰å…¨é£Žé™©**ï¼Œåº”è°¨æ…Žä½¿ç”¨ã€‚



##### å†…æ ¸å‚æ•°

**Kubernetes å†…æ ¸å‚æ•°ç®¡ç†æœºåˆ¶**

Kubernetes é€šè¿‡ **`sysctl`** æ¥ç®¡ç†å’Œä¿®æ”¹å†…æ ¸å‚æ•°ã€‚ç”±äºŽ `sysctl` ä¿®æ”¹çš„æ˜¯æ“ä½œç³»ç»Ÿå†…æ ¸çš„å…¨å±€é…ç½®ï¼Œä½œç”¨èŒƒå›´æ˜¯æ•´ä¸ª **Linux å‘½åç©ºé—´**ï¼Œå› æ­¤ï¼š

- **Pod å†…çš„æ‰€æœ‰å®¹å™¨å…±äº«ç›¸åŒçš„å†…æ ¸å‘½åç©ºé—´**ã€‚
- **æ— æ³•é’ˆå¯¹å•ä¸ªå®¹å™¨** ä¿®æ”¹ç‹¬ç«‹çš„å†…æ ¸å‚æ•°ï¼Œå› ä¸ºåŒä¸€ Pod å†…çš„å®¹å™¨ä½¿ç”¨ç›¸åŒçš„ **Linux å†…æ ¸å‘½åç©ºé—´**ã€‚



**ä¸ºä»€ä¹ˆåªèƒ½åœ¨ Pod çº§åˆ«ä¿®æ”¹ï¼Ÿ**

**åŽŸå› ï¼šå‘½åç©ºé—´çš„å…±äº«**

åœ¨ Kubernetes ä¸­ï¼ŒPod æ˜¯ç”±ä¸€ç»„å®¹å™¨ç»„æˆçš„ï¼Œå®ƒä»¬å…±äº«ä»¥ä¸‹èµ„æºï¼š

- **å†…æ ¸å‘½åç©ºé—´ï¼ˆKernel Namespaceï¼‰**ï¼šsysctl å‚æ•°å±žäºŽå…¨å±€æˆ–å‘½åç©ºé—´çº§åˆ«ã€‚
- **ç½‘ç»œå‘½åç©ºé—´ï¼ˆNet Namespaceï¼‰**ï¼šPod çº§åˆ«çš„ç½‘ç»œæ ˆã€‚
- **PID å‘½åç©ºé—´**ï¼šPod å†…çš„æ‰€æœ‰è¿›ç¨‹å…±äº« PID ç©ºé—´ã€‚

**å½±å“**

- å¦‚æžœä¿®æ”¹äº†ä¸€ä¸ª Pod çš„å†…æ ¸å‚æ•°ï¼Œé‚£ä¹ˆ Pod å†…çš„æ‰€æœ‰å®¹å™¨éƒ½ä¼šå—åˆ°å½±å“ã€‚
- Kubernetes æ²¡æœ‰ä¸ºå•ä¸ªå®¹å™¨æä¾›ç‹¬ç«‹çš„å†…æ ¸å‘½åç©ºé—´ï¼Œå› æ­¤æ— æ³•é’ˆå¯¹å•ä¸ªå®¹å™¨è¿›è¡Œå†…æ ¸å‚æ•°çš„ä¿®æ”¹ã€‚





**å¦‚ä½•åœ¨ Pod çº§åˆ«ä¿®æ”¹å†…æ ¸å‚æ•°ï¼Ÿ**

Kubernetes æä¾›äº† **`sysctl` æ”¯æŒ** æ¥è®¾ç½® Pod çº§åˆ«çš„å†…æ ¸å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ `securityContext` ä¸­çš„ **`sysctls` å­—æ®µ** è¿›è¡Œé…ç½®ã€‚

**ç¤ºä¾‹ï¼šPod çº§åˆ«ä¿®æ”¹å†…æ ¸å‚æ•°**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sysctl-example
spec:
  securityContext:
    sysctls:                # Pod çº§åˆ«çš„ sysctl é…ç½®
    - name: net.core.somaxconn
      value: "1024"
    - name: net.ipv4.tcp_syncookies
      value: "1"
  containers:
  - name: nginx
    image: nginx
```

**è§£é‡Š**ï¼š

- **`securityContext.sysctls`**ï¼šåœ¨ Pod çº§åˆ«è®¾ç½®å†…æ ¸å‚æ•°ã€‚
- ä¿®æ”¹çš„å†…æ ¸å‚æ•°å¦‚ `net.core.somaxconn` å’Œ `net.ipv4.tcp_syncookies`ï¼Œä¼šä½œç”¨äºŽæ•´ä¸ª Podï¼Œè€Œéžå•ä¸ªå®¹å™¨ã€‚



**æ”¯æŒçš„ sysctl å‚æ•°**

Kubernetes ä¸­çš„ sysctl å‚æ•°åˆ†ä¸º **å®‰å…¨ï¼ˆsafeï¼‰** å’Œ **ä¸å®‰å…¨ï¼ˆunsafeï¼‰** ä¸¤ç±»ï¼š

1. **å®‰å…¨å‚æ•°**ï¼ˆSafe Sysctlsï¼‰ï¼š

   - è¿™äº›å‚æ•°ä½œç”¨èŒƒå›´é™åˆ¶åœ¨ Pod çš„ç½‘ç»œæˆ– IPC å‘½åç©ºé—´å†…ã€‚
   - ç¤ºä¾‹å‚æ•°ï¼š
     - `net.ipv4.tcp_syncookies`
     - `net.ipv4.ip_unprivileged_port_start`
     - `net.core.somaxconn`
     - `net.ipv4.ping_group_range`

2. **ä¸å®‰å…¨å‚æ•°**ï¼ˆUnsafe Sysctlsï¼‰ï¼š

   - è¿™äº›å‚æ•°å¯èƒ½å½±å“æ•´ä¸ªèŠ‚ç‚¹ï¼Œå¯èƒ½ä¼šå¼•å‘å®‰å…¨é£Žé™©ã€‚

   - éœ€è¦åœ¨ kubelet å¯åŠ¨æ—¶æ·»åŠ å‚æ•°å¯ç”¨ï¼š

     ```bash
     kubelet --allowed-unsafe-sysctls='kernel.*,net.*'
     ```





#### PodæœåŠ¡è´¨é‡QoS

#### æœåŠ¡è´¨é‡åˆ†ç±»

QoSï¼ˆæœåŠ¡è´¨é‡ç­‰çº§ï¼‰æ˜¯ä½œç”¨åœ¨Podä¸Šçš„ä¸€ä¸ªé…ç½®

å½“Kubernetesåˆ›å»ºä¸€ä¸ªPodæ—¶ï¼Œå®ƒå°±ä¼šç»™è¿™ä¸ªPodåˆ†é…ä¸€ä¸ªQoSç­‰çº§



QoSä¸‰ä¸ªç­‰çº§ï¼ˆå›¾ä¾‹ï¼‰

![image-20241219100140277](D:\git_repository\cyber_security_learning\markdown_img\image-20241219100140277.png)





- ä½Žä¼˜å…ˆçº§BestEffortï¼šæ²¡æœ‰ä»»ä½•ä¸€ä¸ªå®¹å™¨è®¾ç½®äº†requestsæˆ–limitsçš„å±žæ€§ã€‚ï¼ˆæœ€ä½Žä¼˜å…ˆçº§ï¼‰
- ä¸­ä¼˜å…ˆçº§Burstableï¼šPodè‡³å°‘æœ‰ä¸€ä¸ªå®¹å™¨è®¾ç½®äº†cpuæˆ–å†…å­˜çš„requestså’Œlimitsï¼Œä¸”ä¸ç›¸åŒ

- é«˜ä¼˜å…ˆçº§Guaranteedï¼šPodå†…çš„æ¯ä¸ªå®¹å™¨åŒæ—¶è®¾ç½®äº†CPUå’Œå†…å­˜çš„requestså’Œlimits  è€Œä¸”æ‰€æœ‰å€¼ å¿…é¡»ç›¸ç­‰



**å½“ä¸»æœºå‡ºçŽ°OOMæ—¶,å…ˆåˆ é™¤æœåŠ¡è´¨é‡ä¸ºBestEffortçš„Podï¼Œç„¶åŽåœ¨åˆ é™¤Burstableï¼ŒQuaranteedæœ€åŽè¢«åˆ é™¤**





#### Podè®¾è®¡æ¨¡å¼

##### å®¹å™¨è®¾è®¡æ¨¡å¼

åŸºäºŽå®¹å™¨çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸ç”¨ä¸‰ç±»è®¾è®¡æ¨¡å¼

- **å•å®¹å™¨æ¨¡å¼**ï¼šå•ä¸€å®¹å™¨å½¢å¼è¿è¡Œçš„åº”ç”¨,æ­¤æ¨¡å¼åº”ç”¨æœ€ä¸ºå¹¿æ³›,ç›¸å½“äºŽä¸€ä¸ªäºº
- **å•èŠ‚ç‚¹å¤šå®¹å™¨æ¨¡å¼**ï¼šç”±å¼ºè€¦åˆçš„å¤šä¸ªå®¹å™¨ååŒå…±ç”Ÿ,å®¹å™¨ä¹‹é—´å…³ç³»å¯†åˆ‡,é€šå¸¸éœ€è¦å·¥ä½œåœ¨åŒä¸€ä¸ª workerä¸»æœºä¸Š,ç›¸å½“äºŽä¸€ä¸ªå¤šæˆå‘˜çš„å®¶åº­,**Podå°±æ˜¯æ­¤æ¨¡å¼çš„ä»£è¡¨**
- **å¤šèŠ‚ç‚¹å¤šå®¹å™¨æ¨¡å¼**ï¼šåŸºäºŽç‰¹å®šéƒ¨ç½²å•å…ƒï¼ˆ Podï¼‰å®žçŽ°åˆ†å¸ƒå¼ç®—æ³•,é€šå¸¸å®¹å™¨é—´éœ€è¦è·¨ç½‘ç»œé€šä¿¡,ç›¸å½“ äºŽå¤šä¸ªå®¶åº­æ­¤æ¨¡å¼ä¾èµ–äºŽåº”ç”¨è‡ªèº«çš„å®žçŽ°, ä¾‹å¦‚: MySQLä¸»ä»Žå¤åˆ¶é›†ç¾¤åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹çš„Pod





##### å•èŠ‚ç‚¹å¤šå®¹å™¨æ¨¡å¼



**æ³¨æ„:æ­¤å¤„çš„èŠ‚ç‚¹æŒ‡ä¸€ä¸ªpod,è€ŒéžworkerèŠ‚ç‚¹ä¸»æœº**

ä¸€ç§è·¨å®¹å™¨çš„è®¾è®¡æ¨¡å¼ï¼Œç›®çš„æ˜¯åœ¨**å•ä¸ªPodä¹‹ä¸Š**åŒæ—¶**è¿è¡Œå¤šä¸ªå…±ç”Ÿå…³ç³»çš„å®¹å™¨**ï¼Œå› è€Œå®¹å™¨ç®¡ç†ç³»ç»Ÿéœ€è¦ç”±å°†å®ƒä»¬ä½œä¸ºä¸€ä¸ªåŽŸå­å•ä½è¿›è¡Œç»Ÿä¸€è°ƒåº¦

**Podæ¦‚å¿µå°±æ˜¯è¿™ä¸ªè®¾è®¡æ¨¡å¼çš„å®žçŽ°ä¹‹ä¸€**

ä¸€ä¸ªå®¹å™¨æœ‰å¤šä¸ªå®¹å™¨,åˆ†ä¸ºä¸¤ç±»

- ä¸»å®¹å™¨: å®Œæˆä¸»è¦æ ¸å¿ƒä¸šåŠ¡
- è¾…åŠ©å®¹å™¨: æä¾›è¾…åŠ©åŠŸèƒ½,æ¯”å¦‚ç›‘æŽ§,å†…æ ¸ä¼˜åŒ–,ä»£ç†ç­‰



**å•èŠ‚ç‚¹å¤šå®¹å™¨æ¨¡å¼çš„å¸¸è§å®žçŽ°**

è¾…åŠ©å®¹å™¨è·Ÿæ®å’Œä¸»å®¹å™¨çš„å…³ç³»,å¯ä»¥ç”±ä¸‹é¢å‡ ç§æ¨¡å¼

- **Init Container æ¨¡å¼**
  - Init Containeræ¨¡å¼åªä¼šå‡ºçŽ°åœ¨å®¹å™¨åˆå§‹åŒ–é˜¶æ®µ
  - Initå®¹å™¨è´Ÿè´£ä»¥ä¸åŒäºŽä¸»å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸæ¥å®Œæˆé‚£äº›å¿…è¦çš„åˆå§‹åŒ–ä»»åŠ¡ï¼ŒåŒ…æ‹¬åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šè®¾ç½®å¿… è¦çš„ç‰¹æ®Šæƒé™ã€æ•°æ®åº“æ¨¡å¼è®¾ç½®æˆ–ä¸ºä¸»åº”ç”¨ç¨‹åºæä¾›åˆå§‹æ•°æ®ç­‰ï¼Œä½†è¿™äº›åˆå§‹åŒ–é€»è¾‘æ— æ³•åŒ…å«åœ¨åº” ç”¨ç¨‹åºçš„é•œåƒæ–‡ä»¶ä¸­ï¼Œæˆ–è€…å‡ºäºŽå®‰å…¨åŽŸå› ï¼Œåº”ç”¨ç¨‹åºé•œåƒæ²¡æœ‰æ‰§è¡Œåˆå§‹åŒ–æ´»åŠ¨çš„æƒé™ç­‰ç­‰
  - ä¸€ä¸ªPodä¸­å¯ä»¥åŒæ—¶å®šä¹‰å¤šä¸ªInitå®¹å™¨
  - Initå®¹å™¨éœ€è¦ä¸²è¡Œè¿è¡Œï¼Œä¸”åœ¨**æ‰€æœ‰Initå®¹å™¨å‡æ­£å¸¸ç»ˆæ­¢åŽï¼Œæ‰èƒ½è¿è¡Œä¸»å®¹å™¨**
  - æ³¨æ„: æ­¤æ¨¡å¼ç”¨`kubectl get pods` æ˜¾ç¤ºä¸€ä¸ªPodåªæœ‰ä¸€ä¸ªå®¹å™¨



- **Sidecar æ¨¡å¼**
  - Sidecaræ¨¡å¼å³è¾¹è½¦(æ‘©æ‰˜è½¦çš„æŒŽæ–—)æ¨¡å¼
  - Podä¸­çš„åº”ç”¨ç”±ä¸»åº”ç”¨ç¨‹åºï¼ˆé€šå¸¸æ˜¯åŸºäºŽHTTPåè®®çš„åº”ç”¨ç¨‹åºï¼‰ä»¥åŠä¸€ä¸ªSidecarçš„è¾…åŠ©å®¹å™¨ç»„æˆ Sidecaråšä¸ºè¾…åŠ©å®¹å™¨ç”¨äºŽä¸ºä¸»å®¹å™¨æä¾›è¾…åŠ©æœåŠ¡ä»¥å¢žå¼ºä¸»å®¹å™¨çš„åŠŸèƒ½ï¼Œæ˜¯ä¸»åº”ç”¨ç¨‹åºæ˜¯å¿…ä¸å¯å°‘ çš„ä¸€éƒ¨åˆ†ï¼Œä½†å´æœªå¿…éžå¾—è¿è¡Œä¸ºåº”ç”¨çš„ä¸€éƒ¨åˆ†,æ¯”å¦‚ï¼šæœåŠ¡ç½‘æ ¼çš„Envoyä»£ç†, filebeat æ—¥å¿—æ”¶
  - Sidecarå®¹å™¨å¯ä»¥å¯¹å®¢æˆ·ç«¯å’Œä¸»å®¹å™¨ä¹‹é—´çš„æ‰€æœ‰æµé‡è¿›è¡Œå¹²é¢„å’Œç›‘æŽ§ 
  - å¸¸è§åº”ç”¨åœºæ™¯: ä¸ºä¸»å®¹å™¨æä¾›ä»£ç†æœåŠ¡



- **Ambassador æ¨¡å¼**
  - Ambassadoræ¨¡å¼å³å¤§ä½¿æ¨¡å¼,åŠŸèƒ½ç±»ä¼¼ä¸€å›½çš„å¤§ä½¿
  - Podä¸­çš„åº”ç”¨ç”±**ä¸»åº”ç”¨ç¨‹åºå’Œä¸€ä¸ªAmbassadorå®¹å™¨ç»„æˆ**
  - Ambassadorè¾…åŠ©å®¹å™¨ä»£è¡¨ä¸»å®¹å™¨å‘é€ç½‘ç»œè¯·æ±‚è‡³ç‰¹å®šçš„å¤–éƒ¨çŽ¯å¢ƒä¸­ï¼Œå› æ­¤å¯ä»¥å°†å…¶è§†ä½œä¸»å®¹å™¨åº” ç”¨çš„â€œå¤§ä½¿â€



- **Adapter æ¨¡å¼**
  - Adapteræ¨¡å¼å³é€‚é…å™¨æ¨¡å¼
  - Podä¸­çš„åº”ç”¨ç”±ä¸»åº”ç”¨ç¨‹åºå’Œä¸€ä¸ªAdapterå®¹å™¨ç»„æˆï¼Œä¸»è¦ä¸ºä»Žå¤–éƒ¨åº”ç”¨å‘ä¸»åº”ç”¨å®¹å™¨è®¿é—®æä¾›æ”¯ æŒï¼Œå’ŒAmbassador æ¨¡å¼æ–¹å‘ç›¸å
  - Adapterå®¹å™¨ä¸ºä¸»åº”ç”¨ç¨‹åºæä¾›ä¸€è‡´çš„æŽ¥å£ï¼Œå®žçŽ°æ¨¡å—é‡ç”¨ï¼Œæ”¯æŒä¸»å®¹å™¨åº”ç”¨ç¨‹åºçš„æ ‡å‡†åŒ–å’Œè§„èŒƒ åŒ–è¾“å‡ºä»¥ä¾¿äºŽä»Žå¤–éƒ¨æœåŠ¡è¿›è¡Œè®¿é—®
  - Adapterå®¹å™¨å¸®åŠ©ä¸»å®¹å™¨é€šä¿¡è¿‡ç¨‹ä¸­çš„ä¿¡æ¯æ ¼å¼ä¿®æ­£,å°†å®¢æˆ·ç«¯çš„æ•°æ®æ ¼å¼è½¬æ¢æˆä¸»å®¹å™¨èƒ½å¤Ÿè¯†åˆ«çš„ æ•°æ®æ ¼å¼
  - å¸¸è§åº”ç”¨åœºæ™¯: å¤–éƒ¨prometheusæœåŠ¡é€šè¿‡Adapter æ¨¡å¼çš„Exporterå®¹å™¨æŠ“å–nginxå®¹å™¨çš„æ—¥å¿—,ä¸­é—´ Exporteréœ€è¦è½¬æ¢ä¸¤è€…ä¹‹é—´çš„æ ¼å¼   



##### initæ¨¡å¼æ¡ˆä¾‹

```yaml
# cat pod-init-container.yaml

apiVersion: v1
kind: Pod
metadata:
  name: pod-init-container
  namespace: default
spec:
  initContainers:
  - name: iptables-init
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1
    imagePullPolicy: IfNotPresent
    command: ['/bin/bash', '-c']
    args: ['iptables -t nat -A -PREROUTING -p tcp --dport 8000 -j REDIRECT --to-port:80']
    securityContext:
      capabilities:
        add:
        - NET_ADMIN
  containers:
  - name: demo
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    ports:
    - name: http
      containerPort: 80
```



##### sidecaræ¨¡å¼æ¡ˆä¾‹

```yaml
# cat pod-sidecar-test.yaml
apiServer: v1
kind: Pod
metadata:
  name: sidecar-test
spec:
  containers:
  - name: proxy
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/envoy-alpine:v1.14.1
    command: ['sh', '-c', 'sleep 5 && envoy -c /etc/envoy/envoy.yaml']
    lifecycle:
      postStart:
        exec:
          command: ["/bin/sh", "-c", "wget -O /etc/envoy/envoy.yaml http://www.wangxiaochun.com:8888/kubernetes/yaml/envoy.yaml"]
  - name: pod-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    env:
    - name: HOST
      value: "127.0.0.1"
    - name: PORT
      value: "8000"
```





## Kuberneteså·¥ä½œè´Ÿè½½



**æœ¬ç« å†…å®¹**

- **æŽ§åˆ¶å™¨åŽŸç†**
- **æ ‡ç­¾å’Œæ ‡ç­¾é€‰æ‹©å™¨**
- **Replica Set**
- **Deployment**
- **DaemonSet**
- **Job**
- **CronJob**



### æŽ§åˆ¶å™¨åŽŸç†

#### èµ„æºå¯¹è±¡

![image-20241220154542565](D:\git_repository\cyber_security_learning\markdown_img\image-20241220154542565.png)



å¯¹äºŽKubernetes é›†ç¾¤åº”ç”¨æ¥è¯´ï¼Œæ‰€æœ‰çš„ç¨‹åºåº”ç”¨éƒ½æ˜¯

- è¿è¡Œåœ¨ **Pod èµ„æº**å¯¹è±¡é‡Œé¢
- å€ŸåŠ©äºŽ**serviceèµ„æº**å¯¹è±¡å‘å¤–æä¾›æœåŠ¡è®¿é—®
- å€ŸåŠ©äºŽå„ç§**å­˜å‚¨èµ„æºå¯¹è±¡**å®žçŽ°æ•°æ®çš„å¯æŒä¹…åŒ–
- å€ŸåŠ©äºŽå„ç§**é…ç½®èµ„æºå¯¹è±¡**å®žçŽ°é…ç½®å±žæ€§ã€æ•æ„Ÿä¿¡æ¯çš„ç®¡ç†æ“ä½œ



#### åº”ç”¨ç¼–æŽ’

åœ¨å·¥ä½œä¸­ä¸ºäº†å®Œæˆå¤§é‡çš„ä¸šåŠ¡ç›®æ ‡ï¼Œé¦–å…ˆä¼šæ ¹æ®ä¸šåŠ¡åº”ç”¨å†…éƒ¨çš„å…³è”å…³ç³»ï¼Œ**æŠŠä¸šåŠ¡æ‹†åˆ†æˆå¤šä¸ªå­ä»»åŠ¡**ï¼Œ ç„¶åŽ**å¯¹è¿™äº›å­ä»»åŠ¡è¿›è¡Œé¡ºåºç»„åˆ**ï¼Œå½“å­ä»»åŠ¡æŒ‰ç…§æ–¹æ¡ˆæ‰§è¡Œå®Œæ¯•åŽï¼Œå°±å®Œæˆäº†ä¸šåŠ¡ç›®æ ‡ã€‚

ä»»åŠ¡ç¼–æŽ’å®žçŽ°å°±æ˜¯å¯¹å¤šä¸ªå­ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºè¿›è¡Œç¡®å®šçš„è¿‡ç¨‹ã€‚

å¯¹äºŽKubernetes æ¥è¯´:

- å¯¹äºŽ**ç´§å¯†ç›¸å…³**çš„å¤šä¸ªå­ä»»åŠ¡ï¼ŒæŠŠå®ƒä»¬æ”¾åˆ°**åŒä¸€ä¸ªpodå†…éƒ¨**
- å¯¹äºŽ**éžç´§å¯†å…³è”**çš„å¤šä¸ªä»»åŠ¡ï¼Œåˆ†åˆ«æ”¾åˆ°**ä¸åŒçš„podä¸­**
- ç„¶åŽå€ŸåŠ©äºŽ**endpoint+service**çš„æ–¹å¼å®žçŽ°å½¼æ­¤ä¹‹é—´çš„ç›¸äº’è°ƒç”¨

- ä¸ºäº†è®©è¿™äº›çº·ä¹±ç¹æ‚çš„ä»»åŠ¡èƒ½å¤Ÿäº’ç›¸å‘çŽ°ï¼Œé€šè¿‡é›†ç¾¤çš„ **CoreDNS**ç»„ä»¶å®žçŽ°æœåŠ¡æ³¨å†Œå‘çŽ°åŠŸèƒ½ã€‚



å¯¹äºŽKubernetesåœºæ™¯ä¸­çš„åº”ç”¨ä»»åŠ¡ï¼Œä¸»è¦å­˜åœ¨éƒ¨ç½²ã€æ‰©å®¹ã€ç¼©å®¹ã€æ›´æ–°ã€å›žæ»šç­‰å¸¸è§ç¼–æŽ’æ“ä½œã€‚

è™½ç„¶åŸºäºŽpodçš„æ–¹å¼å®žçŽ°äº†åº”ç”¨ä»»åŠ¡çš„éƒ¨ç½²åŠŸèƒ½æ“ä½œï¼Œä½†æ˜¯å¯¹äºŽè‡ªä¸»å¼çš„podæ¥è¯´ï¼Œå®ƒå¹¶ä¸èƒ½å®žçŽ°å…¶ä»– çš„æ›´å¤šç¼–æŽ’ä»»åŠ¡ã€‚

å› æ­¤åœ¨Kubernetesé›†ç¾¤çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸Šï¼Œæœ‰ä¸€ç¾¤éžå¸¸é‡è¦çš„ç»„ä»¶ä¸“ç”¨äºŽå¯¹podå®žçŽ°æ‰€è°“çš„ä»»åŠ¡ç¼–æŽ’åŠŸ èƒ½ï¼Œè¿™äº›ç»„ä»¶ç»Ÿç»Ÿå°†å…¶ç§°ä¸º**æŽ§åˆ¶å™¨Controller**ã€‚



**Kubernetesçš„å£°æ˜Žå¼API**

- ç”¨æˆ·èƒ½å¤Ÿä»¥å£°æ˜Žå¼å®šä¹‰èµ„æºå¯¹è±¡çš„ç›®æ ‡çŠ¶æ€ï¼Œå³specå­—æ®µ
- ç”±æŽ§åˆ¶å™¨ä»£ç ï¼ˆæœºå™¨æ™ºèƒ½ç»„ä»¶ï¼‰è´Ÿè´£ç¡®ä¿å®žé™…çŠ¶æ€ï¼Œå³**statuså­—æ®µä¸ŽæœŸæœ›çŠ¶æ€specå­—æ®µä¸€è‡´**
- æŽ§åˆ¶å™¨ç›¸å½“äºŽâ€œäººå·¥æ™ºèƒ½æœºå™¨äººâ€ï¼Œè´Ÿè´£ç¡®ä¿å„é¡¹å…·ä½“ä»»åŠ¡å¾—ä»¥è½åœ°ï¼Œè€ŒæŽ§åˆ¶å™¨é€šå¸¸ç”±APIçš„æä¾›è€…è´Ÿ è´£å¼€å‘ç¼–å†™
- ç”¨æˆ·éœ€è¦åšçš„æ˜¯æ ¹æ®èµ„æºç±»åž‹åŠå…¶æŽ§åˆ¶å™¨æä¾›çš„DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰è¿›è¡Œå£°æ˜Žå¼ç¼–ç¨‹



**Kubernetesçš„æŽ§åˆ¶å™¨ç±»åž‹**

- Kuberneteså†…ç½®æŽ§åˆ¶å™¨ï¼š
  - Kubernetesé»˜è®¤å°±æä¾›çš„å®žçŽ°åŸºç¡€åž‹ã€æ ¸å¿ƒåž‹çš„æŽ§åˆ¶å™¨
  - Controller Managerä¸­å†…ç½®æä¾›äº†è®¸å¤šçš„æŽ§åˆ¶å™¨ï¼Œä¾‹å¦‚Service Controllerã€DeploymentControllerç­‰
  - ä»¥kube-controller-managerç»„ä»¶çš„ç¨‹åºæ–¹å¼è¿è¡Œå®žçŽ°
- ç¬¬ä¸‰æ–¹æŽ§åˆ¶å™¨
  - å®žçŽ°é«˜çº§æŽ§åˆ¶å™¨ï¼Œé€šå¸¸éœ€è¦å€ŸåŠ©äºŽåŸºç¡€åž‹æŽ§åˆ¶å™¨å®Œæˆå…¶åŠŸèƒ½
  - ä¾‹å¦‚Ingressæ’ä»¶ingress-nginxçš„Controllerï¼Œç½‘ç»œæ’ä»¶Project Calicoçš„Controllerç­‰
  - é€šå¸¸ä»¥Podå½¢å¼æ‰˜ç®¡è¿è¡ŒäºŽKubernetesä¹‹ä¸Šï¼Œè€Œä¸”è¿™äº›Podå†ç”±å†…ç½®çš„æŽ§åˆ¶å™¨æ‰€æŽ§åˆ¶



**æŽ§åˆ¶å™¨ç§ç±»**

- èŠ‚ç‚¹æŽ§åˆ¶å™¨(Node Controller): è´Ÿè´£åœ¨èŠ‚ç‚¹å‡ºçŽ°æ•…éšœæ—¶è¿›è¡Œé€šçŸ¥å’Œå“åº”
- ä»»åŠ¡æŽ§åˆ¶å™¨(Job controller): ç›‘æµ‹ä»£è¡¨ä¸€æ¬¡æ€§ä»»åŠ¡çš„ Job å¯¹è±¡ï¼Œç„¶åŽåˆ›å»º Pods æ¥è¿è¡Œè¿™äº›ä»»åŠ¡ç›´è‡³å®Œæˆ
- ç«¯ç‚¹æŽ§åˆ¶å™¨(Endpoints Controller): å¡«å……ç«¯ç‚¹(Endpoints)å¯¹è±¡(å³åŠ å…¥ Service ä¸Ž Pod)
- æœåŠ¡å¸æˆ·å’Œä»¤ç‰ŒæŽ§åˆ¶å™¨(Service Account & Token Controllers): ä¸ºæ–°çš„å‘½åç©ºé—´åˆ›å»ºé»˜è®¤å¸æˆ·å’Œ API è®¿é—®ä»¤ç‰Œ



**Kubernetes Controllerçš„æŽ§åˆ¶å›žè·¯æœºåˆ¶**

![image-20241220160056338](D:\git_repository\cyber_security_learning\markdown_img\image-20241220160056338.png)



- Controlleræ ¹æ®Specï¼ŒæŽ§åˆ¶Systemsç”Ÿæˆå½“å‰å®žé™…Status
- Controllerå€ŸåŠ©äºŽSensoræŒç»­ç›‘è§†Systemçš„Specå’ŒStatusï¼Œåœ¨æ¯ä¸€æ¬¡æŽ§åˆ¶å›žè·¯ä¸­éƒ½ä¼šå¯¹äºŒè€…è¿›è¡Œ æ¯”è¾ƒ
- ç¡®ä¿Systemçš„Statusä¸æ–­é€¼è¿‘æˆ–å®Œå…¨ç­‰åŒSpec



#### Kubernetes Controller æµç¨‹

![image-20241220160149849](D:\git_repository\cyber_security_learning\markdown_img\image-20241220160149849.png)

- ç”¨æˆ·å‘ APIserverä¸­æ’å…¥ä¸€ä¸ªåº”ç”¨èµ„æºå¯¹è±¡çš„è¯·æ±‚
- è¿™ä¸ªè¯·æ±‚åŒ…å«çš„æ•°æ®å½¢æ€ä¸­å®šä¹‰äº†è¯¥èµ„æºå¯¹è±¡çš„ "æœŸæœ›"çŠ¶æ€
- æ•°æ®ç»ç”± APIserver ä¿å­˜åˆ° ETCD ä¸­
- kube-controller-manager ä¸­çš„å„ç§æŽ§åˆ¶å™¨ä¼šç›‘è§† Apiserverä¸Šä¸Žè‡ªå·±ç›¸å…³çš„èµ„æºå¯¹è±¡çš„å˜åŠ¨ æ¯”å¦‚ Pod Controlleråªè´Ÿè´£Podèµ„æºçš„æŽ§åˆ¶ï¼ŒService Controlleråªè´Ÿè´£Serviceèµ„æºçš„æŽ§åˆ¶ç­‰ã€‚
- ä¸€æ—¦API Serverä¸­çš„èµ„æºå¯¹è±¡å‘ç”Ÿå˜åŠ¨ï¼Œå¯¹åº”çš„Controlleræ‰§è¡Œç›¸å…³çš„é…ç½®ä»£ç ï¼Œåˆ°å¯¹åº”çš„nodeèŠ‚ ç‚¹ä¸Šè¿è¡Œ
- è¯¥èµ„æºå¯¹è±¡ä¼šåœ¨å½“å‰èŠ‚ç‚¹ä¸Šï¼ŒæŒ‰ç…§ç”¨æˆ·çš„"æœŸæœ›"è¿›è¡Œè¿è¡Œ
- è¿™äº›å®žä½“å¯¹è±¡çš„è¿è¡ŒçŠ¶æ€ç§°ä¸º "å®žé™…çŠ¶æ€"
- å³æŽ§åˆ¶å™¨çš„ä½œç”¨å°±æ˜¯ç¡®ä¿ "æœŸæœ›çŠ¶æ€" ä¸Ž "å®žé™…çŠ¶æ€" ç›¸ä¸€è‡´
- Controllerå°†è¿™äº›å®žé™…çš„èµ„æºå¯¹è±¡çŠ¶æ€ï¼Œé€šè¿‡APIServerå­˜å‚¨åˆ°ETCDçš„åŒä¸€ä¸ªæ•°æ®æ¡ç›®çš„statusçš„ å­—æ®µä¸­
- èµ„æºå¯¹è±¡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼ŒController ä¼šå¾ªçŽ¯çš„æ–¹å¼å‘ APIServer ç›‘æŽ§ spec å’Œ status çš„å€¼æ˜¯å¦ä¸€è‡´
- å¦‚æžœä¸¤ä¸ªçŠ¶æ€ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±æŒ‡æŒ¥nodeèŠ‚ç‚¹çš„èµ„æºè¿›è¡Œä¿®æ”¹ï¼Œä¿è¯ä¸¤ä¸ªçŠ¶æ€ä¸€è‡´
- çŠ¶æ€ä¸€è‡´åŽï¼Œé€šè¿‡APIServeråŒæ­¥æ›´æ–°å½“å‰èµ„æºå¯¹è±¡åœ¨ETCDä¸Šçš„æ•°æ®



### å·¥ä½œè´Ÿè½½èµ„æº

å·¥ä½œè´Ÿè½½æ˜¯åœ¨ Kubernetes ä¸Šè¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚

ä¸ºäº†å‡è½»ç”¨æˆ·çš„ä½¿ç”¨è´Ÿæ‹…ï¼Œé€šå¸¸ä¸éœ€è¦ç”¨æˆ·ç›´æŽ¥ç®¡ç†æ¯ä¸ª Pod ã€‚ è€Œæ˜¯**ä½¿ç”¨è´Ÿè½½èµ„æºæ¥æ›¿ç”¨æˆ·ç®¡ç† ä¸€ç»„ Pod**ã€‚ è¿™äº›è´Ÿè½½èµ„æºé€šè¿‡å¯¹åº”çš„é…ç½®æŽ§åˆ¶å™¨æ¥ç¡®ä¿æ­£ç¡®ç±»åž‹çš„ã€å¤„äºŽè¿è¡ŒçŠ¶æ€çš„ Pod ä¸ªæ•°æ˜¯æ­£ç¡® çš„ï¼Œä¸Žç”¨æˆ·æ‰€æŒ‡å®šçš„çŠ¶æ€ç›¸ä¸€è‡´ã€‚

ä»¥ç¼–æŽ’PodåŒ–è¿è¡Œçš„åº”ç”¨ä¸ºæ ¸å¿ƒçš„æŽ§åˆ¶å™¨ï¼Œé€šå¸¸è¢«ç»Ÿç§°ä¸ºå·¥ä½œè´Ÿè½½åž‹æŽ§åˆ¶å™¨ï¼Œç”¨äºŽç®¡ç†ä¸Žä¹‹åŒåçš„å·¥ä½œè´Ÿè½½åž‹èµ„æºç±»åž‹çš„èµ„æºå¯¹è±¡



**Kubernetes æä¾›è‹¥å¹²ç§å†…ç½®çš„å·¥ä½œè´Ÿè½½èµ„æºï¼š**

- **æ— çŠ¶æ€åº”ç”¨ç¼–æŽ’**: Deployment å’Œ ReplicaSet ï¼ˆæ›¿æ¢åŽŸæ¥çš„èµ„æº ReplicationControllerï¼‰ã€‚ Deployment å¾ˆé€‚åˆç”¨æ¥ç®¡ç†ä½ çš„é›†ç¾¤ä¸Šçš„æ— çŠ¶æ€åº”ç”¨ï¼Œ Deployment ä¸­çš„æ‰€æœ‰ Pod éƒ½æ˜¯ç›¸äº’ç­‰ä»·çš„ï¼Œå¹¶ä¸”åœ¨éœ€è¦çš„æ—¶å€™è¢«æ›¿æ¢ã€‚
- **æœ‰çŠ¶æ€åº”ç”¨ç¼–æŽ’**:StatefulSet è®©ä½ èƒ½å¤Ÿè¿è¡Œä¸€ä¸ªæˆ–è€…å¤šä¸ªä»¥æŸç§æ–¹å¼è·Ÿè¸ªåº”ç”¨çŠ¶æ€çš„ Podã€‚ ä¾‹å¦‚ï¼Œ å¦‚æžœä½ çš„è´Ÿè½½ä¼šå°†æ•°æ®ä½œæŒä¹…å­˜å‚¨ï¼Œä½ å¯ä»¥è¿è¡Œä¸€ä¸ª StatefulSet ï¼Œå°†æ¯ä¸ª Pod ä¸ŽæŸä¸ª PersistentVolume å¯¹åº”èµ·æ¥ã€‚ä½ åœ¨ StatefulSet ä¸­å„ä¸ª Pod å†…è¿è¡Œçš„ä»£ç å¯ä»¥å°†æ•°æ®å¤åˆ¶åˆ° åŒä¸€ StatefulSet ä¸­çš„å…¶å®ƒ Pod ä¸­ä»¥æé«˜æ•´ä½“çš„æœåŠ¡å¯é æ€§ã€‚
- **ç³»ç»Ÿçº§åº”ç”¨**:DaemonSet å®šä¹‰æä¾›èŠ‚ç‚¹æœ¬åœ°æ”¯æ’‘è®¾æ–½çš„ Pod ã€‚è¿™äº› Pod å¯èƒ½å¯¹äºŽä½ çš„é›†ç¾¤çš„è¿ç»´ æ˜¯ éžå¸¸é‡è¦çš„ï¼Œä¾‹å¦‚ä½œä¸ºç½‘ç»œé“¾æŽ¥çš„è¾…åŠ©å·¥å…·æˆ–è€…ä½œä¸ºç½‘ç»œ æ’ä»¶ çš„ä¸€éƒ¨åˆ†ç­‰ç­‰ã€‚æ¯æ¬¡ä½ å‘é›†ç¾¤ä¸­ æ·»åŠ ä¸€ä¸ªæ–°èŠ‚ç‚¹æ—¶ï¼Œå¦‚æžœè¯¥èŠ‚ç‚¹ä¸ŽæŸ DaemonSet çš„è§„çº¦åŒ¹é…ï¼Œåˆ™æŽ§åˆ¶å¹³é¢ä¼šä¸ºè¯¥ DaemonSet è°ƒåº¦ä¸€ä¸ª Pod åˆ°è¯¥æ–°èŠ‚ç‚¹ä¸Šè¿è¡Œã€‚
- **ä½œä¸šç±»åº”ç”¨:**Job å’Œ CronJobã€‚ å®šä¹‰ä¸€äº›ä¸€ç›´è¿è¡Œåˆ°ç»“æŸå¹¶åœæ­¢çš„ä»»åŠ¡ã€‚ Job ç”¨æ¥æ‰§è¡Œä¸€æ¬¡æ€§ä»» åŠ¡ï¼Œè€Œ CronJob ç”¨æ¥æ‰§è¡Œçš„æ ¹æ®æ—¶é—´è§„åˆ’åå¤è¿è¡Œçš„ä»»åŠ¡ã€‚



| æŽ§åˆ¶å™¨                | è§£æž                                                         |
| --------------------- | ------------------------------------------------------------ |
| ReplicationController | æœ€æ—©æœŸçš„PodæŽ§åˆ¶å™¨ï¼Œç›®å‰å·²è¢«åºŸå¼ƒ                              |
| RelicaSet             | å‰¯æœ¬é›†ï¼Œè´Ÿè´£ç®¡ç†ä¸€ä¸ªåº”ç”¨(Pod)çš„å¤šä¸ªå‰¯æœ¬çŠ¶æ€                  |
| Deployment            | å®ƒä¸ç›´æŽ¥ç®¡ç†Podï¼Œè€Œæ˜¯å€ŸåŠ©äºŽReplicaSetæ¥ç®¡ç†Podï¼›æœ€å¸¸ç”¨çš„æ— çŠ¶æ€åº”ç”¨æŽ§åˆ¶å™¨ |
| DaemonSet             | å®ˆæŠ¤è¿›ç¨‹é›†ï¼Œç”¨äºŽç¡®ä¿åœ¨æ¯ä¸ªèŠ‚ç‚¹ä»…è¿è¡ŒæŸä¸ªåº”ç”¨çš„ä¸€ä¸ªPodå‰¯æœ¬ã€‚ç”¨äºŽå®Œæˆç³»ç»Ÿçº§ä»»åŠ¡ |
| Job                   | æœ‰ç»ˆæ­¢æœŸé™çš„ä¸€æ¬¡æ€§ä½œä¸šå¼ä»»åŠ¡ï¼Œè€Œéžä¸€ç›´å¤„äºŽè¿è¡ŒçŠ¶æ€çš„æœåŠ¡è¿›ç¨‹ |
| CronJob               | æœ‰ç»ˆæ­¢æœŸé™çš„å‘¨æœŸæ€§ä½œä¸šå¼ä»»åŠ¡                                 |
| StatefulSet           | åŠŸèƒ½ç±»ä¼¼äºŽDeploymentï¼Œä½†StatefulSetä¸“ç”¨äºŽç¼–æŽ’æœ‰çŠ¶æ€åº”ç”¨      |

æ³¨æ„ï¼š

- å½“å‰ä¸»è¦ apps/v1 ç‰ˆæœ¬ä¸‹çš„æŽ§åˆ¶å™¨
- æ¯ä¸ªæŽ§åˆ¶å™¨å¯¹è±¡ä¹Ÿéœ€è¦å¯¹åº”çš„controlleræ¥è¿›è¡Œç®¡ç†



#### **æŽ§åˆ¶å™¨å’ŒPod**

- æŽ§åˆ¶å™¨ä¸»è¦æ˜¯é€šè¿‡ç®¡ç†podæ¥å®žçŽ°ä»»åŠ¡çš„ç¼–æŽ’æ•ˆæžœ
- æŽ§åˆ¶å™¨æ˜¯é€šè¿‡**æ ‡ç­¾æˆ–è€…æ ‡ç­¾é€‰æ‹©å™¨**æ‰¾åˆ°pod
- æŽ§åˆ¶å™¨å¯¹è±¡ä»…è´Ÿè´£ç¡®ä¿API Serverä¸Šæœ‰ç›¸åº”æ•°é‡çš„ç¬¦åˆæ ‡ç­¾é€‰æ‹©å™¨çš„Podå¯¹è±¡çš„å®šä¹‰
- Pod å¯¹è±¡çš„Statuså¦‚ä½•ä¸ŽSpecä¿æŒä¸€è‡´ï¼Œåˆ™è¦ç”±ç›¸åº”èŠ‚ç‚¹ä¸Šçš„kubeletè´Ÿè´£ä¿è¯

![image-20241220162927417](D:\git_repository\cyber_security_learning\markdown_img\image-20241220162927417.png)



#### èŠ‚ç‚¹æŽ§åˆ¶å™¨å’ŒWorkerèŠ‚ç‚¹

![image-20241220163315449](D:\git_repository\cyber_security_learning\markdown_img\image-20241220163315449.png)

- èŠ‚ç‚¹æŽ§åˆ¶å™¨**æ¯é—´éš”5ç§’æ£€æŸ¥ä¸€æ¬¡** Worker èŠ‚ç‚¹çš„çŠ¶æ€
- å¦‚æžœèŠ‚ç‚¹æŽ§åˆ¶å™¨æ²¡æœ‰æ”¶åˆ°æ¥è‡ªWorker èŠ‚ç‚¹çš„å¿ƒè·³ï¼Œåˆ™å°†è¯¥Worker èŠ‚ç‚¹è¢«æ ‡è®°ä¸º**ä¸å¯è¾¾**
- å¦‚æžœè¯¥WorkerèŠ‚ç‚¹è¢«æ ‡è®°ä¸ºä¸å¯è¾¾åŽ,èŠ‚ç‚¹æŽ§åˆ¶å™¨å†**ç­‰å¾…40ç§’åŽ**ä»æ— æ³•å¾—åˆ°æ­¤èŠ‚ç‚¹çš„å¿ƒè·³,å°†è¯¥èŠ‚ç‚¹ æ ‡è®°ä¸º**æ— æ³•è®¿é—®**
- å¦‚æžœè¯¥Worker èŠ‚ç‚¹è¢«æ ‡è®°ä¸ºæ— æ³•è®¿é—®åŽ,å†**ç­‰å¾…5åˆ†é’ŸåŽ,**è¿˜æ²¡æœ‰å¿ƒè·³, èŠ‚ç‚¹æŽ§åˆ¶å™¨ä¼š**åˆ é™¤å½“å‰ WorkerèŠ‚ç‚¹ä¸Šé¢çš„æ‰€æœ‰pod,å¹¶åœ¨å…¶å®ƒå¯ç”¨çš„WorkerèŠ‚ç‚¹é‡å»ºè¿™äº› pod**





### **æ ‡ç­¾å’Œæ ‡ç­¾é€‰æ‹©å™¨**

#### æ ‡ç­¾è¯´æ˜Ž

Kubernetesé€šè¿‡æ ‡ç­¾æ¥ç®¡ç†å¯¹åº”æˆ–è€…ç›¸å…³è”çš„å„ç§èµ„æºå¯¹è±¡ï¼Œ**Label**æ˜¯kubernetesä¸­çš„æ ¸å¿ƒæ¦‚å¿µä¹‹ä¸€ã€‚

Label ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„API èµ„æºç±»åž‹,ä½†Labelå¯¹è±¡å¯ä»¥å…³è”åˆ°å„ç§èµ„æºå¯¹è±¡ä¸Š

é€šè¿‡å¯¹Labelçš„ç®¡ç†ä»Žè€Œè¾¾åˆ°å¯¹ç›¸åŒLabelçš„èµ„æºè¿›è¡Œåˆ†ç»„ç®¡ç†ã€åˆ†é…ã€è°ƒåº¦ã€é…ç½®ã€éƒ¨ç½²ç­‰ã€‚

æ ‡ç­¾Label æ˜¯å¯ä»¥é™„åŠ åœ¨ä»»ä½•èµ„æºå¯¹è±¡ä¸Šçš„é”®å€¼åž‹å…ƒæ•°æ®,å³**Labelæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªkey/valueé”®å€¼å¯¹**ï¼Œå…¶ä¸­ keyä¸Žvalueç”±ç”¨æˆ·è‡ªå·±æŒ‡å®š

keyé”®æ ‡è¯†ç”±é”®å‰ç¼€å’Œé”®åç»„æˆ,æ ¼å¼ä¸º **[key_prefix/]key_name**



**`kubectl label`** å‘½ä»¤å¯ç®¡ç†å¯¹è±¡çš„æ ‡ç­¾

åˆ›å»ºï¼šLabelé€šå¸¸åœ¨èµ„æºå¯¹è±¡å®šä¹‰æ—¶ç¡®å®šï¼Œä¹Ÿå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºåŽåŠ¨æ€æ·»åŠ æˆ–è€…åˆ é™¤

ä¸€ä¸ªèµ„æºå¯¹è±¡å¯ä»¥å®šä¹‰å¤šä¸ªLabelï¼ŒåŒä¸€ä¸ªLabel ä¹Ÿå¯ä»¥å…³è”å¤šä¸ªèµ„æºå¯¹è±¡ä¸ŠåŽ»



**å¸¸ç”¨æ ‡ç­¾ä½¿ç”¨åœºæ™¯ï¼š**

- ç‰ˆæœ¬æ ‡ç­¾ï¼š"release" : "stable"ï¼Œ"release" : "canary"ï¼Œ"release" : "beta"
- çŽ¯å¢ƒæ ‡ç­¾ï¼š"environment" : "dev"ï¼Œ"environment" : "qa"ï¼Œ"environment" : "prod"
- åº”ç”¨æ ‡ç­¾ï¼š"app" : "ui"ï¼Œ"app" : "as"ï¼Œ"app" : "pc"ï¼Œ"app" : "sc"
- æž¶æž„å±‚çº§æ ‡ç­¾ï¼š"tier" : "frontend"ï¼Œ"tier" : "backend", "tier" : "cache"
- åˆ†åŒºæ ‡ç­¾ï¼š"partition" : "customerA"ï¼Œ"partition" : "customerB"
- å“æŽ§çº§åˆ«æ ‡ç­¾ï¼š"track" : "daily"ï¼Œ"track" : "weekly"



#### ç®¡ç†æ ‡ç­¾

å…³äºŽlabelçš„åˆ›å»ºæ“ä½œä¸»è¦æœ‰ä¸¤ç§ï¼š

- å‘½ä»¤è¡Œæ–¹æ³•
- yamlæ–‡ä»¶æ–¹æ³•



#####  å‘½ä»¤è¡Œæ–¹æ³•

**ç®¡ç†æ ‡ç­¾ï¼š**

```bash
# æ·»åŠ æ ‡ç­¾
kubectl label èµ„æºç±»åž‹ èµ„æºåç§° label_name=label_value [label_name=label_value] ...

# ä¿®æ”¹æ ‡ç­¾
kubectl label èµ„æºç±»åž‹ èµ„æºåç§° label_name=label_value [label_name=label_value] ... --overwrite[=true]

# åˆ é™¤æ ‡ç­¾
kubectl label èµ„æºç±»åž‹ èµ„æºåç§° label_name- [label_name-] ...

# å‚æ•°è¯´æ˜Ž
åŒæ—¶å¢žåŠ å¤šä¸ªæ ‡ç­¾ï¼Œåªéœ€è¦åœ¨åŽé¢å¤šå†™å‡ ä¸ªå°±å¯ä»¥äº†ï¼Œä½¿ç”¨ç©ºæ ¼éš”å¼€
é»˜è®¤æƒ…å†µä¸‹ï¼Œå·²å­˜åœ¨çš„æ ‡ç­¾æ˜¯ä¸èƒ½ä¿®æ”¹çš„ï¼Œä½¿ç”¨ --overwrite=true è¡¨ç¤ºå¼ºåˆ¶è¦†ç›–
label_name=label_valueæ ·å¼å†™æˆ label_name- å³è¡¨ç¤ºåˆ é™¤label
```



**æŸ¥çœ‹æ ‡ç­¾å’ŒæŒ‡å®šæ ‡ç­¾çš„èµ„æº**

```bash
#æŸ¥çœ‹æ‰€æœ‰æ ‡ç­¾
kubectl get èµ„æºç±»åž‹ [èµ„æºåç§°] --show-labels

#ç¤ºä¾‹:
kubectl get pods --show-labels

#æŸ¥çœ‹æŒ‡å®šæ ‡ç­¾çš„èµ„æº
kubectl get pods -l label_name[=label_value]

# å‚æ•°ï¼š
-l #æŒ‡å®šæ ‡ç­¾æ¡ä»¶ï¼ŒèŽ·å–æŒ‡å®šèµ„æºå¯¹è±¡ï¼Œ=è¡¨ç¤ºåŒ¹é…ï¼Œ!= è¡¨ç¤ºä¸åŒ¹é…, å¦‚æžœåŽé¢çš„é€‰æ‹©æ ‡ç­¾æœ‰å¤šä¸ªçš„è¯ï¼Œä½¿ç”¨é€—å·éš”å¼€

# å¦‚æžœé’ˆå¯¹æ ‡ç­¾çš„å€¼è¿›è¡ŒèŒƒå›´è¿‡æ»¤çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ ¼å¼ï¼š
-l 'label_name in (value1, value2, value3, ...)'      #åŒ…æ‹¬å…¶ä¸­ä¸€ä¸ªlabel
-l 'label_name notin (value1, value2, value3, ...)'   #ä¸åŒ…æ‹¬å…¶ä¸­ä»»ä½•ä¸€ä¸ªlabel
kube
#æ˜¯å¦å­˜åœ¨labelçš„åˆ¤æ–­
-l 'label_name'    #å­˜åœ¨label
-l '!label_name'   #ä¸å­˜åœ¨label,æ³¨æ„ä½¿ç”¨å•å¼•å·.ä¸æ”¯æŒåŒå¼•å·ã€‘
```



ç¤ºä¾‹

```bash
# æ·»åŠ æ ‡ç­¾
[root@master1 yaml]#kubectl label pod pod-startup-exec type=test
pod/pod-startup-exec labeled

# æŸ¥çœ‹æ ‡ç­¾
[root@master1 yaml]#kubectl get pod --show-labels 
NAME               READY   STATUS    RESTARTS   AGE     LABELS
pod-startup-exec   1/1     Running   0          5h51m   app=pod-startup-exec,type=test

# ä¿®æ”¹æ ‡ç­¾
[root@master1 yaml]#kubectl label pod pod-startup-exec type=proc --overwrite
pod/pod-startup-exec labeled

# æŸ¥çœ‹æ ‡ç­¾
[root@master1 yaml]#kubectl get pod --show-labels 
NAME               READY   STATUS    RESTARTS   AGE     LABELS
pod-startup-exec   1/1     Running   0          5h52m   app=pod-startup-exec,type=proc

# åˆ é™¤æ ‡ç­¾
[root@master1 yaml]#kubectl label pod pod-startup-exec type-
pod/pod-startup-exec unlabeled

# æŸ¥çœ‹æ ‡ç­¾
[root@master1 yaml]#kubectl get pod --show-labels 
NAME               READY   STATUS    RESTARTS   AGE     LABELS
pod-startup-exec   1/1     Running   0          5h53m   app=pod-startup-exec
```



##### yamlæ–¹æ³•

èµ„æºå¯¹è±¡ Label ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„APIèµ„æºï¼Œéœ€è¦ä¾é™„åœ¨æŸäº›èµ„æºå¯¹è±¡ä¸Šæ‰å¯ä»¥

æ¯”å¦‚ï¼šä¾é™„åœ¨Podï¼ŒServiceï¼ŒDeployment ç­‰å¯¹è±¡ä¸Š

åˆå§‹åŒ–Podèµ„æºå¯¹è±¡åº”ç”¨æ—¶å€™ï¼Œåœ¨èµ„æºå¯¹è±¡çš„å…ƒæ•°æ®metadataå±žæ€§ä¸‹æ·»åŠ ä¸€æ¡Labelsé…ç½®ï¼š

åœ¨ç‰¹å®šçš„å±žæ€§åŽé¢æŒ‰ç…§æŒ‡å®šæ–¹å¼å¢žåŠ å†…å®¹å³å¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š

```YAML
metadata:
  labels:
    key1: value1
    key2: value2
    ......
    
# æ³¨æ„ï¼šlabelså¤æ•°
```



ç¤ºä¾‹ï¼š

```yaml
# Labelåœ¨ä¹‹å‰çš„Podçš„èµ„æºæ–‡ä»¶ä¸­å®šä¹‰,æ ‡ç­¾çš„å†…å®¹æ˜¯ï¼šapp: nginxå’Œ version: v1.20.0
# cat pod-label-nginx.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-label-nginx
  labels:
    app: nginx
    version: v1.20.0
spec:
  containers:
  - name: pod-label-nginx-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    
# æŸ¥çœ‹
[root@master1 yaml]#kubectl get pod --show-labels 
NAME              READY   STATUS    RESTARTS   AGE   LABELS
pod-label-nginx   1/1     Running   0          10s   app=nginx,version=v1.20.0

# æ·»åŠ æ–°label
[root@master1 yaml]# kubectl label pod pod-label-nginx arch=frontend role=proxy
pod/pod-label-nginx labeled

[root@master1 yaml]# kubectl get pod --show-labels 
NAME              READY   STATUS    RESTARTS   AGE    LABELS
pod-label-nginx   1/1     Running   0          111s   app=nginx,arch=frontend,role=proxy,version=v1.20.0

```



#### æ ‡ç­¾é€‰æ‹©å™¨

Labelé™„åŠ åˆ°Kubernetesé›†ç¾¤ä¸­çš„å„ç§èµ„æºå¯¹è±¡ä¸Šï¼Œç›®çš„æ˜¯å¯¹è¿™äº›èµ„æºå¯¹è±¡å¯ä»¥è¿›è¡Œ**åŽç»­çš„åˆ†ç»„ç®¡ç†** è€Œåˆ†ç»„ç®¡ç†çš„æ ¸å¿ƒå°±æ˜¯ï¼š**æ ‡ç­¾é€‰æ‹©å™¨Label Selector**ã€‚

å¯ä»¥é€šè¿‡Label SelectoræŸ¥è¯¢å’Œç­›é€‰æŸäº›ç‰¹å®šLabelçš„èµ„æºå¯¹è±¡ï¼Œè¿›è€Œå¯ä»¥å¯¹ä»–ä»¬è¿›è¡Œç›¸åº”çš„æ“ä½œç®¡ç†



**æ ‡ç­¾é€‰æ‹©å™¨çš„ä¸»è¦åº”ç”¨åœºæ™¯ï¼š**

ç›‘æŽ§å…·ä½“çš„Podã€è´Ÿè½½å‡è¡¡è°ƒåº¦ã€å®šå‘è°ƒåº¦ï¼Œå¸¸ç”¨äºŽ Podã€Nodeç­‰èµ„æºå¯¹è±¡

**Label Selector**è·ŸLabelä¸€æ ·ï¼Œä¸èƒ½å•ç‹¬å®šä¹‰ï¼Œå¿…é¡»é™„åŠ åœ¨ä¸€äº›èµ„æºå¯¹è±¡çš„å®šä¹‰æ–‡ä»¶ä¸Šã€‚ä¸€èˆ¬é™„åŠ åœ¨RSï¼Œ Deployment å’ŒServiceç­‰èµ„æºå®šä¹‰æ–‡ä»¶ä¸­ã€‚

Label Selectorä½¿ç”¨æ—¶å€™æœ‰ä¸¤ç§å¸¸è§çš„æ ‡ç­¾é€‰æ‹©ç®—ç¬¦è¡¨è¾¾å¼ï¼š**ç­‰å€¼**å’Œ**é›†åˆ**



##### ç­‰å€¼å’Œä¸ç­‰å€¼

```bash
# ç­‰å€¼
name = nginx                                   # åŒ¹é…æ‰€æœ‰å…·æœ‰æ ‡ç­¾name = nginxçš„èµ„æºå¯¹è±¡
name == nginx                                  # åŒä¸Š
name                                           # è¡¨ç¤ºåŒ¹é…å­˜åœ¨nameæ ‡ç­¾çš„èµ„æºå¯¹è±¡

# ä¸ç­‰å€¼
!name                                          # è¡¨ç¤ºåŒ¹é…ä¸å­˜åœ¨nameæ ‡ç­¾çš„èµ„æºå¯¹è±¡
name != nginx                                  # åŒ¹é…æ‰€æœ‰æ²¡æœ‰nameæ ‡ç­¾æˆ–è€…æ ‡ç­¾nameçš„å€¼ä¸ç­‰äºŽnginxçš„èµ„æºå¯¹è±¡

# ç¤ºä¾‹ï¼špodè°ƒåº¦åˆ°æŒ‡å®šæ ‡ç­¾çš„NodeèŠ‚ç‚¹ä¸Š
apiVersion: v1
kind: Pod
metadata:
  name: cuda-test
spec:
  containers:
  - name: cuda-test
    image: "registry.k8s.io/cuda-vector-add:v0.1"
    resources:
      limits:
        nvidia.com/gpu: 1
  nodeSelector:
    acclerator: nvidia-tesla-p100
    
# å°†æ‰€æœ‰çš„æœ‰app: myappæ ‡ç­¾çš„podç®¡ç†åœ¨serviceä¸‹
apiVersion: v1
kind: Service
metadata:
  name: service-loadbalancer-lbaas
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: myapp
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
```



##### é›†åˆ

```bash
# ç¤ºä¾‹
env in (dev, test)                # åŒ¹é…æ‰€æœ‰å…·æœ‰æ ‡ç­¾ env = dev æˆ–è€… env = testçš„èµ„æºå¯¹è±¡
name notin (frontend, backent)    # åŒ¹é…æ‰€æœ‰ä¸å…·æœ‰æ ‡ç­¾name=frontendæˆ–è€…name=backendæˆ–è€…æ²¡æœ‰nameæ ‡ç­¾çš„èµ„æºå¯¹è±¡
```



åŽç»­Kubernetes çš„é›†åˆè¡¨è¾¾å¼åˆå¢žåŠ äº†ä¸¤ç§æ–°çš„å†™æ³•ï¼šåŒ¹é…æ ‡ç­¾ã€åŒ¹é…è¡¨è¾¾å¼



##### **åŒ¹é…æ ‡ç­¾ï¼šmatchLabels**

```bash
# åŒ¹é…æ ‡ç­¾
matchLabels:
  name: nginx
  app: myapp
  
# å½“ matchLabels ä¸­æœ‰å¤šä¸ªæ ‡ç­¾æ—¶ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯é€»è¾‘ä¸Žï¼ˆANDï¼‰å…³ç³»

#å¦‚ä¸‹æ‰€ç¤ºï¼š
matchLabels:
 app: frontend
 environment: production
#é‚£ä¹ˆåªæœ‰é‚£äº›æ ‡ç­¾ä¸­åŒæ—¶åŒ…å« app=frontend å’Œ environment=production çš„èµ„æºæ‰ä¼šè¢«é€‰ä¸­ã€‚
```



##### **åŒ¹é…è¡¨è¾¾å¼ matchExpressions**

```bash
#åŒ¹é…è¡¨è¾¾å¼ï¼š
   matchExpressions:
      - {key: name, operator: NotIn, values: [frontend]}
#å½“ matchExpressions ä¸­åŒ…å«å¤šä¸ªæ ‡ç­¾è¡¨è¾¾å¼æ—¶ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ˜¯é€»è¾‘ä¸Žï¼ˆANDï¼‰å…³ç³»ã€‚

#å¸¸è§çš„operatoræ“ä½œå±žæ€§å€¼æœ‰ï¼š
   Inã€NotInã€Existsã€NotExistsç­‰
   Existså’ŒNotExistæ—¶ï¼Œvalueså¿…é¡»ä¸ºç©ºï¼Œå³ { key: environment, opetator: Exists,values:}
#æ³¨æ„ï¼šè¿™äº›è¡¨è¾¾å¼ä¸€èˆ¬åº”ç”¨åœ¨RSã€RCã€Deploymentç­‰å…¶å®ƒç®¡ç†å¯¹è±¡ä¸­ã€‚

#ç¤ºä¾‹
matchExpressions:
  - key: environment
    operator: In
    values:
      - production
      - staging
  - key: app
    operator: NotIn
    values:
      - test
#é‚£ä¹ˆåªæœ‰é‚£äº›æ ‡ç­¾æ»¡è¶³ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶çš„èµ„æºæ‰ä¼šè¢«é€‰ä¸­ï¼š
- æ ‡ç­¾ä¸­ environment çš„å€¼æ˜¯ production æˆ– staging
- æ ‡ç­¾ä¸­ app çš„å€¼ä¸æ˜¯ test
```



#### æ ‡ç­¾é€‰æ‹©å™¨æ“ä½œæ–¹å¼

æ ‡ç­¾é€‰æ‹©å™¨ä¸¤ç§æ–¹å¼

- å‘½ä»¤
- æ–‡ä»¶



##### å‘½ä»¤æ–¹å¼

```bash
kubectl get TYPE -l SELECTOR1[,SELECTOR2,...]
kubectl get TYPE -l SELECTOR1 [-l SELECTOR2] ...

# ç¤ºä¾‹ï¼š
[root@master1 yaml]#kubectl get node -l ai
NAME    STATUS   ROLES    AGE    VERSION
node1   Ready    <none>   2d2h   v1.30.8
```



##### é…ç½®æ–‡ä»¶

```yaml
# åŸºäºŽç­‰å€¼ï¼Œå¤šä¸ªä¸ºä¸Žå…³ç³»
selector:
  component: reids
  
# åŸºäºŽé›†åˆ
selector:
  matchLabels:
    component: redis
  matchExpressions:
    - key: tier            # ç­‰ä»· - { key: tier, operator: In, values: [cache] }
      operator: In
      values: [cache]
    - key: environment     # ç­‰ä»· - { key: environment, operator: NotIn, values: [dev] }
      operator: NotIn
      values: [dev]
```





### Replica Set

####  Replica Set å·¥ä½œæœºåˆ¶

Replica Set æ˜¯Pod æœ€å¸¸ç”¨çš„æŽ§åˆ¶å™¨

Replica Set å…¶å®žæ˜¯å®šä¹‰äº†ä¸€ä¸ªæœŸæœ›çš„åœºæ™¯ï¼ŒRSæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

è´Ÿè´£ç¼–æŽ’æ— çŠ¶æ€åº”ç”¨çš„åŸºç¡€æŽ§åˆ¶å™¨æ˜¯ReplicaSetï¼Œå®šä¹‰ç¼–æŽ’ä¸€ä¸ªæ— çŠ¶æ€åº”ç”¨ç›¸åº”çš„èµ„æºç±»åž‹ä¸»è¦çš„**ä¸‰ä¸ªå…³é”®å±ž**æ€§å¦‚ä¸‹

- **replicas**ï¼šPodæœŸå¾…çš„å‰¯æœ¬æ•°é‡
- **selector**ï¼šç­›é€‰ç›®æ ‡Podçš„æ ‡ç­¾é€‰æ‹©å™¨,æ”¯æŒmatchExpressionså’ŒmatchLabels
- **template**ï¼šå¦‚æžœPodæ•°é‡ä¸æ»¡è¶³é¢„æœŸå€¼ï¼Œè‡ªåŠ¨åˆ›å»ºPodæ—¶å€™ç”¨åˆ°çš„æ¨¡æ¿(template)ï¼Œæ¸…å•æ–‡ä»¶æ ¼å¼ å’Œè‡ªä¸»å¼Podä¸€æ ·

æ„ä¹‰ï¼šè‡ªåŠ¨ç›‘æŽ§Podè¿è¡Œçš„å‰¯æœ¬æ•°ç›®ç¬¦åˆé¢„æœŸï¼Œä¿è¯Podé«˜å¯ç”¨çš„æ ¸å¿ƒç»„ä»¶ï¼Œå¸¸ç”¨äºŽPodçš„ç”Ÿå‘½å‘¨æœŸç®¡ç†



**å·¥ä½œæœºåˆ¶**

- å½“é€šè¿‡"èµ„æºå®šä¹‰æ–‡ä»¶"å®šä¹‰å¥½äº†ä¸€ä¸ªRSèµ„æºå¯¹è±¡ï¼ŒæŠŠå®ƒæäº¤åˆ°Kubernetesé›†ç¾¤
- MasterèŠ‚ç‚¹ä¸Šçš„Controller Managerç»„ä»¶å°±å¾—åˆ°é€šçŸ¥
- Controller Manager æ ¹æ® ReplicaSet Control Loop ç®¡ç† ReplicaSet Object
- ç”±è¯¥å¯¹è±¡å‘API Serverè¯·æ±‚ç®¡ç†Podå¯¹è±¡(æ ‡ç­¾é€‰æ‹©å™¨é€‰å®šçš„ï¼‰
- å¦‚æžœæ²¡æœ‰podï¼šä»¥**Podæ¨¡æ¿**å‘API Serverè¯·æ±‚åˆ›å»ºPodå¯¹è±¡ï¼Œç”±Schedulerè°ƒåº¦å¹¶ç»‘å®šè‡³æŸèŠ‚ç‚¹ï¼Œç”±ç›¸åº”èŠ‚ç‚¹kubeletè´Ÿè´£è¿è¡Œ
- å®šæœŸå·¡æ£€ç³»ç»Ÿä¸­å½“å‰å­˜æ´»çš„Podï¼Œå¹¶ç¡®ä¿Podå®žä¾‹æ•°é‡åˆšåˆ°æ»¡è¶³RCçš„æœŸæœ›å€¼ã€‚
- å¦‚æžœPodæ•°é‡å¤§äºŽRSå®šä¹‰çš„æœŸæœ›å€¼ï¼Œé‚£ä¹ˆå°±æ€æ­»ä¸€äº›Pod
- å¦‚æžœPodæ•°é‡å°äºŽRSå®šä¹‰çš„æœŸæœ›å€¼ï¼Œé‚£ä¹ˆå°±åˆ›å»ºä¸€äº›Pod
- æ‰€ä»¥é€šè¿‡RSèµ„æºå¯¹è±¡ï¼ŒKuberneteså®žçŽ°äº†ä¸šåŠ¡åº”ç”¨é›†ç¾¤çš„é«˜å¯ç”¨æ€§ï¼Œå¤§å¤§å‡å°‘äº†äººå·¥å¹²é¢„ï¼Œæé«˜äº†ç®¡ç† çš„è‡ªåŠ¨åŒ–ã€‚
- å¦‚æžœåŽç»­æƒ³è¦æ‰©å……Podå‰¯æœ¬çš„æ•°é‡ï¼Œå¯ä»¥ç›´æŽ¥ä¿®æ”¹replicasçš„å€¼å³å¯
- å½“å…¶ä¸­ä¸€ä¸ªNodeçš„Podæ„å¤–ç»ˆæ­¢ï¼Œæ ¹æ®RSçš„å®šä¹‰ï¼ŒPodçš„æœŸæœ›å€¼æ˜¯2ï¼Œæ‰€ä»¥ä¼šéšæœºæ‰¾ä¸€ä¸ªNodeç»“ç‚¹é‡æ–° å†åˆ›å»ºä¸€ä¸ªæ–°çš„Podï¼Œæ¥ä¿è¯æ•´ä¸ªé›†ç¾¤ä¸­å§‹ç»ˆå­˜åœ¨ä¸¤ä¸ªPodè¿è¡Œ



![image-20241221153308297](D:\git_repository\cyber_security_learning\markdown_img\image-20241221153308297.png)



æ³¨æ„ï¼š

- åˆ é™¤RSå¹¶ä¸ä¼šå½±å“é€šè¿‡è¯¥RSèµ„æºå¯¹è±¡åˆ›å»ºå¥½çš„Podã€‚
- å¦‚æžœè¦åˆ é™¤æ‰€æœ‰çš„Podé‚£ä¹ˆå¯ä»¥è®¾ç½®RSçš„replicasçš„å€¼ä¸º0ï¼Œç„¶åŽæ›´æ–°è¯¥RSã€‚
- å¦å¤–kubectlæä¾›äº†stopå’Œdeleteå‘½ä»¤æ¥ä¸€æ¬¡æ€§åˆ é™¤RSå’ŒRSæŽ§åˆ¶çš„Podã€‚
- Podæä¾›çš„å¦‚æžœæ— çŠ¶æ€æœåŠ¡ï¼Œä¸ä¼šå½±å“åˆ°å®¢æˆ·çš„è®¿é—®æ•ˆæžœã€‚



RSå¯ä»¥å®žçŽ°åº”ç”¨çš„éƒ¨ç½²ï¼Œæ‰©ç¼©å®¹å’Œå¸è½½ï¼Œä½†ä¸€èˆ¬å¾ˆå°‘å•ç‹¬ä½¿ç”¨ï¼Œå®ƒ**ä¸»è¦æ˜¯è¢«Deploymentè¿™ä¸ªæ›´é«˜å±‚çš„èµ„æºå¯¹è±¡æ‰€ä½¿ç”¨**ï¼Œä»Žè€Œå½¢æˆäº†ä¸€æ•´å¥—Podçš„åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°çš„ç¼–æŽ’æœºåˆ¶ã€‚



#### Replica Set èµ„æºæ¸…å•æ–‡ä»¶ç¤ºä¾‹

```yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: ...                                   # ReplicaSetåç§°ï¼Œç”Ÿæˆçš„Podåç§°ä»¥æ­¤å¤„çš„ReplicaSetåç§°ä¸ºå‰ç¼€+éšæœºå­—ç¬¦
  namespace: ...
spec:
  minReadySeconds <integer>                   # Podå°±ç»ªåŽå¤šå°‘ç§’å†…ï¼ŒPodä»»ä¸€å®¹å™¨æ— crashæ–¹å¯è§†ä¸ºâ€œå°±ç»ªâ€
  replicas <integer>                          # æœŸæœ›çš„Podå‰¯æœ¬æ•°ï¼Œé»˜è®¤ä¸º1
  selector:                                   # æ ‡ç­¾é€‰æ‹©å™¨ï¼Œå¿…é¡»åŒ¹é…templateå­—æ®µä¸­Podæ¨¡ç‰ˆä¸­çš„æ ‡ç­¾
    matchExpressions <[]Object>
    matchLabels <map[string]String>
  template:                                   # podæ¨¡ç‰ˆå¯¹è±¡
    metadata:                                 # podå¯¹è±¡å…ƒæ•°æ®
      labels:                                 # ç”±æ¨¡ç‰ˆåˆ›å»ºå‡ºçš„Podå¯¹è±¡æ‰€æ‹¥æœ‰çš„æ ‡ç­¾ï¼Œå¿…é¡»è¦èƒ½å¤ŸåŒ¹é…å‰é¢å®šä¹‰çš„æ ‡ç­¾é€‰æ‹©å™¨
    spec:                                     # podè§„èŒƒï¼Œæ ¼å¼åŒè‡ªä¸»å¼Pod
```



#### åˆ›å»ºèµ„æºå¯¹è±¡

```yaml
# cat controller-replicaset.yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: controller-replicaset-test
spec:
  minReadySeconds: 0
  replicas: 3
  selector:
    matchLabels:
      app: rs-test
      release: stable
      version: v1.0
  template:
    metadata:
      labels:
        app: rs-test
        release: stable
        version: v1.0
    spec:
      containers:
      - name: rs-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
        
# åˆ›å»º
kubectl apply -f controller-replicaset.yaml

# æŸ¥çœ‹
[root@master1 controller]#kubectl get rs
NAME                         DESIRED   CURRENT   READY   AGE
controller-replicaset-test   3         3         3       50s

[root@master1 controller]#kubectl get pod
NAME                               READY   STATUS    RESTARTS   AGE
controller-replicaset-test-27mmp   1/1     Running   0          57s
controller-replicaset-test-2hf65   1/1     Running   0          57s
controller-replicaset-test-jm29c   1/1     Running   0          57s
pod-label-nginx                    1/1     Running   0          78m
pod-label-nginx2                   1/1     Running   0          50m

```



#### æ‰©å®¹å’Œç¼©å®¹

```yaml
# æ‰©å®¹ï¼šè°ƒæ•´Podå‰¯æœ¬æ•°é‡æ›´å¤š
# æ–¹æ³•1ï¼šä¿®æ”¹æ¸…å•æ–‡ä»¶
[root@master1 controller]#cat controller-replicaset.yaml 
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: controller-replicaset-test
spec:
  minReadySeconds: 0
  replicas: 4                                    # ä¿®æ”¹è¿™é‡Œï¼Œå°†å…¶æ”¹ä¸º4
  selector:
    matchLabels:
      app: rs-test
      release: stable
      version: v1.0
  template:
    metadata:
      labels:
        app: rs-test
        release: stable
        version: v1.0
    spec:
      containers:
      - name: rs-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1

# æŸ¥çœ‹ï¼Œæ•°é‡å˜ä¸º4
[root@master1 controller]#kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
controller-replicaset-test-27mmp   1/1     Running   0          17m
controller-replicaset-test-2hf65   1/1     Running   0          17m
controller-replicaset-test-85dbn   1/1     Running   0          2m11s
controller-replicaset-test-jm29c   1/1     Running   0          17m


# å‘½ä»¤å¼ï¼Œä½¿ç”¨å‘½ä»¤å°†å…¶ç¼©å‡ä¸º3ä¸ª
[root@master1 controller]#kubectl scale --replicas=3 rs/controller-replicaset-test 
replicaset.apps/controller-replicaset-test scaled

# æŸ¥çœ‹
[root@master1 controller]#kubectl get po
NAME                               READY   STATUS    RESTARTS   AGE
controller-replicaset-test-27mmp   1/1     Running   0          18m
controller-replicaset-test-2hf65   1/1     Running   0          18m
controller-replicaset-test-jm29c   1/1     Running   0          18m
```



æ›´æ–°Podé•œåƒç‰ˆæœ¬

```yaml
# å‡çº§é•œåƒç‰ˆæœ¬
# æ–¹æ³•1ï¼šæ¸…å•æ–‡ä»¶
cat controller-replicaset.yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: controller-replicaset-test
spec:
  minReadySeconds: 0
  replicas: 6           # ä¿®æ”¹æ­¤è¡Œï¼ŒåŽŸpodç‰ˆæœ¬ä¸å˜ï¼Œæ–°podçš„ç‰ˆæœ¬å‘ç”Ÿå˜åŒ–ï¼Œæ›´æ–°ä¸ºv0.2
  selector:
    matchLabels:
      app: rs-test
      release: stable
      version: v1.0
  template:
    metadata:
      labels:
        app: rs-test
        release: stable
        version: v1.0
    spec:
      containers:
      - name: rs-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2  # ä¿®æ”¹æ­¤è¡Œ
```



#### Replica Set ç‰ˆæœ¬å‘å¸ƒ

##### æ»šåŠ¨å‘å¸ƒ

```yaml
# å‡†å¤‡service
# cat svc-controller-replicaset.yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-replicaset
spec:
  type: ClusterIP
  selector:
    app: rs-test
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
    
# å‡†å¤‡æ—§ç‰ˆæœ¬çš„replicasetçš„æ¸…å•æ–‡ä»¶
# cat controller-replicaset-1.yaml
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: replicaset-test
spec:
  minReadySeconds: 0
  replicas: 3
  selector:
    matchLabels:
      app: rs-test
      release: stable
      version: v0.1
  template:
    metadata:
      labels:
        app: rs-test
        release: stable
        version: v0.1
    spec:
      containers:
      - name: rs-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1

# å‡†å¤‡æ–°ç‰ˆæœ¬çš„replicasetæ¸…å•æ–‡ä»¶
# cat controller-replicaset-2.yaml
apiVersion: apps/v2
kind: ReplicaSet
metadata:
  name: replicaset-test-2
spec:
  minReadySeconds: 0
  replicas: 0                   # æ³¨æ„æ­¤å¤„ä¸º0
  selector:
    matchLabels:
      app: rs-test
      release: stable
      version: v0.2
  template:
    metadata:
      labels:
        app: rs-test
        release: stable
        version: v0.2
    spec:
      containers:
      - name: rs-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2

# å¯åŠ¨èµ„æº
kubectl apply -f svc-controller-replicaset.yaml
kubectl apply -f controller-replicaset-1.yaml
kubectl apply -f controller-replicaset-2.yaml

# å¯¹æ—§ç‰ˆçš„RSç¼©å®¹ï¼Œå¯¹æ–°ç‰ˆæœ¬çš„RSæ‰©å®¹
[root@master1 controller]# kubectl scale --replicas=2 rs/replicaset-test; kubectl scale --replicas=1 rs/replicaset-test-2
replicaset.apps/replicaset-test scaled
replicaset.apps/replicaset-test-2 scaled

# è§‚å¯Ÿç»“æžœ
[root@master1 controller]#kubectl get pod --show-labels 
NAME                      READY   STATUS    RESTARTS      AGE   LABELS
pod-label-nginx           1/1     Running   1 (55m ago)   27h   app=nginx,version=v1.20.0
pod-label-nginx2          1/1     Running   1 (57m ago)   27h   app=nginx,version=v1.20.0
replicaset-test-2-ffh5j   1/1     Running   0             68s   app=rs-test,release=stable,version=v0.2
replicaset-test-2pbdk     1/1     Running   0             11m   app=rs-test,release=stable,version=v0.1
replicaset-test-v8967     1/1     Running   0             11m   app=rs-test,release=stable,version=v0.1


# å†æ¬¡å¯¹æ—§ç‰ˆçš„RSç¼©å®¹,å¯¹æ–°ç‰ˆæœ¬çš„RSæ‰©å®¹
[root@master1 controller]#kubectl scale --replicas=1 rs/replicaset-test; kubectl scale --replicas=2 rs/replicaset-test-2
replicaset.apps/replicaset-test scaled
replicaset.apps/replicaset-test-2 scaled

#æœ€åŽä¸€æ¬¡å¯¹æ—§ç‰ˆçš„RSç¼©å®¹ä¸º0,å¯¹æ–°ç‰ˆæœ¬çš„RSæ‰©å®¹åˆ°3
[root@master1 ~]#kubectl scale --replicas=0 rs/replicaset-test;kubectl scale -- replicas=3 rs/replicaset-test-2

# ä¸Šè¿°æ‰‹åŠ¨å®žçŽ°æ»šåŠ¨å‡çº§
```



##### è“ç»¿å‘å¸ƒ

```yaml
# cat controller-replicaset-blue-green.yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-replicaset-blue-green
spec:
  type: ClusterIP
  selector:
    app: rs-test
    ctr: rs-${DEPLOY}
    version: ${VERSION}
  ports:
  - name: http
    port: 80
    protocol: TCP
    targetPort: 80
---
apiVersion: apps/v1
kind: ReplicaSet
metadata:
  name: rs-${DEPLOY}
spec:
  minReadySeconds: 3
  replicas: 2
  selector:
    matchLabels:
      app: rs-test
      ctr: rs-${DEPLOY}
      version: ${VERSION}
  template:
    metadata:
      labels:
        app: rs-test
        ctr: rs-${DEPLOY}
        version: ${VERSION}
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:${VERSION}
        
        
# å¼€å¯è“è‰²å‘å¸ƒæ—§ç‰ˆæœ¬
[root@master1 controller]#DEPLOY=blue VERSION=v0.1 envsubst < controller-replicaset-blue-green.yaml |kubectl apply -f -
service/svc-replicaset-blue-green created
replicaset.apps/rs-blue created


# å¼€å¯æµ‹è¯•podè®¿é—®Service
[root@master1 controller]#kubectl run pod-$RANDOM --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --command -- /bin/bash
If you don't see a command prompt, try pressing enter.
root@pod-3326 /# 
root@pod-3326 /# curl svc-replicaset-blue-green
kubernetes pod-test v0.1!! ClientIP: 10.244.2.26, ServerName: rs-blue-qbmlm, ServerIP: 10.244.3.30!
root@pod-3326 /# curl svc-replicaset-blue-green
kubernetes pod-test v0.1!! ClientIP: 10.244.2.26, ServerName: rs-blue-6hkbt, ServerIP: 10.244.1.25!


# åˆ‡æ¢è‡³ç»¿è‰²ç‰ˆæœ¬
[root@master1 ~]#DEPLOY=green VERSION=v0.2 envsubst < ./yaml/controller/controller-replicaset-blue-green.yaml |kubectl apply -f -
service/svc-replicaset-blue-green configured
replicaset.apps/rs-green created

# æ­¤æ—¶åœ¨æµ‹è¯•podä¸Šè¿›è¡Œæµ‹è¯•
root@pod-3326 /# curl svc-replicaset-blue-green
kubernetes pod-test v0.2!! ClientIP: 10.244.2.26, ServerName: rs-green-m5psl, ServerIP: 10.244.3.31!
root@pod-3326 /# curl svc-replicaset-blue-green
kubernetes pod-test v0.2!! ClientIP: 10.244.2.26, ServerName: rs-green-hlmxv, ServerIP: 10.244.1.26!

# å·²æˆåŠŸåˆ‡æ¢è‡³v0.2ï¼Œæ­¤æ—¶å½“å‰k8sä¸Šæœ‰ä¸¤å¥—rs
[root@master1 controller]#kubectl get rs
NAME       DESIRED   CURRENT   READY   AGE
rs-blue    2         2         2       5m20s
rs-green   2         2         2       87s

# ä¸Šè¿°å°±æ˜¯è“ç»¿å‘
```



### Deployment

#### **Deploymentå·¥ä½œæœºåˆ¶**

**Deployment ä»‹ç»**

Deploymentèµ„æºå¯¹è±¡ä¸€èˆ¬ç”¨äºŽéƒ¨ç½²**æ— çŠ¶æ€æœåŠ¡**,æ¯”å¦‚ javaåº”ç”¨ï¼ŒWebç­‰ï¼Œè¿™ä¹Ÿæ˜¯æœ€å¸¸ç”¨çš„æŽ§åˆ¶å™¨

å¯ä»¥ç®¡ç†å¤šä¸ªå‰¯æœ¬çš„Pod, å®žçŽ°æ— ç¼è¿ç§»ã€è‡ªåŠ¨æ‰©å®¹ç¼©å®¹ã€è‡ªåŠ¨ç¾éš¾æ¢å¤ã€ä¸€é”®å›žæ»šç­‰åŠŸèƒ½

**Deploymentç›¸å¯¹äºŽRCæˆ–RSçš„ä¸€ä¸ªæœ€å¤§çš„å‡çº§æ˜¯:æ”¯æŒæ»šåŠ¨å‘å¸ƒç­–ç•¥,å…¶å®ƒåŠŸèƒ½å‡ ä¹Žä¸€æ ·**

Deploymentèµ„æºå¯¹è±¡åœ¨å†…éƒ¨ä½¿ç”¨Replica Setæ¥å®žçŽ°Podçš„è‡ªåŠ¨åŒ–ç¼–æŽ’



**Deploymentå·¥ä½œæµç¨‹**

- åˆ›å»ºDeploymentèµ„æºå¯¹è±¡ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹åº”çš„Replicas Setå¹¶å®ŒæˆPodçš„è‡ªåŠ¨ç®¡ç†ï¼Œè€Œæ— éœ€äººä¸ºæ˜¾ç¤ºåˆ›å»º Replicas Set
- æ£€æŸ¥Deploymentå¯¹è±¡çŠ¶æ€ï¼Œæ£€æŸ¥Podè‡ªåŠ¨ç®¡ç†æ•ˆæžœ
- æ‰©å±•Deploymentèµ„æºå¯¹è±¡ï¼Œä»¥åº”å¯¹åº”ç”¨ä¸šåŠ¡çš„é«˜å¯ç”¨





#### èµ„æºå¯¹è±¡ Deployment å’Œ Replica Set å…³ç³»

**Deployment æœ¬è´¨ä¸Šæ˜¯ä¾èµ–å¹¶è°ƒç”¨ Replica Set çš„å®Œæˆæ¥åŸºæœ¬çš„ç¼–æŽ’åŠŸèƒ½ï¼Œå¹¶é¢å¤–æä¾›äº†æ»šåŠ¨æ›´æ–°ï¼Œå›žæ»šçš„åŠŸèƒ½**

- å…ˆç”±Deployment åˆ›å»º Replica Set èµ„æºå¯¹è±¡å¹¶è¿›è¡Œç¼–æŽ’
- å†ç”±Replica Set åˆ›å»ºå¹¶å¯¹ Pod çš„ç¼–æŽ’
- Deploymentæ˜¯å»ºç«‹åœ¨ReplicaSetæŽ§åˆ¶å™¨ä¸Šå±‚çš„æ›´é«˜çº§çš„æŽ§åˆ¶å™¨
- Deployment ä½äºŽReplicaSetæ›´ä¸Šé¢ä¸€å±‚ï¼ŒåŸºäºŽReplieaSetï¼Œæä¾›äº†æ»šåŠ¨æ›´æ–°ã€å›žæ»šç­‰æ›´ä¸ºå¼ºå¤§çš„ åº”ç”¨ç¼–æŽ’åŠŸèƒ½
- Deploymentæ˜¯ Replica Set çš„ç¼–æŽ’å·¥å…·ï¼ŒDeploymentç¼–æŽ’ReplicaSetï¼ŒReplicaSetç¼–æŽ’Pod
- Replica Setçš„åç§°ç”±Deploymentåç§°-Templateçš„Hashå€¼ç”Ÿæˆ
- **Deployment å¹¶ä¸ç›´æŽ¥ç®¡ç† Pod**ï¼Œå¿…é¡»é—´æŽ¥çš„åˆ©ç”¨ Replica Set æ¥å®Œæˆå¯¹Podçš„ç¼–æŽ’
- é€šå¸¸åº”è¯¥ç›´æŽ¥é€šè¿‡å®šä¹‰Deploymentèµ„æºæ¥ç¼–æŽ’Podåº”ç”¨ï¼Œè€ŒReplicaSetæ— é¡»æ˜¾å¼é…ç½®





#### Deployment çš„èµ„æºå®šä¹‰

Deploymentçš„å®šä¹‰ä¸ŽReplica Setçš„å®šä¹‰ç±»ä¼¼ï¼Œé™¤äº†APIå£°æ˜Žä¸ŽKindç±»åž‹æœ‰æ‰€åŒºåˆ«ï¼Œå…¶ä»–åŸºæœ¬ä¸Šéƒ½ä¸€æ ·ã€‚

![image-20241222191629314](D:\git_repository\cyber_security_learning\markdown_img\image-20241222191629314.png)



**æ³¨æ„ï¼šDeploymentå¯¹æ»šåŠ¨æ›´æ–°å¤šäº†ä¸€äº›æ›´æ–°ç­–ç•¥çš„åŠŸèƒ½**

```yaml
apiVersion: apps/v1                 # APIç¾¤ç»„åŠç‰ˆæœ¬
kind: Deployment                    # èµ„æºç±»åž‹ç‰¹æœ‰æ ‡è¯†
metadata: 
  name: <string>                    # èµ„æºåç§°ï¼Œåœ¨ä½œç”¨åŸŸä¸­è¦å”¯ä¸€ï¼Œç”ŸæˆPodåç§°ï¼šDeployment + Podæ¨¡ç‰ˆHash + éšæœºå­—ç¬¦ä¸²
  namespace: <string>               # åç§°ç©ºé—´ï¼šDeploymentéš¶å±žåç§°ç©ºé—´çº§åˆ«
spec:
  minReadySeconds: <integer>
  replicas: <integer>
  selector: <object>
    matchLabels:
      app: <string>
  template: <object>
  revisionHistoryLimit: <integer>    # æ»šåŠ¨æ›´æ–°åŽ†å²è®°å½•æ•°é‡ï¼Œé»˜è®¤ä¸º10ï¼Œå¦‚æžœä¸º0è¡¨ç¤ºä¸ä¿ç•™åŽ†å²æ•°æ®
  strategy: <object>                 # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    type: <string>                   # æ»šåŠ¨æ›´æ–°ç±»åž‹ï¼Œå¯ç”¨å€¼æœ‰Recreateï¼ˆåˆ é™¤æ‰€æœ‰æ—§POdå†åˆ›å»ºæ–°Podï¼‰å’ŒRollingUpdate     
    rollingUpdate: <Object>          # æ»šåŠ¨æ›´æ–°ç±»åž‹ï¼Œä¸“ç”¨äºŽRollingUpdateç±»åž‹ï¼Œé€æ­¥æ›´æ–°ï¼Œå…ˆåˆ›å»ºæ–°Podå†é€æ­¥åˆ é™¤æ—§Pod
      maxSurge: <string>             # æ›´æ–°æœŸé—´å¯æ¯”æœŸæœ›çš„POdæ•°é‡èƒ½å¤Ÿå¤šå‡ºçš„æœ€å¤§æ•°é‡æˆ–æ¯”ä¾‹
      maxUnavaiLabel: <String>       # æ›´æ–°æœŸé—´å¯æ¯”æœŸæœ›çš„Podæ•°é‡èƒ½å¤Ÿç¼ºå°‘çš„æœ€å¤§æ•°é‡æˆ–æ¯”ä¾‹
  progressDeadlineSeconds: <integer> # æ»šåŠ¨æ›´æ–°æ•…éšœè¶…æ—¶æ—¶é•¿ï¼Œé»˜è®¤ä¸º600ç§’
  paused: <boolean>                  # æ˜¯å¦æš‚åœéƒ¨ç½²è¿‡ç¨‹
```





#### Deploymentå®žçŽ°



**å‘½ä»¤è¡Œåˆ›å»ºå¯¹è±¡**

```bash
kubectl create deployment NAME --image=image -- [COMMAND] [args...] [options]
```



**ç¤ºä¾‹**

```bash
# åˆ›å»ºå‘½ä»¤
kubectl create deployment deployment-pod-test --image=wangxiaochun/pod-test:v0.1 --replicas=3

# æŸ¥çœ‹æ•ˆæžœ
[root@master1 controller]#kubectl get all
NAME                                       READY   STATUS    RESTARTS       AGE
pod/deployment-pod-test-587f5cfffb-btv2w   1/1     Running   0              36s
pod/deployment-pod-test-587f5cfffb-cbkrn   1/1     Running   0              36s
pod/deployment-pod-test-587f5cfffb-ctjvc   1/1     Running   0              36s
......

NAME                                  READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deployment-pod-test   3/3     3            3           36s

NAME                                             DESIRED   CURRENT   READY   AGE
replicaset.apps/deployment-pod-test-587f5cfffb   3         3         3       36s

# æ³¨æ„:åˆ›å»ºdeploymentä¼šè‡ªåŠ¨åˆ›å»ºç›¸åº”çš„RSå’ŒPOD
# RSçš„åç§°=deploymentåç§°+template_hashå€¼
# Podçš„åç§°=deploymentåç§°+replcaset_id+pod_id


# ä½¿ç”¨å‘½ä»¤æŸ¥çœ‹èµ„æºå¯¹è±¡æ ¼å¼
[root@master1 controller]# kubectl create deployment myapp --image registry.cn- beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas 3 --dry-run=client -o yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  creationTimestamp: null
  labels:
    app: myapp
  name: myapp
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  strategy: {}
  template:
    metadata:
      creationTimestamp: null
      labels:
        app: myapp
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
        name: pod-test
        resources: {}
status: {}
```



**èµ„æºå®šä¹‰æ–‡ä»¶åˆ›å»ºå¯¹è±¡**

ç¤ºä¾‹

```yaml
# cat controller-deployment-test.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-test
spec:
  replicas: 3
  selector: 
    matchLabels:
      app: rs-test
  template:
    metadata:
      labels:
        app: rs-test
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
        
# å¯åŠ¨èµ„æºæ¸…å•
[root@master1 controller]#kubectl apply -f controller-deployment-test.yaml 
deployment.apps/deployment-test created

# æŸ¥çœ‹
[root@master1 controller]#kubectl get deploy
NAME              READY   UP-TO-DATE   AVAILABLE   AGE
deployment-test   3/3     3            3           53s

# è‡ªåŠ¨ç”Ÿæˆrs
[root@master1 controller]#kubectl get rs
NAME                         DESIRED   CURRENT   READY   AGE
deployment-test-65495d86f9   3         3         3       95s

# åªè¦templateæ¨¡ç‰ˆå†…å®¹å˜é‡ï¼Œå°±ä¼šç”Ÿæˆæ–°çš„rsï¼Œå› ä¸ºhashå€¼ä¼šå˜
[root@master1 controller]#cat controller-deployment-test.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-test
spec:
  replicas: 3
  selector: 
    matchLabels:
      app: rs-test
  template:
    metadata:
      labels:
        app: rs-test
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2        # è¿™é‡Œæ”¹ä¸ºv0.2
      
# æŸ¥çœ‹ï¼šå¯ä»¥çœ‹åˆ°2ä¸ªrs      
[root@master1 controller]#kubectl get rs
NAME                         DESIRED   CURRENT   READY   AGE
deployment-test-65495d86f9   0         0         0       10m
deployment-test-79f667698b   3         3         3       18s
```



![image-20241222202019431](D:\git_repository\cyber_security_learning\markdown_img\image-20241222202019431.png)





#### Deploymentå®žçŽ°æ‰©å®¹ç¼©å®¹

**åŸºäºŽDeploymentè°ƒæ•´Podæœ‰ä¸¤ç§æ–¹æ³•**

```bash
# åŸºäºŽèµ„æºå¯¹è±¡è°ƒæ•´
kubectl scale  [--current-replicas=<å½“å‰å‰¯æœ¬æ•°>] --replicas=<æ–°å‰¯æœ¬æ•°> deployment/deploy_name

# åŸºäºŽèµ„æºæ–‡ä»¶è°ƒæ•´
kubectl scale --replicas=<æ–°å‰¯æœ¬æ•°> -f deploy_name.yaml
```



ç¤ºä¾‹

```bash
[root@master1 controller]#kubectl scale deployment deployment-test --replicas=5
deployment.apps/deployment-test scaled

[root@master1 controller]#kubectl get pod
NAME                               READY   STATUS    RESTARTS       AGE
deployment-test-65495d86f9-4sl7h   1/1     Running   0              2s
deployment-test-65495d86f9-kk28x   1/1     Running   0              3m33s
deployment-test-65495d86f9-qr2mr   1/1     Running   0              3m30s
deployment-test-65495d86f9-rfspr   1/1     Running   0              2s
deployment-test-65495d86f9-tl7sp   1/1     Running   0              3m32s
pod-label-nginx                    1/1     Running   1 (167m ago)   29h
pod-label-nginx2                   1/1     Running   1 (169m ago)   29h
```



#### DeploymentåŠ¨æ€æ›´æ–°å›žæ»š

##### å‘½ä»¤ä»‹ç»

```bash
# æ›´æ–°å‘½ä»¤1
kubectl set SUBCOMMAND [options] èµ„æºç±»åž‹ èµ„æºåç§°
SUBCOMMANDï¼šå­å‘½ä»¤ï¼Œå¸¸ç”¨çš„å­å‘½ä»¤å°±æ˜¯image

# å‚æ•°è¯¦è§£
--record=true       # æ›´æ”¹æ—¶ï¼Œä¼šå°†ä¿¡æ¯å¢žåŠ åˆ°åŽ†å²è®°å½•ä¸­

#æ›´æ–°å‘½ä»¤2ï¼šï¼ˆç”¨çš„å¾ˆå°‘ï¼‰
kubectl patch (-f FILENAME | TYPE NAME) -p PATCH [options]

#å‚æ•°è¯¦è§£ï¼š
--patch='' #è®¾å®šå¯¹è±¡å±žæ€§å†…å®¹

#å›žæ»šå‘½ä»¤ï¼š
kubectl rollout SUBCOMMAND [options] èµ„æºç±»åž‹ èµ„æºåç§°

SUBCOMMAND å­å‘½ä»¤ï¼š
history         #æ˜¾ç¤º rollout åŽ†å²,é»˜è®¤åªä¿ç•™æœ€è¿‘çš„10ä¸ªç‰ˆæœ¬
pause           #æ ‡è®°resourceä¸ºä¸­æ­¢çŠ¶æ€ï¼Œé…åˆresumeå¯å®žçŽ°ç°åº¦å‘å¸ƒï¼Œpauseç›®å‰ä»…æ”¯æŒdeployment,å¯é…åˆkubectl setå®žçŽ°æ‰¹é‡æ›´æ–°
restart         #é‡å¯ä¸€ä¸ª resource
resume          #ç»§ç»­ä¸€ä¸ªåœæ­¢çš„ resource
status          #æ˜¾ç¤º rollout çš„çŠ¶æ€
undo            #æ’¤é”€ä¸Šä¸€æ¬¡çš„ rollout
--revision=n    #æŸ¥çœ‹æŒ‡å®šç‰ˆæœ¬çš„è¯¦ç»†ä¿¡æ¯
--to-revision=0 #rollbackè‡³æŒ‡å®šç‰ˆæœ¬,é»˜è®¤ä¸º0,è¡¨ç¤ºå‰ä¸€ä¸ªç‰ˆæœ¬
```



##### æ¡ˆä¾‹ï¼šå‘½ä»¤å¼æ›´æ–°å’Œå›žæ»š

```bash
# åˆ›å»ºdeployment
[root@master1 controller]# kubectl create deployment nginx --image registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.18.0
deployment.apps/nginx created


# ä¿®æ”¹ç‰ˆæœ¬ä¸¤ç§æ ¼å¼
#kubectl set image deployment/nginx nginx='registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0' --record=true

# æŸ¥çœ‹åŽ†å²kubectl rollout history
[root@master1 controller]#kubectl rollout history deployment nginx
deployment.apps/nginx 
REVISION  CHANGE-CAUSE
1         <none>
2         kubectl set image deployment/nginx nginx=registry.cnbeijing.aliyuncs.com/wangxiaochun/nginx:1.20.0 --record=true

# æ’¤é”€/å›žé€€ä¸Šæ¬¡çš„æ›´æ”¹ï¼šæ³¨æ„ï¼šåªèƒ½å›žé€€ä¸€æ¬¡
kubectl rollout undo deployment nginx

# å›žé€€åˆ°æŒ‡å®šç‰ˆæœ¬
kubectl rollout undo --to-revision=2 deployment nginx
```



##### æ¡ˆä¾‹: åŸºäºŽå£°æ˜Žæ¸…å•æ–‡ä»¶å®žçŽ°å‡çº§å’Œé™çº§

```yaml
# cat controller-deployment-test.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-test
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rs-test
  template:
    metadata:
      labels:
        app: rs-test
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2        # ç›´æŽ¥æ”¹è¿™é‡Œ

# å®Œæˆå‡çº§
kubectl apply -f controller-deployment-test.yaml
```



##### æ‰¹é‡æ›´æ–°

é»˜è®¤åªæ›´æ”¹ä¸€æ¬¡å°±ä¼šè§¦å‘é‡æ–°ç”Ÿæˆæ–°Podå¯èƒ½ä¼šå½±å“ä¸šåŠ¡çš„ç¨³å®š,å¯ä»¥å°†å¤šæ¬¡æ‰¹é‡æ›´æ–°åˆå¹¶ä¸ºåªè§¦å‘ä¸€æ¬¡ é‡æ–°åˆ›å»ºPod,ä»Žè€Œä¿è¯ä¸šåŠ¡çš„ç¨³å®š

```bash
# æš‚åœæ›´æ–°
kubectl rollout pause deployment pod-test

# ç¬¬ä¸€æ¬¡æ›´æ”¹
kubectl set image deployment pod-test pod-test=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2 --record

# ç¬¬äºŒæ¬¡æ›´æ”¹
kubectl set resources deployment nginx --limits=cpu=200m,memory=128Mi --requests=cpu=100m,memory=64Mi


# æ¢å¤æ‰¹é‡æ›´æ–°
kubectl rollout resume deployment nginx
```





#### Deploymentæ»šåŠ¨æ›´æ–°ç­–ç•¥

Deployment æŽ§åˆ¶å™¨æ”¯æŒä¸¤ç§æ›´æ–°ç­–ç•¥

- **é‡å»ºå¼æ›´æ–° recreate**
  - å½“ä½¿ç”¨Recreateç­–ç•¥æ—¶ï¼ŒDeploymentä¼šç›´æŽ¥**åˆ é™¤å…¨éƒ¨çš„æ—§çš„Pod**ï¼Œç„¶åŽåˆ›å»ºæ–°çš„Podã€‚
  - è¿™æ„å‘³ç€åœ¨éƒ¨ç½²æ–°ç‰ˆæœ¬æ—¶ï¼Œæ•´ä¸ªåº”ç”¨ä¼šåœæ­¢æœåŠ¡ä¸€æ®µæ—¶é—´ï¼Œç›´åˆ°æ‰€æœ‰æ—§çš„Podéƒ½è¢«åˆ é™¤å¹¶ä¸”æ–°çš„ Podè¢«åˆ›å»ºå¹¶è¿è¡Œèµ·æ¥ã€‚
  - è¿™å¯èƒ½ä¼šå¯¼è‡´ä¸€æ®µæ—¶é—´å†…çš„æœåŠ¡ä¸­æ–­ï¼Œå› ä¸ºæ—§ç‰ˆæœ¬çš„Podè¢«ç›´æŽ¥æ›¿æ¢æŽ‰äº†ã€‚
  - **æ­¤æ–¹å¼å¯ä»¥é˜²æ­¢ç«¯å£å†²çª**

- **æ»šåŠ¨å¼æ›´æ–° rolling updates** 
  - æ­¤ä¸ºé»˜è®¤ç­–ç•¥
  - RollingUpdateç­–ç•¥å…è®¸åœ¨éƒ¨ç½²æ–°ç‰ˆæœ¬æ—¶é€æ­¥æ›´æ–°Podã€‚
  - å®ƒä¼šå…ˆåˆ›å»ºæ–°ç‰ˆæœ¬çš„Podï¼Œç„¶åŽé€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„Podï¼Œç›´åˆ°æ‰€æœ‰Podéƒ½å·²ç»æ›´æ–°ä¸ºæ–°ç‰ˆæœ¬ã€‚
  - è¿™ç§æ–¹å¼å¯ä»¥ç¡®ä¿åº”ç”¨ä¸€ç›´å¤„äºŽå¯ç”¨çŠ¶æ€ï¼Œå› ä¸ºåœ¨æ•´ä¸ªæ›´æ–°è¿‡ç¨‹ä¸­ï¼Œè‡³å°‘æœ‰ä¸€éƒ¨åˆ†Podä¸€ç›´åœ¨è¿è¡Œã€‚
  - é€æ‰¹æ¬¡æ›´æ–°Podçš„æ–¹å¼ï¼Œæ”¯æŒæŒ‰ç™¾åˆ†æ¯”æˆ–å…·ä½“çš„æ•°é‡å®šä¹‰æ‰¹æ¬¡è§„æ¨¡
  - è§¦å‘æ¡ä»¶:
    - **podTemplateçš„hashç **å˜åŠ¨ï¼Œå³ä»…podTemplateçš„é…ç½®å˜åŠ¨æ‰ä¼šå¯¼è‡´hashç æ”¹å˜
    - replicaså’Œselectorçš„å˜æ›´ä¸ä¼šå¯¼è‡´podTemplateçš„hashå˜åŠ¨



**å­˜åœ¨çš„é—®é¢˜**:å¿…é¡»ä»¥Podä¸ºæœ€å°å•ä½æ¥è°ƒæ•´è§„æ¨¡æ¯”ä¾‹ï¼Œè€Œæ— æ³•å®žçŽ°æµé‡è·¯ç”±æ¯”ä¾‹çš„æŽ§åˆ¶ï¼Œæ¯”å¦‚: å…±3ä¸ªPod å®žçŽ°20%æµé‡æ¯”ä¾‹

è¦å®žçŽ°æµé‡è·¯ç”±æ¯”ä¾‹çš„æŽ§åˆ¶ï¼Œå°±éœ€è¦ä½¿ç”¨æ›´é«˜çº§çš„å·¥å…·æ¯”å¦‚: Ingress æ‰èƒ½å®žçŽ°



**å±žæ€§è§£æž**

```bash
kubectl explain deployment.spec.strategy

type <string> #ä¸»è¦æœ‰ä¸¤ç§ç±»åž‹ï¼š"Recreate"ã€"RollingUpdate-é»˜è®¤"
Recreate            #é‡å»º,å…ˆåˆ é™¤æ—§Pod,å†åˆ›å»ºæ–°Pod,æ¯”å¦‚å¯ä»¥é˜²æ­¢ç«¯å£å†²çª

kubectl explain deployment.spec.strategy.rollingUpdate
rollingUpdate       <Object>
 maxSurge   <string>#æ›´æ–°æ—¶å…è®¸è¶…è¿‡æœŸæœ›å€¼çš„æœ€å¤§Podæ•°é‡æˆ–ç™¾åˆ†æ¯”,é»˜è®¤ä¸º25%,å¦‚æžœä¸º0,è¡¨ç¤ºå…ˆå‡,å†åŠ ï¼Œæ­¤æ—¶maxUnavaibleä¸èƒ½ä¸º0
 maxUnavailabel <string> #æ›´æ–°æ—¶å…è®¸æœ€å¤§å¤šå°‘ä¸ªæˆ–ç™¾åˆ†æ¯”çš„Podä¸å¯ç”¨,é»˜è®¤ä¸º25%,å¦‚æžœä¸º0,è¡¨ç¤ºå…ˆåŠ åŽå‡ï¼Œæ­¤æ—¶maxSurgeä¸èƒ½ä¸º0
#å¦‚æžœmaxSurgeä¸ºæ­£æ•´æ•°, maxUnavailabelä¸º0,è¡¨ç¤ºå…ˆæ·»åŠ æ–°ç‰ˆæœ¬çš„Pod,å†åˆ é™¤æ—§ç‰ˆæœ¬çš„Podï¼Œå³å…ˆåŠ å†å‡
#å¦‚æžœmaxSurgeä¸º0, maxUnavaiLabelä¸ºæ­£æ•´æ•°,è¡¨ç¤ºå…ˆåˆ é™¤æ—§ç‰ˆæœ¬çš„Pod,å†æ·»åŠ æ–°ç‰ˆæœ¬çš„Podï¼Œå³å…ˆå‡å†åŠ 
#å¦‚æžœmaxSurgeä¸º100%ï¼ŒmaxUnavaiLabelä¸º100%ï¼Œå®žçŽ°è“ç»¿å‘å¸ƒï¼Œæ³¨æ„ï¼šèµ„æºè¦è¶³å¤Ÿ
```



| å±žæ€§            | è§£æž                                                         |
| --------------- | ------------------------------------------------------------ |
| minReadySeconds | Kubernetesåœ¨ç­‰å¾…è®¾ç½®çš„æ—¶é—´åŽæ‰è¿›è¡Œå‡çº§<br />å¦‚æžœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼ŒKubernetesä¼šå‡è®¾è¯¥å®¹å™¨å¯åŠ¨èµ·æ¥åŽå°±æä¾›æœåŠ¡äº†<br />å¦‚æžœæ²¡æœ‰è®¾ç½®è¯¥å€¼ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½ä¼šé€ æˆæœåŠ¡ä¸æ­£å¸¸è¿è¡Œ |
| maxSurge        | å‡çº§è¿‡ç¨‹ä¸­Podæœ€å¤šå¯æ¯”é¢„æœŸå€¼å¤šå‡ºçš„Podæ•°é‡ï¼Œå…¶å€¼å¯ä»¥æ˜¯0æˆ–æ­£æ•´æ•°,æˆ– è€…ç›¸å¯¹é¢„æœŸå€¼çš„ç™¾åˆ†æ¯”<br />é»˜è®¤æ˜¯25%<br />ä¾‹å¦‚ï¼šmaxSurage=1ï¼Œreplicas=5,åˆ™è¡¨ç¤ºKubernetesä¼šå…ˆå¯åŠ¨1ä¸€ä¸ªæ–°çš„ PodåŽæ‰åˆ æŽ‰ä¸€ä¸ªæ—§çš„PODï¼Œæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰5+1ä¸ªPodã€‚ |
| maxUnavailabel  | å‡çº§è¿‡ç¨‹ä¸­æœ€å¤šæœ‰å¤šå°‘ä¸ªPodå¤„äºŽæ— æ³•æä¾›æœåŠ¡çš„çŠ¶æ€<br />é»˜è®¤æ˜¯25%<br />å½“maxSurgeä¸ä¸º0æ—¶ï¼Œè¯¥å€¼ä¹Ÿä¸èƒ½ä¸º0<br />ä¾‹å¦‚ï¼šmaxUnavaible=1ï¼Œåˆ™è¡¨ç¤ºKubernetesæ•´ä¸ªå‡çº§è¿‡ç¨‹ä¸­æœ€å¤šä¼šæœ‰1ä¸ª PODå¤„äºŽæ— æ³•æœåŠ¡çš„çŠ¶æ€ã€‚ |



**èµ„æºæ¸…å•æ–‡ä»¶åŸºæœ¬æ ·å¼**

```yaml
#åŸºæœ¬å±žæ€§æ ·å¼ï¼š
minReadySeconds: 5
strategy:
 type: RollingUpdate
 rollingUpdate:
   maxSurge: 1
   maxUnavaiLabel: 1
```





##### æ¡ˆä¾‹ï¼šå®šåˆ¶æ»šåŠ¨æ›´æ–°æ–‡ä»¶

```yaml
# cat controller-deployment-rollupdate.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-rolling-update
spec:
  replicas: 6
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      containers:
      - name: pod-rolling-update
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    minReadySeconds: 5
    strategy:
      type: RollingUpdate
      rollingUpdate:
        maxSurge: 1
        maxUnavailable: 1
# å±žæ€§è§£æž
minReadySeconds: 5 #è¡¨ç¤ºåœ¨æ›´æ–°çš„æ—¶å€™ï¼Œéœ€è¦å…ˆç­‰å¾…5ç§’ï¼Œè€Œä¸æ˜¯ä¸€æ—¦å‘ç”Ÿå˜åŒ–å°±æ»šåŠ¨æ›´æ–°
maxSurge: 1 #å®šä¹‰äº†åœ¨æ›´æ–°æœŸé—´å…è®¸è¶…è¿‡æœŸæœ›æ•°é‡çš„ Pod å®žä¾‹,æ­¤å¤„è¡¨ç¤ºå…è®¸è¶…è¿‡æœŸæœ›æ•°é‡çš„ä¸€ä¸ªé¢å¤–çš„ Pod å®žä¾‹ã€‚
maxUnavaiLabel: 1 #å®šä¹‰äº†åœ¨æ›´æ–°æœŸé—´å…è®¸ä¸å¯ç”¨çš„æœ€å¤§ Pod æ•°é‡ã€‚æ­¤å¤„è¡¨ç¤ºåœ¨æ›´æ–°æœŸé—´å…è®¸æœ€å¤šä¸€ä¸ª Pod ä¸å¯ç”¨ã€‚
```



##### æ¡ˆä¾‹ï¼šé‡‘ä¸é›€å‘å¸ƒ

```yaml
# cat controller-deployment-rollupdate-canary.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-rolling-update-canary
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      containers:
      - name: pod-rolling-update-canary
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1         # å…ˆåŠ åŽå‡
      maxUnavailable: 0
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: pod-test
  name: pod-test
spec:
  ports:
  - name: "80"
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: pod-test
  type: ClusterIP
 
 
# å¯åŠ¨èµ„æºæ¸…å•
[root@master1 controller] # kubectl apply -f controller-deployment-rollupdate-canary.yaml 
deployment.apps/deployment-rolling-update-canary created
service/pod-test created

# å½“å‰çŠ¶æ€
[root@master1 controller] # kubectl get pod
NAME                                                READY   STATUS    RESTARTS        AGE
deployment-rolling-update-canary-6794cd6c97-6ljcw   1/1     Running   0               45s
deployment-rolling-update-canary-6794cd6c97-dmsgg   1/1     Running   0               45s
deployment-rolling-update-canary-6794cd6c97-xmjnh   1/1     Running   0               45s

# å‡çº§ç‰ˆæœ¬
[root@master1 controller]#sed -i 's/pod-test:v0.1/pod-test:v0.2/' controller-deployment-rollupdate-canary.yaml

# é‡‘ä¸é›€å‘å¸ƒ
[root@master1 controller] # kubectl apply -f controller-deployment-rollupdate-canary.yaml && kubectl rollout pause deployment deployment-rolling-update-canary
deployment.apps/deployment-rolling-update-canary configured
service/pod-test unchanged
deployment.apps/deployment-rolling-update-canary paused
[root@master1 controller] # kubectl get pod
NAME                                                READY   STATUS    RESTARTS        AGE
deployment-rolling-update-canary-65687cb7cb-b9ghp   1/1     Running   0               4s
deployment-rolling-update-canary-6794cd6c97-6ljcw   1/1     Running   0               3m34s
deployment-rolling-update-canary-6794cd6c97-dmsgg   1/1     Running   0               3m34s
deployment-rolling-update-canary-6794cd6c97-xmjnh   1/1     Running   0               3m34s

# æ›´æ–°
[root@master1 controller] # kubectl rollout status deployment deployment-rolling-update-canary 
Waiting for deployment "deployment-rolling-update-canary" rollout to finish: 1 out of 3 new replicas have been updated...

# è§‚å¯Ÿ
[root@master1 ~]#while true;do curl 10.103.158.212; sleep 1;done
87cb7cb-b9ghp, ServerIP: 10.244.3.41!
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-6794cd6c97-6ljcw, ServerIP: 10.244.3.40!
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-6794cd6c97-6ljcw, ServerIP: 10.244.3.40!
kubernetes pod-test v0.2!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-65687cb7cb-b9ghp, ServerIP: 10.244.3.41!
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-6794cd6c97-dmsgg, ServerIP: 10.244.2.32!
kubernetes pod-test v0.2!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-65687cb7cb-b9ghp, ServerIP: 10.244.3.41!
kubernetes pod-test v0.2!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-65687cb7cb-b9ghp, ServerIP: 10.244.3.41!
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: deployment-rolling-update-canary-6794cd6c97-6ljcw, ServerIP: 10.244.3.40!


# ç¡®ä¿¡æ²¡é—®é¢˜ä¹‹åŽï¼Œç»§ç»­å®Œæˆä¸€éƒ¨åˆ†æ›´æ–°
[root@master1 controller] # kubectl rollout resume deployment deployment-rolling-update-canary && kubectl rollout pause deployment deployment-rolling-update-canary
deployment.apps/deployment-rolling-update-canary resumed
deployment.apps/deployment-rolling-update-canary paused
```



##### æ¡ˆä¾‹ï¼š**æ¨¡æ‹Ÿè“ç»¿å‘å¸ƒ**

```yaml
# cat controller-deployment-rollupdate-bluegreen.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-rolling-update-bluegreen
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      containers:
      - name: pod-rolling-update-bluegreen
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 100%
      maxUnavailable: 100%
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: pod-test
  name: pod-test
spec:
  ports:
  - name: "80"
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: pod-test
  type: ClusterIP
  
  
# å¯åŠ¨èµ„æºæ¸…å•
[root@master1 controller]#kubectl apply -f controller-deployment-rollupdate-bluegreen.yaml 
deployment.apps/deployment-rolling-update-bluegreen created
service/pod-test unchanged

# æŸ¥çœ‹
[root@master1 controller]#kubectl get pod
NAME                                                   READY   STATUS    RESTARTS        AGE
deployment-rolling-update-bluegreen-854d466b88-d2fk4   1/1     Running   0               4s
deployment-rolling-update-bluegreen-854d466b88-dmpfg   1/1     Running   0               4s
deployment-rolling-update-bluegreen-854d466b88-nmkc4   1/1     Running   0               4s

# ä¿®æ”¹ç‰ˆæœ¬
[root@master1 controller]#sed -i 's/pod-test:v0.1/pod-test:v0.2/' controller-deployment-rollupdate-bluegreen.yaml 

# å¯åŠ¨å¹¶è§‚å¯Ÿç»“æžœ
[root@master1 controller]#kubectl apply -f controller-deployment-rollupdate-bluegreen.yaml 
deployment.apps/deployment-rolling-update-bluegreen configured
service/pod-test unchanged

# å…¨éƒ¨åˆ é™¤ï¼Œå…¨éƒ¨æ¢æˆæ–°ç‰ˆæœ¬
[root@master1 controller]#kubectl get pod
NAME                                                   READY   STATUS        RESTARTS        AGE
deployment-rolling-update-bluegreen-5dcf45995c-6srwf   1/1     Running       0               6s
deployment-rolling-update-bluegreen-5dcf45995c-bmcr7   1/1     Running       0               6s
deployment-rolling-update-bluegreen-5dcf45995c-xr5ds   1/1     Running       0               6s
deployment-rolling-update-bluegreen-854d466b88-d2fk4   1/1     Terminating   0               115s
deployment-rolling-update-bluegreen-854d466b88-dmpfg   1/1     Terminating   0               115s
deployment-rolling-update-bluegreen-854d466b88-nmkc4   1/1     Terminating   0               115

# å›žé€€
[root@master1 controller]#kubectl rollout undo deployment deployment-rolling-update-bluegreen 
deployment.apps/deployment-rolling-update-bluegreen rolled back

# æŸ¥çœ‹çŠ¶æ€
[root@master1 controller]#kubectl get pod
NAME                                                   READY   STATUS        RESTARTS        AGE
deployment-rolling-update-bluegreen-5dcf45995c-6srwf   1/1     Terminating   0               70s
deployment-rolling-update-bluegreen-5dcf45995c-bmcr7   1/1     Terminating   0               70s
deployment-rolling-update-bluegreen-5dcf45995c-xr5ds   1/1     Terminating   0               70s
deployment-rolling-update-bluegreen-854d466b88-b2nmw   1/1     Running       0               2s
deployment-rolling-update-bluegreen-854d466b88-nvprx   1/1     Running       0               2s
deployment-rolling-update-bluegreen-854d466b88-rq7nw   1/1     Running       0               2s
```





### DaemonSet



![image-20241223092340014](D:\git_repository\cyber_security_learning\markdown_img\image-20241223092340014.png)



æœ‰äº›æƒ…å†µä¸‹ï¼Œ**éœ€è¦åœ¨æ‰€æœ‰èŠ‚ç‚¹éƒ½è¿è¡Œä¸€ä¸ªPod**ï¼Œå› ä¸ºNodeæ•°é‡ä¼šå˜åŒ–ï¼Œæ‰€ä»¥æŒ‡å®šPodçš„å‰¯æœ¬æ•°å°±ä¸åˆé€‚ äº†

DaemonSetèƒ½å¤Ÿè®©æ‰€æœ‰ï¼ˆæˆ–è€…ç‰¹å®šï¼‰çš„èŠ‚ç‚¹"ç²¾ç¡®çš„"è¿è¡ŒåŒä¸€ä¸ªpod

å½“èŠ‚ç‚¹åŠ å…¥åˆ°kubernetesé›†ç¾¤ä¸­ï¼ŒPodä¼šè¢«DaemonSet æŽ§åˆ¶å™¨è°ƒåº¦åˆ°è¯¥èŠ‚ç‚¹ä¸Šè¿è¡Œ

å½“èŠ‚ç‚¹ä»ŽKubrenetesé›†ç¾¤ä¸­è¢«ç§»é™¤ï¼Œè¢«DaemonSetè°ƒåº¦çš„podä¹Ÿä¼šè¢«ç§»é™¤

å¦‚æžœåˆ é™¤DaemonSetï¼Œæ‰€æœ‰è·Ÿè¿™ä¸ªDaemonSetç›¸å…³çš„podséƒ½ä¼šè¢«åˆ é™¤

åœ¨æŸç§ç¨‹åº¦ä¸Šï¼ŒDaemonSetæ‰¿æ‹…äº†RSçš„éƒ¨åˆ†åŠŸèƒ½ï¼Œå®ƒä¹Ÿèƒ½ä¿è¯ç›¸å…³podsæŒç»­è¿è¡Œ



**DaemonSet çš„ä¸€äº›å…¸åž‹ç”¨æ³•**

- åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œé›†ç¾¤å®ˆæŠ¤è¿›ç¨‹
- åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ—¥å¿—æ”¶é›†å®ˆæŠ¤è¿›ç¨‹
- åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œç›‘æŽ§å®ˆæŠ¤è¿›ç¨‹



**å¸¸ç”¨äºŽåŽå°æ”¯æ’‘æœåŠ¡**

- Kubernetesé›†ç¾¤çš„ç³»ç»Ÿçº§åº”ç”¨: kube-proxy,flannel,calico
- é›†ç¾¤å­˜å‚¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå¦‚ï¼šcephï¼Œglusterd
- æ—¥å¿—æ”¶é›†æœåŠ¡ï¼Œå¦‚ï¼šfluentdï¼Œlogstash
- ç›‘æŽ§æœåŠ¡ï¼Œå¦‚ï¼šPrometheusï¼Œcollectd
- æš´éœ²æœåŠ¡: å¦‚: Ingress nginx



DaemonSetå±žæ€§è§£æž

```yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: <string>
  namespace: <string>
spec:
  minReadySeconds: <integer>
  selector: <object>
  template: <object>
  revisionHistoryLimit: <integer>
  updateStrategy: <object>          # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    type: <string>                  # æ»šåŠ¨æ›´æ–°ç±»åž‹ï¼ŒOnDelete(åˆ é™¤æ—¶æ›´æ–°ï¼Œæ‰‹åŠ¨è§¦å‘)å’ŒRollingUpdate(é»˜è®¤å€¼ï¼Œæ»šåŠ¨æ›´æ–°)
    rollingUpdate: <object>
      maxSurge
      maxUnavailable: <string>
```



å®˜æ–¹ç¤ºä¾‹

```yaml
#https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/daemonset/
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: fluentd-elasticsearch
  namespace: kube-system
  labels:
    k8s-app: fluentd-logging
spec:
  selector:
    matchLabels:
      name: fluentd-elasticsearch
  template:
    metadata:
      labels:
        name: fluentd-elasticsearch
    spec:
      tolerations:
      # è¿™äº›å®¹å¿åº¦è®¾ç½®æ˜¯ä¸ºäº†è®©è¯¥å®ˆæŠ¤è¿›ç¨‹é›†åœ¨æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹ä¸Šè¿è¡Œ
      # å¦‚æžœä½ ä¸å¸Œæœ›è‡ªå·±çš„æŽ§åˆ¶å¹³é¢èŠ‚ç‚¹è¿è¡ŒPodï¼Œå¯ä»¥åˆ é™¤å®ƒä»¬
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule
      containers:
      - name: fluentd-elasticsearch
        image: quay.io/fluentd_elasticsearch/fluentd:v2.5.2
        resources:
          limits:
            memory: 200Mi
          requests:
            cpu: 100m
            memory: 200Mi
        volumeMounts:
        - name: varlog
          mountPath: /var/log
      terminationGracePeriodSeconds: 30
      volumes:
      - name: varlog
        hostPath:
          path: /var/log
```





**æŸ¥çœ‹å½“å‰æ‰€æœ‰åç§°ç©ºé—´å†…çš„DaemonSet**

```bash
kubectl get ds -A    # -Aè¡¨ç¤ºæ‰€æœ‰åç§°ç©ºé—´
```



##### DaemonSetæ¡ˆä¾‹

```yaml
# cat controller-daemonset-test.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: controller-daemonset-test
spec:
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      # hostNetwork: true #ä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œå’Œç«¯å£,å¯ä»¥é€šè¿‡å®¿ä¸»æœºç›´æŽ¥è®¿é—®Pod,æ€§èƒ½å¥½,ä½†è¦é˜²æ­¢ç«¯å£å†²çª
      #hostPID: true #ç›´æŽ¥ä½¿ç”¨å®¿ä¸»æœºçš„PID
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1


# æŸ¥çœ‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹æœ‰ä¸€ä¸ª
[root@master1 controller]#kubectl get pod -o wide
NAME                                                   READY   STATUS    RESTARTS      AGE   IP            NODE    NOMINATED NODE   READINESS GATES
controller-daemonset-test-hb2w4                        1/1     Running   0             16s   10.244.2.41   node2   <none>           <none>
controller-daemonset-test-q5zgl                        1/1     Running   0             16s   10.244.3.48   node3   <none>           <none>
controller-daemonset-test-wz55z                        1/1     Running   0             16s   10.244.1.43   node1   <none>           <none>

# daemonsetå¯¹è±¡ä¹Ÿæ”¯æŒæ»šåŠ¨æ›´æ–°
kubectl set image daemonsets controller-daemonset-test pod-test='wangxiaochun/pod-test:v0.2' --record=true && kubectl rollout status daemonset controller-daemonset-test

# æ³¨æ„ï¼šdaemonsetå¯¹è±¡ä¸æ”¯æŒpauseåŠ¨ä½œ
```



##### æ¡ˆä¾‹ï¼š: åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šéƒ¨ç½²ç›‘æŽ§è½¯ä»¶prometheusé‡‡é›†æŒ‡æ ‡æ•°æ®

```yaml
# cat controller-daemonset-prometheus.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: daemonset-demo
  namespace: default
  labels:
    app: prometheus
    component: node-exporter
spec:
  selector:
    matchLabels:
      app: prometheus
      component: node-exporter
  template:
    metadata:
      name: prometheus-node-exporter
      labels:
        app: prometheus
        component: node-exporter
    spec:
      #tolerations:
      #- key: node-role.kubernetes.io/control-plane
      #  operator: Exists
      #  effect: NoSchedule
      #- key: node-role.kubernetes.io/master
      #  operator: Exists
      #  effect: NoSchedule
      containers:
      - image: prom/node-exporter:v1.2.2
        name: prometheus-node-exporter
        ports:
        - name: prom-node-exp
          containerPort: 9100
          #hostPort: 9100
        livenessProbe:
          tcpSocket:
            port: prom-node-exp
          initialDelaySeconds: 3
        readinessProbe:
          httpGet:
            path: '/metrics'
            port: prom-node-exp
            scheme: HTTP
          initialDelaySeconds: 5
      hostNetwork: true
      hostPID: true
```

![image-20241223104118377](D:\git_repository\cyber_security_learning\markdown_img\image-20241223104118377.png)



**æ¡ˆä¾‹ï¼šä»…åœ¨æŒ‡å®šæ ‡ç­¾çš„æ¯ä¸ªä¸»æœºä¸Šè¿è¡Œä¸€ä¸ªPod**

```bash
# åœ¨æŒ‡å®šçš„èŠ‚ç‚¹ä¸Šæ‰“ä¾¿ç­¾
[root@master1 yaml]#kubectl label node node1.wang.org node2.wang.org ds=true
node/node1.wang.org labeled
node/node2.wang.org labeled

[root@master1 yaml]#cat controller-daemonset-label-test.yaml 
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: controller-daemonset-label-test
spec:
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      nodeSelector:      # ä½¿ç”¨èŠ‚ç‚¹æ ‡ç­¾é€‰æ‹©å™¨
        ds: "true"       #æŒ‡å®šæ¡ä»¶
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
```





### Job



#### Jobå·¥ä½œæœºåˆ¶

åœ¨æ—¥å¸¸çš„å·¥ä½œä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°ä¸´æ—¶æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä½†æ˜¯è¿™ä¸ªä»»åŠ¡å¿…é¡»åœ¨æŸä¸ªæ—¶é—´ç‚¹æ‰§è¡Œæ‰å¯ä»¥

å‰é¢çš„Deploymentå’ŒDaemonSetä¸»è¦è´Ÿè´£ç¼–æŽ’å§‹ç»ˆ**æŒç»­è¿è¡Œçš„å®ˆæŠ¤è¿›ç¨‹ç±»çš„åº”ç”¨**ï¼Œå¹¶ä¸é€‚åˆæ­¤åœºæ™¯

é’ˆå¯¹äºŽè¿™ç§åœºæ™¯ï¼Œä¸€èˆ¬ä½¿ç”¨jobçš„æ–¹å¼æ¥å®Œæˆä»»åŠ¡ã€‚



**Jobè´Ÿè´£ç¼–æŽ’è¿è¡Œæœ‰ç»“æŸæ—¶é—´çš„â€œä¸€æ¬¡æ€§â€ä»»åŠ¡**

- æŽ§åˆ¶å™¨è¦ç¡®ä¿Podå†…çš„è¿›ç¨‹â€œæ­£å¸¸ï¼ˆæˆåŠŸå®Œæˆä»»åŠ¡)â€é€€å‡º
- **éžæ­£å¸¸é€€å‡ºçš„Podå¯ä»¥æ ¹æ®éœ€è¦é‡å¯ï¼Œå¹¶åœ¨é‡è¯•æŒ‡å®šçš„æ¬¡æ•°åŽç»ˆæ­¢**
- Job å¯ä»¥æ˜¯å•æ¬¡ä»»åŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨å¤šä¸ªPodåˆ†åˆ«å„è‡ªè¿è¡Œä¸€æ¬¡ï¼Œå®žçŽ°è¿è¡Œå¤šæ¬¡ï¼ˆæ¬¡æ•°é€šå¸¸å›ºå®š)
- Job æ”¯æŒåŒæ—¶åˆ›å»ºåŠå¹¶è¡Œè¿è¡Œå¤šä¸ªPodä»¥åŠ å¿«ä»»åŠ¡å¤„ç†é€Ÿåº¦ï¼ŒJobæŽ§åˆ¶å™¨æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å…¶å¹¶è¡Œåº¦



**å…³äºŽjobçš„æ‰§è¡Œä¸»è¦æœ‰ä¸¤ç§å¹¶è¡Œåº¦çš„ç±»åž‹ï¼š**

- **ä¸²è¡Œ job**ï¼šå³æ‰€æœ‰çš„jobä»»åŠ¡éƒ½åœ¨ä¸Šä¸€ä¸ªjobæ‰§è¡Œå®Œæ¯•åŽï¼Œå†å¼€å§‹æ‰§è¡Œ
- **å¹¶è¡Œ job**ï¼šå¦‚æžœå­˜åœ¨å¤šä¸ª jobï¼Œå¯ä»¥è®¾å®šå¹¶è¡Œæ‰§è¡Œçš„ job æ•°é‡ã€‚



Jobèµ„æºåŒæ ·éœ€è¦æ ‡ç­¾é€‰æ‹©å™¨å’ŒPodæ¨¡æ¿ï¼Œä½†å®ƒä¸éœ€è¦æŒ‡å®šreplicasï¼Œä¸”éœ€è¦ç»™å®š**completions**ï¼Œå³éœ€è¦å®Œæˆçš„ä½œä¸šæ¬¡æ•°ï¼Œé»˜è®¤ä¸º1æ¬¡

- Jobèµ„æºä¼šä¸ºå…¶Podå¯¹è±¡è‡ªåŠ¨æ·»åŠ â€œjob-name=JOB_NAMEâ€å’Œâ€œcontroller-uid=UIDâ€æ ‡ç­¾ï¼Œå¹¶ä½¿ç”¨æ ‡ ç­¾é€‰æ‹©å™¨å®Œæˆå¯¹controller-uidæ ‡ç­¾çš„å…³è”ï¼Œå› æ­¤ï¼Œselectorå¹¶éžå¿…é€‰å­—æ®µ
- Podçš„å‘½åæ ¼å¼ï¼š$(job-name)-$(index)-$(random-string)ï¼Œå…¶ä¸­çš„$(index)å­—æ®µå–å€¼ä¸Ž completionså’ŒcompletionModeæœ‰å…³



**æ³¨æ„**ï¼š

- Job èµ„æºæ˜¯æ ‡å‡†çš„APIèµ„æºç±»åž‹
- Job èµ„æºæ‰€åœ¨ç¾¤ç»„ä¸ºâ€œbatch/v1â€
- Job èµ„æºä¸­ï¼ŒPodçš„RestartPolicyçš„å–å€¼åªèƒ½ä¸º**Never**æˆ–**OnFailure**



#### jobå±žæ€§è§£æž

```yaml
apiVersion: batch/v1                   # APIç¾¤ç»„åŠç‰ˆæœ¬
kind: Job
metadata:
  name: <string>             
  namespace: <string>                  # åç§°ç©ºé—´ï¼šJobèµ„æºéš¶å±žåç§°ç©ºé—´çº§åˆ«
spec:
  selector: <object>                   # æ ‡ç­¾é€‰æ‹©å™¨ï¼Œå¿…é¡»åŒ¹é…templateå­—æ®µä¸­Podæ¨¡ç‰ˆä¸­çš„æ ‡ç­¾
  suspend: <boolean>                   # æ˜¯å¦æŒ‚èµ·å½“å‰Jobçš„æ‰§è¡Œï¼ŒæŒ‚èµ·ä½œä¸šä¼šé‡ç½®StartTimeå­—æ®µçš„å€¼
  template: <object>                   # Podæ¨¡ç‰ˆå¯¹è±¡
  completions: <integer>               # æœŸæœ›çš„æˆåŠŸå®Œæˆçš„ä½œä¸šæ¬¡æ•°ï¼ŒæˆåŠŸè¿è¡Œç»“æŸçš„Podæ•°é‡ï¼Œé»˜è®¤1æ¬¡
  completionMode: <string>             # è¿½è¸ªPodå®Œæˆæ¨¡å¼ï¼Œæ”¯æŒæœ‰åºçš„Indexedå’Œæ— åºçš„NonIndexedï¼ˆé»˜è®¤ï¼‰ä¸¤ç§
  ttlSecondsAfterFinished: <integer>   # Completedç»ˆæ­¢çŠ¶æ€ä½œä¸šçš„ç”Ÿå­˜æ—¶é•¿ï¼Œè¶…æ—¶å°†è¢«åˆ é™¤
  parallelism: <integer>               # ä½œä¸šçš„æœ€å¤§å¹¶è¡Œåº¦ï¼Œé»˜è®¤ä¸º1
  backoffLimit: <integer>              # å°†ä½œä¸šæ ‡è®°ä¸ºFailedä¹‹å‰çš„é‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸º6
  activeDeadlineSeconds: <integer>     # ä½œä¸šå¯åŠ¨åŽå¯å¤„äºŽæ´»åŠ¨çŠ¶æ€çš„æ—¶é•¿
```



**å¹¶è¡Œé…ç½®ç¤ºä¾‹**

```yaml
#ä¸²è¡Œè¿è¡Œå…±5æ¬¡ä»»åŠ¡
spec
  parallelism: 1
  completion: 5
 
#å¹¶è¡Œ2ä¸ªé˜Ÿåˆ—ï¼Œæ€»å…±è¿è¡Œ6æ¬¡ä»»åŠ¡
spec
  parallelism: 2
  completion: 6
```



#### Jobæ¡ˆä¾‹

##### ç¤ºä¾‹ï¼šå•ä¸ªä»»åŠ¡

```yaml
# cat controller-job-single.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: job-single
spec:
  template:
    metadata:
      name: job-single
    spec:
      restartPolicy: Never
      containers:
      - name: job-single
        image: busybox:1.30.0
        command: ["/bin/sh", "-c", "for i in `seq 10 -1 1`; do echo $i; sleep 2; done"]
# å±žæ€§è§£æžï¼šjobé‡å¯ç­–ç•¥åªæœ‰ä¸¤ç§ï¼Œä»…æ”¯æŒNeverå’ŒOnFailureä¸¤ç§ï¼Œä¸æ”¯æŒAlways,å¦åˆ™çš„è¯å°±æˆæ­»å¾ªçŽ¯äº†

# æŸ¥çœ‹
[root@master1 loadBalancer]#kubectl logs job-single-t58q9 -f --timestamps=true
2024-12-23T03:08:42.128553849Z 10
2024-12-23T03:08:44.131895308Z 9
2024-12-23T03:08:46.132162071Z 8
2024-12-23T03:08:48.132344330Z 7
2024-12-23T03:08:50.132757393Z 6
2024-12-23T03:08:52.133286967Z 5
2024-12-23T03:08:54.133431930Z 4
2024-12-23T03:08:56.134113681Z 3
2024-12-23T03:08:58.134510385Z 2
2024-12-23T03:09:00.134875367Z 1

# ç»“æžœæ˜¾ç¤ºï¼šjobä»»åŠ¡æ‰§è¡Œå®Œæ¯•åŽï¼ŒçŠ¶æ€æ˜¯Completed
[root@master1 loadBalancer]#kubectl get pod
NAME                                                   READY   STATUS      RESTARTS       AGE
job-single-t58q9                                       0/1     Completed   0              13m

```



##### ç¤ºä¾‹ï¼šå¤šä¸ªä¸²è¡Œä»»åŠ¡

```yaml
# cat controller-job-multi-serial.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: job-multi-serial
spec:
  completions: 5
  parallelism: 1              # parallelismä¸º1è¡¨ç¤ºä¸²è¡Œ
  # completionMode: Indexed
  template:
    spec:
      containers:
      - name: job-multi-serial
        image: busybox:1.30.0
        command: ["/bin/sh", "-c", "echo serial job; sleep 3"]
      restartPolicy: OnFailure

# éªŒè¯æ˜¯å¦ä¸²è¡Œ
# job_list=$(kubectl get pod |sort -k5 | awk '!/^NAME/{print $1}')
[root@master1 loadBalancer] # for i in $job_list ;do kubectl logs $i --timestamps;done
2024-12-23T03:36:53.978861730Z serial job
2024-12-23T03:37:19.492071239Z serial job
2024-12-23T03:37:12.968879900Z serial job
2024-12-23T03:37:06.853185566Z serial job
2024-12-23T03:37:00.775452672Z serial job
#ç»“æžœæ˜¾ç¤ºï¼šè¿™äº›ä»»åŠ¡ï¼Œç¡®å®žæ˜¯ä¸²è¡Œçš„æ–¹å¼æ¥æ‰§è¡Œï¼Œç”±äºŽæ¶‰åŠåˆ°ä»»åŠ¡æœ¬èº«æ˜¯å¯åŠ¨å’Œåˆ é™¤ï¼Œæ‰€ä»¥æ—¶é—´é—´éš”è¦å¤§äºŽ3s
```



##### ç¤ºä¾‹ï¼šå¹¶è¡Œä»»åŠ¡

```yaml
# cat controller-job-multi-parallel.yaml 
apiVersion: batch/v1
kind: Job
metadata:
  name: job-multi-parallel
spec:
  completions: 6
  parallelism: 2   # #completions/parallelism å¦‚æžœä¸èƒ½æ•´é™¤,æœ€åŽä¸€æ¬¡ä¸ºå‰©ä½™çš„ç¬¦åŠ¡æ•°
  ttlSecondsAfterFinished: 3600
  backoffLimit: 3
  activeDeadlineSeconds: 1200
  template:
    spec:
      containers:
      - name: job-multi-parallel
        image: busybox:1.30.0
        command: ["/bin/sh", "-c", "echo parallel job; sleep 3"]
      restartPolicy: OnFailure
      
[root@master1 loadBalancer] # kubectl apply -f controller-job-multi-parallel.yaml 
job.batch/job-multi-parallel created

# æŸ¥çœ‹Pod
[root@master1 loadBalancer] # kubectl get pod
NAME                       READY   STATUS      RESTARTS   AGE
job-multi-parallel-9mcfj   0/1     Completed   0          42s
job-multi-parallel-cmgjq   0/1     Completed   0          54s
job-multi-parallel-n9kc2   0/1     Completed   0          48s
job-multi-parallel-t7hrz   0/1     Completed   0          54s
job-multi-parallel-vzrrp   0/1     Completed   0          42s
job-multi-parallel-z2bsl   0/1     Completed   0          48s

# éªŒè¯ç»“æžœ
[root@master1 loadBalancer] # job_list=$(kubectl get pod |sort -k5 | awk '!/^NAME/{print $1}')
[root@master1 loadBalancer] # for i in $job_list ;do kubectl logs $i --timestamps;done
2024-12-23T03:45:54.982398422Z parallel job
2024-12-23T03:45:54.921097939Z parallel job
2024-12-23T03:45:48.912076981Z parallel job
2024-12-23T03:45:48.908837334Z parallel job
2024-12-23T03:45:42.743753059Z parallel job
2024-12-23T03:45:42.739638339Z parallel job
#ç»“æžœæ˜¾ç¤ºï¼šè¿™6æ¡ä»»åŠ¡ç¡®å®žæ˜¯ä¸¤ä¸¤å¹¶è¡Œæ‰§è¡Œçš„
```



### CronJob

#### CronJobå·¥ä½œæœºåˆ¶

![image-20241223114903445](D:\git_repository\cyber_security_learning\markdown_img\image-20241223114903445.png)



å¯¹äºŽ**å‘¨æœŸæ€§çš„å®šæ—¶ä»»åŠ¡**ï¼Œkubernetesæä¾›äº† CronjobæŽ§åˆ¶å™¨å®žçŽ°ä»»åŠ¡çš„ç¼–æŽ’

CronJob å»ºç«‹åœ¨Jobçš„åŠŸèƒ½ä¹‹ä¸Šï¼Œæ˜¯æ›´é«˜å±‚çº§çš„æŽ§åˆ¶å™¨

å®ƒä»¥JobæŽ§åˆ¶å™¨å®Œæˆå•æ‰¹æ¬¡çš„ä»»åŠ¡ç¼–æŽ’ï¼Œè€ŒåŽä¸ºè¿™ç§Jobä½œä¸šæä¾›éœ€è¦è¿è¡Œçš„å‘¨æœŸå®šä¹‰

CronJobå…¶å®žå°±æ˜¯åœ¨Jobçš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†æ—¶é—´è°ƒåº¦ï¼Œå¯ä»¥åœ¨ç»™å®šçš„æ—¶é—´ç‚¹å¯åŠ¨ä¸€ä¸ªPod æ¥è¿è¡Œä»»åŠ¡ï¼Œä¹Ÿå¯ ä»¥å‘¨æœŸæ€§åœ°åœ¨ç»™å®šæ—¶é—´ç‚¹å¯åŠ¨Podè¿è¡Œä»»åŠ¡ã€‚

CronJob è¢«è°ƒç”¨çš„æ—¶é—´æ˜¯æ¥è‡ªäºŽcontroller-managerçš„æ—¶é—´,éœ€è¦ç¡®ä¿controller-managerå‡†ç¡®

å¦å¤–CronJobæ‰§è¡Œæ—¶,éœ€è¦æ‹‰å–é•œåƒä¹Ÿéœ€è¦ä¸€å®šçš„æ—¶é—´,æ‰€ä»¥å¯èƒ½ä¼šå¯¼è‡´çœŸæ­£æ‰§è¡Œçš„æ—¶é—´ä¸å‡†ç¡® å¯¹äºŽæ²¡æœ‰æŒ‡å®šæ—¶åŒºçš„ CronJobï¼Œkube-controller-manager åŸºäºŽæœ¬åœ°æ—¶åŒºè§£é‡ŠæŽ’æœŸè¡¨ï¼ˆScheduleï¼‰

**åˆ é™¤CronJobï¼ŒåŒæ—¶ä¼šçº§è”åˆ é™¤ç›¸å…³çš„Jobå’ŒPod**

ä¸€ä¸ªCronJobå¯¹è±¡å…¶å®žå°±å¯¹åº”ä¸­crontabæ–‡ä»¶ä¸­çš„ä¸€è¡Œï¼Œå®ƒæ ¹æ®é…ç½®çš„æ—¶é—´æ ¼å¼å‘¨æœŸæ€§åœ°è¿è¡Œä¸€ä¸ªJobï¼Œ æ ¼å¼å’Œcrontabä¹Ÿæ˜¯ç›¸åŒçš„

æ³¨æ„ï¼šåœ¨CronJobä¸­ï¼Œé€šé…ç¬¦â€œ?â€å’Œâ€œ*â€çš„æ„ä¹‰ç›¸åŒï¼Œå®ƒä»¬éƒ½è¡¨ç¤ºä»»ä½•å¯ç”¨çš„æœ‰æ•ˆå€¼



**Cron æ—¶é—´è¡¨è¯­æ³•**

```bash
# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åˆ†é’Ÿ (0 - 59)
# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°æ—¶ (0 - 23)
# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆçš„æŸå¤© (1 - 31)
# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æœˆä»½ (1 - 12)
# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‘¨çš„æŸå¤© (0 - 6)ï¼ˆå‘¨æ—¥åˆ°å‘¨ä¸€ï¼›åœ¨æŸäº›ç³»ç»Ÿä¸Šï¼Œ7 ä¹Ÿæ˜¯æ˜ŸæœŸæ—¥ï¼‰
# â”‚ â”‚ â”‚ â”‚ â”‚                         æˆ–è€…æ˜¯ sunï¼Œmonï¼Œtueï¼Œwebï¼Œthuï¼Œfriï¼Œsat
# â”‚ â”‚ â”‚ â”‚ â”‚
# â”‚ â”‚ â”‚ â”‚ â”‚
# * * * * *
```



| è¾“å…¥                   | æè¿°                         | ç›¸å½“äºŽ    |
| ---------------------- | ---------------------------- | --------- |
| @yearly (or @annually) | æ¯å¹´ 1 æœˆ 1 æ—¥çš„åˆå¤œè¿è¡Œä¸€æ¬¡ | 0 0 1 1 * |
| @monthly               | æ¯æœˆç¬¬ä¸€å¤©çš„åˆå¤œè¿è¡Œä¸€æ¬¡     | 0 0 1 * * |
| @weekly                | æ¯å‘¨çš„å‘¨æ—¥åˆå¤œè¿è¡Œä¸€æ¬¡       | 0 0 * * 0 |
| @daily (or @midnight)  | æ¯å¤©åˆå¤œè¿è¡Œä¸€æ¬¡             | 0 0 * * * |
| @hourly                | æ¯å°æ—¶çš„å¼€å§‹ä¸€æ¬¡             | 0 * * * * |



#### CronJobå±žæ€§è§£æž

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: <string>
  namespace: <string>
spec:
  jobTemplate: <object>
    metadata: <object>
    spec: <object>
  schedule: <string>                   # è°ƒåº¦æ—¶é—´è®¾å®šï¼Œå¿…é€‰å­—æ®µï¼Œæ ¼å¼å’ŒLinuxçš„cronjobç›¸åŒ
  concurrencyPolicy: <string>          # å¤šä¸ªCronjobæ˜¯å¦è¿è¡Œå¹¶å‘ç­–ç•¥ï¼Œå¯ç”¨å€¼æœ‰Allow,Forbidå’ŒReplace
                                       # Allow å…è®¸ä¸Šä¸€ä¸ªCronJobæ²¡æœ‰å®Œæˆï¼Œå¼€å§‹æ–°çš„ä¸€ä¸ªCronJobå¼€å§‹æ‰§è¡Œ
                                       # Forbid ç¦æ­¢åœ¨ä¸Šä¸€ä¸ªCronJobè¿˜æ²¡å®Œæˆï¼Œå°±å¼€å§‹æ–°çš„ä»»åŠ¡
                                       # Replace å½“ä¸Šä¸€ä¸ªCronJobæ²¡æœ‰å®Œæˆæ—¶ï¼Œæ€æŽ‰æ—§ä»»åŠ¡ï¼Œç”¨æ–°çš„ä»»åŠ¡ä»£æ›¿
  failedJobsHistoryLimit: <integer>    # å¤±è´¥ä½œä¸šçš„åŽ†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º1ï¼Œå»ºè®®è®¾ç½®æ­¤å€¼ç¨å¤§ä¸€äº›ï¼Œæ–¹ä¾¿æŸ¥çœ‹åŽŸå› 
  successfulDeadlineSeconds: <integer> # æˆåŠŸä½œä¸šçš„åŽ†å²è®°å½•æ•°ï¼Œé»˜è®¤ä¸º3
  startingDeadlineSeconds: <integer>   # å› é”™è¿‡æ—¶é—´ç‚¹è€Œæœªæ‰§è¡Œçš„ä½œä¸šçš„å¯è¶…æœŸæ—¶é•¿ï¼Œä»å¯ç»§ç»­æ‰§è¡Œ
  suspend: <boolean>                   # æ˜¯å¦æŒ‚èµ·åŽç»­çš„ä½œä¸šï¼Œä¸å½±å“å½“å‰çš„ä½œä¸šï¼Œé»˜è®¤ä¸ºfalse
  

# å®˜æ–¹ç¤ºä¾‹
apiVersion: batch/v1
kind: CronJob
metadata:
  name: hello
spec:
  schedule: "* * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: hello
            image: busybox:1.28
            imagePullPolicy: IfNotPresent
            command:
            - /bin/sh
            - -c
            - date; echo Hello from the kubernetes cluster
          restartPolicy: OnFailure
```



#### CronJobæ¡ˆä¾‹

##### ç¤ºä¾‹ï¼šå•å‘¨æœŸä»»åŠ¡

```yaml
# cat controller-cronjob-simple.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cronjob
spec:
  schedule: "*/2 * * * *"   # æ¯2åˆ†é’Ÿæ‰§è¡Œ1æ¬¡
  jobTemplate:
    spec:
      #parallelism: 2       # ä¸¤è·¯å¹¶è¡Œ
      #completions: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: cronjob
            image: busybox:1.30.0
            command: ["/bin/sh", "-c", "echo Cron Job"]
            
# å¯åŠ¨
[root@master1 loadBalancer]#kubectl apply -f controller-cronjob-simple.yaml 
cronjob.batch/cronjob created

# æŸ¥çœ‹cronjob
[root@master1 loadBalancer]#kubectl get cronjobs.batch 
NAME      SCHEDULE      TIMEZONE   SUSPEND   ACTIVE   LAST SCHEDULE   AGE
cronjob   */2 * * * *   <none>     False     0        <none>          13s

# å¯ä»¥è§‚å¯Ÿåˆ°cronjobæ˜¯å‘¨æœŸæ€§åˆ›å»ºjob
[root@master1 loadBalancer]#kubectl get job
NAME               STATUS     COMPLETIONS   DURATION   AGE
cronjob-28915564   Complete   1/1           3s         2m14s
cronjob-28915566   Complete   1/1           3s         14s

[root@master1 loadBalancer]#kubectl get pod
NAME                     READY   STATUS      RESTARTS   AGE
cronjob-28915564-zx5vh   0/1     Completed   0          2m50s
cronjob-28915566-trj2l   0/1     Completed   0          50s
```





## KubernetesæœåŠ¡å‘çŽ°



**æœ¬ç« å†…å®¹**

- **æœåŠ¡è®¿é—®**
- **æœåŠ¡å‘çŽ°**
- **åŸŸåè§£æž**
- **æ— å¤´æœåŠ¡**





### æœåŠ¡è®¿é—®

Kubernetesé›†ç¾¤æä¾›äº†è¿™æ ·çš„ä¸€ä¸ªèµ„æºå¯¹è±¡Serviceï¼Œå®ƒå®šä¹‰äº†ä¸€ç»„Podçš„é€»è¾‘é›†åˆå’Œä¸€ä¸ªç”¨äºŽè®¿é—®å®ƒä»¬ çš„å…¥å£ç­–ç•¥

Service å¯ä»¥**åŸºäºŽæ ‡ç­¾çš„æ–¹å¼**è‡ªåŠ¨æ‰¾åˆ°å¯¹åº”çš„podåº”ç”¨ï¼Œè€Œæ— éœ€å…³å¿ƒpodçš„ipåœ°å€å˜åŒ–ä¸Žå¦ï¼Œä»Žè€Œå®žçŽ°äº† ç±»ä¼¼è´Ÿè½½å‡è¡¡çš„æ•ˆæžœ

Service æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ª**å››å±‚çš„åå‘ä»£ç†**ï¼Œé›†ç¾¤å†…å’Œå¤–çš„å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å¦‚ä¸‹æµç¨‹æœ€ç»ˆå®žçŽ°è®¿é—®Podåº”ç”¨

```ABAP
é›†ç¾¤å†…éƒ¨Client --> serviceç½‘ç»œ --> Podç½‘ç»œ --> å®¹å™¨åº”ç”¨
é›†ç¾¤å¤–éƒ¨Client --> é›†ç¾¤å†…èŠ‚ç‚¹ç½‘ç»œ --> serviceç½‘ç»œ --> Podç½‘ç»œ --> å®¹å™¨åº”ç”¨

Kubernetesç½‘ç»œ
Podç½‘ç»œ     ----  cni
Serviceç½‘ç»œ ----  kubeproxy
nodeç½‘ç»œ    ----  å®¿ä¸»æœºç½‘ç»œ
```



Service èµ„æºåœ¨masterç«¯çš„Controllerç»„ä»¶ä¸­ï¼Œç”± Service Controller æ¥è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

serviceæ˜¯Kubernetesé‡Œæœ€æ ¸å¿ƒçš„APIèµ„æºå¯¹è±¡ä¹‹ä¸€ï¼Œå®ƒæ˜¯ç”±corednsæˆ–è€…kube-dnsç»„ä»¶æä¾›çš„åŠŸèƒ½ã€‚

Service æ˜¯åŸºäºŽåç§°ç©ºé—´çš„èµ„æº



Kubernetes çš„ Serviceå®šä¹‰äº†ä¸€ä¸ªæœåŠ¡çš„è®¿é—®å…¥å£åœ°å€ï¼Œå‰ç«¯çš„åº”ç”¨Podé€šè¿‡Serviceè®¿é—®å…¶èƒŒåŽä¸€ç»„æœ‰ Podå‰¯æœ¬ç»„æˆçš„é›†ç¾¤å®žä¾‹ï¼ŒServiceé€šè¿‡**Label Selector**è®¿é—®æŒ‡å®šçš„åŽç«¯Podï¼ŒRCä¿è¯Serviceçš„æœåŠ¡èƒ½åŠ›å’ŒæœåŠ¡è´¨é‡å¤„äºŽé¢„æœŸçŠ¶æ€ã€‚



æ¯ä¸ªPodéƒ½æœ‰ä¸€ä¸ªä¸“ç”¨çš„IPåœ°å€ï¼ŒåŠ ä¸ŠPodå†…éƒ¨å®¹å™¨çš„Portç«¯å£ï¼Œå°±ç»„æˆäº†ä¸€ä¸ªè®¿é—®Podä¸“ç”¨çš„ EndPoint(Pod IP+Container Port)ï¼Œä»Žè€Œå®žçŽ°äº†ç”¨æˆ·å¤–éƒ¨èµ„æºè®¿é—®Podå†…éƒ¨åº”ç”¨çš„æ•ˆæžœã€‚

è¿™ä¸ªEndPointèµ„æºåœ¨masterç«¯çš„Controllerç»„ä»¶ä¸­ï¼Œç”±EndPoint Controller æ¥è¿›è¡Œç»Ÿä¸€ç®¡ç†ã€‚

å½“å¤šä¸ªPodç»„æˆäº†ä¸€ä¸ªä¸šåŠ¡é›†ç¾¤æ¥æä¾›å¤–éƒ¨æœåŠ¡ï¼Œé‚£ä¹ˆå¤–éƒ¨å®¢æˆ·ç«¯æ€Žä¹ˆæ‰èƒ½è®¿é—®ä¸šåŠ¡é›†ç¾¤æœåŠ¡å‘¢ï¼Ÿ

![image-20241223144004352](D:\git_repository\cyber_security_learning\markdown_img\image-20241223144004352.png)

æ ¹æ®Podæ‰€å¤„çš„Nodeåœºæ™¯ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š

- æ‰€æœ‰Podå‰¯æœ¬éƒ½åœ¨åŒä¸€NodeèŠ‚ç‚¹ä¸Šï¼šå¯¹äºŽè¿™ç§æƒ…å†µï¼Œå°†Nodeç‰©ç†èŠ‚ç‚¹ä¸“ç”¨çš„IPï¼Œä½œä¸ºè´Ÿè½½å‡è¡¡å™¨ çš„VIPï¼Œå³å¯å®žçŽ°è´Ÿè½½å‡è¡¡åŽç«¯æœåŠ¡çš„æ•ˆæžœã€‚
- æ‰€æœ‰Podå‰¯æœ¬ä¸åœ¨åŒä¸€NodeèŠ‚ç‚¹ä¸Šï¼šNodeèŠ‚ç‚¹çš„ç‰©ç†ipå°±æ²¡æœ‰åŠžæ³•ä½œä¸ºè´Ÿè½½å‡è¡¡å™¨çš„VIPäº†ï¼Œè¿™ä¹Ÿ æ˜¯æ›´ä¸ºå¸¸è§çš„æƒ…å†µã€‚



Kuberneteså‘æ˜Žäº†ä¸€ç§è®¾è®¡ï¼Œç»™Serviceåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„è™šæ‹Ÿipåœ°å€--**cluster IP**ï¼Œå®ƒä¸å­˜åœ¨ä»»ä½•ç½‘ç»œ è®¾å¤‡ä¸Šï¼ŒServiceé€šè¿‡å†…éƒ¨çš„**æ ‡ç­¾é€‰æ‹©å™¨**ï¼ŒæŒ‡å®šç›¸åº”è¯¥Serviceçš„Podèµ„æºï¼Œå½“è¯·æ±‚å‘ç»™cluster IPï¼ŒåŽç«¯ çš„Podèµ„æºæ”¶åˆ°è¯·æ±‚åŽï¼Œå°±ä¼šå“åº”è¯·æ±‚ã€‚

è¿™ç§æƒ…å†µä¸‹ï¼Œæ¯ä¸ªServiceéƒ½æœ‰ä¸€ä¸ªå…¨å±€å”¯ä¸€é€šä¿¡åœ°å€ï¼Œæ•´ä¸ªç³»ç»Ÿçš„å†…éƒ¨æœåŠ¡é—´è°ƒç”¨å°±å˜æˆäº†æœ€åŸºç¡€çš„ TCP/IPç½‘ç»œé€šä¿¡é—®é¢˜ã€‚å¦‚æžœæˆ‘ä»¬çš„é›†ç¾¤å†…éƒ¨çš„æœåŠ¡æƒ³è¦å’Œå¤–éƒ¨çš„ç½‘ç»œè¿›è¡Œé€šä¿¡ï¼Œå¯ä»¥æœ‰å¤šç§æ–¹æ³•ï¼Œæ¯” å¦‚ï¼š

- NodePortç±»åž‹ï¼Œé€šè¿‡åœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸Šå¢žåŠ ä¸€ä¸ªå¯¹å¤–çš„ç«¯å£ï¼Œç”¨äºŽæŽ¥å…¥é›†ç¾¤å¤–éƒ¨è¯·æ±‚
- ingressç±»åž‹ï¼Œé€šè¿‡é›†ç¾¤é™„åŠ æœåŠ¡åŠŸèƒ½ï¼Œå°†å¤–éƒ¨çš„åŸŸåæµé‡è½¬äº¤åˆ°é›†ç¾¤å†…éƒ¨ã€‚



**Service æ ¸å¿ƒåŠŸèƒ½**

- æœåŠ¡å‘çŽ°: åˆ©ç”¨æ ‡ç­¾é€‰æ‹©å™¨ï¼Œåœ¨åŒä¸€ä¸ªnamespaceä¸­ç­›é€‰ç¬¦åˆçš„æ¡ä»¶çš„Pod, ä»Žé¢å®žçŽ°å‘çŽ°ä¸€ç»„æä¾› äº†ç›¸åŒæœåŠ¡çš„Pod
- è´Ÿè½½å‡è¡¡: Serviceä½œä¸ºæµé‡å…¥å£å’Œè´Ÿè½½å‡è¡¡å™¨ï¼Œå…¶å…¥å£ä¸ºClusterIP, è¿™ç»„ç­›é€‰å‡ºçš„Podçš„IPåœ°å€ï¼Œå°† ä½œä¸ºè¯¥Serviceçš„åŽç«¯æœåŠ¡å™¨
- åç§°è§£æž: åˆ©ç”¨Cluster DNSï¼Œä¸ºè¯¥ç»„Podæ‰€ä»£è¡¨çš„æœåŠ¡æä¾›ä¸€ä¸ªåç§°, åœ¨DNSä¸­ å¯¹äºŽæ¯ä¸ªServiceï¼Œ è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªAã€PTRå’ŒSRVè®°å½•



```ABAP
[root@master1 loadBalancer]#kubectl get svc -A
NAMESPACE     NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
default       kubernetes   ClusterIP   10.96.0.1    <none>        443/TCP                  4d1h
kube-system   kube-dns     ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   4d1h

# ä½¿ç”¨10.96.0.1æ¥è®¿é—®api-server
# ä½¿ç”¨10.96.0.10æ¥è®¿é—®dnsï¼Œè¿›è¡ŒåŸŸåè§£æž
# å› ä¸ºåœ¨k8sä¸­ï¼Œcore-dnså’Œapi-serveréƒ½æ˜¯ä»¥å®¹å™¨æ–¹å¼å­˜åœ¨ï¼Œæœ¬èº«åœ°å€ä¸å›ºå®šï¼Œå› æ­¤éœ€è¦å€ŸåŠ©serviceè¿›è¡Œè®¿é—®
```



#### Endpoints

å½“åˆ›å»º Serviceèµ„æºçš„æ—¶å€™ï¼Œæœ€é‡è¦çš„å°±æ˜¯ä¸ºServiceæŒ‡å®šèƒ½å¤Ÿæä¾›æœåŠ¡çš„æ ‡ç­¾é€‰æ‹©å™¨

Service Controllerå°±ä¼šæ ¹æ®æ ‡ç­¾é€‰æ‹©å™¨ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒåçš„**Endpoint**èµ„æºå¯¹è±¡ï¼ŒKubernetesæ–°ç‰ˆä¸­è¿˜å¢žåŠ äº†**endpointslices**èµ„æº

- Endpoint Controllerä½¿ç”¨Endpointçš„æ ‡ç­¾é€‰æ‹©å™¨(ç»§æ‰¿è‡ªServiceæ ‡ç­¾é€‰æ‹©å™¨)ï¼Œç­›é€‰ç¬¦åˆæ¡ä»¶(åŒ…æ‹¬ ç¬¦åˆæ ‡ç­¾é€‰æ‹©å™¨æ¡ä»¶å’Œå¤„äºŽReady çŠ¶æ€)çš„podèµ„æº
- Endpoint Controller å°†ç¬¦åˆè¦æ±‚çš„podèµ„æºç»‘å®šåˆ°Endpointä¸Šï¼Œå¹¶å‘ŠçŸ¥ç»™Serviceèµ„æºè°å¯ä»¥æ­£å¸¸æä¾›æœåŠ¡
- Service ä¼šè‡ªåŠ¨èŽ·å–ä¸€ä¸ªå›ºå®šçš„ **cluster IP**å‘å¤–æä¾›ç”±Endpointæä¾›çš„æœåŠ¡èµ„æº
- Service å…¶å®žå°±æ˜¯ä¸ºåŠ¨æ€çš„ä¸€ç»„ pod èµ„æºå¯¹è±¡æä¾›ä¸€ä¸ªå›ºå®šçš„è®¿é—®å…¥å£ã€‚å³ Serviceå®žçŽ°äº†åŽç«¯Pod åº”ç”¨æœåŠ¡çš„å‘çŽ°åŠŸèƒ½ 





![image-20241223151136366](D:\git_repository\cyber_security_learning\markdown_img\image-20241223151136366.png)



- æ¯åˆ›å»ºä¸€ä¸ªService ,è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå’Œä¹‹åŒåçš„API èµ„æºç±»åž‹ Endpoints
- Endpointsè´Ÿè´£ç»´æŠ¤ç”±ç›¸å…³Serviceæ ‡ç­¾é€‰æ‹©å™¨åŒ¹é…çš„Podå¯¹è±¡
- Endpointså¯¹è±¡ä¸Šä¿å­˜ServiceåŒ¹é…åˆ°çš„æ‰€æœ‰Podçš„IPå’ŒPortä¿¡æ¯,ç§°ä¹‹ä¸ºç«¯ç‚¹
- ETCDæ˜¯K/Væ•°æ®åº“, è€Œä¸€ä¸ª**Endpointså¯¹è±¡å¯¹åº”ä¸€ä¸ªKey**,æ‰€æœ‰**åŽç«¯Podç«¯ç‚¹ä¿¡æ¯ä¸ºå…¶Value**
- å½“ä¸€ä¸ªEndpointså¯¹è±¡å¯¹åº”åŽç«¯æ¯ä¸ªPodçš„æ¯æ¬¡å˜åŠ¨ï¼Œéƒ½éœ€æ›´æ–°æ•´ä¸ªEndpointså¯¹è±¡ï¼Œå¹¶å°†æ–°çš„ Endpointså¯¹è±¡é‡æ–°ä¿å­˜è‡³API Serverå’ŒETCD
- æ­¤å¤–è¿˜éœ€è¦å°†è¯¥å¯¹è±¡åŒæ­¥è‡³æ¯ä¸ªèŠ‚ç‚¹çš„kube-proxy
- åœ¨ETCDä¸­çš„å¯¹è±¡é»˜è®¤æœ€å¤§ä¸º1.5MB,ä¸€ä¸ªEndpointså¯¹è±¡è‡³å¤šå¯ä»¥å­˜å‚¨5000ä¸ªå·¦å³çš„ç«¯ç‚¹ä¿¡æ¯,è¿™æ„ å‘³ç€å¹³å‡æ¯ç«¯ç‚¹å 300KB



#### EndpointSlice

æ–°ç‰ˆKubernetesä¸ºä»€ä¹ˆéœ€è¦å¼•ç”¨EndpointSliceå‘¢?

![image-20241223151352710](D:\git_repository\cyber_security_learning\markdown_img\image-20241223151352710.png)

- åŸºäºŽEndpointsæœºåˆ¶ï¼Œå³ä¾¿åªæœ‰ä¸€ä¸ªPodçš„IPç­‰ä¿¡æ¯å‘ç”Ÿå˜åŠ¨ï¼Œå°±éœ€è¦å‘é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„ kube-proxyå‘é€æ•´ä¸ªendpointså¯¹è±¡
- æ¯”å¦‚: ä¸€ä¸ªç”±2000ä¸ªèŠ‚ç‚¹ç»„æˆçš„é›†ç¾¤ä¸­ï¼Œæ›´æ–°ä¸€ä¸ªæœ‰5000ä¸ªPod IPå ç”¨1.5MBç©ºé—´çš„Endpoints å¯¹ è±¡ï¼Œå°±éœ€è¦å‘é€3GBçš„æ•°æ®
  - è‹¥ä»¥æ»šåŠ¨æ›´æ–°æœºåˆ¶ï¼Œä¸€æ¬¡åªå‡çº§æ›´æ–°ä¸€ä¸ªPodçš„ä¿¡æ¯ï¼Œè¿™å°†å¯¼è‡´æ›´æ–°è¿™ä¸ªEndpointså¯¹è±¡éœ€è¦å‘é€ 15Tçš„æ•°æ®
- EndpointSliceèµ„æºé€šè¿‡å°†Endpointsåˆ‡åˆ†ä¸ºå¤šç‰‡æ¥è§£å†³ä¸Šè¿°é—®é¢˜
- è‡ªKubernetes v1.16å¼•å…¥EndpointSlice
- æ¯ä¸ªç«¯ç‚¹ä¿¡æ¯çš„å˜åŠ¨ï¼Œä»…éœ€è¦æ›´æ–°å’Œå‘é€ä¸€ä¸ª**EndpontSliceå¯¹è±¡**,è€Œéžæ•´ä¸ªEndpointså¯¹è±¡
- æ¯ä¸ªEndpointSliceé»˜è®¤å­˜å‚¨100ä¸ªç«¯ç‚¹ä¿¡æ¯ï¼Œä¸ä¼šè¶…è¿‡ etcdå¯¹å•ä¸ªå¯¹è±¡çš„å­˜å‚¨é™åˆ¶
- å¯åœ¨kube-controller-managerç¨‹åºä¸Šä½¿ç”¨ **--max-endpoints-per-slice** é€‰é¡¹è¿›è¡Œé…ç½®
- EndpointSliceå¹¶æœªå–ä»£Endpointsï¼ŒäºŒè€…åŒæ—¶å­˜åœ¨



```bash
# æŸ¥çœ‹endpointå’Œendpointslices
[root@master1 loadBalancer]#kubectl get endpointslices -A
NAMESPACE     NAME             ADDRESSTYPE   PORTS        ENDPOINTS                 AGE
default       kubernetes       IPv4          6443         10.0.0.201                4d2h
kube-system   kube-dns-5zfkl   IPv4          9153,53,53   10.244.2.40,10.244.2.38   4d2h
[root@master1 loadBalancer]#kubectl get ep -A
NAMESPACE     NAME         ENDPOINTS                                                  AGE
default       kubernetes   10.0.0.201:6443                                            4d2h
kube-system   kube-dns     10.244.2.38:53,10.244.2.40:53,10.244.2.38:53 + 3 more...   4d2h
```





#### Serviceè®¿é—®è¿‡ç¨‹

![image-20241223153657945](D:\git_repository\cyber_security_learning\markdown_img\image-20241223153657945.png)



#### endpointsæ‰©å±•æ€è·¯

```ABAP
å¯ä»¥æ‰‹åŠ¨åˆ›å»ºendpointsï¼Œå¹¶å°†é›†ç¾¤å¤–èµ„æºåŠ å…¥endpointsçš„é˜Ÿåˆ—ä¸­ï¼Œå®žçŽ°é›†ç¾¤å†…çš„podè®¿é—®é›†ç¾¤å¤–èµ„æºçš„æ•ˆæžœ
```



#### Service å·¥ä½œæ¨¡åž‹

ä¸€ä¸ªServiceå¯¹è±¡æœ€ç»ˆä½“çŽ°ä¸ºå·¥ä½œèŠ‚ç‚¹ä¸Šçš„ä¸€äº›**iptablesæˆ–ipvsè§„åˆ™**ï¼Œè¿™äº›è§„åˆ™æ˜¯ç”±kube-proxyè¿›è¡Œå®žæ—¶ç”Ÿæˆå’Œç»´æŠ¤\



**é’ˆå¯¹æŸä¸€ç‰¹å®šæœåŠ¡ï¼Œå¦‚ä½•å°†é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å˜æˆå…¶å‡è¡¡å™¨ï¼š**

- åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œä¸€ä¸ªkube-proxyï¼Œç”±kube-proxyæ³¨å†Œç›‘è§†API Serverçš„Serviceèµ„æºçš„åˆ›å»ºã€ä¿® æ”¹å’Œåˆ é™¤
- å°†Serviceçš„å®šä¹‰ï¼Œè½¬ä¸ºæœ¬åœ°è´Ÿè½½å‡è¡¡åŠŸèƒ½çš„è½åœ°å®žçŽ°



**kube-proxyå°†è¯·æ±‚ä»£ç†è‡³ç›¸åº”ç«¯ç‚¹çš„å®žçŽ°æ–¹å¼æœ‰å››ç§ï¼š**

- userspaceï¼ˆåœ¨kubernetes  v1.2ä»¥åŽæ·˜æ±°ï¼‰
- **iptables**ï¼š iptableså·¥å…·ï¼Œé»˜è®¤æ¨¡å¼
- **ipvs**
- nftables: ä»Žkubernetes-v1.29.0 ä¹‹åŽç‰ˆæœ¬æ”¯æŒ,nft å·¥å…·
- kernelspace: ä»…Windowsä½¿ç”¨



è¿™äº›æ–¹æ³•çš„ç›®çš„æ˜¯ï¼škube-proxyå¦‚ä½•ç¡®ä¿serviceèƒ½åœ¨æ¯ä¸ªèŠ‚ç‚¹å®žçŽ°å¹¶æ­£å¸¸å·¥ä½œ

æ³¨æ„: ä¸€ä¸ªé›†ç¾¤åªèƒ½é€‰æ‹©ä½¿ç”¨ä¸€ç§Modeï¼Œå³é›†ç¾¤ä¸­æ‰€æœ‰èŠ‚ç‚¹è¦ä½¿ç”¨ç›¸åŒçš„æ–¹å¼



#### Serviceå’Œkube-proxyå…³è”å…³ç³»

![image-20241223160711007](D:\git_repository\cyber_security_learning\markdown_img\image-20241223160711007.png)

- Serviceä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„APIèµ„æºå¯¹è±¡ï¼Œå®ƒä¼šåœ¨API ServiceæœåŠ¡ä¸­å®šä¹‰å‡ºæ¥çš„
- åœ¨åˆ›å»ºä»»ä½•å­˜åœ¨æ ‡ç­¾é€‰æ‹©å™¨çš„Serviceæ—¶ï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨åˆ›å»ºä¸€ä¸ªåŒåçš„Endpointsèµ„æºï¼ŒEndpoints  å¯¹è±¡ä¼šä½¿ç”¨Label Selectorè‡ªåŠ¨å‘çŽ°åŽç«¯ç«¯ç‚¹ï¼Œå¹¶å„ç«¯ç‚¹çš„IPé…ç½®ä¸ºå¯ç”¨åœ°å€åˆ—è¡¨çš„å…ƒç´ 
- Service Controller è§¦å‘æ¯ä¸ªèŠ‚ç‚¹ä¸Šçš„kube-proxyï¼Œç”±kube-proxyå®žæ—¶çš„è½¬æ¢ä¸ºæœ¬åœ°èŠ‚ç‚¹ä¸Šé¢çš„ ipvs/iptablesè§„åˆ™ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œå†…æ ¸ä¸­çš„ipvsæˆ–iptablesè§„åˆ™ï¼Œä»…ä»…æ˜¯è´Ÿè´£æœ¬åœ°èŠ‚ç‚¹ç”¨æˆ·ç©ºé—´podå®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚æ—¶ çš„æ‹¦æˆªæˆ–è€…è½¬å‘è§„åˆ™
- å¦‚æžœPodå®¢æˆ·ç«¯å‘Serviceå‘å‡ºè¯·æ±‚,å®¢æˆ·ç«¯å‘å†…æ ¸å‘å‡ºè¯·æ±‚ï¼Œæ ¹æ®ipvsæˆ–iptablesè§„åˆ™ï¼ŒåŒ¹é…ç›®æ ‡ service
- å¦‚æžœserviceåŒ¹é…ï¼Œä¼šè¿”å›žå½“å‰serviceéšå¯¹åº”çš„åŽç«¯endpointæœ‰å“ªäº›
- iptablesæˆ–ipvsä¼šæ ¹æ®æƒ…å†µæŒ‘é€‰ä¸€ä¸ªåˆé€‚çš„endpointåœ°å€
  - å¦‚æžœendpointæ˜¯æœ¬æœºä¸Šçš„ï¼Œåˆ™ä¼šè½¬å‘ç»™æœ¬æœºçš„endpoint
  - å¦‚æžœendpointæ˜¯å…¶ä»–ä¸»æœºä¸Šçš„ï¼Œåˆ™è½¬å‘ç»™å…¶ä»–ä¸»æœºä¸Šçš„endpoint



#### Serviceç±»åž‹

å¯¹äºŽKubernetes å¯ä»¥å®žçŽ°å†…éƒ¨æœåŠ¡çš„è‡ªç”±é€šä¿¡,ä¹Ÿå¯ä»¥å°†å¹³å°å†…éƒ¨çš„æœåŠ¡å‘å¸ƒåˆ°å¤–éƒ¨çŽ¯å¢ƒ

Serviceä¸»è¦æœ‰å››ç§ç±»åž‹ï¼Œå®žçŽ°ä¸åŒçš„ç½‘ç»œé€šä¿¡åŠŸèƒ½

- ClusterIP
- NodePort
- LoadBalancer
- ExternalName



| ç±»åž‹         | è§£æž                                                         |
| ------------ | ------------------------------------------------------------ |
| ClusterIP    | æ­¤ä¸ºServiceçš„é»˜è®¤ç±»åž‹<br />ä¸º**é›†ç¾¤å†…éƒ¨çš„å®¢æˆ·ç«¯è®¿é—®**,åŒ…æ‹¬èŠ‚ç‚¹å’ŒPodç­‰ï¼Œ**å¤–éƒ¨ç½‘ç»œæ— æ³•è®¿é—®**<br />In client --> clusterIP: ServicePort (Service) --> PodIP: PodPort |
| NodePort     | æœ¬è´¨ä¸Š**åœ¨ClusterIPæ¨¡å¼åŸºç¡€ä¸Š,å†å¤šåŠ äº†ä¸€å±‚ç«¯å£æ˜ å°„çš„å°è£…**,ç›¸å½“äºŽå¢žå¼ºç‰ˆçš„ ClusterIP<br />é€šè¿‡NodeIP:NodePortå¯¹å¤–éƒ¨ç½‘ç»œæä¾›æœåŠ¡ï¼Œé»˜è®¤**éšæœºç«¯å£èŒƒå›´30000~32767**, å¯æŒ‡å®šä¸ºå›ºå®šç«¯å£<br />NodePortæ˜¯ä¸€ä¸ªéšæœºçš„ç«¯å£ï¼Œä»¥é˜²æ­¢ç«¯å£å†²çª,åœ¨**æ‰€æœ‰å®‰è£…kube-proxyçš„èŠ‚ç‚¹ ä¸Šéƒ½ä¼šæ‰“å¼€æ­¤ç›¸åŒçš„ç«¯å£**<br />å¯é€šè¿‡è®¿é—®ClusterIPå®žçŽ°é›†ç¾¤å†…éƒ¨è®¿é—®,ä¹Ÿå¯ä»¥é€šè¿‡NodeIP:NortPortçš„æ–¹å¼å®ž çŽ°ä»Žé›†ç¾¤å¤–éƒ¨è‡³å†…éƒ¨çš„è®¿é—®<br />Ex Client --> NodeIP:NodePort (Service) --> PodIP:PodPort |
| LoadBalancer | åŸºäºŽNodePortåŸºç¡€ä¹‹ä¸Š**ï¼Œä½¿ç”¨é›†ç¾¤å¤–éƒ¨çš„è¿è¥å•†è´Ÿè½½å‡è¡¡å™¨æ–¹å¼å®žçŽ°å¯¹å¤–æä¾›** æœåŠ¡,å¢žå¼ºç‰ˆçš„NodePort<br/>åŸºäºŽäº‘è¿è¥å•†IaaSäº‘åˆ›å»ºä¸€ä¸ªKubernetesäº‘ï¼Œäº‘å¹³å°ä¹Ÿæ”¯æŒLBaaS(Load Balance as a Service)äº§å“æœåŠ¡<br/>Masterå€ŸåŠ©cloud-managerå‘LBaaSçš„APIè¯·æ±‚åŠ¨æ€åˆ›å»ºè½¯ä»¶LB,å³æ”¯æŒå’ŒKubernetes API Server è¿›è¡Œäº¤äº’<br/>å¦‚æžœæ²¡æœ‰äº‘æœåŠ¡,å°†æ— æ³•èŽ·å–EXTERNAL-IP,æ˜¾ç¤ºPendingçŠ¶æ€,åˆ™é™çº§ä¸º NodePortç±»åž‹<br/>Ex Client --> LB_IP:LB_PORT --> NodeIP:NodePort(Service)--> PodIP:PodPort |
| ExternalName | å½“Kubernetesé›†ç¾¤éœ€è¦è®¿é—®é›†ç¾¤å¤–éƒ¨æœåŠ¡æ—¶ï¼Œéœ€è¦é€šè¿‡externalName**å°†å¤–éƒ¨ä¸»æœºå¼•å…¥åˆ°é›†ç¾¤å†…éƒ¨**<br />å¤–éƒ¨ä¸»æœºåä»¥ DNSæ–¹å¼è§£æžä¸ºä¸€ä¸ª CNAMEè®°å½•ç»™Kubernetesé›†ç¾¤çš„å…¶ä»–ä¸»æœºæ¥ä½¿ç”¨<br />**è¿™ç§Serviceæ—¢æ²¡æœ‰ClusterIPï¼Œä¹Ÿæ²¡æœ‰NodePort.è€Œä¸”ä¾èµ–äºŽå†…éƒ¨çš„CoreDNSåŠŸèƒ½**<br />In client -->Cluster ServiceName --> CName --> External Service Name |





### ExternalIP

å¦‚æžœæœ‰å¤–éƒ¨ IP èƒ½å¤Ÿè·¯ç”±åˆ°ä¸€ä¸ªæˆ–å¤šä¸ªé›†ç¾¤èŠ‚ç‚¹ä¸Šï¼Œåˆ™ Kubernetes å¯ä»¥é€šè¿‡ externalIPs å°†Service  å…¬å¼€å‡ºåŽ»ã€‚

å½“ç½‘ç»œæµé‡è¿›å…¥é›†ç¾¤æ—¶ï¼Œå¦‚æžœ externalIPs ä½œä¸ºç›®çš„ IP åœ°å€å’Œç«¯å£éƒ½ä¸Žè¯¥ Service åŒ¹é…ï¼Œ Kubernetes  æ‰€é…ç½®çš„è§„åˆ™å’Œè·¯ç”±ä¼šç¡®ä¿æµé‡è¢«è·¯ç”±åˆ°è¯¥ Service çš„ç«¯ç‚¹ä¹‹ä¸€ã€‚

Serviceå¯é€šè¿‡ä½¿ç”¨èŠ‚ç‚¹ä¸Šé…ç½®çš„è¾…åŠ©IPåœ°å€æŽ¥å…¥é›†ç¾¤å¤–éƒ¨å®¢æˆ·ç«¯æµé‡

æµé‡å…¥å£ä»…èƒ½æ˜¯é…ç½®æœ‰è¯¥IPåœ°å€çš„èŠ‚ç‚¹ï¼Œå…¶å®ƒèŠ‚ç‚¹æ— æ•ˆï¼Œå› è€Œæ­¤æ—¶åœ¨èŠ‚ç‚¹é—´æ— è´Ÿè½½å‡è¡¡çš„æ•ˆæžœ

external IPæ‰€åœ¨çš„èŠ‚ç‚¹æ•…éšœåŽï¼Œè¯¥æµé‡å…¥å£å¤±æ•ˆï¼Œé™¤éžå°†è¯¥IPåœ°å€è½¬ç§»é…ç½®åˆ°å…¶å®ƒèŠ‚ç‚¹

å®šä¹‰ Service æ—¶ï¼Œä½ å¯ä»¥ä¸ºä»»ä½•æœåŠ¡ç±»åž‹externalIPsã€‚

ç”±äºŽ externalIPs æ˜¯ç»‘å®šåœ¨æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Š,è€Œæ­¤èŠ‚ç‚¹å­˜åœ¨å•ç‚¹é—®é¢˜,å¯ä»¥é€šè¿‡Keepalivedç­‰æ–¹å¼å®žçŽ°é«˜å¯ç”¨

**é«˜å¯ç”¨å¯¹å¤–è§£å†³æ–¹æ¡ˆ**

```ABAP
ExternalIP + VRRP Keepalived -----> Service -----> Pod
```



#### ExternalIPå®žçŽ°

```yaml
# åˆ›å»ºå¸¦externalIPsçš„service
apiVersion: v1
kind: Service
metadata:
  name: my-service
spec:
  selector:
    app.kubernetes.io/name: MyApp
  ports:
    - name: http
      protocol: TCP
      port: 80
      targetPort: 80
  externalIPs:
    - 10.0.0.88   

# æŸ¥çœ‹
[root@master1 ExternalIP]#kubectl get svc
NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP   4d4h
my-service   ClusterIP   10.108.156.228   10.0.0.88     80/TCP    60s

# åˆ›å»ºdeployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-test
spec:
  replicas: 3
  selector:
    matchLabels:
      app: rs-test
  template:
    metadata:
      labels:
        app: rs-test
        app.kubernetes.io/name: MyApp
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1


[root@master1 loadBalancer] #kubectl apply -f controller-deployment-test.yaml 
deployment.apps/deployment-test created

# æŸ¥çœ‹ep
[root@master1 loadBalancer]#kubectl get ep
NAME         ENDPOINTS                                      AGE
kubernetes   10.0.0.201:6443                                4d4h
my-service   10.244.1.88:80,10.244.2.44:80,10.244.3.99:80   11m

# åœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ·»åŠ ip
ip a a 10.0.0.88 dev eth0:1

# éªŒè¯æ•ˆæžœ
[root@master1 ExternalIP]#curl 10.0.0.88
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: deployment-test-74b7f7d459-j4fx6, ServerIP: 10.244.2.44!
```



### Serviceç®¡ç†



#### åˆ›å»º Service æ–¹å¼è¯´æ˜Ž

å¯¹äºŽServiceçš„åˆ›å»ºæœ‰ä¸¤ç§æ–¹æ³•ï¼š

- å‘½ä»¤è¡Œæ–¹æ³•
- YAML æ–‡ä»¶æ–¹æ³•



##### å‘½ä»¤è¡Œçš„æ–¹å¼

```bash
# åˆ›å»ºå‘½ä»¤1ï¼šï¼ˆå•ç‹¬åˆ›å»ºä¸€ä¸ªserviceæœåŠ¡ï¼‰
kubectl create service [flags] NAME [--tcp=port:targetPort] [--dry-run]

# flagså‚æ•°è¯¦è§£ï¼š
clusterip   Create a ClusterIP service.å°†é›†ç¾¤ä¸“ç”¨æœåŠ¡æŽ¥å£
nodeport     åˆ›å»ºä¸€ä¸ª NodePort service.å°†é›†ç¾¤å†…éƒ¨æœåŠ¡ä»¥ç«¯å£å½¢å¼å¯¹å¤–æä¾›
loadbalancer åˆ›å»ºä¸€ä¸ª LoadBalancer service.ä¸»è¦é’ˆå¯¹å…¬æœ‰äº‘æœåŠ¡
externalname Create an ExternalName service.å°†é›†ç¾¤å¤–éƒ¨æœåŠ¡å¼•å…¥é›†ç¾¤å†…éƒ¨

# åˆ›å»ºå‘½ä»¤2ï¼šï¼ˆé’ˆå¯¹ä¸€ä¸ªå·²å­˜åœ¨çš„deploymentã€podã€ReplicaSetç­‰åˆ›å»ºä¸€ä¸ªserviceï¼‰
kubectl expose (-f FILENAME | TYPE NAME) [--port=port] [--protocol=TCP|UDP|SCTP] [--target-port=number-or-name] [--name=name] [--external-ip=external-ip-of-service] [--type=type] [options]

# å‚æ•°è¯¦è§£
--port=''            #è®¾å®šserviceå¯¹å¤–çš„ç«¯å£ä¿¡æ¯
--target-port=''     #è®¾å®šå®¹å™¨çš„ç«¯å£,é»˜è®¤å’Œserviceçš„ç«¯å£ç›¸åŒ    
--type=''            #è®¾å®šç±»åž‹ï¼Œæ”¯æŒå››ç§ï¼šClusterIP(é»˜è®¤), NodePort, LoadBalancer,ExternalName    
--cluster-ip=''      #è®¾å®šå¯¹å¤–çš„ClusterIPåœ°å€
--name=''            #åˆ›å»ºserviceå¯¹å¤–çš„svcåç§°

# åˆ›å»ºå‘½ä»¤3ï¼šï¼ˆåˆ›å»ºè‡ªä¸»å¼Podæ—¶åŠ¨åˆ›å»ºServiceï¼‰
kubectl run <Pod_name> --image é•œåƒ --expose --port <å®¹å™¨ç«¯å£>

# æŸ¥çœ‹å‘½ä»¤
kubectl get svc

# åˆ é™¤service
kubectl delete svc <svc_name> [ -n <namespace>[] [--all]
```





##### æ–‡ä»¶æ–¹å¼

è¯­æ³•è§£æž

```yaml
apiVersion: v1
kind: Service
metadata:
  name: ...
  namespace: ...
  labels:
    key1: value1
    key2: value2
spec:
  type: <string>                    # serviceç±»åž‹ï¼Œé»˜è®¤ä¸ºClusterIP
  selector: <map[string]string>     # æŒ‡å®šç”¨äºŽè¿‡æ»¤å‡ºserviceæ‰€ä»£ç†çš„åŽç«¯podçš„æ ‡ç­¾ï¼ŒæŒ‡æ”¯æŒç­‰å€¼ç±»åž‹çš„æ ‡ç­¾é€‰æ‹©å™¨
  ports:                            # Serviceçš„ç«¯å£å¯¹è±¡åˆ—è¡¨
  - name: <string>                  # ç«¯å£åç§°ï¼Œéœ€è¦ä¿è¯å”¯ä¸€æ€§
    protocol: <string>              # åè®®ï¼Œç›®å‰ä»…æ”¯æŒTCPã€UDPå’ŒSCTPï¼Œé»˜è®¤ä¸ºTCP
    port: <integer>                 # Serviceç«¯å£å·
    targetPort: <string>            # åŽç«¯Podçš„ç«¯å£å·æˆ–åç§°ï¼Œåç§°éœ€ç”±Podä¸­çš„è§„èŒƒå®šä¹‰
    nodePort: <integer>             # èŠ‚ç‚¹ç«¯å£å·ï¼Œä»…ä½¿ç”¨NodePortå’ŒLoadBalancerlç±»åž‹ï¼ŒèŒƒå›´ï¼š30000-32768ï¼Œå»ºè®®ç³»ç»Ÿåˆ†é…
  - name: <string>
    ...
  clusterIP: <string>               # æŒ‡å®šServiceçš„é›†ç¾¤IPï¼Œå»ºè®®ä¸æŒ‡å®šè€Œç”±ç³»ç»Ÿåˆ†é…
  internalTrafficPolicy: <string>   # å†…éƒ¨æµé‡ç­–ç•¥å¤„ç†æ–¹å¼ï¼ŒLocalè¡¨ç¤ºç”±å½“å‰èŠ‚ç‚¹å¤„ç†ï¼ŒClusterè¡¨ç¤ºå‘é›†ç¾¤èŒƒå›´è°ƒåº¦ï¼Œé»˜è®¤                                         Cluster
  externalTrafficPolicy: <string>   # å¤–éƒ¨æµé‡ç­–ç•¥å¤„ç†æ–¹å¼ï¼Œé»˜è®¤ä¸ºClusterï¼Œå½“ä¸ºLocalæ—¶ï¼Œè¡¨ç¤ºç”±å½“å‰èŠ‚ç‚¹å¤„ç†ï¼Œæ€§èƒ½å¥½ï¼Œä½†æ—                                        è´Ÿè½½å‡è¡¡åŠŸèƒ½ï¼Œä¸”å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯çœŸå®žIPï¼ŒClusterè¡¨ç¤ºå‘é›†ç¾¤èŒƒå›´è°ƒåº¦ï¼Œå’ŒLocalç›¸åï¼ŒåŸºäºŽ                                       æ€§èƒ½åŽŸå› ï¼Œç”Ÿäº§æ›´å»ºè®®Localï¼Œæ­¤æ–¹å¼åªæ”¯æŒtypeæ˜¯NodePortå’ŒLoadBalancerç±»åž‹æˆ–è€…                                         ExternalIps
  loadBalancerIP: <string>          # å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ä½¿ç”¨çš„IPåœ°å€ï¼Œä»…é€‚ç”¨äºŽLoadBalancerï¼Œæ­¤å­—æ®µæœªæ¥å¯èƒ½åˆ é™¤
  externalName: <string>            # å¤–éƒ¨æœåŠ¡åç§°ï¼Œè¯¥åç§°å°†ä½œä¸ºServiceçš„DNS CNAMEå€¼
  externalIPs: <[]string>           # ç¾¤é›†ä¸­çš„èŠ‚ç‚¹å°†æŽ¥å—æ­¤æœåŠ¡çš„æµé‡çš„IPåœ°å€åˆ—è¡¨ã€‚è¿™äº›IPä¸ç”±Kubernetesç®¡ç†ã€‚ç”¨æˆ·è´Ÿè´£ç¡®ä¿                                       æµé‡åˆ°è¾¾å…·æœ‰æ­¤ IP çš„èŠ‚ç‚¹ã€‚å¸¸è§çš„æ˜¯ä¸å±žäºŽ Kubernetes ç³»ç»Ÿçš„å¤–éƒ¨è´Ÿè½½å‡è¡¡å™¨ï¼Œæ³¨æ„ï¼š                                       æ­¤IPå’ŒTypeç±»åž‹æ— å…³
```



#### ClusterIP Serviceå®žçŽ°

#####  å•ç«¯å£åº”ç”¨

```yaml
# å¦‚æžœåŸºäºŽèµ„æºé…ç½®æ–‡ä»¶åˆ›å»ºèµ„æºï¼Œä¾èµ–äºŽåŽç«¯podçš„æ ‡ç­¾ï¼Œæ‰å¯ä»¥å…³è”åŽç«¯çš„èµ„æº
# å‡†å¤‡å¤šä¸ªåŽç«¯Podå¯¹è±¡
[root@master1 loadBalancer] # kubectl create deployment myweb --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
deployment.apps/myweb created

# æŸ¥çœ‹æ•ˆæžœ
[root@master1 service] # kubectl get pod --show-labels 
NAME                     READY   STATUS    RESTARTS   AGE     LABELS
myweb-565cb68445-6c928   1/1     Running   0          5m49s   app=myweb,pod-template-hash=565cb68445
myweb-565cb68445-fc6xg   1/1     Running   0          5m49s   app=myweb,pod-template-hash=565cb68445
myweb-565cb68445-rsbs6   1/1     Running   0          5m49s   app=myweb,pod-template-hash=565cb68445


# åˆ›å»ºserviceå¯¹è±¡
[root@master1 service] # vim service-clusterip-test.yaml
apiVersion: v1
kind: Service
metadata: 
  name: service-clusterip-test
spec:
  #type: ClusterIP            # é»˜è®¤å³ä¸ºClusterIPï¼Œæ­¤è¡Œå¯çœç•¥
  #clusterIP: 192.168.64.100  #å¯ä»¥æ‰‹åŠ¨æŒ‡å®šIPï¼Œä½†ä¸€èˆ¬éƒ½æ˜¯ç³»ç»Ÿè‡ªåŠ¨æŒ‡å®šè€Œæ— éœ€æ·»åŠ æ­¤è¡Œ
  selector:
    app: myweb                # å¼•ç”¨ä¸Šé¢deploymentçš„åç§°ï¼ŒåŒæ—¶ä¹Ÿæ˜¯Podçš„Lableä¸­çš„appå€¼
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80

[root@master1 service] # kubectl apply -f service-clusterip-test.yaml 
service/service-clusterip-test created

# æŸ¥çœ‹
[root@master1 service] # kubectl get svc
NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
kubernetes               ClusterIP   10.96.0.1        <none>        443/TCP   4d7h
my-service               ClusterIP   10.108.156.228   10.0.0.88     80/TCP    158m
service-clusterip-test   ClusterIP   10.102.58.175    <none>        80/TCP    4s

# æµ‹è¯•
[root@master1 service]# curl 10.102.58.175
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: myweb-565cb68445-rsbs6, ServerIP: 10.244.1.89!

```



##### å¤šç«¯å£å®žçŽ°

æœ‰å¾ˆå¤šæœåŠ¡éƒ½ä¼šåŒæ—¶å¼€å¯å¤šä¸ªç«¯å£ï¼Œå…¸åž‹çš„æ¯”å¦‚ï¼štomcatä¸‰ä¸ªç«¯å£ï¼ŒæŽ¥ä¸‹æ¥å®žçŽ°åˆ›å»ºå¤šç«¯å£çš„Service

```yaml
# åˆ›å»ºå¤šç«¯å£Service
[root@master1 service] # vim service-clusterip-multi-port.yaml
apiVersion: v1
kind: Service
metadata:
  name: service-clusterip-multi-port
spec:
  selector:
    app: myweb
  ports:
  - name: http
    protocol: TCP
    port: 80
  - name: https
    protocol: TCP
    port: 443
#å…³é”®ç‚¹ï¼šåªèƒ½æœ‰ä¸€ä¸ªportså±žæ€§ï¼Œå¤šäº†ä¼šè¦†ç›–,æ¯ä¸€ä¸ªå­portå¿…é¡»æœ‰ä¸€ä¸ªnameå±žæ€§,ç”±äºŽserviceæ˜¯åŸºäºŽæ ‡ç­¾çš„æ–¹å¼æ¥ç®¡ç†podçš„ï¼Œæ‰€ä»¥å¿…é¡»æœ‰æ ‡ç­¾é€‰æ‹©å™¨ 
```



#### NodePort Serviceå®žçŽ°

NodePortä¼šåœ¨æ‰€æœ‰èŠ‚ç‚¹ä¸»æœºä¸Šï¼Œå‘å¤–æš´éœ²ä¸€ä¸ªæŒ‡å®šæˆ–è€…éšæœºçš„ç«¯å£ï¼Œä¾›é›†ç¾¤å¤–éƒ¨çš„åº”ç”¨èƒ½å¤Ÿè®¿é—®

æ³¨æ„ï¼šnodePort å±žæ€§èŒƒå›´ä¸º 30000-32767ï¼Œä¸”type ç±»åž‹åªæ”¯æŒ NodePortæˆ–LoadBalancer

**æ³¨æ„: æ­¤æ–¹å¼æœ‰å®‰å…¨é£Žé™©ï¼Œç«¯å£ä¸ºéžæ ‡ç«¯å£,è€Œä¸”æ€§èƒ½ä¸€èˆ¬,ç”Ÿäº§ä¸€èˆ¬è¾ƒå°‘ä½¿ç”¨**

**ç”Ÿäº§ä¸­å»ºè®®ä½¿ç”¨Ingressæ–¹å¼å‘å¤–æš´éœ²é›†ç¾¤å†…çš„æœåŠ¡**



##### externaltrafficpolicy çš„ä¸¤ç§ç­–ç•¥

![image-20241223203921088](D:\git_repository\cyber_security_learning\markdown_img\image-20241223203921088.png)

- **clusteræ¨¡å¼**
  - æ­¤ä¸ºé»˜è®¤æ¨¡å¼
  - é›†ç¾¤å¤–çš„è¯·æ±‚æŠ¥æ–‡ä»ŽæŸèŠ‚ç‚¹çš„NodePortè¿›å…¥ï¼Œè¯¥èŠ‚ç‚¹çš„Serviceå¯ä»¥å°†è¯·æ±‚æµé‡è°ƒåº¦åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šçš„Podï¼Œæ— éœ€å…³å¿ƒPodåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Š
  - **Kube-proxyè½¬å‘å¤–éƒ¨è¯·æ±‚æ—¶ä¼šæ›¿æ¢æŽ‰æŠ¥æ–‡çš„æºIPå’Œç›®æ ‡IP,ç›¸å½“äºŽFULLNAT**
  - è¿”å›žæ—¶éœ€è¦ä»ŽåŽŸè·¯è¿”å›ž,å¯èƒ½ä¼šäº§ç”Ÿè·¨èŠ‚ç‚¹çš„è·ƒç‚¹è½¬å‘æµé‡
  - æ­¤æ¨¡å¼è´Ÿè½½å‡è¡¡æ•ˆæžœå¥½ï¼Œå› ä¸ºæ— è®ºå®¹å™¨å®žä¾‹æ€Žä¹ˆåˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ƒéƒ½ä¼šè½¬å‘è¿‡åŽ»ã€‚
  - ä½†æ˜¯ç”±äºŽå¤šäº†ä¸€æ¬¡è½¬å‘ï¼Œæ€§èƒ½ä¼šæŸå¤±
  - å¦‚æžœæ˜¯NodePortç±»åž‹,Podæ— æ³•èŽ·å–å¤–éƒ¨å®¢æˆ·ç«¯çœŸå®žå®¢æˆ·ç«¯IP

![image-20241223204317595](D:\git_repository\cyber_security_learning\markdown_img\image-20241223204317595.png)



- **localæ¨¡å¼**
  - é›†ç¾¤å¤–çš„è¯·æ±‚æŠ¥æ–‡ä»ŽæŸèŠ‚ç‚¹çš„NodePortè¿›å…¥,è¯¥èŠ‚ç‚¹çš„Service åªä¼šå°†è¯·æ±‚æµé‡è°ƒåº¦åˆ°å½“å‰èŠ‚ç‚¹ä¸Š çš„Pod
  - **å¤–éƒ¨è¯·æ±‚æµé‡åªå‘ç»™æœ¬æœºçš„Pod, Kube-proxyè½¬å‘æ—¶åªä¼šæ›¿æ¢æŽ‰æŠ¥æ–‡çš„ç›®æ ‡IP,å³åªå®žçŽ°DNAT**
  - å³ï¼šå®¹å™¨æ”¶åˆ°çš„æŠ¥æ–‡ï¼Œçœ‹åˆ°æºIPåœ°å€è¿˜æ˜¯ç”¨æˆ·çš„åŽŸæœ‰ IP  
  - æ­¤æ¨¡å¼çš„è´Ÿè½½å‡è¡¡æ•ˆæžœä¸æ˜¯å¾ˆå¥½ï¼Œå› ä¸ºä¸€æ—¦å®¹å™¨å®žä¾‹åˆ†å¸ƒåœ¨å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå®ƒåªè½¬å‘ç»™æœ¬æœºï¼Œä¸äº§ç”Ÿ è·¨èŠ‚ç‚¹çš„è·ƒç‚¹è½¬å‘æµé‡ã€‚
  - ä½†æ˜¯å°‘äº†ä¸€æ¬¡è½¬å‘ï¼Œæ€§èƒ½ä¼šç›¸å¯¹å¥½
  - ç”±äºŽæœ¬æœºä¸ä¼šè·¨èŠ‚ç‚¹è½¬å‘æŠ¥æ–‡ï¼Œæ‰€ä»¥è¦æƒ³å¯¹æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„å®¹å™¨å®žçŽ°è´Ÿè½½å‡è¡¡ï¼Œå°±éœ€è¦å€ŸåŠ©å¤–éƒ¨çš„ Loadbalanceræ¥å®žçŽ°
  - å› æ­¤ä½¿ç”¨Local æ¨¡å¼,ä¸€èˆ¬ä¼šä½¿ç”¨ LoadBalancer Service ç±»åž‹ç»“åˆ Loadbalancer å®žçŽ°





##### nodePortå®žçŽ°

```yaml
[root@master1 service] # vim service-nodeport.yaml
apiVersion: v1
kind: Service
metadata:
  name: service-nodeport
spec:
  type: NodePort
  #externalTrafficPolicy: Local # é»˜è®¤å€¼ä¸ºCluster,å¦‚æžœæ˜¯Localåªèƒ½è¢«å½“å‰è¿è¡ŒPodçš„èŠ‚ç‚¹å¤„ç†æµé‡ï¼Œå¹¶>ä¸”å¯ä»¥èŽ·å–å®¢æˆ·ç«¯çœŸå®žIP
  selector:
    app: myweb
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 30066   # æŒ‡å®šå›ºå®šç«¯å£(30000-32767)ï¼Œä½¿ç”¨NodePortç±»åž‹ä¸”ä¸æŒ‡å®šnodeportï¼Œä¼šè‡ªåŠ¨åˆ†é…éšæœºç«¯å£å‘å¤–æš´éœ²

[root@master1 service] # kubectl apply -f service-nodeport.yaml 
service/service-nodeport created

# æŸ¥çœ‹
[root@master1 service] # kubectl get svc
NAME                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service-nodeport         NodePort    10.104.196.234   <none>        80:30066/TCP   33s

# é»˜è®¤externalTrafficPolicy: Clusterï¼Œæ‰€ä»¥ä½¿ç”¨è®¿é—®é›†ç¾¤ä¸­ä»»æ„ä¸€ä¸ªç‰©ç†èŠ‚ç‚¹çš„åœ°å€éƒ½å¯ä»¥ï¼Œä½†æ˜¯Podä¸Šçœ‹ä¸åˆ°çœŸå®žå®¢æˆ·ç«¯åœ°å€
[root@master1 service]#curl 10.0.0.202:30066
kubernetes pod-test v0.1!! ClientIP: 10.244.1.0, ServerName: myweb-565cb68445-6c928, ServerIP: 10.244.2.46!
[root@master1 service]#curl 10.0.0.202:30066
kubernetes pod-test v0.1!! ClientIP: 10.244.1.1, ServerName: myweb-565cb68445-rsbs6, ServerIP: 10.244.1.90!
[root@master1 service]#curl 10.0.0.202:30066
kubernetes pod-test v0.1!! ClientIP: 10.244.1.0, ServerName: myweb-565cb68445-fc6xg, ServerIP: 10.244.3.101!
[root@master1 

# æŒ‡å®šexternalTrafficPolicy: Localï¼ŒPodèƒ½çœ‹åˆ°å®¢æˆ·ç«¯çœŸå®žIPï¼ŒåŒæ—¶æ¯ä¸ªèŠ‚ç‚¹åªèƒ½è°ƒåº¦è¯¥èŠ‚ç‚¹ä¸Šçš„Pod
[root@master1 service] #curl 10.0.0.202:30066
kubernetes pod-test v0.1!! ClientIP: 10.0.0.201, ServerName: myweb-565cb68445-rsbs6, ServerIP: 10.244.1.90!
[root@master1 service] #curl 10.0.0.202:30066
kubernetes pod-test v0.1!! ClientIP: 10.0.0.201, ServerName: myweb-565cb68445-rsbs6, ServerIP: 10.244.1.90!
[root@master1 service] #curl 10.0.0.202:30066
kubernetes pod-test v0.1!! ClientIP: 10.0.0.201, ServerName: myweb-565cb68445-rsbs6, ServerIP: 10.244.1.90!
[root@master1 service] #curl 10.0.0.203:30066
kubernetes pod-test v0.1!! ClientIP: 10.0.0.201, ServerName: myweb-565cb68445-6c928, ServerIP: 10.244.2.46!
[root@master1 service] #curl 10.0.0.203:30066
kubernetes pod-test v0.1!! ClientIP: 10.0.0.201, ServerName: myweb-565cb68445-6c928, ServerIP: 10.244.2.46!
[root@master1 service] #curl 10.0.0.203:30066
kubernetes pod-test v0.1!! ClientIP: 10.0.0.201, ServerName: myweb-565cb68445-6c928, ServerIP: 10.244.2.46!

# å°†deployç¼©å®¹è‡³1
[root@master1 service] #kubectl scale deployment myweb --replicas=1
deployment.apps/myweb scaled

# æŸ¥çœ‹
[root@master1 service]#kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS      AGE   IP             NODE    NOMINATED NODE   READINESS GATES
myweb-565cb68445-fc6xg   1/1     Running   1 (17m ago)   13h   10.244.3.101   node3   <none>           <none>

# è®¿é—®node1ä¸Šçš„ç«¯å£
[root@master1 service]#curl 10.0.0.202:30066
é˜»å¡ž...
```



#### LoadBalancer Serviceå®žçŽ°

![image-20241224093229587](D:\git_repository\cyber_security_learning\markdown_img\image-20241224093229587.png)

åªæœ‰Kubernetesé›†ç¾¤æ˜¯éƒ¨ç½²åœ¨ä¸€ä¸ªLBaaSå¹³å°ä¸Šä¸”æŒ‡ä¾›æœ‰ä¸€ä¸ªé›†ç¾¤å¤–éƒ¨çš„LBæ‰é€‚åˆä½¿ç”¨LoadBalancer 

ä¸€èˆ¬çš„å…¬æœ‰äº‘éƒ½æä¾›äº†æ­¤åŠŸèƒ½,ä½†å¯èƒ½ä¼šæœ‰è´¹ç”¨äº§ç”Ÿ

å¦‚æžœåœ¨ä¸€ä¸ªéžå…¬ç”¨äº‘çš„æ™®é€šçš„Kubernetesé›†ç¾¤ä¸Šï¼Œåˆ›å»ºäº†ä¸€ä¸ªLoadBalancerç±»åž‹çš„Serviceï¼Œä¸€èˆ¬æƒ…å†µ é»˜è®¤çŽ¯å¢ƒä¸­æ˜¯æ²¡æœ‰LBaaSçš„ï¼Œæ‰€ä»¥ä¼šå¯¼è‡´ç”±äºŽæ‰¾ä¸åˆ°æŒ‡å®šçš„æœåŠ¡ï¼ŒçŠ¶æ€ä¼šä¸€ç›´å¤„äºŽ Pending çŠ¶æ€

å¦‚æžœåœ¨ç§æœ‰äº‘çŽ¯å¢ƒä¸­ä½¿ç”¨ LoadBalancer Serviceï¼Œå¯ä»¥ä½¿ç”¨äº‘åŽŸç”Ÿçš„å¼€æºé¡¹ç›®å®žçŽ°è´Ÿè½½å‡è¡¡å™¨ï¼Œæ¯”å¦‚ **OpenELB, MetalLB** å®žçŽ°

Loadbalancer å¯ä»¥èŽ·å–ç”¨æˆ·è®¿é—®çš„Serviceå¯¹åº”çš„Podåœ¨å“ªä¸ªèŠ‚ç‚¹ä¸Š,å› æ­¤æ”¯æŒexternaltrafficpolicyä¸º Localæ¨¡å¼çš„æµé‡è½¬å‘



##### OpenElBå®žçŽ°LBaasæœåŠ¡



OpenELB æ˜¯ä¸€ä¸ªå¼€æºçš„äº‘åŽŸç”Ÿè´Ÿè½½å‡è¡¡å™¨å®žçŽ°

å¯ä»¥åœ¨åŸºäºŽè£¸é‡‘å±žæœåŠ¡å™¨ã€è¾¹ç¼˜ä»¥åŠè™šæ‹ŸåŒ–çš„ Kubernetes çŽ¯å¢ƒä¸­ä½¿ç”¨ LoadBalancer ç±»åž‹çš„ Service å¯¹ å¤–æš´éœ²æœåŠ¡ã€‚

OpenELB é¡¹ç›®æœ€åˆç”±å›½å†…é’äº‘çš„ KubeSphere ç¤¾åŒºå‘èµ·ï¼Œç›®å‰å·²ä½œä¸º CNCF æ²™ç®±é¡¹ç›®åŠ å…¥ CNCF åŸºé‡‘ ä¼šï¼Œç”± OpenELB å¼€æºç¤¾åŒºç»´æŠ¤ä¸Žæ”¯æŒã€‚

å®˜ç½‘: 

```ABAP
https://openelb.io/
https://github.com/openelb/openelb
```



OpenELB ä¹Ÿæ‹¥æœ‰ä¸¤ç§ä¸»è¦å·¥ä½œæ¨¡å¼ï¼š**Layer2** æ¨¡å¼å’Œ **BGP** æ¨¡å¼ã€‚OpenELB çš„ BGP æ¨¡å¼ç›®å‰æš‚ä¸æ”¯æŒ IPv6ã€‚

å› ä¸º OpenELB æ˜¯é’ˆå¯¹è£¸é‡‘å±žæœåŠ¡å™¨è®¾è®¡çš„ï¼Œå› æ­¤å¦‚æžœæ˜¯åœ¨äº‘çŽ¯å¢ƒä¸­éƒ¨ç½²ï¼Œéœ€è¦æ³¨æ„æ˜¯å¦æ»¡è¶³æ¡ä»¶ã€‚

æ ¸å¿ƒåŠŸèƒ½

- BGPæ¨¡å¼å’ŒäºŒå±‚ç½‘ç»œæ¨¡å¼ä¸‹çš„è´Ÿè½½å‡è¡¡
- ECMPè·¯ç”±å’Œè´Ÿè½½å‡è¡¡
- IPåœ°å€æ± ç®¡ç†
- åŸºäºŽCRDæ¥ç®¡ç†BGPé…ç½®

**æ³¨æ„: æ­¤åº”ç”¨å¯èƒ½ä¸æ”¯æŒ Openstack ç­‰äº‘çŽ¯å¢ƒ**



##### OpenELB å®žçŽ°

éƒ¨ç½²å’Œä½¿ç”¨OpenELB

```bash
[root@master1 ~]#wget https://raw.githubusercontent.com/openelb/openelb/master/deploy/openelb.yaml

# å¯ç”¨
[root@master1 openelb] #kubectl apply -f openelb.yaml 
namespace/openelb-system created
customresourcedefinition.apiextensions.k8s.io/bgpconfs.network.kubesphere.io created
customresourcedefinition.apiextensions.k8s.io/bgppeers.network.kubesphere.io created
customresourcedefinition.apiextensions.k8s.io/eips.network.kubesphere.io created
serviceaccount/openelb-admission created
serviceaccount/openelb-controller created
serviceaccount/openelb-speaker created
role.rbac.authorization.k8s.io/openelb-admission created
clusterrole.rbac.authorization.k8s.io/openelb-admission created
clusterrole.rbac.authorization.k8s.io/openelb-controller created
clusterrole.rbac.authorization.k8s.io/openelb-speaker created
rolebinding.rbac.authorization.k8s.io/openelb-admission created
clusterrolebinding.rbac.authorization.k8s.io/openelb-admission created
clusterrolebinding.rbac.authorization.k8s.io/openelb-controller created
clusterrolebinding.rbac.authorization.k8s.io/openelb-speaker created
secret/memberlist created
service/openelb-controller created
deployment.apps/openelb-controller created
daemonset.apps/openelb-speaker created
job.batch/openelb-admission-create created
job.batch/openelb-admission-patch created
validatingwebhookconfiguration.admissionregistration.k8s.io/openelb-admission created

# æŸ¥çœ‹åˆ›å»ºçš„CRDè‡ªå®šä¹‰èµ„æºç±»åž‹
[root@master1 openelb]#kubectl get crd
NAME                             CREATED AT
bgpconfs.network.kubesphere.io   2024-12-24T01:49:36Z
bgppeers.network.kubesphere.io   2024-12-24T01:49:36Z
eips.network.kubesphere.io       2024-12-24T01:49:36Z

# ç¡®è®¤openelb-manager Podå·²ç»å¤„äºŽRunningçŠ¶æ€ï¼Œä¸”å®¹å™¨å·²ç»Ready
[root@master1 openelb]#kubectl get pods -n openelb-system 
NAME                                  READY   STATUS      RESTARTS   AGE
openelb-admission-create-r28c5        0/1     Completed   0          69s
openelb-admission-patch-h8g6n         0/1     Completed   2          69s
openelb-controller-7f8788f446-22j7d   1/1     Running     0          69s
openelb-speaker-f462b                 1/1     Running     0          69s
openelb-speaker-mzhpb                 1/1     Running     0          69s
openelb-speaker-phzd8                 1/1     Running     0          69s
openelb-speaker-tb2ms                 1/1     Running     0          69s

#åˆ›å»ºäº†ä¸€ä¸ªEipèµ„æºå¯¹è±¡ï¼Œå®ƒæä¾›äº†ä¸€ä¸ªåœ°å€æ± ç»™LoadBalancer Serviceä½¿ç”¨
[root@master1 openelb] #vim service-loadbalancer-eip-pool.yaml
apiVersion: network.kubesphere.io/v1alpha2
kind: Eip
metadata:
  name: eip-pool
  annotations:
    eip.openelb.kubesphere.io/is-default-eip: "true" #æŒ‡å®šå½“å‰EIPä½œä¸ºå‘LoadBalancer Serveråˆ†ç‰‡åœ°>å€æ—¶ä½¿ç”¨çš„é»˜è®¤çš„eipå¯¹è±¡
spec:
  address: 10.0.0.10-10.0.0.50 #æŒ‡å®šæŽ’é™¤ä¸»æœºèŠ‚ç‚¹ä¹‹å¤–çš„åœ°å€èŒƒå›´ï¼Œå¯ä»¥ä½¿ç”¨å•ä¸ªIPæˆ–è€…å¸¦æœ‰æŽ©ç é•¿åº¦çš„>ç½‘ç»œåœ°å€
  protocol: layer2 #æŒ‡å®šOpenELBæ¨¡å¼ï¼Œæ”¯æŒbgp,layer2å’Œvipä¸‰ç§ï¼Œé»˜è®¤bgp
  interface: eth0 #OpenELBä¾¦å¬ARPæˆ–NDPè¯·æ±‚æ—¶ä½¿ç”¨çš„ç½‘ç»œæŽ¥å£åç§°ï¼Œä»…layer2æ¨¡å¼ä¸‹æœ‰æ•ˆ
  disable: false
  
  
# åˆ›å»ºèµ„æº
[root@master1 openelb]#kubectl apply -f service-loadbalancer-eip-pool.yaml 
eip.network.kubesphere.io/eip-pool created

# æŸ¥çœ‹ç»“æžœ
[root@master1 openelb]#kubectl get eip
NAME       CIDR                  USAGE   TOTAL
eip-pool   10.0.0.10-10.0.0.50           41

# åˆ›å»ºDeploymentå’ŒLoadBalancerç±»åž‹çš„Serviceï¼Œæµ‹è¯•åœ°å€æ± æ˜¯å¦èƒ½ç»™Serviceåˆ†é…LoadBalancerIP
[root@master1 openelb] #kubectl create deployment myapp --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
deployment.apps/myapp created

[root@master1 openelb]#vim service-loadbalancer-lbaas.yaml
apiVersion: v1
kind: Service
metadata:
  name: service-loadbalancer-lbaas
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: myapp
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80

# åº”ç”¨
[root@master1 openelb ]#kubectl apply -f service-loadbalancer-lbaas.yaml 
service/service-loadbalancer-lbaas created

# æŸ¥çœ‹serviceèµ„æºå¯¹è±¡myappæ˜¯å¦è‡ªåŠ¨èŽ·å¾—äº†EXTERNAL IPï¼ŒèŽ·å–å¤±è´¥...
[root@master1 openelb]#kubectl get svc service-loadbalancer-lbaas 
NAME                         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE
service-loadbalancer-lbaas   LoadBalancer   10.97.215.163   <pending>     80:30214/TCP   8m41s
```





##### metalLBå®žçŽ°LBaaSæœåŠ¡



![image-20241224101508876](D:\git_repository\cyber_security_learning\markdown_img\image-20241224101508876.png)



å®˜ç½‘

```ABAP
https://github.com/metallb/metallb
https://metallb.universe.tf/
```

MetalLB æ˜¯ç”± Google å¼€æºæä¾›

MetalLB åŠŸèƒ½å®žçŽ°ä¾èµ–äºŽä¸¤ç§æœºåˆ¶

- Address Allocation åœ°å€åˆ†é…ï¼šåŸºäºŽç”¨æˆ·é…ç½®çš„åœ°å€æ± ï¼Œä¸ºç”¨æˆ·åˆ›å»ºçš„LoadBalanceråˆ†é…IPåœ°å€, å¹¶é…ç½®åœ¨èŠ‚ç‚¹ä¸Š
- External Announcement å¯¹å¤–å…¬å‘Šï¼šè®©é›†ç¾¤å¤–éƒ¨çš„ç½‘ç»œäº†è§£æ–°åˆ†é…çš„Påœ°å€ï¼ŒMetalLBä½¿ç”¨ARPã€ NDPæˆ–BGPå®žçŽ°



MetallB å¯é…ç½®ä¸ºåœ¨äºŒå±‚æ¨¡å¼æˆ–BGPæ¨¡å¼ä¸‹è¿è¡Œ

- äºŒå±‚æ¨¡å¼(ARP/NDP)
  - LoadBalancer IPåœ°å€é…ç½®åœ¨æŸä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¹¶ä½¿ç”¨ARP(IPv4)æˆ–NDP(IPv6)å¯¹å¤–å…¬å‘Š
  - æ‹¥æœ‰LoadBalancer IP åœ°å€çš„èŠ‚ç‚¹å°†æˆä¸ºServiceæµé‡çš„æƒŸä¸€å…¥å£ï¼Œå¹¶åœ¨èŠ‚ç‚¹æ•…éšœæ—¶è‡ªåŠ¨è¿›è¡Œæ•…éšœè½¬ ç§»
  - å¹¶æœªçœŸæ­£å®žçŽ°è´Ÿè½½å‡è¡¡ï¼Œå­˜åœ¨æ€§èƒ½ç“¶é¢ˆï¼Œä¸”æ•…éšœè½¬ç§»å­˜åœ¨ç§’çº§çš„å»¶è¿Ÿ
- BGPæ¨¡å¼
  - é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸Žæœ¬åœ°ç½‘ç»œä¸­çš„BGP Routerå»ºç«‹BGPå¯¹ç­‰ä¼šè¯ï¼Œé€šå‘ŠLoadBalancer IPï¼Œä»Žè€Œå‘ŠçŸ¥Routerå¦‚ä½•è¿›è¡Œæµé‡è·¯ç”±
  - å¯ä»¥å®žçŽ°è·¨å¤šä¸ªèŠ‚ç‚¹çš„çœŸæ­£æ„ä¹‰ä¸Šçš„è´Ÿè½½å‡è¡¡



**æ³¨æ„: æ­¤åº”ç”¨å¯èƒ½ä¸æ”¯æŒ Openstack ç­‰äº‘çŽ¯å¢ƒ**



##### MetalLB å®žçŽ°

```bash
# éƒ¨ç½²MetalLBè‡³Kubernetesé›†ç¾¤
METALLB_VERSION='v0.14.7'
wget https://raw.githubusercontent.com/metallb/metallb/${METALLB_VERSION}/config/manifests/metallb-native.yaml

# åº”ç”¨
[root@master1 metalLB]# kubectl apply -f metallb-native.yaml 
namespace/metallb-system created
customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io created
customresourcedefinition.apiextensions.k8s.io/communities.metallb.io created
customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io created
customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io created
serviceaccount/controller created
serviceaccount/speaker created
role.rbac.authorization.k8s.io/controller created
role.rbac.authorization.k8s.io/pod-lister created
clusterrole.rbac.authorization.k8s.io/metallb-system:controller created
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created
rolebinding.rbac.authorization.k8s.io/controller created
rolebinding.rbac.authorization.k8s.io/pod-lister created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created
configmap/metallb-excludel2 created
secret/metallb-webhook-cert created
service/metallb-webhook-service created
deployment.apps/controller created
daemonset.apps/speaker created
validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration created

# æŸ¥çœ‹CRDèµ„æºç±»åž‹
[root@master1 metalLB]#kubectl get crd
NAME                           CREATED AT
bfdprofiles.metallb.io         2024-12-24T02:27:38Z
bgpadvertisements.metallb.io   2024-12-24T02:27:38Z
bgppeers.metallb.io            2024-12-24T02:27:38Z
communities.metallb.io         2024-12-24T02:27:38Z
ipaddresspools.metallb.io      2024-12-24T02:27:38Z
l2advertisements.metallb.io    2024-12-24T02:27:38Z
servicel2statuses.metallb.io   2024-12-24T02:27:38Z

# åˆ›å»ºåœ°å€æ± 
# æ³¨æ„: IPAddressPool å¿…é¡»ä½¿ç”¨Kuberetesé›†ç¾¤èŠ‚ç‚¹çš„IPåœ°å€æ®µ
[root@master1 metalLB]#vim service-metallb-IPAddressPool.yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: localip-pool
  namespace: metallb-system
spec:
  addresses:
  - 10.0.0.10-10.0.0.50
  autoAssign: true
  avoidBuggyIPs: true
  
# åº”ç”¨
[root@master1 metalLB]#kubectl apply -f service-metallb-IPAddressPool.yaml
ipaddresspool.metallb.io/localip-pool created

# åˆ›å»ºäºŒå±‚å…¬å‘Šæœºåˆ¶
[root@master1 metalLB]#vim service-metallb-L2Advertisement.yaml
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: localip-pool-l2a
  namespace: metallb-system
spec:
  ipAddressPools:
  - localip-pool
  interfaces:
  - eth0 # ç”¨äºŽå‘é€å…è´¹ARPå…¬å‘Š

[root@master1 metalLB]#kubectl apply -f service-metallb-L2Advertisement.yaml 
l2advertisement.metallb.io/localip-pool-l2a created

# åˆ›å»ºServiceå’ŒDeploymentï¼Œæµ‹è¯•åœ°å€æ± æ˜¯å¦èƒ½ç»™Serviceåˆ†é…LoadBalancer IP
[root@master1 ~]#kubectl create deployment myapp --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3

[root@master1 metalLB]# vim service-loadbalancer-lbaas.yaml
apiVersion: v1
kind: Service
metadata:
  name: service-loadbalancer-lbaas
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: myapp
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
    
# åº”ç”¨
[root@master1 metalLB]#kubectl apply -f service-loadbalancer-lbaas.yaml 
service/service-loadbalancer-lbaas created

# æŸ¥çœ‹
[root@master1 metalLB]#kubectl get svc service-loadbalancer-lbaas 
NAME                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
service-loadbalancer-lbaas   LoadBalancer   10.111.219.193   10.0.0.10     80:32248/TCP   7s

# ä»Žå¤–éƒ¨è®¿é—®æµ‹è¯•
[root@master1 metalLB]#curl 10.0.0.10
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: myapp-547df679bb-57pnm, ServerIP: 10.244.2.51!
```



##### å®žé™…ç”Ÿäº§çŽ¯å¢ƒ

- é€šå¸¸ä½¿ç”¨å…¬æœ‰äº‘æä¾›çš„LBaaSï¼Œè€Œä¸æ˜¯è¿™ç§å¼€æºçš„è´Ÿè½½å‡è¡¡å™¨ï¼ŒMetalLBæœ‰Bugï¼Œåœ¨Localæ¨¡å¼ä¸‹ï¼Œæ²¡æœ‰è´Ÿè½½å‡è¡¡æ•ˆæžœ
- æ›´å¤šçš„æ˜¯ä½¿ç”¨ingressè¿›è¡Œå¯¹å¤–æš´éœ²







#### ExternalName Serviceå®žçŽ°

Service ä¸ä»…å¯ä»¥å®žçŽ°Kubernetesé›†ç¾¤å†…Podåº”ç”¨ä¹‹é—´çš„ç›¸äº’è®¿é—®ä»¥åŠä»Žé›†ç¾¤å¤–éƒ¨è®¿é—®é›†ç¾¤ä¸­çš„Pod

è¿˜å¯ä»¥æ”¯æŒåšä¸ºå¤–éƒ¨æœåŠ¡çš„ä»£ç†å®žçŽ°é›†ç¾¤ä¸­Podè®¿é—®é›†ç¾¤å¤–çš„æœåŠ¡

```ABAP
Pod --> Service_name --> External Name --> å¤–éƒ¨DNS --> å¤–éƒ¨æœåŠ¡IP
```



**Serviceä»£ç†Kuberneteså¤–éƒ¨åº”ç”¨çš„ä½¿ç”¨åœºæ™¯**

- åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­Pod å¸Œæœ›ä½¿ç”¨æŸä¸ªå›ºå®šçš„åç§°è€ŒéžIPåœ°å€è¿›è¡Œè®¿é—®é›†ç¾¤å¤–éƒ¨çš„æœåŠ¡
- ä½¿ç”¨ServiceæŒ‡å‘å¦ä¸€ä¸ªNamespaceä¸­æˆ–å…¶å®ƒKubernetesé›†ç¾¤ä¸­çš„æœåŠ¡
- æŸä¸ªé¡¹ç›®æ­£åœ¨è¿ç§»è‡³Kubernetesé›†ç¾¤ï¼Œä½†æ˜¯ä¸€éƒ¨åˆ†æœåŠ¡ä»ç„¶åœ¨é›†ç¾¤å¤–éƒ¨ï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨serviceä»£ç†è‡³k8sé›†ç¾¤å¤–éƒ¨çš„æœåŠ¡



**ä½¿ç”¨ExternalName Serviceå®žçŽ°ä»£ç†å¤–éƒ¨æœåŠ¡ï¼ˆå…¬ç½‘IPçš„æœåŠ¡ï¼‰**

```bash
[root@master1 service]# vim service-externalname-web.yaml
apiVersion: v1
kind: Service
metadata:
  name: svc-externalname-web
  namespace: default
spec:
  type: ExternalName
  externalName: www.mysticalrecluse.com
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
    nodePort: 0
  selector: {}

# åº”ç”¨
[root@master1 service]#kubectl apply -f service-externalname-web.yaml 
service/svc-externalname-web created

# æŸ¥çœ‹
#æ³¨æ„: serviceæ²¡æœ‰Cluster-IP,å³ä¸ºæ— å¤´æœåŠ¡Headless Service
[root@master1 service]#kubectl get svc
NAME                   TYPE           CLUSTER-IP   EXTERNAL-IP               PORT(S)   AGE
svc-externalname-web   ExternalName   <none>       www.mysticalrecluse.com   80/TCP    7s

# åˆ›å»ºä¸€ä¸ªæµ‹è¯•podï¼Œè§£æžåŸŸå
[root@master1 service]# kubectl run pod-$RANDOM --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --command -- /bin/bash
If you don't see a command prompt, try pressing enter.
root@pod-18379 /# 
root@pod-18379 /# host svc-externalname-web
svc-externalname-web.default.svc.cluster.local is an alias for www.mysticalrecluse.com.
root@pod-18379 /# ping -c1 svc-externalname-web
PING svc-externalname-web (101.35.250.82): 56 data bytes
64 bytes from 101.35.250.82: seq=0 ttl=127 time=30.567 ms
```



**ä½¿ç”¨è‡ªå»ºçš„Endpointå®žçŽ°åŸºäºŽClusterIPç±»åž‹çš„Serviceä»£ç†é›†ç¾¤å¤–éƒ¨æœåŠ¡**

- æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªEndpointsèµ„æºå¯¹è±¡ï¼Œç›´æŽ¥æŠŠå¤–éƒ¨ç«¯ç‚¹çš„IPåœ°å€ï¼Œæ”¾å…¥å¯ç”¨åœ°å€åˆ—è¡¨
- é¢å¤–åˆ›å»ºä¸€ä¸ªä¸å¸¦selectorçš„åŒåçš„Serviceå¯¹è±¡

```bash
# åœ¨k8sé›†ç¾¤å¤–å®‰è£…redis
[root@master1 ~]#apt update && apt -y install redis
[root@master1 ~]#vim /etc/redis/redis.conf
bind 0.0.0.0
[root@master1 ~]#systemctl restart redis

[root@master1 service]# vim service-endpoints.yaml
apiVersion: v1
kind: Endpoints
metadata:
  name: service-redis  # å’Œä¸‹é¢çš„serviceå¿…é¡»åŒå
  namespace: default
subsets:
  - addresses:
    - ip: 10.0.0.131  # å¤–éƒ¨æœåŠ¡çš„FQDNæˆ–IP
    ports:
    - name: reids
      port: 6379
      protocol: TCP
---
apiVersion: v1
kind: Service
metadata:
  name: service-redis  # å’Œä¸Šé¢çš„endpointså¿…é¡»åŒå
  namespace: default
spec:
  type: ClusterIP
  clusterIP: "None"
  ports:
  - name: redis
    port: 6379
    protocol: TCP
    targetPort: 6379

  
# åº”ç”¨
[root@master1 service]#kubectl apply -f service-endpoints.yaml 
endpoints/service-redis created
service/service-redis created

# æŸ¥çœ‹
[root@master1 service]#kubectl get svc
NAME                   TYPE           CLUSTER-IP   EXTERNAL-IP               PORT(S)    AGE
kubernetes             ClusterIP      10.96.0.1    <none>                    443/TCP    26m
service-redis          ClusterIP      None         <none>                    6379/TCP   38s

[root@master1 service]#kubectl get ep service-redis 
NAME            ENDPOINTS         AGE
service-redis   10.0.0.131:6379   76s

# æµ‹è¯•è®¿é—®ï¼Œä½¿ç”¨serviceååšä¸ºåŸŸåï¼Œè®¿é—®å¤–éƒ¨redis
[root@master1 service]#kubectl run pod-$RANDOM --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/admin-box:v0.1 -it --rm --command -- /bin/bash
If you don't see a command prompt, try pressing enter.
root@pod-28779 /# nc service-redis 6379
info
```





#### ä¼šè¯ç²˜æ»ž

kubernetesçš„Serviceé»˜è®¤æ˜¯æŒ‰ç…§è½®è¯¢æœºåˆ¶è¿›è¡Œè½¬å‘è‡³åŽç«¯çš„å¤šä¸ªpod

å¦‚æžœç”¨æˆ·è¯·æ±‚æœ‰ä¸€å®šçš„ä¼šè¯è¦æ±‚ï¼Œå³å¸Œæœ›åŒä¸€ä¸ªå®¢æˆ·æ¯æ¬¡æ€»æ˜¯èƒ½è®¿é—®åŒä¸€ä¸ªpodçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ serviceçš„**affinityæœºåˆ¶**æ¥å®žçŽ°

å®ƒèƒ½å°†åŒä¸€ä¸ªå®¢æˆ·ç«¯çš„è¯·æ±‚å§‹ç»ˆè½¬å‘è‡³åŒä¸€ä¸ªåŽç«¯Podå¯¹è±¡ï¼Œå®ƒæ˜¯ç”±**kube-proxyçš„ipvsæœºåˆ¶**æ¥å®žçŽ°çš„ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œserviceæ‰€æä¾›çš„ä¼šè¯ç²˜æ€§æ•ˆæžœé»˜è®¤åœ¨**10800s(3å°æ—¶)**åŽä¼šé‡æ–°è°ƒåº¦,è€Œä¸”ä»…èƒ½åŸºäºŽå®¢æˆ·ç«¯IP è¿›è¡Œè¯†åˆ«ï¼Œè°ƒåº¦ç²’åº¦è¾ƒç²—



**å±žæ€§è§£æž**

```yaml
# å±žæ€§ä¿¡æ¯
service.spec.sessionAffinity  # å®šä¹‰ç²˜æ€§ä¼šè¯çš„ç±»åž‹ï¼Œå¯ä¸º None å’Œ ClientIP,é»˜è®¤å€¼ä¸ºNoneå³ä¸å¼€å¯ä¼šè¯æ²¾æ»ž
service.spec.sessionAffinityConfig.clinetIP.timeoutSeconds # é…ç½®ä¼šè¯ä¿æŒæ—¶é•¿ï¼Œé»˜è®¤10800sï¼ŒèŒƒå›´1-86400

# é…ç½®æ ¼å¼
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
```



**å®žçŽ°ä¼šè¯ç²˜æ»ž**

```yaml
# åˆ›å»ºdeploymentèµ„æº
[root@master1 service] # kubectl create deployment myweb --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
deployment.apps/myweb created

[root@master1 service] # kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
myweb-565cb68445-2sqx9   1/1     Running   0          3s
myweb-565cb68445-8z59d   1/1     Running   0          3s
myweb-565cb68445-nts2b   1/1     Running   0          3s

# åˆ›å»ºServiceèµ„æºå¯¹è±¡
[root@master1 service] # vim service-session.yaml
apiVersion: v1
kind: Service
metadata:
  name: service-session
spec:
  type: LoadBalancer
  ports:
  - port: 80
  selector:
    app: myweb
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 1800 # é»˜è®¤å€¼ä¸º10800ï¼Œå³3å°æ—¶

# åº”ç”¨
[root@master1 service]  #kubectl apply -f service-session.yaml 
service/service-session created

# åŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼Œå¤šæ¬¡è®¿é—®éƒ½æ˜¯è°ƒåº¦åˆ°åŒä¸€ä¸ªPodä¸Š
[root@master1 service] # curl 10.109.193.1
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: myweb-565cb68445-8z59d, ServerIP: 10.244.2.52!
[root@master1 service] # curl 10.109.193.1
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: myweb-565cb68445-8z59d, ServerIP: 10.244.2.52!
[root@master1 service] # curl 10.109.193.1
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: myweb-565cb68445-8z59d, ServerIP: 10.244.2.52!
```



#### ipvsæ¨¡å¼

![image-20241224143822632](D:\git_repository\cyber_security_learning\markdown_img\image-20241224143822632.png)



ipvsä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ›å»ºä¸€ä¸ªåä¸ºkube-ipvs0çš„è™šæ‹ŸæŽ¥å£ï¼Œå¹¶å°†é›†ç¾¤æ‰€æœ‰Serviceå¯¹è±¡çš„ClusterIPå’ŒExternalIPéƒ½é…ç½®åœ¨è¯¥æŽ¥å£ï¼› æ‰€ä»¥æ¯å¢žåŠ ä¸€ä¸ªClusterIP æˆ–è€…ExternalIPï¼Œå°±ç›¸å½“äºŽä¸º kube-ipvs0 å…³è” äº†ä¸€ä¸ªåœ°å€ç½¢äº†ã€‚

kube-proxyä¸ºæ¯ä¸ªserviceç”Ÿæˆä¸€ä¸ªè™šæ‹ŸæœåŠ¡å™¨( IPVS Virtual Server)çš„å®šä¹‰ã€‚



**åŸºæœ¬æµç¨‹ï¼š**

- å½“å‰èŠ‚ç‚¹æŽ¥æ”¶åˆ°å¤–éƒ¨æµé‡åŽï¼Œå¦‚æžœè¯¥æ•°æ®åŒ…æ˜¯äº¤ç»™å½“å‰èŠ‚ç‚¹ä¸Šçš„clusterIPï¼Œåˆ™ä¼šç›´æŽ¥å°†æ•°æ®åŒ…äº¤ç»™ kube-ipvs0ï¼Œè€Œè¿™ä¸ªæŽ¥å£æ˜¯å†…æ ¸è™šæ‹Ÿå‡ºæ¥çš„ï¼Œè€Œkube-proxyå®šä¹‰çš„VSç›´æŽ¥å…³è”åˆ°kube-ipvs0ä¸Šã€‚
- å¦‚æžœæ˜¯æœ¬åœ°èŠ‚ç‚¹podå‘é€çš„è¯·æ±‚ï¼ŒåŸºæœ¬ä¸Šå±žäºŽæœ¬åœ°é€šä¿¡ï¼Œæ•ˆçŽ‡æ˜¯éžå¸¸é«˜çš„ã€‚
- é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™é‡Œçš„ipvsä½¿ç”¨çš„æ˜¯natè½¬å‘æ¨¡åž‹ï¼Œè€Œä¸”æ”¯æŒæ›´å¤šçš„åŽç«¯è°ƒåº¦ç®—æ³•ã€‚ä»…ä»…åœ¨æ¶‰åŠåˆ°æºåœ°å€è½¬ æ¢çš„åœºæ™¯ä¸­ï¼Œä¼šæ¶‰åŠåˆ°æžå°‘é‡çš„iptablesè§„åˆ™(åº”è¯¥ä¸ä¼šè¶…è¿‡20æ¡)
- å¯¹äºŽKubernetesæ¥è¯´ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ”¯æŒçš„è§„åˆ™æ˜¯ iptablesï¼Œå¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å¯¹ä»£ç†æ¨¡å¼è¿›è¡Œæ›´æ”¹ï¼Œ å› ä¸ºè¿™äº›è§„åˆ™éƒ½æ˜¯**åŸºäºŽkube-proxy**æ¥å®šåˆ¶çš„ï¼Œæ‰€ä»¥ï¼Œå¦‚æžœè¦æ›´æ”¹ä»£ç†æ¨¡å¼çš„è¯ï¼Œå°±éœ€è¦è°ƒæ•´kube-proxy çš„å±žæ€§ã€‚



**æ³¨æ„ï¼šKubernetes-v1.29ç‰ˆæœ¬åŽï¼Œä¸å†ä½¿ç”¨iptablesï¼Œè€Œä½¿ç”¨nftables frameworkï¼Œå·¥å…·ä½¿ç”¨nft  list ruleset æŸ¥çœ‹**



æ›´æ”¹kube-proxyä¸ºIPVSæ¨¡å¼æ–¹æ³•è¯´æ˜Ž

```bash
#æ–¹æ³•1ï¼š åœ¨é›†ç¾¤åˆ›å»ºçš„æ—¶å€™ï¼Œä¿®æ”¹kubeadm-init.yml æ·»åŠ å¦‚ä¸‹é…ç½®ï¼Œæ­¤æ–¹æ³•æ˜¯ç”Ÿäº§ä¸­æŽ¨è
kubeadm config print init-defaults > kubeadm-init.yaml

# åœ¨æ–‡ä»¶æœ€åŽé¢æ·»åŠ ä¸€ä¸‹å‡ è¡Œ
---
apiVersion: kubeproxy.config.Kubernetes.io/v1alpha1
kind: KubeProxyConfiguration
featureGates:
  SupportIPVSProxyMode: true
mode: ipvs

# åœ¨åˆå§‹é˜¶æ®µå¯èƒ½ä¿®æ”¹çš„å‚æ•°
apiVersion: kubeadm.k8s.io/v1beta3
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: 192.168.0.100
  bindPort: 6443
nodeRegistration:
  criSocket: unix:///run/cri-dockerd.sock                  # é…ç½®cri-dockerdæ’æ§½
  name: master1
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/control-plane

---
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
kubernetesVersion: "v1.30.2"
controlPlaneEndpoint: "master1.mystical.org:6443"            # ä¿®æ”¹æŽ§åˆ¶å¹³é¢åŸŸå
networking:
  podSubnet: "10.244.0.0/16"                                 # ä¿®æ”¹é›†ç¾¤ç½‘è·¯é…ç½®ï¼Œpodç½‘ç»œ
  serviceSubnet: "10.96.0.0/12"                              # serviceç½‘ç»œ
imageRepository: registry.aliyuncs.com/google_containers     # ä¿®æ”¹é•œåƒä»“åº“ï¼ˆå¦‚ä½¿ç”¨å›½å†…é•œåƒï¼‰
apiServer:
  extraArgs:
    authorization-mode: Node,RBAC


# æ›´æ”¹å¥½é…ç½®æ–‡ä»¶åŽï¼Œæ‰§è¡Œå‘½ä»¤åˆå§‹åŒ–
kubeadm init --config=kubeadm-init.yaml --token-ttl --upload-certs

# éªŒè¯é›†ç¾¤çŠ¶æ€
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

# çœ‹é›†ç¾¤æ˜¯å¦æ­£å¸¸è¿è¡Œ
kubectl get nodes
kubectl get pods -n kube-system


# æ–¹æ³•2ï¼šåœ¨æµ‹è¯•çŽ¯å¢ƒä¸­ï¼Œä¸´æ—¶ä¿®æ”¹ä¸€ä¸‹configmapä¸­proxyçš„åŸºæœ¬å±žæ€§ï¼Œæ­¤æ–¹å¼åœ¨æµ‹è¯•çŽ¯å¢ƒä¸­æŽ¨èä½¿ç”¨
[root@master1 ~] # kubectl edit cm  kube-proxy -n kube-system
...
mode: "ipvs"  #ä¿®æ”¹æ­¤è¡Œï¼Œé»˜è®¤ä¸ºç©ºâ€â€œè¡¨ç¤ºiptablesæ¨¡å¼
...

# æ›´æ”¹åŽï¼Œéœ€è¦ç¨ç­‰ä¸€ä¼šå„¿æ‰èƒ½ç”Ÿæ•ˆ

# å¦‚æžœæƒ³ç«‹å³ç”Ÿæ•ˆï¼Œéœ€è¦é‡å¯æ‰€æœ‰çš„kube-proxy podå¯¹è±¡
[root@master1 ~]#kubectl get ds -n kube-system 
NAME         DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE
kube-proxy   4         4         4       4            4           kubernetes.io/os=linux   5d1h

[root@master1 ~]#kubectl get pod -n kube-system -l k8s-app=kube-proxy
NAME               READY   STATUS    RESTARTS        AGE
kube-proxy-7fc2q   1/1     Running   5 (5h50m ago)   5d1h
kube-proxy-7slb9   1/1     Running   5 (5h49m ago)   5d1h
kube-proxy-n66cg   1/1     Running   5 (5h49m ago)   5d1h
kube-proxy-vkqh5   1/1     Running   5 (5h47m ago)   5d1h

# é‡å¯pod
[root@master1 ~]#kubectl rollout restart daemonset -n kube-system kube-proxy 
daemonset.apps/kube-proxy restarted

# é‡å¯æ–¹å¼2ï¼šåˆ é™¤åŽŸpodï¼Œä½¿damonsetè‡ªåŠ¨é‡æ–°åˆ›å»º
kubectl delete pod -n kube-system -l k8s-app=kube-proxy

# å®‰è£…ipvsadmæŸ¥çœ‹æ•ˆæžœ
[root@master1 ~]#apt update && apt -y install ipvsadm
[root@master1 ~]#ipvsadm -Ln
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  172.17.0.1:30433 rr persistent 1800
  -> 10.244.1.99:80               Masq    1      0          0         
  -> 10.244.2.52:80               Masq    1      0          0         
  -> 10.244.3.106:80              Masq    1      0          0         
TCP  10.0.0.201:30433 rr persistent 1800
  -> 10.244.1.99:80               Masq    1      0          0         
  -> 10.244.2.52:80               Masq    1      0          0         
  -> 10.244.3.106:80              Masq    1      0          0 
  ......
```



### ç»¼åˆæ¡ˆä¾‹ï¼šWordpress

```yaml
[root@master1 controller] # vim wordpress-mysql.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: demo
---
apiVersion: v1
kind: Service
metadata:
  name: wordpress
  namespace: demo
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  selector:
    app: wordpress
  ports:
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wordpress
  template:
    metadata:
      labels:
        app: wordpress
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/wordpress:php8.2-apache
        name: wordpress
        env:
        - name: WORDPRESS_DB_HOST
          value: mysql.demo.svc.cluster.local.
        - name: WORDPRESS_DB_USER
          value: wordpress
        - name: WORDPRESS_DB_PASSWORD
          value: "123456"
        - name: WORDPRESS_DB_NAME
          value: wordpress
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: demo
spec:
  ports:
  - port: 3306
    protocol: TCP
    targetPort: 3306
  selector:
    app: mysql

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/mysql:8.0.29-oracle
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "123456"
        - name: MYSQL_DATABASE
          value: "wordpress"
        - name: MYSQL_USER
          value: wordpress
        - name: MYSQL_PASSWORD
          value: "123456"
          
# æŸ¥çœ‹svc
[root@master1 controller]#kubectl get svc -n demo 
NAME        TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE
mysql       ClusterIP      10.111.9.21   <none>        3306/TCP       23s
wordpress   LoadBalancer   10.97.65.76   10.0.0.11     80:30371/TCP   23s

# æµè§ˆå™¨è®¿é—®
http://10.0.0.11/
```



![image-20241224154414207](D:\git_repository\cyber_security_learning\markdown_img\image-20241224154414207.png)









## KubernetesåŸŸåè§£æž

### æœåŠ¡å‘çŽ°æœºåˆ¶

åœ¨ä¼ ç»Ÿçš„ç³»ç»Ÿéƒ¨ç½²ä¸­ï¼ŒæœåŠ¡è¿è¡Œåœ¨ä¸€ä¸ªå›ºå®šçš„å·²çŸ¥çš„ IP å’Œç«¯å£ä¸Šï¼Œå¦‚æžœä¸€ä¸ªæœåŠ¡éœ€è¦è°ƒç”¨å¦å¤–ä¸€ä¸ªæœ åŠ¡ï¼Œå¯ä»¥é€šè¿‡åœ°å€ç›´æŽ¥è°ƒç”¨

åœ¨Kubernetes é›†ç¾¤ä¸­ï¼ŒåŸºäºŽclusteripåœ°å€æ¥è®¿é—®æ¯serviceæ˜¯å¾ˆä¸æ–¹ä¾¿çš„

è™½ç„¶é€šè¿‡é…ç½®DNSå¯ä»¥å®žçŽ°åç§°è§£æžæ¥è®¿é—®ï¼Œä½†æ˜¯åœ¨Kubernetesé›†ç¾¤ä¸­ï¼ŒæœåŠ¡å®žä¾‹çš„å¯åŠ¨å’Œé”€æ¯æ˜¯å¾ˆé¢‘ ç¹çš„ï¼ŒæœåŠ¡åœ°å€åœ¨åŠ¨æ€çš„å˜åŒ–ï¼Œæ‰€ä»¥ä¼ ç»Ÿçš„æ–¹å¼é…ç½®DNSè§£æžè®°å½•å°±å¾ˆä¸å‹å¥½äº†ã€‚



å°†è¯·æ±‚å‘é€åˆ°åŠ¨æ€å˜åŒ–çš„æœåŠ¡å®žä¾‹ä¸Šï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªæ­¥éª¤æ¥å®žçŽ°ï¼š

- **æœåŠ¡æ³¨å†Œ** â€” åˆ›å»ºæœåŠ¡å®žä¾‹åŽï¼Œä¸»åŠ¨å°†å½“å‰æœåŠ¡å®žä¾‹çš„ä¿¡æ¯ï¼Œå­˜å‚¨åˆ°ä¸€ä¸ªé›†ä¸­å¼çš„æœåŠ¡ç®¡ç†ä¸­å¿ƒã€‚
- **æœåŠ¡å‘çŽ°** â€” å½“AæœåŠ¡éœ€è¦æ‰¾æœªçŸ¥çš„BæœåŠ¡æ—¶ï¼Œå…ˆåŽ»æœåŠ¡ç®¡ç†ä¸­å¿ƒæŸ¥æ‰¾BæœåŠ¡åœ°å€ï¼Œç„¶åŽæ ¹æ®è¯¥åœ°å€æ‰¾åˆ°BæœåŠ¡



**Kubernetesä¸»è¦æœ‰ä¸¤ç§æœåŠ¡å‘çŽ°æœºåˆ¶ï¼š**

- çŽ¯å¢ƒå˜é‡
- DNSè§£æž







### çŽ¯å¢ƒå˜é‡

å¯¹äºŽçŽ¯å¢ƒå˜é‡æ¥è¯´ï¼Œå®ƒä¸»è¦æœ‰ä¸¤ç§å®žçŽ°æ–¹å¼

- **Kubernetes ServiceçŽ¯å¢ƒå˜é‡**

  - Kubernetesä¸ºæ¯ä¸ªServiceèµ„æºç”ŸæˆåŒ…æ‹¬ä»¥ä¸‹å½¢å¼çš„çŽ¯å¢ƒå˜é‡åœ¨å†…ä¸€ç³»åˆ—çŽ¯å¢ƒå˜é‡
  - åœ¨åŒä¸€åç§°ç©ºé—´ä¸­åŽç»­åˆ›å»ºçš„Podå¯¹è±¡éƒ½ä¼šè‡ªåŠ¨æ‹¥æœ‰è¿™äº›å˜é‡
  - æ³¨æ„ï¼šæ­¤æ–¹å¼ä¸æ”¯æŒServiceçš„åŠ¨æ€å˜åŒ–ï¼Œå³åœ¨åˆ›å»ºPodå¯¹è±¡ä»¥åŽï¼ŒServiceçš„å˜åŒ–ä¸ä¼šç”Ÿæˆç›¸å…³çš„ çŽ¯å¢ƒå˜é‡ï¼Œç”Ÿäº§æ­¤æ–¹å¼ä¸å¤ªå¸¸è§
  - Serviceç›¸å…³çŽ¯å¢ƒå˜é‡å½¢å¼å¦‚ä¸‹

  ```bash
  {SVCNAME}_SERVICE_HOST {SVCNAME}_PORT
  
  # æ¯”å¦‚ï¼šdefaultåç§°ç©ºé—´åˆ›å»ºåä¸ºtestçš„Serviceï¼Œdefaultåç§°ç©ºé—´ä¸‹çš„æ¯ä¸ªPodå†…éƒ¨ä¼šè¢«è‡ªåŠ¨æ³¨å…¥ å’Œserviceç›¸å…³çš„å˜é‡
  TEST_SERVICE_HOST=ClusterIP
  TEST_PORT=tcp://ClusterIP:80
  ```

  ```yaml
  # æ³¨æ„ï¼šå¦‚æžœå…ˆåˆ›å»ºPodï¼Œç„¶åŽå…³è”åˆ°Serviceæ˜¯ä¸ç”Ÿæ•ˆçš„
  # ä¸€å®šè¦å…ˆåˆ›å»ºServiceï¼Œåœ¨åˆ›å»ºServiceä¸‹çš„podèµ„æºç±»åž‹æˆ–è€…deployç­‰ï¼Œæ‰ä¼šçœ‹åˆ°çŽ¯å¢ƒå˜é‡
  
  
  # ç›¸å…³å®žéªŒ
  åˆ›å»ºservice
  [root@master1 controller]#kubectl create svc clusterip myweb --tcp=80:80
  service/myweb created
  
  # åˆ›å»ºç›¸å…³svcä¸‹çš„deployment
  apiVersion: apps/v1
  kind: Deployment
  metadata:
    labels:
      app: myweb                            # å¿…é¡»æ˜¯myweb,å› ä¸ºsvcæ˜¯myweb
    name: myweb
  spec:
    progressDeadlineSeconds: 600
    replicas: 3
    revisionHistoryLimit: 10
    selector:
      matchLabels:
        app: myweb
    template:
      metadata:
        labels:
          app: myweb
      spec:
        containers:
        - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
          imagePullPolicy: IfNotPresent
          name: pod-test
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
  
  # åº”ç”¨
  [root@master1 controller] # kubectl apply -f myweb-deploy-test1.yaml
  deployment.apps/myweb created
  
  # æŸ¥çœ‹
  [root@master1 controller] # kubectl get pod
  NAME                     READY   STATUS        RESTARTS   AGE
  myweb-565cb68445-btlj8   1/1     Running       0          12s
  myweb-565cb68445-c8drb   1/1     Running       0          12s
  myweb-565cb68445-lj7bq   1/1     Running       0          12s
  
  [root@master1 controller] # kubectl get svc
  NAME         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
  kubernetes   ClusterIP   10.96.0.1        <none>        443/TCP   4h59m
  myweb        ClusterIP   10.104.153.124   <none>        80/TCP    13m
  
  
  # æŸ¥çœ‹podå†…çš„çŽ¯å¢ƒå˜é‡
  [root@master1 controller] # kubectl exec myweb-565cb68445-btlj8 -it -- /bin/sh
  [root@myweb-565cb68445-btlj8 /]# env
  KUBERNETES_SERVICE_PORT=443
  KUBERNETES_PORT=tcp://10.96.0.1:443
  HOSTNAME=myweb-565cb68445-btlj8
  MYWEB_SERVICE_HOST=10.104.153.124        # MYWEB_SERVICE_HOST
  SHLVL=1
  HOME=/root
  PS1=[\u@\h \w]\$ 
  MYWEB_SERVICE_PORT=80
  MYWEB_PORT=tcp://10.104.153.124:80       # MYWEB_PORT
  TERM=xterm
  MYWEB_PORT_80_TCP_ADDR=10.104.153.124
  KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
  MYWEB_SERVICE_PORT_80_80=80
  PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
  MYWEB_PORT_80_TCP_PORT=80
  
  ```



### COREDNS

#### CoreDNSä»‹ç»

![image-20241224164000953](D:\git_repository\cyber_security_learning\markdown_img\image-20241224164000953.png)



ä¸“ç”¨äºŽkubernetesé›†ç¾¤ä¸­çš„æœåŠ¡æ³¨å†Œå’Œå‘çŽ°çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯KubeDNSã€‚

kubeDNSè‡ªä»ŽKubernetesè¯žç”Ÿä»¥æ¥ï¼Œå…¶æ–¹æ¡ˆçš„å…·ä½“å®žçŽ°æ–¹æ¡ˆå‰åŽç»åŽ†äº†ä¸‰ä»£ï¼Œåˆ†åˆ«æ˜¯ SkyDNSã€ KubeDNSã€CoreDNSã€‚

Kubernetes-v1.3ä¹‹å‰ä½¿ç”¨SkyDNS, ä¹‹åŽåˆ°Kubernetes-v1.13ä¹‹å‰ä½¿ç”¨KubeDNS,å½“å‰é»˜è®¤ä½¿ç”¨ **CoreDNS**

CoreDNS æ˜¯ä¸€ä¸ªDNSæœåŠ¡å™¨ã€‚Goå®žçŽ°ï¼Œç”±äºŽå…¶çµæ´»æ€§ï¼Œå®ƒå¯ä»¥åœ¨å¤šç§çŽ¯å¢ƒä¸­ä½¿ç”¨ã€‚

CoreDNS æ˜¯ä¸€ä¸ªäº‘åŽŸç”Ÿè®¡ç®—åŸºé‡‘ä¼šæ¯•ä¸šçš„é¡¹ç›®ã€‚CoreDNSé€šè¿‡ Kubernetes æ’ä»¶ä¸Ž Kubernetes é›† æˆï¼Œæˆ–è€…é€šè¿‡etcdæ’ä»¶ä¸Žetcd é›†æˆ,å®žçŽ°æœåŠ¡å‘çŽ°

**CoreDNS å®˜æ–¹ç½‘ç«™**

```ABAP
https://coredns.io/
https://github.com/coredns/coredns
```





#### CoreDNSè§£æžæµç¨‹

CoreDNS é€šè¿‡è®¿é—®åä¸º kubernetes çš„ Service,æ‰¾åˆ° API Server è¿›è€Œè¿žæŽ¥åˆ° ETCD, ä»Žè€Œå®žçŽ° Kubernetessé›†ç¾¤ä¸­çš„Service,Endpoint,Pod ç­‰èµ„æºçš„æŸ¥æ‰¾

![image-20241224164328154](D:\git_repository\cyber_security_learning\markdown_img\image-20241224164328154.png)



- Client Pod **æŸ¥è¯¢è‡ªèº«çš„/etc/resolv.conf** æŒ‡å‘çš„DNSæœåŠ¡å™¨åœ°å€,æ­¤åœ°å€ä¸ºkube-dns serviceçš„åœ°å€, å³å°†è§£æžè¯·æ±‚è½¬å‘ç»™åä¸º kube-dnsçš„ service

  ```bash
  [root@master1 controller]#kubectl exec myweb-565cb68445-btlj8 -it -- /bin/sh
  [root@myweb-565cb68445-btlj8 /]# cat /etc/resolv.conf 
  nameserver 10.96.0.10      # COREDNSçš„svcåœ°å€
  search default.svc.cluster.local svc.cluster.local cluster.local wang.org
  options ndots:5
  ```

- kube-dns serviceä¼šå°†è¯·æ±‚è½¬å‘åˆ°åŽç«¯CoreDNS Pod,ä¸ºäº†DNSçš„é«˜å¯ç”¨,é€šå¸¸æœ‰ä¸¤ä¸ªCoreDNS Pod, å¹¶ä½äºŽkube-systemåç§°ç©ºé—´

  ```bash
  [root@master1 controller]#kubectl get svc -n kube-system
  NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
  kube-dns   ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   5d3h
  ```

- Coredns Pod æ ¹æ®Corefileçš„é…ç½®ä¼šè¿žæŽ¥åˆ°åœ¨defaultåç§°ç©ºé—´çš„åä¸ºkubernetesçš„service,è€Œ kubernetes serviceå¯¹åº”çš„Endpointsä¸ºæ‰€æœ‰kube-apiserver:6443çš„åœ°å€

  ```bash
  [root@master1 controller]#kubectl get svc -n kube-system
  NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE
  kube-dns   ClusterIP   10.96.0.10   <none>        53/UDP,53/TCP,9153/TCP   5d3h
  
  [root@master1 controller]#kubectl get ep
  NAME         ENDPOINTS                                        AGE
  kubernetes   10.0.0.201:6443                                  5h17m
  ```

- kubernetes service ç›‘è§†service IPçš„å˜åŠ¨ï¼Œç»´æŠ¤DNSè§£æžè®°å½•,å¹¶å°†å˜åŒ–å‘é€è‡³ETCDå®žçŽ°DNSè®°å½• çš„å­˜å‚¨

- CoreDNSæŸ¥è¯¢åˆ°service nameå¯¹åº”çš„IPåŽè¿”å›žç»™å®¢æˆ·ç«¯

- å¦‚æžœæŸ¥è¯¢çš„æ˜¯å¤–éƒ¨åŸŸåï¼Œ**CoreDNSæ— æ³•è§£æžï¼Œå°±è½¬å‘ç»™æŒ‡å®šçš„åŸŸåæœåŠ¡å™¨**ï¼Œ**ä¸€èˆ¬æ˜¯èŠ‚ç‚¹ ä¸Š/etc/resolv.confä¸­çš„æœåŠ¡å™¨è§£æž**

  ```bash
  # è¦ä½¿å…¶ç”Ÿæ•ˆï¼Œéœ€è¦åœ¨æ›´æ”¹corednsæ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„dnsåŽï¼Œæ›´æ–°corednsPod
  [root@master1 controller]#kubectl rollout restart deployment -n kube-system coredns 
  deployment.apps/coredns restarted
  ```







#### CoreDNSåŸŸåè§£æž

![image-20241224175717162](D:\git_repository\cyber_security_learning\markdown_img\image-20241224175717162.png)

Cluster DNSï¼ˆCoreDNSï¼‰æ˜¯Kubernetesé›†ç¾¤çš„å¿…å¤‡é™„ä»¶ï¼Œè´Ÿè´£ä¸ºKubernetesæä¾›åç§°è§£æžå’ŒæœåŠ¡å‘çŽ°

æ¯ä¸ªServiceèµ„æºå¯¹è±¡ï¼Œåœ¨**CoreDNSä¸Šéƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆå¦‚ä¸‹æ ¼å¼çš„åç§°ï¼Œç»“åˆè¯¥åç§°ä¼šç”Ÿæˆå¯¹åº”çš„ä¸€äº›ä¸åŒ ç±»åž‹çš„DNSèµ„æºè®°å½•**

```bash
<service>.<ns>.svc.<zone>
<service>ï¼š #å½“å‰Serviceå¯¹è±¡çš„åç§°
<ns>ï¼š      #å½“å‰Serviceå¯¹è±¡æ‰€å±žçš„åç§°ç©ºé—´
<zone>ï¼š    #å½“å‰Kubernetesé›†ç¾¤ä½¿ç”¨çš„åŸŸååŽç¼€ï¼Œé»˜è®¤ä¸ºâ€œcluster.localâ€pass
```

èŒƒä¾‹ï¼škubeadmå®‰è£…æ–¹å¼æ—¶æŸ¥çœ‹é»˜è®¤Zoneåç§°

```bash
[root@master1 ~]#kubeadm config print init-defaults |grep dns
dns: {}
  dnsDomain: cluster.local
```

CoreDNSä¼šæŒç»­ç›‘è§†API Serverä¸Šçš„Serviceèµ„æºå¯¹è±¡çš„å˜åŠ¨ï¼Œå¹¶å®žæ—¶åæ˜ åˆ°ç›¸å…³çš„DNSèµ„æºè®°å½•ä¸­

Podä¸­å„å®¹å™¨å†…éƒ¨é»˜è®¤ä¼šåœ¨å…¶ /etc/resolv.confä¸­ï¼Œå°†nameserveræŒ‡å‘CoreDNSç›¸å…³çš„Serviceçš„ ClusterIPï¼Œé»˜è®¤ä¸ºserviceç½‘æ®µçš„ç¬¬10ä¸ªIPï¼Œæ¯”å¦‚ï¼š10.96.0.10ï¼Œå…¶åŽé¢çš„Endpointæ˜¯corednså¯¹åº”çš„ Podçš„IPï¼Œæ­¤é…ç½®ç”±kubeletåˆ›å»ºPodæ—¶æ ¹æ®æŒ‡å®šçš„é…ç½®è‡ªåŠ¨æ³¨å…¥



èŒƒä¾‹ï¼šé›†ç¾¤ä¸Šçš„ä¸€ä¸ªéšæœºé€‰æ‹©çš„Podä¸­çš„å®¹å™¨æŸ¥çœ‹DNSå®¢æˆ·ç«¯é…ç½®

```bash
[root@master1 ~]#kubectl exec myweb-5d78b4dcbd-6rgv4 -- cat /etc/resolv.conf
nameserver 10.96.0.10
search default.svc.cluster.local svc.cluster.local cluster.local wang.org
options ndots:5

#ä¸Šè¿°searchå‚æ•°ä¸­æŒ‡å®šçš„DNSå„æœç´¢åŸŸï¼Œæ˜¯ä»¥æ¬¡åºæŒ‡å®šçš„å‡ ä¸ªåŸŸååŽç¼€ï¼Œå®ƒä»¬å„è‡ªçš„å¦‚ä¸‹æ‰€ç¤ºã€‚
#<ns>.svc.<zone>ï¼šé™„å¸¦æœ‰ç‰¹å®šåç§°ç©ºé—´çš„åŸŸåï¼Œä¾‹å¦‚default.svc.cluster.local
#svc. <zone>ï¼šé™„å¸¦äº†Kubernetesæ ‡è¯†Serviceä¸“ç”¨å­åŸŸsvcçš„åŸŸåï¼Œä¾‹å¦‚svc.cluster.localï¼›
<zone>ï¼šé›†ç¾¤æœ¬åœ°åŸŸåï¼Œä¾‹å¦‚cluster.localã€‚
#ndots:5ï¼Œè¡¨ç¤ºå¦‚æžœæ‰‹å·¥æŸ¥è¯¢æ—¶å€™ç»™çš„åŸŸååŒ…å«çš„ç‚¹â€œ.â€ä¸è¶…è¿‡5ä¸ªï¼Œé‚£ä¹ˆè¿›è¡ŒDNSæŸ¥æ‰¾æ—¶å°†ä½¿ç”¨éžå®Œå…¨é™å®š
åç§°ï¼Œå³ç”¨searchæŒ‡å®šçš„åŸŸåè¡¥å…¨
å³ <æ‰‹å·¥è¾“å…¥åŸŸå> æˆ–è€… <æ‰‹å·¥è¾“å…¥åŸŸå>.<search éƒ¨åˆ†ç»™å®šçš„åŸŸååŽç¼€>
å¦‚æžœä½ æŸ¥è¯¢çš„åŸŸååŒ…å«ç‚¹æ•°å¤§äºŽç­‰äºŽ5ï¼Œé‚£ä¹ˆDNSæŸ¥è¯¢ï¼Œé»˜è®¤ä¼šä½¿ç”¨ç»å¯¹åŸŸåè¿›è¡ŒæŸ¥è¯¢ã€‚
å³ <æ‰‹å·¥è¾“å…¥åŸŸå>
```



#### Service èµ„æºå¯¹åº”çš„DNSèµ„æºè®°å½•

åŸºäºŽDNSçš„æœåŠ¡å‘çŽ°ï¼Œå¯¹äºŽæ¯ä¸ªServiceå¯¹è±¡ï¼Œéƒ½ä¼šå…·æœ‰ä»¥ä¸‹3ä¸ªç±»åž‹çš„DNSèµ„æºè®°å½•**A/AAAA**ï¼Œ**PTR**å’Œ **SRV**

- æ ¹æ®ClusterIPçš„åœ°å€ç±»åž‹ï¼Œä¸ºIPv4ç”Ÿæˆå›ºå®šæ ¼å¼çš„ Aè®°å½•ï¼Œä¸ºIPv6ç”ŸæˆAAAAè®°å½•

```bash
<service>.<ns>.svc.<zone>. <ttl> IN A <cluster-ip>
<service>.<ns>.svc.<zone>. <ttl> IN AAAA <cluster-ip>
#ç¤ºä¾‹ï¼š
testapp.default.svc.cluster.local.
#æ³¨æ„ï¼šcluster.local æ˜¯é»˜è®¤zoneåç§°ï¼Œåœ¨åˆå§‹åŒ–Kubernetesé›†ç¾¤ä¸­ï¼Œè‡ªå·±é€šè¿‡dnsDomainå±žæ€§å®šåˆ¶çš„ã€‚
```

- å¯¹äºŽæ¯ä¸ªç»™å®šçš„Aè®°å½•æˆ–AAAAè®°å½•éƒ½è¦ç”ŸæˆPTRè®°å½•ï¼Œæ ¼å¼å¦‚ä¸‹æ‰€ç¤º

```bash
<d>.<c>.<b>.<a>.in-addr.arpa. <ttl> IN PTR <service>.<ns>.svc.<zone>.
h4.h3.h2.h1.g4.g3.g2.g1.f4.f3.f2.f1.e4.e3.e2.e1.d4.d3.d2.d1.c4.c3.c2.c1.b4.b3.b2
.b1.a4.a3.a2.a1.ip6.arpa <ttl> IN PTR <service>.<ns>.svc.<zone>.
```

- ä¸ºæ¯ä¸ªå®šä¹‰äº†åç§°çš„ç«¯å£ç”Ÿæˆä¸€ä¸ªSRVè®°å½•ï¼Œæœªå‘½åçš„ç«¯å£å·åˆ™ä¸å…·æœ‰è¯¥è®°å½•

```bash
_<port_name>._<proto>.<service>.<ns>.svc.<zone>. <ttl> IN SRV <weight> 
<priority> <port-number> <service>.<ns>.svc.<zone>.
```





#### Podçš„DNSè§£æžç­–ç•¥å’Œé…ç½®

Kubernetesæ”¯æŒåœ¨å•ä¸ªPodèµ„æºè§„èŒƒä¸Šè‡ªå®šä¹‰DNSè§£æžç­–ç•¥å’Œé…ç½®ï¼Œå¹¶ç»„åˆç”Ÿæ•ˆ

- **pod.spec.dnsPolicy**ï¼šè§£æžç­–ç•¥
  - **Default**ï¼šä»Žè¿è¡Œåœ¨çš„èŠ‚ç‚¹/etc/resolv.confç»§æ‰¿DNSåç§°è§£æžç›¸å…³çš„é…ç½®
  - **ClusterFirst**ï¼š**æ­¤ä¸ºé»˜è®¤å€¼**ï¼Œä¼˜å…ˆä½¿ç”¨é›†ç¾¤å†…DNSæœåŠ¡ä¸Šè§£æžé›†ç¾¤åŸŸå†…çš„åç§°ï¼Œå…¶ä»–åŸŸåçš„è§£æžåˆ™ äº¤ç”±ä»ŽèŠ‚ç‚¹/etc/resolv.confç»§æ‰¿çš„åç§°æœåŠ¡å™¨ å³ä½¿ç”¨Defaultç­–ç•¥
  - **ClusterFirstWithHostNet**ï¼šä¸“ç”¨äºŽåœ¨è®¾ç½®äº†hostNetworkï¼ˆä½¿ç”¨å®¿ä¸»æœºçš„ç½‘ç»œï¼‰çš„Podå¯¹è±¡ä¸Šå¹¶ä¸ä¼šä½¿ç”¨èŠ‚ç‚¹ç½‘ç»œçš„DNSï¼Œä»ç„¶ä½¿ç”¨çš„ClusterFirstç­–ç•¥
  - **None**ï¼šç”¨äºŽå¿½ç•¥Kubernetesé›†ç¾¤çš„é»˜è®¤è®¾å®šï¼Œè€Œä»…ä½¿ç”¨ç”±dnsConfigè‡ªå®šä¹‰çš„é…ç½®
- **pod.spec.dnsConfig**ï¼šåç§°è§£æžæœºåˆ¶
  - **nameservers <[]string>**ï¼šDNSåç§°æœåŠ¡å™¨åˆ—è¡¨ï¼Œé™„åŠ äºŽç”±dnsPolicyç”Ÿæˆçš„DNSåç§°æœåŠ¡å™¨ä¹‹åŽ
  - **searches <[]string>**ï¼šDNSåç§°è§£æžæ—¶çš„æœç´¢åŸŸï¼Œé™„åŠ ç”±äºŽdnsPolicyç”Ÿæˆçš„æœç´¢åŸŸä¹‹åŽ
  - **options <[]Object>**ï¼šDNSè§£æžé€‰é¡¹åˆ—è¡¨ï¼ŒåŒdnsPolicyç”Ÿæˆçš„è§£æžé€‰é¡¹åˆå¹¶æˆæœ€ç»ˆç”Ÿæ•ˆçš„å®šä¹‰



èŒƒä¾‹ï¼šdnsPolicy çš„ None çš„è§£æžç­–ç•¥

```yaml
# cat service-pod-with-dnspolicy.yaml
apiVersion: v1
kind: Pod
metadata:
  name: service-pod-with-dnspolicy
  namespace: default
spec:
  containers:
  - name: demo
    image: wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
  dnsPolicy: None
  dnsConfig:
    nameservers:
    - 10.96.0.10
    - 180.76.76.76
    - 233.6.6.6
    searches:
    - svc.cluster.local
    - cluster.local
    - wang.org
    options:
    - name: ndots
      value: "5"  #æ„å‘³ç€å¦‚æžœåŸŸåä¸­åªæœ‰5ä¸ªæˆ–æ›´å°‘çš„ç‚¹ï¼Œåˆ™ç³»ç»Ÿä¼šå°è¯•åœ¨å…¶æœ«å°¾æ·»åŠ æœç´¢åŸŸã€‚
```





#### CoreDNSé…ç½®

CoreDNSçš„é…ç½®éƒ½å­˜å‚¨åœ¨åä¸º**corednsçš„ConfigMap**å¯¹è±¡ä¸­ï¼Œè¯¥å¯¹è±¡ä½äºŽ**kube-system**åç§°ç©ºé—´ä¸­

æœåŠ¡å™¨é…ç½®æ®µ(Server Blocks)ï¼Œç”¨äºŽå®šä¹‰è´Ÿè´£è§£æžçš„æƒå¨åŒºåŸŸï¼Œé…ç½®æ®µæ”¾ç½®äºŽå…¶åŽçš„èŠ±æ‹¬å·{}ä¸­

æœåŠ¡å™¨é…ç½®æ®µä¹Ÿå¯ä»¥æŒ‡å®šè¦ç›‘å¬çš„ç«¯å£å·,ç«¯å£å·ä¹‹å‰éœ€è¦ä½¿ç”¨ä¸€ä¸ªå†’å·ï¼Œé»˜è®¤ä¸º53



**é…ç½®è§£æž**

```bash
# corednsçš„é…ç½®æ˜¯å­˜æ”¾åœ¨ configmapä¸­
[root@master1 ~]#kubectl get cm -n kube-system
NAME                                                   DATA   AGE
coredns                                                1      5d20h

#æŸ¥çœ‹é…ç½®å†…å®¹
apiVersion: v1
data:
  Corefile: |
    .:53 {                               # åŒ…æ‹¬è·ŸåŒºåŸŸçš„æ‰€æœ‰åŒºåŸŸå¯¹åº”çš„ç›‘å¬ç«¯å£è¿›è¡Œè§£æž
        errors                           # å°†é”™è¯¯ä¿¡æ¯è¿›è¡Œè¾“å‡º
        health {                         # LivenessProbeæ£€æµ‹ï¼Œhttp://localhost:8080/healthå®žçŽ°
           lameduck 5s
        }
        ready                            # readinessProbeæ£€æµ‹ï¼Œhttp://localhost:8181/ready corednså°±ç»ªè¿”å›ž200
        kubernetes cluster.local in-addr.arpa ip6.arpa {  # åŸºäºŽKubernetesçš„serviceåç§°è¿›è¡ŒæŸ¥è¯¢è¿”å›žæŸ¥è¯¢ç»“æžœ
           pods insecure
           fallthrough in-addr.arpa ip6.arpa    # å¦‚æžœin-addr.arpa ip6.arpaåŒºåŸŸè§£æžå¤±è´¥ï¼Œäº¤ç”±åŽç»­çš„æ’ä»¶è¿›è¡Œè§£æž
           ttl 30
        }
        prometheus :9153                # é…ç½®è®¿é—®ç«¯å£ç»™Prometheuså®žçŽ°ç›‘æŽ§
        forward . /etc/resolv.conf {    # forward è½¬å‘é…ç½®ï¼Œå¦‚æžœé›†ç¾¤å†…éƒ¨æ— æ³•è§£æžï¼Œäº¤ç”±å®¿ä¸»æœºçš„æ–‡ä»¶è§£æžï¼Œä¹Ÿå¯ä¸ºIPåœ°å€
           max_concurrent 1000          # æœ€å¤§è¿žæŽ¥æ•°ï¼Œæé«˜æ­¤å€¼å¯ä»¥æé«˜å¹¶å‘æ€§
        }
        cache 30                        # å¯ç”¨ç¼“å­˜ï¼Œå•ä½s
        loop                            # æ£€æµ‹å‘çŽ°çŽ¯è·¯æ—¶é‡å»ºcorendnså¯¹åº”çš„Podæ˜¾ç¤ºCrashLoopBackOffçŠ¶æ€è€Œåœæ­¢æŸ¥è¯¢ï¼Œæ¯”å¦‚CoreDNSç›´æŽ¥å°†è¯·æ±‚å‘ç»™ä¸Šæ¸¸æœåŠ¡å™¨ï¼ŒåŽè€…å†å°†è¯·æ±‚è½¬å‘å›žCoreDNS
        reload                          # æ£€æµ‹Corefileæ˜¯å¦å˜åŒ–ï¼Œä¿®æ”¹configmapä¼šé»˜è®¤2MåŽè‡ªåŠ¨åŠ è½½
        loadbalance                     # åŸºäºŽéšæœºç®—æ³•å®žçŽ°DNSæŸ¥è¯¢è®°å½•è´Ÿè½½å‡è¡¡
    }

...
        # å¯¹äºŽä¼ä¸šå†…çš„dnsè§£å†³æ–¹æ¡ˆï¼Œå¯ä»¥é€šè¿‡forwardæ¥å®žçŽ°ï¼Œæ ¼å¼å¦‚ä¸‹
        forward <åŸŸå> <è½¬å‘è‡³å¤–éƒ¨DNSçš„åœ°å€> {  # è½¬å‘é…ç½®ï¼Œå¦‚æžœé›†ç¾¤å†…éƒ¨æ— æ³•è§£æžï¼Œäº¤ç”±å®¿ä¸»æœºæ–‡ä»¶æˆ–å¤–éƒ¨DNSçš„IPè§£æž
            max_concurrent æœ€å¤§è¿žæŽ¥é…ç½®
            except æŽ’é™¤åŸŸå
        }
        # ç¤ºä¾‹ï¼šè½¬å‘åŸŸåè§£æžè‡³é›†ç¾¤å¤–çš„DNSæœåŠ¡å™¨,"."ç‚¹è¡¨ç¤ºæ‰€æœ‰åŸŸå
        forward . 10.0.0.10 10.0.0.20 {
            prefer_udp                   # ä¼˜å…ˆä½¿ç”¨UDP
        }
        #æ³¨æ„ï¼šå¦‚æžœä»…ä»…å¯¹æŸä¸ªåŸŸåè¿›è¡Œè½¬å‘çš„è¯ï¼Œåªéœ€è¦å°† <åŸŸå> éƒ¨åˆ†è®¾ç½®ä¸ºæŒ‡å®šçš„åŸŸåå³å¯ã€‚
        #ç”Ÿäº§ä¸­ä¸æŽ¨èç›´æŽ¥å°† "." çš„è½¬å‘åœ°å€ä½¿ç”¨å…¬ç½‘çš„dnsåœ°å€ï¼ŒæŽ¨èåœ¨å½“å‰ä¸»æœºçš„/etc/resolv.confä¸­é…ç½®å¤–ç½‘ï¼Œå®žçŽ°é—´æŽ¥æ•ˆæžœ
        
        # æ·»åŠ ç‰¹å®šä¸»æœºçš„æ­£å‘è§£æžè®°å½•ï¼Œç±»ä¼¼äºŽ/etc/hostsæ–‡ä»¶åŠŸèƒ½
        hosts {
            192.168.10.100 www.example.com
            10.0.0.101 gitlab.example.org nfs.example.org
            10.0.0.102 jenkins.wang.org
            10.0.0.100 harbor.wang.org
            fallthrough
        }
```

```ABAP
æ’ä»¶çš„å®šä¹‰å’Œæ‰§è¡Œæ˜¯æŒ‰ç…§é…ç½®æ–‡ä»¶çš„é¡ºåºè¿›è¡Œè§£æžçš„ï¼Œå¹¶ä¸” CoreDNS ä¼šå¯¹ç¬¬ä¸€ä¸ªåŒ¹é…çš„ forward æ’ä»¶è¿›è¡Œå¤„ç†ã€‚ä¸€æ—¦åŒ¹é…æˆåŠŸï¼Œå°±ä¸ä¼šç»§ç»­å¤„ç†åŽç»­çš„ forward æ’ä»¶ã€‚

å¦‚æžœåŒ¹é…åŽæ— æ³•è§£æžè¯¥åŸŸåï¼ŒCoreDNS å°†è¿”å›ž NXDOMAIN æˆ– SERVFAILã€‚
å¦‚æžœå¸Œæœ›å‰é¢æ— æ³•è§£æžçš„æƒ…å†µä¸‹ï¼Œç»§ç»­å°è¯•åŽç»­çš„é…ç½®ï¼Œå¯ä»¥åœ¨é…ç½®ä¸­æ·»åŠ fallthrough

# ç¤ºä¾‹ï¼š
forward wang.org 10.0.0.200 {
    fallthrough
}
```





èŒƒä¾‹: ä¸ä½¿ç”¨é»˜è®¤çš„è½¬å‘ç­–ç•¥ï¼Œä½¿ç”¨è‡ªå®šä¹‰çš„è½¬å‘ç­–ç•¥

```bash
# ä¿®æ”¹é…ç½®æ–‡ä»¶
[root@master1 ~]#kubectl edit cm coredns -n kube-system 
configmap/coredns edited

# ä¿®æ”¹ä¹‹åŽé‡å¯CoreDNS
[root@master1 ~]#kubectl rollout restart -n kube-system deployment coredns 
deployment.apps/coredns restarted
```



### Headless Service

#### æ— å¤´æœåŠ¡æœºåˆ¶

æ— å¤´æœåŠ¡åœºæ™¯ä¸‹ï¼ŒKubernetesä¼šå°†ä¸€ä¸ªé›†ç¾¤å†…éƒ¨çš„æ‰€æœ‰Podæˆå‘˜æä¾›å”¯ä¸€çš„DNSåŸŸåæ¥ä½œä¸ºæ¯ä¸ªæˆå‘˜çš„ ç½‘ç»œæ ‡è¯†ï¼Œé›†ç¾¤å†…éƒ¨æˆå‘˜ä¹‹é—´ä½¿ç”¨åŸŸåé€šä¿¡ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå°±ç‰¹åˆ«ä¾èµ–serviceçš„selectorå±žæ€§é…ç½®äº†ã€‚



**å¹¿ä¹‰ä¸ŠHeadless Serviceï¼Œå®ƒä»¬åˆå¯ä»¥ä¸ºåˆ†ä¸¤ç§æƒ…å½¢**

- æœ‰æ ‡ç­¾é€‰æ‹©å™¨ï¼Œæˆ–è€…æ²¡æœ‰æ ‡ç­¾é€‰æ‹©å™¨,ä½†æœ‰ç€ä¸ŽServiceå¯¹è±¡åŒåçš„Endpointèµ„æº
  - Serviceçš„DNSåç§°ç›´æŽ¥è§£æžä¸ºåŽç«¯å„å°±ç»ªçŠ¶æ€çš„Podçš„IPåœ°å€
  - è°ƒåº¦åŠŸèƒ½ä¹Ÿå°†ç”±DNSå®Œæˆ
  - å„Pod IPç›¸å…³PTRè®°å½•å°†è§£æžè‡³Podåç§°ï¼Œå‡è®¾Pod IPä¸ºa.b.c.dï¼Œåˆ™å…¶Podåç§°ä¸ºa-b-c-d...SVC.
  - è¿™ç§ç±»åž‹ä¹Ÿå°±æ˜¯ç‹­ä¹‰ä¸Šçš„Headless Service
  - ä¸»è¦åº”ç”¨äºŽæœ‰çŠ¶æ€æœåŠ¡çš„**statefulSet**èµ„æºå¯¹è±¡

- æ— æ ‡ç­¾é€‰æ‹©å™¨ä¸”ä¹Ÿæ²¡æœ‰ä¸ŽServiceå¯¹è±¡åŒåçš„Endpointèµ„æº
  - ç”¨äºŽé›†ç¾¤å¤–éƒ¨ ExternalName ç±»åž‹çš„Service
  - Serviceçš„DNSåç§°å°†ä¼šç”Ÿæˆä¸€æ¡CNAMEè®°å½•ï¼Œå¯¹åº”å€¼ç”±Serviceå¯¹è±¡ä¸Šçš„spec.externalNameå­—æ®µæŒ‡å®š

```ABAP
æ³¨æ„: headless serviceæ˜¯ä¸€ä¸ªå››å±‚è°ƒåº¦ï¼Œå› ä¸ºiptatbles/ipvséƒ½æ˜¯å››å±‚çš„
```



**ä¸»è¦çš„åº”ç”¨åœºæ™¯**

- ServiceName --> (label Selectorï¼ŒPod) --> æ‰€æœ‰Podçš„IPåœ°å€ï¼Œæ­¤æ–¹å¼åˆç§°ä¸ºç‹­ä¹‰çš„Headless  Serviceï¼Œä¸»è¦åº”ç”¨åœ¨ **StatefulSet**
- ServiceName --> CName ï¼ˆ**ExternalName**ï¼‰ --> ExternalService IPï¼Œæ­¤æ–¹å¼ç§°ä¸ºç‹­ä¹‰çš„ External Service



**æ— å¤´æœåŠ¡ç®¡ç†çš„åŸŸåæ˜¯å¦‚ä¸‹çš„æ ¼å¼ï¼š**

```bash
$(service_name).$(Kubernetes_namespace).svc.cluster.local
```



**DNS è§£æžè®°å½•**

```bash
#Aè®°å½•
<a>-<b>-<c>-<d>.<service>.<ns>.svc.<zone> A PodIP

#PodIPçš„PTRåè§£æžè®°å½•  
<d>.<c>.<b>.<a>.in-addr.arpa IN PTR <ç”¨æ¨ªçº¿åˆ†éš”çš„PodIP>.<service>.<ns>.svc.<zone>

#å…³é”®ç‚¹ï¼š
æ­£å‘è§£æž:svc_nameçš„è§£æžç»“æžœä»Žå¸¸è§„Serviceçš„ClusterIPï¼Œè½¬ä¸ºè§£æžæˆå„ä¸ªPodçš„IPåœ°å€
åå‘è§£æž:ä»Žå¸¸è§„çš„clusteripè§£æžä¸ºservice nameï¼Œè½¬ä¸ºä»Žpodipåˆ°hostname, <a>-<b>-<c>-<d>.
<service>.<ns>.svc.<zone>
<hostname>æŒ‡çš„æ˜¯a-b-c-dæ ¼å¼ï¼Œè€ŒéžPodè‡ªå·±çš„ä¸»æœºåï¼›
```



**æ¡ˆä¾‹ï¼š: Headless Service**

```bash
# å‘½ä»¤è¡Œæ–¹å¼
[root@master1 ~]#kubectl create service clusterip service-headless-cmd --clusterip="None"

# åˆ›å»ºæ–‡ä»¶
[root@master1 headlessService]#vim service-headless.yaml
apiVersion: v1
kind: Service
metadata:
  name: service-headless
spec:
  selector:
    app: myweb
  clusterIP: "None"  #æ— å¤´æœåŠ¡
  
# åº”ç”¨
[root@master1 headlessService]#kubectl apply -f service-headless.yaml 
service/service-headless created

# æŸ¥çœ‹
[root@master1 headlessService]#kubectl exec myweb-565cb68445-btlj8 -- host service-headless
service-headless.default.svc.cluster.local has address 10.244.1.104
service-headless.default.svc.cluster.local has address 10.244.2.56
service-headless.default.svc.cluster.local has address 10.244.3.111
```







## Kubernetesæ•°æ®å­˜å‚¨





**æœ¬ç« å†…å®¹**

- **å­˜å‚¨æœºåˆ¶**
- **emptyDir**
- **hostPath**
- **ç½‘ç»œå…±äº«å­˜å‚¨**
- **PVå’ŒPVC**
- **StorageClass**
- **CNSçš„å­˜å‚¨æ–¹æ¡ˆOpenEBS**







### æ•°æ®å­˜å‚¨



#### å­˜å‚¨æœºåˆ¶

Container ä¸­çš„æ–‡ä»¶åœ¨ç£ç›˜ä¸Šæ˜¯ä¸´æ—¶å­˜æ”¾çš„ï¼Œè¿™ç»™ Container ä¸­è¿è¡Œçš„è¾ƒé‡è¦çš„åº”ç”¨ç¨‹åºå¸¦æ¥ä¸€äº›é—®é¢˜ã€‚

- å½“å®¹å™¨å´©æºƒæ—¶ã€‚ kubelet å¯èƒ½ä¼šé‡æ–°åˆ›å»ºå®¹å™¨ï¼Œå¯èƒ½ä¼šå¯¼è‡´å®¹å™¨æ¼‚ç§»è‡³æ–°çš„å®¿ä¸»æœºï¼Œå®¹å™¨ä¼šä»¥å¹²å‡€çš„çŠ¶æ€é‡å»ºã€‚å¯¼è‡´æ•°æ®ä¸¢å¤±
- åœ¨åŒä¸€ Pod ä¸­è¿è¡Œå¤šä¸ªå®¹å™¨éœ€è¦å…±äº«æ•°æ®



Kubernetes å·ï¼ˆVolumeï¼‰ è¿™ä¸€æŠ½è±¡æ¦‚å¿µèƒ½å¤Ÿè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜



Kubernetes é›†ç¾¤ä¸­çš„å®¹å™¨æ•°æ®å­˜å‚¨

![image-20241225142912632](D:\git_repository\cyber_security_learning\markdown_img\image-20241225142912632.png)





**Kubernetesæ”¯æŒçš„å­˜å‚¨ç±»åž‹**

Kubernetesæ”¯æŒä¸°å¯Œçš„å­˜å‚¨ç±»åž‹ï¼Œå¯ä»¥åˆ†ä¸ºæ ‘å†…å’Œæ ‘å¤–ä¸¤ç§



**æ ‘å†… In-Tree å­˜å‚¨å·æ’ä»¶**

| ç±»åž‹         | ä¸¾ä¾‹                                                         |
| ------------ | ------------------------------------------------------------ |
| ä¸´æ—¶å­˜å‚¨å·   | emptyDir                                                     |
| æœ¬åœ°æ•°æ®å·   | hostPathã€local                                              |
| æ–‡ä»¶ç³»ç»Ÿ     | NFSã€CephFSã€GlusterFSã€fastdfsã€Cinderã€gitRepo(DEPRECATED) |
| å—è®¾å¤‡       | iSCSIã€FCã€rdb(å—è®¾å¤‡)ã€vSphereVolume                        |
| å­˜å‚¨å¹³å°     | Quobyteã€PortworxVolumeã€StorageOSã€ScaleIO                  |
| äº‘å­˜å‚¨æ•°æ®å· | Aliyun OSSã€Amazon S3ã€AWS Elastic Block Storeã€Google gcePersistentDiskç­‰ |
| ç‰¹æ®Šå­˜å‚¨å·   | ConfigMapã€Secretã€DownwardAPIã€Projectdã€flocker            |



**æ ‘å¤– Out-of_Tree å­˜å‚¨å·æ’ä»¶**

ç»ç”±**å®¹å™¨å­˜å‚¨æŽ¥å£CSI**æˆ–**FlexVolumeæŽ¥å£ï¼ˆå·²æ·˜æ±°ï¼‰**æ‰©å±•å‡ºçš„å¤–éƒ¨çš„å­˜å‚¨ç³»ç»Ÿç§°ä¸ºOut-of-Trecç±»çš„å­˜å‚¨æ’ä»¶



- **CSI æ’ä»¶**

  - Container Storage Interface æ˜¯å½“å‰Kubernetesç¤¾åŒºæŽ¨èçš„æ’ä»¶å®žçŽ°æ–¹æ¡ˆ
  - CSI ä¸ä»…æ”¯æŒKuberneteså¹³å°å­˜å‚¨æ’ä»¶æŽ¥å£ï¼Œè€Œä¸”ä¹Ÿä½œä¸ºäº‘åŽŸç”Ÿç”Ÿæ€ä¸­å®¹å™¨å­˜å‚¨æŽ¥å£çš„æ ‡å‡†,å…¬ç”¨ äº‘å¯¹å…¶æœ‰æ›´å¥½çš„æ”¯æŒ
  - Kubernetes æ”¯æŒ CSI çš„æŽ¥å£æ–¹å¼å®žçŽ°æ›´å¤§èŒƒå›´çš„å­˜å‚¨åŠŸèƒ½æ‰©å±•,æ›´ä¸ºæŽ¨èä½¿ç”¨

  ```bash
  https://github.com/container-storage-interface/spec/blob/master/spec.md
  ```

  

CSI ä¸»è¦åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š**CSI Controller Server** ä¸Ž **CSI Node Server**ï¼Œåˆ†åˆ«å¯¹åº”**Controller Server Pod**å’Œ **Node Server Pod**



![image-20241225145234834](D:\git_repository\cyber_security_learning\markdown_img\image-20241225145234834.png)

- **Controller Server**
  - ä¹Ÿç§°ä¸ºCSI Controller
  - åœ¨é›†ç¾¤ä¸­åªéœ€è¦éƒ¨ç½²ä¸€ä¸ª Controller Serverï¼Œä»¥ deployment æˆ–è€… StatefulSet çš„å½¢å¼è¿è¡Œ
  - ä¸»è¦è´Ÿè´£ä¸Žå­˜å‚¨æœåŠ¡APIé€šä¿¡å®ŒæˆåŽç«¯å­˜å‚¨çš„ç®¡ç†æ“ä½œï¼Œæ¯”å¦‚ provision å’Œ attach å·¥ä½œã€‚



- **Node Server**
  - ä¹Ÿç§°ä¸ºCSI Node æˆ– Node Plugin
  - ä¿è¯æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¼šæœ‰ä¸€ä¸ª Pod éƒ¨ç½²å‡ºæ¥ï¼Œè´Ÿè´£åœ¨èŠ‚ç‚¹çº§åˆ«å®Œæˆå­˜å‚¨å·ç®¡ç†ï¼Œå’Œ CSI Controller ä¸€èµ· å®Œæˆ volume çš„ mount æ“ä½œã€‚
  - Node Server Pod æ˜¯ä¸ª DaemonSetï¼Œå®ƒä¼šåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šè¿›è¡Œæ³¨å†Œã€‚
  - Kubelet ä¼šç›´æŽ¥é€šè¿‡ Socket çš„æ–¹å¼ç›´æŽ¥å’Œ CSI Node Server è¿›è¡Œé€šä¿¡ã€è°ƒç”¨ Attach/Detach/Mount/Unmount ç­‰ã€‚



![image-20241225145625234](D:\git_repository\cyber_security_learning\markdown_img\image-20241225145625234.png)





**CSI æ’ä»¶åŒ…æ‹¬ä»¥ä¸‹ä¸¤éƒ¨åˆ†**

- **CSI-Plugin**:å®žçŽ°æ•°æ®å·çš„æŒ‚è½½ã€å¸è½½åŠŸèƒ½ã€‚
- **CSI-Provisioner**: åˆ¶å¤‡å™¨ï¼ˆProvisionerï¼‰å®žçŽ°æ•°æ®å·çš„è‡ªåŠ¨åˆ›å»ºç®¡ç†èƒ½åŠ›ï¼Œå³é©±åŠ¨ç¨‹åºï¼Œæ¯”å¦‚: æ”¯ æŒäº‘ç›˜ã€NASç­‰å­˜å‚¨å·åˆ›å»ºèƒ½åŠ›



**Kubernetes å­˜å‚¨æž¶æž„**

å­˜å‚¨çš„ç»„ä»¶ä¸»è¦æœ‰ï¼šattach/detach controllerã€pv controllerã€volume managerã€volume pluginsã€ scheduler

æ¯ä¸ªç»„ä»¶åˆ†å·¥æ˜Žç¡®

![image-20241225150025215](D:\git_repository\cyber_security_learning\markdown_img\image-20241225150025215.png)

- **ADæŽ§åˆ¶å™¨**ï¼šè´Ÿè´£å­˜å‚¨è®¾å¤‡çš„Attach/Detachæ“ä½œ
  - Attachï¼šå°†è®¾å¤‡é™„åŠ åˆ°ç›®æ ‡èŠ‚ç‚¹
  - Detachï¼šå°†è®¾å¤‡ä»Žç›®æ ‡èŠ‚ç‚¹ä¸Šå¸è½½
- **Volume Manager**ï¼šå­˜å‚¨å·ç®¡ç†å™¨ï¼Œè´Ÿè´£å®Œæˆå·çš„Mount/Umountæ“ä½œï¼Œä»¥åŠè®¾å¤‡çš„æ ¼å¼åŒ–æ“ä½œç­‰
- **PV Controller** ï¼šè´Ÿè´£PV/PVCçš„ç»‘å®šã€ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä»¥åŠå­˜å‚¨å·çš„Provision/Deleteæ“ä½œ
- **volume plugins**ï¼šåŒ…å«k8såŽŸç”Ÿçš„å’Œå„åŽ‚å•†çš„çš„å­˜å‚¨æ’ä»¶ï¼Œæ‰©å±•å„ç§å­˜å‚¨ç±»åž‹çš„å·ç®¡ç†èƒ½åŠ›
  - åŽŸç”Ÿçš„åŒ…æ‹¬ï¼šemptydirã€hostpathã€csiç­‰
  - å„åŽ‚å•†çš„åŒ…æ‹¬ï¼šaws-ebsã€azureç­‰
- schedulerï¼šå®žçŽ°Podçš„è°ƒåº¦ï¼Œæ¶‰åŠåˆ°volumeçš„è°ƒåº¦ã€‚æ¯”å¦‚ebsã€csiå…³äºŽå•nodeæœ€å¤§å¯attachç£ç›˜ æ•°é‡çš„predicateç­–ç•¥ï¼Œschedulerçš„è°ƒåº¦è‡³å“ªä¸ªæŒ‡å®šç›®æ ‡èŠ‚ç‚¹ä¹Ÿä¼šå—åˆ°å­˜å‚¨æ’ä»¶çš„å½±å“





### Podçš„å­˜å‚¨å·Volume

Kubernetes æ”¯æŒåœ¨Podä¸Šåˆ›å»ºä¸åŒç±»åž‹çš„ä»»æ„æ•°é‡çš„å·æ¥å®žçŽ°ä¸åŒæ•°æ®çš„å­˜å‚¨



**å•èŠ‚ç‚¹å­˜å‚¨**

![image-20241225151327829](D:\git_repository\cyber_security_learning\markdown_img\image-20241225151327829.png)



**å¤šèŠ‚ç‚¹å­˜å‚¨**

![image-20241225151355422](D:\git_repository\cyber_security_learning\markdown_img\image-20241225151355422.png)



å­˜å‚¨å·æœ¬è´¨ä¸Šè¡¨çŽ°ä¸º Podä¸­**æ‰€æœ‰å®¹å™¨å…±äº«è®¿é—®çš„ç›®å½•**

è€Œæ­¤ç›®å½•çš„åˆ›å»ºæ–¹å¼ã€ä½¿ç”¨çš„å­˜å‚¨ä»‹è´¨ä»¥åŠç›®å½•çš„åˆå§‹å†…å®¹æ˜¯ç”±Podè§„èŒƒä¸­å£°æ˜Žçš„å­˜å‚¨å·ç±»åž‹æ¥æºå†³å®š

**kubeletå†…ç½®æ”¯æŒå¤šç§å­˜å‚¨å·æ’ä»¶**ï¼Œ**å­˜å‚¨å·æ˜¯ç”±å„ç§å­˜å‚¨æ’ä»¶(å­˜å‚¨é©±åŠ¨)æ¥æä¾›å­˜å‚¨æœåŠ¡**

å­˜å‚¨å·æ’ä»¶(å­˜å‚¨é©±åŠ¨)å†³å®šäº†æ”¯æŒçš„åŽç«¯å­˜å‚¨ä»‹è´¨æˆ–å­˜å‚¨æœåŠ¡ï¼Œä¾‹å¦‚hostPathæ’ä»¶ä½¿ç”¨å®¿ä¸»æœºæ–‡ä»¶ç³» ç»Ÿï¼Œè€Œnfsæ’ä»¶åˆ™å¯¹æŽ¥æŒ‡å®šçš„NFSå­˜å‚¨æœåŠ¡ç­‰

Podåœ¨è§„èŒƒä¸­éœ€è¦æŒ‡å®šå…¶åŒ…å«çš„å·ä»¥åŠè¿™äº›å·åœ¨å®¹å™¨ä¸­çš„æŒ‚è½½è·¯å¾„

**å­˜å‚¨å·éœ€è¦å®šä¹‰åœ¨æŒ‡å®šçš„Podä¹‹ä¸Š**

æœ‰äº›å·æœ¬èº«çš„ç”Ÿå‘½å‘¨æœŸä¸ŽPodç›¸åŒï¼Œä½†å…¶åŽç«¯çš„å­˜å‚¨åŠç›¸å…³æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸé€šå¸¸è¦å–å†³äºŽå­˜å‚¨ä»‹è´¨



å­˜å‚¨å·å¯ä»¥åˆ†ä¸ºï¼š**ä¸´æ—¶å·å’ŒæŒä¹…å·**

- **ä¸´æ—¶å·ç±»åž‹**çš„ç”Ÿå‘½å‘¨æœŸä¸Ž Pod ç›¸åŒï¼Œ å½“ Pod ä¸å†å­˜åœ¨æ—¶ï¼ŒKubernetes ä¹Ÿä¼šé”€æ¯ä¸´æ—¶å·
- æŒä¹…å·å¯ä»¥æ¯” Pod çš„å­˜æ´»æœŸé•¿ã€‚å½“ Pod ä¸å†å­˜åœ¨æ—¶ï¼ŒKubernetes ä¸ä¼šé”€æ¯æŒä¹…å·ã€‚
- ä½†å¯¹äºŽç»™å®š Pod ä¸­ä»»ä½•ç±»åž‹çš„å·ï¼Œåœ¨å®¹å™¨é‡å¯æœŸé—´æ•°æ®éƒ½ä¸ä¼šä¸¢å¤±ã€‚



#### Podä¸­å·çš„ä½¿ç”¨

- ä¸€ä¸ªPodå¯ä»¥æ·»åŠ ä»»æ„ä¸ªå·
- åŒä¸€ä¸ªPodå†…æ¯ä¸ªå®¹å™¨å¯ä»¥åœ¨ä¸åŒä½ç½®æŒ‰éœ€æŒ‚è½½Podä¸Šçš„ä»»æ„ä¸ªå·ï¼Œæˆ–è€…ä¸æŒ‚è½½ä»»ä½•å·
- åŒä¸€ä¸ªPodä¸Šçš„æŸä¸ªå·ï¼Œä¹Ÿå¯ä»¥åŒæ—¶è¢«è¯¥Podå†…çš„å¤šä¸ªå®¹å™¨åŒæ—¶æŒ‚è½½ï¼Œä»¥å…±äº«æ•°æ®
- å¦‚æžœæ”¯æŒï¼Œå¤šä¸ªPodä¹Ÿå¯ä»¥é€šè¿‡å·æŽ¥å£è®¿é—®åŒä¸€ä¸ªåŽç«¯å­˜å‚¨å•å…ƒ

![image-20241225155834088](D:\git_repository\cyber_security_learning\markdown_img\image-20241225155834088.png)



**å­˜å‚¨å·çš„é…ç½®ç”±ä¸¤éƒ¨åˆ†ç»„æˆ**

- é€šè¿‡.spec.volumeså­—æ®µå®šä¹‰åœ¨Podä¹‹ä¸Šçš„å­˜å‚¨å·åˆ—è¡¨ï¼Œå®ƒç»ç”±ç‰¹å®šçš„å­˜å‚¨å·æ’ä»¶å¹¶ç»“åˆç‰¹å®šçš„å­˜å‚¨ä¾›ç»™æ–¹çš„è®¿é—®æŽ¥å£è¿›è¡Œå®šä¹‰
- åµŒå¥—å®šä¹‰åœ¨å®¹å™¨çš„volumeMountså­—æ®µä¸Šçš„å­˜å‚¨å·æŒ‚è½½åˆ—è¡¨ï¼Œå®ƒåªèƒ½æŒ‚è½½å½“å‰Podå¯¹è±¡ä¸­å®šä¹‰çš„å­˜å‚¨å·



**Pod å†…éƒ¨å®¹å™¨ä½¿ç”¨å­˜å‚¨å·æœ‰ä¸¤æ­¥ï¼š**

- åœ¨Podä¸Šå®šä¹‰å­˜å‚¨å·ï¼Œå¹¶å…³è”è‡³ç›®æ ‡å­˜å‚¨æœåŠ¡ä¸Š **volumes**
  - **å®šä¹‰å·**
- åœ¨éœ€è¦ç”¨åˆ°å­˜å‚¨å·çš„å®¹å™¨ä¸Šï¼ŒæŒ‚è½½å…¶æ‰€å±žçš„Podä¸­pauseçš„å­˜å‚¨å· **volumesMount**
  - **å¼•ç”¨å·**



**å®¹å™¨å¼•æ“Žå¯¹å…±äº«å¼å­˜å‚¨è®¾å¤‡çš„æ”¯æŒç±»åž‹ï¼š**

- **å•è·¯è¯»å†™** - å¤šä¸ªå®¹å™¨å†…å¯ä»¥é€šè¿‡åŒä¸€ä¸ªä¸­é—´å®¹å™¨å¯¹åŒä¸€ä¸ªå­˜å‚¨è®¾å¤‡è¿›è¡Œè¯»å†™æ“ä½œ
- **å¤šè·¯å¹¶è¡Œè¯»å†™** - å¤šä¸ªå®¹å™¨å†…å¯ä»¥åŒæ—¶å¯¹åŒä¸€ä¸ªå­˜å‚¨è®¾å¤‡è¿›è¡Œè¯»å†™æ“ä½œ
- **å¤šè·¯åªè¯»** - å¤šä¸ªå®¹å™¨å†…å¯ä»¥åŒæ—¶å¯¹åŒä¸€ä¸ªå­˜å‚¨è®¾å¤‡è¿›è¡Œåªè¯»æ“ä½œ



**Podçš„å·èµ„æºå¯¹è±¡å±žæ€§**

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: <string>
  namespace: <string>
spec:
  volumes:                       # å®šä¹‰å·
  - name: <string>               # å­˜å‚¨å·åç§°æ ‡è¯†ï¼Œä»…å¯ä½¿ç”¨DNSæ ‡ç­¾æ ¼å¼çš„å­—ç¬¦ï¼Œåœ¨å½“å‰Podå¿…é¡»å”¯ä¸€
    VOL_TYPE: <Object>           # å­˜å‚¨å·æ’ä»¶åŠå…·ä½“çš„ç›®æ ‡å­˜å‚¨ä¾›ç»™æ–¹çš„ç›¸å…³é…ç½®
  containers:
  - name: ...
    image: ...
    volumeMounts:                # æŒ‚è½½å·
    - name: <string>             # è¦æŒ‚è½½çš„å­˜å‚¨å·çš„åç§°ï¼Œå¿…é¡»åŒ¹é…å­˜å‚¨å·åˆ—è¡¨ä¸­æŸé¡¹çš„å®šä¹‰
      mountPath: <string>        # å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æŒ‚è½½ç‚¹è·¯å¾„
      readOnly: <boolean>        # æ˜¯å¦æŒ‚è½½ä¸ºåªè¯»æ¨¡å¼ï¼Œé»˜è®¤ä¸º"å¦"ï¼Œå³å¯è¯»å¯å†™
      subPath: <string>          # æŒ‚è½½å­˜å‚¨å·ä¸Šçš„ä¸€ä¸ªå­ç›®å½•è‡³æŒ‡å®šæŒ‚è½½ç‚¹
      subPathExpr: <string>      # æŒ‚è½½æœ‰æŒ‡å®šçš„æ¨¡å¼åŒ¹é…åˆ°çš„å­˜å‚¨å·çš„æ–‡ä»¶æˆ–ç›®å½•è‡³æŒ‚è½½ç‚¹
```





### emptyDir

ä¸€ä¸ªemptyDir volumeåœ¨podè¢«è°ƒåº¦åˆ°æŸä¸ªNodeæ—¶å€™è‡ªåŠ¨åˆ›å»ºçš„ï¼Œæ— éœ€æŒ‡å®šå®¿ä¸»æœºä¸Šå¯¹åº”çš„ç›®å½•ã€‚ é€‚ç”¨äºŽåœ¨ä¸€ä¸ª**Podä¸­ä¸åŒå®¹å™¨é—´çš„ä¸´æ—¶æ•°æ®çš„å…±äº«**



**emptyDir æ•°æ®å­˜æ”¾åœ¨å®¿ä¸»æœºçš„è·¯å¾„å¦‚ä¸‹**

```bash
/var/lib/kubelet/pods/<pod_id>/volumes/kubernetes.io~empty-dir/<volume_name>/<FILE>

#æ³¨æ„ï¼šæ­¤ç›®å½•éšç€Podåˆ é™¤ï¼Œä¹Ÿä¼šéšä¹‹åˆ é™¤ï¼Œä¸èƒ½å®žçŽ°æŒä¹…åŒ–

# æŸ¥çœ‹podæ‰€åœ¨èŠ‚ç‚¹
[root@master1 pods]#kubectl get pods -o wide
NAME                     READY   STATUS    RESTARTS        AGE   IP             NODE    NOMINATED NODE   READINESS GATES
myweb-565cb68445-btlj8   1/1     Running   1 (7h25m ago)   24h   10.244.2.56    node2   <none>           <none>
myweb-565cb68445-c8drb   1/1     Running   1 (7h26m ago)   24h   10.244.1.104   node1   <none>           <none>
myweb-565cb68445-lj7bq   1/1     Running   1 (7h25m ago)   24h   10.244.3.111   node3   <none>           <none>

# æŸ¥çœ‹podèŠ‚ç‚¹ä¸ŠemptyDiræ•°æ®å­˜æ”¾çš„è·¯å¾„
[root@master1 pods]#ssh 10.0.0.203 ls /var/lib/kubelet/pods/
242cc64b-4330-4c00-ba80-9228f2186367
4a737c21-36e2-413d-a53f-ce65b9b4698e
9fe61621-a076-4d35-add9-c329ca6b12db
eed8a3fa-73e0-4a1e-b897-4235d77cae66

# æŸ¥çœ‹å¯¹åº”çš„podçš„uid
[root@master1 pods]#kubectl get pod myweb-565cb68445-btlj8 -o yaml|grep -i uid
    uid: 4db8879a-ee0d-48d3-8b7e-675581eb4fa2
  uid: eed8a3fa-73e0-4a1e-b897-4235d77cae66      # -------- åŒ¹é…ä¸Šé¢çš„è·¯å¾„uid
```



**emptyDir ç‰¹ç‚¹å¦‚ä¸‹ï¼š**

- æ­¤ä¸º**é»˜è®¤å­˜å‚¨ç±»åž‹**
- æ­¤æ–¹å¼åªèƒ½ä¸´æ—¶å­˜æ”¾æ•°æ®ï¼Œä¸èƒ½å®žçŽ°æ•°æ®æŒä¹…åŒ–
- è·ŸéšPodåˆå§‹åŒ–è€Œæ¥ï¼Œå¼€å§‹æ˜¯ç©ºæ•°æ®å·
- Pod è¢«åˆ é™¤ï¼ŒemptyDirå¯¹åº”çš„å®¿ä¸»æœºç›®å½•ä¹Ÿè¢«åˆ é™¤ï¼Œå½“ç„¶ç›®å½•å†…çš„æ•°æ®éšä¹‹æ°¸ä¹…æ¶ˆé™¤
- emptyDir æ•°æ®å·ä»‹è´¨ç§ç±»è·Ÿå½“å‰ä¸»æœºçš„ç£ç›˜ä¸€æ ·ã€‚
- emptyDir ä¸»æœºå¯ä»¥ä¸ºåŒä¸€ä¸ªPodå†…å¤šä¸ªå®¹å™¨å…±äº«
- emptyDir å®¹å™¨æ•°æ®çš„ä¸´æ—¶å­˜å‚¨ç›®å½•ä¸»è¦ç”¨äºŽæ•°æ®ç¼“å­˜å’Œ**åŒä¸€ä¸ªPodå†…çš„å¤šä¸ªå®¹å™¨å…±äº«ä½¿ç”¨**



**emptyDirå±žæ€§è§£æž**

```bash
kubectl explain pod.spec.volumes.emptyDir
    medium       # æŒ‡å®šåª’ä»‹ç±»åž‹ï¼Œä¸»è¦æœ‰defaultå’Œmemoryä¸¤ç§
                 # é»˜è®¤æƒ…å†µä¸‹ï¼ŒemptyDirå·æ”¯æŒèŠ‚ç‚¹ä¸Šçš„ä»»ä½•ä»‹è´¨ï¼ŒSSDã€ç£ç›˜æˆ–ç½‘ç»œå­˜å‚¨ï¼Œå…·ä½“å–å†³äºŽè‡ªèº«æ‰€åœ¨Nodeçš„çŽ¯å¢ƒ
                 # å°†å­—æ®µè®¾ç½®ä¸ºMemoryï¼Œè®©K8Sä½¿ç”¨tmpfsï¼Œè™½ç„¶tmpfså¿«ï¼Œä½†æ˜¯Podé‡å¯æ—¶ï¼Œæ•°æ®ä¼šè¢«æ¸…é™¤ï¼Œå¹¶ä¸”è®¾ç½®çš„å¤§å°ä¼šè¢«è®¡å…¥                    # Containerçš„å†…å­˜é™åˆ¶å½“ä¸­
    sizeLimit    # å½“å‰å­˜å‚¨å·çš„ç©ºé—²é™åˆ¶ï¼Œé»˜è®¤å€¼ä¸ºnilè¡¨ç¤ºä¸é™åˆ¶
    
kubectl explain pod.spec.containers.volumeMounts
    mountPath    # æŒ‚è½½åˆ°å®¹å™¨ä¸­çš„è·¯å¾„,æ­¤ç›®å½•ä¼šè‡ªåŠ¨ç”Ÿæˆ
    name         # æŒ‡å®šæŒ‚è½½çš„volumesåç§°
    readOnly     # æ˜¯å¦åªè¯»æŒ‚è½½
    subPath      # æ˜¯å¦æŒ‚è½½å­ç›®å½•çš„è·¯å¾„,é»˜è®¤ä¸æŒ‚è½½å­ç›®å½•
```



**é…ç½®ç¤ºä¾‹**

```yaml
# volumeé…ç½®æ ¼å¼
volumes:
- name: volume_name
  emptyDir: {}
  
# volumeä½¿ç”¨æ ¼å¼
containers:
- volumeMounts:
  - name: volume_name
    mountPath: /path/to/container/  # å®¹å™¨å†…è·¯å¾„


# ç¤ºä¾‹1
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
spec:
  containers:
  - image: registry.k8s.io/test-webserver
    name: test-container
    volumeMounts:
    - mountPath: /cache
      name: cache-volume
  volumes:
  - name: cache-volume
    emptyDir: {}
    
# ç¤ºä¾‹2ï¼š
apiVersion: v1
kind: Pod
metadata:
  name: test-pd
spec:
  containers:
  - image: registry.k8s.io/test-webserver
    name: test-container
    volumeMounts:
    - mountPath: /cache
      name: cache-volume
  volumes:
  - name: cache-volume
    emptyDir:
      medium: Memory
      sizeLimit: 500Mi
```



èŒƒä¾‹ï¼šåœ¨ä¸€ä¸ªPodä¸­å®šä¹‰å¤šä¸ªå®¹å™¨é€šè¿‡emptyDirå…±äº«æ•°æ®

```yaml
[root@master1 storage] # vim storage-emptydir-2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: storage-emptydir
spec:
  volumes:
  - name: nginx-data
    emptyDir: {}
  containers:
  - name: storage-emptydir-nginx
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: nginx-data
      mountPath: /usr/share/nginx/html/
  - name: storage-emptydir-busybox
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/busybox:1.32.0
    volumeMounts:
    - name: nginx-data
      mountPath: /data/
    command:
    - "/bin/sh"
    - "-c"
    - "while true; do date > /data/index.html; sleep 1; done"

# åº”ç”¨
[root@master1 storage]#kubectl apply -f storage-emptydir-2.yaml 
pod/storage-emptydir created

# æŸ¥çœ‹Pod
[root@master1 storage] # kubectl get pod -o wide
NAME                     READY   STATUS              RESTARTS      AGE   IP             NODE    NOMINATED NODE   READINESS GATES
myweb-565cb68445-btlj8   1/1     Running             1 (11h ago)   27h   10.244.2.56    node2   <none>           <none>
myweb-565cb68445-c8drb   1/1     Running             1 (11h ago)   27h   10.244.1.104   node1   <none>           <none>
myweb-565cb68445-lj7bq   1/1     Running             1 (11h ago)   27h   10.244.3.111   node3   <none>           <none>
storage-emptydir         0/2     ContainerCreating   0             9s    <none>         node2   <none>           <none>

# æŸ¥çœ‹Podçš„ç½‘ç»œIP
[root@master1 storage] # kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS      AGE   IP             NODE    NOMINATED NODE   READINESS GATES
myweb-565cb68445-btlj8   1/1     Running   1 (11h ago)   27h   10.244.2.56    node2   <none>           <none>
myweb-565cb68445-c8drb   1/1     Running   1 (11h ago)   27h   10.244.1.104   node1   <none>           <none>
myweb-565cb68445-lj7bq   1/1     Running   1 (11h ago)   27h   10.244.3.111   node3   <none>           <none>
storage-emptydir         2/2     Running   0             14s   10.244.2.59    node2   <none>           <none>

# æµ‹è¯•æ•ˆæžœ
[root@master1 storage] #curl 10.244.2.59
Wed Dec 25 12:05:05 UTC 2024
[root@master1 storage] #curl 10.244.2.59
Wed Dec 25 12:05:06 UTC 2024
[root@master1 storage] #curl 10.244.2.59
Wed Dec 25 12:05:07 UTC 2024
[root@master1 storage] #curl 10.244.2.59
Wed Dec 25 12:05:08 UTC 2024
[root@master1 storage] #curl 10.244.2.59
Wed Dec 25 12:05:08 UTC 2024
```









### hostPath

hostPath å¯ä»¥å°†**å®¿ä¸»æœºä¸Šçš„ç›®å½•**æŒ‚è½½åˆ° Pod ä¸­ä½œä¸ºæ•°æ®çš„å­˜å‚¨ç›®å½•



**hostPath ä¸€èˆ¬ç”¨åœ¨å¦‚ä¸‹åœºæ™¯ï¼š**

- å®¹å™¨åº”ç”¨ç¨‹åºä¸­æŸäº›æ–‡ä»¶éœ€è¦æ°¸ä¹…ä¿å­˜

- Podåˆ é™¤ï¼ŒhostPathæ•°æ®å¯¹åº”åœ¨å®¿ä¸»æœºæ–‡ä»¶ä¸å—å½±å“,å³hostPathçš„ç”Ÿå‘½å‘¨æœŸå’ŒPodä¸åŒ,è€Œå’ŒèŠ‚ç‚¹ç›¸åŒ
- **å®¿ä¸»æœºå’Œå®¹å™¨çš„ç›®å½•éƒ½ä¼šè‡ªåŠ¨åˆ›å»º**
- æŸäº›å®¹å™¨åº”ç”¨éœ€è¦ç”¨åˆ°å®¹å™¨çš„è‡ªèº«çš„å†…éƒ¨æ•°æ®ï¼Œå¯å°†å®¿ä¸»æœºçš„/var/lib/[docker|containerd]æŒ‚è½½åˆ° Podä¸­



**hostPath ä½¿ç”¨æ³¨æ„äº‹é¡¹ï¼š**

- ä¸åŒå®¿ä¸»æœºçš„ç›®å½•å’Œæ–‡ä»¶å†…å®¹ä¸ä¸€å®šå®Œå…¨ç›¸åŒï¼Œæ‰€ä»¥Podè¿ç§»å‰åŽçš„è®¿é—®æ•ˆæžœä¸ä¸€æ ·
- ä¸é€‚åˆDeploymentè¿™ç§åˆ†å¸ƒå¼çš„èµ„æºï¼Œæ›´é€‚åˆäºŽDaemonSet
- å®¿ä¸»æœºçš„ç›®å½•ä¸å±žäºŽç‹¬ç«‹çš„èµ„æºå¯¹è±¡çš„èµ„æºï¼Œæ‰€ä»¥**å¯¹èµ„æºè®¾ç½®çš„èµ„æºé…é¢é™åˆ¶å¯¹hostPathç›®å½•æ— æ•ˆ**



**é…ç½®å±žæ€§**

```bash
# é…ç½®å±žæ€§
kubectl explain pod.spec.volumes.hostPath
path                         # æŒ‡å®šå“ªä¸ªå®¿ä¸»æœºçš„ç›®å½•æˆ–æ–‡ä»¶è¢«å…±äº«ç»™Podä½¿ç”¨
type                         # æŒ‡å®šè·¯å¾„çš„ç±»åž‹ï¼Œä¸€å…±æœ‰7ç§ï¼Œé»˜è®¤çš„ç±»åž‹æ˜¯æ²¡æœ‰æŒ‡å®š
     ç©ºå­—ç¬¦ä¸²                 # é»˜è®¤é…ç½®ï¼Œåœ¨å…³è”hostPathå­˜å‚¨å·ä¹‹å‰ä¸è¿›è¡Œä»»ä½•æ£€æŸ¥ï¼Œå¦‚æžœå®¿ä¸»æœºæ²¡æœ‰å¯¹åº”çš„ç›®å½•ï¼Œä¼šè‡ªåŠ¨åˆ›å»º
     DirectoryCreate         # å®¿ä¸»æœºä¸Šä¸å­˜åœ¨ï¼Œåˆ›å»ºæ­¤0755æƒé™çš„ç©ºç›®å½•ï¼Œå±žä¸»å±žç»„å‡ä¸ºkubelet
     Directory               # å¿…é¡»å­˜åœ¨ï¼ŒæŒ‚è½½å·²å­˜åœ¨ç›®å½•
     FileOrCreate            # å®¿ä¸»æœºä¸Šä¸å­˜åœ¨æŒ‚è½½æ–‡ä»¶ï¼Œå°±åˆ›å»º0644æƒé™çš„ç©ºæ–‡ä»¶ï¼Œå±žä¸»å±žç»„å‡ä¸ºkubelet
     File                    # å¿…é¡»å­˜åœ¨æ–‡ä»¶
     Socket                  # äº‹å…ˆå¿…é¡»å­˜åœ¨Socketæ–‡ä»¶è·¯å¾„
     CharDevice              # äº‹å…ˆå¿…é¡»å­˜åœ¨çš„å­—ç¬¦è®¾å¤‡æ–‡ä»¶è·¯å¾„
     BlockDevice             # äº‹å…ˆå¿…é¡»å­˜åœ¨çš„å—è®¾å¤‡æ–‡ä»¶è·¯å¾„
     
     
# é…ç½®æ ¼å¼ï¼š
  volumes:
  - name: volume_name
    hostPath:
      path: /path/to/host
      
# ç¤ºä¾‹ï¼š
apiVersion: v1
kind: Pod
metadata:
  name: test-pod
  spec:
    containers:
    - image: registry.k8s.io/test-webserver
      name: test-container
      volumeMounts:
      - mountPath: /test-pod
        name: test-volume
    volumes:
    - name: test-volume
      hostPath:
        path: /data           # å®¿ä¸»æœºä¸Šç›®å½•ä½ç½®
        type: Directory       # æ­¤å­—æ®µä¸ºå¯é€‰
```



èŒƒä¾‹ï¼šä½¿ç”¨ä½ ä¸»æœºçš„æ—¶åŒºé…ç½®

```yaml
[root@master1 storage] # vim storage-hostpath-timezone.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-hostpath-timezone
spec:
  volumes:
  - name: timezone
    hostPath:
      path: /etc/timezone        # æ­¤æ–‡ä»¶æ˜¯å½±å“æ—¶åŒº
      type: File
  - name: localtime              # æ­¤æ–‡ä»¶æŒ‚è½½å¤±è´¥ï¼Œä¸å½±å“æ—¶åŒº
    hostPath:
      path: /etc/localtime
      type: File
  containers:
  - name: c01
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    command: ["sh", "-c", "sleep 3600"]
  - name: c02
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    command: ["sh", "-c", "sleep 3600"]
    volumeMounts:
    - name: timezone
      mountPath: /etc/timezone    # å®¹å™¨æ­¤ä¸ºæ–‡ä»¶æ˜¯æ™®é€šæ–‡ä»¶ï¼Œ æŒ‚è½½èŠ‚ç‚¹ç›®å½•æˆåŠŸ
    - name: localtime
      mountPath: /etc/localtime   # å®¹å™¨æ­¤ä¸ºæ–‡ä»¶æ˜¯è½¯è¿žæŽ¥ï¼Œ æŒ‚è½½èŠ‚ç‚¹ç›®å½•å¤±è´¥

# åº”ç”¨
[root@master1 storage] # kubectl apply -f storage-hostpath-timezone.yaml 
pod/pod-hostpath-timezone created

# æŸ¥çœ‹Pod
[root@master1 storage]#kubectl get pod
NAME                     READY   STATUS    RESTARTS      AGE
pod-hostpath-timezone    2/2     Running   0             3s

# æµ‹è¯•æ•ˆæžœ
[root@master1 storage] # kubectl exec pod-hostpath-timezone -c c01 -- date
Wed Dec 25 13:19:40 UTC 2024
[root@master1 storage] # kubectl exec pod-hostpath-timezone -c c02 -- date
Wed Dec 25 21:19:46 CST 2024

[root@master1 storage] # kubectl exec pod-hostpath-timezone -c c01 -- cat /etc/timezone
Etc/UTC
[root@master1 storage] # kubectl exec pod-hostpath-timezone -c c02 -- cat /etc/timezone
Asia/Shanghai
```



**èŒƒä¾‹ï¼šå®žçŽ°NFSæœåŠ¡**

```yaml
[root@master1 storage ]# cat storage-nfs-server.yaml
---
apiVersion: v1
kind: Service
metadata:
  name: nfs-server
  labels:
    app: nfs-server
spec:
  type: ClusterIP
  selector: 
    app: nfs-server
  ports:
    - name: tcp-2049            # æœªæ˜¾ç¤ºæŒ‡å®štartPortï¼Œé»˜è®¤å’Œportä¸€è‡´
      port: 2049
      protocol: TCP
    - name: udp-111
      port: 111
      protocol: UDP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-server
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nfs-server
  template:
    metadata:
      name: nfs-server
      labels:
        app: nfs-server
    spec:
      nodeSelector:
        "kubernetes.io/os": linux
        "server": nfs
      containers:
      - name: nfs-server
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nfs-server-alpine:12
        env:
        - name: SHARED_DIRECTORY
          value: "/exports"
        volumeMounts:
        - mountPath: /exports
          name: nfs-vol
        securityContext:
          privileged: true
        ports:                       # å£°æ˜Žæ€§è¯´æ˜Žï¼Œæ— ç›´æŽ¥åŠŸèƒ½ï¼Œé™¤éžServiceé…ç½®äº†targetPortåŒ¹é…è¿™äº›ç«¯å£
        - name: tcp-2049
          containerPort: 2049
          protocol: TCP
        - name: udp-111
          containerPort: 111
          protocol: UDP
      volumes:
      - name: nfs-vol
        hostPath:
          path: /nfs-vol
          type: DirectoryOrCreate
```



### ç½‘ç»œå…±äº«å­˜å‚¨

å’Œä¼ ç»Ÿçš„æ–¹å¼ä¸€æ ·, é€šè¿‡ NFS ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿå¯ä»¥å®žçŽ°Kubernetesæ•°æ®çš„ç½‘ç»œå­˜å‚¨å…±äº«

ä½¿ç”¨NFSæä¾›çš„å…±äº«ç›®å½•å­˜å‚¨æ•°æ®æ—¶ï¼Œéœ€è¦åœ¨ç³»ç»Ÿä¸­éƒ¨ç½²ä¸€ä¸ªNFSçŽ¯å¢ƒï¼Œé€šè¿‡volumeçš„é…ç½®ï¼Œå®žçŽ°pod å†…çš„å®¹å™¨é—´å…±äº«NFSç›®å½•ã€‚



**å±žæ€§è§£æž**

```bash
# é…ç½®å±žæ€§
kubectl explain pod.spec.volumes.nfs
server                                     #æŒ‡å®šnfsæœåŠ¡å™¨çš„åœ°å€
path                                       #æŒ‡å®šnfsæœåŠ¡å™¨æš´éœ²çš„å…±äº«åœ°å€
readOnly                                   #æ˜¯å¦åªèƒ½è¯»ï¼Œé»˜è®¤false

#é…ç½®æ ¼å¼ï¼š
 volumes:
  - name: <å·åç§°>
   nfs:
     server: nfs_server_address           #æŒ‡å®šNFSæœåŠ¡å™¨åœ°å€
     path: "å…±äº«ç›®å½•"                      #æŒ‡å®šNFSå…±äº«ç›®å½•
     readOnly: false                      #æŒ‡å®šæƒé™

# ç¤ºä¾‹
apiVersion: v1
kind: Pod
metadata:
 name: test-pd
spec:
 containers:
  - image: registry.k8s.io/test-webserver
   name: test-container
   volumeMounts:
    - mountPath: /my-nfs-data
     name: test-volume
 volumes:
  - name: test-volume
   nfs:
     server: my-nfs-server.example.com
     path: /my-nfs-volume
     readonly: true
```



èŒƒä¾‹ï¼šä½¿ç”¨é›†ç¾¤å¤–çš„NFSå­˜å‚¨

```bash
#NFSæœåŠ¡å™¨è½¯ä»¶å®‰è£…,10.0.0.131
[root@nfs ~]#apt update && apt install -y nfs-kernel-server æˆ–è€… nfs-server

#é…ç½®å…±äº«ç›®å½•
[root@nfs ~]#mkdir /nfs-data
[root@nfs ~]#echo '/nfs-data *(rw,all_squash,anonuid=0,anongid=0)' >> /etc/exports

#é‡å¯æœåŠ¡
[root@nfs ~]#exportfs -r
[root@nfs ~]#exportfs -v

# åœ¨æ‰€æœ‰kubernetesçš„workerèŠ‚ç‚¹å……å½“NFSå®¢æˆ·ç«¯ï¼Œéƒ½éœ€è¦å®‰è£…NFSå®¢æˆ·ç«¯è½¯ä»¶
[root@node1 ~]#apt update && apt -y install nfs-common æˆ–è€… nfs-client
[root@node2 ~]#apt update && apt -y install nfs-common æˆ–è€… nfs-client
[root@node3 ~]#apt update && apt -y install nfs-common æˆ–è€… nfs-client

#æµ‹è¯•è®¿é—®
[root@node1 ~]#showmount -e 10.0.0.131
Export list for 10.0.0.101:
/nfs-data *

#ç¼–å†™èµ„æºé…ç½®æ–‡ä»¶
[root@master1 storage]#cat storage-nfs-1.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: storage

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-nfs
  namespace: storage
  labels:
    app: nginx-nfs
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-nfs
  template:
    metadata:
      labels:
        app: nginx-nfs
    spec:
      volumes:
      - name: html
        nfs:
          server: nfs.mystical.org
          path: /nfs-data/nginx
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
        name: nginx
        volumeMounts:
        - name: html
          mountPath: /usr/share/nginx/html
          
# æ³¨æ„ï¼šnfsä¸­çš„åŸŸåè§£æžï¼Œä½¿ç”¨çš„å¼Nodeä¸Šçš„DNSï¼Œè€Œä¸æ˜¯COREDNSï¼Œæ‰€ä»¥éœ€è¦åœ¨NodeèŠ‚ç‚¹ä¸Šå°†DNSæŒ‡å‘ç§æœ‰DNS
```



### **PVå’ŒPVC**

![image-20241228171426884](D:\git_repository\cyber_security_learning\markdown_img\image-20241228171426884.png)

#### PV Persistent Volume å®šä¹‰

å·¥ä½œä¸­çš„å­˜å‚¨èµ„æºä¸€èˆ¬éƒ½æ˜¯ç‹¬ç«‹äºŽPodçš„ï¼Œå°†ä¹‹ç§°ä¸ºèµ„æºå¯¹è±¡Persistent Volume(PV)ï¼Œæ˜¯ç”±ç®¡ç†å‘˜è®¾ç½®çš„å­˜å‚¨ï¼Œå®ƒæ˜¯kubernetesé›†ç¾¤çš„ä¸€éƒ¨åˆ†ï¼ŒPV æ˜¯ Volume ä¹‹ç±»çš„å·æ’ä»¶ï¼Œ**ä½†å…·æœ‰ç‹¬ç«‹äºŽä½¿ç”¨ PV çš„ Pod  çš„ç”Ÿå‘½å‘¨æœŸ**



**Persistent Volume è·Ÿ Volumeç±»ä¼¼ï¼ŒåŒºåˆ«å°±æ˜¯ï¼š**

- PV æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œè´Ÿè´£å°†å­˜å‚¨ç©ºé—´å¼•å…¥åˆ°é›†ç¾¤ä¸­ï¼Œé€šå¸¸ç”±ç®¡ç†å‘˜å®šä¹‰
- PV å°±æ˜¯Kubernetesé›†ç¾¤ä¸­çš„ç½‘ç»œå­˜å‚¨ï¼Œä¸å±žäºŽNamespaceã€Nodeã€Podç­‰èµ„æºï¼Œä½†å¯ä»¥è¢«å®ƒä»¬è®¿é—®
- **PV å±žäºŽKubernetes æ•´ä¸ªé›†ç¾¤,å³å¯ä»¥è¢«æ‰€æœ‰é›†ç¾¤çš„Podè®¿é—®**
- **PVæ˜¯ç‹¬ç«‹çš„ç½‘ç»œå­˜å‚¨èµ„æºå¯¹è±¡ï¼Œæœ‰è‡ªå·±çš„ç”Ÿå‘½å‘¨æœŸ**
- PV æ”¯æŒå¾ˆå¤šç§volumeç±»åž‹,PVå¯¹è±¡å¯ä»¥æœ‰å¾ˆå¤šå¸¸è§çš„ç±»åž‹ï¼šæœ¬åœ°ç£ç›˜ã€NFSã€åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿ...



**PVæŒä¹…å·çš„ç±»åž‹**

PVæŒä¹…å·æ˜¯ç”¨æ’ä»¶çš„å½¢å¼æ¥å®žçŽ°çš„ã€‚Kubernetesç›®å‰æ”¯æŒä¸€ä¸‹æ’ä»¶ï¼š

- **cephfs** - CephFS volume
- **csi** - å®¹å™¨å­˜å‚¨æŽ¥å£ï¼ˆCSIï¼‰
- **fc** - Fibre Channelï¼ˆFCï¼‰å­˜å‚¨
- **hostPath** - HostPathå·ï¼ˆä»…ä¾›å•èŠ‚ç‚¹æµ‹è¯•ä½¿ç”¨ï¼Œä¸é€‚ç”¨äºŽå¤šèŠ‚ç‚¹é›†ç¾¤ï¼›è¯·å°è¯•ä½¿ç”¨lcoalä½œä¸ºæ›¿ä»£ï¼‰
- **iscsi** = iSCSIï¼ˆSCSI over IPï¼‰å­˜å‚¨
- **local** - èŠ‚ç‚¹ä¸ŠæŒ‚è½½çš„æœ¬åœ°å­˜å‚¨è®¾å¤‡
- **nfs** - ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿï¼ˆNFSï¼‰å­˜å‚¨
- **rbd** - Radoså—è®¾å¤‡ï¼ˆRBDï¼‰å·



#### PVC Persistent Volume Claimå®šä¹‰

Persistent Volume Claim(PVC) æ˜¯ä¸€ä¸ªç½‘ç»œå­˜å‚¨æœåŠ¡çš„**è¯·æ±‚**ã€‚

**PVC å±žäºŽåç§°ç©ºé—´çº§åˆ«çš„èµ„æº**ï¼Œåªèƒ½è¢«åŒä¸€ä¸ªåç§°ç©ºé—´çš„Podå¼•ç”¨

ç”±ç”¨æˆ·å®šä¹‰ï¼Œç”¨äºŽåœ¨ç©ºé—²çš„PVä¸­ç”³è¯·ä½¿ç”¨ç¬¦åˆè¿‡æ»¤æ¡ä»¶çš„PVä¹‹ä¸€ï¼Œä¸Žé€‰å®šçš„PVæ˜¯â€œä¸€å¯¹ä¸€â€çš„å…³ç³»

ç”¨æˆ·åœ¨Podä¸Š**é€šè¿‡pvcæ’ä»¶**è¯·æ±‚ç»‘å®šä½¿ç”¨å®šä¹‰å¥½çš„PVCèµ„æº

Podèƒ½å¤Ÿç”³è¯·ç‰¹å®šçš„CPUå’ŒMEMèµ„æºï¼Œä½†æ˜¯Podåªèƒ½é€šè¿‡PVCåˆ°PVä¸Šè¯·æ±‚ä¸€å—ç‹¬ç«‹å¤§å°çš„ç½‘ç»œå­˜å‚¨ç©º é—´ï¼Œè€ŒPVC å¯ä»¥åŠ¨æ€çš„æ ¹æ®ç”¨æˆ·è¯·æ±‚åŽ»ç”³è¯·PVèµ„æºï¼Œä¸ä»…ä»…æ¶‰åŠåˆ°å­˜å‚¨ç©ºé—´ï¼Œè¿˜æœ‰å¯¹åº”èµ„æºçš„è®¿é—®æ¨¡ å¼ï¼Œå¯¹äºŽçœŸæ­£ä½¿ç”¨å­˜å‚¨çš„ç”¨æˆ·ä¸éœ€è¦å…³å¿ƒåº•å±‚çš„å­˜å‚¨å®žçŽ°ç»†èŠ‚ï¼Œåªéœ€è¦ç›´æŽ¥ä½¿ç”¨ PVC å³å¯ã€‚



#### Podã€PVã€PVC å…³ç³»

![image-20241228172519330](D:\git_repository\cyber_security_learning\markdown_img\image-20241228172519330.png)



**å‰æï¼š**

- å­˜å‚¨ç®¡ç†å‘˜é…ç½®å„ç§ç±»åž‹çš„PVå¯¹è±¡
- Podã€PVC å¿…é¡»åœ¨åŒä¸€ä¸ªå‘½åç©ºé—´



**ç”¨æˆ·éœ€è¦å­˜å‚¨èµ„æºçš„æ—¶å€™ï¼š**

- ç”¨æˆ·æ ¹æ®èµ„æºéœ€æ±‚åˆ›å»ºPVCï¼Œç”±PVCè‡ªåŠ¨åŒ¹é…(æƒé™ã€å®¹é‡)åˆé€‚çš„PVå¯¹è±¡
- PVC å…è®¸ç”¨æˆ·æŒ‰éœ€æŒ‡å®šæœŸæœ›çš„å­˜å‚¨ç‰¹æ€§ï¼Œå¹¶ä»¥ä¹‹ä¸ºæ¡ä»¶ï¼ŒæŒ‰ç‰¹å®šçš„æ¡ä»¶é¡ºåºè¿›è¡ŒPVçš„è¿‡æ»¤ 
  - VolumeMode â†’ LabelSelector â†’ StorageClassName â†’ AccessMode â†’ Size 
- åœ¨Podå†…éƒ¨é€šè¿‡ PVC å°† PV ç»‘å®šåˆ°å½“å‰çš„ç©ºé—´ï¼Œè¿›è¡Œä½¿ç”¨
- å¦‚æžœç”¨æˆ·ä¸å†ä½¿ç”¨å­˜å‚¨èµ„æºï¼Œè§£ç»‘ PVC å’Œ Pod å³å¯



**PVå’ŒPVCçš„ç”Ÿå‘½å‘¨æœŸ**

![image-20241229204228667](D:\git_repository\cyber_security_learning\markdown_img\image-20241229204228667.png)





**PVå’ŒPVCçš„é…ç½®æµç¨‹**

![image-20241229204254515](D:\git_repository\cyber_security_learning\markdown_img\image-20241229204254515.png)



- ç”¨æˆ·åˆ›å»ºäº†ä¸€ä¸ªåŒ…å« PVC çš„ Podï¼Œè¯¥ PVC è¦æ±‚ä½¿ç”¨åŠ¨æ€å­˜å‚¨å·
- Scheduler æ ¹æ® Pod é…ç½®ã€èŠ‚ç‚¹çŠ¶æ€ã€PV é…ç½®ç­‰ä¿¡æ¯ï¼ŒæŠŠ Pod è°ƒåº¦åˆ°ä¸€ä¸ªåˆé€‚çš„ Worker èŠ‚ç‚¹ä¸Š
- PV æŽ§åˆ¶å™¨ watch åˆ°è¯¥ Pod ä½¿ç”¨çš„ PVC å¤„äºŽ Pending çŠ¶æ€ï¼ŒäºŽæ˜¯è°ƒç”¨ Volume Plugin(in-tree)åˆ› å»ºå­˜å‚¨å·ï¼Œå¹¶åˆ›å»º PV å¯¹è±¡(out-of-tree ç”± External Provisioner æ¥å¤„ç†)
- AD æŽ§åˆ¶å™¨å‘çŽ° Pod å’Œ PVC å¤„äºŽå¾…æŒ‚æŽ¥çŠ¶æ€ï¼ŒäºŽæ˜¯è°ƒç”¨ Volume Plugin æŒ‚æŽ¥å­˜å‚¨è®¾å¤‡åˆ°ç›®æ ‡ Worker èŠ‚ç‚¹ä¸Š
- åœ¨ Worker èŠ‚ç‚¹ä¸Šï¼ŒKubelet ä¸­çš„ Volume Manager ç­‰å¾…å­˜å‚¨è®¾å¤‡æŒ‚æŽ¥å®Œæˆï¼Œå¹¶é€šè¿‡ Volume  Plugin å°†è®¾å¤‡æŒ‚è½½åˆ°å…¨å±€ç›®å½•ï¼š**/var/lib/kubelet/pods/[pod_uid]/volumes/kubernetes.io~iscsi/[PVname] (ä»¥iscsiä¸ºä¾‹)**
- Kubelet é€šè¿‡ Docker å¯åŠ¨ Pod çš„ Containersï¼Œç”¨ bind mount æ–¹å¼å°†å·²æŒ‚è½½åˆ°æœ¬åœ°å…¨å±€ç›®å½•çš„å· æ˜ å°„åˆ°å®¹å™¨ä¸­



![image-20241229204525669](D:\git_repository\cyber_security_learning\markdown_img\image-20241229204525669.png)





#### PVå’ŒPVCç®¡ç†

**PVçš„Provison ç½®å¤‡ï¼ˆåˆ›å»ºï¼‰æ–¹æ³•**

- **é™æ€**ï¼šé›†ç¾¤ç®¡ç†å‘˜é¢„å…ˆæ‰‹åŠ¨åˆ›å»ºä¸€äº› PVã€‚å®ƒä»¬å¸¦æœ‰å¯ä¾›ç¾¤é›†ç”¨æˆ·ä½¿ç”¨çš„å®žé™…å­˜å‚¨çš„ç»†èŠ‚
- **åŠ¨æ€**ï¼šé›†ç¾¤å°è¯•æ ¹æ®ç”¨æˆ·è¯·æ±‚åŠ¨æ€åœ°è‡ªåŠ¨å®Œæˆåˆ›å»ºå·ã€‚æ­¤é…ç½®åŸºäºŽ StorageClassesï¼šPVC å¿…é¡»è¯· æ±‚å­˜å‚¨ç±»ï¼Œå¹¶ä¸”ç®¡ç†å‘˜å¿…é¡»é¢„å…ˆåˆ›å»ºå¹¶é…ç½®è¯¥ StorageClassesæ‰èƒ½è¿›è¡ŒåŠ¨æ€åˆ›å»ºã€‚å£°æ˜Žè¯¥ç±»ä¸ºç©ºå­— ç¬¦ä¸² ""ï¼Œ å¯ä»¥æœ‰æ•ˆåœ°ç¦ç”¨å…¶åŠ¨æ€é…ç½®ã€‚



##### PVå±žæ€§

```bash
# PVä½œä¸ºå­˜å‚¨èµ„æºï¼Œä¸»è¦åŒ…æ‹¬å­˜å‚¨èƒ½åŠ›ï¼Œè®¿é—®æ¨¡å¼ï¼Œå­˜å‚¨ç±»åž‹ï¼Œå›žæ”¶ç­–ç•¥ç­‰å…³é”®ä¿¡æ¯ï¼Œæ³¨æ„ï¼šPVçš„åç§°ä¸æ”¯æŒå¤§å†™
kubectl explain pv.spec
    capacity                            # å®šä¹‰pvä½¿ç”¨å¤šå°‘èµ„æºï¼Œä»…é™äºŽç©ºé—´çš„è®¾å®š
    accessModes                         # è®¿é—®æ¨¡å¼,æ”¯æŒå•è·¯è¯»å†™ï¼Œå¤šè·¯è¯»å†™ï¼Œå¤šè·¯åªè¯»ï¼Œå•Podè¯»å†™ï¼Œå¯åŒæ—¶æ”¯æŒå¤šç§æ¨¡å¼
    volumeMode                          # æ–‡ä»¶ç³»ç»Ÿæˆ–å—è®¾å¤‡,é»˜è®¤æ–‡ä»¶ç³»ç»Ÿ
    mountOptions                        # æŒ‚è½½é€‰é¡¹,æ¯”å¦‚:["ro", "soft"]    
    persistentVolumeReclaimPolicy       # èµ„æºå›žæ”¶ç­–ç•¥ï¼Œä¸»è¦ä¸‰ç§Retainã€Deleteã€Recycle 
    storageClassName                    # å­˜å‚¨ç±»çš„åç§°,å¦‚æžœé…ç½®å¿…é¡»å’ŒPVCçš„storageClassNameç›¸åŒæ‰èƒ½ç»‘å®š
    
#æ³¨æ„:PersistentVolume å¯¹è±¡çš„åç§°å¿…é¡»æ˜¯åˆæ³•çš„ DNS å­åŸŸå

# ç¤ºä¾‹
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv0003
  labels:
    release: "stable"    # ä¾¿ç­¾å¯ä»¥æ”¯æŒåŒ¹é…è¿‡æ»¤PVC
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteOnce
  persistentVolumeReclaimPolicy: Recycle
  storageClassName: slow  # å¿…é¡»å’ŒPVCç›¸åŒ
  mountOptions:
    - hard
    - nfsvers=4.1
  nfs:
    path: /tmp
    server: 172.17.0.2  
```



##### PVCå±žæ€§

```bash
#PVCå±žæ€§ä¿¡æ¯,ä¸Žæ‰€æœ‰ç©ºé—´éƒ½èƒ½ä½¿ç”¨çš„PVä¸ä¸€æ ·ï¼ŒPVCæ˜¯å±žäºŽåç§°ç©ºé—´çº§åˆ«çš„èµ„æºå¯¹è±¡ï¼Œå³åªæœ‰ç‰¹å®šçš„èµ„æºæ‰èƒ½ä½¿ç”¨
kubectl explain pvc.spec
    accessModes            # è®¿é—®æ¨¡å¼  
    resources              # èµ„æºé™åˆ¶
    volumeMode             # åŽç«¯å­˜å‚¨å·çš„æ¨¡å¼,æ–‡ä»¶ç³»ç»Ÿæˆ–å—,é»˜è®¤ä¸ºæ–‡ä»¶ç³»ç»Ÿ
    volumeName             # æŒ‡å®šç»‘å®šçš„å·(pv)çš„åç§°

kubectl explain pod.spec.volumes.persistentVolumeClaim
    claimName              # å®šä¹‰pvcçš„åç§°,PersistentVolumeClaim å¯¹è±¡çš„åç§°å¿…é¡»æ˜¯åˆæ³•çš„ DNS å­åŸŸå
    readOnly               # è®¾å®špvcæ˜¯å¦åªè¯»
    storageClassName       # å­˜å‚¨ç±»çš„åç§°,å¦‚æžœé…ç½®å¿…é¡»å’ŒPVçš„storageClassNameç›¸åŒæ‰èƒ½ç»‘å®š
    selector                # æ ‡ç­¾é€‰æ‹©å™¨å®žçŽ°é€‰æ‹©ç»‘å®šPV
    
# storageClassNameç±»
PVCå¯ä»¥é€šè¿‡ä¸ºstorageClassNameå±žæ€§è®¾ç½®StorageClassçš„åç§°æ¥è¯·æ±‚ç‰¹å®šçš„å­˜å‚¨ç±»ã€‚åªæœ‰æ‰€è¯·æ±‚çš„ç±»çš„PVçš„StorageClasså€¼ä¸ŽPVCè®¾ç½®ç›¸åŒï¼Œæ‰èƒ½ç»‘å®š

# selectoré€‰æ‹©ç®—ç¬¦
PVCå¯ä»¥è®¾ç½®æ ‡ç­¾é€‰æ‹©ç®—ç¬¦,æ¥è¿›ä¸€æ­¥è¿‡æ»¤å·é›†åˆã€‚åªæœ‰æ ‡ç­¾ä¸Žé€‰æ‹©ç®—ç¬¦ç›¸åŒ¹é…çš„å·èƒ½å¤Ÿç»‘å®šåˆ°PVCä¸Šã€‚é€‰æ‹©ç®—ç¬¦åŒ…å«ä¸¤ä¸ªå­—æ®µï¼š

matchLabels - å·å¿…é¡»åŒ…å«å¸¦æœ‰æ­¤å€¼çš„æ ‡ç­¾
 
matchExpressions - é€šè¿‡è®¾å®šé”®ï¼ˆkeyï¼‰ã€å€¼åˆ—è¡¨å’Œæ“ä½œç¬¦ï¼ˆoperatorï¼‰ æ¥æž„é€ çš„éœ€æ±‚ã€‚åˆæ³•çš„æ“ä½œç¬¦
æœ‰ Inã€NotInã€Exists å’Œ DoesNotExistã€‚
æ¥è‡ª matchLabels å’Œ matchExpressions çš„æ‰€æœ‰éœ€æ±‚éƒ½æŒ‰é€»è¾‘ä¸Žçš„æ–¹å¼ç»„åˆåœ¨ä¸€èµ·ã€‚ è¿™äº›éœ€æ±‚éƒ½å¿…é¡»è¢«æ»¡è¶³æ‰è¢«è§†ä¸ºåŒ¹é…ã€‚

# ç¤ºä¾‹ï¼š
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
  - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 8Gi
  storageClassName: slow  # å¿…é¡»å’ŒPVç›¸åŒ
  selectorï¼š
    matchLabels:
      release: "stable"
    matchExpressions:
    - {key: environment, operator: In, values: [dev]}
```





##### å±žæ€§è¿›é˜¶

**PVçŠ¶æ€**

PV æœ‰ç”Ÿå‘½å‘¨æœŸ,è‡ªç„¶ä¹Ÿæœ‰è‡ªå·±ç‰¹å®šçš„çŠ¶æ€

æ³¨æ„ï¼šè¿™ä¸ªè¿‡ç¨‹æ˜¯å•å‘è¿‡ç¨‹ï¼Œä¸èƒ½é€†å‘

![image-20241229210212463](D:\git_repository\cyber_security_learning\markdown_img\image-20241229210212463.png)

| çŠ¶æ€       | è§£æž                                                  |
| ---------- | ----------------------------------------------------- |
| Availabled | ç©ºé—²çŠ¶æ€ï¼Œè¡¨ç¤ºPVæ²¡æœ‰è¢«å…¶ä»–PVCå¯¹è±¡ä½¿ç”¨                 |
| Bound      | ç»‘å®šçŠ¶æ€ï¼Œè¡¨ç¤ºPVå·²ç»è¢«å…¶ä»–PVCå¯¹è±¡ä½¿ç”¨                 |
| Released   | æœªå›žæ”¶çŠ¶æ€ï¼Œè¡¨ç¤ºPVCå·²ç»è¢«åˆ é™¤äº†ï¼Œä½†æ˜¯èµ„æºè¿˜æ²¡æœ‰è¢«å›žæ”¶ |
| Faild      | èµ„æºå›žæ”¶å¤±è´¥                                          |



![image-20241229210316627](D:\git_repository\cyber_security_learning\markdown_img\image-20241229210316627.png)





**AccessMode è®¿é—®æ¨¡å¼**

AccessModes æ˜¯ç”¨æ¥å¯¹ PV è¿›è¡Œè®¿é—®æ¨¡å¼çš„è®¾ç½®ï¼Œç”¨äºŽæè¿°ç”¨æˆ·åº”ç”¨å¯¹å­˜å‚¨èµ„æºçš„è®¿é—®æƒé™ï¼Œè®¿é—®æƒé™åŒ…æ‹¬

| ç±»åž‹                   | è§£æž                                                         |
| ---------------------- | ------------------------------------------------------------ |
| ReadWriteOnceï¼ˆRWOï¼‰   | å•èŠ‚ç‚¹è¯»å†™,å·å¯ä»¥è¢«ä¸€ä¸ªèŠ‚ç‚¹ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ã€‚ <br />ReadWriteOnce è®¿é—®æ¨¡å¼ä»ç„¶å¯ä»¥åœ¨åŒä¸€èŠ‚ç‚¹ä¸Šè¿è¡Œçš„å¤šä¸ª Pod <br />è®¿é—®è¯¥å·å³ä¸æ”¯æŒå¹¶è¡Œ(éžå¹¶å‘)å†™å…¥ |
| ReadOnlyManyï¼ˆROXï¼‰    | å¤šèŠ‚ç‚¹åªè¯»                                                   |
| ReadWriteManyï¼ˆRWXï¼‰   | å¤šèŠ‚ç‚¹è¯»å†™                                                   |
| ReadWriteOncePod(RWOP) | å·å¯ä»¥è¢«å•ä¸ª Pod ä»¥è¯»å†™æ–¹å¼æŒ‚è½½ã€‚ å¦‚æžœä½ æƒ³ç¡®ä¿æ•´ä¸ªé›†ç¾¤ä¸­åª æœ‰ä¸€ä¸ª Pod å¯ä»¥è¯»å–æˆ–å†™å…¥è¯¥ PVCï¼Œ è¯·ä½¿ç”¨ ReadWriteOncePod è®¿é—®æ¨¡å¼ã€‚å•Podè¯»å†™,v1.22ç‰ˆä»¥åŽæ‰æ”¯ æŒ,v1.29ç‰ˆstableå¯ç”¨ |



æ³¨æ„ï¼š

- ä¸åŒçš„åŽç«¯å­˜å‚¨æ”¯æŒä¸åŒçš„è®¿é—®æ¨¡å¼ï¼Œæ‰€ä»¥è¦æ ¹æ®åŽç«¯å­˜å‚¨ç±»åž‹æ¥è®¾ç½®è®¿é—®æ¨¡å¼ã€‚
- ä¸€äº› PV å¯èƒ½æ”¯æŒå¤šç§è®¿é—®æ¨¡å¼ï¼Œä½†æ˜¯åœ¨æŒ‚è½½çš„æ—¶å€™åªèƒ½ä½¿ç”¨ä¸€ç§è®¿é—®æ¨¡å¼ï¼Œå¤šç§è®¿é—®æ¨¡å¼æ˜¯ä¸ä¼š ç”Ÿæ•ˆçš„



**PVèµ„æºå›žæ”¶ç­–ç•¥**

PV ä¸‰ç§èµ„æºå›žæ”¶ç­–ç•¥

å½“ Pod ç»“æŸ volume åŽå¯ä»¥å›žæ”¶èµ„æºå¯¹è±¡åˆ é™¤PVCï¼Œè€Œç»‘å®šå…³ç³»å°±ä¸å­˜åœ¨äº†ï¼Œå½“ç»‘å®šå…³ç³»ä¸å­˜åœ¨åŽè¿™ä¸ª PVéœ€è¦æ€Žä¹ˆå¤„ç†ï¼Œè€ŒPersistentVolume çš„å›žæ”¶ç­–ç•¥å‘Šè¯‰é›†ç¾¤åœ¨å­˜å‚¨å·å£°æ˜Žé‡Šæ”¾åŽåº”å¦‚ä½•å¤„ç†è¯¥PVå·ã€‚ ç›®å‰ï¼Œvolume çš„å¤„ç†ç­–ç•¥æœ‰ä¿ç•™ã€å›žæ”¶æˆ–åˆ é™¤ã€‚

å½“PVCè¢«åˆ é™¤åŽ, Kubernetes ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªrecycler-for-çš„Podå®žçŽ°å›žæ”¶å·¥ä½œ,ä½†Retainç­– ç•¥é™¤å¤–

å›žæ”¶å®ŒæˆåŽ,PVçš„çŠ¶æ€å˜ä¸ºAvailabled,å¦‚æžœå…¶å®ƒå¤„äºŽPendingçŠ¶æ€çš„PVCå’Œæ­¤PVæ¡ä»¶åŒ¹é…,åˆ™å¯ä»¥å†æ¬¡æ­¤ PVè¿›è¡Œç»‘å®š

| ç±»åž‹    | è§£æž                                                         |
| ------- | ------------------------------------------------------------ |
| Retain  | ä¿ç•™PVå’Œå­˜å‚¨ç©ºé—´æ•°æ®ï¼ŒåŽç»­æ•°æ®çš„åˆ é™¤éœ€è¦äººå·¥å¹²é¢„ï¼Œ**ä¸€èˆ¬æŽ¨èä½¿ç”¨æ­¤é¡¹**ï¼Œå¯¹äºŽ**æ‰‹åŠ¨åˆ›å»ºçš„PVæ­¤ä¸ºé»˜è®¤å€¼** |
| Delete  | ç›¸å…³çš„å­˜å‚¨å®žä¾‹PVå’Œæ•°æ®éƒ½ä¸€èµ·åˆ é™¤ã€‚éœ€è¦æ”¯æŒåˆ é™¤åŠŸèƒ½çš„å­˜å‚¨æ‰èƒ½å®žçŽ°ï¼Œ**åŠ¨æ€å­˜å‚¨ ä¸€èˆ¬ä¼šé»˜è®¤é‡‡ç”¨æ­¤æ–¹å¼** |
| Recycle | **å½“å‰æ­¤é¡¹å·²åºŸå¼ƒ**ï¼Œä¿ç•™PVï¼Œä½†æ¸…ç©ºå­˜å‚¨ç©ºé—´çš„æ•°æ®ï¼Œä»…æ”¯æŒNFSå’ŒhostPath |



##### PVå’ŒPVCçš„ä½¿ç”¨æµç¨‹

å®žçŽ°æ–¹æ³•

- å‡†å¤‡å­˜å‚¨
- åŸºäºŽå­˜å‚¨åˆ›å»ºPV
- æ ¹æ®éœ€æ±‚åˆ›å»ºPVC: PVCä¼šæ ¹æ®capacityå’ŒaccessModesåŠå…¶å®ƒæ¡ä»¶è‡ªåŠ¨æ‰¾åˆ°ç›¸åŒ¹é…çš„PVè¿›è¡Œç»‘å®š, ä¸€ä¸ªPVCå¯¹åº”ä¸€ä¸ªPV
- åˆ›å»ºPod
  - åœ¨Podä¸­çš„ volumes æŒ‡å®šè°ƒç”¨ä¸Šé¢åˆ›å»ºçš„ PVC åç§°
  - åœ¨Podä¸­çš„å®¹å™¨ä¸­çš„volumeMountsæŒ‡å®šPVCæŒ‚è½½å®¹å™¨å†…çš„ç›®å½•è·¯å¾„





##### æ¡ˆä¾‹

**PVå’ŒPVCä½¿ç”¨**

```yaml
[root@master1 storage] # cat storage-mysql-pv-pvc.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: mysql-pv-volume
  labels:
    type: local
spec:
  storageClassName: manual
  capacity:
    storage: 20Gi
  accessModes:
  - ReadWriteOnce
  hostPath:
    path: "/mnt/data"

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
spec:
  storageClassName: manual
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi

---
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  ports:
  - port: 3306
  selector:
    app: mysql
  clusterIP: None
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
spec:
  selector:
    matchLabels:
      app: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/mysql:8.0.29-oracle
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "123456"
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pv-claim

# å®‰è£…mysqlå®¢æˆ·ç«¯
[root@master1 storage] #apt install -y mysql-client

# é€šè¿‡svcåŸŸåï¼Œè§£æžå‡ºmysqlçš„podçš„IP
[root@master1 storage]#nslookup mysql.default.svc.cluster.local 10.96.0.10
Server:		10.96.0.10
Address:	10.96.0.10#53

Name:	mysql.default.svc.cluster.local
Address: 10.244.2.73

# æµ‹è¯•è®¿é—®
[root@master1 storage] # mysql -h10.244.2.73 -p123456 -uroot

# æŸ¥çœ‹Mysqlçš„Podæ‰€åœ¨ä¸»æœº
[root@master1 storage] # kubectl get pod -o wide
NAME                     READY   STATUS    RESTARTS   AGE     IP            NODE    NOMINATED NODE   READINESS GATES
mysql-7ffdfbdf6f-fsv6c   1/1     Running   0          7m34s   10.244.2.73   node2   <none>           <none>

# æŸ¥çœ‹node2èŠ‚ç‚¹çš„/mnt/dataï¼Œè‡ªåŠ¨åˆ›å»º/mnt/dataç›®å½•
[root@node2 ~] # cd /mnt/data/
[root@node2 data]#ls
 auto.cnf        client-cert.pem      ib_logfile0     mysql.sock           sys
 binlog.000001   client-key.pem       ib_logfile1     performance_schema   undo_001
 binlog.000002  '#ib_16384_0.dblwr'   ibtmp1          private_key.pem      undo_002
 binlog.index   '#ib_16384_1.dblwr'  '#innodb_temp'   public_key.pem
 ca-key.pem      ib_buffer_pool       mysql           server-cert.pem
 ca.pem          ibdata1              mysql.ibd       server-key.pem
```



èŒƒä¾‹ï¼šä»¥NFSç±»åž‹åˆ›å»ºä¸€ä¸ª3Gå¤§å°çš„å­˜å‚¨èµ„æºå¯¹è±¡PV

```yaml
# å‡†å¤‡NFSå…±äº«å­˜å‚¨
[root@master1 ~] #mkdir /nfs-data
[root@master1 ~] #apt -y install nfs-server
[root@master1 ~] #echo "/nfs-data *(rw,no_root_squash)" >> /etc/exports
[root@master1 ~] #exportfs -r
[root@master1 ~] #exportfs -v
/nfs-data     <world>
(rw,wdelay,no_root_squash,no_subtree_check,sec=sys,rw,secure,no_root_squash,no_a
ll_squash)

#åœ¨æ‰€æœ‰workerèŠ‚ç‚¹å®‰è£…nfsè½¯ä»¶
[root@node1 ~] #apt -y install nfs-common

# å‡†å¤‡PVï¼Œå®šåˆ¶ä¸€ä¸ªå…·ä½“ç©ºé—´å¤§å°çš„å­˜å‚¨å¯¹è±¡
[root@master1 ~] #cat storage-pv.yaml 
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-test
spec:
  capacity:
    storage: 3Gi
  accessModes:
    - ReadWriteOnce
    - ReadWriteMany
    - ReadOnlyMany
  nfs:
    path: /nfs-data
    server: nfs.mystical.org # éœ€è¦åç§°è§£æž

# åº”ç”¨
[root@master1 ~] #kubectl apply -f storage-pv.yaml
persistentvolume/pv-test created

# æŸ¥çœ‹
[root@master1 ~] #kubectl get pv
NAME     CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM   
STORAGECLASS   REASON   AGE
pv-test   3Gi       RWO,ROX,RWX   Retain           Available                   
                7s
# ç»“æžœæ˜¾ç¤ºï¼šè™½ç„¶æˆ‘ä»¬åœ¨åˆ›å»ºpvçš„æ—¶å€™æ²¡æœ‰æŒ‡å®šå›žæ”¶ç­–ç•¥ï¼Œè€Œå…¶ç­–ç•¥è‡ªåŠ¨å¸®æˆ‘ä»¬é…ç½®äº†Retain

# å‡†å¤‡PVCï¼Œå®šä¹‰ä¸€ä¸ªèµ„æºå¯¹è±¡ï¼Œè¯·æ±‚ç©ºé—´1Gi
[root@master1 ~] #cat storage-pvc.yaml 
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-test
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 1Gi
#æ³¨æ„ï¼šè¯·æ±‚çš„èµ„æºå¤§å°å¿…é¡»åœ¨ pvèµ„æºçš„èŒƒå›´å†…

[root@master1 ~] #kubectl apply -f storage-pvc.yaml

#ç»“æžœæ˜¾ç¤ºï¼šä¸€æ—¦å¯åŠ¨pvcä¼šè‡ªåŠ¨åŽ»æœå¯»åˆé€‚çš„å¯ç”¨çš„pvï¼Œç„¶åŽç»‘å®šåœ¨ä¸€èµ·
#å¦‚æžœpvcæ‰¾ä¸åˆ°å¯¹åº”çš„pvèµ„æºï¼ŒçŠ¶æ€ä¼šä¸€ç›´å¤„äºŽpending

# å‡†å¤‡Pod
[root@master1 ~] #cat storage-nginx-pvc.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: Pod-nginx
spec:
  volumes:
  - name: volume-nginx
    persistentVolumeClaim:
      claimName: pvc-test
  containers:
  - name: pvc-nginx-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: volume-nginx
      mountPath: "/usr/share/nginx/html"
      
#å±žæ€§è§£æžï¼š
#spec.volumes æ˜¯é’ˆå¯¹podèµ„æºç”³è¯·çš„å­˜å‚¨èµ„æºæ¥è¯´çš„ï¼Œè¿™é‡Œä½¿ç”¨çš„ä¸»è¦æ˜¯pvcçš„æ–¹å¼ã€‚
#spec.containers.volumeMounts æ˜¯é’ˆå¯¹podèµ„æºå¯¹ç”³è¯·çš„å­˜å‚¨èµ„æºçš„ä¿¡æ¯ã€‚å°†pvcæŒ‚è½½çš„å®¹å™¨ç›®å½• 
```



**æ¡ˆä¾‹ï¼š PVCè‡ªåŠ¨ç»‘å®šç›¸åŒ¹é…çš„PV,PVCå’Œ PV æ˜¯è‡ªåŠ¨å…³è”çš„ï¼Œè€Œä¸”ä¼šåŒ¹é…å®¹é‡å’Œæƒé™**

```yaml
[root@master1 ~] # mkdir /nfs-data/data{1..3}
[root@master1 ~] # cat /etc/exports
/nfs-data *(rw,no_root_squash)

# PVæ¸…å•æ–‡ä»¶
[root@master1 ~] # cat storage-multi-pv.yaml
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-1
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
    - ReadWriteMany
  persistentVolumeclaimPolicy: Retain
  nfs:
    path: "/nfs-data/data1"
    server: nfs.mystical.org
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-2
spec:
  capacity:
    storage: 5Gi
  volumeMode: Filesystem
  accessModes:
  - ReadOnlyMany
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: "/nfs-data/data2"
    server: nfs.mystical.org
---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-nfs-3
spec:
  capacity:
    storage: 1Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Retain
  nfs:
    path: "/nfs-data/data3"
    server: nfs.mystical.org

# åº”ç”¨
[root@master1 ~] # kubectl apply -f storage-multi-pv.yaml

# kubectl get pv
[root@master1 storage] # kubectl get pv
NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pv-nfs-1   5Gi        RWX            Retain           Available                          <unset>                          3s
pv-nfs-2   5Gi        ROX            Retain           Available                          <unset>                          2m13s
pv-nfs-3   1Gi        RWO            Retain           Available                          <unset>                          2m13s


# PVCæ¸…å•æ–‡ä»¶
[root@master1 ~] # cat storage-multi-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-demo-1
  namespace: default
spec:
  accessModes: ["ReadWriteMany"]
  volumeMode: Filesystem
  resources:
    requests:
      storage: 3Gi
    limits:
      storage: 10Gi
      
# åº”ç”¨
[root@master1 storage] # kubectl apply -f storage-multi-pvc.yaml 
persistentvolumeclaim/pvc-demo-1 created

# æŸ¥çœ‹PVC
[root@master1 storage] # kubectl get pvc
NAME         STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
pvc-demo-1   Bound    pv-nfs-1   5Gi        RWX                           <unset>                 14s

# è‡ªåŠ¨ç»‘å®šPVCè‡³å®¹å™¨å’Œæƒé™éƒ½åŒ¹é…çš„PV
[root@master1 storage]#kubectl get pv
NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM                STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pv-nfs-1   5Gi        RWX            Retain           Bound       default/pvc-demo-1                  <unset>                          3m7s
pv-nfs-2   5Gi        ROX            Retain           Available                                       <unset>                          5m17s
pv-nfs-3   1Gi        RWO            Retain           Available                                       <unset>                          5m17s
```



##### å¼ºåˆ¶åˆ é™¤

ç”Ÿäº§ä¸­ï¼Œå¯¹äºŽå­˜å‚¨èµ„æºçš„é‡Šæ”¾ï¼Œæœ€å¥½æŒ‰ç…§æµç¨‹æ¥ï¼Œå³å…ˆæ¸…ç©ºåº”ç”¨ï¼Œç„¶åŽåœ¨æ¸…ç©ºpvcï¼Œä½†æ˜¯ç”Ÿäº§ä¸­ï¼Œç»å¸¸é‡ åˆ°åº”ç”¨èµ„æºæ„å¤–ç»ˆæ­¢æˆ–è€…å…¶ä»–æƒ…å†µï¼Œå¯¼è‡´æˆ‘ä»¬çš„pvcèµ„æºæ²¡æœ‰ä½¿ç”¨ï¼Œè€Œä¸”ä¹Ÿæ²¡æœ‰æ¸…ç©º

æœ‰å¤šç§æ–¹å¼è§£å†³ï¼Œæœ€å¸¸ç”¨çš„ä¸€ç§æ–¹å¼å°±æ˜¯ï¼Œåœ¨æ‰€æœ‰çš„åº”ç”¨podä¸­å¢žåŠ ä¸€ä¸ªprestopçš„é’©å­å‡½æ•°ï¼Œä»Žè€Œè®©æˆ‘ä»¬çš„åº”ç”¨èµ„æºåˆç†çš„æ¸…ç©º

**è€Œå¯¹äºŽç‰¹æ®Šçš„å¼‚å¸¸æƒ…å†µï¼Œæˆ‘ä»¬è¿˜æœ‰å¦å¤–ä¸€ç§ç­–ç•¥ï¼Œå³å¼ºåˆ¶æ¸…ç©º,ä½†æ˜¯ä¸€èˆ¬ä¸æŽ¨èä½¿ç”¨ã€‚**

```yaml
#å¯¹äºŽè¿™ç§æ— è®ºä½•ç§æ–¹æ³•éƒ½æ— æ³•åˆ é™¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®å±žæ€§çš„æ–¹å¼ï¼Œä»Žè®°å½•ä¸­åˆ é™¤è¯¥ä¿¡æ¯
[root@master1 ~]#kubectl patch pv pv-nfs-1 -p '{"metadata":{"finalizers":null}}'
persistentvolume/pv-nfs-1 patched
```



##### subPath

ä¸Šé¢èŒƒä¾‹ä¸­çš„nginxé¦–é¡µå­˜æ”¾åœ¨/nfs-dataçš„ä¸€çº§ç›®å½•ä¸­ï¼Œä½†æ˜¯ç”Ÿäº§ä¸­ï¼Œä¸€ä¸ªNFSå…±äº«èµ„æºé€šå¸¸æ˜¯ç»™å¤šä¸ªåº” ç”¨æ¥ä½¿ç”¨çš„ï¼Œæ¯”å¦‚éœ€è¦å®šåˆ¶æ¯ä¸ªappçš„åˆ†é…å•ç‹¬çš„å­ç›®å½•å­˜æ”¾é¦–é¡µèµ„æºï¼Œä½†æ˜¯å¦‚æžœæˆ‘ä»¬é‡‡ç”¨PVå®žçŽ°å®šåˆ¶ çš„æ–¹å¼ï¼Œå°±éœ€è¦å¤šä¸ªPV,æ­¤æ–¹å¼æœ‰äº›å¤ªç¹çäº† 

**å¯ä»¥é€šè¿‡subPathå®žçŽ°é’ˆå¯¹ä¸åŒçš„åº”ç”¨å¯¹åº”å­ç›®å½•çš„æŒ‚è½½**

volumeMounts.subPath å±žæ€§å¯ç”¨äºŽæŒ‡å®šæ‰€å¼•ç”¨çš„å·å†…çš„å­è·¯å¾„ï¼Œè€Œä¸æ˜¯å…¶æ ¹è·¯å¾„ã€‚

ä¸‹é¢ä¾‹å­å±•ç¤ºäº†å¦‚ä½•é…ç½®æŸåŒ…å« LAMP å †æ ˆï¼ˆLinux Apache MySQL PHPï¼‰çš„ Pod ä½¿ç”¨åŒä¸€å…±äº«å·ã€‚ **æ­¤ç¤ºä¾‹ä¸­çš„ subPath é…ç½®ä¸å»ºè®®åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ä½¿ç”¨**ã€‚ PHP åº”ç”¨çš„ä»£ç å’Œç›¸å…³æ•°æ®æ˜ å°„åˆ°å·çš„ html æ–‡ ä»¶å¤¹ï¼ŒMySQL æ•°æ®åº“å­˜å‚¨åœ¨å·çš„ mysql æ–‡ä»¶å¤¹ä¸­ï¼š

```yaml
[root@master1 storage] # cat storage-nginx-pvc-subdir.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-nginx-1
spec:
  volume:
  - name: nginx-volume
    persistentVolumeClaim:
      claimName: pvc-test
  containers:
  - name: nginx-pv
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: nginx-volume
      mountPath: "/usr/share/nginx/html"
      subPath: web1
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-nginx-2
spec:
  volumes:
  - name: nginx-volume
    persistentVolumeClaim:
      claimName: pvc-test
  containers:
  - name: nginx-flask
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: nginx-volume
      mountPath: "/usr/share/nginx/html"
      subPath: web2
```





### StorageClass

#### storageClassè¯´æ˜Ž

å¯¹äºŽ PV å’Œ PVC çš„ä½¿ç”¨æ•´ä¸ªè¿‡ç¨‹æ˜¯æ¯”è¾ƒç¹ççš„ï¼Œä¸ä»…éœ€è¦è‡ªå·±å®šä¹‰PVå’ŒPVCè¿˜éœ€è¦å°†å…¶ä¸ŽPodè¿›è¡Œå…³ è”ï¼Œè€Œä¸”å¯¹äºŽPVå’ŒPVCçš„é€‚é…æˆ‘ä»¬ä¹Ÿè¦åšå¥½å‰æè§„åˆ’ï¼Œè€Œç”Ÿäº§çŽ¯å¢ƒä¸­ï¼Œè¿™ç§ç¹ççš„äº‹æƒ…æ˜¯æœ‰æ‚–äºŽæˆ‘ä»¬ä½¿ ç”¨kubernetesçš„åŽŸåˆ™çš„ï¼Œè€Œä¸”è¿™ç§æ–¹å¼åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ï¼Œè€Œä¸”ä¸åŒçš„åº”ç”¨ç¨‹åºå¯¹äºŽ å­˜å‚¨æ€§èƒ½çš„è¦æ±‚å¯èƒ½ä¹Ÿä¸å°½ç›¸åŒï¼Œæ¯”å¦‚è¯»å†™é€Ÿåº¦ã€å¹¶å‘æ€§èƒ½ç­‰ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ªåº”ç”¨éœ€è¦å¯¹å­˜å‚¨çš„å¹¶å‘ åº¦è¦æ±‚æ¯”è¾ƒé«˜ï¼Œè€Œå¦å¤–ä¸€ä¸ªåº”ç”¨å¯¹è¯»å†™é€Ÿåº¦åˆè¦æ±‚æ¯”è¾ƒé«˜ï¼Œç‰¹åˆ«æ˜¯å¯¹äºŽ StatefulSet ç±»åž‹çš„åº”ç”¨ç®€å•çš„æ¥ ä½¿ç”¨é™æ€çš„ PV å°±å¾ˆä¸åˆé€‚äº†ï¼Œè¿™ç§æƒ…å†µä¸‹å°±éœ€è¦ç”¨åˆ°**åŠ¨æ€ PV**ã€‚



Kubernetes å¼•å…¥äº†ä¸€ä¸ª**æ–°çš„èµ„æºå¯¹è±¡ï¼šStorageClass**ï¼Œé€šè¿‡ StorageClass çš„å®šä¹‰ï¼Œç®¡ç†å‘˜å¯ä»¥å°†å­˜å‚¨èµ„æºå®šä¹‰ä¸ºæŸç§ç±»åž‹çš„èµ„æºï¼Œæ¯”å¦‚å­˜å‚¨è´¨é‡ã€å¿«é€Ÿå­˜å‚¨ã€æ…¢é€Ÿå­˜å‚¨ç­‰ï¼Œä¸ºäº†æ»¡è¶³ä¸åŒç”¨æˆ·çš„å¤šç§å¤šæ ·çš„ éœ€æ±‚ï¼Œç”¨æˆ·æ ¹æ® StorageClass çš„æè¿°å°±å¯ä»¥éžå¸¸ç›´è§‚çš„çŸ¥é“å„ç§å­˜å‚¨èµ„æºçš„å…·ä½“ç‰¹æ€§äº†ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®åº”ç”¨çš„ç‰¹æ€§åŽ»ç”³è¯·åˆé€‚çš„å­˜å‚¨èµ„æºäº†ã€‚

æ‰€ä»¥,StorageClassæä¾›äº†ä¸€ç§èµ„æºä½¿ç”¨çš„æè¿°æ–¹å¼ï¼Œä½¿å¾—ç®¡ç†å‘˜èƒ½å¤Ÿæè¿°æä¾›çš„å­˜å‚¨çš„æœåŠ¡è´¨é‡å’Œç­‰çº§ï¼Œè¿›è€Œåšå‡ºä¸åŒçº§åˆ«çš„å­˜å‚¨æœåŠ¡å’ŒåŽç«¯ç­–ç•¥ã€‚

StorageClass ç”¨äºŽå®šä¹‰ä¸åŒçš„å­˜å‚¨é…ç½®å’Œå±žæ€§ï¼Œä»¥ä¾› PersistentVolumeï¼ˆPVï¼‰çš„åŠ¨æ€åˆ›å»ºå’Œç®¡ç†ã€‚å®ƒ ä¸ºå¼€å‘äººå‘˜å’Œç®¡ç†å‘˜æä¾›äº†ä¸€ç§åœ¨ä¸åŒçš„å­˜å‚¨æä¾›å•†ä¹‹é—´æŠ½è±¡å‡ºå­˜å‚¨é…ç½®çš„æ–¹å¼ã€‚

**åœ¨ Kubernetes ä¸­ï¼ŒStorageClass æ˜¯é›†ç¾¤çº§åˆ«çš„èµ„æºï¼Œè€Œä¸æ˜¯åç§°ç©ºé—´çº§åˆ«ã€‚**

PVCå’ŒPVå¯ä»¥å±žäºŽæŸä¸ªSCï¼Œä¹Ÿå¯ä»¥ä¸å±žäºŽä»»ä½•SC,PVCåªèƒ½å¤Ÿåœ¨åŒä¸€ä¸ªstorageClassä¸­è¿‡æ»¤PV



**èƒ½å»ºç«‹ç»‘å®šå…³ç³»çš„PVCå’ŒPVä¸€å®šæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼š**

- äºŒè€…éš¶å±žäºŽåŒä¸ªSC
- äºŒè€…éƒ½ä¸å±žäºŽä»»ä½•SC



**StorageClassè¿™ä¸ªAPIå¯¹è±¡å¯ä»¥è‡ªåŠ¨åˆ›å»ºPVçš„æœºåˆ¶,å³:Dynamic Provisioning**



**StorageClasså¯¹è±¡ä¼šå®šä¹‰ä¸‹é¢ä¸¤éƒ¨åˆ†å†…å®¹:**

- PVçš„å±žæ€§.æ¯”å¦‚,å­˜å‚¨ç±»åž‹,Volumeçš„å¤§å°ç­‰
- åˆ›å»ºè¿™ç§PVéœ€è¦ç”¨åˆ°çš„å­˜å‚¨æ’ä»¶

æä¾›ä»¥ä¸Šä¸¤ä¸ªä¿¡æ¯,Kuberneteså°±èƒ½å¤Ÿæ ¹æ®ç”¨æˆ·æäº¤çš„PVC,æ‰¾åˆ°ä¸€ä¸ªå¯¹åº”çš„StorageClass,ä¹‹åŽ Kuberneteså°±ä¼šè°ƒç”¨è¯¥StorageClasså£°æ˜Žçš„å­˜å‚¨æ’ä»¶,è¿›è€Œåˆ›å»ºå‡ºéœ€è¦çš„PV.



è¦ä½¿ç”¨ StorageClassï¼Œå°±å¾—**å®‰è£…å¯¹åº”çš„è‡ªåŠ¨é…ç½®ç¨‹åº**ï¼Œæ¯”å¦‚å­˜å‚¨åŽç«¯ä½¿ç”¨çš„æ˜¯ nfsï¼Œé‚£ä¹ˆå°±éœ€è¦ä½¿ç”¨åˆ° ä¸€ä¸ª nfs-client çš„è‡ªåŠ¨é…ç½®ç¨‹åºï¼Œä¹Ÿç§°ä¸º Provisionerï¼Œè¿™ä¸ªç¨‹åºä½¿ç”¨å·²ç»é…ç½®å¥½çš„ nfs æœåŠ¡å™¨ï¼Œæ¥è‡ªåŠ¨ åˆ›å»ºæŒä¹…å· PVã€‚



#### storageClass API

æ¯ä¸ª StorageClass éƒ½åŒ…å« **provisioner** ã€ **parameters** å’Œ **reclaimPolicy** å­—æ®µï¼Œ è¿™äº›å­—æ®µä¼šåœ¨ StorageClass éœ€è¦åŠ¨æ€åˆ¶å¤‡ PersistentVolume æ—¶ä¼šä½¿ç”¨åˆ°ã€‚

StorageClass å¯¹è±¡çš„å‘½åå¾ˆé‡è¦ï¼Œç”¨æˆ·ä½¿ç”¨è¿™ä¸ªå‘½åæ¥è¯·æ±‚ç”Ÿæˆä¸€ä¸ªç‰¹å®šçš„ç±»ã€‚ å½“åˆ›å»º StorageClass  å¯¹è±¡æ—¶ï¼Œç®¡ç†å‘˜è®¾ç½® StorageClass å¯¹è±¡çš„å‘½åå’Œå…¶ä»–å‚æ•°ã€‚

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: standard
provisioner: kubernetes.io/aws-ebs
parameters:
  type: gp2
reclaimPolicy: Retain
allowVolumeExpansion: true
mountOptions:
- debug
volumeBindingMode: Immediate | WaitForFirstConsumerï¼ˆå»¶è¿Ÿç»‘å®šï¼Œåªæœ‰Podå‡†å¤‡å¥½æ‰ç»‘å®šï¼‰

# ç®¡ç†å‘˜å¯ä»¥ä¸ºæ²¡æœ‰ç”³è¯·ç»‘å®šåˆ°ç‰¹å®šStorageClassçš„PVCæŒ‡å®šä¸€ä¸ªé»˜è®¤çš„å­˜å‚¨ç±»
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: myclaim
spec:
  accessModes:
  - ReadWriteOnce
  volumeMode: Filesystem
  resources:
    requests:
      storage: 8Gi
  storageClassName: standard
  selector:
    matchLabels:
      release: "stable"
    matchExpressions:
      - {key: environment, operator: In, values: [dev]}
```



#### å­˜å‚¨åˆ¶å¤‡å™¨

æ¯ä¸ª StorageClass éƒ½æœ‰**ä¸€ä¸ªåˆ¶å¤‡å™¨ï¼ˆProvisionerï¼‰**ï¼Œç”¨äºŽæä¾›å­˜å‚¨é©±åŠ¨ï¼Œç”¨æ¥å†³å®šä½¿ç”¨å“ªä¸ªå·æ’ä»¶åˆ¶å¤‡ PVã€‚ **è¯¥å­—æ®µå¿…é¡»æŒ‡å®š**

| å·æ’ä»¶         | å†…ç½®åˆ¶å¤‡å™¨ |                           é…ç½®ç¤ºä¾‹                           |
| :------------- | :--------: | :----------------------------------------------------------: |
| AzureFile      |     âœ“      | [Azure File](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#azure-file) |
| CephFS         |     -      |                              -                               |
| FC             |     -      |                              -                               |
| FlexVolume     |     -      |                              -                               |
| iSCSI          |     -      |                              -                               |
| Local          |     -      | [Local](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#local) |
| NFS            |     -      | [NFS](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#nfs) |
| PortworxVolume |     âœ“      | [Portworx Volume](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#portworx-volume) |
| RBD            |     âœ“      | [Ceph RBD](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#ceph-rbd) |
| VsphereVolume  |     âœ“      | [vSphere](https://kubernetes.io/zh-cn/docs/concepts/storage/storage-classes/#vsphere) |





#### Local Volume



#####  hostPathå­˜åœ¨çš„é—®é¢˜

è¿‡åŽ»æˆ‘ä»¬ç»å¸¸ä¼šé€šè¿‡hostPath volumeè®©Podèƒ½å¤Ÿä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼Œå°†Nodeæ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶æˆ–è€…ç›®å½•æŒ‚ è½½åˆ°å®¹å™¨å†…ï¼Œä½†æ˜¯hostPath volumeçš„ä½¿ç”¨æ˜¯å¾ˆéš¾å—çš„ï¼Œå¹¶ä¸é€‚åˆåœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ä½¿ç”¨ã€‚

- ç”±äºŽé›†ç¾¤å†…æ¯ä¸ªèŠ‚ç‚¹çš„å·®å¼‚åŒ–ï¼Œè¦ä½¿ç”¨hostPath Volumeï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡**NodeSelector**ç­‰æ–¹å¼è¿›è¡Œç²¾ç¡®è°ƒåº¦ï¼Œè¿™ç§äº‹æƒ…å¤šäº†ï¼Œä½ å°±ä¼šä¸è€çƒ¦äº†ã€‚

- æ³¨æ„DirectoryOrCreateå’ŒFileOrCreateä¸¤ç§ç±»åž‹çš„hostPathï¼Œå½“Nodeä¸Šæ²¡æœ‰å¯¹åº”çš„ File/Directoryæ—¶ï¼Œä½ éœ€è¦ä¿**è¯kubeletæœ‰åœ¨ Nodeä¸ŠCreate File/Directoryçš„æƒé™**ã€‚
- å¦å¤–ï¼Œå¦‚æžœNodeä¸Šçš„æ–‡ä»¶æˆ–ç›®å½•æ˜¯ç”±rootåˆ›å»ºçš„ï¼ŒæŒ‚è½½åˆ°å®¹å™¨å†…ä¹‹åŽï¼Œä½ é€šå¸¸è¿˜è¦ä¿è¯å®¹å™¨å†…è¿›ç¨‹æœ‰æƒé™å¯¹è¯¥æ–‡ä»¶æˆ–è€…ç›®å½•è¿›è¡Œå†™å…¥ï¼Œæ¯”å¦‚ä½ éœ€è¦ä»¥rootç”¨æˆ·å¯åŠ¨è¿›ç¨‹å¹¶è¿è¡ŒäºŽprivilegedå®¹å™¨ï¼Œ æˆ–è€…ä½ éœ€è¦äº‹å…ˆä¿®æ”¹å¥½Nodeä¸Šçš„æ–‡ä»¶æƒé™é…ç½®ã€‚
- **Schedulerå¹¶ä¸ä¼šè€ƒè™‘hostPath volumeçš„å¤§å°ï¼ŒhostPathä¹Ÿä¸èƒ½ç”³æ˜Žéœ€è¦çš„storagesize**ï¼Œè¿™æ ·è°ƒåº¦æ—¶å­˜å‚¨çš„è€ƒè™‘ï¼Œå°±éœ€è¦äººä¸ºæ£€æŸ¥å¹¶ä¿è¯ã€‚



#####  Local PV ä½¿ç”¨åœºæ™¯

Local Persistent Volume å¹¶ä¸é€‚ç”¨äºŽæ‰€æœ‰åº”ç”¨ã€‚å®ƒçš„é€‚ç”¨èŒƒå›´éžå¸¸å›ºå®šï¼Œæ¯”å¦‚ï¼šé«˜ä¼˜å…ˆçº§çš„ç³»ç»Ÿåº”ç”¨ï¼Œ éœ€è¦åœ¨å¤šä¸ªä¸åŒèŠ‚ç‚¹ä¸Šå­˜å‚¨æ•°æ®ï¼Œè€Œä¸”å¯¹ I/O è¦æ±‚è¾ƒé«˜ã€‚Kubernetes ç›´æŽ¥ä½¿ç”¨å®¿ä¸»æœºçš„æœ¬åœ°ç£ç›˜ç›®å½• ï¼Œæ¥æŒä¹…åŒ–å­˜å‚¨å®¹å™¨çš„æ•°æ®ã€‚å®ƒçš„**è¯»å†™æ€§èƒ½ç›¸æ¯”äºŽå¤§å¤šæ•°è¿œç¨‹å­˜å‚¨æ¥è¯´ï¼Œè¦å¥½å¾—å¤šï¼Œå°¤å…¶æ˜¯ SSD ç›˜**ã€‚

å…¸åž‹çš„åº”ç”¨åŒ…æ‹¬ï¼šåˆ†å¸ƒå¼æ•°æ®å­˜å‚¨æ¯”å¦‚ MongoDBï¼Œåˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿæ¯”å¦‚ GlusterFSã€Ceph ç­‰ï¼Œä»¥åŠéœ€ è¦åœ¨æœ¬åœ°ç£ç›˜ä¸Šè¿›è¡Œå¤§é‡æ•°æ®ç¼“å­˜çš„åˆ†å¸ƒå¼åº”ç”¨ï¼Œå…¶æ¬¡ä½¿ç”¨ Local Persistent Volume çš„åº”ç”¨å¿…é¡»å…·å¤‡ æ•°æ®å¤‡ä»½å’Œæ¢å¤çš„èƒ½åŠ›ï¼Œå…è®¸ä½ æŠŠè¿™äº›æ•°æ®å®šæ—¶å¤‡ä»½åœ¨å…¶ä»–ä½ç½®ã€‚



#####  Local PV çš„å®žçŽ°

LocalPV çš„å®žçŽ°å¯ä»¥ç†è§£ä¸ºæˆ‘ä»¬å‰é¢ä½¿ç”¨çš„ hostpath åŠ ä¸Š nodeAffinity ï¼Œæ¯”å¦‚ï¼šåœ¨å®¿ä¸»æœº NodeA ä¸Š æå‰åˆ›å»ºå¥½ç›®å½• ï¼Œç„¶åŽåœ¨å®šä¹‰ Pod æ—¶æ·»åŠ  nodeAffinity=NodeA ï¼ŒæŒ‡å®š Pod åœ¨æˆ‘ä»¬æå‰åˆ›å»ºå¥½ç›®å½•çš„ ä¸»æœºä¸Šè¿è¡Œã€‚ä½†æ˜¯**æˆ‘ä»¬ç»ä¸åº”è¯¥æŠŠä¸€ä¸ªå®¿ä¸»æœºä¸Šçš„ç›®å½•å½“ä½œ PV ä½¿ç”¨**ï¼Œå› ä¸ºæœ¬åœ°ç›®å½•çš„ç£ç›˜éšæ—¶éƒ½å¯èƒ½ è¢«åº”ç”¨å†™æ»¡ï¼Œç”šè‡³é€ æˆæ•´ä¸ªå®¿ä¸»æœºå®•æœºã€‚è€Œä¸”ï¼Œä¸åŒçš„æœ¬åœ°ç›®å½•ä¹‹é—´ä¹Ÿç¼ºä¹å“ªæ€•æœ€åŸºç¡€çš„ I/O éš”ç¦»æœº åˆ¶ã€‚æ‰€ä»¥ï¼Œ**ä¸€ä¸ª Local Persistent Volume å¯¹åº”çš„å­˜å‚¨ä»‹è´¨ï¼Œä¸€å®šæ˜¯ä¸€å—é¢å¤–æŒ‚è½½åœ¨å®¿ä¸»æœºçš„ç£ç›˜æˆ–è€… å—è®¾å¤‡**ï¼ˆâ€œé¢å¤–â€ çš„æ„æ€æ˜¯ï¼Œå®ƒä¸åº”è¯¥æ˜¯å®¿ä¸»æœºæ ¹ç›®å½•æ‰€ä½¿ç”¨çš„ä¸»ç¡¬ç›˜ï¼‰ã€‚è¿™ä¸ªåŽŸåˆ™ï¼Œæˆ‘ä»¬å¯ä»¥ç§°ä¸º â€œ**ä¸€ä¸ª PV ä¸€å—ç›˜**â€ã€‚





#####  Local PV å’Œå¸¸è§„ PV çš„åŒºåˆ«

å¯¹äºŽå¸¸è§„çš„ PVï¼ŒKubernetes éƒ½æ˜¯å…ˆè°ƒåº¦ Pod åˆ°æŸä¸ªèŠ‚ç‚¹ä¸Šï¼Œç„¶åŽå†æŒä¹…åŒ– è¿™å°æœºå™¨ä¸Šçš„ Volume ç›® å½•ã€‚è€Œ Local PVï¼Œåˆ™éœ€è¦è¿ç»´äººå‘˜æå‰å‡†å¤‡å¥½èŠ‚ç‚¹çš„ç£ç›˜ã€‚å®ƒä»¬åœ¨ä¸åŒèŠ‚ç‚¹ä¸Šçš„æŒ‚è½½æƒ…å†µå¯ä»¥å®Œå…¨ä¸ åŒï¼Œç”šè‡³æœ‰çš„èŠ‚ç‚¹å¯ä»¥æ²¡è¿™ç§ç£ç›˜ã€‚æ‰€ä»¥è°ƒåº¦å™¨å°±å¿…é¡»èƒ½å¤ŸçŸ¥é“æ‰€æœ‰èŠ‚ç‚¹ä¸Ž Local Persistent Volume  å¯¹åº”çš„ç£ç›˜çš„å…³è”å…³ç³»ï¼Œç„¶åŽæ ¹æ®è¿™ä¸ªä¿¡æ¯æ¥è°ƒåº¦ Podã€‚ä¹Ÿå°±æ˜¯åœ¨è°ƒåº¦çš„æ—¶å€™è€ƒè™‘ Volume åˆ†å¸ƒã€‚



k8s v1.10+ä»¥ä¸Šçš„ç‰ˆæœ¬ä¸­æŽ¨å‡ºlocal pvæ–¹æ¡ˆã€‚Local volume å…è®¸ç”¨æˆ·é€šè¿‡æ ‡å‡† PVC æŽ¥å£ä»¥ç®€å•ä¸”å¯ç§»æ¤ çš„æ–¹å¼è®¿é—® node èŠ‚ç‚¹çš„æœ¬åœ°å­˜å‚¨ã€‚ PV çš„å®šä¹‰ä¸­éœ€è¦åŒ…å«æè¿°èŠ‚ç‚¹äº²å’Œæ€§çš„ä¿¡æ¯ï¼Œk8s ç³»ç»Ÿåˆ™ä½¿ç”¨è¯¥ä¿¡ æ¯å°†å®¹å™¨è°ƒåº¦åˆ°æ­£ç¡®çš„ node èŠ‚ç‚¹ã€‚

åœ¨ Kubernetes ä¸­ï¼ŒHostPath å’Œ Local Volume éƒ½å¯ä»¥ç”¨äºŽå°†ä¸»æœºä¸Šçš„æ–‡ä»¶ç³»ç»ŸæŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ã€‚è™½ç„¶ å®ƒä»¬æœ‰ä¸€äº›ç›¸ä¼¼ä¹‹å¤„ï¼Œä½†æ˜¯å®ƒä»¬ä¹‹é—´ä¹Ÿæœ‰ä¸€äº›é‡è¦çš„åŒºåˆ«ã€‚

HostPathå·ç±»åž‹ä¼šç›´æŽ¥æŒ‚è½½ä¸»æœºçš„æ–‡ä»¶ç³»ç»Ÿåˆ°Podä¸­ï¼Œè¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶æˆ–è€…æ˜¯ä¸€ä¸ªç›®å½•ã€‚ å½“Podè¢«è°ƒåº¦åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Šæ—¶ï¼Œè¯¥èŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿå°±ä¼šè¢«æŒ‚è½½åˆ°Podä¸­ã€‚è¿™ä½¿å¾—å¯ä»¥å¾ˆå®¹æ˜“åœ°åœ¨å®¹å™¨ å†…éƒ¨è®¿é—®ä¸»æœºä¸Šçš„æ–‡ä»¶ï¼Œä¾‹å¦‚ä¸»æœºä¸Šçš„æ—¥å¿—æˆ–é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œä½¿ç”¨ HostPath å·ç±»åž‹å¯èƒ½ä¼šå­˜åœ¨å®‰å…¨ é£Žé™©ï¼Œå› ä¸ºå®¹å™¨å¯ä»¥è®¿é—®ä¸»æœºä¸Šçš„æ‰€æœ‰æ–‡ä»¶å’Œç›®å½•ï¼ŒåŒ…æ‹¬å…¶ä»–å®¹å™¨çš„æ–‡ä»¶ã€‚

ç›¸æ¯”ä¹‹ä¸‹ï¼ŒLocal Volume å·ç±»åž‹åªèƒ½å°†èŠ‚ç‚¹ä¸Šçš„ä¸€ä¸ªç›®å½•æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ã€‚å½“Podè¢«è°ƒåº¦åˆ°ä¸€ä¸ªèŠ‚ç‚¹ä¸Š æ—¶ï¼ŒKubernetes ä¼šä¸ºè¯¥èŠ‚ç‚¹åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„ç›®å½•ï¼Œå¹¶å°†è¯¥ç›®å½•æŒ‚è½½åˆ° Pod ä¸­ã€‚å› ä¸ºæ¯ä¸ª Pod åªèƒ½è®¿é—® å…¶æœ¬åœ°çš„ Local Volume ç›®å½•ï¼Œæ‰€ä»¥è¿™ç§å·ç±»åž‹æ›´åŠ å®‰å…¨ã€‚ä½†æ˜¯ï¼Œå¦‚æžœèŠ‚ç‚¹æ•…éšœæˆ–è¢«åˆ é™¤ï¼ŒLocal  Volume ä¸­çš„æ•°æ®å°†ä¼šä¸¢å¤±ã€‚å› æ­¤ï¼Œä½¿ç”¨ Local Volume å·ç±»åž‹éœ€è¦è°¨æ…Žï¼Œéœ€è¦ç¡®ä¿æœ‰å¤‡ä»½æœºåˆ¶æˆ–æŒä¹…åŒ– å­˜å‚¨ã€‚



**local Volume é»˜è®¤ä¸æ”¯æŒåŠ¨æ€é…ç½®ï¼Œåªèƒ½ç”¨ä½œé™æ€åˆ›å»ºçš„æŒä¹…å·å›½ã€‚ä½†å¯ä»¥é‡‡æœ‰ç¬¬ä¸‰æ–¹æ–¹æ¡ˆå®žçŽ°åŠ¨æ€é…ç½®**

local ç±»åž‹çš„PVæ˜¯ä¸€ç§æ›´é«˜çº§çš„æœ¬åœ°å­˜å‚¨æŠ½è±¡ï¼Œå®ƒå¯ä»¥**å…è®¸é€šè¿‡StorageClassæ¥è¿›è¡Œç®¡ç†**ã€‚

ä¸Ž hostPath å·ç›¸æ¯”ï¼Œ local å·èƒ½å¤Ÿä»¥æŒä¹…å’Œå¯ç§»æ¤çš„æ–¹å¼ä½¿ç”¨ï¼Œè€Œæ— éœ€æ‰‹åŠ¨å°† Pod è°ƒåº¦åˆ°èŠ‚ç‚¹ã€‚

åŒæ ·ä½¿ç”¨èŠ‚ç‚¹ä¸Šçš„æœ¬åœ°å­˜å‚¨ï¼Œä½†ç›¸æ¯”äºŽ hostPath ï¼Œ l**ocal Volumeå¯ä»¥å£°æ˜Žä¸ºåŠ¨æ€ä¾›åº”ï¼Œå¹¶ä¸”å¯ä»¥åˆ© ç”¨èŠ‚ç‚¹æ ‡ç­¾ï¼ˆnodeAffinityï¼‰å®žçŽ°å­˜å‚¨äº²å’Œæ€§ï¼Œç¡®ä¿Podè°ƒåº¦åˆ°åŒ…å«æ‰€éœ€æ•°æ®çš„èŠ‚ç‚¹ä¸Š**ã€‚è€ŒhostPathå· åœ¨Podé‡å»ºåŽå¯èƒ½ä¼šè°ƒåº¦è‡³æ–°çš„èŠ‚ç‚¹ï¼Œè€Œå¯¼è‡´æ—§çš„æ•°æ®æ— æ³•ä½¿ç”¨



ç„¶è€Œï¼Œ local å·ä»ç„¶å–å†³äºŽåº•å±‚èŠ‚ç‚¹çš„å¯ç”¨æ€§ï¼Œå¹¶ä¸é€‚åˆæ‰€æœ‰åº”ç”¨ç¨‹åºã€‚ å¦‚æžœèŠ‚ç‚¹å˜å¾—ä¸å¥åº·ï¼Œé‚£ä¹ˆ local å·ä¹Ÿå°†å˜å¾—ä¸å¯è¢« Pod è®¿é—®ã€‚ä½¿ç”¨å®ƒçš„ Pod å°†ä¸èƒ½è¿è¡Œã€‚ ä½¿ç”¨ local å·çš„åº”ç”¨ç¨‹åºå¿…é¡»èƒ½å¤Ÿ å®¹å¿è¿™ç§å¯ç”¨æ€§çš„é™ä½Žï¼Œä»¥åŠå› åº•å±‚ç£ç›˜çš„è€ç”¨æ€§ç‰¹å¾è€Œå¸¦æ¥çš„æ½œåœ¨çš„æ•°æ®ä¸¢å¤±é£Žé™©



##### åˆ›å»ºLocal PV

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ local å·å’Œ nodeAffinity çš„æŒä¹…å·ç¤ºä¾‹ï¼š

```yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner #è¡¨ç¤ºè¯¥å­˜å‚¨ç±»ä¸ä½¿ç”¨ä»»ä½• provisionerï¼Œå³ä¸æ”¯æŒåŠ¨æ€åˆ†é…æŒä¹…å·ã€‚è¿™æ„å‘³ç€ç®¡ç†å‘˜éœ€è¦æ‰‹åŠ¨åˆ›å»ºå¹¶ç®¡ç†æŒä¹…å·ã€‚
volumeBindingMode: WaitForFirstConsumer #å»¶è¿Ÿç»‘å®šï¼Œåªæœ‰Podå‡†å¤‡å¥½æ‰ç»‘å®šPVè‡³PVCï¼Œå¦åˆ™PVCå¤„äºŽPendingçŠ¶æ€

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: example-pv
spec:
  capacity:
    storage: 100Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  sotrageClassName: local-storage
  local:
    path: /mnt/disks/ssd1
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - example-node
```

ä½¿ç”¨ local å·æ—¶ï¼Œä½ éœ€è¦è®¾ç½® PersistentVolume å¯¹è±¡çš„ nodeAffinity å­—æ®µã€‚ Kubernetes è°ƒåº¦å™¨ ä½¿ç”¨ PersistentVolume çš„ nodeAffinity ä¿¡æ¯æ¥å°†ä½¿ç”¨ local å·çš„ Pod è°ƒåº¦åˆ°æ­£ç¡®çš„èŠ‚ç‚¹ã€‚

ä½¿ç”¨ local å·æ—¶ï¼Œ**å»ºè®®åˆ›å»ºä¸€ä¸ª StorageClass å¹¶å°†å…¶ volumeBindingMode è®¾ç½®ä¸º WaitForFirstConsumer** ã€‚è¦äº†è§£æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è€ƒ local StorageClass ç¤ºä¾‹ã€‚ å»¶è¿Ÿå·ç»‘å®šçš„æ“ä½œ å¯ä»¥ç¡®ä¿ Kubernetes åœ¨ä¸º PersistentVolumeClaim ä½œå‡ºç»‘å®šå†³ç­–æ—¶ï¼Œä¼šè¯„ä¼° Pod å¯èƒ½å…·æœ‰çš„å…¶ä»–èŠ‚ç‚¹ çº¦æŸï¼Œä¾‹å¦‚ï¼šå¦‚èŠ‚ç‚¹èµ„æºéœ€æ±‚ã€èŠ‚ç‚¹é€‰æ‹©å™¨ã€Pod äº²å’Œæ€§å’Œ Pod åäº²å’Œæ€§ã€‚



**ä½¿ç”¨Localå·æµç¨‹**

- åˆ›å»ºPVï¼Œä½¿ç”¨ nodeAffinity æŒ‡å®šç»‘å®šçš„èŠ‚ç‚¹æä¾›å­˜å‚¨
- åˆ›å»º PVCï¼Œç»‘å®šPVçš„å­˜å‚¨æ¡ä»¶
- åˆ›å»ºPodï¼Œå¼•ç”¨å‰é¢çš„PVCå’ŒPVå®žçŽ°Local å­˜å‚¨



##### æ¡ˆä¾‹ï¼šåŸºäºŽStorageClasså®žçŽ°Localå·

```yaml
#äº‹å…ˆå‡†å¤‡ç›®æ ‡èŠ‚ç‚¹å‡†å¤‡ç›®å½•ï¼Œå¯¹äºŽæœ¬åœ°å­˜å‚¨Kubernetes æœ¬èº«å¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºè·¯å¾„ï¼Œè¿™æ˜¯å› ä¸ºKubernetes ä¸èƒ½æŽ§åˆ¶èŠ‚ç‚¹ä¸Šçš„æœ¬åœ°å­˜å‚¨ï¼Œå› æ­¤æ— æ³•è‡ªåŠ¨åˆ›å»ºè·¯å¾„ã€‚
[root@node2 ~] # mkdir -p /data/www

#å¦‚æžœæ²¡æœ‰å‡†å¤‡ç›®å½•ï¼Œä¼šå‡ºçŽ°ä¸‹é¢æç¤ºé”™è¯¯
[root@master1 yaml]#kubectl describe pod pod-sc-local-demo
Events:
 Type     Reason           Age               From               Message
  ----     ------            ----              ----               -------
 Warning FailedScheduling 2m2s             default-scheduler  0/4 nodes are 
available: pod has unbound immediate PersistentVolumeClaims. preemption: 0/4 
nodes are available: 4 No preemption victims found for incoming pod..
 Normal   Scheduled         2m1s             default-scheduler Successfully 
assigned default/pod-sc-local-demo to node2.wang.org
 Warning FailedMount       56s (x8 over 2m) kubelet           
MountVolume.NewMounter initialization failed for volume "example-pv" : path 
"/data/www" does not exist

#å‡†å¤‡æ¸…å•æ–‡ä»¶, #kuberneteså†…ç½®äº†Localçš„ç½®å¤‡å™¨ï¼Œæ‰€ä»¥ä¸‹é¢StorageClassèµ„æºå¯ä»¥ä¸åˆ›å»º
[root@master1 yaml] # cat storage-sc-local-pv-pvc-pod.yaml
---
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: local-storage
provisioner: kubernetes.io/no-provisioner
volumeBindingMode: waitForFirstConsumer #å»¶è¿Ÿç»‘å®šï¼Œåªæœ‰Podå¯åŠ¨åŽå†ç»‘å®šPVåˆ°Podæ‰€åœ¨èŠ‚ç‚¹ï¼Œå¦åˆ™PVCå¤„äºŽPendingçŠ¶æ€

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: pv-sc-local
spec:
  capacity:
    storage: 100Gi
  volumeMode: Filesystem
  accessModes:
  - ReadWriteOnce
  persistentVolumeReclaimPolicy: Delete
  storageClassName: local-storage
  local:
    path: /data/www/
  nodeAffinity:
    required:
      nodeSelectorTerms:
      - matchExpressions:
        - key: kubernetes.io/hostname
          operator: In
          values:
          - node2.mystical.org
          
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-sc-local
spec:
  storageClassName: local-storage
  accessModes: ["ReadWriteOnce"]
  resources:
    requests:
      storage: 100Mi

---
apiVersion: v1
kind: Pod
metadata:
  name: pod-sc-local-demo
spec:
  containers:
  - name: pod-sc-local-demo
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: pvc-sc-local
      mountPath: "/usr/share/nginx/html"
  restartPolicy: "Nerver"
  volumes:
  - name: pvc-sc-local
    persistentVolumeClaim:
      claimName: pvc-sc-local
      
#åº”ç”¨æ¸…å•æ–‡ä»¶
[root@master1 yaml] # kubectl apply -f storage-sc-local-pv-pvc-pod.yaml
persistentvolume/pv-sc-local created
persistentvolumeclaim/pvc-sc-local created
pod/pod-sc-local-demo created

# è¿™é‡ŒPodçš„èŠ‚ç‚¹è°ƒåº¦å–å†³äºŽPVå®šä¹‰çš„èŠ‚ç‚¹ä½ç½®ï¼Œæ˜¯ç”±äºŽPVä¸Šå®šä¹‰äº†node2èŠ‚ç‚¹ï¼Œå› æ­¤Podå¿…ç„¶è°ƒåº¦åˆ°node2èŠ‚ç‚¹
# è€ŒhostPathæ˜¯å…ˆç¡®å®šPodï¼Œç„¶åŽåœ¨æ ¹æ®Podè°ƒåº¦åˆ°çš„èŠ‚ç‚¹æ¥ç¡®å®šè·¯å¾„ã€‚
# è€Œä¸”PVå¯ä»¥é™å®šå¤§å°ï¼Œè€ŒPVæ— æ³•é™å®š
```



#### NFS StorageClass

##### NFSçš„å­˜å‚¨åˆ¶å¤‡å™¨æ–¹æ¡ˆ

NFS çš„è‡ªåŠ¨é…ç½®ç¨‹åº Provisioner å¯ä»¥é€šè¿‡ä¸åŒçš„é¡¹ç›®å®žçŽ°,æ¯”å¦‚ï¼š

- **csi-driver-nfs**

  ```http
  https://github.com/kubernetes-csi/csi-driver-nfs
  ```

  

- **nfs-client-provisioner**

  - nfs-client-provisioner æ˜¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®å·ç¨‹åºï¼Œå®ƒä½¿ç”¨çŽ°æœ‰çš„å’Œå·²é…ç½®çš„ NFS æœåŠ¡å™¨æ¥æ”¯æŒé€šè¿‡ PVCåŠ¨æ€é…ç½® PV
  - nfs-client-provisioner **ç›®å‰å·²ç»ä¸æä¾›æ›´æ–°**ï¼Œnfs-client-provisioner çš„ Github ä»“åº“å½“å‰å·²ç»è¿ç§» åˆ° NFS-Subdir-External-Provisionerçš„ä»“åº“

  ```http
  https://github.com/kubernetes-retired/external-storage/tree/master/nfs-client
  https://github.com/kubernetes-sigs/sig-storage-lib-external-provisioner
  ```



- **NFS-Subdir-External-Provisionerï¼ˆå®˜æ–¹æŽ¨èï¼‰**

  - æ­¤ç»„ä»¶æ˜¯ç”±Kubernetes SIGs ç¤¾åŒºå¼€å‘,ä¹Ÿæ˜¯Kuberneteså®˜æ–¹æŽ¨èå®žçŽ°
  - æ˜¯å¯¹ nfs-client-provisioner ç»„ä»¶çš„æ‰©å±•

  ```http
  https://kubernetes.io/docs/concepts/storage/storage-classes/#nfs
  ```

  - NFS-Subdir-External-Provisioner æ˜¯ä¸€ä¸ªè‡ªåŠ¨é…ç½®å·ç¨‹åºï¼Œå¯ä»¥åœ¨ NFS æœåŠ¡å™¨ä¸Šé€šè¿‡PVCåŠ¨æ€åˆ› å»ºå’Œé…ç½® Kubernetes æŒä¹…å·
  - PVå‘½åè§„åˆ™å¦‚ä¸‹

  ```bash
  è‡ªåŠ¨åˆ›å»ºçš„ PV ä»¥${namespace}-${pvcName}-${pvName} å‘½åæ ¼å¼åˆ›å»ºåœ¨ NFS æœåŠ¡å™¨ä¸Šçš„å…±äº«æ•°æ®ç›®å½•ä¸­
  å½“è¿™ä¸ª PV è¢«å›žæ”¶åŽä¼šä»¥ archieved-${namespace}-${pvcName}-${pvName} å‘½åæ ¼å¼å­˜åœ¨NFS æœåŠ¡å™¨ä¸­
  ```



- **NFS Ganesha server and external provisioner**

  ```http
  https://github.com/kubernetes-sigs/nfs-ganesha-server-and-external-provisioner
  ```

  - nfs-ganesha-server-and-external-provisioner æ˜¯ Kubernetes 1.14+ çš„æ ‘å¤–åŠ¨æ€é…ç½®ç¨‹åºã€‚ æ‚¨å¯ä»¥ä½¿ç”¨å®ƒå¿«é€Ÿè½»æ¾åœ°éƒ¨ç½²å‡ ä¹Žå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨çš„å…±äº«å­˜å‚¨ã€‚



##### æ¡ˆä¾‹: åŸºäºŽ nfs-subdir-external-provisione åˆ›å»º NFS å…±äº«å­˜å‚¨çš„ storageclass

éƒ¨ç½²ç›¸å…³æ–‡ä»¶

```http
https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner
https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner/tree/master/deploy
https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner?tab=readme-ov-file#manuall
```



åˆ›å»ºNFSå…±äº«å­˜å‚¨çš„storageclassæ­¥éª¤å¦‚ä¸‹

- åˆ›å»º NFS å…±äº«
- åˆ›å»º **Service Account** å¹¶æŽˆäºˆç®¡æŽ§NFS provisioneråœ¨k8sé›†ç¾¤ä¸­è¿è¡Œçš„æƒé™
- éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ **Deployment**
- åˆ›å»º StorageClass è´Ÿè´£å»ºç«‹PVCå¹¶è°ƒç”¨NFS provisionerè¿›è¡Œé¢„å®šçš„å·¥ä½œ,å¹¶è®©PVä¸ŽPVCå»ºç«‹è”ç³»
- åˆ›å»º PVC æ—¶è‡ªåŠ¨è°ƒç”¨SCåˆ›å»ºPV



**åˆ›å»ºNFSæœåŠ¡**

```bash
[root@master1 ~] # apt update && apt -y install nfs-server
[root@master1 ~] # systemctl status nfs-server.service 
â— nfs-server.service - NFS server and services
     Loaded: loaded (/lib/systemd/system/nfs-server.service; enabled; vendor 
preset: enabled)
     Active: active (exited) since Thu 2021-09-29 09:28:41 CST; 5min ago
   Main PID: 64029 (code=exited, status=0/SUCCESS)
     Tasks: 0 (limit: 2236)
     Memory: 0B
     CGroup: /system.slice/nfs-server.service
9æœˆ 29 09:28:40 master1.wang.org systemd[1]: Starting NFS server and services...
9æœˆ 29 09:28:41 master1.wang.org systemd[1]: Finished NFS server and services.


[root@master1 ~]#mkdir -pv /data/sc-nfs 
[root@master1 ~]#chown 777 /data/sc-nfs
[root@master1 ~]#vim /etc/exports
#æŽˆæƒworkerèŠ‚ç‚¹çš„ç½‘æ®µå¯ä»¥æŒ‚è½½
#/data/sc-nfs *(rw,no_root_squash,all_squash,anonuid=0,anongid=0) 
/data/sc-nfs *(rw,no_root_squash)

[root@master1 ~]#exportfs -r
[root@master1 ~]#exportfs -v
/data/sc-nfs <world>
(sync,wdelay,hide,no_subtree_check,anonuid=0,anongid=0,sec=sys,rw,secure,no_root_squash,all_squash)

#å¹¶åœ¨æ‰€æœ‰workerèŠ‚ç‚¹å®‰è£…NFSå®¢æˆ·ç«¯ 
[root@nodeX ~]#apt update && apt -y install nfs-common æˆ–è€… nfs-client
```



**åˆ›å»ºServiceAccountå¹¶æŽˆæƒ**

```yaml
[root@master1 yaml] # cat rbac.yaml 
# åˆ›å»ºç‹¬ç«‹çš„åç§°ç©ºé—´
apiVersion: v1
kind: Namespace
metadata:
  name: nfs-provisioner-demo
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  # replace with namespace where provisioner is deployed æ ¹æ®ä¸šåŠ¡éœ€è¦ä¿®æ”¹æ­¤å¤„åç§°ç©ºé—´
  namespace: nfs-provisioner-demo
  
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "update", "patch"]
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "delete"]
    
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: nfs-provisioner-demo
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
  
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs-provisioner-demo
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs-provisioner-demo
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: nfs-provisioner-demo
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io


# åº”ç”¨
[root@master1 yaml] # kubectl apply -f rbac.yaml
serviceaccount/nfs-client-provisioner created
clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created
clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created
role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created
rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created

# æŸ¥çœ‹ç³»ç»Ÿç”¨æˆ·
[root@master1 yaml]#kubectl get sa
NAME                     SECRETS   AGE
default                  0         34d
nfs-client-provisioner   0         9s
```



**éƒ¨ç½² NFS-Subdir-External-Provisioner å¯¹åº”çš„ Deployment**

```yaml
[root@master1 nsf-provisioner] #vim nfs-client-provisioner.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  labels:
    app: nfs-client-provisioner
  namespace: nfs-provisioner-demo
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
      - name: nfs-client-provisioner     
        image: k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2 #æ­¤é•œåƒå›½å†…å¯èƒ½æ— æ³•è®¿é—®
        imagePullPolicy: IfNotPresent
        volumeMounts:
        - name: nfs-client-root
          mountPath: /persistentvolumes
        env:
        - name: PROVISIONER_NAME
          value: k8s-sigs.io/nfs-subdir-external-provisioner # åç§°ç¡®ä¿ä¸Žnfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
        - name: NFS_SERVER
          value: nfs.mystical.org
        - name: NFS_PATH
          value: /nfs-data/sc-nfs
      volumes:
      - name: nfs-client-root
        nfs:
          server: nfs.mystical.org
          path: /nfs-data/sc-nfs
          
# åº”ç”¨
[root@master1 nsf-provisioner]#kubectl apply -f nfs-client-provisioner.yaml 
deployment.apps/nfs-client-provisioner created

# æŸ¥çœ‹
[root@master1 nsf-provisioner]#kubectl get pod -n nfs-provisioner-demo 
NAME                                      READY   STATUS    RESTARTS   AGE
nfs-client-provisioner-74d7c6bf46-kkpmd   1/1     Running   0          4m9s
```



**åˆ›å»ºNFSèµ„æºçš„storageClass**

```yaml
[root@master1 nsf-provisioner] # vim nfs-storageClass.yaml
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: sc-nfs
  annotations:
    storageclass.kubernetes.io/is-default-class: "false" # æ˜¯å¦è®¾ç½®ä¸ºé»˜è®¤çš„storageClass
provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME
parameters:
  archiveOnDelete: "true" # è®¾ç½®ä¸ºfalseæ—¶åˆ é™¤PVCä¸ä¼šä¿ç•™æ•°æ®ï¼Œ"true"åˆ™ä¿ç•™æ•°æ®ï¼ŒåŸºäºŽå®‰å…¨åŽŸå› å»ºè®®è®¾ä¸º"true"


# åº”ç”¨
[root@master1 nsf-provisioner] # kubectl apply -f nfs-storageClass.yaml 
storageclass.storage.k8s.io/sc-nfs created

# æŸ¥çœ‹
[root@master1 nsf-provisioner]#kubectl get sc -n nfs-provisioner-demo 
NAME     PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
sc-nfs   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           false                  15s
```



**åˆ›å»ºPVC**

```yaml
[root@master1 nsf-provisioner] # vim pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: pvc-nfs-sc
spec:
  storageClassName: sc-nfs # éœ€è¦å’Œå‰é¢åˆ›å»ºçš„storageClassåç§°ç›¸åŒ
  accessModes: ["ReadWriteMany", "ReadOnlyMany"]
  resources:
    requests:
      storage: 100Mi


# åº”ç”¨
[root@master1 nsf-provisioner] # kubectl apply -f pvc.yaml 
persistentvolumeclaim/pvc-nfs-sc created

# æŸ¥çœ‹pvc
[root@master1 nsf-provisioner] # kubectl get pvc
NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   VOLUMEATTRIBUTESCLASS   AGE
pvc-nfs-sc   Bound    pvc-a77fd2d8-3f14-475c-8e81-b5c0b24c4358   100Mi      ROX,RWX        sc-nfs         <unset>                 9m46s

# è‡ªåŠ¨ç”Ÿæˆpv
[root@master1 nsf-provisioner]#kubectl get pv
NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                STORAGECLASS   VOLUMEATTRIBUTESCLASS   REASON   AGE
pvc-a77fd2d8-3f14-475c-8e81-b5c0b24c4358   100Mi      ROX,RWX        Delete           Bound    default/pvc-nfs-sc   sc-nfs         <unset>                          10m


# å¦‚æžœpvæ²¡æœ‰åˆ›å»ºå‡ºæ¥ï¼Œå¯èƒ½çš„é—®é¢˜æŸ¥çœ‹ä¸‹rbacçš„æƒé™ï¼Œæ˜¯å¦ServiceAccountç»™äºˆçš„æƒé™ä¸å¤Ÿ
# å¯ä»¥é€šè¿‡logså‘½ä»¤æŸ¥çœ‹ï¼Œæ ¹æ®è¾“å‡ºçš„æ—¥å¿—è¿›è¡ŒæŽ’é”™
[root@master1 nsf-provisioner] # kubectl logs pod/nfs-client-provisioner-649b64df96-sb7sg -n nfs-provisioner-demo
```



**åˆ›å»ºPod**

```yaml
[root@master1 nsf-provisioner] # cat pod-test.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-nfs-sc-test
spec:
  containers:
  - name: pod-nfs-sc-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: nfs-pvc
      mountPath: "/usr/share/nginx/html/"
  restartPolicy: "Never"
  volumes:
  - name: nfs-pvc
    persistentVolumeClaim:
      claimName: pvc-nfs-sc

# åº”ç”¨
[root@master1 nsf-provisioner] # kubectl apply -f pod-test.yaml                          
pod/pod-nfs-sc-test created

# æŸ¥çœ‹
[root@master1 nsf-provisioner] # kubectl get pod -o wide
NAME              READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
pod-nfs-sc-test   1/1     Running   0          11s   10.244.1.125   node1   <none>           <none>

# curlIP
[root@master1 nsf-provisioner] # curl 10.244.1.125
<html>
<head><title>403 Forbidden</title></head>
<body>
<center><h1>403 Forbidden</h1></center>
<hr><center>nginx/1.20.0</center>
</body>
</html>

# å› ä¸ºæ ¹ç›®å½•ä¸‹æ²¡æœ‰å†…å®¹ï¼Œå› æ­¤è¿”å›ž403
# åœ¨nfsç›®å½•ä¸‹ï¼Œæ·»åŠ index.htmlæ–‡ä»¶
[root@ubuntu2204 ~] # echo web1 > /nfs-data/sc-nfs/default-pvc-nfs-sc-pvc-a77fd2d8-3f14-475c-8e81-b5c0b24c4358/index.html

# ç­‰ä¸€æ®µæ—¶é—´åŽï¼ˆæœ‰çŸ­æ—¶é—´çš„å»¶è¿Ÿï¼‰ï¼Œå†æ¬¡æŸ¥çœ‹ï¼Œ
[root@master1 nsf-provisioner] # curl 10.244.1.125
web1
```







## Kubernetesé…ç½®ç®¡ç†



**æ–‡ç« å†…å­˜**

- **é…ç½®è¯´æ˜Ž**
- **ConfigMap**
- **Secret**
- **downwardAPI**
- **Projected**





### é…ç½®è¯´æ˜Ž

kubernetesæä¾›äº†å¯¹ Pod å®¹å™¨åº”ç”¨å¯ä»¥å®žçŽ°é›†ä¸­å¼çš„é…ç½®ç®¡ç†åŠŸèƒ½çš„ç›¸å…³èµ„æºï¼š

- ConfigMap
- Secret
- downwardAPI
- Projected 



é€šè¿‡è¿™äº›ç»„ä»¶æ¥å®žçŽ°å‘podä¸­çš„å®¹å™¨åº”ç”¨ä¸­æ³¨å…¥é…ç½®ä¿¡æ¯çš„æœºåˆ¶ï¼Œä»Žè€Œé¿å…äº†å¼€å‘è€…å‚ä¸Ž

æ³¨æ„ï¼š**å¯¹äºŽè¿è¡Œä¸­å®¹å™¨çš„é…ç½®æ”¹å˜ï¼Œè¿˜éœ€è¦é€šè¿‡åº”ç”¨ç¨‹åºé‡è½½ç›¸å…³é…ç½®æ‰èƒ½ç”Ÿæ•ˆ**





#### é…ç½®ç»„ä»¶ç®€ä»‹

**configMap**

Configmapæ˜¯Kubernetesé›†ç¾¤ä¸­éžå¸¸é‡è¦çš„ä¸€ç§é…ç½®ç®¡ç†èµ„æºå¯¹è±¡ã€‚

å€ŸåŠ©äºŽConfigMap APIå¯ä»¥å‘podä¸­çš„å®¹å™¨ä¸­æ³¨å…¥é…ç½®ä¿¡æ¯ã€‚

ConfigMapä¸ä»…å¯ä»¥ä¿å­˜çŽ¯å¢ƒå˜é‡æˆ–å‘½ä»¤è¡Œå‚æ•°ç­‰å±žæ€§ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜æ•´ä¸ªé…ç½®æ–‡ä»¶æˆ–è€…JSONæ ¼å¼çš„ æ–‡ä»¶ã€‚

å„ç§é…ç½®å±žæ€§å’Œæ•°æ®ä»¥ k/væˆ–åµŒå¥—k/v æ ·å¼ å­˜åœ¨åˆ°Configmapä¸­

æ³¨æ„ï¼šæ‰€æœ‰çš„é…ç½®ä¿¡æ¯éƒ½æ˜¯**ä»¥æ˜Žæ–‡çš„æ–¹å¼**æ¥è¿›è¡Œä¿å­˜ï¼Œå®žçŽ°èµ„æºé…ç½®çš„å¿«é€ŸèŽ·å–æˆ–è€…æ›´æ–°ã€‚



**Secret**

Kubernetesé›†ç¾¤ä¸­ï¼Œæœ‰ä¸€äº›é…ç½®å±žæ€§ä¿¡æ¯æ˜¯éžå¸¸æ•æ„Ÿçš„ï¼Œæ‰€ä»¥è¿™äº›ä¿¡æ¯åœ¨ä¼ é€’çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¸å¸Œæœ›å…¶ä»–äººèƒ½å¤Ÿçœ‹åˆ°çš„

Kubernetesæä¾›äº†ä¸€ç§åŠ å¯†åœºæ™¯ä¸­çš„é…ç½®ç®¡ç†èµ„æºå¯¹è±¡Secretã€‚

å®ƒåœ¨è¿›è¡Œæ•°æ®ä¼ è¾“ä¹‹å‰ï¼Œä¼šå¯¹æ•°æ®è¿›è¡Œç¼–ç ï¼Œåœ¨æ•°æ®èŽ·å–çš„æ—¶å€™ï¼Œä¼šå¯¹æ•°æ®è¿›è¡Œè§£ç ã€‚ä»Žè€Œä¿è¯æ•´ä¸ªæ•° æ®ä¼ è¾“è¿‡ç¨‹çš„å®‰å…¨ã€‚

**æ³¨æ„ï¼šè¿™äº›æ•°æ®é€šå¸¸é‡‡ç”¨Base64æœºåˆ¶ä¿å­˜ï¼Œæ‰€ä»¥å®‰å…¨æ€§ä¸€èˆ¬**



**DownwardAPI**

downwardAPI ä¸ºè¿è¡Œåœ¨podä¸­çš„åº”ç”¨å®¹å™¨æä¾›äº†ä¸€ç§åå‘å¼•ç”¨ã€‚è®©å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºäº†è§£æ‰€å¤„podæˆ– Nodeçš„ä¸€äº›åŸºç¡€å¤–éƒ¨å±žæ€§ä¿¡æ¯ã€‚

ä»Žä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è¯´ï¼ŒdownwardAPIä¸æ˜¯å­˜å‚¨å·ï¼Œå®ƒè‡ªèº«å°±å­˜åœ¨

ç›¸è¾ƒäºŽconfigmapã€secretç­‰èµ„æºå¯¹è±¡éœ€è¦åˆ›å»ºåŽæ‰èƒ½ä½¿ç”¨ï¼Œè€ŒdownwardAPIå¼•ç”¨çš„æ˜¯Podè‡ªèº«çš„è¿è¡ŒçŽ¯å¢ƒä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯åœ¨Podå¯åŠ¨çš„æ—¶å€™å°±å­˜åœ¨



 **Projected**

ä¸€ä¸ª projected Volumes æŠ•å°„å·å¯ä»¥å°†è‹¥å¹²çŽ°æœ‰çš„å·æºæ˜ å°„åˆ°åŒä¸€ä¸ªç›®å½•ä¹‹ä¸Šã€‚







### ConfigMap



#### ConfigMapè¯´æ˜Ž

Kubernetesæä¾›äº†å¯¹podä¸­å®¹å™¨åº”ç”¨çš„é›†ä¸­é…ç½®ç®¡ç†ç»„ä»¶ï¼šConfigMapã€‚

é€šè¿‡ConfigMapæ¥å®žçŽ°å‘podä¸­çš„å®¹å™¨ä¸­æ³¨å…¥é…ç½®ä¿¡æ¯çš„æœºåˆ¶ã€‚

å¯ä»¥æŠŠconfigmapç†è§£ä¸ºLinuxç³»ç»Ÿä¸­çš„/etcç›®å½•ï¼Œä¸“é—¨ç”¨æ¥å­˜å‚¨é…ç½®æ–‡ä»¶çš„ç›®å½•

Kuberneteså€ŸåŠ©äºŽConfigMapå¯¹è±¡å®žçŽ°äº†å°†é…ç½®ä¿¡æ¯ä»Žå®¹å™¨é•œåƒä¸­è§£è€¦ï¼Œä»Žè€Œå¢žå¼ºäº†å·¥ä½œè´Ÿè½½çš„å¯ç§»æ¨Ÿ æ€§ã€ä½¿å…¶é…ç½®æ›´æ˜“äºŽæ›´æ”¹å’Œç®¡ç†å¹¶é¿å…äº†å°†é…ç½®æ•°æ®ç¡¬ç¼–ç åˆ°Podé…ç½®æ¸…å•ä¸­

**ConfigMapä¸ä»…ä»…å¯ä»¥ä¿å­˜å•ä¸ªå±žæ€§ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥ä¿å­˜æ•´ä¸ªé…ç½®æ–‡ä»¶ã€‚**

ä»ŽKubernetes v1.19ç‰ˆæœ¬å¼€å§‹ï¼ŒConfigMapå’ŒSecretæ”¯æŒä½¿ç”¨**immutableå­—æ®µ**åˆ›å»ºä¸å¯å˜å®žä¾‹ï¼Œå®žçŽ°ä¸ å¯å˜åŸºç¡€è®¾æ–½æ•ˆæžœ



##### åŸºæœ¬å±žæ€§

```bash
# kubectl explain cm
    binaryData              # äºŒè¿›åˆ¶æ•°æ®
    data                    # æ–‡æœ¬æ•°æ®ï¼Œæ”¯æŒå˜é‡å’Œæ–‡ä»¶
    immutable <boolean>     # è®¾ä¸ºtrueï¼Œä¸èƒ½è¢«ä¿®æ”¹åªèƒ½åˆ é™¤ï¼Œé»˜è®¤ä¸ºnilå¯ä»¥éšæ—¶è¢«ä¿®æ”¹
    
#æ³¨æ„ï¼šåŸºäºŽdataçš„æ–¹å¼ä¼ é€’ä¿¡æ¯çš„è¯ï¼Œä¼šåœ¨podçš„å®¹å™¨å†…éƒ¨ç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„æ•°æ®æ–‡ä»¶    
```



##### æ•°æ®é…ç½®çš„æ ¼å¼

```bash
#å•è¡Œé…ç½®æ•°æ®æ ¼å¼
å±žæ€§åç§°key: å±žæ€§å€¼value   #å•è¡Œé…ç½®å†…å®¹ï¼Œä¸€èˆ¬ä¿å­˜å˜é‡ï¼Œå‚æ•°ç­‰
æ–‡ä»¶åï¼šå•è¡Œå†…å®¹            #é…ç½®æ–‡ä»¶å¦‚æžœåªæœ‰ä¸€è¡Œï¼Œä¹Ÿä½¿ç”¨æ­¤æ–¹å¼ï¼Œkeyä¸ºæ–‡ä»¶åï¼Œvalueä¸ºæ–‡ä»¶å†…å®¹


#å¤šè¡Œæ–‡ä»¶æ•°æ®æ ¼å¼     
æ–‡ä»¶åç§°1: |     #æ³¨æ„ï¼š| æ˜¯"å¤šè¡Œé”®å€¼"çš„æ ‡è¯†ç¬¦
 æ–‡ä»¶å†…å®¹è¡Œ1    #å†…å®¹å¤§å°ä¸èƒ½è¶…è¿‡1M
 æ–‡ä»¶å†…å®¹è¡Œ2
 ......
æ–‡ä»¶åç§°2: |     #æ³¨æ„ï¼š| æ˜¯"å¤šè¡Œé”®å€¼"çš„æ ‡è¯†ç¬¦
 æ–‡ä»¶å†…å®¹è¡Œ1    #å†…å®¹å¤§å°ä¸èƒ½è¶…è¿‡1M
 æ–‡ä»¶å†…å®¹è¡Œ2
 ......
```

configmapèµ„æºç±»åž‹çš„åˆ›å»ºï¼Œä¸ŽKubernetesçš„å…¶ä»–å¾ˆå¤šèµ„æºå¯¹è±¡çš„åˆ›å»ºæ–¹å¼ä¸€æ ·ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸¤ç§æ–¹å¼ï¼š

- **å‘½ä»¤è¡Œå·¥å…·**ï¼šé…ç½®ä¸­æœ‰å¤§é‡ç®€å•çš„é”®å€¼å¯¹æ—¶å»ºè®®ä½¿ç”¨
- **èµ„æºå®šä¹‰æ–‡ä»¶**ï¼šé…ç½®ä¸ºå¤§é‡æ–‡æœ¬å†…å®¹æ—¶å»ºè®®ä½¿ç”¨ï¼Œæ­¤æ–¹å¼éœ€è¦äº‹å…ˆå‡†å¤‡åœ¨èµ„æºæ¸…å•å…ƒæ–‡ä»¶ä¸­åŠ å…¥é…ç½®æ–‡ä»¶å†…å®¹





é€šå¸¸ä¸ºäº†é¿å…é…ç½®æ›´æ–°åŽæ²¡æœ‰ç”Ÿæ•ˆçš„é—®é¢˜ï¼Œå¯ä»¥åœ¨æ›´æ–° ConfigMap ä¹‹åŽï¼Œæ‰‹åŠ¨é‡åˆ›å»ºç›¸å…³çš„ Pod æˆ–è€… Deployment

- è¿ç»´æ–¹å¼ï¼šå¯ä»¥é€šè¿‡ **é‡å¯** æˆ– **é‡å»º** çš„æ–¹å¼ 
  - ä½¿ç”¨ kubectl rollout restart å‘½ä»¤æ¥é‡å¯ Deployment 
  - ä½¿ç”¨ kubectl delete pod å‘½ä»¤æ¥åˆ é™¤ Podï¼Œä»Žè€Œè§¦å‘ Pod çš„é‡å¯



#### ConfigMapåˆ›å»ºå’Œæ›´æ–°

##### å‘½ä»¤è¡Œåˆ›å»ºæ–¹å¼

```bash
# åˆ›å»ºå‘½ä»¤æ ¼å¼
kubectl create configmap NAME [--from-file=[key=]source] [--from-literal=key1=value1] [--dry-run=server|client|none] [-n <namespace>] [options]

# å‚æ•°è¯¦è§£ï¼š
--from-literal=key1=value1          #ä»¥è®¾ç½®é”®å€¼å¯¹çš„æ–¹å¼å®žçŽ°å˜é‡é…ç½®æ•°æ®
--from-env-file=/PATH/TO/FILE       #ä»¥çŽ¯å¢ƒå˜é‡ä¸“ç”¨æ–‡ä»¶çš„æ–¹å¼å®žçŽ°é…ç½®æ•°æ®
--from-file=[key=]/PATH/TO/FILE     #ä»¥é…ç½®æ–‡ä»¶çš„æ–¹å¼åˆ›å»ºé…ç½®æ–‡ä»¶æ•°æ®ï¼Œå¦‚ä¸æŒ‡å®škeyï¼ŒFILEåç§°ä¸ºkeyå
--from-file=/PATH/TO/DIR            #ä»¥é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„æ–¹å¼åˆ›å»ºé…ç½®æ–‡ä»¶æ•°æ®

--dry-run=client -o yaml            #æµ‹è¯•è¿è¡Œå¹¶æ˜¾ç¤ºcmå†…å®¹


#æŸ¥çœ‹configmap
kubectl create configmap <cm_name> -n <namespace> [-o yaml] --dry-run=client
kubectl get configmap <cm_name> -n <namespace>
kubectl describe configmap <cm_name> -n <namespace>


#åˆ é™¤configmap
kubectl delete configmap <cm_name> [-n <namespace>]
```



##### **å‘½ä»¤è¡Œåˆ›å»ºæ–¹å¼æ¡ˆä¾‹**



**èŒƒä¾‹ï¼šå‘½ä»¤è¡Œåˆ›å»ºåŸºäºŽkey/valueå½¢å¼çš„å˜é‡é…ç½®**

```bash
# åœ¨ä½¿ç”¨kubectlåˆ›å»ºçš„æ—¶å€™ï¼Œé€šè¿‡åœ¨å‘½ä»¤è¡Œç›´æŽ¥ä¼ é€’é”®å€¼å¯¹åˆ›å»º
[root@master1 ~]#kubectl create configmap cm-test1 --from-literal=key1='value1' --from-literal=key2='value2'

# æŸ¥çœ‹
[root@master1 nsf-provisioner]#kubectl get cm
NAME               DATA   AGE
cm-test1           2      7s
kube-root-ca.crt   1      3d1h

# æŸ¥çœ‹yamlæ¸…å•
[root@master1 nsf-provisioner]#kubectl get cm cm-test1 -o yaml
apiVersion: v1
data:
  key1: value1
  key2: value2
kind: ConfigMap
metadata:
  creationTimestamp: "2024-12-31T09:27:23Z"
  name: cm-test1
  namespace: default
  resourceVersion: "165446"
  uid: 8f831d4c-3b2d-4058-ae76-342c819f38a3

# æŸ¥çœ‹describe
[root@master1 nsf-provisioner]#kubectl describe cm cm-test1 
Name:         cm-test1
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
key1:
----
value1
key2:
----
value2

BinaryData
====

Events:  <none>

# åˆ é™¤cm
[root@master1 nsf-provisioner]#kubectl delete cm cm-test1 
configmap "cm-test1" deleted
```



**èŒƒä¾‹: å‘½ä»¤è¡Œåˆ›å»ºåŸºäºŽkey/valueå½¢å¼çš„å˜é‡é…ç½®**

```bash
[root@master1 ~]# kubectl create configmap pod-test-config --from-literal=host="127.0.0.1" --from-literal=port="8888"
configmap/pod-test-config created

# æŸ¥çœ‹
[root@master1 ~]# kubectl get cm
NAME               DATA   AGE
kube-root-ca.crt   1      3d22h
pod-test-config    2      5s

# è¾“å‡ºæ¸…å•
[root@master1 ~]# kubectl get cm pod-test-config -o yaml;
apiVersion: v1
data:
  host: 127.0.0.1
  port: "8888"
kind: ConfigMap
metadata:
  creationTimestamp: "2025-01-01T06:27:29Z"
  name: pod-test-config
  namespace: default
  resourceVersion: "197278"
  uid: 297b056b-8fa0-42e3-8394-93470a208147
```



**èŒƒä¾‹: å‘½ä»¤è¡Œåˆ›å»ºåŸºäºŽçŽ¯å¢ƒå˜é‡æ–‡ä»¶çš„å˜é‡é…ç½®**

```bash
# å¦‚æžœå˜é‡è¾ƒå¤šï¼Œä½¿ç”¨ä¸Šé¢æ–¹å¼ä¸€ä¸ªä¸ªçš„è®¾å®šçŽ¯å¢ƒå˜é‡å¤ªç¹çï¼Œå¯ä»¥å…¨éƒ¨æ·»åŠ åˆ°çŽ¯å¢ƒå˜é‡æ–‡ä»¶ä¸­ç„¶åŽåŸºäºŽå®ƒæ¥åˆ›å»ºCM
# å®šåˆ¶çŽ¯å¢ƒå˜é‡æ–‡ä»¶
[root@master1 conf.d]#cat env
key1=value1
key2=value2

# æ³¨æ„ï¼šenvæ–‡ä»¶ä¸­æ‰€æœ‰çš„é…ç½®é¡¹ä»¥â€œå±žæ€§å=å±žæ€§å€¼â€æ ¼å¼å®šåˆ¶

# å°†æ‰€æœ‰çŽ¯å¢ƒå˜é‡æ·»åŠ åˆ°configmapä¸­
[root@master1 conf.d]# kubectl create configmap cm-test2 --from-env-file=./env 
configmap/cm-test2 created

# æŸ¥çœ‹æ¸…å•æ–‡ä»¶
[root@master1 conf.d]# kubectl get cm cm-test2 -o yaml
apiVersion: v1
data:
  key1: value1
  key2: value2
kind: ConfigMap
metadata:
  creationTimestamp: "2025-01-01T06:32:42Z"
  name: cm-test2
  namespace: default
  resourceVersion: "197783"
  uid: e3a193ae-5093-4822-9c34-3b212fafc473

# åˆ é™¤cm
[root@master1 conf.d]# kubectl delete cm pod-test-config 
configmap "pod-test-config" deleted
```



**èŒƒä¾‹ï¼šå‘½ä»¤è¡Œåˆ›å»ºåŸºäºŽé…ç½®æ–‡ä»¶çš„æ–‡ä»¶å½¢å¼CM**

```bash
# ç›´æŽ¥å°†å¤šä¸ªé…ç½®æ–‡ä»¶åˆ›å»ºä¸ºä¸€ä¸ªConfigMap
[root@master1 ~]# ls conf.d/
app1.conf app2.conf app3.conf

[root@master1 ~]# cat conf.d/app1.conf
[app1]
config1

[root@master1 ~]# cat conf.d/app2.conf
[app2]
config2

#æ–‡ä»¶åè‡ªåŠ¨æˆä¸ºkeyå
[root@master1 conf.d]#kubectl create configmap cm-test3 --from-file=./app1.conf --from-file=./app2.conf 
configmap/cm-test3 created

# æŸ¥çœ‹
[root@master1 conf.d]#kubectl get cm cm-test3 -o yaml
apiVersion: v1
data:
  app1.conf: |
    [app1]
    config1
  app2.conf: |
    [app2]
    config2
kind: ConfigMap
metadata:
  creationTimestamp: "2025-01-01T06:36:45Z"
  name: cm-test3
  namespace: default
  resourceVersion: "198174"
  uid: ee772063-dd7d-4ed5-acab-74423104695b
  
# åˆ é™¤CM
[root@master1 conf.d]#kubectl delete cm cm-test3 
configmap "cm-test3" deleted
```



**èŒƒä¾‹: å‘½ä»¤è¡Œåˆ›å»ºåŸºäºŽç›®å½•çš„CM**

```bash
[root@master1 conf.d]# ls
app1.conf  app2.conf  app3.conf

[root@master1 conf.d]#cat *
[app1]
config1
[app2]
config2
[app3]
config3

#ç›´æŽ¥å°†ä¸€ä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰é…ç½®æ–‡ä»¶åˆ›å»ºä¸ºä¸€ä¸ªConfigMap
[root@master1 cm]#kubectl create cm cm-test4 --from-file=./conf.d/
configmap/cm-test4 created

#ç»“æžœæ˜¾ç¤ºï¼šå¤šä¸ªæ–‡ä»¶ä¹‹é—´ï¼Œå±žæ€§åæ˜¯æ–‡ä»¶åï¼Œå±žæ€§å€¼æ˜¯æ–‡ä»¶å†…å®¹
[root@master1 cm]#kubectl get cm cm-test4 -o yaml;
apiVersion: v1
data:
  app1.conf: |
    [app1]
    config1
  app2.conf: |
    [app2]
    config2
  app3.conf: |
    [app3]
    config3
kind: ConfigMap
metadata:
  creationTimestamp: "2025-01-01T06:40:19Z"
  name: cm-test4
  namespace: default
  resourceVersion: "198521"
  uid: 4c83e7d6-b191-46a5-b0f4-a1c8b14f905a

# åˆ é™¤CM
[root@master1 ~]#kubectl delete cm cm-test4
```



##### èµ„æºæ¸…å•æ–‡ä»¶åˆ›å»ºæ–¹å¼

**èµ„æºæ¸…å•æ–‡ä»¶å‘½ä»¤æ ¼å¼è¯´æ˜Ž**

```yaml
# æ¸…å•æ–‡ä»¶æ ¼å¼
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm_name
  namespace: default
data:
  key: value          # é…ç½®ä¿¡æ¯å¦‚æžœåªæœ‰ä¸€è¡Œï¼Œä¹Ÿä½¿ç”¨æ­¤æ–¹å¼ï¼Œä½¿ç”¨å·æŒ‚è½½æ—¶ï¼Œkeyå³ä¸ºæ–‡ä»¶åï¼Œvalueä¸ºæ–‡ä»¶å†…å®¹
  æ–‡ä»¶åï¼š |
    æ–‡ä»¶å†…å®¹è¡Œ1
    æ–‡ä»¶å†…å®¹è¡Œ2
    ......
# æ³¨æ„ï¼šCMçš„æ¸…å•æ–‡ä»¶æ²¡æœ‰specä¿¡æ¯ï¼Œè€Œæ˜¯data

# å‘½ä»¤å¼ï¼š
kubectl create -f /path/file
# å£°æ˜Žå¼
kubectl apply -f /path/file
```

æ³¨æ„ï¼šæ­¤æ–¹å¼éœ€è¦äº‹å…ˆå°†é…ç½®æ–‡ä»¶çš„å†…å®¹å…¨éƒ¨å†™å…¥æ¸…å•æ–‡ä»¶ï¼Œè€Œä¸”é…ç½®æ–‡ä»¶çš„æ ¼å¼éœ€è¦è°ƒæ•´æ‰èƒ½åŒ¹é…ï¼Œ æ‰€ä»¥å¾ˆä¸æ–¹ä¾¿ï¼ŒæŽ¨èå¦‚ä¸‹æ–¹å¼è§£å†³

- å…ˆåœ¨å‘½ä»¤è¡Œæ‰§è¡Œæ—¶æŒ‡å®šé…ç½®æ–‡ä»¶çš„æ–¹å¼åˆ›å»º CM
- é€šè¿‡ kubectl get cm  -o yaml > cm.yaml æ–¹å¼å¯¼å‡ºèµ„æºæ¸…å•æ–‡ä»¶
- æˆ–è€… kubectl create configmap NAME --dry-run=client -o yaml > cm.yaml æ–¹å¼å¯¼å‡ºèµ„æºæ¸…å•æ–‡ä»¶
- æœ€åŽè°ƒæ•´å’Œä¿®æ”¹ä¸Šé¢ç”Ÿæˆçš„ yamlèµ„æºæ¸…å•æ–‡ä»¶



##### èµ„æºæ¸…å•æ–‡ä»¶åˆ›å»ºæ–¹å¼æ¡ˆä¾‹

```yaml
# èµ„æºå®šä¹‰æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-test.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: config-test
data:
  author: wangxiaochun
  file.conf: |
    [class]
    linux
    go
    java
    
    
# åˆ›å»ºèµ„æºå¯¹è±¡
[root@master1 cm] # kubectl apply -f storage-configmap-test.yaml 
configmap/config-test created

# æŸ¥çœ‹
[root@master1 cm] # kubectl describe cm config-test 
Name:         config-test
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
author:
----
wangxiaochun
file.conf:
----
[class]
linux
go
java


BinaryData
====

Events:  <none>

# å¯ä»¥åœ¨çº¿ä¿®æ”¹
[root@master1 cm] # kubectl edit cm config-test

# åˆ é™¤
[root@master1 cm]#kubectl delete cm config-test 
configmap "config-test" deleted
```



**èŒƒä¾‹: åªè¯»çš„configmap**

```yaml
[root@master1 cm] # vim storage-configmap-immutable-test.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-immutable-test
data:
  author: wangxiaochun
  file.conf: |
    [class]
    linux
    go
    java
immutable: true  # åªè¯»

# åº”ç”¨
[root@master1 cm]#kubectl apply -f storage-configmap-immutable-test.yaml 
configmap/cm-immutable-test created

# æŸ¥çœ‹
[root@master1 cm]#kubectl get cm cm-immutable-test 
NAME                DATA   AGE
cm-immutable-test   2      31s

# åœ¨çº¿ä¿®æ”¹configmapæç¤ºå‡ºé”™
[root@master1 cm]#kubectl edit cm cm-immutable-test 
error: configmaps "cm-immutable-test" is invalid

# å¯ä»¥åˆ é™¤
[root@master1 cm]#kubectl delete cm cm-immutable-test 
configmap "cm-immutable-test" deleted
```



##### åœ¨çº¿æ›´æ–°configmap

æ³¨æ„ï¼šconfigmapè™½ç„¶æ”¯æŒåœ¨çº¿æ›´æ–°ï¼Œä½†æ˜¯configmapæ›´æ–°åŽå¯èƒ½ä¸ä¼šå¯¹å·²æœ‰çš„Podçš„åº”ç”¨ç”Ÿæ•ˆï¼Œå¯èƒ½ è¿˜éœ€è¦é‡å»ºPodæ‰èƒ½ç”Ÿæ•ˆ

```bash
#åˆ›å»º configmap
[root@master1 ~]#kubectl create cm cm-nginx-conf --from-file=nginx.conf

#ä¿®æ”¹configmap
#æ–¹æ³•1,æ—§ç‰ˆä¸­å¦‚æžœé…ç½®å†…å®¹å¦‚æžœä¸å¤§,å¤šè¡Œå†…å®¹å¯ä»¥æ˜¾ç¤ºåœ¨ä¸€è¡Œ,ä½†æ­¤æ–¹å¼ä¸æ–¹ä¾¿ä¿®æ”¹,ä½†å¦‚æžœè¿‡å¤§,æ­¤æ–¹å¼åª
èƒ½æ˜¾ç¤ºå¤§å°,è€Œéžå†…å®¹,æ‰€ä»¥ä¸èƒ½ä¿®æ”¹,æ–°ç‰ˆæ— æ­¤é—®é¢˜
[root@master1 ~]#kubectl edit cm cm-nginx-conf


#æ–¹æ³•2
[root@master1 ~]#kubectl get cm cm-nginx-conf -o yaml > cm-config-conf.yaml
[root@master1 ~]#vim cm-config-conf.yaml
[root@master1 ~]#kubectl apply -f cm-config-conf.yaml


#æ–¹æ³•3
#ä¿®æ”¹é…ç½®
[root@master1 ~]#vim nginx.conf
[root@master1 ~]#kubectl create cm cm-nginx-conf --from-file=nginx.conf --dry-run=client -oyaml |kubectl apply -f -
```



#### ConfigMapä½¿ç”¨

**ä½¿ç”¨ConfigMapä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š**

- é€šè¿‡çŽ¯å¢ƒå˜é‡çš„æ–¹å¼ç›´æŽ¥ä¼ é€’pod
- ä½¿ç”¨volumeçš„æ–¹å¼æŒ‚è½½å…¥åˆ°podå†…çš„æ–‡ä»¶ä¸­



**æ³¨æ„ï¼š**

- ConfigMapå¿…é¡»åœ¨Podä¹‹å‰åˆ›å»º
- ä¸ŽConfigMapåœ¨åŒä¸€ä¸ªnamespaceå†…çš„podæ‰èƒ½ä½¿ç”¨ConfigMap**ï¼Œå³ConfigMapä¸èƒ½è·¨å‘½åç©ºé—´è°ƒç”¨ã€‚**
- ConfigMapé€šå¸¸å­˜æ”¾çš„æ•°æ®ä¸è¦è¶…è¿‡1M
- CM å¯ä»¥æ”¯æŒå®žæ—¶æ›´æ–°ï¼Œåœ¨åŽŸæ¥çš„podé‡Œé¢ç›´æŽ¥çœ‹åˆ°æ•ˆæžœ



#####  é€šè¿‡çŽ¯å¢ƒå˜é‡çš„æ–¹å¼ç›´æŽ¥ä¼ é€’ Pod

å¼•ç”¨ConfigMapå¯¹è±¡ä¸Šç‰¹å®šçš„keyï¼Œä»¥**valueFrom**èµ‹å€¼ç»™Podä¸ŠæŒ‡å®šçš„çŽ¯å¢ƒå˜é‡

ä¹Ÿå¯ä»¥åœ¨Podä¸Šä½¿ç”¨**envFrom**ä¸€æ¬¡æ€§å¯¼å…¥ConfigMapå¯¹è±¡ä¸Šçš„æ‰€æœ‰çš„key-value,key(å¯ä»¥ç»Ÿä¸€é™„åŠ ç‰¹å®šå‰ ç¼€ï¼‰å³ä¸ºçŽ¯å¢ƒå˜é‡,valueè‡ªåŠ¨æˆä¸ºç›¸åº”çš„å˜é‡å€¼

çŽ¯å¢ƒå˜é‡æ˜¯å®¹å™¨å¯åŠ¨æ—¶æ³¨å…¥çš„ï¼Œå®¹å™¨å¯åŠ¨åŽå˜é‡çš„å€¼ä¸ä¼šéšCMæ›´æ”¹è€Œå‘ç”Ÿå˜åŒ–,å³ä¸€æ¬¡æ€§åŠ è½½ configmap,é™¤éžåˆ é™¤å®¹å™¨é‡å»º



**æ–¹å¼1ï¼šenv å¯¹æŒ‡å®šçš„å˜é‡ä¸€ä¸ªä¸€ä¸ªèµ‹å€¼**

```bash
kubectl explain pod.spec.containers.env
    name          # æ‰‹å·¥å®šåˆ¶çŽ¯å¢ƒå˜é‡æ—¶ï¼Œè®¾ç½®çŽ¯å¢ƒå˜é‡çš„åç§°ï¼Œå¿…é€‰å­—æ®µ
    value         # æ‰‹å·¥å®šåˆ¶çŽ¯å¢ƒå˜é‡æ—¶ï¼Œç›´æŽ¥è®¾ç½®çŽ¯å¢ƒå˜é‡çš„å±žæ€§å€¼ï¼Œä¸é€šè¿‡CMèŽ·å–é…ç½®ï¼Œå¯é€‰å­—æ®µ
    valueFrom     # #æ‰‹å·¥å®šåˆ¶çŽ¯å¢ƒå˜é‡æ—¶ï¼Œè®¾ç½®çŽ¯å¢ƒå˜é‡çš„å±žæ€§æ¥æºï¼Œå¯ä»¥æ”¯æŒä»ŽCM,Secret,downwordAPIèŽ·å–

kubectl explain pod.spec.containers.env.valueFrom.configMapKeyRef
    name          # å¼•ç”¨æŒ‡å®šçš„configmap
    key           # å¼•ç”¨æŒ‡å®šçš„configmapä¸­çš„å…·ä½“å“ªä¸ªkey
    optional      # å¦‚æžœè®¾ç½®ä¸ºfalseï¼Œæ ‡è¯†è¯¥é¡¹æ˜¯å¿…é€‰é¡¹ï¼Œå¦‚æžœè®¾ç½®ä¸ºtrueæ ‡è¯†è¿™ä¸ªkeyæ˜¯å¯é€‰çš„ã€‚é»˜è®¤false

#æ­¤æ–¹å¼å®žçŽ°è¿‡ç¨‹
1ï¼‰å®¹å™¨ä¸­è‡ªå®šä¹‰çŽ¯å¢ƒå˜é‡å
2ï¼‰æ ¹æ®CMçš„åç§°å’ŒKeyåï¼Œæ‰¾åˆ°å¯¹åº”çš„value
3) å†å°†valueèµ‹å€¼ç»™å®¹å™¨çš„çŽ¯å¢ƒå˜é‡
```



**æ–¹å¼2ï¼šenvFrom ä½¿ç”¨CMçš„æ‰€æœ‰å˜é‡å®žçŽ°å¯¹å˜é‡çš„æ‰¹é‡èµ‹å€¼ï¼Œæ­¤æ–¹å¼ç”Ÿäº§æ›´ä¸ºæŽ¨è**

```bash
kubectl explain pod.spec.containers.envFrom
    configMapRef     # ConfigMapå¯¹è±¡ä¸­çš„æ‰€æœ‰Key
    secretKeyRef     # Secretå¯¹è±¡ä¸­çš„æ‰€æœ‰Key
    prefix           # #ä¸ºConfigMapä¸­çš„æ¯ä¸ªå±žæ€§éƒ½æ·»åŠ å‰ç¼€æ ‡è¯†

#æ­¤æ–¹å®žçŽ°è¿‡ç¨‹
1ï¼‰å®¹å™¨ä¸­è‡ªå®šä¹‰çŽ¯å¢ƒå˜é‡åï¼Œå¹¶ä¸”å’ŒCMçš„keyåŒå
2ï¼‰æ‰¾åˆ°æŒ‡å®šçš„CMä¸­æ‰€æœ‰Keyåï¼Œå°†å€¼æ‰¹é‡ç›´æŽ¥èµ‹å€¼ç»™å®¹å™¨ä¸­ç›¸åŒåç§°çš„å˜é‡
```



##### ä½¿ç”¨volumeçš„æ–¹å¼æŒ‚è½½å…¥åˆ°podå†…çš„æ–‡ä»¶ä¸­

åœ¨Podä¸Šå°† configMapå¯¹è±¡å¼•ç”¨ä¸ºå­˜å‚¨å·ï¼Œè€ŒåŽæ•´ä½“ç”±å®¹å™¨mountè‡³æŸä¸ªç›®å½•ä¸‹ï¼Œkeyè½¬ä¸ºæ–‡ä»¶åï¼Œ valueå³ä¸ºç›¸åº”çš„æ–‡ä»¶å†…å®¹

åœ¨Podä¸Šå®šä¹‰configMapå·æ—¶ï¼Œä»…å¼•ç”¨å…¶ä¸­çš„éƒ¨åˆ†keyï¼Œè€ŒåŽç”±å®¹å™¨mountè‡³ç›®å½•ä¸‹

åœ¨å®¹å™¨ä¸Šä»…mount configMapå·ä¸ŠæŒ‡å®šçš„key

å®¹å™¨ä¸­æŒ‚è½½çš„Volumeæ•°æ®å¯ä»¥**æ ¹æ®æ—¶é—´æˆ³æœºåˆ¶å’ŒConfigMap åŒæ­¥æ›´æ–°**ï¼Œå³configmapå˜æ›´åŽä¼šè‡ªåŠ¨åŠ è½½ï¼Œä½†æ›´æ–°æ—¶é—´æ˜¯ä¸ç¡®å®šçš„ï¼Œ

æ‰€ä»¥ä¸€èˆ¬å»ºè®®å½“æ›´æ–°configmapçš„é…ç½®åŽï¼Œå¯ä»¥é€šè¿‡é‡æ–°Podä½¿ä¹‹ç”Ÿæ•ˆï¼Œç¬¦åˆä¸å¯å˜åŸºç¡€è®¾æ–½çš„ç†å¿µ 

æŽ¨èæ»šåŠ¨å‡çº§podçš„æ–¹å¼æ¥è®©ConfigMapå†…å®¹å˜åŒ–ç”Ÿæ•ˆ



##### ConfigMapå®žæˆ˜æ¡ˆä¾‹

**èŒƒä¾‹ï¼šenv å˜é‡**

```yaml
# èµ„æºæ¸…å•æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-simple-env.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-nginx-config
data:
  port: "10086"  # æ³¨æ„ï¼šåªæ”¯æŒå­—ç¬¦ä¸²ï¼Œéœ€è¦ç”¨å¼•å·å¼•èµ·æ¥
  user: "www"
---
apiVersion: v1
kind: Pod
metadata:
  name: configmap-env-test
spec:
  containers:
  - name: configmap-env-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    env:
    - name: NGINX_HOST
      value: "10.0.0.100"  #ç›´æŽ¥å˜é‡èµ‹å€¼
    - name: NGINX_PORT
      valueFrom:
        configMapKeyRef:
          name: cm-nginx-config
          key: port
          optional: true
    - name: NGINX_USER
      valueFrom:
        configMapKeyRef:
          name: cm-nginx-config
          key: user
          optional: false
#é…ç½®è§£æžï¼šè¿™é‡Œé¢æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ç§æ–¹å¼åœ¨podä¸­ä¼ é€’å˜é‡

# èµ„æºåˆ›å»º
[root@master1 cm] # kubectl apply -f storage-configmap-simple-env.yaml 
configmap/cm-nginx-config created
pod/configmap-env-test created

# æŸ¥çœ‹
[root@master1 cm] # kubectl get pod
NAME                 READY   STATUS    RESTARTS   AGE
configmap-env-test   1/1     Running   0          9s
[root@master1 cm] # kubectl get cm
NAME               DATA   AGE
cm-nginx-config    2      32s

# éªŒè¯å˜é‡
[root@master1 cm] # kubectl exec configmap-env-test -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=configmap-env-test
NGINX_HOST=10.0.0.100 
NGINX_PORT=10086   # ---------------------- ConfigMapä¼ å…¥å˜é‡
NGINX_USER=www     # ---------------------- ConfigMapä¼ å…¥å˜é‡
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
NGINX_VERSION=1.20.0
NJS_VERSION=0.5.3
PKG_RELEASE=1~buster
HOME=/root

# èµ„æºåˆ é™¤
[root@master1 cm] # kubectl delete -f storage-configmap-simple-env.yaml 
configmap "cm-nginx-config" deleted
pod "configmap-env-test" deleted
```



**èŒƒä¾‹ï¼šenv å˜é‡**

```yaml
# åˆ›å»ºé…ç½®æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-valueFrom-env.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-pod-test
  namespace: default
data:
  host: 0.0.0.0
  port: "8888"

---
apiVersion: v1
kind: Pod
metadata:
  name: configmap-env-demo
spec:
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    name: pod-test
    env:
    - name: HOST
      valueFrom:
        configMapKeyRef:
          name: cm-pod-test
          key: host
          optional: true  #trueæ—¶,å¦‚æžœconfigmapä¸­çš„keyå³ä½¿ä¸å­˜åœ¨,ä¹Ÿä¸ä¼šå¯¼è‡´å®¹å™¨æ— æ³•åˆå§‹

    - name: PORT
      valueFrom:
        configMapKeyRef:
          name: cm-pod-test
          key: port
          optional: false # falseæ—¶ï¼Œå¦‚æžœconfigmapä¸­çš„keyä¸å­˜åœ¨ï¼Œä¼šå¯¼è‡´å®¹å™¨æ— æ³•åˆå§‹åŒ–


# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-valueFrom-env.yaml 
configmap/cm-pod-test created
pod/configmap-env-demo created

# æŸ¥çœ‹
[root@master1 cm] # kubectl exec configmap-env-demo -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=configmap-env-demo
HOST=0.0.0.0
PORT=8888
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
DEPLOYENV=Production
RELEASE=Stable
PS1=[\u@\h \w]\$ 
HOME=/root

# åˆ é™¤èµ„æº
[root@master1 cm]#kubectl delete -f storage-configmap-valueFrom-env.yaml 
configmap "cm-pod-test" deleted
pod "configmap-env-demo" deleted
```



**èŒƒä¾‹ï¼šenv å˜é‡**

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-simple-envargs.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-command-arg
data:
  time: "3600"
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-cm-command-arg
spec:
  containers:
  - name: pod-cm-command-arg-container
    image: busybox:1.32.0
    command: ["/bin/sh", "-c", "sleep ${SPECIAL_TIME}"]
    env:
    - name: SPECIAL_TIME
      valueFrom:
        configMapKeyRef:
          name: cm-command-arg
          key: time
    - name: NAME
      value: "wangxiaochun"
  restartPolicy: Never

# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-simple-envargs.yaml 
configmap/cm-command-arg created
pod/pod-cm-command-arg created

# æŸ¥çœ‹
[root@master1 cm] # kubectl get pod
NAME                 READY   STATUS    RESTARTS   AGE
pod-cm-command-arg   1/1     Running   0          3s

[root@master1 cm] # kubectl exec pod-cm-command-arg -- ps aux
PID   USER     TIME  COMMAND
    1 root      0:00 sleep 3600
    8 root      0:00 ps aux

# åˆ é™¤
[root@master1 cm]#kubectl delete -f storage-configmap-simple-envargs.yaml 
configmap "cm-command-arg" deleted
pod "pod-cm-command-arg" deleted
```



**èŒƒä¾‹ï¼šenvFrom æ‰¹é‡å¯¼å…¥æ‰€æœ‰å˜é‡**

```yaml
# é…ç½®æ–‡ä»¶èµ„æºå®šä¹‰æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-simple-envfrom.yaml
[root@master1 cm]#cat storage-configmap-simple-envfrom.yaml 
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-nginx
data:
  NGINX_PORT: "10086"
  NGINX_USER: "www"
---
apiVersion: v1
kind: Pod
metadata:
  name: configmap-envfrom-test
spec:
  containers:
  - name: configmap-envfrom-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    envFrom:
    - configMapRef:
        name: cm-nginx  # æ‰€æœ‰å˜é‡ä»Žcmä¸­è¯»å–
        
# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-simple-envfrom.yaml 
configmap/cm-nginx unchanged
pod/configmap-envfrom-test created

# æŸ¥çœ‹
[root@master1 cm] # kubectl get pod
NAME                     READY   STATUS    RESTARTS   AGE
configmap-envfrom-test   1/1     Running   0          2s

[root@master1 cm] # kubectl exec configmap-envfrom-test -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=configmap-envfrom-test
NGINX_PORT=10086
NGINX_USER=www
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
NGINX_VERSION=1.20.0
NJS_VERSION=0.5.3
PKG_RELEASE=1~buster
HOME=/root

# åˆ é™¤
[root@master1 cm]#kubectl delete -f storage-configmap-simple-envfrom.yaml 
configmap "cm-nginx" deleted
pod "configmap-envfrom-test" deleted
```



 **èŒƒä¾‹ï¼švolume ç”Ÿæˆé…ç½®æ–‡ä»¶å¹¶æ›´æ–°ç”Ÿæ•ˆ**

```yaml
# configmapèµ„æºå®šä¹‰
[root@master1 cm] # vim storage-configmap-simple-volume.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-volume
data:
  author: wangxiaochun
  file.conf: |
    [app]
    config1
    config2

---
apiVersion: v1
kind: Pod
metadata:
  name: pod-volume-test
spec:
  volumes:
  - name: volume-config  # æŒ‡å®šå·å
    configMap:
      name: cm-volume    # æŒ‡å®šå·æ¥è‡ªcm
  containers:
  - name: nginx
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: volume-config # è°ƒç”¨å‰é¢å®šä¹‰çš„å·å
      mountPath: /cmap/   # æŒ‡å®šPodä¸­çš„æŒ‚è½½ç‚¹ç›®å½•
      
# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-simple-volume.yaml 
configmap/cm-volume created
pod/pod-volume-test created

# æŸ¥çœ‹
[root@master1 cm] # kubectl get pod
NAME              READY   STATUS    RESTARTS   AGE
pod-volume-test   1/1     Running   0          4s

[root@master1 cm] # kubectl exec pod-volume-test -- ls /cmap/
author
file.conf

# è¿›å…¥å®¹å™¨æŸ¥çœ‹
[root@master1 cm] # kubectl exec -it pod-volume-test -- sh
# cd /cmap     
# ls
author	file.conf
# ls -al
total 12
drwxrwxrwx 3 root root 4096 Jan  1 09:26 .
drwxr-xr-x 1 root root 4096 Jan  1 09:26 ..
drwxr-xr-x 2 root root 4096 Jan  1 09:26 ..2025_01_01_09_26_31.673800736
lrwxrwxrwx 1 root root   31 Jan  1 09:26 ..data -> ..2025_01_01_09_26_31.673800736
lrwxrwxrwx 1 root root   13 Jan  1 09:26 author -> ..data/author
lrwxrwxrwx 1 root root   16 Jan  1 09:26 file.conf -> ..data/file.conf
# cd ..2025*        
# ls
author	file.conf

# ç»“æžœæ˜¾ç¤ºï¼š
# è¿™äº›æ–‡ä»¶è™½ç„¶çœ‹èµ·æ¥æ˜¯æŒ‚è½½åœ¨ç›®å½•ä¸‹ï¼Œå®žé™…ä¸Šï¼Œå®ƒæ˜¯ç»è¿‡ä¸¤å±‚çš„è½¯é“¾æŽ¥æ‰èƒ½æ‰¾åˆ°çœŸæ­£çš„æŒ‚è½½çš„æ–‡ä»¶ï¼Œå®¹å™¨å†…æŒ‚è½½ç›®å½•çš„ç”Ÿæˆçš„æ–‡ä»¶
# ..2025_01_01_09_26_31.673800736
# ..data -> ..2025_01_01_09_26_31.673800736
# author -> ..data/author
# file.conf -> ..data/file.conf
# é€šè¿‡è¿™ç§åŒå±‚è½¯è¿žæŽ¥çš„æ–¹å¼ï¼Œåªè¦å®¹å™¨æ”¯æŒé‡è½½æŠ€æœ¯ï¼Œé‚£ä¹ˆåªéœ€è¦æ›´æ”¹é…ç½®æ–‡ä»¶å°±å¯ä»¥å®žçŽ°å®¹å™¨åº”ç”¨çš„å˜åŠ¨

# ä¿®æ”¹cm
[root@master1 cm] # kubectl edit cm cm-volume 
apiVersion: v1
data:
 author: wang  #ä¿®æ”¹æ­¤è¡Œ
 file.conf: |
   [app]
   config1
   config2
   config3  #åŠ æ­¤è¡Œ
kind: ConfigMap
.....
configmap/cm-volume edited

# ç­‰ä¸€ä¼šå„¿è¿›å…¥podå¯ä»¥çœ‹åˆ°é…ç½®æ–‡ä»¶å˜åŒ–
[root@master1 cm] # kubectl exec -it pod-volume-test -- sh
# cd /cmap
# ls -al
total 12
drwxrwxrwx 3 root root 4096 Jan  1 09:33 .
drwxr-xr-x 1 root root 4096 Jan  1 09:26 ..
drwxr-xr-x 2 root root 4096 Jan  1 09:33 ..2025_01_01_09_33_42.2079151602
lrwxrwxrwx 1 root root   32 Jan  1 09:33 ..data -> ..2025_01_01_09_33_42.2079151602
lrwxrwxrwx 1 root root   13 Jan  1 09:26 author -> ..data/author
lrwxrwxrwx 1 root root   16 Jan  1 09:26 file.conf -> ..data/file.conf
# cat file.conf                     
[app]
config1
config2
config3
# exit

#åˆ é™¤
[root@master1 cm] # kubectl delete -f storage-configmap-simple-volume.yaml 
configmap "cm-volume" deleted
pod "pod-volume-test" deleted
```



**èŒƒä¾‹ï¼švolume æŒ‚è½½å…¨éƒ¨å†…å®¹**

```yaml
# å‘½ä»¤è¡Œåˆ›å»ºCMï¼Œåˆ›å»ºNginxçš„é…ç½®ä¿¡æ¯
[root@master1 nginx.conf.d] # vim default.conf
server {
    listen 8080;
    server_name localhost;
    location / {
        root /usr/share/nginx/html;
        index index.html index.htm;
    }
    error_page 500 502 503 504 /50x.html;
    location /50x.html {
        root /usr/share/nginx/html;
    }
}

# å‘½ä»¤è¡Œåˆ›å»ºCM
[root@master1 cm] # kubectl create configmap cm-nginx-conf-files --from-file=nginx.conf.d/
configmap/cm-nginx-conf-files created

# æŸ¥çœ‹
[root@master1 cm]#kubectl get cm
NAME                  DATA   AGE
cm-nginx-conf-files   1      87s

# æ¸…å•æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-nginx-file.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-nginx-index
data:
  index.html: "Nginx Configmap Page!" # å•è¡Œå†…å®¹ç”Ÿæˆconfigmap
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-nginx-conf-configmap
spec:
  volumes:
  - name: nginx-conf
    configMap:
      name: cm-nginx-conf-files
      optional: false
  - name: nginx-index
    configMap:
      name: cm-nginx-index
      optional: false
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    name: nginx
    volumeMounts:
    - name: nginx-conf
      mountPath: /etc/nginx/conf.d/
      readOnly: true
    - name: nginx-index
      mountPath: /usr/share/nginx/html/
      readOnly: true
      
      
# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-nginx-file.yaml 
configmap/cm-nginx-index created
pod/pod-nginx-conf-configmap created

# æŸ¥çœ‹
[root@master1 cm] # kubectl get cm
NAME                  DATA   AGE
cm-nginx-conf-files   1      7m31s
cm-nginx-index        1      55s

# æµ‹è¯•æ•ˆæžœ
[root@master1 cm] # kubectl get pod -o wide
NAME                       READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
pod-nginx-conf-configmap   1/1     Running   0          77s   10.244.3.138   node3   <none>           <none>

[root@master1 cm] # curl 10.244.3.138
curl: (7) Failed to connect to 10.244.3.138 port 80 after 0 ms: æ‹’ç»è¿žæŽ¥

# è¯»å–äº†configmapä¼ å…¥çš„é…ç½®æ–‡ä»¶
[root@master1 cm] # curl 10.244.3.138:8080
Nginx Configmap Page!

# åˆ é™¤
[root@master1 cm] # kubectl delete -f storage-configmap-nginx-file.yaml 
configmap "cm-nginx-index" deleted
pod "pod-nginx-conf-configmap" deleted

[root@master1 cm] # kubectl delete cm cm-nginx-conf-files 
configmap "cm-nginx-conf-files" deleted
```



**èŒƒä¾‹ï¼švolume æŒ‚è½½ CM ä¸­éƒ¨åˆ†æ–‡ä»¶**

```yaml
# å‡†å¤‡é…ç½®æ–‡ä»¶
[root@master1 nginx.conf.d] #ls
default.conf  myserver.conf  myserver-gzip.cfg  myserver-status.cfg

# é…ç½®æ–‡ä»¶
[root@master1 cm] #cat nginx.conf.d/myserver.conf 
server {
    listen 8888;
    server_name www.wang.org;
    include /etc/nginx/conf.d/myserver-*.cfg
    location / {
        root /usr/share/nginx/html;
    }
}

# å­é…ç½®æ–‡ä»¶,æ³¨æ„:æ–‡ä»¶æ˜¯ä»¥cfgä¸ºåŽç¼€,ä¸èƒ½ä»¥confæ–‡ä»¶åŽç¼€,ä¼šå¯¼è‡´å†²çª
[root@master1 cm] # cat nginx.conf.d/myserver-gzip.cfg 
gzip on;
gzip_comp_level 5;
gzip_proxied     expired no-cache no-store private auth;
gzip_types text/plain text/css application/xml text/javascript;

[root@master1 cm] # cat nginx.conf.d/myserver-status.cfg 
location /nginx-status {
   stub_status on;
   access_log off;
}

# åˆ›å»ºcm
[root@master1 cm] # kubectl create cm cm-nginx-conf-files --from-file=nginx.conf.d/
configmap/cm-nginx-conf-files created

# æ¸…å•æ–‡ä»¶
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-nginx-index
data:
  index.html: "Nginx Sub Configmap Page\n"
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-cm-nginx-conf
spec:
  volumes:
  - name: nginx-conf
    configMap:
      name: cm-nginx-conf-files
      items:                            # æŒ‡å®šcmä¸­çš„key
      - key: myserver.conf              # cmä¸­çš„keyåç§°
        path: myserver.conf             # Podä¸­çš„æ–‡ä»¶å
        mode: 0644                      # Podä¸­çš„æ–‡ä»¶æƒé™
      - key: myserver-status.cfg
        path: myserver-status.cfg
        mode: 0644
      - key: myserver-gzip.cfg
        path: myserver-gzip.cfg
        mode: 0644
      optional: false
  - name: nginx-index
    configMap:
      name: cm-nginx-index
      optional: false
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    name: pod-cm-nginx-conf-container
    volumeMounts:
    - name: nginx-conf
      mountPath: /etc/nginx/conf.d/
      readOnly: true
    - name: nginx-index
      mountPath: /usr/share/nginx/html/
      readOnly: true

# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-nginx-subfile.yaml 
configmap/cm-nginx-index created
pod/pod-cm-nginx-conf created

# æŸ¥çœ‹
[root@master1 cm]#kubectl exec pod-cm-nginx-conf -- ls /etc/nginx/conf.d
myserver-gzip.cfg
myserver-status.cfg
myserver.conf

# æŸ¥çœ‹èµ„æº
[root@master1 cm]#kubectl get cm cm-nginx-conf-files -o yaml
apiVersion: v1
data:
  default.conf: |
    server {
        listen 8080;
        server_name localhost;
        location / {
            root /usr/share/nginx/html;
            index index.html index.htm;
        }
        error_page 500 502 503 504 /50x.html;
        location /50x.html {
            root /usr/share/nginx/html;
        }
    }
  myserver-gzip.cfg: |
    gzip on;
    gzip_comp_level 5;
    gzip_proxied     expired no-cache no-store private auth;
    gzip_types text/plain text/css application/xml text/javascript;
  myserver-status.cfg: |+
    location /nginx-status {
       stub_status on;
       access_log off;
    }

  myserver.conf: |
    server {
        listen 8888;
        server_name www.wang.org;
        include /etc/nginx/conf.d/myserver-*.cfg;
        location / {
            root /usr/share/nginx/html;
        }
    }
kind: ConfigMap
metadata:
  creationTimestamp: "2025-01-01T10:54:52Z"
  name: cm-nginx-conf-files
  namespace: default
  resourceVersion: "224964"
  uid: 80862286-fb45-4dc2-ba8a-4d886f88e015
  
# æŸ¥çœ‹æ•ˆæžœ
[root@master1 cm] # curl 10.244.3.140:8888
Nginx Sub Configmap Page

# åˆ é™¤èµ„æº
#åˆ é™¤èµ„æº
[root@master1 yaml] #kubectl delete -f storage-configmap-nginx-subfile.yaml
[root@master1 yaml] #kubectl delete cm cm-nginx-conf-files
```



**èŒƒä¾‹ï¼švolume åŸºäºŽsubpathå®žçŽ°æŒ‚è½½CMéƒ¨åˆ†æ–‡ä»¶å¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶åç§°**

```yaml
kubectl explain pod.spec.volumes.configMap.items

FIELDS:
   key <string> -required-
     key is the key to project.
     
   mode <integer>
     mode is Optional: mode bits used to set permissions on this file. Must be
     an octal value between 0000 and 0777 or a decimal value between 0 and 511.
     YAML accepts both octal and decimal values, JSON requires decimal values
     for mode bits. If not specified, the volume defaultMode will be used. This
     might be in conflict with other options that affect the file mode, like
     fsGroup, and the result can be other mode bits set.
     
   path <string> -required-
     path is the relative path of the file to map the key to. May not be an
     absolute path. May not contain the path element '..'. May not start with
     the string '..'.
     
kubectl explain pod.spec.containers.volumeMounts
FIELDS:
   mountPath <string> -required-
     Path within the container at which the volume should be mounted. Must not
     contain ':'.
     
   mountPropagation <string>
     mountPropagation determines how mounts are propagated from the host to
     container and the other way around. When not set, MountPropagationNone is
     used. This field is beta in 1.10.
     
   name <string> -required-
     This must match the Name of a Volume.
     
   readOnly <boolean>
     Mounted read-only if true, read-write otherwise (false or unspecified).
     Defaults to false.
     
   subPath <string>
     Path within the volume from which the container's volume should be mounted.
     Defaults to "" (volume's root).

   subPathExpr <string>
     Expanded path within the volume from which the container's volume should be
     mounted. Behaves similarly to SubPath but environment variable references
     $(VAR_NAME) are expanded using the container's environment. Defaults to ""
     (volume's root). SubPathExpr and SubPath are mutually exclusive
```

**èŒƒä¾‹**

```yaml
# å‡†å¤‡é…ç½®æ–‡ä»¶åŒä¸Šä¸€æ ·
[root@master1 cm] #ls nginx.conf.d/
default.conf  myserver.conf  myserver-gzip.cfg  myserver-status.cfg

# å°†ä¸Šé¢çš„é…ç½®æ–‡ä»¶éƒ½åŠ å…¥cm
[root@master1 cm] # kubectl create cm cm-nginx-conf-files --from-file=nginx.conf.d/
configmap/cm-nginx-conf-files created

# æ¸…å•æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-nginx-usesubfile.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cm-nginx-index
data:
  index.html: "Nginx Use Sub Configmap Page\n"
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-cm-nginx-conf
spec:
  volumes:
  - name: nginx-conf
    configMap:
      name: cm-nginx-conf-files
      optional: false
  - name: nginx-index
    configMap:
      name: cm-nginx-index
      optional: false
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    name: pod-cm-nginx-conf-container
    volumeMounts:
    - name: nginx-conf
      mountPath: /etc/nginx/conf.d/myserver2.conf   # ä¿®æ”¹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å
      subPath: myserver.conf                        # æŒ‡å®šnginx-confä¸­çš„ç‰¹å®šæ–‡ä»¶ï¼Œè€Œéžæ‰€æœ‰æ–‡ä»¶
      readOnly: true
    - name: nginx-conf
      mountPath: /etc/nginx/conf.d/myserver-gzip2.cfg   # ä¿®æ”¹ç”Ÿæˆçš„é…ç½®æ–‡ä»¶å
      subPath: myserver-gzip.cfg                        # æŒ‡å®šnginx-confä¸­çš„ç‰¹å®šæ–‡ä»¶ï¼Œè€Œéžæ‰€æœ‰æ–‡ä»¶
      readOnly: true
    - name: nginx-index
      mountPath: /usr/share/nginx/html/
      readOnly: true


[root@master1 cm] # kubectl apply -f storage-configmap-nginx-usesubfile.yaml 
configmap/cm-nginx-index created
pod/pod-cm-nginx-conf created

[root@master1 cm] # kubectl get pod
NAME                READY   STATUS    RESTARTS   AGE
pod-cm-nginx-conf   1/1     Running   0          2s

[root@master1 cm] # kubectl get pod -o wide
NAME                READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
pod-cm-nginx-conf   1/1     Running   0          15s   10.244.3.142   node3   <none>           <none>

[root@master1 cm] # kubectl exec pod-cm-nginx-conf -- ls /etc/nginx/conf.d
default.conf
myserver-gzip2.cfg
myserver2.conf

# åˆ é™¤

```



**èŒƒä¾‹ï¼švolume åŸºäºŽsubPath æŒ‚è½½CM éƒ¨åˆ†æ–‡ä»¶å¹¶ä¿ç•™åŽŸç›®å½•ä¸­çš„å…¶å®ƒæ–‡ä»¶**

```yaml
# æŸ¥çœ‹å®¹å™¨å†…çš„æ–‡ä»¶åˆ—è¡¨
[root@master1 cm] # docker run --rm --name nginx wangxiaochun/nginx:1.20.0 ls /etc/nginx/
conf.d
fastcgi_params
mime.types
modules
nginx.conf
scgi_params
uwsgi_params

# å¯¼å‡ºé…ç½®æ–‡ä»¶
[root@master1 cm] # docker run --rm --name nginx wangxiaochun/nginx:1.20.0 cat /etc/nginx/nginx.conf > nginx.conf

# åˆ›å»ºconfigmap
[root@master1 cm] # kubectl create cm cm-nginx-conf --from-file=nginx.conf
configmap/cm-nginx-conf created

# æŸ¥çœ‹é…ç½®å†…å®¹
[root@master1 cm] # kubectl describe cm cm-nginx-conf 
Name:         cm-nginx-conf
Namespace:    default
Labels:       <none>
Annotations:  <none>

Data
====
nginx.conf:
----

user  nginx;
worker_processes  auto;

error_log  /var/log/nginx/error.log notice;
pid        /var/run/nginx.pid;


events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    #gzip  on;

    include /etc/nginx/conf.d/*.conf;
}


BinaryData
====

Events:  <none>


# å‡†å¤‡é…ç½®æ–‡ä»¶
[root@master1 cm] # vim storage-configmap-subPath-nginx-1.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-cn-nginx-conf
spec:
  volumes:
  - name: volume-nginx-conf
    configMap:
      name: cm-nginx-conf
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    name: pod-cm-nginx-conf-container
    command: ["sh", "-c", "sleep 3600"]
    volumeMounts:
    - name: volume-nginx-conf
      mountPath: /etc/nginx/

# åº”ç”¨
[root@master1 cm] # kubectl apply -f storage-configmap-subPath-nginx-1.yaml 
pod/pod-cn-nginx-conf created

# æŸ¥çœ‹
[root@master1 cm] # kubectl get pod
NAME                READY   STATUS    RESTARTS   AGE
pod-cn-nginx-conf   1/1     Running   0          3s

# ç›´æŽ¥å°†æ•´ä¸ªç›®å½•è¦†ç›–äº†
[root@master1 cm] # kubectl exec pod-cn-nginx-conf -- ls /etc/nginx
nginx.conf

# åˆ é™¤
[root@master1 cm] # kubectl delete -f storage-configmap-subPath-nginx-1.yaml 
pod "pod-cn-nginx-conf" deleted

# ä¿®æ”¹æ¸…å•æ–‡ä»¶
[root@master1 cm] # cat storage-configmap-subPath-nginx-2.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-cm-nginx-conf
spec:
  volumes:
  - name: volume-nginx-conf
    configMap:
      name: cm-nginx-conf
      items:
      - key: nginx.conf
        path: etc/nginx/nginx.conf       # å¿…é¡»æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¸”å’Œä¸‹é¢subPathè·¯å¾„ç›¸åŒ
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    name: pod-cm-nginx-conf-container
    command: ["sh", "-c", "sleep 3600"]
    volumeMounts:
    - name: volume-nginx-conf
      mountPath: /etc/nginx/nginx.conf
      subPath: etc/nginx/nginx.conf     # å¿…é¡»æ˜¯ç›¸å¯¹è·¯å¾„ï¼Œä¸”å’Œvolumesçš„pathè·¯å¾„ç›¸åŒ
      
[root@master1 cm] # kubectl apply -f storage-configmap-subPath-nginx-2.yaml 
pod/pod-cm-nginx-conf created

[root@master1 cm] # kubectl get pod
NAME                READY   STATUS    RESTARTS   AGE
pod-cm-nginx-conf   1/1     Running   0          3s

[root@master1 cm] # kubectl exec -it pod-cm-nginx-conf -- ls /etc/nginx/
conf.d		mime.types  nginx.conf	 uwsgi_params
fastcgi_params	modules     scgi_params
```



**å…³äºŽä¸Šé¢æ¡ˆä¾‹ä¸­ï¼Œvolumes.configMap.items.pathç›¸å¯¹è·¯å¾„è¡¥å……è¯´æ˜Žï¼š**

åœ¨ `ConfigMap` ä¸­ï¼Œ`path` æ˜¯ç”¨æ¥æŒ‡å®šè¯¥é”®å€¼å¯¹åœ¨ **`volume` æ ¹ç›®å½•ä¸‹çš„ç›¸å¯¹è·¯å¾„**ã€‚

- **å¿…é¡»æ˜¯ç›¸å¯¹è·¯å¾„çš„åŽŸå› **ï¼š Kubernetes çš„è®¾è®¡ä¸­ï¼Œ`ConfigMap` çš„ `items` æ˜¯å°†é”®å€¼å¯¹æ˜ å°„ä¸ºæ–‡ä»¶ï¼Œå¹¶å­˜å‚¨åˆ° `volume` çš„ä¸´æ—¶æ–‡ä»¶ç›®å½•ä¸­ã€‚è¿™ä¸ªç›®å½•æ˜¯åŠ¨æ€åˆ›å»ºçš„ï¼Œæ— æ³•æå‰ç¡®å®šä¸€ä¸ªå…·ä½“çš„ç»å¯¹è·¯å¾„ã€‚å› æ­¤ï¼Œ`path` æ˜¯ç›¸å¯¹äºŽ **`volume` çš„æ ¹ç›®å½•** çš„ç›¸å¯¹è·¯å¾„



**è¯¦ç»†è§£é‡Šï¼šå®ƒç›¸å¯¹äºŽè°çš„è·¯å¾„ï¼Ÿ**

**å·ï¼ˆ`volume`ï¼‰çš„æ ¹ç›®å½•**ï¼š

- `ConfigMap` æ•°æ®è¢«æŒ‚è½½åˆ°å®¹å™¨ä¹‹å‰ï¼ŒKubernetes ä¼šå°†æ•°æ®æ”¾åœ¨ä¸€ä¸ªä¸´æ—¶ç›®å½•ä¸­ï¼Œæ¯”å¦‚ï¼š

  ```js
  /var/lib/kubelet/pods/<pod-id>/volumes/kubernetes.io~configmap/<volume-name>/
  ```

- åœ¨ `path` ä¸­æŒ‡å®šçš„è·¯å¾„æ˜¯ **ç›¸å¯¹äºŽè¿™ä¸ªä¸´æ—¶ç›®å½•** çš„ç›¸å¯¹è·¯å¾„ã€‚

- å‡è®¾ `ConfigMap` ä¸­æœ‰ä¸€æ¡å®šä¹‰ï¼š

  ```yaml
  items:
    - key: nginx.conf
      path: etc/nginx/nginx.conf
  ```

- Kubernetes ä¼šå°†é”®`nginx.conf`çš„å€¼å†™å…¥æ–‡ä»¶ï¼š

  ```js
  /var/lib/kubelet/pods/<pod-id>/volumes/kubernetes.io~configmap/<volume-name>/etc/nginx/nginx.conf
  ```

**æŒ‚è½½ç‚¹çš„å±‚æ¬¡åŒ–è®¾è®¡:**

- `path` æ˜¯ç›¸å¯¹äºŽ `volume` å†…å®¹çš„æ ¹è·¯å¾„ï¼Œè€Œä¸æ˜¯å®¹å™¨å†…çš„ `mountPath`ã€‚
- å¦‚æžœå…è®¸ `path` æ˜¯ç»å¯¹è·¯å¾„ï¼ˆå¦‚ `/etc/nginx/nginx.conf`ï¼‰ï¼Œåˆ™ Kubernetes æ— æ³•å°†å®ƒæŒ‚è½½åˆ° `volume` çš„ä¸´æ—¶ç›®å½•ä¸­ï¼Œå› ä¸ºè¿™æ ·ä¼šå’Œæ–‡ä»¶ç³»ç»Ÿç»“æž„å†²çªã€‚



**`mountPath` å’Œ `subPath` çš„å…³ç³»**

- **`mountPath`**ï¼šæ˜¯å®¹å™¨ä¸­æŒ‚è½½ç‚¹çš„ç»å¯¹è·¯å¾„ï¼Œè¡¨ç¤ºæŒ‚è½½ç‚¹åœ¨å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä½ç½®ã€‚
- **`subPath`**ï¼šè¡¨ç¤ºæŒ‚è½½ç‚¹å†…éƒ¨ï¼ˆ`volume` å†…éƒ¨ï¼‰çš„ç›¸å¯¹è·¯å¾„ï¼Œå®ƒä»Ž `volumes` æŒ‡å®šçš„èµ„æºï¼ˆå¦‚ `ConfigMap` æˆ– `PersistentVolume`ï¼‰çš„æ ¹ç›®å½•å¼€å§‹ã€‚



**æŒ‚è½½è·¯å¾„çš„é€»è¾‘**

- `mountPath` å®šä¹‰äº†å®¹å™¨ä¸­çš„æ–‡ä»¶/ç›®å½•æŒ‚è½½ä½ç½®ï¼Œæ¯”å¦‚ `/etc/nginx/nginx.conf`ã€‚
- `subPath` å®šä¹‰äº†åœ¨å·ä¸­é€‰æ‹©å…·ä½“çš„æ–‡ä»¶æˆ–è·¯å¾„ï¼Œæ¯”å¦‚ `etc/nginx/nginx.conf`ã€‚
- **`subPath` æ˜¯ç›¸å¯¹äºŽ `volumes` æŒ‚è½½å†…å®¹çš„è·¯å¾„ï¼Œè€Œä¸æ˜¯ `mountPath` çš„è·¯å¾„ã€‚**





### Secret



#### Secretä»‹ç»

![image-20250101212836061](D:\git_repository\cyber_security_learning\markdown_img\image-20250101212836061.png)

Secret å’Œ Configmap ç›¸ä¼¼ï¼Œä¹Ÿå¯ä»¥æä¾›é…ç½®æ•°æ®ï¼Œä½†ä¸»è¦ç”¨äºŽä¸ºPodæä¾›æ•æ„Ÿéœ€è¦åŠ å¯†çš„ä¿¡æ¯

Secret ä¸»è¦ç”¨äºŽå­˜å‚¨å¯†ç ã€è¯ä¹¦ç§é’¥ï¼ŒSSH å¯†é’¥ï¼ŒOAuthä»¤ç‰Œç­‰æ•æ„Ÿä¿¡æ¯ï¼Œè¿™äº›æ•æ„Ÿä¿¡æ¯é‡‡ç”¨base64ç¼– ç ä¿å­˜ï¼Œç›¸å¯¹æ˜Žæ–‡å­˜å‚¨æ›´å®‰å…¨

ç›¸æ¯”äºŽç›´æŽ¥å°†æ•æ„Ÿæ•°æ®é…ç½®åœ¨Podçš„å®šä¹‰æˆ–è€…é•œåƒä¸­ï¼ŒSecretæä¾›äº†æ›´åŠ å®‰å…¨çš„æœºåˆ¶ï¼Œå°†éœ€è¦å…±äº«çš„æ•° æ®è¿›è¡ŒåŠ å¯†ï¼Œé˜²æ­¢æ•°æ®æ³„éœ²ã€‚

Secretçš„å¯¹è±¡éœ€è¦å•ç‹¬å®šä¹‰å¹¶åˆ›å»ºï¼Œé€šå¸¸ä»¥æ•°æ®å·çš„å½¢å¼æŒ‚è½½åˆ°Podä¸­ï¼ŒSecretçš„æ•°æ®å°†ä»¥æ–‡ä»¶çš„å½¢å¼ ä¿å­˜ï¼Œå®¹å™¨é€šè¿‡è¯»å–æ–‡ä»¶å¯ä»¥èŽ·å–éœ€è¦çš„æ•°æ®

Secret volumeæ˜¯é€šè¿‡tmpfsï¼ˆå†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼‰å®žçŽ°çš„ï¼Œæ‰€ä»¥**è¿™ç§ç±»åž‹çš„volumeä¸æ˜¯æ°¸ä¹…å­˜å‚¨çš„ã€‚**

**æ¯ä¸ªSecretçš„æ•°æ®ä¸èƒ½è¶…è¿‡1MB**ï¼Œæ”¯æŒé€šè¿‡èµ„æºé™é¢æŽ§åˆ¶æ¯ä¸ªåç§°ç©ºé—´çš„Secretçš„æ•°é‡

**æ³¨æ„: Secret å±žäºŽåç§°ç©ºé—´çº§åˆ«ï¼Œåªèƒ½è¢«åŒä¸€ä¸ªåç§°ç©ºé—´çš„Podå¼•ç”¨**



**Secret åˆ†æˆä»¥ä¸‹å¸¸è§å¤§çš„åˆ†ç±»**

| ç±»åž‹            | è§£æž                                                         |
| --------------- | ------------------------------------------------------------ |
| generic         | é€šç”¨ç±»åž‹ï¼ŒåŸºäºŽ**base64ç¼–ç **ç”¨æ¥å­˜å‚¨å¯†ç ï¼Œå…¬é’¥ç­‰ã€‚<br />å¸¸è§çš„å­ç±»åž‹æœ‰ï¼š Opaque,kubernetes.io/service-account-token,kubernetes.io/basicauth,kubernetes.io/ssh-auth,bootstrap.kubernetes.io/token,kubernetes.io/rbd |
| tls             | ä¸“é—¨ç”¨äºŽä¿å­˜tls/sslç”¨åˆ°è¯ä¹¦å’Œé…å¯¹çš„ç§é’¥,å¸¸è§çš„å­ç±»åž‹:kubernetes.io/tls |
| docker-registry | ä¸“ç”¨äºŽè®©kubeletå¯åŠ¨Podæ—¶ä»Žç§æœ‰é•œåƒä»“åº“pullé•œåƒæ—¶ï¼Œé¦–å…ˆè®¤è¯åˆ°ä»“åº“Registryæ—¶ä½¿ç”¨ <br />å¸¸è§çš„å­ç±»åž‹:kubernetes.io/dockercfg,kubernetes.io/dockerconfigjson |



**Secret ç»†åŒ–ä¸ºçš„å­ç±»åž‹(Type)**

| å¤§ç±»åž‹          | Builtin Type                       | è¯´æ˜Ž                                        |
| --------------- | ---------------------------------- | ------------------------------------------- |
| generic         | opaque                             | arbitrary user-defined data                 |
| generic         | kubernetes.io/service-accounttoken | service account token                       |
| generic         | kubernetes.io/basic-auth           | credentials for basic authentication        |
| generic         | kubernetes.io/ssh-auth             | credentials for SSH authentication          |
| generic         | bootstrap.kubernetes.io/token      | bootstrap token data åˆå§‹åŒ–                 |
| tls             | kubernetes.io/tls                  | data for a TLS client or server             |
| docker-registry | kubernetes.io/dockerconfigjson     | serialized ~/ .docker/config.json file æ–°ç‰ˆ |
| docker-registry | kubernetes.io/dockercfg            | serialized -/ .dockercfg file æ—§ç‰ˆ          |



**æ³¨æ„ï¼š**

ä¸åŒç±»åž‹çš„Secretï¼Œåœ¨å®šä¹‰æ—¶æ”¯æŒä½¿ç”¨çš„æ ‡å‡†å­—æ®µä¹Ÿæœ‰æ‰€ä¸åŒ

ä¾‹å¦‚: ssh-authç±»åž‹çš„Secretåº”è¯¥ä½¿ç”¨ssh-privatekeyï¼Œè€Œbasic-authç±»åž‹çš„Secretåˆ™éœ€è¦ä½¿ç”¨ usernameå’Œpasswordç­‰

å¦å¤–ä¹Ÿå¯èƒ½å­˜åœ¨ä¸€äº›ç‰¹æ®Šçš„ç±»åž‹, ç”¨äºŽæ”¯æ’‘ç¬¬ä¸‰æ–¹éœ€æ±‚ï¼Œä¾‹å¦‚: cephçš„keyringä¿¡æ¯ä½¿ç”¨çš„ kubernetes.io/rbdç­‰



**Secret åˆ›å»ºæ–¹å¼**

- **æ‰‹åŠ¨åˆ›å»º**ï¼šç”¨æˆ·è‡ªè¡Œåˆ›å»ºçš„Secret å¸¸ç”¨æ¥å­˜å‚¨ç”¨æˆ·ç§æœ‰çš„ä¸€äº›ä¿¡æ¯
- **è‡ªåŠ¨åˆ›å»º**ï¼šé›†ç¾¤è‡ªåŠ¨åˆ›å»ºçš„Secret ç”¨æ¥ä½œä¸ºé›†ç¾¤ä¸­å„ä¸ªç»„ä»¶ä¹‹é—´é€šä¿¡çš„èº«ä»½æ ¡éªŒä½¿ç”¨



**æŸ¥çœ‹Secret**

```bash
[root@master1 cm]# kubectl get secrets -A
NAMESPACE     NAME                     TYPE                            DATA   AGE
kube-system   bootstrap-token-8loc6r   bootstrap.kubernetes.io/token   6      4d6h

[root@master1 cm]# kubectl get secrets -n kube-system  bootstrap-token-8loc6r -o yaml
apiVersion: v1
data:
  auth-extra-groups: c3lzdGVtOmJvb3RzdHJhcHBlcnM6a3ViZWFkbTpkZWZhdWx0LW5vZGUtdG9rZW4=
  description: VGhlIGRlZmF1bHQgYm9vdHN0cmFwIHRva2VuIGdlbmVyYXRlZCBieSAna3ViZWFkbSBpbml0Jy4=
  token-id: OGxvYzZy
  token-secret: cjFybWE3dzQ4eG1kdmJudA==
  usage-bootstrap-authentication: dHJ1ZQ==
  usage-bootstrap-signing: dHJ1ZQ==
kind: Secret
metadata:
  creationTimestamp: "2024-12-28T07:55:15Z"
  name: bootstrap-token-8loc6r
  namespace: kube-system
  resourceVersion: "215"
  uid: b50e2dd9-50e8-4f60-879f-89086ff35b2f
type: bootstrap.kubernetes.io/token

# basey64è§£ç æŸ¥çœ‹descriptionå…·ä½“æ•°æ®
[root@master1 cm]#echo -n "VGhlIGRlZmF1bHQgYm9vdHN0cmFwIHRva2VuIGdlbmVyYXRlZCBieSAna3ViZWFkbSBpbml0Jy4="|base64 -d
The default bootstrap token generated by 'kubeadm init'.
```



#### Secretå‘½ä»¤å¼åˆ›å»º



![image-20250101223713630](D:\git_repository\cyber_security_learning\markdown_img\image-20250101223713630.png)



**æ ¼å¼**

```bash
 kubectl create secret [flags] [options] [-n <namespace>]
```



**å‘½ä»¤æ ¼å¼**

```bash
# genericç±»åž‹
kubectl create secret generic NAME [--type=string] [--from-file=[key=]source] [--from-literal=key1=value1]

--from-literal=key1=value1       #ä»¥å‘½ä»¤è¡Œè®¾ç½®é”®å€¼å¯¹çš„çŽ¯å¢ƒå˜é‡æ–¹å¼é…ç½®æ•°æ®
--from-env-file=/PATH/FILE       #ä»¥çŽ¯å¢ƒå˜é‡çš„ä¸“ç”¨æ–‡ä»¶çš„æ–¹å¼é…ç½®æ•°æ®
--from-file=[key=]/PATH/FILE     #ä»¥é…ç½®æ–‡ä»¶çš„æ–¹å¼åˆ›å»ºé…ç½®æ•°æ®ï¼Œå¦‚ä¸æŒ‡å®škeyï¼ŒFILEåç§°ä¸ºkeyå
--from-file=/PATH/DIR            #ä»¥é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„æ–¹å¼åˆ›å»ºé…ç½®æ•°æ®

#è¯¥å‘½ä»¤ä¸­çš„--typeé€‰é¡¹è¿›è¡Œå®šä¹‰é™¤äº†åŽé¢docker-registryå’Œtlså‘½ä»¤ä¹‹å¤–çš„å…¶å®ƒå­ç±»åž‹ï¼Œæœ‰äº›ç±»åž‹æœ‰keyçš„ç‰¹å®šè¦æ±‚
#æ³¨æ„: å¦‚æžœvauleä¸­æœ‰ç‰¹æ®Šå­—ç¬¦,æ¯”å¦‚:$,\,*,=,!ç­‰,éœ€è¦ç”¨\è¿›è¡Œè½¬ä¹‰æˆ–ç”¨å•å¼•å·''å¼•èµ·æ¥

#tlsç±»åž‹
kubectl create secret tls NAME --cert=/path/file --key=/path/file
#å…¶ä¿å­˜certæ–‡ä»¶å†…å®¹çš„keyåç§°ä¸èƒ½æŒ‡å®šè‡ªåŠ¨ä¸ºtls.crtï¼Œè€Œä¿å­˜private keyçš„keyä¸èƒ½æŒ‡å®šè‡ªåŠ¨tls.key

#docker-registryç±»åž‹
#æ–¹å¼1:åŸºäºŽç”¨æˆ·åå’Œå¯†ç æ–¹å¼å®žçŽ°
kubectl create secret docker-registry NAME --docker-username=user --docker-password=password --docker-email=email [--docker-server=string] [--from-file=[key=]source]

#æ–¹å¼2:åŸºäºŽdockerconfigæ–‡ä»¶æ–¹å¼å®žçŽ°
kubectl create secret docker-registry KEYNAME --fromfile=.dockerconfigjson=path/to/.docker/config.json
#ä»Žå·²æœ‰çš„jsonæ ¼å¼çš„æ–‡ä»¶åŠ è½½ç”Ÿæˆçš„å°±æ˜¯dockerconfigjsonç±»åž‹ï¼Œå‘½ä»¤è¡Œç›´æŽ¥ç”Ÿæˆçš„ä¹Ÿæ˜¯è¯¥ç±»åž‹
```



**èŒƒä¾‹**

```bash
# åˆ›å»ºgenericç±»åž‹
kubectl create secret generic my-secret-generic --from-file=/path/bar

kubectl create secret generic my-secret-generic --from-file=ssh-privatekey=~/.ssh/id_rsa --from-file=ssh-publickey=~/.ssh/id_rsa.pub

kubectl create secret generic my-secret-generic --from-literal=username=admin --from-literal=password=123456

kubectl create secret generic my-secret-generic --from-env-file=path/to/bar.env


# åˆ›å»ºtlsç±»åž‹
kubectl create secret tls my-secret-tls --cert=certs/wang.org.cert --key=certs/wang.org.key

#åˆ›å»ºdocker-registryç±»åž‹
#å‚è€ƒç¤ºä¾‹ï¼šhttps://Kubernetesmeetup.github.io/docs/tasks/configure-podcontainer/pull-image-private-registry/
#åŸºäºŽç§æœ‰ä»“åº“çš„ç”¨æˆ·åå’Œå¯†ç 
kubectl create secret docker-registry my-secret-docker-registry --docker-server=harbor.wang.org --docker-username=admin --docker-password=123456 --docker-email=29308620@qq.com

#å…ˆç™»å½•å¹¶è®¤è¯åˆ°ç›®æ ‡ä»“åº“serverä¸Šï¼Œè®¤è¯å‡­æ®è‡ªåŠ¨ä¿å­˜åœ¨dockercfgæ–‡ä»¶ä¸­,åŸºäºŽdockerconfigæ–‡ä»¶å®žçŽ°
kubectl create secret docker-registry dockerharbor-auth --from-file=.dockerconfigjson=/root/.docker/config.json

kubectl create secret generic dockerharbor-auth --
type='kubernetes.io/dockerconfigjson' --from-file=.dockerconfigjson=/root/.docker/config.json
```





#### Secretå£°æ˜Žå¼åˆ›å»º

Secret æ•°æ®å­˜æ”¾åœ¨dataæˆ–stringDataå­—æ®µ,å…¶ä¸­**dataå­—æ®µä¸­çš„Key/valueå¿…é¡»ä½¿ç”¨base64ç¼–ç å­˜æ”¾**,è€Œ stringDataä½¿ç”¨æ˜Žæ–‡å­˜æ”¾

Secret èµ„æºçš„å…ƒæ•°æ®ï¼šé™¤äº†name, namespaceä¹‹å¤–ï¼Œå¸¸ç”¨çš„è¿˜æœ‰labels, annotations

- annotationçš„åç§°éµå¾ªç±»ä¼¼äºŽlabelsçš„åç§°å‘½åæ ¼å¼ï¼Œä½†å…¶æ•°æ®é•¿åº¦ä¸å—é™åˆ¶
- å®ƒä¸èƒ½ç”¨äºŽè¢«æ ‡ç­¾é€‰æ‹©å™¨ä½œä¸ºç­›é€‰æ¡ä»¶ï¼›ä½†å¸¸ç”¨äºŽä¸ºé‚£äº›ä»å¤„äºŽBetaé˜¶æ®µçš„åº”ç”¨ç¨‹åºæä¾›ä¸´æ—¶çš„é…ç½®æŽ¥å£
- ç®¡ç†å‘½ä»¤ï¼škubectl annotate TYPE/NAME KEY=VALUE

```bash
[root@master1 ~]#kubectl explain secret
KIND:       Secret
VERSION:    v1

DESCRIPTION:
    Secret holds secret data of a certain type. The total bytes of the values in
    the Data field must be less than MaxSecretSize bytes.
    
FIELDS:
  apiVersion	<string>
    APIVersion defines the versioned schema of this representation of an object.
    Servers should convert recognized schemas to the latest internal value, and
    may reject unrecognized values. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

  data	<map[string]string>
    Data contains the secret data. Each key must consist of alphanumeric
    characters, '-', '_' or '.'. The serialized form of the secret data is a
    base64 encoded string, representing the arbitrary (possibly non-string) data
    value here. Described in https://tools.ietf.org/html/rfc4648#section-4

  immutable	<boolean>
    Immutable, if set to true, ensures that data stored in the Secret cannot be
    updated (only object metadata can be modified). If not set to true, the
    field can be modified at any time. Defaulted to nil.

  kind	<string>
    Kind is a string value representing the REST resource this object
    represents. Servers may infer this from the endpoint the client submits
    requests to. Cannot be updated. In CamelCase. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

  metadata	<ObjectMeta>
    Standard object's metadata. More info:
    https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

  stringData	<map[string]string>
    stringData allows specifying non-binary secret data in string form. It is
    provided as a write-only input field for convenience. All keys and values
    are merged into the data field on write, overwriting any existing values.
    The stringData field is never output when reading from the API.

  type	<string>
    Used to facilitate programmatic handling of secret data. More info:
    https://kubernetes.io/docs/concepts/configuration/secret/#secret-types

```





#### Secretå¼•ç”¨

Secretèµ„æºåœ¨Podä¸­å¼•ç”¨çš„æ–¹å¼æœ‰ä¸‰ç§

- **çŽ¯å¢ƒå˜é‡**
  - å¼•ç”¨Secretå¯¹è±¡ä¸Šç‰¹å®šçš„keyï¼Œä»¥valueFromèµ‹å€¼ç»™Podä¸ŠæŒ‡å®šçš„çŽ¯å¢ƒå˜é‡
  - åœ¨Podä¸Šä½¿ç”¨envFromä¸€æ¬¡æ€§å¯¼å…¥Secretå¯¹è±¡ä¸Šçš„æ‰€æœ‰key-valueï¼Œkey(ä¹Ÿå¯ä»¥ç»Ÿä¸€é™„åŠ ç‰¹å®šå‰ç¼€ï¼‰ å³ä¸ºçŽ¯å¢ƒå˜é‡å,valueè‡ªåŠ¨æˆ ä¸ºç›¸åº”çš„å˜é‡å€¼
  - æ³¨æ„ï¼šå®¹å™¨å¾ˆå¯èƒ½ä¼šå°†çŽ¯å¢ƒå˜é‡æ‰“å°åˆ°æ—¥å¿—ä¸­,åŸºäºŽå®‰å…¨è€ƒè™‘**ä¸å»ºè®®ä»¥çŽ¯å¢ƒå˜é‡æ–¹å¼å¼•ç”¨Secretä¸­çš„æ•æ„Ÿæ•°æ®**
- **secretå·**
  - åœ¨Podä¸Šå°†Secretå¯¹è±¡å¼•ç”¨ä¸ºå­˜å‚¨å·ï¼Œè€ŒåŽæ•´ä½“ç”±å®¹å™¨mountè‡³æŸä¸ªç›®å½•ä¸‹,å…¶ä¸­keyåç§°è½¬ä¸ºæ–‡ä»¶ åï¼Œvalueçš„å€¼è½¬ä¸ºç›¸åº”çš„æ–‡ä»¶å†…å®¹
  - åœ¨Podä¸Šå®šä¹‰Secretå·æ—¶ï¼Œä¹Ÿå¯ä»¥ä»…å¼•ç”¨å…¶ä¸­çš„æŒ‡å®šçš„éƒ¨åˆ†keyï¼Œè€ŒåŽç”±å®¹å™¨mountè‡³ç›®å½•ä¸‹
- **æ‹‰å–é•œåƒ**
  - åœ¨Pod ä¸Šä½¿ç”¨ imagePullSecrets æ‹‰å–ç§æœ‰ä»“åº“é•œåƒä½¿ç”¨
  - Podå¼•ç”¨Secretçš„æ–¹å¼ï¼špods.spec.imagePullSecrets





#### Generic æ¡ˆä¾‹

generic ä¸»è¦ç”¨äºŽå®žçŽ°ç”¨æˆ·åå’Œå¯†ç çš„åŠ å¯†ä¿å­˜

æ³¨æ„: genericåŠ å¯†ä¿å­˜è¦æ³¨æ„æ¢è¡Œé—®é¢˜ `\n `

```bash
#genericç±»åž‹
kubectl create secret generic NAME [--type=string] [--from-file=[key=]source] [--from-literal=key1=value1]

--from-literal=key1=value1        #ä»¥å‘½ä»¤è¡Œè®¾ç½®é”®å€¼å¯¹çš„æ–¹å¼é…ç½®æ•°æ®
--from-env-file=/PATH/TO/FILE       #ä»¥çŽ¯å¢ƒå˜é‡ä¸“ç”¨æ–‡ä»¶çš„æ–¹å¼é…ç½®æ•°æ®
--from-file=[key=]/PATH/TO/FILE #ä»¥é…ç½®æ–‡ä»¶çš„æ–¹å¼åˆ›å»ºé…ç½®æ•°æ®ï¼Œå¦‚ä¸æŒ‡å®škeyï¼ŒFILEåç§°ä¸ºkeyå
--from-file=/PATH/TO/DIR        #ä»¥é…ç½®æ–‡ä»¶æ‰€åœ¨ç›®å½•çš„æ–¹å¼åˆ›å»ºé…ç½®æ•°æ®

#è¯¥å‘½ä»¤ä¸­çš„--typeé€‰é¡¹è¿›è¡Œå®šä¹‰é™¤äº†åŽé¢docker-registryå’Œtlså‘½ä»¤ä¹‹å¤–çš„å…¶å®ƒå­ç±»åž‹ï¼Œæœ‰äº›ç±»åž‹æœ‰keyçš„ç‰¹å®šè¦æ±‚
#æ³¨æ„: å¦‚æžœvauleä¸­æœ‰ç‰¹æ®Šå­—ç¬¦,æ¯”å¦‚:$,\,*,=,!ç­‰,éœ€è¦ç”¨\è¿›è¡Œè½¬ä¹‰æˆ–ç”¨å•å¼•å·''å¼•èµ·æ¥
```



##### èŒƒä¾‹ï¼šå‘½ä»¤å¼åˆ›å»º generic

```bash
# å‘½ä»¤å¼åˆ›å»º
[root@master1 ~]# kubectl create secret generic secret-mysql-root --from-literal=username=root --f
rom-literal=password=123456
secret/secret-mysql-root created

# æŸ¥çœ‹
[root@master1 ~]# kubectl get secrets 
NAME                TYPE     DATA   AGE
secret-mysql-root   Opaque   2      6s

# æŸ¥çœ‹Genericä½¿ç”¨Base64ç¼–ç 
[root@master1 ~]# kubectl get secrets secret-mysql-root -o yaml
apiVersion: v1
data:
  password: MTIzNDU2
  username: cm9vdA==
kind: Secret
metadata:
  creationTimestamp: "2025-01-02T01:19:55Z"
  name: secret-mysql-root
  namespace: default
  resourceVersion: "247070"
  uid: 5e668e52-7990-47ec-93b6-a412649c5417
type: Opaque

# è§£ç 
[root@master1 ~]# echo -n "MTIzNDU2" | base64 -d
123456
[root@master1 ~]# echo -n "cm9vdA==" | base64 -d
root

# åˆ é™¤
[root@master1 ~]# kubectl delete secrets secret-mysql-root 
secret "secret-mysql-root" deleted
```



##### èŒƒä¾‹ï¼šstringDataæ˜Žæ–‡æ•°æ®

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 secret] # vim storage-secret-opaque-stringData.yaml
apiVersion: v1
kind: Secret
metadata:
  name: secret-stringdata
  namespace: default
type: opaque
stringData:                  # stringDataè¡¨ç¤ºæ˜Žæ–‡å­˜æ”¾æ•°æ®ï¼Œdataè¡¨ç¤ºå¿…é¡»ä»¥base64ç¼–ç å­˜æ”¾
  user: 'admin'
  password: '123456'


# åº”ç”¨
[root@master1 secret] # kubectl apply -f storage-secret-opaque-stringData.yaml 
secret/secret-stringdata created

# æŸ¥çœ‹
[root@master1 secret] # kubectl get secrets 
NAME                TYPE     DATA   AGE
secret-stringdata   opaque   2      5s

# æŸ¥çœ‹
[root@master1 secret] # kubectl get secrets secret-stringdata -o yaml
apiVersion: v1
data:
  password: MTIzNDU2
  user: YWRtaW4=
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Secret","metadata":{"annotations":{},"name":"secret-stringdata","namespace":"default"},"stringData":{"password":"123456","user":"admin"},"type":"opaque"}
  creationTimestamp: "2025-01-02T01:27:51Z"
  name: secret-stringdata
  namespace: default
  resourceVersion: "247832"
  uid: 58fa1297-3800-4c02-bfd7-b9a63212f1e3
type: opaque

# åˆ é™¤
[root@master1 secret] # kubectl delete -f storage-secret-opaque-stringData.yaml 
secret "secret-stringdata" deleted
```



#####  èŒƒä¾‹: Secret é€šè¿‡çŽ¯å¢ƒå˜é‡ä¸ºæä¾›MySQLçŽ¯å¢ƒåˆå§‹åŒ–çš„å¯†ç ä¿¡æ¯

```yaml
# MySQLå®¹å™¨æ”¯æŒMYSQL_ROOT_PASSWORDå˜é‡å­˜æ”¾å¯†ç ,ä½¿ç”¨çŽ¯å¢ƒå˜é‡åˆ›å»ºMySQLå®¹å™¨
[root@master1 secret] # docker run --name mysql_test -e MYSQL_ROOT_PASSWORD=123456 -d mysql:8.0

# ç™»å½•éªŒè¯
[root@master1 secret] # docker exec mysql_test mysql -uroot -h127.0.0.1 -p123456 -e status
mysql: [Warning] Using a password on the command line interface can be insecure.
--------------
mysql  Ver 8.0.40 for Linux on x86_64 (MySQL Community Server - GPL)

Connection id:		8
Current database:	
Current user:		root@127.0.0.1
SSL:			Cipher in use is TLS_AES_256_GCM_SHA384
Current pager:		stdout
Using outfile:		''
Using delimiter:	;
Server version:		8.0.40 MySQL Community Server - GPL
Protocol version:	10
Connection:		127.0.0.1 via TCP/IP
Server characterset:	utf8mb4
Db     characterset:	utf8mb4
Client characterset:	latin1
Conn.  characterset:	latin1
TCP port:		3306
Uptime:			48 sec

Threads: 2  Questions: 5  Slow queries: 0  Opens: 119  Flush tables: 3  Open tables: 38  Queries per second avg: 0.104
--------------

# ç”Ÿæˆå¯†ç çš„base64ç¼–ç 
[root@master1 secret] # echo -n root|base64
cm9vdA==
[root@master1 secret] # echo -n 123456|base64
MTIzNDU2

# æ¸…å•æ–‡ä»¶ï¼Œsecret é€šè¿‡çŽ¯å¢ƒä¸ºæä¾›MySQLçŽ¯å¢ƒåˆå§‹åŒ–çš„å¯†ç ä¿¡æ¯ï¼Œä½†å¾ˆä¸å®‰å…¨
[root@master1 secret]#cat storage-secret-mysql-init.yaml 
apiVersion: v1
kind: Secret
metadata:
  name: secret-mysql
type: kubernetes.io/basic-auth
# type: Opaque  # ä¹Ÿå¯ä»¥ç”¨Opaqueç±»åž‹
data:
  username: cm9vdA==
  password: MTIzNDU2
---
apiVersion: v1
kind: Pod
metadata:
  name: pod-secret-mysql-init
spec:
  containers:
  - name: mysql
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/mysql:8.0.29-oracle
    env:
    - name: MYSQL_ROOT_PASSWORD
      valueFrom:
        secretKeyRef:
          name: secret-mysql   # å¼•ç”¨æŒ‡å®šçš„secret
          key: password        # å¼•ç”¨æŒ‡å®šçš„secretä¸­å¯¹åº”çš„key
          optional: false      # å¿…é¡»å­˜åœ¨

# åº”ç”¨
[root@master1 secret] # kubectl apply -f storage-secret-mysql-init.yaml 
secret/secret-mysql created
pod/pod-secret-mysql-init created

# æŸ¥çœ‹ç»“æžœ
[root@master1 secret] # kubectl get secrets 
NAME           TYPE                       DATA   AGE
secret-mysql   kubernetes.io/basic-auth   2      28s

[root@master1 secret] # kubectl get pod
NAME                    READY   STATUS    RESTARTS      AGE
pod-secret-mysql-init   1/1     Running   0             47s

# å¯ä»¥é€šè¿‡çŽ¯å¢ƒå˜é‡æŸ¥çœ‹åˆ°å¯†ç ï¼Œå¾ˆä¸å®‰å…¨
[root@master1 secret]#kubectl exec pod-secret-mysql-init -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=pod-secret-mysql-init # -------------- secretå˜é‡
MYSQL_ROOT_PASSWORD=123456     # -------------- secretå˜é‡
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
GOSU_VERSION=1.14
MYSQL_MAJOR=8.0
MYSQL_VERSION=8.0.29-1.el8
MYSQL_SHELL_VERSION=8.0.29-1.el8
HOME=/root

# éªŒè¯å¯†ç ç™»å½•MySQL
[root@master1 secret] # kubectl exec pod-secret-mysql-init -- mysql -uroot -p123456 -e status
mysql: [Warning] Using a password on the command line interface can be insecure.
--------------
mysql  Ver 8.0.29 for Linux on x86_64 (MySQL Community Server - GPL)

Connection id:		8
Current database:	
Current user:		root@localhost
SSL:			Not in use
Current pager:		stdout
Using outfile:		''
Using delimiter:	;
Server version:		8.0.29 MySQL Community Server - GPL
Protocol version:	10
Connection:		Localhost via UNIX socket
Server characterset:	utf8mb4
Db     characterset:	utf8mb4
Client characterset:	latin1
Conn.  characterset:	latin1
UNIX socket:		/var/run/mysqld/mysqld.sock
Uptime:			2 min 27 sec

Threads: 2  Questions: 5  Slow queries: 0  Opens: 117  Flush tables: 3  Open tables: 36  Queries per second avg: 0.034
--------------

# æ›´æ”¹å¯†ç 
[root@master1 yaml] # echo -n 654321 | base64 
NjU0MzIx

[root@master1 yaml] # vim storage-secret-mysql-init.yaml
data:
 username: cm9vdAo=
 password: NjU0MzIx   #ä¿®æ”¹å¯†ç 
 
# é‡æ–°åº”ç”¨
[root@master1 secret] # kubectl apply -f storage-secret-mysql-init.yaml 
secret/secret-mysql configured
pod/pod-secret-mysql-init unchanged

# æŸ¥çœ‹æ˜¯å¦å˜åŒ–
[root@master1 secret] # kubectl get secrets secret-mysql -o yaml
apiVersion: v1
data:
  password: NjU0MzIx        # æˆåŠŸæ›´æ–°
  username: cm9vdA==
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"password":"NjU0MzIx","username":"cm9vdA=="},"kind":"Secret","metadata":{"annotations":{},"name":"secret-mysql","namespace":"default"},"type":"kubernetes.io/basic-auth"}
  creationTimestamp: "2025-01-02T01:40:21Z"
  name: secret-mysql
  namespace: default
  resourceVersion: "249464"
  uid: 1ba61d4f-41d6-4f3a-989d-4f572ec08734
type: kubernetes.io/basic-auth

# Podå†…å˜é‡æ²¡æœ‰è‡ªåŠ¨æ›´æ–°
[root@master1 secret] # kubectl exec pod-secret-mysql-init -- env|grep PASSWORD
MYSQL_ROOT_PASSWORD=123456

# åˆ é™¤Podé‡å»º
[root@master1 secret] # kubectl delete pod pod-secret-mysql-init 
pod "pod-secret-mysql-init" deleted

[root@master1 secret] # kubectl apply -f storage-secret-mysql-init.yaml 
secret/secret-mysql unchanged
pod/pod-secret-mysql-init created

# Podå†…å˜é‡æ›´æ–°æˆåŠŸ
[root@master1 secret] # kubectl exec pod-secret-mysql-init -- env|grep PASSWORD
MYSQL_ROOT_PASSWORD=654321

# æ¸…ç†çŽ¯å¢ƒ
[root@master1 secret] # kubectl delete -f storage-secret-mysql-init.yaml 
secret "secret-mysql" deleted
pod "pod-secret-mysql-init" deleted
```



##### èŒƒä¾‹: é€šè¿‡å·è°ƒç”¨ secret

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 secret] # cat storage-secret-test-pod.yaml 
apiVersion: v1
kind: Secret
metadata:
  name: secret-test
type: kubernetes.io/basic-auth
data:
  username: YWRtaW4=
  password: cGFzc3dvcmQ=

# è¯´æ˜Žï¼š
#typeç±»åž‹æŒ‡å®šä¸º Opaque æˆ–è€… kubernetes.io/basic-auth,usernameå’Œpasswordæ˜¯åŠ å¯†çš„ä¿¡æ¯
#èµ„æºå®šä¹‰æ–‡ä»¶æ—¶ï¼Œä¸Žå‘½ä»¤è¡Œåˆ›å»ºsecretçš„--from-literal=username=admin æ•ˆæžœæ˜¯ä¸€æ ·çš„,ä½†å‘½ä»¤è¡Œçš„å˜é‡æ— éœ€åŠ å¯†

---
# è°ƒç”¨secretçš„æ¸…å•æ–‡ä»¶
apiVersion: v1
kind: Pod
metadata:
  name: pod-secret-volume
spec:
  volumes:
  - name: secret
    secret:
      secretName: secret-test    # æŒ‡å®šsecretçš„åç§°
  containers:
  - name: secret-test-container
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    volumeMounts:
    - name: secret
      mountPath: /secret/
      readOnly: true

# åˆ›å»ºèµ„æº
[root@master1 secret] # kubectl apply -f  storage-secret-test-pod.yaml 
secret/secret-test unchanged
pod/pod-secret-volume created

# æŸ¥çœ‹
[root@master1 secret] # kubectl get secrets 
NAME          TYPE                       DATA   AGE
secret-test   kubernetes.io/basic-auth   2      56s

# éªŒè¯
[root@master1 secret]#kubectl exec pod-secret-volume  -- ls /secret
password
username

# åœ¨Podè¿è¡Œçš„å®¿ä¸»æœºä¸Šå¯ä»¥çœ‹åˆ°secretå¯¹åº”çš„æ–‡ä»¶
[root@node2 ~] # find /var/lib/kubelet -name password
/var/lib/kubelet/pods/0439bb26-fdfc-4769-9cc9-d47c718fb301/volumes/kubernetes.io~secret/secret/password

[root@node2 ~] # cat /var/lib/kubelet/pods/0439bb26-fdfc-4769-9cc9-d47c718fb301/volumes/kubernetes.io~secret/secret/password
password

# æ¸…ç†çŽ¯å¢ƒ
[root@master1 secret] # kubectl delete -f storage-secret-test-pod.yaml 
secret "secret-test" deleted
pod "pod-secret-volume" deleted
```



##### èŒƒä¾‹: ä¸º Service Account åˆ›å»º Secret

```yaml
#k8s-v1.24ç‰ˆæœ¬åŽ,åˆ›å»ºSAä¸ä¼šè‡ªåŠ¨åˆ›å»ºsecret,éœ€è¦æ‰‹åŠ¨åˆ›å»ºsecret
[root@master1 secret] # cat storage-secret-sa.yaml 
apiVersion: v1
kind: ServiceAccount
metadata:
  name: testsa
---
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: testsa-secret
  namespace: default
  annotations:
    kubernetes.io/service-account.name: "testsa"

# æŸ¥çœ‹
[root@master1 secret] # kubectl get secrets,sa
NAME                   TYPE                                  DATA   AGE
secret/testsa-secret   kubernetes.io/service-account-token   3      29s

NAME                     SECRETS   AGE
serviceaccount/default   0         4d18h
serviceaccount/testsa    0         29s

# æŸ¥çœ‹å¯¹åº”token
[root@master1 secret] # kubectl get secrets testsa-secret -o yaml
apiVersion: v1
data:
  ca.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJZHhKUmVsbVJDVlF3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TkRFeU1qZ3dOelV3TURWYUZ3MHpOREV5TWpZd056VTFNRFZhTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUMrdG9oRDcwaUhEVzNxeFhPeVlsaFpveER0bUZFSTRjTk93K0RySDZFcFVxaVdSUDM0TmwxSzNuR3kKdlRJM3BlRkJtQnF4cXFSSGhCV3M3QUNHTUNFM3VJTHdpN21WTTBrOXJrTW9XeDBIL0draTFyQUJRRXhCS0xyUgp3MTJTdE1QNTFKMHJKaUpxU1I3SElCQ1N5b2NSTzFmYmZNY0VQKzRvK2ZLaWxybHZtTVZIS08vb1czSlJBSXA1CjNkSTBlZUNHTytIN1FFV0RDUlZwek10emtRUGg5L2hMM0t2eEVtSFRtcGt5N2NLNFVoc3c5ZVBrOTVxTmgybnoKUExKd0laNTBpRkh0M05VclRjVUJwTUlpN2VKZEZ0T0ZCTXEraEdvLzJRZlIzUTZ1dmpLdFdrTk9tcFcwRmRaYwpvbHlwbjFmZjdUUEFMVFc4eWdlSGIwRnhIR1R6QWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJTWGtXOGRYRVVpanlhRThiZGFRU1pxd2k5UVFUQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQ0FkTTQ3RHNHUApla2VUQXRXdTFFc3NJVlJJWUZ4bzZhNzBPZG8rOGxyQ2xVdjc1SzRHbkxxc3ByaFA5Y2dPN0JZbXpxb0xNazR2Cmwyem1VOFlqbXYrblVpaWVFMkcyekh6dFNZRXZ2RHBoL1FUajl0Yk1LYmpqenRQYWlNTE9RUXB6bXNXR2FIYzIKUTMrMnZlYzNFY3JneTJidCtUOWNDUE9za0ZZemlNTzZaMEVtNXdtRkgxbk9CRkdCSWpwVUJUZmV5TURkMjNwNwp6THB5M0RUMkNTVWkva2NOeWpOd0tZczhTTmNwRjYyc1VCS2h1eUdidG8rSEo2Q3J6UmFTb3hRcW9BeHdtRUl6CjhYZHhnbEFaSm5tY0F2L0lKVW1HOGVTRFhYMTZNdDBsSm5XT0JzTHJXU08rN1BwWkR0UFlnaG5rVGgweHNmNHUKODEydFFWelpnYjFsCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
  namespace: ZGVmYXVsdA==
  token: ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltdERURWRTV0VwNFozbGpTamxMWlhsTFRrTjZMWE5EZUZsQmJsaE5OR1paY1hSelowTkhjelUzVURnaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJblJsYzNSellTMXpaV055WlhRaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNXVZVzFsSWpvaWRHVnpkSE5oSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaWEoyYVdObExXRmpZMjkxYm5RdWRXbGtJam9pTURNNVpUZGpNalF0TXpkaVpTMDBNamt4TFRneE9HTXRNemxqWWpKaFkyVmhOekkySWl3aWMzVmlJam9pYzNsemRHVnRPbk5sY25acFkyVmhZMk52ZFc1ME9tUmxabUYxYkhRNmRHVnpkSE5oSW4wLkI3SFQtQWx5MWt2Wk1TTGFfSTREWHBGM0lkZ2JVaHJXWkczZXBQdVprcTQtWkpfcGN5MTJabkVCTUttLVRTbTFwNWhrQ3gzQm5NQzJ6QmF0VHJIRmp5TkhQSWRuZFJwMk9NMzZHeHNKOGNna0tOU21FMVg3bmM4R2w0ZkxYcDJXSWdUQVN2ZWFVOFI3UWFlZWhXaXdpNzNLNjVpMjNqNEtFYW9YRHhyS2hmb1RIWkdhVG5hVFdTTFZPNW5aRTBZNjg4VnVvem9rcEtrX21Qa1RteUpYUFhPanJKTGNBbHNkSGw2enVhaklJSlkyOGhUQTdCR2NyRnRGSzN3Nm1SLUdTSWpra2pzUmRkQW1mR1lsSVhlci1UMkItZ2Z0eWVaeElvM214OVJzRWhNdzY0Z2V6LUh6NmR6cC1JUVNqMHZwNmtHME1pbTR0WDdRZHpiOWhZaWNtQQ==
kind: Secret
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Secret","metadata":{"annotations":{"kubernetes.io/service-account.name":"testsa"},"name":"testsa-secret","namespace":"default"},"type":"kubernetes.io/service-account-token"}
    kubernetes.io/service-account.name: testsa
    kubernetes.io/service-account.uid: 039e7c24-37be-4291-818c-39cb2acea726
  creationTimestamp: "2025-01-02T02:16:03Z"
  name: testsa-secret
  namespace: default
  resourceVersion: "252537"
  uid: 61a2410e-06eb-4222-ba61-df9a4589db5e
type: kubernetes.io/service-account-token

# èŽ·å–ä¸Šé¢çš„Tokenå€¼å¹¶è§£ç ç”Ÿæˆå˜é‡TOKEN
[root@master1 secret]#TOKEN=$(echo ZXlKaGJHY2lPaUpTVXpJMU5pSXNJbXRwWkNJNkltdERURWRTV0VwNFozbGpTamxMWlhsTFRrTjZMWE5EZUZsQmJsaE5OR1paY1hSelowTkhjelUzVURnaWZRLmV5SnBjM01pT2lKcmRXSmxjbTVsZEdWekwzTmxjblpwWTJWaFkyTnZkVzUwSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXVZVzFsYzNCaFkyVWlPaUprWldaaGRXeDBJaXdpYTNWaVpYSnVaWFJsY3k1cGJ5OXpaWEoyYVdObFlXTmpiM1Z1ZEM5elpXTnlaWFF1Ym1GdFpTSTZJblJsYzNSellTMXpaV055WlhRaUxDSnJkV0psY201bGRHVnpMbWx2TDNObGNuWnBZMlZoWTJOdmRXNTBMM05sY25acFkyVXRZV05qYjNWdWRDNXVZVzFsSWpvaWRHVnpkSE5oSWl3aWEzVmlaWEp1WlhSbGN5NXBieTl6WlhKMmFXTmxZV05qYjNWdWRDOXpaWEoyYVdObExXRmpZMjkxYm5RdWRXbGtJam9pTURNNVpUZGpNalF0TXpkaVpTMDBNamt4TFRneE9HTXRNemxqWWpKaFkyVmhOekkySWl3aWMzVmlJam9pYzNsemRHVnRPbk5sY25acFkyVmhZMk52ZFc1ME9tUmxabUYxYkhRNmRHVnpkSE5oSW4wLkI3SFQtQWx5MWt2Wk1TTGFfSTREWHBGM0lkZ2JVaHJXWkczZXBQdVprcTQtWkpfcGN5MTJabkVCTUttLVRTbTFwNWhrQ3gzQm5NQzJ6QmF0VHJIRmp5TkhQSWRuZFJwMk9NMzZHeHNKOGNna0tOU21FMVg3bmM4R2w0ZkxYcDJXSWdUQVN2ZWFVOFI3UWFlZWhXaXdpNzNLNjVpMjNqNEtFYW9YRHhyS2hmb1RIWkdhVG5hVFdTTFZPNW5aRTBZNjg4VnVvem9rcEtrX21Qa1RteUpYUFhPanJKTGNBbHNkSGw2enVhaklJSlkyOGhUQTdCR2NyRnRGSzN3Nm1SLUdTSWpra2pzUmRkQW1mR1lsSVhlci1UMkItZ2Z0eWVaeElvM214OVJzRWhNdzY0Z2V6LUh6NmR6cC1JUVNqMHZwNmtHME1pbTR0WDdRZHpiOWhZaWNtQQ==|base64 -d)

# ä½¿ç”¨ä¸Šé¢TOKENè®¿é—®ï¼ŒéªŒè¯ç”¨æˆ·èº«ä»½ï¼Œä½†æƒé™ä¸è¶³
[root@master1 secret] # curl -s --cacert /etc/kubernetes/pki/ca.crt -H "Authorization:Bearer ${TOKEN}" https://10.0.0.201:6443 
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "forbidden: User \"system:serviceaccount:default:testsa\" cannot get path \"/\"",
  "reason": "Forbidden",
  "details": {},
  "code": 403
}

# åˆ é™¤
[root@master1 secret] # kubectl delete -f storage-secret-sa.yaml 
serviceaccount "testsa" deleted
```



#### TLSæ¡ˆä¾‹

TLS ç±»åž‹çš„ Secret ä¸»è¦ç”¨äºŽå¯¹**httpsåœºæ™¯**çš„è¯ä¹¦å’Œå¯†é’¥æ–‡ä»¶æ¥è¿›è¡ŒåŠ å¯†ä¼ è¾“

```bash
#tlsç±»åž‹æ ¼å¼
kubectl create secret tls NAME --cert=/path/file --key=/path/file

#æ³¨æ„ï¼š
#ä¿å­˜certæ–‡ä»¶å†…å®¹çš„keyåç§°ä¸èƒ½æŒ‡å®šï¼Œè‡ªåŠ¨ä¸ºtls.crtï¼Œå·æŒ‚è½½åŽç”Ÿæˆçš„æ–‡ä»¶åä¹Ÿä¸ºtls.crt
#ä¿å­˜private keyæ–‡ä»¶å†…å®¹çš„keyä¸èƒ½æŒ‡å®š,è‡ªåŠ¨ä¸ºtls.keyï¼Œå·æŒ‚è½½åŽç”Ÿæˆçš„æ–‡ä»¶åä¹Ÿä¸ºtls.key

```

![image-20250102102801681](D:\git_repository\cyber_security_learning\markdown_img\image-20250102102801681.png)



ä¸‹é¢æ¡ˆä¾‹å®žçŽ°ä¸€ä¸ªåŸºäºŽhttps çš„nginxçš„webæœåŠ¡

#####  åˆ›å»º TLS è¯ä¹¦æ–‡ä»¶

```bash
# ç”Ÿæˆç§é’¥
[root@master1 tls]# openssl genrsa -out nginx-certs/mystical.org.key 2048

# ç”Ÿæˆè‡ªç­¾è¯ä¹¦
[root@master1 tls]# openssl req -new -x509 -key nginx-certs/mystical.org.key -days 3650 -out nginx-certs/mystical.org.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=www.mystical.org
#æ³¨æ„ï¼šCNæŒ‡å‘çš„åŸŸåå¿…é¡»æ˜¯nginxé…ç½®ä¸­ä½¿ç”¨çš„åŸŸåä¿¡æ¯

# æŸ¥çœ‹æ–‡ä»¶
[root@master1 tls]# ls nginx-certs/
mystical.org.crt  mystical.org.key
```



##### åŸºäºŽ TLS è¯ä¹¦æ–‡ä»¶åˆ›å»ºå¯¹åº”çš„ Secret

```yaml
[root@master1 tls] # kubectl create secret tls secret-nginx-ssl --cert=nginx-certs/mystical.org.crt  --key=nginx-certs/mystical.org.key 
secret/secret-nginx-ssl created

# æŸ¥çœ‹ç»“æžœ
[root@master1 tls] # kubectl get secrets 
NAME               TYPE                DATA   AGE
secret-nginx-ssl   kubernetes.io/tls   2      23s

# æŸ¥çœ‹å†…å®¹
[root@master1 tls]#kubectl get secrets secret-nginx-ssl -o yaml
apiVersion: v1
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURtekNDQW9PZ0F3SUJBZ0lVTjJtZHRnQU1obHNvdlRhbkxaK2F5M29oNW9jd0RRWUpLb1pJaHZjTkFRRUwKQlFBd1hURUxNQWtHQTFVRUJoTUNRMDR4RURBT0JnTlZCQWdNQjBKbGFXcHBibWN4RURBT0JnTlZCQWNNQjBKbAphV3BwYm1jeER6QU5CZ05WQkFvTUJrUmxkazl3Y3pFWk1CY0dBMVVFQXd3UWQzZDNMbTE1YzNScFkyRnNMbTl5Clp6QWVGdzB5TlRBeE1ESXdNak14TlRsYUZ3MHpOREV5TXpFd01qTXhOVGxhTUYweEN6QUpCZ05WQkFZVEFrTk8KTVJBd0RnWURWUVFJREFkQ1pXbHFhVzVuTVJBd0RnWURWUVFIREFkQ1pXbHFhVzVuTVE4d0RRWURWUVFLREFaRQpaWFpQY0hNeEdUQVhCZ05WQkFNTUVIZDNkeTV0ZVhOMGFXTmhiQzV2Y21jd2dnRWlNQTBHQ1NxR1NJYjNEUUVCCkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEaVVZUjVacFoxY2NML0wydVNTZTB0aU5RMVpCVzRFaHN2YVdweHJTbncKeENac3NWb0pnbzV3eExmeTV6dTY1QmFLOTJsR29xbWRUWFYxbG54UTJERWQ0S3JXVmNDQnhlaHNDRGx1bVZUVgpIRGF0QkFpeWtzRWd4bmszNzdma2FHbGtKSmp0dWlCalRNdlNFUnlMYWlWbGI4Y1BjWDFyNzdNNXJMQ3lhdkZDCm5yM21JWWxYQi9POE42N21zdHI3TlNVNkN4ZFgzVkdXVzdRYzFLVFJ4SGhmQ1o0aHd3RTBFOFNZeHZuTTRsUkIKNitidThZbEpsb0JUZGFOQko3NkpaOE5CbzJpcEc0VTZSMmhMNEVPdnkyOGJBOWlCdisyc2RmM3NzQ0F3U1pqUgpab1RoTlQyaXU2cG5sTXR5Nzg5WmFpSTBPMThWZ2hVQ0swYU4zRmRnTE9VN0FnTUJBQUdqVXpCUk1CMEdBMVVkCkRnUVdCQlRGTGhreDFCQTJEMHNTUG1jVnhPNktDSWF0b3pBZkJnTlZIU01FR0RBV2dCVEZMaGt4MUJBMkQwc1MKUG1jVnhPNktDSWF0b3pBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFDZwoxTmhtZlcrOTRHTFBuNXE4QlFqcXpzL1ZSSlBGMTNYbXBDVTREczJFdm5ya0JXb0NRYXJlSmdiUjZzMi82R1dKCjVud0Ewbjd4VnBiYk1UV2U0bVdrd3N0STJPRXJhYnhlQml2NVdBeGF5ZzMzOXQ3WkhCQkJpdzFqZU14d28yNm4KMnlJUFkxU0dYMVdoY2RqL21FNVQyZnRYb3RLUHFrUk5lNFBpdDdXRlBEOUlWd3FJdWM3Q3QwSjFDaFpQVWZONgpxdGhaTUd4S2RQbVc4TnZaeU5GUDV6Q2JheXVXQmJFZjc0WE9tQ0Jqa0x4a0NIcHFkTjRwVkhQb3QxUkxRQ3pkCjlhWCsyUS9XMWdkS3pGMzNucnJLSTMzd3Jpclo3UVp5QjVBaHplOUxwMFBiQjRlTFkyUzgvRkxiaWhSZm90SEMKREJaQzltckFsNWNHK0pIeE42OFoKLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUV2Z0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktnd2dnU2tBZ0VBQW9JQkFRRGlVWVI1WnBaMWNjTC8KTDJ1U1NlMHRpTlExWkJXNEVoc3ZhV3B4clNud3hDWnNzVm9KZ281d3hMZnk1enU2NUJhSzkybEdvcW1kVFhWMQpsbnhRMkRFZDRLcldWY0NCeGVoc0NEbHVtVlRWSERhdEJBaXlrc0VneG5rMzc3ZmthR2xrSkpqdHVpQmpUTXZTCkVSeUxhaVZsYjhjUGNYMXI3N001ckxDeWF2RkNucjNtSVlsWEIvTzhONjdtc3RyN05TVTZDeGRYM1ZHV1c3UWMKMUtUUnhIaGZDWjRod3dFMEU4U1l4dm5NNGxSQjYrYnU4WWxKbG9CVGRhTkJKNzZKWjhOQm8yaXBHNFU2UjJoTAo0RU92eTI4YkE5aUJ2KzJzZGYzc3NDQXdTWmpSWm9UaE5UMml1NnBubE10eTc4OVphaUkwTzE4VmdoVUNLMGFOCjNGZGdMT1U3QWdNQkFBRUNnZ0VBQ3Bvb3NML3FadGhzVUU4VTVOYXd2K21CT00vQS9XSzFGNmRYdjJQamdKak4KSWdTOFErWWVyU1ZuWnFveXovZTFIMC9RTHo1dk5XUWhEMS84TlQ5WTF3ajZNb05Ka0VBZUQzTGloSTRMVXRaNQpCZW1YOTJHaVNZVHl2YzVDN2t0K2tISHZJTWZrNTRkUlR4SFNlcXpVMFZLSFgrK3E5cWovMjVaUzlYREd4UE9iClFzQW5KejYrb2syVDhwMWNNZXZqSUZUWkIrbk8vYmhQWkZUZHAwalZ5WWhsMHkvRXk2Z2pEQ1pBaEM3UFFZck4KQ2lLZWpSL2ZpQ1NUaURkSXJ0Y2JoQmlCL2xVZWhyd3JldnpvOWhFcnBWb3daeThhRHVERVkxL0ZWTVRsMUc0agppTWhMcUxSYkFFZ1R6T1pNYUY4TU5KNTR4KzZURFAxTldxcUFDYkt1VFFLQmdRRHdydGR2cmVHOTJmTWVNT3RHCnhhdFpZUDZWd2laYU0zbmJIN1B3UkxXMkVjODlaMjRLVnJhUGt6bjhWOC8ySTNBTVVhRElxeTlvb0ZWNThzeEoKc044VWcxdzZObTZQR043UWFEUUR3ZWRxbGtxSzFzK0dXWFVZWXVjUmM2eE5ESm5EZHlKRmJPc05ubzdCNlRabAppWGhtdVJ6NWl0V1RrWVg4YldkVkpRdkwvUUtCZ1FEd3VLYlEvS3A2NUs2aXJVM3dXZzJlK0RIUlZUZWwrV1F4Cm9JbUJVODFkNUVMVzFUNHdOZSs4WWxoVmJwR0lMeTczeWo3a2xBY2VsMlJJM3JqK0xtd05iNFZPN05LTkc1VkwKNW5tdW4wcUlocUNya1ZOL2hWcUovK1h1eFJtMWpmYlRROURCSHl6WVJJVjBKU3QvV2tmUnFTeFE2Wk5zTXlZawp0RTYwZVQ3UGx3S0JnUUNtYVMwNTRXN2d0bzQ3UkxXWUpGb2FIVTlKT29rTCt1VjVGVTF6aGY1aG1hVEJudjdkCmxTRDYybC9RVXVMT0c2aUFTL3d3WXZRUGtqUW5jakcvamRSZ09ZY09GTTZTa0M2V3lFV1doMzQ3R3hrRk1Bc2kKcUQybkU5TVNKUGx2K0pOa0s3MzlaSmFNdnlHVGYyMEYvV3ZMRXBpdkRVZ29sUWlnQlFEYVJSZ0gvUUtCZ0d1dgp6MENTcDVsT2tDbEtLaUdweDRva01mVVprRWw1cGE3bHlGM0lwWWlwUXBWazArc3hWY3dLbXNXdEx3R2pTZm1qCnlqcnJWYndEc2VNL2I3YVdBZFNJM1RRUGthbDZlM0YyNjF5SStnalZZUzhmVmlFb0FQYlhPWDkxUVNrTkZ5d3YKbkVXb3NxRVZGalo5SWxaWWh1UnVMOXNLZ3Q3V2l1dkVsYWo2ekhTRkFvR0JBSTFaZnFiK2VpVkhDU0JBaHN5bgpiYzRRazlHNmxoaXByYnZlQXRTUjRsWnFXeWlXdmpvZU5WZWVJVk14Wm1XVUtEZ29ZZDNPNC96RFpmYm9PNCtqCk1QWk40RzhrYS9IcWNKRFl0N3pzRXJ5WU5QVnVNSmsyTzhMcXAxbzBwdVM2cUFoaDVXVjJ1c1UvNXZKZDY0emcKa05ENWk5S3E3b250YzRHdVVvWTRpeGdLCi0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0K
kind: Secret
metadata:
  creationTimestamp: "2025-01-02T02:35:26Z"
  name: secret-nginx-ssl
  namespace: default
  resourceVersion: "254403"
  uid: e4c5eeac-23a3-4412-8f7e-c07dbf5dc837
type: kubernetes.io/tls
```



å‡†å¤‡Nginxé…ç½®æ–‡ä»¶

```bash
# nginxä¸»é…ç½®æ–‡ä»¶ myserver.conf
[root@master1 tls]#vim myserver.conf
server {
    listen 80;
    server_name www.mystical.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name www.mystical.org;
    
     ssl_certificate /etc/nginx/certs/tls.crt; 
     ssl_certificate_key /etc/nginx/certs/tls.key;
     ssl_session_timeout 5m;
     ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; 
     ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
     ssl_prefer_server_ciphers on;
     include /etc/nginx/conf.d/myserver-*.cfg;

     location / {
         root /usr/share/nginx/html;
     }
}

# nginxçš„åŽ‹ç¼©é…ç½®æ–‡ä»¶:myserver-gzip.cfg
[root@master1 tls]#vim myserver-gzip.cfg
gzip on;
gzip_comp_level 5;
gzip_proxied     expired no-cache no-store private auth;
gzip_types text/plain text/css application/xml text/javascript;


# nginxçš„çŠ¶æ€é¡µé…ç½®æ–‡ä»¶myserver-status.cfg
[root@master1 tls]#vim myserver-status.cfg
location /status {
   stub_status on;
   access_log off;
}
```



#####  åˆ›å»ºé…ç½®æ–‡ä»¶å¯¹åº”çš„ Configmap

```bash
# æŸ¥çœ‹é…ç½®æ–‡ä»¶
[root@master1 tls]# ls nginx-ssl-conf.d/
myserver.conf  myserver-gzip.cfg  myserver-status.cfg

# åˆ›å»ºcm
[root@master1 tls]# kubectl create configmap cm-nginx-ssl-conf --from-file=nginx-ssl-conf.d/
configmap/cm-nginx-ssl-conf created

# æŸ¥çœ‹
[root@master1 tls]# kubectl get cm
NAME                DATA   AGE
cm-nginx-ssl-conf   3      42s
kube-root-ca.crt    1      4d18h
```



##### åˆ›å»ºå¼•ç”¨Secretå’Œconfigmapèµ„æºé…ç½®æ–‡ä»¶

```yaml
# åˆ›å»ºèµ„æºé…ç½®æ–‡ä»¶
[root@master1 tls] # cat storage-secret-nginx-ssl.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-nginx-ssl
  namespace: default
spec:
  volumes:
  - name: nginx-certs
    secret:
      secretName: secret-nginx-ssl
  - name: nginx-confs
    configMap:
      name: cm-nginx-ssl-conf
      optional: false
  containers:
  - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
    name: nginx-ssl-server
    volumeMounts:
    - name: nginx-certs
      mountPath: /etc/nginx/certs/  # å…¶ä¿å­˜certæ–‡ä»¶è‡ªåŠ¨å‘½åä¸ºtls.crtï¼Œè€Œprivate keyæ–‡ä»¶ä¼šè‡ªåŠ¨å‘½åä¸ºtls.key
      readOnly: true
    - name: nginx-confs
      mountPath: /etc/nginx/conf.d/
      readOnly: true


# åº”ç”¨
[root@master1 tls] # kubectl apply -f storage-secret-nginx-ssl.yaml 
pod/pod-nginx-ssl created

# éªŒè¯ç»“æžœ
[root@master1 tls] # kubectl get pod pod-nginx-ssl -o wide
NAME            READY   STATUS    RESTARTS   AGE   IP             NODE    NOMINATED NODE   READINESS GATES
pod-nginx-ssl   1/1     Running   0          24s   10.244.3.150   node3   <none>           <none>

# æŸ¥çœ‹ç”Ÿæˆçš„è¯ä¹¦æ–‡ä»¶ï¼Œè¡¨ç¤ºä¸ºå…³è”æ—¶é—´æˆ³ç›®å½•ä¸‹çš„ä¸¤ä¸ªåŒå±‚è½¯é“¾æŽ¥æ–‡ä»¶tls.crtå’Œtls.key,ä¿å­˜è¯ä¹¦çš„åŽŸå§‹æ–‡ä»¶,è€Œéžbase64æ ¼å¼
[root@master1 tls] # kubectl exec -it pod-nginx-ssl -- ls -l /etc/nginx/certs/
total 0
lrwxrwxrwx 1 root root 14 Jan  2 02:47 tls.crt -> ..data/tls.crt
lrwxrwxrwx 1 root root 14 Jan  2 02:47 tls.key -> ..data/tls.key

# è®¿é—®Pod
[root@master1 tls]#curl -H'host: www.mystical.org' http://10.244.3.150 -I
HTTP/1.1 301 Moved Permanently
Server: nginx/1.20.0
Date: Thu, 02 Jan 2025 02:59:02 GMT
Content-Type: text/html
Content-Length: 169
Connection: keep-alive
Location: https://www.mystical.org/

[root@master1 tls] # curl 10.244.3.150 -kL
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
</head>
<body>
<h1>Welcome to nginx!</h1>
<p>If you see this page, the nginx web server is successfully installed and
working. Further configuration is required.</p>

<p>For online documentation and support please refer to
<a href="http://nginx.org/">nginx.org</a>.<br/>
Commercial support is available at
<a href="http://nginx.com/">nginx.com</a>.</p>

<p><em>Thank you for using nginx.</em></p>
</body>
</html>

# æ¸…ç†çŽ¯å¢ƒ
[root@master1 tls] # kubectl delete -f storage-secret-nginx-ssl.yaml 
pod "pod-nginx-ssl" deleted
[root@master1 tls] # kubectl delete cm cm-nginx-ssl-conf 
configmap "cm-nginx-ssl-conf" deleted
[root@master1 tls] # kubectl delete secrets tls secret-nginx-ssl 
secret "secret-nginx-ssl" deleted
```



#### Docker-registryæ¡ˆä¾‹

æœ‰æ—¶Dockerçš„ä»“åº“æ˜¯ç§æœ‰çš„,å¦‚æžœæƒ³ä¸‹è½½é•œåƒ,å°±éœ€è¦åœ¨ä¸‹è½½é•œåƒçš„ä¸»æœºä¸Šç™»å½•ä»“åº“å¹¶è®¤è¯åŽæ‰èƒ½å®žçŽ°

ä½†æ˜¯åœ¨Kubernetesé›†ç¾¤ä½¿ç”¨ç§æœ‰ä»“åº“é•œåƒå°±æ¯”è¾ƒç¹ç,å› ä¸ºè¿è¡ŒPod çš„å®¿ä¸»æœºå¹¶ä¸å›ºå®š,å¦‚æžœåœ¨æ¯ä¸ª workerèŠ‚ç‚¹ç™»å½•éªŒè¯æ˜¾ç„¶æ˜¯ä¸æ–¹ä¾¿çš„

dockercfgåŠdockerconfigjsonç±»åž‹çš„Secret é€‚ç”¨äºŽå®žçŽ°è®©kubeletä»Žç§æœ‰Image Registryä¸­ä¸‹è½½å®¹å™¨é•œåƒ

å…¶å¼•ç”¨å®šä¹‰åœ¨pod.spec.imagePullSecretså­—æ®µä¸Šçš„åˆ—è¡¨,å³æ”¯æŒå¤šä¸ªdocker-registryç±»åž‹çš„Secret,ä»Žä¸Šè‡³ä¸‹é€ä¸ªè¿›è¡ŒåŒ¹é…



**åˆ›å»ºæ­¤ç§secret å¯ä»¥é€šè¿‡ä¸‹é¢æ–¹å¼å®žçŽ°**

**æ–¹æ³•1: é€šè¿‡å‘½ä»¤åˆ›å»º**

```bash
kubectl create secret docker-registry KEYNAME --docker-server=DOCKER_REGISTRY_SERVER --docker-username=DOCKER_USER --docker-password=DOCKER_PASSWORD --docker-email=EMAIL
```



**æ–¹å¼äºŒ: é€šè¿‡dockerè®¤è¯æ–‡ä»¶åˆ›å»º**

```bash
# å…ˆç™»å½•å¹¶è®¤è¯åˆ°ç›®æ ‡ä»“åº“serverä¸Šï¼Œè®¤è¯å‡­æ®è‡ªåŠ¨ä¿å­˜åœ¨~/.docker/config.jsonæ–‡ä»¶ä¸­
docker login --username=DOCKER_USER DOCKER_REGISTRY_SERVER

#åŸºäºŽconfig.jsonæ–‡ä»¶ç”Ÿæˆsecret
kubectl create secret docker-registry KEYNAME --from-file=.dockerconfigjson=path/to/.docker/config.json

kubectl create secret generic KEYNAME --type='kubernetes.io/dockerconfigjson' --from-file=.dockerconfigjson=/root/.docker/config.json

# ç¤ºä¾‹
kubectl create secret docker-registry my-secret --from-file=.dockerconfigjson=path/to/.docker/config.json

kubectl create secret generic dockerharbor-auth --
type='kubernetes.io/dockerconfigjson' --from-file=.dockerconfigjson=/root/.docker/config.json
```





##### é€šè¿‡å‘½ä»¤åˆ›å»ºç§æœ‰ä»“åº“ç™»å½•è®¤è¯ä¿¡æ¯



**å®‰è£…å¹¶åˆ›å»ºHarborçš„ç§æœ‰ä»“åº“å’Œé¡¹ç›®**

```bash
# ä¸‹è½½harborçš„åŒ…
wget https://www.mysticalrecluse.com/script/tools/harbor-offline-installer-v2.11.0.tgz
# ä½¿ç”¨è„šæœ¬ä¸‹è½½å¹¶éƒ¨ç½²harbor
wget https://www.mysticalrecluse.com/script/Shell/install_harbor.sh
bash install_harbor.sh
......
Harbor å®‰è£…å®Œæˆ

Harborå®‰è£…å®Œæˆ!                                            [  OK  ]
-------------------------------------------------------------------
è¯·è®¿é—®é“¾æŽ¥: http://10.0.0.131/
ç”¨æˆ·å’Œå¯†ç : admin/123456
```

![image-20250102141543930](D:\git_repository\cyber_security_learning\markdown_img\image-20250102141543930.png)



##### åˆ›å»ºHarborç”¨æˆ·

![image-20250102141832106](D:\git_repository\cyber_security_learning\markdown_img\image-20250102141832106.png)



##### ç»™libraryé¡¹ç›®æ·»åŠ æˆå‘˜

![image-20250102141948806](D:\git_repository\cyber_security_learning\markdown_img\image-20250102141948806.png)



##### å°†harborçš„åŸŸåè§£æžæ·»åŠ åˆ°åŸŸåæœåŠ¡å™¨ä¸Š

```bash
[root@ubuntu2204 ~]#cat /etc/bind/db.mystical.org 
$TTL 86400

@ IN  SOA dns1 msticalrecluse.gmail.com (123 12H 10M 3D 1D)

  IN  NS dns1

dns1 A 10.0.0.131
harbor A 10.0.0.131
feng A 11.11.11.11
nfs A 10.0.0.131

# ä¹‹å‰åœ¨CoreDNSä¸Šå·²ç»æŒ‡å®šäº†è½¬å‘çš„DNSæœåŠ¡å™¨ä¸º10.0.0.131
# éšä¾¿åˆ›å»ºä¸€ä¸ªPodæµ‹è¯•
[root@master1 yaml]# kubectl apply -f myapp.yaml 
deployment.apps/myapp created

# æˆåŠŸè§£æž
[root@master1 yaml]#kubectl exec myapp-7b94444f8d-7zqjv -- ping harbor.mystical.org
PING harbor.mystical.org. (10.0.0.131): 56 data bytes
64 bytes from 10.0.0.131: seq=0 ttl=63 time=0.755 ms
64 bytes from 10.0.0.131: seq=1 ttl=63 time=0.190 ms

# æ›´æ”¹harborçš„yamlæ–‡ä»¶ï¼ŒæŒ‡å®šåŸŸåè®¿é—®
[root@ubuntu2204 ~]#vim /usr/local/harbor/harbor.yml
hostname: harbor.mystical.org  # ---è¿™é‡Œæ›´æ”¹ä¸ºæŒ‡å®šåŸŸåï¼ŒåŽç»­ä½¿ç”¨åŸŸåè®¿é—®harbor

# ä½¿ç”¨prepareé‡æ–°ç”Ÿæˆè„šæœ¬
[root@ubuntu2204 harbor]# ls
common     docker-compose.yml     harbor.yml       install.sh  prepare
common.sh  harbor.v2.11.0.tar.gz  harbor.yml.tmpl  LICENSE
[root@ubuntu2204 harbor]# ./prepare 
prepare base dir is set to /usr/local/harbor
WARNING:root:WARNING: HTTP protocol is insecure. Harbor will deprecate http protocol in the future. Please make sure to upgrade to https
Clearing the configuration file: /config/nginx/nginx.conf
Clearing the configuration file: /config/registryctl/config.yml
Clearing the configuration file: /config/registryctl/env
Clearing the configuration file: /config/db/env
Clearing the configuration file: /config/log/rsyslog_docker.conf
Clearing the configuration file: /config/log/logrotate.conf
Clearing the configuration file: /config/registry/config.yml
Clearing the configuration file: /config/registry/root.crt
Clearing the configuration file: /config/registry/passwd
Clearing the configuration file: /config/core/env
Clearing the configuration file: /config/core/app.conf
Clearing the configuration file: /config/portal/nginx.conf
Clearing the configuration file: /config/jobservice/config.yml
Clearing the configuration file: /config/jobservice/env
Generated configuration file: /config/portal/nginx.conf
Generated configuration file: /config/log/logrotate.conf
Generated configuration file: /config/log/rsyslog_docker.conf
Generated configuration file: /config/nginx/nginx.conf
Generated configuration file: /config/core/env
Generated configuration file: /config/core/app.conf
Generated configuration file: /config/registry/config.yml
Generated configuration file: /config/registryctl/env
Generated configuration file: /config/registryctl/config.yml
Generated configuration file: /config/db/env
Generated configuration file: /config/jobservice/env
Generated configuration file: /config/jobservice/config.yml
loaded secret from file: /data/secret/keys/secretkey
Generated configuration file: /compose_location/docker-compose.yml
Clean up the input dir

# åˆ é™¤ä¹‹å‰çš„docker composeèµ·çš„harborï¼Œé‡æ–°åˆ›å»ºharbor
[root@ubuntu2204 harbor]# docker-compose down
Stopping harbor-jobservice ... done
Stopping nginx             ... done
Stopping harbor-core       ... done
Stopping redis             ... done
Stopping harbor-db         ... done
Stopping harbor-portal     ... done
Stopping registry          ... done
Stopping registryctl       ... done
Stopping harbor-log        ... done
Removing harbor-jobservice ... done
Removing nginx             ... done
Removing harbor-core       ... done
Removing redis             ... done
Removing harbor-db         ... done
Removing harbor-portal     ... done
Removing registry          ... done
Removing registryctl       ... done
Removing harbor-log        ... done
Removing network harbor_harbor

# é‡æ–°ä½¿ç”¨serviceå¯åŠ¨harbor
[root@ubuntu2204 harbor]# systemctl start harbor.service 
```



##### æ›´æ”¹å®¿ä¸»æœºä¸Šçš„hostæ–‡ä»¶åŽï¼Œä½¿ç”¨åŸŸåç™»å½•harbor

![image-20250102145733724](D:\git_repository\cyber_security_learning\markdown_img\image-20250102145733724.png)



##### ä½¿dockerä¿¡ä»»harborï¼Œä¿®æ”¹æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„dockeré…ç½®

```bash
# ä¿®æ”¹æ‰€æœ‰é›†ç¾¤èŠ‚ç‚¹çš„Dockeré…ç½®æ”¯æŒç§æœ‰ä»“åº“
[root@node1 ~]# vim /etc/docker/daemon.json 
{
      "registry-mirrors": ["https://si7y70hh.mirror.aliyuncs.com"],
      "insecure-registries": ["harbor.mystical.org"], # æ·»åŠ æ­¤è¡Œ
      "no-proxy": "127.0.0.0/8,172.17.0.0/16,10.0.0.0/24,10.244.0.0/16,192.168.0.0/16,wang.org,cluster.local,harbor.mystical.org" # å¦‚æžœé…äº†ä»£ç†ï¼Œåœ¨ä»£ç†ä¸­å°†harbor.mystical.orgæŽ’é™¤ï¼Œä¹Ÿå°±æ˜¯æ·»åŠ harbor.mystical.orgåœ¨noproxyå­—æ®µ
     }

# æ›´æ”¹ä»£ç†é…ç½®ï¼Œä¿®æ”¹ /etc/systemd/system/docker.service.d/http-proxy.conf æ–‡ä»¶
[root@node1 ~]# vim /etc/systemd/system/docker.service.d/http-proxy.conf
[Service]
Environment="NO_PROXY=127.0.0.0/8,172.17.0.0/16,10.0.0.0/24,10.244.0.0/16,192.168.0.0/16,wang.org,cluster.local,harbor.mystical.org" # ä¿®æ”¹è¿™è¡Œ


# é‡å¯docker
[root@node1 ~]#systemctl daemon-reload
[root@node1 ~]# systemctl restart docker

# æŸ¥çœ‹
[root@node1 ~]#docker info
......
 HTTP Proxy: http://10.0.0.1:10809/
 HTTPS Proxy: http://10.0.0.1:10809/
 # åœ¨noproxyä¸­æ·»åŠ harbor.mystical.org
 No Proxy: 127.0.0.0/8,172.17.0.0/16,10.0.0.0/24,10.244.0.0/16,192.168.0.0/16,wang.org,cluster.local,harbor.mystical.org
 Experimental: false
 # æ·»åŠ ä¿¡ä»»
 Insecure Registries:
  harbor.mystical.org
  127.0.0.0/8
 Registry Mirrors:
  https://si7y70hh.mirror.aliyuncs.com/
 Live Restore Enabled: false
 Product License: Community Engine


# ç™»å½•æµ‹è¯•
[root@node1 ~]# docker login harbor.mystical.org -u mystical -p 'Zyf646130..'
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded
```



##### ä½¿ç”¨å‘½ä»¤è¡Œæ–¹å¼åˆ›å»ºdocker-registryç±»åž‹çš„secret

```bash
[root@master1 yaml]# kubectl create secret docker-registry harbor-docker-registry-secret --docker-server=harbor.mystical.org --docker-username=mystical --docker-password=Zyf646130..
secret/harbor-docker-registry-secret created

# æŸ¥çœ‹
[root@master1 yaml]# kubectl get secret
NAME                            TYPE                             DATA   AGE
harbor-docker-registry-secret   kubernetes.io/dockerconfigjson   1      21s

```



##### ä½¿ç”¨adminè´¦å·ï¼Œåˆ›å»ºä¸€ä¸ªç§æœ‰é¡¹ç›®exampleï¼Œå¹¶æ·»åŠ æˆå‘˜mystical

![image-20250102153457019](D:\git_repository\cyber_security_learning\markdown_img\image-20250102153457019.png)

![image-20250102153558659](D:\git_repository\cyber_security_learning\markdown_img\image-20250102153558659.png)



##### åœ¨nodeèŠ‚ç‚¹æµ‹è¯•ç§æœ‰ä»“èƒ½å¦ä¸Šä¼ ä¸‹è½½é•œåƒ

```bash
# ç™»å½•
[root@node3 ~]#docker login harbor.mystical.org -u mystical -p 'Zyf646130..'
WARNING! Using --password via the CLI is insecure. Use --password-stdin.
WARNING! Your password will be stored unencrypted in /root/.docker/config.json.
Configure a credential helper to remove this warning. See
https://docs.docker.com/engine/reference/commandline/login/#credentials-store

Login Succeeded

# æŸ¥çœ‹dockeré•œåƒï¼Œé€‰ä¸€ä¸ªä¸Šä¼ åˆ°harborä»“åº“
[root@node3 ~]#docker images

# æ›´æ”¹é•œåƒtagåç§°
[root@node3 ~]#docker tag registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0 harbor.mystical.org/example/nginx:1.20.0

# ä¸Šä¼ æˆåŠŸ
[root@node3 ~]#docker push harbor.mystical.org/example/nginx:1.20.0
The push refers to repository [harbor.mystical.org/example/nginx]
272bc57d3405: Pushed 
f7141923aaa3: Pushed 
9b63e6289fbe: Pushed 
a2f4f809e04e: Pushed 
1839f9962bd8: Pushed 
02c055ef67f5: Pushed 
1.20.0: digest: sha256:598057a5c482d2fb42092fd6f4ba35ea4cc86c41f5db8bb68d1ab92c4c40db98 size: 1570
```



##### ä½¿ç”¨åˆ›å»ºçš„secretè®©k8sä»Žç§æœ‰ä»“ä¸­æ‹‰å–é•œåƒ

```bash
[root@master1 yaml]#cat storage-secret-docker-registry-harbor.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-harbor-docker-registry-secret
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pod-test-harbor-docker-registry-secret
  template:
    metadata:
      labels:
        app: pod-test-harbor-docker-registry-secret
    spec:
      containers:
      - name: pod-test-harbor-docker-registry-secret
        image: harbor.mystical.org/example/nginx:1.20.0
      imagePullSecrets:
      - name: harbor-docker-registry-secret  # æŒ‡å®šdocker-registryç±»åž‹çš„secretï¼Œå¦‚æžœæœ‰å¤šä¸ªä¼šé€ä¸ªéªŒè¯

# åº”ç”¨
[root@master1 yaml]# kubectl apply -f storage-secret-docker-registry-harbor.yaml 
deployment.apps/deployment-harbor-docker-registry-secret created

# æŸ¥çœ‹
[root@master1 yaml]#kubectl get pod -o wide
NAME                                                       READY   STATUS    RESTARTS      AGE   IP             NODE    NOMINATED NODE   READINESS GATES
deployment-harbor-docker-registry-secret-97787d89c-fbw8v   1/1     Running   0             22s   10.244.1.143   node1   <none>           <none>
deployment-harbor-docker-registry-secret-97787d89c-plcdx   1/1     Running   0             22s   10.244.2.88    node2   <none>           <none>
deployment-harbor-docker-registry-secret-97787d89c-tgzmx   1/1     Running   0             22s   10.244.3.154   node3   <none>           <none>
myapp-7b94444f8d-7zqjv                                     1/1     Running   2 (20m ago)   88m   10.244.2.86    node2   <none>           <none>
myapp-7b94444f8d-9x8xk                                     1/1     Running   1 (20m ago)   88m   10.244.3.152   node3   <none>           <none>
myapp-7b94444f8d-dh7jd                                     1/1     Running   4 (28m ago)   88m   10.244.1.140   node1   <none>           <none>
```





### downwardAPI

#### dockerwardAPIä»‹ç»

åœ¨Kubernetesä¸­ å¯ä»¥åŸºäºŽä¸€ç§ downwardAPI çš„å¯¹è±¡ï¼Œ**å°†å®¿ä¸»æœºç›¸å…³çš„ä¿¡æ¯ä»¥å­˜å‚¨å·çš„æ ·å¼åŠ è½½åˆ°podå†…éƒ¨**ã€‚

ç›¸è¾ƒäºŽconfigmapã€secretç­‰èµ„æºå¯¹è±¡éœ€è¦åˆ›å»ºåŽæ‰èƒ½ä½¿ç”¨ï¼ŒdownwardAPI ä¸æ˜¯å­˜å‚¨å·ï¼Œæ— éœ€äººä¸ºåˆ› å»ºï¼Œå®ƒè‡ªèº«ä¸€ç›´å°±å­˜åœ¨ã€‚

downwardAPI ä¸æ˜¯ä¸€ç§ç‹¬ç«‹çš„APIèµ„æºç±»åž‹ï¼Œåªæ˜¯ä¸€ç§å¼•ç”¨Podè‡ªèº«çš„è¿è¡ŒçŽ¯å¢ƒä¿¡æ¯

downwardAPI åŒ…æ‹¬Podçš„metadata,spectæˆ–statuså­—æ®µå€¼ï¼Œå°†è¿™äº›ä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨å†…éƒ¨çš„æ–¹å¼

downwardAPI ä¸ºè¿è¡Œåœ¨podä¸­çš„åº”ç”¨å®¹å™¨æä¾›äº†ä¸€ç§åå‘å¼•ç”¨ã€‚è®©å®¹å™¨ä¸­çš„åº”ç”¨ç¨‹åºäº†è§£æ‰€å¤„podæˆ– Nodeçš„ä¸€äº›åŸºç¡€å±žæ€§ä¿¡æ¯ã€‚



![image-20250102155831373](D:\git_repository\cyber_security_learning\markdown_img\image-20250102155831373.png)



ä¸è¿‡ï¼Œ**é€šå¸¸åªæœ‰å¸¸é‡ç±»åž‹çš„å±žæ€§**æ‰èƒ½å¤Ÿé€šè¿‡çŽ¯å¢ƒå˜é‡æ³¨å…¥åˆ°å®¹å™¨ä¸­ï¼Œæ¯•ç«Ÿï¼Œåœ¨è¿›ç¨‹å¯åŠ¨å®ŒæˆåŽæ— æ³•å†å‘ å…¶å‘ŠçŸ¥å˜é‡å€¼çš„å˜åŠ¨ï¼ŒäºŽæ˜¯ï¼ŒçŽ¯å¢ƒå˜é‡ä¹Ÿå°±ä¸æ”¯æŒä¸­é€”çš„æ›´æ–°æ“ä½œã€‚



**DownwardAPIæä¾›äº†ä¸¤ç§æ–¹å¼ç”¨äºŽå°† Pod çš„ä¿¡æ¯æ³¨å…¥åˆ°å®¹å™¨å†…éƒ¨**

- **çŽ¯å¢ƒå˜é‡**ï¼šç”¨äºŽå•ä¸ªå˜é‡ï¼Œå¯ä»¥å°† Pod ä¿¡æ¯å’Œå®¹å™¨ä¿¡æ¯ç›´æŽ¥æ³¨å…¥å®¹å™¨å†…éƒ¨
- **VolumeæŒ‚è½½**ï¼šå°† Pod ä¿¡æ¯ç”Ÿæˆä¸ºæ–‡ä»¶ï¼Œå†æŒ‚è½½åˆ°å®¹å™¨å†…éƒ¨ä¸­



ç±»ä¼¼äºŽConfigMapæˆ–Secretèµ„æºï¼Œå®¹å™¨èƒ½å¤Ÿåœ¨çŽ¯å¢ƒå˜é‡ä¸­**valueFromå­—æ®µ**ä¸­åŸºäºŽ**ä¸¤ä¸ªå­—æ®µ**æ¥å¼•ç”¨å…¶æ‰€å±ž Podå¯¹è±¡çš„å…ƒæ•°æ®ä¿¡æ¯

- **fieldRef**ï¼šå¼•ç”¨å¸¸è§„æ€§çš„å…ƒæ•°æ®
- **resourceFieldRef**ï¼šå¼•ç”¨å’Œèµ„æºé™åˆ¶å’Œèµ„æºè¯·æ±‚ç›¸å…³çš„å…ƒæ•°æ®



**Downward API fields injected via the fieldRef field**

| Field                       | Description                                                  | Allowed in env | Allowed in volume |
| --------------------------- | ------------------------------------------------------------ | -------------- | ----------------- |
| metadata.name               | The podâ€™s name.                                              | Yes            | Yes               |
| metadata.namespace          | The podâ€™s namespace.                                         | Yes            | Yes               |
| metadata.uid                | The podâ€™s UID.                                               | Yes            | Yes               |
| metadata.labels             | All the podâ€™s labels, one label per line, formatted as key=â€ valueâ€ . | No             | Yes               |
| metadata.labels['key']      | The value of the specified label.                            | Yes            | Yes               |
| metadata.annotations        | All the podâ€™s annotations, one per line, formatted as key=â€ valueâ€ . | No             | Yes               |
| metadata.annotations['key'] | The value of the specified annotation.                       | Yes            | Yes               |
| spec.nodeName               | The name of the worker node the pod runs on.                 | Yes            | No                |
| spec.serviceAccountName     | The name of the podâ€™s service account.                       | Yes            | No                |
| status.podIP                | The podâ€™s IP address                                         | Yes            | No                |
| status.hostIP               | The worker nodeâ€™s IP address.                                | Yes            | No                |



**Table 9.6 Downward API resource fields injected via the resourceFieldRef field**

| Resource field             | Description                                | Allowed in env | Allowed in vol |
| -------------------------- | ------------------------------------------ | -------------- | -------------- |
| requests.cpu               | The containerâ€™s CPU request.               | Yes            | Yes            |
| requests.memory            | The containerâ€™s memory request.            | Yes            | Yes            |
| requests.ephemeral-storage | The containerâ€™s ephemeral storage request. | Yes            | Yes            |
| limits.cpu                 | The containerâ€™s CPU limit.                 | Yes            | Yes            |
| limits.memory              | The containerâ€™s memory limit.              | Yes            | Yes            |
| limits.ephemeral-storage   | The containerâ€™s ephemeral storage limit.   | Yes            | Yes            |



#### downwardAPIæ¡ˆä¾‹

##### èŒƒä¾‹ï¼šèŽ·å–åŸºæœ¬çš„å˜é‡ä¿¡æ¯é€šè¿‡å˜é‡æ–¹å¼å¼•ç”¨

```yaml
# å®šåˆ¶çš„èµ„æºå¯¹è±¡
[root@master1 yaml] # vim storage-downwardapi-env-test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: downwardapi-env-test
  labels:
    app: downwardapi-env
spec:
  containers:
  - name: downwardapi-env-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    resources:
      requests:
        memory: "32Mi"
        cpu: "250m"
      limits:
        memory: "64Mi"
        cpu: "500m"
    env:
    - name: THIS_POD_NAME
      valueFrom:
        fieldRef:                 
          fieldPath: metadata.name 
          # "fieldPath"æŒ‡å®šçš„æ˜¯ Pod çš„æŸäº›å…ƒæ•°æ®å­—æ®µçš„è·¯å¾„ï¼Œå®ƒå‘Šè¯‰ Kubernetes è¦ä»Ž Pod çš„å“ªäº›éƒ¨åˆ†æå–å€¼ã€‚
    - name: THIS_POD_NAMESPACE
      valueFrom:
        fieldRef:
          fieldPath: metadata.namespace
    - name: THIS_APP_LABEL
      valueFrom:
        fieldRef:
          fieldPath: metadata.labels['app']
    - name: THIS_CPU_LIMIT
      valueFrom:
        resourceFieldRef:
          resource: limits.cpu
    - name: THIS_MEM_REQUEST
      valueFrom:
        resourceFieldRef:
          resource: requests.memory
          divisor: 1Mi
    - name: VAR_REF
      value: $(THIS_POD_NAMESPACE).wang.org  # å˜é‡å¼•ç”¨æ ¼å¼:$(VAR_NAME)


[root@master1 yaml] # kubectl apply -f storage-downwardapi-env-test.yaml 
pod/downwardapi-env-test created

[root@master1 yaml] # kubectl get pod
NAME                   READY   STATUS    RESTARTS   AGE
downwardapi-env-test   1/1     Running   0          2m36s

# æŸ¥çœ‹çŽ¯å¢ƒå˜é‡
[root@master1 yaml] # kubectl exec -it downwardapi-env-test -- env
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=downwardapi-env-test
TERM=xterm
THIS_APP_LABEL=downwardapi-env
THIS_CPU_LIMIT=1
THIS_MEM_REQUEST=32
VAR_REF=default.wang.org
THIS_POD_NAME=downwardapi-env-test
THIS_POD_NAMESPACE=default
KUBERNETES_PORT_443_TCP_PROTO=tcp
KUBERNETES_PORT_443_TCP_PORT=443
KUBERNETES_PORT_443_TCP_ADDR=10.96.0.1
KUBERNETES_SERVICE_HOST=10.96.0.1
KUBERNETES_SERVICE_PORT=443
KUBERNETES_SERVICE_PORT_HTTPS=443
KUBERNETES_PORT=tcp://10.96.0.1:443
KUBERNETES_PORT_443_TCP=tcp://10.96.0.1:443
DEPLOYENV=Production
RELEASE=Stable
PS1=[\u@\h \w]\$ 
HOME=/root

# åˆ é™¤
[root@master1 yaml]#kubectl delete pod downwardapi-env-test 
pod "downwardapi-env-test" deleted
```



##### èŒƒä¾‹ï¼šå­˜å‚¨å·æ–¹å¼ä½¿ç”¨

```yaml
[root@master1 yaml] # vim storage-downwardapi-volume-test.yaml
apiVersion: v1
kind: Pod
metadata:
  name: downwardapi-volume-test
  labels:
    zone: Beijing
    rack: zhongguancun
    app: redis-master
  annotations:
    region: Asia-China
spec:
  volumes:
  - name: podinfo
    downwardAPI:
      defaultMode: 0420  # æ–‡ä»¶æƒé™ï¼Œé»˜è®¤0644
      items:
      - fieldRef:
          fieldPath: metadata.namespace
        path: pod_namespace
      - fieldRef:
          fieldPath: metadata.labels
        path: pod_labels
      - fieldRef:
          fieldPath: metadata.annotations
        path: pod_annotations
      - resourceFieldRef:
          containerName: downwardapi-volume-test
          resource: limits.cpu
        path: "cpu_limit"
      - resourceFieldRef:
          containerName: downwardapi-volume-test
          resource: requests.memory
          divisor: "1Mi"              # å°†èµ„æºå€¼è¿›è¡Œæ•´é™¤æ“ä½œï¼Œä»Žè€Œå°†èµ„æºå€¼è½¬æ¢ä¸ºä»¥æŒ‡å®šå•ä½ä¸ºåŸºå‡†çš„æ•´æ•°å€¼ã€‚
        path: "mem_request"
  containers:
  - name: downwardapi-volume-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    resources:
      requests:
        memory: "32Mi"
        cpu: "250m"
      limits:
        memory: "64Mi"
        cpu: "500m"
    volumeMounts:
    - name: podinfo
      mountPath: /etc/podinfo
      readOnly: false

# åº”ç”¨
[root@master1 yaml] # kubectl apply -f storage-downwardapi-volume-test.yaml 
pod/downwardapi-volume-test created

# æŸ¥çœ‹
[root@master1 yaml]#kubectl get pod
NAME                      READY   STATUS    RESTARTS   AGE
downwardapi-volume-test   1/1     Running   0          3s

# æŸ¥çœ‹å®¹å™¨å†…æŒ‚è½½çš„æ–‡ä»¶åŠå…¶å†…å®¹
[root@master1 yaml] # kubectl exec downwardapi-volume-test -- ls /etc/podinfo -l
total 0
lrwxrwxrwx    1 root     root            16 Jan  2 09:31 cpu_limit -> ..data/cpu_limit
lrwxrwxrwx    1 root     root            18 Jan  2 09:31 mem_request -> ..data/mem_request
lrwxrwxrwx    1 root     root            22 Jan  2 09:31 pod_annotations -> ..data/pod_annotations
lrwxrwxrwx    1 root     root            17 Jan  2 09:31 pod_labels -> ..data/pod_labels
lrwxrwxrwx    1 root     root            20 Jan  2 09:31 pod_namespace -> ..data/pod_namespace

[root@master1 yaml] # kubectl exec downwardapi-volume-test -- cat /etc/podinfo/pod_labels
app="redis-master"
rack="zhongguancun"
zone="Beijing"

# åˆ é™¤
[root@master1 yaml] # kubectl delete pod downwardapi-volume-test 
pod "downwardapi-volume-test" deleted
```





### Projected

#### Projectedè¯´æ˜Ž

ä¹‹å‰çš„CM,Secretç­‰å·èµ„æºåœ¨Podå†…çš„ä¸€ä¸ªç›®å½•åŒæ—¶åªèƒ½æŒ‚è½½ä¸€ä¸ªå·ï¼Œè€Œæˆ‘ä»¬æœ‰æ—¶å¸Œæœ›åœ¨ä¸€ä¸ªç›®å½•å†…ç”Ÿæˆ æ¥è‡ªå¤šä¸ªå·çš„å¤šä¸ªæ–‡ä»¶

**Projected volumes æ˜¯ä¸€ç§ç‰¹æ®Šçš„å·ç±»åž‹ï¼Œæ”¯æŒåŒæ—¶æŠ•å°„å¤šä¸ªå·è‡³åŒä¸€ä¸ªæŒ‚è½½ç‚¹**

Projected ä¸æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„API èµ„æºç±»åž‹ï¼Œä½†å…¶å¯ä»¥å¼•ç”¨çŽ°æœ‰çš„configmapã€secretèµ„æºå¯¹è±¡ï¼Œæˆ– downwardAPIä¸­çš„å…ƒæ•°æ®ä¿¡æ¯

æ­¤ç±»çš„å·ä¸€èˆ¬ç”¨äºŽä¸ºå®¹å™¨æä¾›é¢„å…ˆå®šä¹‰å¥½çš„æ•°æ®

![image-20250102174640664](D:\git_repository\cyber_security_learning\markdown_img\image-20250102174640664.png)



**Projected Volumeä»…æ”¯æŒå¯¹å¦‚ä¸‹å››ç§ç±»åž‹çš„å·ï¼ˆæ•°æ®æºï¼‰è¿›è¡ŒæŠ•å°„æ“ä½œ**

- **Secret**ï¼šæŠ•å°„Secretå¯¹è±¡
- **ConfigMap**ï¼šæŠ•å°„ConfgMapå¯¹è±¡
- **DownwardAPI**ï¼šæŠ•å°„Podå…ƒæ•°æ®
- **ServiceAccountToken**ï¼šæŠ•å°„ServiceAccountToken



#### Projectedæ¡ˆä¾‹

##### èŒƒä¾‹ï¼šExample configuration with a secret, a downwardAPI, and a configMap

```yaml
# èµ„æºæ¸…å•æ–‡ä»¶
[root@master1 yaml] # vim storage-projected-demo.yaml
apiVersion: v1
kind: Secret
metadata:
  name: mysecret
  namespace: default
data:
  username: d2FuZ3hpYW9jaHVu
type: Opaque
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: myconfigmap
  namespace: default
data:
  myconfig: Hello, Myconfig
---
apiVersion: v1
kind: Pod
metadata:
  name: projected-volume-demo
spec:
  containers:
  - name: container-test
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    volumeMounts:
    - name: all-in-one
      mountPath: "/projected-volume"
      readOnly: true
  volumes:
  - name: all-in-one
    projected:
      sources:
      - secret:
          name: mysecret
          items:
          - key: username
            path: my-group/my-username
      - downwardAPI:
          items:
          - path: "labels"
            fieldRef:
              fieldPath: metadata.labels
          - path: "cpu_limit"
            resourceFieldRef:
              containerName: container-test
              resource: limits.cpu
      - configMap:
          name: myconfigmap
          items:
          - key: myconfig
            path: my-group/my-config

# åº”ç”¨
[root@master1 yaml] # kubectl apply -f storage-projected-demo.yaml 
secret/mysecret unchanged
configmap/myconfigmap unchanged
pod/projected-volume-demo created

# æŸ¥çœ‹
[root@master1 yaml] # kubectl get pod
NAME                    READY   STATUS    RESTARTS   AGE
projected-volume-demo   1/1     Running   0          7s

# æŸ¥çœ‹æŒ‚è½½æ–‡ä»¶
[root@master1 yaml] # kubectl exec projected-volume-demo -- ls /projected-volume -l
total 0
lrwxrwxrwx    1 root     root            16 Jan  2 10:03 cpu_limit -> ..data/cpu_limit
lrwxrwxrwx    1 root     root            13 Jan  2 10:03 labels -> ..data/labels
lrwxrwxrwx    1 root     root            15 Jan  2 10:03 my-group -> ..data/my-group

[root@master1 yaml] # kubectl exec projected-volume-demo -- ls /projected-volume/my-group/  -l
total 8
-rw-r--r--    1 root     root            15 Jan  2 10:03 my-config
-rw-r--r--    1 root     root            12 Jan  2 10:03 my-username

```



### ç»¼åˆæ¡ˆä¾‹ï¼šä½¿ç”¨æŒä¹…å·éƒ¨ç½²WordPresså’ŒMySQL

åœ¨kuberneteséƒ¨ç½² wordpressï¼Œè¦æ»¡è¶³ä»¥ä¸‹è¦æ±‚ï¼š

- éƒ¨ç½²ä¸€ä¸ªç‹¬ç«‹çš„nginx Podå®žä¾‹ï¼Œä¸ºwordpressæä¾›åå‘ä»£ç†ï¼›åŒæ—¶æä¾›httpså’Œhttpè™šæ‹Ÿä¸»æœºï¼Œå…¶ä¸­å‘å¾€httpçš„è¯·æ±‚éƒ½é‡å®šå‘ç»™httpsï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- ç‹¬ç«‹éƒ¨ç½²ä¸¤ä¸ªwordpress Podå®žä¾‹ï¼Œå®ƒä»¬ä½¿ç”¨NFS StorageClass å­˜å‚¨å·å­˜å‚¨ç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡æˆ–æ–‡ ä»¶ç­‰æ•°æ®ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- éƒ¨ç½²ä¸€ä¸ªMySQLæ•°æ®åº“ï¼›ä»¥ConfigMapå’ŒSecretæä¾›å¿…è¦çš„é…ç½®
- service æš´éœ² nginxçš„æœåŠ¡ï¼Œç„¶åŽä»¥åå‘ä»£ç†çš„æ–¹å¼è¿›è¡Œè®¿é—®
- åŠ¨æ€çš„è“ç»¿å‘å¸ƒå’Œæ»šåŠ¨å‘å¸ƒ
  - å¯¹äºŽwordpress æ¥è¯´ï¼Œæ²¡æœ‰æœ¬è´¨çš„åŒºåˆ«
  - nginxçš„æ›´æ–°ï¼Œä¾èµ–configmapå’Œsecretçš„å†…å®¹



**ç®€å•ç‰ˆï¼šæ— nginxåå‘ä»£ç†**

```yaml
# æå‰å‡†å¤‡å¥½åŠ¨æ€ç½®å¤‡ç¨‹åºçš„Podï¼Œsa
# æå‰å‡†å¤‡åä¸ºsc-nfsçš„storageClass
[root@master1 yaml] # kubectl get sc
NAME     PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE
sc-nfs   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           false                  2d8h

[root@master1 nsf-provisioner] # kubectl get pod -n nfs-provisioner-demo 
NAME                                      READY   STATUS    RESTARTS   AGE
nfs-client-provisioner-649b64df96-tq8hq   1/1     Running   0          7m29s

[root@master1 nsf-provisioner] # kubectl get sa -n nfs-provisioner-demo 
NAME                     SECRETS   AGE
default                  0         8m27s
nfs-client-provisioner   0         8m27s

# æ¸…å•æ–‡ä»¶
[root@master1 yaml] # cat mysql-wordpress-persistent-volume.yaml 
apiVersion: v1
kind: Secret
metadata:
  name: mysql-pass
type: kubernetes.io/basic-auth
data:
  password: MTIzNDU2

---
apiVersion: v1
kind: Service
metadata:
  name: wordpress-mysql
  labels: 
    app: wordpress
spec:
  ports:
  - port: 3306
  selector:
    app: wordpress
    tier: mysql
  clusterIP: None

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
  labels:
    app: wordpress
spec:
  storageClassName: sc-nfs
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress-mysql
  labels:
    app: wordpress
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: mysql
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/mysql:8.0.29-oracle
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        - name: MYSQL_DATABASE
          value: wordpress
        - name: MYSQL_USER
          value: wordpress
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        ports:  # ports æœ¬èº«ä¸å¯¹å®¹å™¨çš„ç«¯å£ç›‘å¬äº§ç”Ÿå®žé™…ä½œç”¨ï¼Œåªæ˜¯ä¸€ä¸ªå£°æ˜Žã€‚ä½†æ˜¯ï¼Œå®ƒåœ¨ Kubernetes èµ„æºåä½œã€æ–‡æ¡£åŒ–ã€ä»¥åŠæŸäº›å·¥å…·ä¸­ï¼Œé—´æŽ¥å…·æœ‰é‡è¦æ„ä¹‰ã€‚
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pv-claim
---
apiVersion: v1
kind: Service
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  ports:
  - port: 80
  selector:
    app: wordpress
    tier: frontend
  type: LoadBalancer
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wp-pv-claim
  labels:
    app: wordpress
spec:
  storageClassName: sc-nfs
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: frontend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: frontend
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/wordpress:php8.2-apache
        name: wordpress
        env:
        - name: WORDPRESS_DB_HOST
          value: wordpress-mysql
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        - name: WORDPRESS_DB_USER
          value: wordpress
        ports:
        - containerPort: 80
          name: wordpress
        volumeMounts:
        - name: wordpress-persistent-storage
          mountPath: /var/www/html
      volumes:
      - name: wordpress-persistent-storage
        persistentVolumeClaim:
          claimName: wp-pv-claim

#åº”ç”¨
[root@master1 yaml] # kubectl apply -f mysql-wordpress-persistent-volume.yaml 
secret/mysql-pass created
service/wordpress-mysql created
persistentvolumeclaim/mysql-pv-claim created
deployment.apps/wordpress-mysql created
service/wordpress created
persistentvolumeclaim/wp-pv-claim created
deployment.apps/wordpress created

# æŸ¥çœ‹
[root@master1 yaml] # kubectl get svc
NAME              TYPE           CLUSTER-IP     EXTERNAL-IP   PORT(S)        AGE
kubernetes        ClusterIP      10.96.0.1      <none>        443/TCP        5d4h
wordpress         LoadBalancer   10.102.38.58   <pending>     80:31889/TCP   31s
wordpress-mysql   ClusterIP      None           <none>        3306/TCP       31s

# æµè§ˆå™¨è®¿é—®10.0.0.202:31889
```



![image-20250102204154945](D:\git_repository\cyber_security_learning\markdown_img\image-20250102204154945.png)





**è¿›é˜¶ï¼šå®Œå…¨æŒ‰è¦æ±‚é…ç½®**

![image-20250103172728642](D:\git_repository\cyber_security_learning\markdown_img\image-20250103172728642.png)



```yaml
# ç›®å½•ç»“æž„
[root@master1 lnmp] # ls
mysql  nginx  nginx.conf.d  plugin  wordpress

[root@master1 lnmp] # tree .
.
â”œâ”€â”€ mysql
â”‚Â Â  â”œâ”€â”€ lnmp-mysql.yaml
â”‚Â Â  â””â”€â”€ service-mysql.yaml
â”œâ”€â”€ nginx
â”‚Â Â  â”œâ”€â”€ lnmp-nginx-deloyment.yaml
â”‚Â Â  â”œâ”€â”€ service-nginx.yaml
â”‚Â Â  â””â”€â”€ tls
â”‚Â Â      â”œâ”€â”€ mystical.org.crt
â”‚Â Â      â””â”€â”€ mystical.org.key
â”œâ”€â”€ nginx.conf.d
â”‚Â Â  â””â”€â”€ wordpress.mystical.org.conf
â”œâ”€â”€ plugin
â”‚Â Â  â”œâ”€â”€ metalLB
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ metallb-native.yaml
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ service-metallb-IPAddressPool.yaml
â”‚Â Â  â”‚Â Â  â””â”€â”€ service-metallb-L2Advertisement.yaml
â”‚Â Â  â””â”€â”€ nfc-sc
â”‚Â Â      â”œâ”€â”€ nfs-client-provisioner.yaml
â”‚Â Â      â”œâ”€â”€ nfs-storageClass.yaml
â”‚Â Â      â””â”€â”€ rbac.yaml
â””â”€â”€ wordpress
    â”œâ”€â”€ lnmp-wordpress.yaml
    â”œâ”€â”€ service-wordpress-loadbalancer.yaml
    â””â”€â”€ service-wordpress.yaml


# æ’ä»¶æ¸…å• -- MetalLB
[root@master1 lnmp] # METALLB_VERSION='v0.14.7'
[root@master1 lnmp] # wget https://raw.githubusercontent.com/metallb/metallb/${METALLB_VERSION}/config/manifests/metallb-native.yaml

# åº”ç”¨
[root@master1 metalLB]# kubectl apply -f metallb-native.yaml 
namespace/metallb-system created
customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io created
customresourcedefinition.apiextensions.k8s.io/communities.metallb.io created
customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io created
customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io created
serviceaccount/controller created
serviceaccount/speaker created
role.rbac.authorization.k8s.io/controller created
role.rbac.authorization.k8s.io/pod-lister created
clusterrole.rbac.authorization.k8s.io/metallb-system:controller created
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created
rolebinding.rbac.authorization.k8s.io/controller created
rolebinding.rbac.authorization.k8s.io/pod-lister created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created
configmap/metallb-excludel2 created
secret/metallb-webhook-cert created
service/metallb-webhook-service created
deployment.apps/controller created
daemonset.apps/speaker created
validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration created

# åˆ›å»ºåœ°å€æ± 
# æ³¨æ„: IPAddressPool å¿…é¡»ä½¿ç”¨Kuberetesé›†ç¾¤èŠ‚ç‚¹çš„IPåœ°å€æ®µ
[root@master1 metalLB]#vim service-metallb-IPAddressPool.yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: localip-pool
  namespace: metallb-system
spec:
  addresses:
  - 10.0.0.10-10.0.0.50
  autoAssign: true
  avoidBuggyIPs: true
  
# åº”ç”¨
[root@master1 metalLB]#kubectl apply -f service-metallb-IPAddressPool.yaml
ipaddresspool.metallb.io/localip-pool created

# åˆ›å»ºäºŒå±‚å…¬å‘Šæœºåˆ¶
[root@master1 metalLB]#vim service-metallb-L2Advertisement.yaml
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: localip-pool-l2a
  namespace: metallb-system
spec:
  ipAddressPools:
  - localip-pool
  interfaces:
  - eth0 # ç”¨äºŽå‘é€å…è´¹ARPå…¬å‘Š

# åº”ç”¨
[root@master1 metalLB] # kubectl apply -f service-metallb-L2Advertisement.yaml 
l2advertisement.metallb.io/localip-pool-l2a created

####################################################################################################

# å­˜å‚¨åˆ¶å¤‡å™¨
[root@master1 nfc-sc]#cat rbac.yaml 
apiVersion: v1
kind: Namespace
metadata:
  name: nfs-provisioner-demo
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: nfs-client-provisioner
  # replace with namespace where provisioner is deployed æ ¹æ®ä¸šåŠ¡éœ€è¦ä¿®æ”¹æ­¤å¤„åç§°ç©ºé—´
  namespace: nfs-provisioner-demo
  
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: nfs-client-provisioner-runner
rules:
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["persistentvolumes"]
    verbs: ["get", "list", "watch", "create", "delete"]
  - apiGroups: [""]
    resources: ["persistentvolumeclaims"]
    verbs: ["get", "list", "watch", "update"]
  - apiGroups: ["storage.k8s.io"]
    resources: ["storageclasses"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["create", "update", "patch"]
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "delete"]
    
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: run-nfs-client-provisioner
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: nfs-provisioner-demo
roleRef:
  kind: ClusterRole
  name: nfs-client-provisioner-runner
  apiGroup: rbac.authorization.k8s.io
  
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs-provisioner-demo
rules:
  - apiGroups: [""]
    resources: ["endpoints"]
    verbs: ["get", "list", "watch", "create", "update", "patch"]
    
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: leader-locking-nfs-client-provisioner
  # replace with namespace where provisioner is deployed
  namespace: nfs-provisioner-demo
subjects:
  - kind: ServiceAccount
    name: nfs-client-provisioner
    # replace with namespace where provisioner is deployed
    namespace: nfs-provisioner-demo
roleRef:
  kind: Role
  name: leader-locking-nfs-client-provisioner
  apiGroup: rbac.authorization.k8s.io
  
# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f rbac.yaml

[root@master1 nfc-sc] # cat nfs-client-provisioner.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nfs-client-provisioner
  labels:
    app: nfs-client-provisioner
  namespace: nfs-provisioner-demo
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: nfs-client-provisioner
  template:
    metadata:
      labels:
        app: nfs-client-provisioner
    spec:
      serviceAccountName: nfs-client-provisioner
      containers:
      - name: nfs-client-provisioner     
        image: k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2 #æ­¤é•œåƒå›½å†…å¯èƒ½æ— æ³•è®¿é—®
        imagePullPolicy: IfNotPresent
        volumeMounts:
        - name: nfs-client-root
          mountPath: /persistentvolumes
        env:
        - name: PROVISIONER_NAME
          value: k8s-sigs.io/nfs-subdir-external-provisioner # åç§°ç¡®ä¿ä¸Žnfs-StorageClass.yamlæ–‡ä»¶ä¸­çš„provisioneråç§°ä¿æŒä¸€è‡´
        - name: NFS_SERVER
          value: nfs.mystical.org
        - name: NFS_PATH
          value: /nfs-data/sc-nfs
      volumes:
      - name: nfs-client-root
        nfs:
          server: nfs.mystical.org
          path: /nfs-data/sc-nfs

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f nfs-client-provisioner.yaml

[root@master1 nfc-sc] # cat nfs-storageClass.yaml 
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: sc-nfs
  annotations:
    storageclass.kubernetes.io/is-default-class: "false" # æ˜¯å¦è®¾ç½®ä¸ºé»˜è®¤çš„storageClass
provisioner: k8s-sigs.io/nfs-subdir-external-provisioner # or choose another name, must match deployment's env PROVISIONER_NAME
parameters:
  archiveOnDelete: "true"

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f nfs-storageClass.yaml 

####################################################################################################

# MySQLæ¸…å•èµ„æº
[root@master1 lnmp] # cat mysql/lnmp-mysql.yaml 
apiVersion: v1
kind: Secret
metadata:
  name: mysql-pass
type: kubernetes.io/basic-auth
data:
  password: MTIzNDU2

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pv-claim
  labels:
    app: wordpress
spec:
  storageClassName: sc-nfs
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress-mysql
  labels:
    app: wordpress
spec:
  selector:
    matchLabels:
      app: wordpress
      tier: mysql
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: mysql
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/mysql:8.0.29-oracle
        name: mysql
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        - name: MYSQL_DATABASE
          value: wordpress
        - name: MYSQL_USER
          value: wordpress
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        ports:
        - containerPort: 3306
          name: mysql
        volumeMounts:
        - name: mysql-persistent-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-persistent-storage
        persistentVolumeClaim:
          claimName: mysql-pv-claim

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f mysql/lnmp-mysql.yaml

[root@master1 lnmp] # cat mysql/service-mysql.yaml 
apiVersion: v1
kind: Service
metadata:
  name: wordpress-mysql
  labels:
    app: wordpress
spec:
  ports:
  - port: 3306
  selector:
    app: wordpress
    tier: mysql
  clusterIP: None

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f mysql/service-mysql.yaml 

######################################################################################################

# wordpressèµ„æºæ¸…å•
[root@master1 lnmp] # cat wordpress/lnmp-wordpress.yaml 
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: wp-pv-claim
  labels:
    app: wordpress
spec:
  storageClassName: sc-nfs
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  replicas: 2
  selector:
    matchLabels:
      app: wordpress
      tier: frontend
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: frontend
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/wordpress:php8.2-apache
        name: wordpress
        env:
        - name: WORDPRESS_DB_HOST
          value: wordpress-mysql
        - name: WORDPRESS_DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-pass
              key: password
        - name: WORDPRESS_DB_USER
          value: wordpress
        ports:
        - containerPort: 80
          name: wordpress
        volumeMounts:
        - name: wordpress-persistent-storage
          mountPath: /var/www/html
      volumes:
      - name: wordpress-persistent-storage
        persistentVolumeClaim:
          claimName: wp-pv-claim
          
# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f wordpress/lnmp-wordpress.yaml

[root@master1 lnmp] # cat wordpress/service-wordpress.yaml 
apiVersion: v1
kind: Service
metadata:
  name: wordpress
  labels:
    app: wordpress
spec:
  ports:
  - port: 80
  selector:
    app: wordpress
    tier: frontend
  clusterIP: None

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f wordpress/service-wordpress.yaml
#########################################################################################################

# nginxèµ„æºæ¸…å•
# nginxé…ç½®æ–‡ä»¶
[root@master1 lnmp] # cat nginx.conf.d/wordpress.mystical.org.conf 
server {
    listen 80;
    server_name wordpress.mystical.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl;
    server_name www.mystical.org;
    
    ssl_certificate /etc/nginx/certs/tls.crt; 
    ssl_certificate_key /etc/nginx/certs/tls.key;
    ssl_session_timeout 5m;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; 
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE; 
    ssl_prefer_server_ciphers on;
    include /etc/nginx/conf.d/myserver-*.cfg;

    location / {
        proxy_pass http://wordpress;                       # wordpressçš„svcåç§°
        proxy_set_header Host $host;                       # å¿…é¡»å†™ï¼Œå°†ç”¨æˆ·çš„hostsä¼ ç»™wordpress
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}


# ç”Ÿæˆcm
[root@master1 lnmp] #kubectl create cm cm-nginx-conf --from-file=./wordpress.mystical.org.conf

# nginxçš„deployment
[root@master1 lnmp] # cat nginx/lnmp-nginx-deloyment.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: lnmp-nginx-deploy
  labels:
    app: wordpress
spec:
  replicas: 2
  selector:
    matchLabels:
      app: wordpress
      tier: nginx
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: wordpress
        tier: nginx
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
        name: nginx
        env:
        - name: UPSTREAM_URL
          value: "http://wordpress"
        volumeMounts:
        - name: nginx-config-volume
          mountPath: /etc/nginx/conf.d
        - name: nginx-certs
          mountPath: /etc/nginx/certs/
      volumes:
      - name: nginx-config-volume
        configMap:
          name: cm-nginx-conf
      - name: nginx-certs
        secret:
          secretName: secret-nginx-ssl

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f nginx/lnmp-nginx-deloyment.yaml 

# nginxå¯¹å¤–çš„Service
[root@master1 lnmp] # cat nginx/service-nginx.yaml 
apiVersion: v1
kind: Service
metadata:
  name: server-nodeport-nginx
spec:
  type: LoadBalancer
  selector:
    app: wordpress
    tier: nginx
  ports:                         # æ³¨æ„æš´éœ²ä¸¤ä¸ªç«¯å£
  - name: https
    protocol: TCP
    port: 443  
    targetPort: 443
  - name: http
    protocol: TCP
    port: 80
    targetPort: 80

# åº”ç”¨
[root@master1 nfc-sc] # kubectl apply -f nginx/service-nginx.yaml
```







## Kubernetesæµé‡è°ƒåº¦-Ingress



**æœ¬ç« å†…å®¹**

- **IngressåŽŸç†**
- **Ingress-nginxå®‰è£…å’Œé…ç½®**
- **Ingress-nginxå®žçŽ°**
- **Ingress-nginx å®žçŽ°è“ç»¿å’Œç°åº¦å‘å¸ƒ**





### IngressåŽŸç†

Ingressæœ¬è´¨å°±æ˜¯**ä¸ƒå±‚ä»£ç†**, æ‰€ä»¥å¯ä»¥åŸºäºŽhttp/httpsçš„æ–¹å¼ï¼Œå°†é›†ç¾¤å¤–éƒ¨çš„æµé‡ç»Ÿä¸€çš„å¼•å…¥åˆ°é›†ç¾¤å†…éƒ¨

é€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„æµé‡å…¥å£ï¼Œé¿å…å°†é›†ç¾¤å†…éƒ¨å¤§é‡çš„ç«¯å£ç›´æŽ¥æš´éœ²ç»™å¤–éƒ¨

Ingress å¯ä¸º Service æä¾›å¤–éƒ¨å¯è®¿é—®çš„ URLã€è´Ÿè½½å‡è¡¡æµé‡ã€ç»ˆæ­¢ SSL/TLSï¼Œä»¥åŠåŸºäºŽåç§°çš„è™šæ‹Ÿæ‰˜ç®¡ã€‚ Ingress æŽ§åˆ¶å™¨ é€šå¸¸è´Ÿè´£é€šè¿‡è´Ÿè½½å‡è¡¡å™¨æ¥å®žçŽ° Ingressï¼Œå°½ç®¡å®ƒä¹Ÿå¯ä»¥é…ç½®è¾¹ç¼˜è·¯ç”±å™¨æˆ–å…¶ä»–å‰ ç«¯æ¥å¸®åŠ©å¤„ç†æµé‡ã€‚

Ingress ä¸ä¼šå…¬å¼€ä»»æ„ç«¯å£æˆ–åè®®ã€‚ å°† HTTP å’Œ HTTPS ä»¥å¤–çš„æœåŠ¡å…¬å¼€åˆ° Internet æ—¶ï¼Œé€šå¸¸ä½¿ç”¨ Service.Type=NodePort æˆ– Service.Type=LoadBalancer ç±»åž‹çš„ Serviceã€‚

Ingressè¿™ç§åˆ©ç”¨åº”ç”¨å±‚åè®®æ¥è¿›è¡Œæµé‡çš„è´Ÿè½½å‡è¡¡æ•ˆæžœï¼Œå®ƒå¯ä»¥å®žçŽ°è®©ç”¨æˆ·é€šè¿‡åŸŸåæ¥è®¿é—®ç›¸åº”çš„ serviceå°±å¯ä»¥äº†ï¼Œæ— éœ€å…³å¿ƒNode IPåŠPortæ˜¯ä»€ä¹ˆï¼Œé¿å…äº†ä¿¡æ¯çš„æ³„éœ²ã€‚



**ingress ä¸»è¦åŒ…å«ä¸¤ä¸ªç»„ä»¶Ingress APIå’ŒIngress Controller**

ingress å…¶å…·å¤‡äº†åŠ¨æ€æ›´æ–°å¹¶åŠ è½½æ–°é…ç½®çš„ç‰¹æ€§ã€‚è€Œä¸”ingressæœ¬èº«æ˜¯ä¸å…·å¤‡å®žçŽ°é›†ç¾¤å†…å¤–æµé‡é€šä¿¡çš„åŠŸèƒ½çš„ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯é€šè¿‡ controlleræ¥å®žçŽ°çš„ã€‚**Ingress Controlleræœ¬èº«æ˜¯è¿è¡ŒäºŽé›†ç¾¤ä¸­çš„Podèµ„æºå¯¹è±¡**

| ç»„ä»¶               | è§£æž                                                         |
| ------------------ | ------------------------------------------------------------ |
| Ingress API        | Kubernetesä¸Šçš„æ ‡å‡†APIèµ„æºç±»åž‹ä¹‹ä¸€ ä»…å®šä¹‰äº†æŠ½è±¡è·¯ç”±é…ç½®ä¿¡æ¯ï¼Œåªæ˜¯å…ƒæ•°æ®ï¼Œéœ€è¦ç”±ç›¸åº”çš„æŽ§åˆ¶å™¨åŠ¨æ€åŠ è½½ å°†ä»£ç†é…ç½®æŠ½è±¡æˆä¸€ä¸ªIngresså¯¹è±¡ï¼Œæ¯ä¸ªæœåŠ¡å¯¹åº”ä¸€ä¸ªyamlé…ç½®æ–‡ä»¶ è´Ÿè´£ä»¥k8sæ ‡å‡†çš„èµ„æºæ ¼å¼å®šä¹‰æµé‡è°ƒåº¦ã€è·¯ç”±ç­‰è§„åˆ™ å±žäºŽåç§°ç©ºé—´çº§èµ„æº,å®Œæˆå°†åŒä¸€ä¸ªåç©ºé—´çš„serviceèµ„æºè¿›è¡Œæš´éœ² |
| Ingress Controller | ä¸ƒå±‚åå‘ä»£ç†æœåŠ¡ç¨‹åº éœ€è¦ç›‘è§†ï¼ˆwatchï¼‰API Serverä¸Š Ingressèµ„æºçš„å˜åŠ¨ï¼Œå¹¶ç”Ÿæˆå…·ä½“åº”ç”¨çš„è‡ªèº«çš„é… ç½®æ–‡ä»¶æ ¼å¼ï¼Œå³å°†æ–°åŠ å…¥çš„Ingressè½¬åŒ–æˆåå‘ä»£ç†çš„é…ç½®æ–‡ä»¶å¹¶åŠ¨æ€åŠ è½½ä½¿ä¹‹ç”Ÿæ•ˆï¼Œæœ€ç»ˆå¹¶æ®æ­¤å®Œæˆæµé‡è½¬å‘ <br />Ingress Controlleréžä¸ºå†…ç½®çš„æŽ§åˆ¶å™¨ï¼Œéœ€è¦é¢å¤–è‡ªè¡Œéƒ¨ç½² <br />é€šå¸¸ä»¥Podå½¢å¼è¿è¡ŒäºŽKubernetesé›†ç¾¤ä¹‹ä¸Š ä¸€èˆ¬åº”è¯¥ç”±ä¸“ç”¨çš„LB Serviceè´Ÿè´£ä¸ºå…¶æŽ¥å…¥é›†ç¾¤å¤–éƒ¨æµé‡ |



**å› ä¸ºingress Controlleræ˜¯ä»¥podçš„æ–¹å¼éƒ¨ç½²çš„,æ‰€ä»¥éœ€è¦è§£å†³å¦‚ä¸‹é—®é¢˜**

- ingressçš„podå¦‚ä½•å¼•å…¥å¤–éƒ¨æµé‡
  - é€šè¿‡ä¸€ä¸ªä¸“ç”¨çš„service å³å¯å®žçŽ°
- å¦‚ä½•å®žçŽ°ingressçš„Podçš„æµé‡è´Ÿè½½å‡è¡¡
  - å…³äºŽpodè´Ÿè½½å‡è¡¡çš„æµé‡ï¼Œç›´æŽ¥é€šè¿‡deployment/daemonsetç­‰controllerè½¬å‘ç»™åŽç«¯podå³å¯ã€‚
- åŽç«¯åº”ç”¨çš„ Pod å¾ˆå¤šï¼Œå¦‚ä½•æ‰¾åˆ°è¦è½¬å‘çš„ç›®æ ‡ï¼Ÿ
  - é€šè¿‡k8sçš„serviceå¯¹æ‰€æœ‰çš„podè¿›è¡Œåˆ†ç»„ç®¡ç†ï¼Œå†ç”¨controllerå†…éƒ¨çš„è´Ÿè½½å‡è¡¡é…ç½®ï¼Œæ‰¾åˆ°å¯¹åº”çš„ç›®æ ‡ã€‚
  - å³åŽç«¯åº”ç”¨çš„Podå¯¹åº”çš„service åªæ˜¯èµ·åˆ°æœåŠ¡å‘çŽ°Podçš„åŠŸèƒ½ï¼Œè€Œä»Žå¤–éƒ¨è®¿é—®åº”ç”¨çš„Podçš„æµé‡è½¬å‘è¿‡ç¨‹ä¸­ä¸éœ€è¦å†ç»è¿‡æ­¤service 



#### Ingress è®¿é—®è¿‡ç¨‹

- ä»Žå¤–éƒ¨æµé‡è°ƒåº¦åˆ°kubernetesä¸­Ingress serviceï¼Œæœ‰å¤šç§å®žçŽ°æ–¹æ¡ˆï¼Œæ¯”å¦‚ä½¿ç”¨èŠ‚ç‚¹ç½‘ç»œä¸­çš„ EXTERNAL-IPæˆ–è€…NodePortæ–¹å¼
- ä»Žserviceè°ƒåº¦åˆ°ingress-controller
- ingress-controlleræ ¹æ®ingress Pod ä¸­çš„å®šä¹‰ï¼Œæ¯”å¦‚è™šæ‹Ÿä¸»æœºæˆ–è€…åŽç«¯çš„url
- æ ¹æ®è™šæ‹Ÿä¸»æœºåç›´æŽ¥è°ƒåº¦åˆ°åŽç«¯çš„ä¸€ç»„åº”ç”¨podä¸­



![image-20250104101257362](D:\git_repository\cyber_security_learning\markdown_img\image-20250104101257362.png)

æ³¨æ„ï¼š

- æ•´ä¸ªæµç¨‹ä¸­æ¶‰åŠåˆ°äº†ä¸¤å¤„serviceå†…å®¹
- service ingress-nginx æ˜¯å¸®åŠ© ingress controller Pod æŽ¥å…¥å¤–éƒ¨æµé‡çš„
- **åŽç«¯çš„æœåŠ¡å¯¹åº”çš„service**åªèµ·åˆ°å¸®åŠ© ingress controller Pod æ‰¾åˆ°å…·ä½“çš„æœåŠ¡çš„Podï¼Œå³**åªç”¨äºŽæœåŠ¡å‘çŽ°** ï¼Œè€Œ**æµé‡ä¸éœ€è¦ç»è¿‡åŽç«¯æœåŠ¡çš„Service**ï¼Œç›´æŽ¥ä»Žingress controller Podè½¬åˆ°è‡³å…·ä½“çš„Pod
- è™šçº¿è¡¨ç¤ºserviceå¯¹åŽç«¯çš„åº”ç”¨è¿›è¡Œåˆ†ç»„ï¼Œå®žçº¿è¡¨ç¤ºingresså®žé™…çš„è®¿é—®æµå‘







###  Ingress controller å¸¸è§çš„è§£å†³æ–¹æ¡ˆ

å¯¹äºŽIngress controllerçš„è½¯ä»¶å®žçŽ°ï¼Œå…¶å®žæ²¡æœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œåªè¦èƒ½å¤Ÿå®žçŽ°ä¸ƒå±‚çš„è´Ÿè½½å‡è¡¡åŠŸèƒ½æ•ˆæžœå³å¯

Ingress controller æ”¯æŒç”±ä»»ä½•å…·æœ‰åå‘ä»£ç†åŠŸèƒ½çš„ç¨‹åºå®žçŽ°ï¼Œå¦‚Nginxã€Traefikã€Envoyã€HAProxyã€ Vulcandç­‰

Kubernetesæ”¯æŒåŒæ—¶éƒ¨ç½²äºŒä¸ªæˆ–ä»¥ä¸Šçš„æ•°é‡çš„Ingress Controller

**Ingressèµ„æºé…ç½®æŒ‡å®šIngress Controllerç±»åž‹çš„æ–¹æ³•**

- ä¸“ç”¨çš„**annotation**ï¼škubernetes.io/ingress.classï¼Œè€ç‰ˆæœ¬ç”¨æ³•
- Ingressèµ„æºçš„specçš„ä¸“æœ‰å­—æ®µï¼š**ingressClassName**ï¼Œå¼•ç”¨çš„IngressClassæ˜¯ä¸€ç§ç‰¹å®šçš„èµ„æºç±» åž‹ï¼Œæ­¤æ–¹å¼v1.18ç‰ˆæœ¬èµ·ä½¿ç”¨ï¼Œæ–°ç‰ˆæœ¬æŽ¨è





### Ingress-nginx Controller å®‰è£…å’Œé…ç½®

![image-20250104103640034](D:\git_repository\cyber_security_learning\markdown_img\image-20250104103640034.png)

#### åŸºäºŽYAMLéƒ¨ç½²

åŸºäºŽkubectl apply éƒ¨ç½²

```bash
#èŽ·å–é…ç½®æ–‡ä»¶,å¯èƒ½éœ€è¦ç§‘å­¦ä¸Šç½‘æ‰èƒ½ä¸‹è½½
https://kubernetes.github.io/ingress-nginx/deploy/

# æ–°ç‰ˆ
[root@master1 ~]#wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.11.1/deploy/static/provider/cloud/deploy.yaml

[root@master1 ~]#wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.2/deploy/static/provider/cloud/deploy.yaml

[root@master1 ~]#wget https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.0/deploy/static/provider/cloud/deploy.yaml

# æŸ¥çœ‹èµ„æº
[root@master1 ~]#cat deploy-v1.11.1.yaml |grep "^kind"
kind: Namespace
kind: ServiceAccount
kind: ServiceAccount
kind: Role
kind: Role
kind: ClusterRole
kind: ClusterRole
kind: RoleBinding
kind: RoleBinding
kind: ClusterRoleBinding
kind: ClusterRoleBinding
kind: ConfigMap
kind: Service
kind: Service
kind: Deployment
kind: Job
kind: Job
kind: IngressClass
kind: ValidatingWebhookConfiguration

# ç¼–è¾‘deploy-v1.11.1.yaml
# 1ï¼‰é»˜è®¤é•œåƒå¯èƒ½éœ€è¦ç¿»å¢™ï¼Œéœ€è¦ä¿®æ”¹åŸºç¡€é•œåƒï¼ˆå…±æ”¹3å¤„ï¼Œå…¶ä¸­2å¤„ç›¸åŒï¼‰
[root@master1 ~]#vim deploy.yaml
        # image: registry.k8s.io/ingress-nginx/controller:v1.11.1@sha256:e6439a12b52076965928e83b7b56aae6731231677b01e81818bce7fa5c60161a
          image: registry.cn-hangzhou.aliyuncs.com/google_containers/nginx-ingress-controller:v1.11.1
        # image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.4.1@sha256:36d05b4077fb8e3d13663702fa337f124675ba8667cbd949c03a8e8ea6fa4366  
          image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v20230407
        # image: registry.k8s.io/ingress-nginx/kube-webhook-certgen:v1.4.1@sha256:36d05b4077fb8e3d13663702fa337f124675ba8667cbd949c03a8e8ea6fa4366  
          image: registry.cn-hangzhou.aliyuncs.com/google_containers/kube-webhook-certgen:v20230407
          
#2ï¼‰å¼€æ”¾å¤–éƒ¨è®¿é—®å…¥å£åœ°å€
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/part-of: ingress-nginx
    app.kubernetes.io/version: 1.11.1
  name: ingress-nginx-controller
  namespace: ingress-nginx
  annotations:                       # æ·»åŠ å¦‚ä¸‹ä¸‰è¡Œï¼Œç”¨äºŽæ”¯æŒPrometheusç›‘æŽ§ï¼Œå¯é€‰
    prometheus.io/scrape: "true"
    prometheus.io/port: "10254"
spec:
  externalTrafficPolicy: Local
  ipFamilies:
  - IPv4
  ipFamilyPolicy: SingleStack
  ports:
  - appProtocol: http
    name: http
    port: 80
    protocol: TCP
    targetPort: http
  - appProtocol: https
    name: https
    port: 443
    protocol: TCP
    targetPort: https
  selector:
    app.kubernetes.io/component: controller
    app.kubernetes.io/instance: ingress-nginx
    app.kubernetes.io/name: ingress-nginx
  type: LoadBalancer             # è¿™é‡Œä½¿ç”¨LoadBalancerï¼Œå› æ­¤éœ€è¦éƒ¨ç½²MetalLB
  
#3ï¼‰é»˜è®¤ingress-nginx-controlleråªæœ‰ä¸€ä¸ªPodå‰¯æœ¬çš„,
#æ–¹æ³•1: æŒ‡å®š2ä¸ªå‰¯æœ¬å®žçŽ°é«˜å¯ç”¨ï¼ˆæ­¤æ­¥å¯é€‰ï¼‰
  name: ingress-nginx-controller
  namespace: ingress-nginx
spec:
  replicas: 2  # æ·»åŠ å‰¯æœ¬æ•°
  
# é…ç½®MetalLB
[root@master1 metalLB]#kubectl apply -f metallb-native.yaml 
namespace/metallb-system created
customresourcedefinition.apiextensions.k8s.io/bfdprofiles.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgpadvertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/bgppeers.metallb.io created
customresourcedefinition.apiextensions.k8s.io/communities.metallb.io created
customresourcedefinition.apiextensions.k8s.io/ipaddresspools.metallb.io created
customresourcedefinition.apiextensions.k8s.io/l2advertisements.metallb.io created
customresourcedefinition.apiextensions.k8s.io/servicel2statuses.metallb.io created
serviceaccount/controller created
serviceaccount/speaker created
role.rbac.authorization.k8s.io/controller created
role.rbac.authorization.k8s.io/pod-lister created
clusterrole.rbac.authorization.k8s.io/metallb-system:controller created
clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created
rolebinding.rbac.authorization.k8s.io/controller created
rolebinding.rbac.authorization.k8s.io/pod-lister created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created
clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created
configmap/metallb-excludel2 created
secret/metallb-webhook-cert created
service/metallb-webhook-service created
deployment.apps/controller created
daemonset.apps/speaker created
validatingwebhookconfiguration.admissionregistration.k8s.io/metallb-webhook-configuration created

[root@master1 metalLB]#kubectl apply -f service-metallb-IPAddressPool.yaml 
ipaddresspool.metallb.io/localip-pool created

[root@master1 metalLB]#kubectl apply -f service-metallb-L2Advertisement.yaml 
l2advertisement.metallb.io/localip-pool-l2a created

# åº”ç”¨Ingress-nginxèµ„æºé…ç½®æ–‡ä»¶
[root@master1 ~]#kubectl apply -f deploy-v1.11.1.yaml 
namespace/ingress-nginx created
serviceaccount/ingress-nginx created
serviceaccount/ingress-nginx-admission created
role.rbac.authorization.k8s.io/ingress-nginx created
role.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrole.rbac.authorization.k8s.io/ingress-nginx created
clusterrole.rbac.authorization.k8s.io/ingress-nginx-admission created
rolebinding.rbac.authorization.k8s.io/ingress-nginx created
rolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx created
clusterrolebinding.rbac.authorization.k8s.io/ingress-nginx-admission created
configmap/ingress-nginx-controller created
service/ingress-nginx-controller created
service/ingress-nginx-controller-admission created
deployment.apps/ingress-nginx-controller created
job.batch/ingress-nginx-admission-create created
job.batch/ingress-nginx-admission-patch created
ingressclass.networking.k8s.io/nginx created
validatingwebhookconfiguration.admissionregistration.k8s.io/ingress-nginx-admission created

# æŸ¥çœ‹
[root@master1 ~]# kubectl get all -n ingress-nginx 
NAME                                        READY   STATUS      RESTARTS   AGE
pod/ingress-nginx-admission-create-lx764    0/1     Completed   0          91s
pod/ingress-nginx-admission-patch-vqttt     0/1     Completed   1          91s
pod/ingress-nginx-controller-666487-9cvb7   1/1     Running     0          91s
pod/ingress-nginx-controller-666487-z24f8   1/1     Running     0          91s

NAME                                         TYPE           CLUSTER-IP       EXTERNAL-IP   PORT(S)                      AGE
service/ingress-nginx-controller             LoadBalancer   10.100.252.99    10.0.0.10     80:30529/TCP,443:31050/TCP   91s
service/ingress-nginx-controller-admission   ClusterIP      10.110.228.129   <none>        443/TCP                      91s

NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/ingress-nginx-controller   2/2     2            2           91s

NAME                                              DESIRED   CURRENT   READY   AGE
replicaset.apps/ingress-nginx-controller-666487   2         2         2       91s

NAME                                       STATUS     COMPLETIONS   DURATION   AGE
job.batch/ingress-nginx-admission-create   Complete   1/1           20s        91s
job.batch/ingress-nginx-admission-patch    Complete   1/1           22s        91s

```



### Ingresså‘½ä»¤å¼å®žçŽ°

#### å‘½ä»¤å¼å®žçŽ°è¯´æ˜Ž

```bash
# ç±»æ¯”nginxåå‘ä»£ç†é…ç½®æ–‡ä»¶
http {
    upstream service_name {
        server xxxx: port
        server xxxx: port
    }
    server {
        listen 80;
        server_name domain;
        location /url {
            proxy_pass http://upstream_name;
        }
    }
}

# åˆ›å»ºIngresså‘½ä»¤
kubectl create ingress NAME --rule=domain/url=service:port[, tls[=secret]] [option]

# å¸¸ç”¨option
--annotation=[]  # æ³¨è§£ä¿¡æ¯ï¼šæ ¼å¼"annotation=value"
--rule=[]        # ä»£ç†è§„åˆ™ï¼Œæ ¼å¼"host/path=service:port[,tls=secretname]",,æ³¨æ„:ruleä¸­å¤–éƒ¨åŸŸåè¦åœ¨æ‰€æœ‰çš„åç§°ç©ºé—´å”¯ä¸€
--class=''       # æ­¤Ingressé€‚é…çš„Ingress Class Controller

# åŸºäºŽURIæ–¹å¼ä»£ç†ä¸åŒåº”ç”¨çš„è¯·æ±‚æ—¶ï¼ŒåŽç«¯åº”ç”¨çš„URIè‹¥ä¸Žä»£ç†æ—¶ä½¿ç”¨çš„URIä¸åŒï¼Œåˆ™éœ€è¦å¯ç”¨URL Rewriteå®ŒæˆURIçš„é‡å†™
# Ingress-Nginxæ”¯æŒä½¿ç”¨â€œannotation nginx.ingress.kubernetes.io/rewrite-targetâ€æ³¨è§£è¿›è¡Œ
```



#### å‘½ä»¤å¼å®žçŽ°æ¡ˆä¾‹

**å‡†å¤‡çŽ¯å¢ƒå®žçŽ°ä¸¤ä¸ªserviceåº”ç”¨ pod-test1å’Œpod-test2**

```bash
# å‡†å¤‡åŽç«¯çš„åº”ç”¨pod-test v0.1å’Œç›¸åº”çš„service
[root@master1 ~]# kubectl create deployment pod-test1 --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
deployment.apps/pod-test1 created

[root@master1 ~]# kubectl create service clusterip pod-test1 --tcp=80:80
service/pod-test1 created

# å‡†å¤‡åŽç«¯çš„åº”ç”¨pod-test v0.2å’Œç›¸åº”çš„service
[root@master1 ~]# kubectl create deployment pod-test2 --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2 --replicas=3
deployment.apps/pod-test2 created

[root@master1 ~]#kubectl create service clusterip pod-test2 --tcp=80:80
service/pod-test2 created

[root@master1 ~]#kubectl get ep
NAME         ENDPOINTS                                         AGE
kubernetes   10.0.0.201:6443                                   4h47m
pod-test1    10.244.1.159:80,10.244.2.107:80,10.244.3.173:80   3m10s
pod-test2    10.244.1.160:80,10.244.2.108:80,10.244.3.174:80   13s
```



##### å•åŸŸåå•URL

**å®žçŽ°å•åŸŸåä¸æ”¯æŒå­URL**

èŒƒä¾‹ï¼šå‘½ä»¤å¼å®žçŽ°å•åŸŸåä¸æ”¯æŒå­URLï¼Œå­URLæ— æ³•è®¿é—®ï¼Œè¿”å›ž404

```bash
#è·¯å¾„ç²¾ç¡®åŒ¹é…,å¯¹äºŽå‘å¾€www.wang.orgçš„è¯·æ±‚ï¼Œä»£ç†è‡³service/pod-test1ï¼Œå…¶å®ƒçš„URLåˆ™æ— æ³•ä»£ç†
[root@master1 ~]# kubectl create ingress demo-ingress --rule="www.mystical.org/=pod-test1:80" --class=nginx -o yaml --dry-run=client
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  creationTimestamp: null
  name: demo-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /
        pathType: Exact    # #è¡¨ç¤ºç²¾ç¡®åŒ¹é…ï¼Œ--rule="www.wang.org/*=pod-test1:80",åˆ™ä¸ºprefix
status:
  loadBalancer: {}

# åˆ›å»º
[root@master1 ~]#kubectl create ingress demo-ingress --rule="www.mystical.org/=pod-test1:80" --class=nginx
ingress.networking.k8s.io/demo-ingress created

# æŸ¥çœ‹ç”Ÿæˆçš„yamlæ–‡ä»¶
[root@master1 ~]#kubectl get ingress demo-ingress -o yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  creationTimestamp: "2025-01-04T06:37:06Z"
  generation: 1
  name: demo-ingress
  namespace: default
  resourceVersion: "30734"
  uid: a87cc2f4-3755-45fd-ab85-36a800869698
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /
        pathType: Exact
status:
  loadBalancer: {}


# æŸ¥çœ‹ingressèµ„æº
[root@master1 ~]#kubectl get ingress
NAME           CLASS   HOSTS              ADDRESS     PORTS   AGE
demo-ingress   nginx   www.mystical.org   10.0.0.10   80      2m37s


# æŸ¥çœ‹ingress-nginx-controllerå¯¹åº”çš„Podä¸­Nginxé…ç½®æ–‡ä»¶çš„å˜åŒ–
[root@master1 ~]# kubectl exec -it -n ingress-nginx ingress-nginx-controller-666487-9cvb7  -- grep mystical.org /etc/nginx/nginx.conf
	## start server www.mystical.org
		server_name www.mystical.org ;
	## end server www.mystical.org


# é›†ç¾¤å¤–è®¿é—®
[root@master1 ~]#curl -H"host: www.mystical.org" http://10.0.0.10
kubernetes pod-test v0.1!! ClientIP: 10.244.1.158, ServerName: pod-test1-cd487559d-pmf2j, ServerIP: 10.244.3.173!
[root@master1 ~]#curl -H"host: www.mystical.org" http://10.0.0.10
kubernetes pod-test v0.1!! ClientIP: 10.244.1.158, ServerName: pod-test1-cd487559d-v6pl7, ServerIP: 10.244.1.159!


# è®¿é—®å­URLå¤±è´¥ï¼ŒåŽŸå› æ˜¯åªå‘å¸ƒäº†www.wang.orgçš„æ ¹ç›®å½•ï¼Œå…¶å®ƒURLæ²¡æœ‰å‘å¸ƒ
[root@master1 ~]#curl -H"host: www.mystical.org" http://10.0.0.10/hostname
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>


#æ¸…ç†
[root@master1 ~]#kubectl delete ingress demo-ingress 
ingress.networking.k8s.io "demo-ingress" deleted
```



**å®žçŽ°å•åŸŸåæ”¯æŒå­URL**

```bash
#æ·»åŠ /*ï¼Œæ”¯æŒå­URLï¼Œå¦‚æžœæœ‰URLåˆ™è½¬å‘è‡³Podå¯¹åº”ç›¸åŒçš„URL
[root@master1 ~]# kubectl create ingress demo-ingress --class=nginx --rule="www.mystical.org/*=pod-test1:80" -o yaml --dry-run=client
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  creationTimestamp: null
  name: demo-ingress
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /
        pathType: Prefix
status:
  loadBalancer: {}


# åˆ›å»º
[root@master1 ~]#kubectl create ingress demo-ingress --rule="www.mystical.org/*=pod-test1:80" --class=nginx
ingress.networking.k8s.io/demo-ingress created

# æŸ¥çœ‹
[root@master1 ~]#kubectl get ingress
NAME           CLASS   HOSTS              ADDRESS   PORTS   AGE
demo-ingress   nginx   www.mystical.org             80      5s

# æµ‹è¯•è®¿é—®ï¼Œä¸”æ”¯æŒå­URL
[root@master1 ~]#curl -H"host: www.mystical.org" 10.0.0.10/hostname
ServerName: pod-test1-cd487559d-gs725

# æ¸…ç†
[root@master1 ~]#kubectl delete ingress demo-ingress 
ingress.networking.k8s.io "demo-ingress" deleted
```



##### å•åŸŸåå¤šURL

![image-20250104152617359](D:\git_repository\cyber_security_learning\markdown_img\image-20250104152617359.png)

åœ¨åŒä¸€ä¸ªFQDNä¸‹é€šè¿‡ä¸åŒçš„URLå®Œæˆä¸åŒåº”ç”¨é—´çš„æµé‡åˆ†å‘



**å•åŸŸåå¤šURLä¸æ”¯æŒå­URL**

èŒƒä¾‹: å‘½ä»¤å¼å®žçŽ°å•åŸŸåå¤šURLï¼Œä¸æ”¯æŒå­URLï¼Œå¦‚æžœå­URLè®¿é—®ï¼Œä¹Ÿå…¨éƒ¨è½¬å‘è‡³åŽç«¯Podçš„æ ¹è·¯å¾„ / 

```bash
#è·¯å¾„ç²¾ç¡®åŒ¹é…,å¯¹äºŽå‘å¾€www.wang.org/v1å’Œwww.wang.org/v2çš„è¯·æ±‚ï¼Œåˆ†åˆ«ä»£ç†è‡³service/pod-test1å’Œservice/pod-test2çš„å¯¹åº”çš„å­URL
[root@master1 ~]# kubectl create ingress demo-ingress1 --rule="www.mystical.org/v1=pod-test1:80" --rule="www.mystical.org/v2=pod-test2:80" --class=nginx
ingress.networking.k8s.io/demo-ingress1 created

# é›†ç¾¤å¤–è®¿é—®å¤±è´¥ï¼ŒåŽŸå› æ˜¯åŽç«¯æœåŠ¡æ²¡æœ‰å¯¹åº”çš„/v1è¿™æ ·çš„å­URLèµ„æº
[root@master1 ~]# curl -H"host: www.mystical.org" 10.0.0.10/v1/
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>
[root@mas

[root@master1 ~]# curl -H"host: www.mystical.org" 10.0.0.10/v2/
<html>
<head><title>404 Not Found</title></head>
<body>
<center><h1>404 Not Found</h1></center>
<hr><center>nginx</center>
</body>
</html>

# è·¯å¾„ç²¾ç¡®åŒ¹é…,å¯¹äºŽå‘å¾€www.wang.org/v1å’Œ/v2çš„è¯·æ±‚ï¼Œåˆ†åˆ«ä»£ç†è‡³service/pod-test1å’Œservice/pod-test2çš„æ ¹
[root@master1 ~]# kubectl create ingress demo-ingress1 --rule="www.mystical.org/v1=pod-test1:80" --rule="www.mystical.org/v2=pod-test2:80" --class=nginx --annotation nginx.ingress.kubernetes.io/rewrite-target="/"

# --annotation nginx.ingress.kubernetes.io/rewrite-target="/" è¡¨ç¤ºä»£ç†è‡³åŽç«¯æœåŠ¡çš„æ ¹/ï¼Œè€Œéžé»˜è®¤ä»£ç†è‡³åŽç«¯æœåŠ¡çš„å­URL/v1å’Œ/v2

# æŸ¥çœ‹å¯¹åº”çš„yamlæ–‡ä»¶
[root@master1 ~]# kubectl get ingress demo-ingress1 -o yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
  creationTimestamp: "2025-01-04T07:49:12Z"
  generation: 1
  name: demo-ingress1
  namespace: default
  resourceVersion: "38353"
  uid: 822e0bb2-0ae3-4b17-acc2-13db0bfe5499
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /v1
        pathType: Exact
      - backend:
          service:
            name: pod-test2
            port:
              number: 80
        path: /v2
        pathType: Exact
status:
  loadBalancer:
    ingress:
    - ip: 10.0.0.10


# æµ‹è¯•
[root@master1 ~]#curl -H"host: www.mystical.org" 10.0.0.10/v2/
kubernetes pod-test v0.2!! ClientIP: 10.244.3.172, ServerName: pod-test2-6fb54b5db8-jkvjx, ServerIP: 10.244.1.160!
[root@master1 ~]#curl -H"host: www.mystical.org" 10.0.0.10/v1
kubernetes pod-test v0.1!! ClientIP: 10.244.1.158, ServerName: pod-test1-cd487559d-pmf2j, ServerIP: 10.244.3.173!

# å¦‚æžœæœ‰URLï¼Œåˆ™è®¿é—®çš„èµ„æºä»ç„¶æ˜¯æ ¹ç›®å½•ï¼Œä¸æ”¯æŒå¯¹åº”çš„å­URL
[root@master1 ~]#curl -H"host: www.mystical.org" 10.0.0.10/v1/hostname
kubernetes pod-test v0.1!! ClientIP: 10.244.1.158, ServerName: pod-test1-cd487559d-v6pl7, ServerIP: 10.244.1.159!

# æ¸…ç†
[root@master1 ~]#kubectl delete ingress demo-ingress1 
ingress.networking.k8s.io "demo-ingress1" deleted
```



**å•åŸŸåå¤šURLæ”¯æŒå­URL**

èŒƒä¾‹ï¼šå‘½ä»¤å¼å®žçŽ°å•åŸŸåå¤šURLï¼Œæ”¯æŒå­URL

```bash
# ä½¿ç”¨URIçš„å‰ç¼€åŒ¹é…ï¼Œè€Œéžç²¾ç¡®åŒ¹é…ï¼Œä¸”åŸºäºŽæ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼è¿›è¡Œurl rewrite
[root@master1 ~]# kubectl create ingress demo-ingress2 --rule='www.mystical.org/v1(/|$)(.*)=pod-test1:80' --rule='www.mystical.org/v2(/|$)(.*)=pod-test2:80' --class=nginx --annotation nginx.ingress.kubernetes.io/rewrite-target='/$2'
Warning: path /v1(/|$)(.*) cannot be used with pathType Exact
Warning: path /v2(/|$)(.*) cannot be used with pathType Exact
ingress.networking.k8s.io/demo-ingress2 created


# æŸ¥çœ‹
[root@master1 ~]#kubectl get ingress
NAME            CLASS   HOSTS              ADDRESS     PORTS   AGE
demo-ingress2   nginx   www.mystical.org   10.0.0.10   80      75s


# æŸ¥çœ‹yamlæ–‡ä»¶
[root@master1 ~]# kubectl get ingress demo-ingress2 -o yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
  creationTimestamp: "2025-01-04T07:58:21Z"
  generation: 1
  name: demo-ingress2
  namespace: default
  resourceVersion: "39303"
  uid: de4a2bb8-e2aa-4458-ba39-3660dc46ed5f
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /v1(/|$)(.*)
        pathType: Exact
      - backend:
          service:
            name: pod-test2
            port:
              number: 80
        path: /v2(/|$)(.*)
        pathType: Exact
status:
  loadBalancer:
    ingress:
    - ip: 10.0.0.10


# æµ‹è¯•
[root@master1 ~]# curl -H"host: www.mystical.org" 10.0.0.10/v1/hostname
ServerName: pod-test1-cd487559d-v6pl7
[root@master1 ~]# curl -H"host: www.mystical.org" 10.0.0.10/v2/hostname
ServerName: pod-test2-6fb54b5db8-p6bwc
 
# æ¸…ç†
[root@master1 ~]# kubectl delete ingress demo-ingress2 
ingress.networking.k8s.io "demo-ingress2" deleted
```



##### å¤šåŸŸå

![image-20250104160408264](D:\git_repository\cyber_security_learning\markdown_img\image-20250104160408264.png)



èŒƒä¾‹ï¼šå‘½ä»¤å¼å®žçŽ°åŸºäºŽä¸»æœºå¤´çš„å¤šè™šæ‹Ÿä¸»æœº

```bash
# çŽ¯å¢ƒå‡†å¤‡ï¼š
# åŸºäºŽFQDNåç§°ä»£ç†ä¸åŒåº”ç”¨çš„è¯·æ±‚æ—¶ï¼Œéœ€è¦äº‹å…ˆå‡†å¤‡å¥½å¤šä¸ªåŸŸåï¼Œä¸”ç¡®ä¿å¯¹è¿™äº›åŸŸåçš„è§£æžèƒ½å¤Ÿè¾¾åˆ°Igress Controller

# å¯¹test1.wang.orgçš„è¯·æ±‚ä»£ç†è‡³service/pod-test1ï¼Œå¯¹test2.wang.orgè¯·æ±‚ä»£ç†è‡³service/pod-test2
[root@master1 ~]# kubectl create ingress demo-ingress3 --rule="test1.mystical.org/*=pod-test1:80" --rule="test2.mystical.org/*=pod-test2:80" --class=nginx
ingress.networking.k8s.io/demo-ingress3 created


# æŸ¥çœ‹
[root@master1 ~]# kubectl get ingress
NAME            CLASS   HOSTS                                  ADDRESS   PORTS   AGE
demo-ingress3   nginx   test1.mystical.org,test2.mytical.org             80      25s

[root@master1 ~]# kubectl get ingress demo-ingress3 -o yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  creationTimestamp: "2025-01-04T08:11:21Z"
  generation: 1
  name: demo-ingress3
  namespace: default
  resourceVersion: "40668"
  uid: af274e94-7c95-4ee3-9dd3-4da09fcd0937
spec:
  ingressClassName: nginx
  rules:
  - host: test1.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /
        pathType: Prefix
  - host: test2.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test2
            port:
              number: 80
        path: /
        pathType: Prefix
status:
  loadBalancer:
    ingress:
    - ip: 10.0.0.10


# æµ‹è¯•
[root@master1 ~]#curl -H'host: test1.mystical.org' 10.0.0.10
kubernetes pod-test v0.1!! ClientIP: 10.244.3.172, ServerName: pod-test1-cd487559d-gs725, ServerIP: 10.244.2.107!

[root@master1 ~]#curl -H'host: test2.mystical.org' 10.0.0.10
kubernetes pod-test v0.2!! ClientIP: 10.244.1.158, ServerName: pod-test2-6fb54b5db8-jkvjx, ServerIP: 10.244.1.160!

# æ¸…ç†
[root@master1 ~]#kubectl delete ingress demo-ingress3 
ingress.networking.k8s.io "demo-ingress3" deleted
```



##### HTTPS

èŒƒä¾‹ï¼šå‘½ä»¤å¼å®žçŽ°HTTPS

```bash
# åŸºäºŽTLSçš„Ingressè¦æ±‚äº‹å…ˆå‡†å¤‡å¥½ä¸“ç”¨çš„â€œkubernetes.io/tlsâ€ç±»åž‹çš„Secretèµ„æºå¯¹è±¡
[root@master1 tls]#ls
mystical.org.crt  mystical.org.key

#åˆ›å»ºSecret
[root@master1 tls]#kubectl create secret tls tls-mystical --cert=./mystical.org.crt --key=./mystical.org.key 
secret/tls-mystical created

# æŸ¥çœ‹
[root@master1 tls]#kubectl get secrets
NAME           TYPE                DATA   AGE
tls-mystical   kubernetes.io/tls   2      45s

#åˆ›å»ºè™šæ‹Ÿä¸»æœºä»£ç†è§„åˆ™ï¼ŒåŒæ—¶å°†è¯¥ä¸»æœºå®šä¹‰ä¸ºTLSç±»åž‹ï¼Œé»˜è®¤HTTPè‡ªåŠ¨è·³è½¬è‡³HTTPS
[root@master1 tls]#kubectl create ingress tls-demo-ingress --rule='www.mystical.org/*=pod-test1:80, tls=tls-mystical' --class=nginx
ingress.networking.k8s.io/tls-demo-ingress created

# æ³¨æ„ï¼šå¯ç”¨tlsåŽï¼Œè¯¥åŸŸåä¸‹çš„æ‰€æœ‰URIé»˜è®¤ä¸ºå¼ºåˆ¶å°†httpè¯·æ±‚åˆ©ç”¨308è·³è½¬è‡³httpsï¼Œè‹¥ä¸å¸Œæœ›ä½¿ç”¨è¯¥è·³è½¬åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ³¨è§£é€‰é¡¹
--annotation nginx.ingress.kubernetes.io/ssl-redirect=falseï¼Œå³å¦‚ä¸‹å½¢å¼
[root@master1 ~]# kubectl create ingress tls-demo-ingress -- rule='www.wang.org/*=pod-test1:80,tls=tls-wang' --class=nginx --annotation nginx.ingress.kubernetes.io/ssl-redirect=false

# æŸ¥çœ‹
[root@master1 tls]#kubectl get ingress tls-demo-ingress -o yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  creationTimestamp: "2025-01-04T08:47:00Z"
  generation: 1
  name: tls-demo-ingress
  namespace: default
  resourceVersion: "44442"
  uid: 42e90245-143b-4f74-a128-8216da28b839
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /
        pathType: Prefix
  tls:
  - hosts:
    - www.mystical.org
    secretName: tls-mystical
status:
  loadBalancer:
    ingress:
    - ip: 10.0.0.10


#é›†ç¾¤å¤–å®¢æˆ·ç«¯æµ‹è¯•è®¿é—®
https://www.mystical.org/
```



![image-20250104165007749](D:\git_repository\cyber_security_learning\markdown_img\image-20250104165007749.png)





##### è¯ä¹¦æ›´æ–°

HTTPS çš„è¯ä¹¦çš„æœ‰æ•ˆæœŸä¸€èˆ¬ä¸º1å¹´,åˆ°æœŸå‰éœ€è¦æå‰æ›´æ–°è¯ä¹¦

```bash
#é‡æ–°é¢å‘è¯ä¹¦
[root@master1 ~]# (umask 077; openssl genrsa -out wang.key 2048)
[root@master1 ~]# openssl req -new -x509 -key wang.key -out wang.crt -subj /C=CN/ST=Beijing/L=Beijing/O=SRE/CN=www.wang.org -days 3650

# æ–¹æ³•1ï¼š
#åœ¨çº¿ä¿®æ”¹è¯ä¹¦é…ç½®,éœ€è¦æå‰å…ˆå°†æ–°è¯ä¹¦æ–‡ä»¶ç”¨base64ç¼–ç å¹¶åˆ é™¤æ¢è¡Œç¬¦
[root@master1 ~]# cat wang.crt |base64 | tr -d '\n' 
[root@master1 ~]# cat wang.key |base64 | tr -d '\n'

#ä¸Šé¢ç”Ÿæˆçš„å†…å®¹æ›¿æ¢ä¸‹é¢å‘½ä»¤çš„å†…å®¹,ç«‹å³ç”Ÿæ•ˆ
[root@master1 ~]# kubectl edit secrets tls-wang 

# æ–¹æ³•2ï¼š
#æ–¹æ³•2
#åˆ é™¤æ—§è¯ä¹¦é…ç½®
[root@master1 ~]#kubectl delete secrets tls-wang 

#åˆ›å»ºæ–°è¯ä¹¦é…ç½®
[root@master1 ~]# kubectl create secret tls tls-wang --cert=./wang.crt --key=./wang.key
```



### Ingresså£°æ˜Žå¼å®žçŽ°

#### å£°æ˜Žå¼å®žçŽ°è¯´æ˜Ž

åŸºäºŽå‘½ä»¤æ–¹å¼æ ¼å¼åŠŸèƒ½æœ‰é™ï¼Œä¸”ä¸åˆ©äºŽåŽç»­çš„é‡å¤ä½¿ç”¨ï¼Œ**å·¥ä½œä¸­æ›´å¤šçš„ä½¿ç”¨å£°æ˜Žå¼å®žçŽ°Ingress**

åœ¨å®žé™…çš„å·¥ä½œä¸­ï¼Œå¯èƒ½ä¼šåŸºäºŽåŸŸåè®¿é—®,ä¹Ÿå¯èƒ½ä¼šåŸºäºŽä¸åŒçš„åŠŸèƒ½æœåŠ¡ä»¥å­è·¯å¾„çš„æ–¹å¼æ¥è¿›è¡Œè®¿é—®ï¼Œä»¥åŠ ä¸Žhttpsç›¸å…³çš„è®¿é—®ã€‚



**é…ç½®æ–‡ä»¶è§£æž**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: <string>
  annotations:                                 # èµ„æºæ³¨è§£ï¼Œv1beta1ä½¿ç”¨ä¸‹é¢çš„æ³¨è§£æ¥æŒ‡å®šè¦è§£æžè¯¥èµ„æºçš„æŽ§åˆ¶å™¨ç±»åž‹
    kubernetes.io/ingress.class: <string>      # é€‚é…çš„IngressæŽ§åˆ¶å™¨ç±»åˆ«ï¼Œä¾¿äºŽå¤šingressç»„ä»¶åœºæ™¯ä¸‹ï¼ŒæŒ‘é€‰é’ˆå¯¹çš„ç±»åž‹
  namespace: <string>
spec:
  rules: <[]object>                            # Ingressè§„åˆ™åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯httpè½¬å‘æ—¶å€™ç”¨åˆ°çš„ urlå…³é”®å­—
  - host: <string>                             # è™šæ‹Ÿä¸»æœºçš„FQDNï¼Œæ”¯æŒ"*"å‰ç¼€é€šé…ï¼Œä¸æ”¯æŒIPï¼Œä¸æ”¯æŒæŒ‡å®šç«¯å£
    http: <object>
      paths: <[]object>                        # è™šæ‹Ÿä¸»æœºPATHå®šä¹‰çš„åˆ—è¡¨ï¼Œç”±pathå’Œbackendç»„æˆ
      - path: <string>                         # æµé‡åŒ¹é…çš„HTTP PATHï¼Œå¿…é¡»ä»¥/å¼€å¤´
        pathType: <string>                     # æ”¯æŒExactã€Prefixå’ŒImplementationSpecific, å¿…é¡»
        backend: <object>                      # åŒ¹é…åˆ°çš„æµé‡è½¬å‘åˆ°çš„ç›®æ ‡åŽç«¯
          resource: <object>                   # å¼•ç”¨çš„åŒä¸€åç§°ç©ºé—´ä¸‹çš„èµ„æºï¼Œä¸Žä¸‹é¢ä¸¤ä¸ªå­—æ®µäº’æ–¥
          service: <object>                    # å…³è”çš„åŽç«¯Serviceå¯¹è±¡
            name: <string>                     # åŽç«¯Serviceçš„åç§°
            port: <string>                     # åŽç«¯Serviceä¸Šçš„ç«¯å£å¯¹è±¡
              name: <string>                   # ç«¯å£åç§°
              number: <integer>                # ç«¯å£å·
  tls: <[]Object>                              # TLSé…ç½®ï¼Œç”¨äºŽæŒ‡å®šä¸Šrulesä¸­å®šä¹‰çš„å“ªäº›hostéœ€è¦å·¥ä½œhttpsæ¨¡å¼
  - hosts: <[]string>                          # ä½¿ç”¨åŒä¸€ç»„è¯ä¹¦çš„ä¸»æœºåç§°åˆ—è¡¨
    secretName: <string>                       # ä¿å­˜äºŽæ•°å­—è¯ä¹¦å’Œç§é’¥ä¿¡æ¯çš„Secretèµ„æºåç§°ï¼Œç”¨äºŽä¸»æœºè®¤è¯
  backend: <Object>                            # é»˜è®¤backendçš„å®šä¹‰ï¼Œå¯åµŒå¥—å­—æ®µåŠä½¿ç”¨æ ¼å¼è·Ÿruleså­—æ®µä¸­çš„ç›¸åŒ
  ingressClassName: <string>                   # ingressç±»åç§°ï¼Œç”¨äºŽæŒ‡å®šé€‚é…çš„æŽ§åˆ¶å™¨ï¼Œç±»ä¼¼äºŽæ³¨è§£çš„åŠŸèƒ½ï¼Œæœªæ¥ä»£æ›¿                                                        annotations
```



#### å£°æ˜Žå¼å®žçŽ°æ¡ˆä¾‹

##### å•åŸŸåæ¡ˆä¾‹

![image-20250104171513550](D:\git_repository\cyber_security_learning\markdown_img\image-20250104171513550.png)

èŒƒä¾‹ : å•åŸŸåæ”¯æŒå­URL

```yaml
# å‡†å¤‡åŽç«¯æœåŠ¡æ‰€éœ€èµ„æº
[root@master1 ingress] # cat ingress-deployment-svc.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-test
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: http
---
apiVersion: v1
kind: Service
metadata:
  name: deployment-service
spec:
  selector:
    app: pod-test
  ports:
  - name: http
    port: 80
    targetPort: 80
    
# åº”ç”¨
[root@master1 yaml] # kubectl apply -f ingress-deployment-svc.yaml 
deployment.apps/deployment-test created

# è‡ªå®šä¹‰åˆ›å»ºingressèµ„æºæ–‡ä»¶
[root@master1 ingress] # vim ingress-http-test.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-test
  #annotations:
  #  kubernetes.io/ingress.class: "nginx"
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: deployment-service
            port:
              number: 80

# æŸ¥çœ‹ingress
[root@master1 ingress] # kubectl get ingress
NAME           CLASS   HOSTS              ADDRESS     PORTS   AGE
ingress-test   nginx   www.mystical.org   10.0.0.10   80      2m12s

# æµ‹è¯•
# è¿™é‡Œçš„å®¢æˆ·ç«¯æ˜¾ç¤ºçš„æ˜¯ingressçš„Podçš„IPï¼Œè€Œä¸æ˜¯çœŸå®žçš„å®¢æˆ·ç«¯IP
[root@master1 ingress] # curl -H"host: www.mystical.org" 10.0.0.10
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: deployment-test-5cc5b8d4cd-bzbnm, ServerIP: 10.244.2.112!
[root@master1 ingress] # curl -H"host: www.mystical.org" 10.0.0.10
kubernetes pod-test v0.1!! ClientIP: 10.244.1.164, ServerName: deployment-test-5cc5b8d4cd-qv78g, ServerIP: 10.244.3.177!

# æ¸…ç†åˆ é™¤
[root@master1 ingress]#kubectl delete -f ingress-http-test.yaml 
ingress.networking.k8s.io "ingress-test" deleted
```



##### èŽ·å–çœŸå®žå®¢æˆ·ç«¯IP

```yaml
# çŽ¯å¢ƒå‡†å¤‡ï¼Œç›´æŽ¥ä½¿ç”¨ä¸Šè¿°çŽ¯å¢ƒå³å¯
[root@master1 ingress] # kubectl create deployment myapp --image registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
deployment.apps/myapp created

[root@master1 ingress] # kubectl create svc clusterip myapp --tcp 80
service/myapp created

# Ingressé…ç½®
[root@master1 ingress] # cat ingress-http-real-ip.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-myapp
  annotations:
    nginx.ingress.kubernetes.io/enable-real-ip: "true" # å…è®¸IPé€ä¼ ï¼Œæ­¤ä¸ºé»˜è®¤å€¼
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: myapp
            port:
              number: 80
        path: /
        pathType: Prefix
        
# æŸ¥çœ‹ingress-nginxçš„podé‡Œçš„é…ç½®
[root@master1 ingress] # kubectl exec -n ingress-nginx ingress-nginx-controller-666487-9cvb7 -- nginx -T|grep 'proxy_set_header X-Forwarded-For'
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
			proxy_set_header X-Forwarded-For        $remote_addr;
			proxy_set_header X-Forwarded-For        $remote_addr;
			
# ä»Žé›†ç¾¤å¤–è®¿é—® 
[root@ubuntu2204 ~] # curl www.mystical.org
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
...

# æŸ¥çœ‹æ—¥å¿—ä¿¡æ¯
[root@master1 ingress] # kubectl logs myapp-56cc856b4-k9hjv 
10.244.3.178 - - [06/Jan/2025:06:28:39 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.81.0" "10.0.0.132"
10.244.3.178 - - [06/Jan/2025:06:28:42 +0000] "GET / HTTP/1.1" 200 612 "-" "curl/7.81.0" "10.0.0.132"
```



##### å•åŸŸåå¤šURLæ¡ˆä¾‹

èŒƒä¾‹ï¼šçŽ¯å¢ƒå‡†å¤‡ä¸¤ä¸ªHTTPåº”ç”¨

```yaml
# å¦‚æžœå‰é¢çš„èµ„æºå·²åˆ é™¤ï¼Œé‡æ–°åº”ç”¨ä¸Šé¢å°èŠ‚çš„èµ„æºæ–‡ä»¶ç”Ÿæˆdeploymentå’Œå¯¹åº”çš„SVC
#è®¿é—® www.wang.org/flaskçš„æ—¶å€™ï¼Œè¿”å›žflaskçš„ç»“æžœ
#è®¿é—® www.wang.org/nginxçš„æ—¶å€™ï¼Œè¿”å›žnginxçš„ç»“æžœ

[root@master1 ingress] # cat ingress-deployment-svc.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-test
spec:
  replicas: 3
  selector:
    matchLabels:
      app: pod-test
  template:
    metadata:
      labels:
        app: pod-test
    spec:
      containers:
      - name: pod-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: http
---
apiVersion: v1
kind: Service
metadata:
  name: deployment-service
spec:
  selector:
    app: pod-test
  ports:
  - name: http
    port: 80
    targetPort: 80


# åº”ç”¨
[root@master1 ingress] # kubectl apply -f ingress-deployment-svc.yaml 
deployment.apps/deployment-test created
service/deployment-service created

# åœ¨æ·»åŠ ä¸€ä¸ªnginxçš„æœåŠ¡ï¼Œå®šä¹‰èµ„æºæ–‡ä»¶
[root@master1 ingress] # cat ingress-deployment-nginx.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  name: deployment-nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx-test
  template:
    metadata:
      labels:
        app: nginx-test
    spec:
      containers:
      - name: nginx-test
        image: registry.cn-beijing.aliyuncs.com/wangxiaochun/nginx:1.20.0
        imagePullPolicy: IfNotPresent
        ports:
        - containerPort: 80
          name: nginx

---
apiVersion: v1
kind: Service
metadata:
  name: nginx-service
spec:
  selector:
    app: nginx-test
  ports:
  - name: nginx
    port: 80
    targetPort: 80
    
# åº”ç”¨
[root@master1 ingress] # kubectl apply -f ingress-deployment-nginx.yaml 
deployment.apps/deployment-nginx created
service/nginx-service created

# æŸ¥çœ‹
[root@master1 ingress] # kubectl get deployments,svc
NAME                               READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/deployment-nginx   3/3     3            3           113s
deployment.apps/deployment-test    3/3     3            3           10m
deployment.apps/myapp              1/1     1            1           21m

NAME                         TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE
service/deployment-service   ClusterIP   10.105.47.74     <none>        80/TCP    10m
service/kubernetes           ClusterIP   10.96.0.1        <none>        443/TCP   2d5h
service/myapp                ClusterIP   10.102.162.246   <none>        80/TCP    21m
service/nginx-service        ClusterIP   10.102.157.212   <none>        80/TCP    113s
```



**å•åŸŸåå¤šURLä¸æ”¯æŒå­URL**

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 ingress] # cat ingress-http-mul-url.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-mul-url
  annotations:
#    kubenetes.io/ingress.class: "nginx"   # æ–°ç‰ˆk8så¥½åƒä¸æ”¯æŒæ³¨è§£çš„ç”¨æ³•
    nginx.ingress.kubernetes.io/rewrite-target: / # é»˜è®¤ä¼šè½¬å‘ç»™åŽç«¯æ—¶ä¼šå¸¦URLï¼Œæ·»åŠ æ­¤è¡Œï¼Œè¡¨ç¤ºè½¬å‘æ—¶åˆ é™¤åŽé¢çš„URL
spec:
  ingressClassName: nginx  # æ–°ç‰ˆå»ºè®®ä½¿ç”¨æ­¤é¡¹æŒ‡å®šcontrollerç±»åž‹
  rules:
  - host: www.mystical.org
    http:
      paths:
      - path: /flask
        pathType: Prefix # è¡¨ç¤ºä»¥/flaskä¸ºå¼€å§‹å³å¯
        backend:
          service:
            name: deployment-service  # æŒ‡å®šå¯¹åº”Serviceçš„åç§°
            port:
              name: http
      - path: /nginx
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              name: nginx

# åº”ç”¨
[root@master1 ingress] # kubectl apply -f ingress-http-mul-url.yaml 
ingress.networking.k8s.io/ingress-mul-url created

# æŸ¥çœ‹
[root@master1 ingress] # kubectl get ingress
NAME              CLASS   HOSTS              ADDRESS     PORTS   AGE
ingress-mul-url   nginx   www.mystical.org   10.0.0.10   80      5s

# æµ‹è¯•
[root@ubuntu2204 ~] # curl www.mystical.org/flask
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: deployment-test-5cc5b8d4cd-nrv8t, ServerIP: 10.244.1.166!

[root@ubuntu2204 ~] # curl www.mystical.org/nginx
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
......

#æ³¨æ„äº‹é¡¹ï¼š
#é»˜è®¤è½¬ç»™åŽç«¯æœåŠ¡æ—¶ä¼šå°†urlä¹ŸåŒæ—¶è½¬å‘ï¼Œè€ŒåŽç«¯æœåŠ¡æœ‰å¯èƒ½ä¸å­˜åœ¨æ­¤URLï¼Œæ‰€ä»¥éœ€è¦åœ¨åŽç«¯urlè½¬å‘çš„æ—¶å€™ï¼Œå–æ¶ˆè½¬å‘å…³é”®å­—ã€‚
#æ–¹æ³•å°±æ˜¯ï¼Œåœ¨annotationä¸­æ·»åŠ ä¸€ä¸ªé‡å†™çš„è§„åˆ™nginx.ingress.kubernetes.io/rewrite-target: / å³æ‰€æœ‰çš„è¯·æ±‚æŠŠingressåŒ¹é…åˆ°çš„urlå…³é”®å­—æ¸…é™¤æŽ‰

```



**å•åŸŸåå¤šURLæ”¯æŒå­URL**

```yaml
# å‡†å¤‡åŽç«¯çš„åº”ç”¨pod-test v0.1å’Œç›¸åº”çš„service
[root@master1 ~]# kubectl create deployment pod-test1 --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1 --replicas=3
deployment.apps/pod-test1 created

[root@master1 ~]# kubectl create service clusterip pod-test1 --tcp=80:80
service/pod-test1 created

# å‡†å¤‡åŽç«¯çš„åº”ç”¨pod-test v0.2å’Œç›¸åº”çš„service
[root@master1 ~]# kubectl create deployment pod-test2 --image=registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2 --replicas=3
deployment.apps/pod-test2 created

[root@master1 ~]#kubectl create service clusterip pod-test2 --tcp=80:80
service/pod-test2 created

[root@master1 ~]#kubectl get ep
NAME         ENDPOINTS                                         AGE
kubernetes   10.0.0.201:6443                                   4h47m
pod-test1    10.244.1.159:80,10.244.2.107:80,10.244.3.173:80   3m10s
pod-test2    10.244.1.160:80,10.244.2.108:80,10.244.3.174:80   13s


# èµ„æºæ–‡ä»¶
[root@master1 ingress] # cat ingress-http-mul-suburl.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2  # æ­£åˆ™è¡¨è¾¾å¼
  name: ingress-http-mul-suburl
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test1
            port:
              number: 80
        path: /v1(/|$)(.*)
        pathType: Exact
      - backend:
          service:
            name: pod-test2
            port:
              number: 80
        path: /v2(/|$)(.*)
        pathType: Exact

# åº”ç”¨
[root@master1 ingress] # kubectl apply -f ingress-http-mul-suburl.yaml 
Warning: path /v1(/|$)(.*) cannot be used with pathType Exact
Warning: path /v2(/|$)(.*) cannot be used with pathType Exact
ingress.networking.k8s.io/ingress-http-mul-suburl created

# æŸ¥çœ‹
[root@master1 ingress] # kubectl get ingress
NAME                      CLASS   HOSTS              ADDRESS     PORTS   AGE
ingress-http-mul-suburl   nginx   www.mystical.org   10.0.0.10   80      9s

# æµ‹è¯•
[root@ubuntu2204 ~]#curl www.mystical.org/v1/hostname
ServerName: pod-test1-cd487559d-wfvhs
[root@ubuntu2204 ~]#curl www.mystical.org/v2/hostname
ServerName: pod-test2-6fb54b5db8-mmrjm
```



##### å¤šåŸŸåæ¡ˆä¾‹

```yaml
# è®¿é—®flask.mystical.org/çš„æ—¶å€™ï¼Œè¿”å›žflaskçš„ç»“æžœ
# è®¿é—®flask.mystical.org/çš„æ—¶å€™ï¼Œè¿”å›žnginxçš„ç»“æžœ
[root@master1 ingress] # kubectl apply -f ingress-deployment-nginx.yaml 
deployment.apps/deployment-nginx created
service/nginx-service created

[root@master1 ingress] # kubectl apply -f ingress-deployment-svc.yaml
deployment.apps/deployment-test created
service/deployment-service created

# ç¼–è¾‘Ingressèµ„æºå®šä¹‰æ–‡ä»¶
[root@master1 ingress]#cat ingress-http-mul-host.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-mul-url
  annotations:
    nginx.ingress.kubernetes.io/use-regex: "true"           # æŒ‡å®šåŽé¢ruleså®šä¹‰çš„pathä½¿ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼
    nginx.ingress.kubernetes.io/proxy-body-size: "100m"     # å®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶æœ€å¤§å€¼ï¼Œé»˜è®¤1m
    nginx.ingress.kubernetes.io/proxy-connect-timeout: "60" # åŽç«¯æœåŠ¡å™¨çš„è¿žæŽ¥è¶…æ—¶çš„æ—¶é—´ï¼Œé»˜è®¤å€¼ä¸º5s
    nginx.ingress.kubernetes.io/proxy-send-timeout: "120"   # åŽç«¯æœåŠ¡å™¨æ•°æ®å›žä¼ è¶…æ—¶æ—¶é—´ï¼Œå³è§„å®šæ—¶é—´ä¹‹å†…åŽç«¯æœåŠ¡å™¨å¿…é¡»ä¼ å®Œæ‰€æœ‰çš„æ•°æ®ï¼Œé»˜è®¤å€¼ä¸º60s
    nginx.ingress.kubernetes.io/proxy-read-timeout: "120"   # åŽç«¯æœåŠ¡å™¨å“åº”çš„è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤60s
    #nginx.ingress.kubernetes.io/app-root: /index.html      #æŒ‡å®šé»˜è®¤é¡µé¢æ–‡ä»¶
spec:
  ingressClassName: nginx                                   # æ–°ç‰ˆå»ºè®®ä½¿ç”¨æ­¤é¡¹æŒ‡å®šcontrollerlç±»åž‹
  rules:
  - host: flask.mystical.org
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: deployment-service
            port:
              name: http                                  # åŒ¹é…serviceä¸­çš„ç«¯å£ name: http
  - host: nginx.mystical.org
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: nginx-service
            port:
              name: nginx

# åº”ç”¨
[root@master1 ingress] # kubectl apply -f ingress-http-mul-host.yaml 
ingress.networking.k8s.io/ingress-mul-url created

# æŸ¥çœ‹
[root@master1 ingress]#kubectl get ingress
NAME              CLASS   HOSTS                                   ADDRESS     PORTS   AGE
ingress-mul-url   nginx   flask.mystical.org,nginx.mystical.org   10.0.0.10   80      65s

# æµ‹è¯•
[root@ubuntu2204 ~] # curl flask.mystical.org
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: deployment-test-5cc5b8d4cd-69cgm, ServerIP: 10.244.3.184!

[root@ubuntu2204 ~] # curl nginx.mystical.org
<!DOCTYPE html>
<html>
<head>
<title>Welcome to nginx!</title>
<style>

#æ¸…ç†çŽ¯å¢ƒ
[root@master1 ingress] # kubectl delete -f ingress-http-mul-host.yaml 
ingress.networking.k8s.io "ingress-mul-url" deleted

[root@master1 ingress] # kubectl delete -f ingress-deployment-svc.yaml 
deployment.apps "deployment-test" deleted
service "deployment-service" deleted

[root@master1 ingress] # kubectl delete -f ingress-deployment-nginx.yaml 
deployment.apps "deployment-nginx" deleted
service "nginx-service" deleted
```



#####  HTTPS æ¡ˆä¾‹

```yaml
# å‡†å¤‡å¥½è¯ä¹¦ç›¸å…³çš„secret
[root@master1 ingress] # kubectl get secret
NAME           TYPE                DATA   AGE
tls-mystical   kubernetes.io/tls   2      47h

# å‡†å¤‡å¥½åŽé¢çš„deploymentå’Œservice
[root@master1 ingress] # kubectl apply -f ingress-deployment-svc.yaml 
deployment.apps/deployment-test created
service/deployment-service created

# å®šä¹‰èµ„æºé…ç½®æ–‡ä»¶ï¼Œå®žçŽ°HTTPè‡ªåŠ¨è·³è½¬è‡³HTTPS
[root@master1 ingress]#cat ingress-http-tls-test.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-test
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: deployment-service
            port:
              number: 80
# - host: m.mystical.org
# ...

# httpsè¯ä¹¦é…ç½®
  tls:
  - hosts:
    - www.mystical.org
    secretName: tls-mystical
 #- hosts:                                             # å¤šä¸ªåŸŸååˆ†åˆ«å¯¹åº”ä¸åŒçš„è¯ä¹¦
 #  - m.mystical.org
 #  secretName: ingress-tls-m


# åº”ç”¨
[root@master1 ingress] # kubectl apply -f ingress-http-tls-test.yaml 
ingress.networking.k8s.io/ingress-test created

# æŸ¥çœ‹
[root@master1 ingress] # kubectl get ingress
NAME           CLASS   HOSTS              ADDRESS     PORTS     AGE
ingress-test   nginx   www.mystical.org   10.0.0.10   80, 443   2m11s


# æµ‹è¯•
[root@ubuntu2204 ~] # curl www.mystical.org -Lk
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: deployment-test-5cc5b8d4cd-ww8fc, ServerIP: 10.244.3.185!
[root@ubuntu2204 ~] # curl www.mystical.org -Lk
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: deployment-test-5cc5b8d4cd-lkf2v, ServerIP: 10.244.2.119!
```





### Ingress Nginx å®žçŽ°è“ç»¿BlueGreen å’Œç°åº¦Canary å‘å¸ƒ



####  Ingress Nginx è¿›è¡ŒBlueGreen å’Œ Canary ç°åº¦å‘å¸ƒè¯´æ˜Ž



Service è™½ç„¶æ”¯æŒæµé‡åˆ†é…,ä½†æ˜¯**åªæ”¯æŒåŸºäºŽPodçš„æ•°é‡æˆ–æ¯”ä¾‹å®žçŽ°**,è€Œ**ä¸æ”¯æŒåŸºäºŽHeader,cookie,æƒé‡ç­‰** æ›´ä¸ºæ¸…ç¡®çš„æµé‡å‘é…ç­–ç•¥

**Ingress-Nginxæ”¯æŒé…ç½®Ingress Annotationsæ¥å®žçŽ°ä¸åŒåœºæ™¯ä¸‹çš„ç°åº¦å‘å¸ƒå’Œæµ‹è¯•**ï¼Œå®ƒèƒ½å¤Ÿæ»¡è¶³é‡‘ä¸é›€ å‘å¸ƒã€è“ç»¿éƒ¨ç½²ä¸ŽA/Bæµ‹è¯•ç­‰ä¸åŒçš„ä¸šåŠ¡åœºæ™¯

**æ³¨æ„**ï¼šIngress-Nginx åªèƒ½æ”¯æŒå—åŒ—å‘çš„æµé‡å‘å¸ƒï¼Œè€Œä¸œè¥¿å‘æµé‡çš„å‘å¸ƒå¯ä»¥åˆ©ç”¨å·¥ä½œè´Ÿè½½åž‹å¦‚ deploymentçš„æ›´æ–°ç­–ç•¥æˆ–è€…æœåŠ¡ç½‘æ ¼æŠ€æœ¯å®žçŽ°



**Ingress Nginxçš„æµé‡å‘å¸ƒæœºåˆ¶**



![image-20250106163000499](D:\git_repository\cyber_security_learning\markdown_img\image-20250106163000499.png)



- **è“ç»¿**ï¼š
  - production: 100%, canary: 0%
  - production: 0%, canary: 100% --> Canaryå˜æˆåŽé¢çš„Production
- **é‡‘ä¸é›€Canary**ï¼š
  - **æµé‡æ¯”ä¾‹åŒ–åˆ‡åˆ†**: é€æ¸è°ƒæ•´
  - **æµé‡è¯†åˆ«ï¼Œå°†ç‰¹å®šçš„æµé‡åˆ†å‘ç»™Canary**ï¼š
    - By-Headerï¼šåŸºäºŽç‰¹å®šçš„æ ‡å¤´è¯†åˆ«
      -  Header å€¼é»˜è®¤ï¼šåªæœ‰Always æˆ– Nerver ä¸¤ç§å€¼ 
      - Header å€¼è‡ªå®šä¹‰ 
      - Header å€¼å¯ä»¥åŸºäºŽæ­£åˆ™è¡¨è¾¾å¼Patternè¿›è¡ŒåŒ¹é…
    - By-Cookie: åŸºäºŽCookieè¯†åˆ«



**åŸºäºŽIngress Nginxçš„Canaryè§„åˆ™**

Ingress Nginx çš„ Annotationsæ”¯æŒçš„Canaryè§„åˆ™ï¼Œ Annotations å’Œ Label ç›¸ä¼¼ä¹Ÿæ˜¯ä¿å­˜èµ„æºå¯¹è±¡ä¸Šçš„ å…ƒæ•°æ®ï¼Œä½†ä¸èƒ½è¢«æ ‡ç­¾é€‰æ‹©å™¨é€‰æ‹©ï¼Œä¸”æ²¡æœ‰Labelçš„åç§°æœ€é•¿63ä¸ªå­—ç¬¦çš„é™åˆ¶



- **nginx.ingress.kubernetes.io/canary-weight**ï¼š
  - åŸºäºŽæœåŠ¡æƒé‡è¿›è¡Œæµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºŽè“ç»¿æˆ–ç°åº¦å‘å¸ƒï¼Œæƒé‡èŒƒå›´0 - 100æŒ‰ç™¾åˆ†æ¯”å°†è¯·æ±‚è·¯ç”±åˆ° Canary Ingressä¸­æŒ‡å®šçš„æœåŠ¡
  - æƒé‡ä¸º 0 æ„å‘³ç€è¯¥é‡‘ä¸é›€è§„åˆ™ä¸ä¼šå‘Canaryå…¥å£çš„æœåŠ¡å‘é€ä»»ä½•è¯·æ±‚
  - æƒé‡ä¸º100æ„å‘³ç€æ‰€æœ‰è¯·æ±‚éƒ½å°†è¢«å‘é€åˆ° Canary å…¥å£

- **nginx.ingress.kubernetes.io/canary-by-cookie**ï¼š
  - åŸºäºŽ cookie çš„æµé‡åˆ‡åˆ†ï¼Œé€‚ç”¨äºŽç°åº¦å‘å¸ƒä¸Ž A/B æµ‹è¯•
  - cookie çš„å€¼è®¾ç½®ä¸º always æ—¶ï¼Œå®ƒå°†è¢«è·¯ç”±åˆ°Canaryå…¥å£
  - cookie çš„å€¼è®¾ç½®ä¸º never æ—¶ï¼Œè¯·æ±‚ä¸ä¼šè¢«å‘é€åˆ°Canaryå…¥å£
  - å¯¹äºŽä»»ä½•å…¶ä»–å€¼ï¼Œå°†å¿½ç•¥ cookie å¹¶å°†è¯·æ±‚ä¸Žå…¶ä»–é‡‘ä¸é›€è§„åˆ™è¿›è¡Œä¼˜å…ˆçº§çš„æ¯”è¾ƒï¼Œé»˜è®¤è½¬å‘ç»™æ—§ç‰ˆ æœ¬











**è§„åˆ™çš„åº”ç”¨æ¬¡åº**

- Canaryè§„åˆ™ä¼šæŒ‰ç‰¹å®šçš„æ¬¡åºè¿›è¡Œè¯„ä¼°
- ä¼˜å…ˆçº§ä»Žä½Žåˆ°é«˜é¡ºåºï¼š**canary -weight- -> canary-by-cookie --> canary-by-header** 





#### å®žæˆ˜æ¡ˆä¾‹

##### èŒƒä¾‹ï¼šåˆå§‹çŽ¯å¢ƒå‡†å¤‡æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬åº”ç”¨

```yaml
# å‡†å¤‡æ–°æ—§ç‰ˆæœ¬å¯¹åº”çš„å„è‡ªç‹¬ç«‹çš„ä¸¤å¥—deploymentå’Œservice
[root@master1 project-caray] # cat deploy-pod-test-v1.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: pod-test
  name: pod-test-v1
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pod-test
      version: v0.1
  strategy: {}
  template:
    metadata:
      labels:
        app: pod-test
        version: v0.1
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
        name: pod-test

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: pod-test
  name: pod-test-v1
spec:
  ports:
  - name: http-80
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: pod-test
    version: v0.1
  type: ClusterIP

[root@master1 project-caray] # cat deploy-pod-test-v2.yaml 
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: pod-test
  name: pod-test-v2
spec:
  replicas: 1
  selector:
    matchLabels:
      app: pod-test
      version: v0.2
  strategy: {}
  template:
    metadata:
      labels:
        app: pod-test
        version: v0.2
    spec:
      containers:
      - image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.2
        name: pod-test

---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: pod-test
  name: pod-test-v2
spec:
  ports:
  - name: http-80
    port: 80
    protocol: TCP
    targetPort: 80
  selector:
    app: pod-test
    version: v0.2
  type: ClusterIP


# éƒ¨ç½²æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬
[root@master1 project-caray] # kubectl apply -f deploy-pod-test-v1.yaml 
deployment.apps/pod-test-v1 created
service/pod-test-v1 created

[root@master1 project-caray] # kubectl apply -f deploy-pod-test-v2.yaml 
deployment.apps/pod-test-v2 created
service/pod-test-v2 created

# æµ‹è¯•
[root@master1 project-caray] # kubectl get svc
NAME          TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
kubernetes    ClusterIP   10.96.0.1       <none>        443/TCP   2d7h
pod-test-v1   ClusterIP   10.99.14.10     <none>        80/TCP    84s
pod-test-v2   ClusterIP   10.96.114.114   <none>        80/TCP    81s

[root@master1 project-caray] # curl 10.99.14.10
kubernetes pod-test v0.1!! ClientIP: 10.244.0.0, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!

[root@master1 project-caray] # curl 10.96.114.114
kubernetes pod-test v0.2!! ClientIP: 10.244.0.0, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
```



##### èŒƒä¾‹ï¼šè“ç»¿å‘å¸ƒ

```yaml
# åˆ›å»ºIngressï¼Œä½¿å…¶å¯¹åº”æ—§ç‰ˆæœ¬åº”ç”¨
[root@master1 project-caray] # cat ingress-blue-green.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-blue-green
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v1
            port:
              number: 80 
        path: /
        pathType: Prefix

# æŸ¥çœ‹
[root@master1 project-caray] # kubectl get ingress
NAME                 CLASS   HOSTS              ADDRESS     PORTS   AGE
ingress-blue-green   nginx   www.mystical.org   10.0.0.10   80      54s

# æµ‹è¯•
[root@ubuntu2204 ~] # curl www.mystical.org
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!

# ä¿®æ”¹Ingressåˆ‡æ¢æˆv0.2ç‰ˆæœ¬
[root@master1 project-caray]#cat ingress-blue-green.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: ingress-blue-green
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v2              # ä¿®æ”¹Serviceç‰ˆæœ¬
            port:
              number: 80 
        path: /
        pathType: Prefix

# åº”ç”¨
[root@master1 project-caray] # kubectl apply -f ingress-blue-green.yaml 
ingress.networking.k8s.io/ingress-blue-green configured

# æµ‹è¯•
[root@ubuntu2204 ~] # curl www.mystical.org
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
```





##### èŒƒä¾‹ï¼šåŸºäºŽæƒé‡çš„é‡‘ä¸é›€å‘å¸ƒ

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 project-caray] # cat canary-by-weight.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-weight: "10"  # æŒ‡å®šä½¿ç”¨é‡‘ä¸é›€æ–°ç‰ˆå ç”¨ç™¾åˆ†æ¯”
  name: pod-test-canary-by-weight
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v2
            port:
              number: 80
        path: /
        pathType: Prefix

# åº”ç”¨
[root@master1 project-caray] # kubectl apply -f canary-by-weight.yaml 
ingress.networking.k8s.io/pod-test-canary-by-weight created

# é›†ç¾¤å¤–å®¢æˆ·ç«¯è®¿é—®ï¼Œè§‚å¯Ÿæ–°æ—§ç‰ˆæœ¬çš„æ¯”ä¾‹
[root@ubuntu2204 ~]#while true; do curl www.mystical.org; sleep 1; done
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# è°ƒæ•´weightæƒé‡ä¸º90
[root@master1 project-caray]# cat canary-by-weight.yaml 
......
    nginx.ingress.kubernetes.io/canary-weight: "90"
    ......
    
# è§‚å¯Ÿæ¯”ä¾‹å˜åŒ–
[root@ubuntu2204 ~] # while true; do curl www.mystical.org; sleep 1; done
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# æ¸…ç†
[root@master1 project-caray] # kubectl delete -f canary-by-weight.yaml 
ingress.networking.k8s.io "pod-test-canary-by-weight" deleted
```



##### èŒƒä¾‹ï¼šåŸºäºŽCookieå®žçŽ°é‡‘ä¸é›€å‘å¸ƒ

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 project-caray] # cat canary-by-cookie.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-cookie: "vip_user"  # cookieä¸­vip_user=alwaysæ—¶æ‰ç”¨é‡‘ä¸é›€å‘å¸ƒä¸‹é¢æ–°ç‰ˆæœ¬
  name: pod-test-canary-by-cookie
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v2
            port:
              number: 80
        path: /
        pathType: Prefix

# åº”ç”¨
[root@master1 project-caray] # kubectl apply -f canary-by-cookie.yaml 
ingress.networking.k8s.io/pod-test-canary-by-cookie created

# å¤–éƒ¨æ­£å¸¸è®¿é—®
[root@ubuntu2204 ~] # while true; do curl www.mystical.org; sleep 1; done
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!

# å°†Cookieä¸Šé¢æ·»åŠ ï¼švip_user=alwaysï¼Œæµ‹è¯•æˆåŠŸ
[root@ubuntu2204 ~]#while true; do curl -b "vip_user=always" www.mystical.org; sleep 1; done
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# æ¸…ç†

```



##### èŒƒä¾‹ï¼šåŸºäºŽè¯·æ±‚Headerå›ºå®šå€¼çš„é‡‘ä¸é›€å‘å¸ƒ

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 project-caray ]# cat canary-by-header.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-header: "X-Canary" # X-Canaryé¦–éƒ¨å­—æ®µå€¼ä¸ºalwaysæ—¶æ‰ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒä¸‹é¢æ–°ç‰ˆæœ¬,å¦åˆ™ä¸ºæ—§ç‰ˆæœ¬
  name: pod-test-canary-by-header
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v2
            port:
              number: 80
        path: /
        pathType: Prefix
        
# åº”ç”¨
[root@master1 project-caray] # kubectl apply -f canary-by-header.yaml 
ingress.networking.k8s.io/pod-test-canary-by-header created

# æµ‹è¯•
[root@ubuntu2204 ~]#while true; do curl www.mystical.org; sleep 1; done
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!
kubernetes pod-test v0.1!! ClientIP: 10.244.3.178, ServerName: pod-test-v1-5b856c4b5b-g9ltz, ServerIP: 10.244.1.173!

# æ·»åŠ headerï¼Œå®žçŽ°ç‰ˆæœ¬åˆ‡æ¢
[root@ubuntu2204 ~]#while true; do curl -H "X-Canary: always" www.mystical.org; sleep 1; done
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# æ¸…ç†

```



##### èŒƒä¾‹: åŸºäºŽè¯·æ±‚ Header ç²¾ç¡®åŒ¹é…æŒ‡å®šå€¼çš„é‡‘ä¸é›€å‘å¸ƒ

```yaml
# æ¸…å•
[root@master1 project-caray] # cat canary-by-header-value.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-header: "IsVIP"
    nginx.ingress.kubernetes.io/canary-by-header-value: "true" #IsVIPé¦–éƒ¨å­—æ®µçš„å€¼ä¸ºtrueå°±ä½¿ç”¨é‡‘ä¸é›€å‘å¸ƒä¸‹é¢æ–°ç‰ˆæœ¬,å¦åˆ™ä¸ºæ—§ç‰ˆæœ¬
  name: pod-test-canary-by-header-value
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v2
            port: 
              number: 80
        path: /
        pathType: Prefix


# åº”ç”¨
[root@master1 project-caray] # kubectl apply -f canary-by-header-value.yaml 
ingress.networking.k8s.io/pod-test-canary-by-header-value created

# æµ‹è¯•
[root@ubuntu2204 ~] # while true; do curl -H "IsVIP: true" www.mystical.org; sleep 1; done
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# æ¸…ç†
[root@master1 project-caray] # kubectl delete -f canary-by-header-value.yaml 
ingress.networking.k8s.io "pod-test-canary-by-header-value" deleted
```



##### èŒƒä¾‹ï¼šåŸºäºŽè¯·æ±‚ Header æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼åŒ¹é…çš„æŒ‡å®šå€¼çš„é‡‘ä¸é›€å‘å¸ƒ

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 project-caray] # cat canary-by-header-pattern.yaml 
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  annotations:
    nginx.ingress.kubernetes.io/canary: "true"
    nginx.ingress.kubernetes.io/canary-by-header: "username"
    nginx.ingress.kubernetes.io/canary-by-header-pattern: "(vip|VIP)_.*" #é¦–éƒ¨å­—æ®µçš„å€¼ä¸ºusernameä¸”æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ—¶ä½¿ç”¨æ–°ç‰ˆï¼Œå¦åˆ™ä½¿ç”¨æ—§ç‰ˆ
  name: pod-test-canary-by-header-pattern
spec:
  ingressClassName: nginx
  rules:
  - host: www.mystical.org
    http:
      paths:
      - backend:
          service:
            name: pod-test-v2
            port: 
              number: 80
        path: /
        pathType: Prefix

# åº”ç”¨
[root@master1 project-caray] # kubectl apply -f canary-by-header-pattern.yaml 
ingress.networking.k8s.io/pod-test-canary-by-header-pattern created

# é›†ç¾¤å¤–å®¢æˆ·ç«¯è®¿é—®
[root@ubuntu2204 ~]#while true; do curl -H "username: vip_user" www.mystical.org; sleep 1; done
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# æ¢ä¸ªusernameçš„å€¼ï¼Œå¯ä»¥åŒ¹é…æ­£åˆ™ï¼Œå› æ­¤ä»æ˜¯æ–°ç‰ˆ
[root@ubuntu2204 ~]#while true; do curl -H "username: VIP_man" www.mystical.org; sleep 1; done
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!
kubernetes pod-test v0.2!! ClientIP: 10.244.3.178, ServerName: pod-test-v2-54df7d7958-c427f, ServerIP: 10.244.3.186!

# æ¸…ç†
[root@master1 project-caray] # kubectl delete -f canary-by-header-pattern.yaml 
ingress.networking.k8s.io "pod-test-canary-by-header-pattern" deleted
```





## Kuberneteså®‰å…¨æœºåˆ¶



**æœ¬ç« å†…å®¹**

- **å®‰å…¨ä½“ç³»**
- **è®¤è¯æœºåˆ¶**
- **æŽˆæƒæœºåˆ¶**
- **å‡†å…¥æœºåˆ¶**





### å®‰å…¨ä½“ç³»



**ç”¨æˆ·è®¿é—®Kubernetesä¸šåŠ¡åº”ç”¨çš„æµç¨‹**

- æ— éœ€api_serverè®¤è¯
  - ç”¨æˆ· --> Service(ingress-nginx) --> ingress(controller) --> service --> pod
- åŸºäºŽapi_serverè®¤è¯
  - ç®¡ç†Kuberneteså¹³å°ä¸Šå„ç§åº”ç”¨çŽ°è±¡

å¯¹äºŽKuberneteså¹³å°æ¥è¯´ï¼Œå‡ ä¹Žæ‰€æœ‰çš„æ“ä½œåŸºæœ¬ä¸Šéƒ½æ˜¯é€šè¿‡kube apiserverè¿™ä¸ªç»„ä»¶è¿›è¡Œçš„ï¼Œè¯¥ç»„ä»¶æä¾›HTTP RESTfulå½¢å¼çš„APIé›†ç¾¤å†…å¤–å®¢æˆ·ç«¯è°ƒç”¨

å¯¹äºŽKubernetesé›†ç¾¤çš„éƒ¨ç½²æ ·å¼ä¸»è¦ç”±ä¸¤ç§ï¼šhttpå½¢å¼å’Œhttpså½¢å¼

é‡‡ç”¨Kuberneteséƒ¨ç½²çš„å½¢å¼é»˜è®¤å¯¹å¤–æ˜¯åŸºäºŽhttpsçš„æ–¹å¼ï¼Œè€Œå†…éƒ¨ç»„ä»¶çš„é€šä¿¡æ˜¯åŸºäºŽhttpæ–¹å¼

è€ŒKubernetesçš„è®¤è¯æŽˆæƒæœºåˆ¶ä»…ä»…å­˜åœ¨äºŽhttpså½¢å¼çš„apiè®¿é—®ä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœå®¢æˆ·ç«¯ä½¿ç”¨HTTPè¿žæŽ¥åˆ°kube-apiserver,é‚£ä¹ˆæ˜¯ä¸ä¼šè¿›è¡Œè®¤è¯æŽˆæƒçš„ï¼Œè¿™æ ·å³å¢žåŠ äº†å®‰å…¨æ€§ï¼Œä¹Ÿä¸è‡³äºŽå¤ªå¤æ‚

Kubeletå’Œkubeapiç±»ä¼¼ï¼Œæä¾›ä¸€ä¸ªç®€å•çš„REST APIæœåŠ¡ï¼Œä¹Ÿç›‘å¬ä¸€äº›TCPçš„å¥—æŽ¥å­—

- 10250ï¼šå…·æœ‰æ‰€æœ‰èŠ‚ç‚¹ä¸ŠPodç®¡ç†æƒé™çš„è¯»å†™ç«¯å£ï¼Œåº”è°¨æ…Žç®¡ç†ï¼ŒKubeletç®¡ç†çš„ç«¯å£
- 10255ï¼šä»…æä¾›åªè¯»æ“ä½œï¼Œæ˜¯REST APIçš„å­é›†ï¼Œæ–°ç‰ˆä¸å†ä½¿ç”¨
- 10248ï¼šæ˜¯æœ¬åœ°healthzç«¯ç‚¹ä½¿ç”¨çš„ç«¯å£ï¼ŒKubeletç®¡ç†çš„ç«¯å£

```bash
[root@master1 project-caray]# ss -ntlp|grep kubelet
LISTEN 0      4096       127.0.0.1:10248      0.0.0.0:*    users:(("kubelet",pid=1256,fd=17))       
LISTEN 0      4096               *:10250            *:*    users:(("kubelet",pid=1256,fd=14))  
```



#### å®‰å…¨åŸºæœ¬æµç¨‹

![image-20250106182043977](D:\git_repository\cyber_security_learning\markdown_img\image-20250106182043977.png)



- è®¤è¯ Authentication
- æŽˆæƒ Authorization
- å‡†å…¥æŽ§åˆ¶ Admission contro



æ­¤å®‰å…¨æœºåˆ¶åœ¨ä¸€å®šç¨‹åº¦ä¸Šæé«˜å®‰å…¨æ€§ï¼Œä¸è¿‡æ›´å¤šæ˜¯èµ„æºç®¡ç†æ–¹é¢çš„ä½œç”¨ã€‚

è®¤è¯,æŽˆæƒå’Œå‡†å…¥æŽ§åˆ¶åŠŸèƒ½éƒ½æ˜¯ä»¥**æ’ä»¶åŒ–çš„æ–¹å¼**æ¥å®žçŽ°çš„ï¼Œè¿™æ ·å¯ä»¥æœ€å¤§åŒ–çš„ç”¨æˆ·è‡ªå®šä¹‰çµæ´»æ€§ã€‚



| æ­¥éª¤                 | è§£æž                                                         |
| -------------------- | ------------------------------------------------------------ |
| è®¤è¯(Authn)          | å¯¹ç”¨æˆ·è¿›è¡Œèº«ä»½è®¤è¯ï¼Œåªå…è®¸è¢«è®¸å¯çš„ç”¨æˆ·æ‰èƒ½è¿›å…¥é›†ç¾¤å†…éƒ¨ï¼Œè®¤è¯å¤±è´¥è¿”å›ž 401ã€‚<br />éµå¾ªâ€œæˆ–â€é€»è¾‘,ä¸”ä»»ä½•ä¸€ä¸ªæ’ä»¶æ ¸éªŒæˆåŠŸåŽéƒ½å°†ä¸å†è¿›è¡ŒåŽç»­çš„æ’ä»¶éªŒè¯<br />å‰é¢çš„æ’ä»¶æ£€æŸ¥å¤±è´¥,åˆ™æ£€æŸ¥ä¸‹ä¸€ä¸ªæ’ä»¶,å¦‚é‡Œéƒ½ä¸æˆåŠŸ,æ‰å¤±è´¥,æˆ–ä»¥åŒ¿åèº«ä»½è®¿ é—® |
| æŽˆæƒ(Authz)          | ä¸åŒç”¨æˆ·èŽ·å–ä¸åŒçš„èµ„æºæ“ä½œæƒé™ï¼Œæ¯”å¦‚æ™®é€šç”¨æˆ·ã€è¶…çº§ç”¨æˆ·ç­‰ã€‚æƒé™ä¸è¶³è¿” å›ž403<br />é‰´æƒè¿‡ç¨‹éµå¾ªâ€œæˆ–â€é€»è¾‘ï¼Œä¸”ä»»ä½•ä¸€ä¸ªæ’ä»¶å¯¹æ“ä½œçš„è®¸å¯æŽˆæƒåŽéƒ½å°†ä¸å†è¿›è¡ŒåŽ ç»­çš„æ’ä»¶éªŒè¯<br />å¦‚æžœéƒ½æœªè®¸å¯,åˆ™æ‹’ç»è¯·æ±‚ |
| å‡†å…¥æŽ§åˆ¶ (Admission) | ç”¨æˆ·è®¤è¯ã€æŽˆæƒä¹‹åŽï¼Œå½“è¿›è¡Œä¸€äº›å†™æ“ä½œçš„æ—¶å€™ï¼Œéœ€è¦éµå¾ªçš„ä¸€äº›é™åˆ¶çš„è¦ æ±‚,æ¯”å¦‚èµ„æºé™åˆ¶<br />å†…å®¹åˆè§„æ€§æ£€æŸ¥ï¼Œéµå¾ªâ€œä¸Žâ€é€»è¾‘ï¼Œä¸”æ— è®ºæˆè´¥ï¼Œæ¯æ¬¡æ“ä½œéƒ½è¦ç»ç”±æ‰€æœ‰æ’ä»¶æ£€ éªŒ,æœ€åŽç»Ÿä¸€è¿”å›žç»“æžœ<br />åªå¯¹å†™æ“ä½œè¿›è¡Œåˆè§„æ€§æ£€æŸ¥ï¼Œåœ¨æŽˆæƒèŒƒå›´å†…ï¼Œå¯¹ç”¨æˆ·çš„æŸäº›å‘½ä»¤æˆ–è€…æ“ä½œè¿›è¡Œ è¿›ä¸€æ­¥çš„é™åˆ¶<br />åˆ†ä¸ºä¸¤ç±»: validaing æ ¡éªŒ(åˆè§„æ€§,èµ„æºé»˜è®¤å’Œæœ€å¤§å’Œæœ€å°é™åˆ¶)å’Œ mutating å˜ æ›´(è¡¥å…¨,é»˜è®¤å€¼å¡«å……) |



![image-20250106182813464](D:\git_repository\cyber_security_learning\markdown_img\image-20250106182813464.png)



### è®¤è¯æœºåˆ¶

ä¸»è¦æ¶‰åŠåˆ°**ç”¨æˆ·å¸å·UA**å’Œ**æœåŠ¡å¸å·SA**çš„è®¤è¯å†…å®¹



#### è®¤è¯æœºåˆ¶è¯´æ˜Ž

æ‰€æœ‰ Kubernetes é›†ç¾¤éƒ½æœ‰**ä¸¤ç±»ç”¨æˆ·**ï¼šç”± Kubernetes ç®¡ç†çš„**æœåŠ¡è´¦å·**å’Œ**æ™®é€šç”¨æˆ·**ã€‚

åœ¨ Kubernetes ä¸­ï¼Œ**subject** æ˜¯æŒ‡ä¸€ä¸ªå¯¹è±¡æˆ–å®žä½“ï¼Œè¯¥å¯¹è±¡æˆ–å®žä½“å¯ä»¥**æ˜¯ç”¨æˆ·ã€æœåŠ¡å¸æˆ·ã€ç»„æˆ–å…¶ä»–å¯è¯†åˆ«çš„å®žä½“**ã€‚å®ƒåœ¨æŽˆæƒç­–ç•¥ä¸­ç”¨äºŽæ ‡è¯†å“ªäº›å®žä½“è¢«å…è®¸æˆ–è¢«æ‹’ç»è®¿é—®èµ„æºã€‚ç®€è€Œè¨€ä¹‹ï¼Œ**subject å°±æ˜¯éœ€è¦è¢«æŽˆæƒè®¿é—®èµ„æºçš„å®žä½“**ã€‚è®¤è¯ç”¨æˆ·å³å±žäºŽSubject



åœ¨Kubernetesé›†ç¾¤ä¸­å®šä¹‰äº†**ä¸¤ç§ç±»åž‹çš„subjectèµ„æºçš„è®¤è¯ç”¨æˆ·**ï¼š

| ç”¨æˆ·ç§ç±»        | è§£æž                                                         |
| --------------- | ------------------------------------------------------------ |
| User Account    | ç”¨æˆ·è´¦æˆ·ï¼ŒæŒ‡éžPodç±»çš„å®¢æˆ·ç«¯è®¿é—®API Serveræ—¶ä½¿ç”¨çš„èº«ä»½æ ‡è¯†ï¼Œä¸€èˆ¬æ˜¯çŽ°å®žä¸­çš„ â€œäººâ€<br />API Serveræ²¡æœ‰ä¸ºè¿™ç±»è´¦æˆ·æä¾›ä¿å­˜å…¶ä¿¡æ¯çš„èµ„æºç±»åž‹ï¼Œ**ç›¸å…³çš„ä¿¡æ¯é€šå¸¸ä¿å­˜äºŽå¤–éƒ¨çš„æ–‡ä»¶æˆ–è®¤è¯ç³»ç»Ÿä¸­**,ç”±å¤–éƒ¨ç‹¬ç«‹æœåŠ¡è¿›è¡Œç®¡ç†ï¼Œæ‰€ä»¥ç”¨æˆ·ä¸èƒ½é€šè¿‡é›†ç¾¤å†…éƒ¨çš„ API æ¥ è¿›è¡Œç®¡ç†ã€‚<br />èº«ä»½æ ¸éªŒæ“ä½œå¯ç”±API Serverè¿›è¡Œï¼Œä¹Ÿå¯èƒ½æ˜¯ç”±å¤–éƒ¨èº«ä»½è®¤è¯æœåŠ¡å®Œæˆ ä½œç”¨åŸŸä¸ºæ•´ä¸ªé›†ç¾¤çº§åˆ«,å¸¸è§çš„ç®¡ç†æ–¹å¼ï¼Œå¦‚ï¼š opensslç­‰ |
| Service Account | ervice Accountsï¼ˆSAï¼‰åœ¨ Kubernetes ä¸­æ˜¯ä¸€ç§å†…å»ºçš„ã€ä¸Ž Pod å…³è”çš„è´¦å·ç±»åž‹ã€‚ å®ƒä»¬ä¸»è¦æ˜¯ä¸ºäº†åœ¨Podä¸­è¿è¡Œçš„è¿›ç¨‹æä¾›ä¸€ä¸ªèº«ä»½æ ‡è¯†ï¼Œä»¥ä¾¿è®¿é—® Kubernetes API é€šè¿‡Kubernetes API æ¥ç®¡ç†çš„ç”¨æˆ·å¸å·ï¼Œé€‚ç”¨äºŽé›†ç¾¤ä¸­Podå†…çš„è¿›ç¨‹è®¿é—®API Server æ—¶ä½¿ç”¨çš„èº«ä»½ä¿¡æ¯ï¼Œéœ€è¦é€šè¿‡ API æ¥å®Œæˆæƒé™è®¤è¯<br />API Serverä½¿ç”¨ServiceAccountç±»åž‹çš„èµ„æºå¯¹è±¡æ¥ä¿å­˜è¯¥ç±»è´¦å·<br />è®¤è¯åˆ°API Serverçš„è®¤è¯ä¿¡æ¯ç§°ä¸º**Service Account Token**ï¼Œå®ƒä»¬**ä¿å­˜äºŽåŒåçš„ä¸“ç”¨ç±»åž‹çš„Secretå¯¹è±¡ä¸­**<br />åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œæƒé™æ“ä½œï¼Œéƒ½éœ€è¦ä½¿ç”¨åˆ° ServiceAccount<br />**namespace åˆ«çº§çš„èµ„æºç±»åž‹,å³å¸å·éš¶å±žäºŽåç§°ç©ºé—´,ä½†å¯ä»¥æŽˆäºˆé›†ç¾¤çº§åˆ«çš„æƒé™** |
| åŒ¿åç”¨ æˆ·       | ä¸èƒ½è¢«è¯†åˆ«ä¸ºService Accountï¼Œä¹Ÿä¸èƒ½è¢«è¯†åˆ«ä¸ºUser Accountçš„ç”¨æˆ·ï¼Œå³â€œåŒ¿åç”¨æˆ·" |

å°½ç®¡æ— æ³•é€šè¿‡ API è°ƒç”¨æ¥æ·»åŠ æ™®é€šç”¨æˆ·ï¼Œ Kubernetes ä»ç„¶è®¤ä¸º**èƒ½å¤Ÿæä¾›**ç”±é›†ç¾¤çš„è¯ä¹¦æœºæž„ç­¾åçš„**åˆæ³•è¯ä¹¦**çš„**ç”¨æˆ·**æ˜¯**é€šè¿‡èº«ä»½è®¤è¯çš„ç”¨æˆ·**ã€‚ åŸºäºŽè¿™æ ·çš„é…ç½®**ï¼ŒKubernetes ä½¿ç”¨è¯ä¹¦ä¸­çš„ 'subject' çš„é€šç”¨åç§°** ï¼ˆCommon Nameï¼‰**å­—æ®µ** ï¼ˆä¾‹å¦‚ï¼Œ"/CN=bob"ï¼‰**æ¥ç¡®å®šç”¨æˆ·å**ã€‚ æŽ¥ä¸‹æ¥ï¼Œ**åŸºäºŽè§’è‰²è®¿é—®æŽ§åˆ¶**ï¼ˆRBACï¼‰ å­ç³»ç»Ÿä¼š**ç¡®å®šç”¨æˆ·æ˜¯å¦æœ‰æƒé’ˆå¯¹æŸèµ„æºæ‰§è¡Œç‰¹å®šçš„æ“ä½œ**ã€‚



##### ç”¨æˆ·ç»„

åœ¨kubernetesé›†ç¾¤ä¸­ï¼Œä¸ºäº†æ›´æ–¹ä¾¿çš„å¯¹æŸä¸€ç±»ç”¨æˆ·å¸å·UAè¿›è¡Œæ–¹ä¾¿ç®¡ç†ï¼Œä¸€èˆ¬ä¼šé€šè¿‡ç”¨æˆ·ç»„çš„æ–¹å¼æ¥è¿›è¡Œç®¡ç†

æ³¨æ„: Kubernetes ä¸æ”¯æŒå°†ä¸€ä¸ªSAæœåŠ¡å¸æˆ·åŠ å…¥ä¸€ä¸ªæŒ‡å®šçš„ç»„ä¸­,ä½†æ˜¯å¯ä»¥é€šè¿‡RBACæœºåˆ¶åˆ›å»ºä¸€ä¸ªæŽˆæƒ çš„è§’è‰²,å†å°†æœåŠ¡å¸æˆ·å’Œè§’è‰²ç»‘å®šå®žçŽ°ã€‚

Kuberneteså¸¸è§çš„å†…ç½®ç”¨æˆ·ç»„æœ‰ä»¥ä¸‹å››ç±»ï¼š

| ç”¨æˆ·ç»„                              | è§£æž                                                         |
| ----------------------------------- | ------------------------------------------------------------ |
| system:unauthenticated              | æœªèƒ½é€šè¿‡ä»»ä½•ä¸€ä¸ªæŽˆæƒæ’ä»¶æ£€éªŒçš„è´¦å·çš„æ‰€æœ‰æœªé€šè¿‡è®¤è¯æµ‹è¯•çš„ç”¨æˆ· ç»Ÿä¸€éš¶å±žçš„ç”¨æˆ·ç»„ |
| system:authenticated                | è®¤è¯æˆåŠŸåŽçš„ç”¨æˆ·è‡ªåŠ¨åŠ å…¥çš„ä¸€ä¸ªä¸“ç”¨ç»„ï¼Œç”¨äºŽå¿«æ·å¼•ç”¨æ‰€æœ‰æ­£å¸¸é€š è¿‡è®¤è¯çš„ç”¨æˆ·è´¦å· |
| system:serviceaccounts              | æ‰€æœ‰åç§°ç©ºé—´ä¸­çš„æ‰€æœ‰ServiceAccountå¯¹è±¡                       |
| system:serviceaccounts: <namespace> | ç‰¹å®šåç§°ç©ºé—´å†…æ‰€æœ‰çš„ServiceAccountå¯¹è±¡                       |

Kubernetesæœ¬èº«å¹¶æ²¡æœ‰å¯¹ç”¨æˆ·æˆ–ç”¨æˆ·ç»„çš„å†…å»ºæ¦‚å¿µæˆ–å®žä½“ã€‚

åœ¨**Kubernetesä¸­**ï¼Œ**ç”¨æˆ·å’Œç»„æ˜¯åœ¨èº«ä»½æä¾›è€…**ï¼ˆå¦‚OpenID Connectï¼ŒActive Directoryç­‰ï¼‰**ä¸­åˆ›å»ºå’Œç®¡ç† çš„**ï¼Œ**è€Œä¸æ˜¯åœ¨Kubernetesé›†ç¾¤è‡ªèº«ä¸­åˆ›å»º**ã€‚æ‰€ä»¥ï¼Œæ— æ³•ç›´æŽ¥åœ¨Kubernetesä¸­åˆ›å»ºç»„ã€‚

åœ¨Kubernetesä¸­ï¼Œç”¨æˆ·å’Œç”¨æˆ·ç»„ä¸»è¦åœ¨**è®¤è¯ (Authentication)** å’Œ**æŽˆæƒ (Authorization)** çŽ¯èŠ‚ä¸­å‘æŒ¥ä½œç”¨ã€‚

**è¿™å°±æ„å‘³ç€åœ¨Kubernetesä¸­æ²¡æœ‰ç›´æŽ¥çš„æ–¹å¼åŽ»æŸ¥çœ‹ç”¨æˆ·æˆ–ç”¨æˆ·ç»„**

å¦‚æžœæƒ³è¦æŸ¥çœ‹å½“å‰Kubernetesé›†ç¾¤ä¸­çš„ç”¨æˆ·å’Œç”¨æˆ·ç»„ï¼Œé€šå¸¸éœ€è¦æŸ¥çœ‹çš„æ˜¯**å¤–éƒ¨èº«ä»½æä¾›å•†çš„è®¾ç½®**æˆ–**Kubeconfigæ–‡ä»¶**ã€‚åŒæ—¶ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹åœ¨Kubernetesä¸­å®šä¹‰çš„RBACç­–ç•¥ï¼Œä»¥ç†è§£å“ªäº›ç”¨æˆ·å’Œç”¨æˆ·ç»„æœ‰ æƒè®¿é—®ç‰¹å®šèµ„æºã€‚

åœ¨Kubernetesä¸­ï¼Œ**æœåŠ¡å¸æˆ·(ServiceAccount)**é»˜è®¤ä¼šè¢«æ”¾å…¥ä¸¤ä¸ªç»„ä¹‹ä¸€ï¼š **system:serviceaccounts ï¼ˆ**è¡¨ç¤ºé›†ç¾¤ä¸­çš„æ‰€æœ‰æœåŠ¡å¸æˆ·ï¼‰å’Œ **system:serviceaccounts: `<namespace>`**ï¼ˆè¡¨ç¤ºç»™å®šå‘½åç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡å¸æˆ·ï¼‰ã€‚è¿™äº›æ˜¯å†…ç½®çš„ç»„ã€‚



**èŒƒä¾‹ï¼šæŸ¥çœ‹ç”¨æˆ·ç»„`system:master`çš„æƒé™**

```bash
#æ‰€æœ‰çš„k8sé›†ç¾¤èµ„æºæ“ä½œï¼Œå…¶å®žéƒ½æ˜¯é€šè¿‡nodeèŠ‚ç‚¹ä¸Šçš„kubeletå’ŒmasterèŠ‚ç‚¹ä¸Šçš„apiserverä¹‹é—´çš„é€šä¿¡å®žçŽ°ï¼Œè€Œåœ¨kubernetesçš„è®¤è¯ç›®å½•ä¸­æœ‰å…¶ä¸“ç”¨çš„é€šä¿¡è®¤è¯è¯ä¹¦ apiserver-kubelet-client.crtï¼Œå¯ä»¥é€šè¿‡è¯¥æ–‡ä»¶æ¥æ£€æŸ¥ä¸€ä¸‹è¿™ä¸¤è€…ä¹‹é—´æ˜¯ä¸€ä¸ªæ€Žæ ·çš„å…³ç³»ã€‚

# æ–°ç‰ˆ
[root@master1 pki]#openssl x509 -in /etc/kubernetes/pki/apiserver-kubelet-client.crt -text -noout
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number: 8841619138675744303 (0x7ab3bdc300101e2f)
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN = kubernetes
        Validity
            Not Before: Jan  4 01:39:06 2025 GMT
            Not After : Jan  4 01:44:06 2026 GMT
            # ä¸‹é¢Organizationçš„å€¼ä¸ºkubeadm: cluster-adminsï¼Œæ„æ€æ˜¯å°†è¯¥ç”¨æˆ·åŠ å…¥ç»„cluster-adminsä¸­
            # ä¸‹é¢æœ‰ä¸ºä»€ä¹ˆcluster-adminsæœ‰æ‰€æœ‰æƒé™
        Subject: O = kubeadm:cluster-admins, CN = kube-apiserver-kubelet-client
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                Modulus:
                ......
                
# æŸ¥çœ‹é›†ç¾¤è§’è‰²æƒé™
[root@master1 pki]#kubectl get clusterrole cluster-admin -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2025-01-04T01:44:14Z"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin     # ç»™é›†ç¾¤è§’è‰²cluster-adminå…¨éƒ¨æƒé™ï¼Œä¸‹é¢éƒ½æ˜¯*ï¼Œå°±è¡¨ç¤ºæŽˆäºˆæ‰€æœ‰æƒé™
  resourceVersion: "74"
  uid: 7defd096-536a-4bd1-890c-e496d1c5f35e
rules:
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - '*'
- nonResourceURLs:
  - '*'
  verbs:
  - '*'

# æŸ¥çœ‹roleè§’è‰²cluster-adminåŒåçš„clusterrolebindingï¼Œåˆ†é…æƒé™ç»™kubeadm:cluster-adminsç»„
[root@master1 pki]# kubectl get clusterrolebinding kubeadm:cluster-admins -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  creationTimestamp: "2025-01-04T01:44:15Z"
  name: kubeadm:cluster-admins
  resourceVersion: "204"
  uid: c0010b58-45ce-4d63-a0b4-e1a1632f3977
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin   # å°†è¿™ä¸ªæ‹¥æœ‰å…¨éƒ¨æƒé™çš„è§’è‰²ï¼Œèµ‹äºˆä¸‹é¢çš„ç»„kubeadm:cluster-admins
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: kubeadm:cluster-admins   # å› æ­¤è¿™é‡Œè¿™ä¸ªç»„cluster-adminsæœ‰å…¨éƒ¨æƒé™

```



##### è®¤è¯æ’ä»¶

Kubernetes é€šè¿‡èº«ä»½è®¤è¯æ’ä»¶åˆ©ç”¨**å®¢æˆ·ç«¯è¯ä¹¦**ã€**æŒæœ‰è€…ä»¤ç‰Œï¼ˆBearer Tokenï¼‰**æˆ–**èº«ä»½è®¤è¯ä»£ç† ï¼ˆProxyï¼‰** æ¥è®¤è¯ API è¯·æ±‚çš„èº«ä»½ã€‚

kubernetesæä¾›äº†å¤šç§è®¤è¯æ–¹å¼ï¼Œå¯ä»¥åŒæ—¶ä½¿ç”¨ä¸€ç§æˆ–å¤šç§è®¤è¯æ–¹å¼ï¼Œåªè¦é€šè¿‡ä»»ä½•ä¸€ä¸ªæˆåŠŸå³è¢«è®¤ä½œ æ˜¯è®¤è¯é€šè¿‡ã€‚å³æˆ–å…³ç³»



**å¸¸è§çš„è®¤è¯æ–¹å¼å¦‚ä¸‹ï¼š**

| è®¤è¯æ–¹å¼            | è§£æž                                                         |
| ------------------- | ------------------------------------------------------------ |
| X509 å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯ | TLSåŒå‘è®¤è¯ï¼Œå®¢æˆ·ç«¯æŒæœ‰æ•°å­—è¯ä¹¦,API Serverä¿¡ä»»å®¢æˆ·ç«¯è¯ä¹¦çš„é¢å‘è€….å³æœåŠ¡å™¨å®¢æˆ· ç«¯äº’ç›¸éªŒè¯<br />**ä¿¡ä»»çš„CA**éœ€è¦åœ¨kube-apiserverå¯åŠ¨æ—¶,é€šè¿‡**--client-ca-fileé€‰é¡¹æŒ‡å®š**.<br />è¯ä¹¦ä¸­çš„Subjectä¸­çš„ **CN(CommonName)å³è¢«è¯†åˆ«ä¸ºç”¨æˆ·å**ï¼Œè€Œ**Oï¼ˆOrganizationï¼‰ è¢«è¯†åˆ«ä¸ºç»„å**<br />å¯¹äºŽè¿™ç§å®¢æˆ·çš„è´¦å·ï¼Œk8sæ˜¯æ— æ³•ç®¡ç†çš„ã€‚ä¸ºäº†ä½¿ç”¨è¿™ä¸ªæ–¹æ¡ˆï¼Œapi-serveréœ€è¦ç”¨-- client-ca-fileã€--tls-private-key-fileã€--tls-cert-fileé€‰é¡¹æ¥å¼€å¯ã€‚<br />kubeadméƒ¨ç½²çš„Kubernetesé›†ç¾¤ï¼Œé»˜è®¤ä½¿ç”¨ **/etc/kubernetes/pki/ca.crt** è¿›è¡Œå®¢æˆ·ç«¯è®¤è¯,æ­¤æ–‡ä»¶æ˜¯kubeadmä¸ºKuberneteså„ç»„ä»¶é—´é¢å‘æ•°å­—è¯ä¹¦çš„**æ ¹CA** |
| ä»¤ç‰Œè®¤è¯ (Token)    | åœ¨èŠ‚ç‚¹æ•°é‡éžå¸¸å¤šçš„æ—¶å€™ï¼Œå¤§é‡æ‰‹åŠ¨é…ç½®TLSè®¤è¯æ¯”è¾ƒéº»çƒ¦ï¼Œå¯ä»¥**é€šè¿‡åœ¨api-serverå¼€ å¯ experimental-bootstrap-token-auth ç‰¹æ€§**ï¼Œ**é€šè¿‡å¯¹å®¢æˆ·ç«¯çš„å’Œk8så¹³å°é¢„å…ˆå®šä¹‰çš„ tokenä¿¡æ¯è¿›è¡ŒåŒ¹é…**ï¼Œ**è®¤è¯é€šè¿‡åŽï¼Œè‡ªåŠ¨ä¸ºèŠ‚ç‚¹é¢å‘è¯ä¹¦**ï¼Œå¯ä»¥å¤§å¤§å‡è½»å·¥ä½œé‡ï¼Œè€Œä¸” åº”ç”¨åœºæ™¯éžå¸¸å¹¿ã€‚<br />åŒ…æ‹¬: Service Account ä»¤ç‰Œ,é™æ€ä»¤ç‰Œæ–‡ä»¶,Bootstrapä»¤ç‰Œ,OIDC(OpenID Connect)ä»¤ ç‰Œ,Webhook ä»¤ç‰Œ ç­‰ |
| ä»£ç†è®¤è¯            | ä¸€èˆ¬å€ŸåŠ©äºŽä¸­é—´ä»£ç†çš„æ–¹å¼æ¥è¿›è¡Œç»Ÿç”¨çš„è®¤è¯æ–¹å¼ï¼Œæ ·å¼ä¸å›ºå®š     |
| åŒ¿å                | æ— æ³•è®¤è¯çš„å…¶å®ƒè¯·æ±‚                                           |



**API Serverå¯ç”¨çš„èº«ä»½è®¤è¯æœºåˆ¶**

- åŸºäºŽè®¤è¯æ’ä»¶æ”¯æŒå¤šç§è®¤è¯æ–¹å¼ï¼Œè€Œç›¸åº”è®¤è¯æ’ä»¶çš„å¯ç”¨éœ€è¦ç»ç”±kube-apiserverä¸Šçš„ä¸“ç”¨é€‰é¡¹å®Œæˆ
- kubeadm éƒ¨ç½²çš„é›†ç¾¤é»˜è®¤å¯ç”¨çš„è®¤è¯æœºåˆ¶åŒ…æ‹¬å¦‚ä¸‹å‡ ç§
  - X509å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
  - Bootstrapä»¤ç‰Œè®¤è¯
  - å‰ç«¯ä»£ç†èº«ä»½è®¤è¯ front-proxy
  - Service Account ä»¤ç‰Œ
- æ³¨æ„ï¼šAPI Serverå¹¶ä¸ä¿è¯å„è®¤è¯æ’ä»¶çš„ç”Ÿæ•ˆæ¬¡åºä¸Žå®šä¹‰çš„æ¬¡åºç›¸åŒ



**èŒƒä¾‹: æŸ¥çœ‹API Server çš„è®¤è¯æœºåˆ¶**

```bash
#åœ¨MasterèŠ‚æŸ¥çœ‹è®¤è¯æœºåˆ¶
[root@master1 pki] # cat /etc/kubernetes/manifests/kube-apiserver.yaml 
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 10.0.0.201:6443
  creationTimestamp: null
  labels:
    component: kube-apiserver
    tier: control-plane
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    - --advertise-address=10.0.0.201
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC
    - --client-ca-file=/etc/kubernetes/pki/ca.crt             # x509å®¢æˆ·ç«¯è®¤è¯ï¼Œæ­¤CAé¢å‘çš„è¯ä¹¦å¯¹åº”çš„ç”¨æˆ·æ˜¯åˆæ³•ç”¨æˆ·
    - --enable-admission-plugins=NodeRestriction
    - --enable-bootstrap-token-auth=true                      # Bootstrap ä»¤ç‰Œè®¤è¯
    - --etcd-cafile=/etc/kubernetes/pki/etcd/ca.crt
    - --etcd-certfile=/etc/kubernetes/pki/apiserver-etcd-client.crt
    - --etcd-keyfile=/etc/kubernetes/pki/apiserver-etcd-client.key
    - --etcd-servers=https://127.0.0.1:2379
    - --kubelet-client-certificate=/etc/kubernetes/pki/apiserver-kubelet-client.crt
    - --kubelet-client-key=/etc/kubernetes/pki/apiserver-kubelet-client.key
    - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname
    - --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.crt     # èº«ä»½è®¤è¯ä»£ç†
    - --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client.key      # èº«ä»½è®¤è¯ä»£ç†
    - --requestheader-allowed-names=front-proxy-client                        # èº«ä»½è®¤è¯ä»£ç†
    - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.crt   # èº«ä»½è®¤è¯ä»£ç†
    - --requestheader-extra-headers-prefix=X-Remote-Extra-                    # èº«ä»½è®¤è¯ä»£ç†
    - --requestheader-group-headers=X-Remote-Group                            # èº«ä»½è®¤è¯ä»£ç†
    - --requestheader-username-headers=X-Remote-User                          # èº«ä»½è®¤è¯ä»£ç†
    - --secure-port=6443
    - --service-account-issuer=https://kubernetes.default.svc.cluster.local   # SAè®¤è¯
    - --service-account-key-file=/etc/kubernetes/pki/sa.pub                   # SAè®¤è¯
    - --service-account-signing-key-file=/etc/kubernetes/pki/sa.key           # SAè®¤è¯
    - --service-cluster-ip-range=10.96.0.0/12
    - --tls-cert-file=/etc/kubernetes/pki/apiserver.crt
    - --tls-private-key-file=/etc/kubernetes/pki/apiserver.key
    image: registry.aliyuncs.com/google_containers/kube-apiserver:v1.30.2
    imagePullPolicy: IfNotPresent
    livenessProbe:
      failureThreshold: 8
      httpGet:
        host: 10.0.0.201
        path: /livez
        port: 6443
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    name: kube-apiserver
    readinessProbe:
      failureThreshold: 3
      httpGet:
        host: 10.0.0.201
        path: /readyz
        port: 6443
        scheme: HTTPS
      periodSeconds: 1
      timeoutSeconds: 15
    resources:
      requests:
        cpu: 250m
    startupProbe:
      failureThreshold: 24
      httpGet:
        host: 10.0.0.201
        path: /livez
        port: 6443
        scheme: HTTPS
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 15
    volumeMounts:
    - mountPath: /etc/ssl/certs
      name: ca-certs
      readOnly: true
    - mountPath: /etc/ca-certificates
      name: etc-ca-certificates
      readOnly: true
    - mountPath: /etc/pki
      name: etc-pki
      readOnly: true
    - mountPath: /etc/kubernetes/pki
      name: k8s-certs
      readOnly: true
    - mountPath: /usr/local/share/ca-certificates
      name: usr-local-share-ca-certificates
      readOnly: true
    - mountPath: /usr/share/ca-certificates
      name: usr-share-ca-certificates
      readOnly: true
  hostNetwork: true
  priority: 2000001000
  priorityClassName: system-node-critical
  securityContext:
    seccompProfile:
      type: RuntimeDefault
  volumes:
  - hostPath:
      path: /etc/ssl/certs
      type: DirectoryOrCreate
    name: ca-certs
  - hostPath:
      path: /etc/ca-certificates
      type: DirectoryOrCreate
    name: etc-ca-certificates
  - hostPath:
      path: /etc/pki
      type: DirectoryOrCreate
    name: etc-pki
  - hostPath:
      path: /etc/kubernetes/pki
      type: DirectoryOrCreate
    name: k8s-certs
  - hostPath:
      path: /usr/local/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-local-share-ca-certificates
  - hostPath:
      path: /usr/share/ca-certificates
      type: DirectoryOrCreate
    name: usr-share-ca-certificates
status: {}
```



**Kubeletå¯ç”¨çš„èº«ä»½è®¤è¯æœºåˆ¶**

- kubeletçš„REST APIç«¯ç‚¹é»˜è®¤é€šè¿‡TCPåè®®çš„10250ç«¯å£æä¾›ï¼Œæ”¯æŒç®¡ç†æ“ä½œ

| Kubelet API | åŠŸèƒ½ç®€ä»‹                   |
| ----------- | -------------------------- |
| /pods       | åˆ—å‡ºå½“å‰kubeletèŠ‚ç‚¹ä¸Šçš„Pod |
| /run        | åœ¨ä¸€ä¸ªå®¹å™¨å†…è¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ |
| /exec       | åœ¨ä¸€ä¸ªå®¹å™¨å†…è¿è¡ŒæŒ‡å®šçš„å‘½ä»¤ |
| /configz    | è®¾ç½®Kubeletçš„é…ç½®æ–‡ä»¶å‚æ•°  |
| /debug      | è°ƒè¯•ä¿¡æ¯                   |

- éœ€è¦å¯¹å®¢æˆ·ç«¯èº«ä»½è¿›è¡Œè®¤è¯
- å¯ç”¨çš„èº«ä»½è®¤è¯:webhook,x509å®¢æˆ·ç«¯è¯ä¹¦è®¤è¯
  - æ³¨æ„ï¼šå»ºè®®æ˜¾å¼ç¦ç”¨åŒ¿åç”¨æˆ·
- API Serveræ˜¯è¯¥APIç«¯ç‚¹çš„å®¢æˆ·ç«¯ï¼Œå› æ­¤ï¼Œkubeletéœ€è¦åœ¨éªŒè¯å®¢æˆ·ç«¯èº«ä»½æ—¶ä¿¡ä»»ç»™API Serveré¢å‘æ•°å­—è¯ä¹¦çš„CA



**èŒƒä¾‹ï¼šæŸ¥çœ‹Kubeletçš„è®¤è¯æœºåˆ¶**

```yaml
#åœ¨æ¯ä¸ªworkerèŠ‚ç‚¹æŸ¥çœ‹
[root@node1 pki] # cat /var/lib/kubelet/config.yaml 
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false                             # åŒ¿åè®¤è¯ï¼Œtrueä¸ºå…è®¸åŒ¿åè®¿é—®ï¼Œä½†æ˜¯æƒé™ä¸è¶³
  webhook:
    cacheTTL: 0s                               # webhookè®¤è¯
    enabled: true
  x509:
    clientCAFile: /etc/kubernetes/pki/ca.crt   # è¯ä¹¦è®¤è¯
authorization:
  mode: Webhook
  webhook:
    cacheAuthorizedTTL: 0s
    cacheUnauthorizedTTL: 0s
cgroupDriver: systemd
clusterDNS:
- 10.96.0.10
clusterDomain: cluster.local
containerRuntimeEndpoint: ""
cpuManagerReconcilePeriod: 0s
evictionPressureTransitionPeriod: 0s
fileCheckFrequency: 0s
healthzBindAddress: 127.0.0.1
healthzPort: 10248
httpCheckFrequency: 0s
imageMaximumGCAge: 0s
imageMinimumGCAge: 0s
kind: KubeletConfiguration
logging:
  flushFrequency: 0
  options:
    json:
      infoBufferSize: "0"
    text:
      infoBufferSize: "0"
  verbosity: 0
memorySwap: {}
nodeStatusReportFrequency: 0s
nodeStatusUpdateFrequency: 0s
resolvConf: /run/systemd/resolve/resolv.conf
rotateCertificates: true
runtimeRequestTimeout: 0s
shutdownGracePeriod: 0s
shutdownGracePeriodCriticalPods: 0s
staticPodPath: /etc/kubernetes/manifests
streamingConnectionIdleTimeout: 0s
syncFrequency: 0s
volumeStatsAggPeriod: 0s

#å¦‚æžœä¿®æ”¹,ä¸å»ºè®®ä¿®æ”¹/var/lib/kubelet/config.yamlé…ç½®æ–‡ä»¶,è€Œé€šè¿‡ä¿®æ”¹å¯¹åº”çš„configmapå®žçŽ°
[root@master1 pki]#kubectl get -n kube-system cm kubelet-config -o yaml
apiVersion: v1
data:
  kubelet: |
    apiVersion: kubelet.config.k8s.io/v1beta1
    authentication:
      anonymous:
        enabled: false
      webhook:
        cacheTTL: 0s
        enabled: true
      x509:
        clientCAFile: /etc/kubernetes/pki/ca.crt
    authorization:
      mode: Webhook
      webhook:
        cacheAuthorizedTTL: 0s
        cacheUnauthorizedTTL: 0s
    cgroupDriver: systemd
    clusterDNS:
    - 10.96.0.10
    clusterDomain: cluster.local
    containerRuntimeEndpoint: ""
    cpuManagerReconcilePeriod: 0s
    evictionPressureTransitionPeriod: 0s
    fileCheckFrequency: 0s
    healthzBindAddress: 127.0.0.1
    healthzPort: 10248
    httpCheckFrequency: 0s
    imageMaximumGCAge: 0s
    imageMinimumGCAge: 0s
    kind: KubeletConfiguration
    logging:
      flushFrequency: 0
      options:
        json:
          infoBufferSize: "0"
        text:
          infoBufferSize: "0"
      verbosity: 0
    memorySwap: {}
    nodeStatusReportFrequency: 0s
    nodeStatusUpdateFrequency: 0s
    resolvConf: /run/systemd/resolve/resolv.conf
    rotateCertificates: true
    runtimeRequestTimeout: 0s
    shutdownGracePeriod: 0s
    shutdownGracePeriodCriticalPods: 0s
    staticPodPath: /etc/kubernetes/manifests
    streamingConnectionIdleTimeout: 0s
    syncFrequency: 0s
    volumeStatsAggPeriod: 0s
kind: ConfigMap
metadata:
  annotations:
    kubeadm.kubernetes.io/component-config.hash: sha256:14a463ee2caafeaa2b6d58bb8c225fb8e9e4509ed1a77d8c55a943bc7d89f7ac
  creationTimestamp: "2025-01-04T01:44:15Z"
  name: kubelet-config
  namespace: kube-system
  resourceVersion: "208"
  uid: 4e74f407-d431-4379-9a22-4cd5b9f64916
```



#### X509å®¢æˆ·ç«¯è®¤è¯

Kubernetesé›†ç¾¤ä¸­çš„X509å®¢æˆ·ç«¯è®¤è¯ä¾èµ–äºŽPKIè¯ä¹¦ä½“ç³»,æœ‰å¦‚ä¸‹ä¸‰å¥—CAè¯ä¹¦ç³»ç»Ÿ

![image-20250107194258441](D:\git_repository\cyber_security_learning\markdown_img\image-20250107194258441.png)

kubeadméƒ¨ç½²Kubernetesé›†ç¾¤æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆæ‰€éœ€è¦çš„è¯ä¹¦ï¼Œå®ƒä»¬ä½äºŽ**/etc/kubernetes/pki**è‡ªå½•ä¸‹

| æ–‡ä»¶                                     | Default CN               | è¯´æ˜Ž                           |
| ---------------------------------------- | ------------------------ | ------------------------------ |
| ca.crt,ca.key                            | kubernetes-ca            | Kubernetes general CA          |
| etcd/ca.crt,etcd/ca.key                  | etcd-ca                  | For all etcd-related functions |
| front-proxy-ca.crt,front-proxyca.crt.key | kubernetes-frontproxy-ca | For the front-end proxy        |



**æ¡ˆä¾‹**

#####  **åˆ›å»ºåŸºäºŽX509å®¢æˆ·ç«¯æ™®é€šçš„ç”¨æˆ·è¯ä¹¦**

```ABAP
åŽŸç†ï¼šå®¢æˆ·ç«¯ï¼Œæ— è®ºæ˜¯ä½¿ç”¨kubectlè¿˜æ˜¯curlï¼Œå’ŒapiServeré€šä¿¡ï¼Œå®¢æˆ·ç«¯ä½¿ç”¨çš„è¯ä¹¦æ˜¯apiServeræœåŠ¡ç«¯ä¸Šæœ‰çš„caè¯ä¹¦ç”Ÿæˆçš„ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯ä½¿ç”¨çš„è¯ä¹¦å¯ä»¥è¢«æœåŠ¡ç«¯ä¿¡ä»»ï¼Œå°±è¿™ä¹ˆç®€å•ï¼Œå“ˆå“ˆå“ˆ
```



```bash
# æŸ¥çœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼Œè¡¨ç¤ºé»˜è®¤kubernetesçš„CAç­¾å‘çš„è¯ä¹¦ï¼Œéƒ½æ˜¯k8så®¢æˆ·ç«¯çš„ç”¨æˆ·
[root@master1 kubelet]#grep '\-\-client-ca-file' /etc/kubernetes/manifests/kube-apiserver.yaml 
    - --client-ca-file=/etc/kubernetes/pki/ca.crt

# #åœ¨masterèŠ‚ç‚¹åˆ›å»ºtestç”¨æˆ·è¯ä¹¦
[root@master1 ~]#mkdir pki
[root@master1 pki]#(umask 077; openssl genrsa -out pki/mystical.key 4096)
[root@master1 pki]#ls pki/
mystical.key

# ç”Ÿæˆè¯ä¹¦ç”³è¯·,åŠ å…¥opsç»„åªå…·æœ‰æ™®é€šæƒé™
[root@master1 pki]# openssl req -new -key ./mystical.key -out ./mystical.csr -subj "/CN=mystical/O=ops"
[root@master1 pki]# ls
mystical.csr  mystical.key

#ä½¿ç”¨kubernetes-caé¢å‘è¯ä¹¦
[root@master1 pki]#openssl x509 -req -days 3650 -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -in ./mystical.csr -out ./mystical.crt
Certificate request self-signature ok
subject=CN = mystical, O = ops

# å¤åˆ¶è¯ä¹¦æ–‡ä»¶åˆ°workerèŠ‚ç‚¹
[root@master1 ~]#scp -r pki/ 10.0.0.202:
mystical.key                                        100% 3272     1.7MB/s   00:00    
mystical.csr                                        100% 1602     2.4MB/s   00:00    
mystical.crt                                        100% 1359     2.0MB/s   00:00 

#åœ¨workerèŠ‚ç‚¹ä½¿ç”¨kubectlè®¿é—®ï¼Œæ­£å¸¸æ˜¯æ²¡æœ‰æƒé™çš„
[root@node1 pki]#kubectl get pod
E0107 20:00:19.853410  205917 memcache.go:265] couldn't get current server API group list: Get "http://localhost:8080/api?timeout=32s": dial tcp 127.0.0.1:8080: connect: connection refused

# ä½¿ç”¨åˆšåˆ›å»ºçš„è¯ä¹¦è¿›è¡Œè®¿é—®ï¼Œæ˜¾ç¤ºçš„æ˜¯æ— æƒé™ï¼Œè€Œä¸æ˜¯æ‹’ç»è®¿é—®ï¼Œæ˜¯Forbidden
[root@node1 ~]#kubectl get pod --server=https://10.0.0.201:6443 --client-certificate=pki/mystical.crt --client-key=pki/mystical.key --certificate-authority=/etc/kubernetes/pki/ca.crt
Error from server (Forbidden): pods is forbidden: User "mystical" cannot list resource "pods" in API group "" in the namespace "default"

# æˆ–è€…ä¸‹é¢é€‰é¡¹å¿½ç•¥è¯ä¹¦æ ¡éªŒä¹Ÿå¯ä»¥
[root@node1 ~]#kubectl get pod --server=https://10.0.0.201:6443 --client-certificate=pki/mystical.crt --client-key=pki/mystical.key --insecure-skip-tls-verify=true
Error from server (Forbidden): pods is forbidden: User "mystical" cannot list resource "pods" in API group "" in the namespace "default"

# é€šè¿‡curlä½¿ç”¨è¯ä¹¦è®¿é—®ï¼Œä»æ˜¯æƒé™ä¸è¶³
[root@node1 ~]#curl --cert pki/mystical.crt --key pki/mystical.key --key-type PEM --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.201:6443
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "forbidden: User \"mystical\" cannot get path \"/\"",
  "reason": "Forbidden",
  "details": {},
  "code": 403
}
```



##### åˆ›å»ºåŸºäºŽX509å®¢æˆ·ç«¯ç®¡ç†å‘˜çš„ç”¨æˆ·è¯ä¹¦

```bash
# åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·adminè¯ä¹¦
[root@master1 pki]#(umask 077; openssl genrsa -out ./admin.key 4096)

[root@master1 pki]#ls
admin.key  mystical.crt  mystical.csr  mystical.key

# ç”Ÿæˆè¯ä¹¦ç”³è¯·æ–‡ä»¶ï¼Œæ³¨æ„ï¼šåŠ å…¥system:mastersç»„æˆSystemç»„æ‰å…·æœ‰ç®¡ç†æƒé™
# æ–°ç‰ˆ
[root@master1 pki]#openssl req -new -key ./admin.key -out ./admin.csr -subj "/CN=admin/O=kubeadm:cluster-admins"

[root@master1 pki]#ls
admin.csr  admin.key  mystical.crt  mystical.csr  mystical.key

#æŸ¥çœ‹åˆ°system:mastersç»„è¢«æŽˆæƒClusterRoleè§’è‰²,å…·æœ‰é›†ç¾¤çš„ç®¡ç†æƒé™
#æ–°ç‰ˆ
[root@master1 pki]#kubectl get clusterrolebindings.rbac.authorization.k8s.io kubeadm:cluster-admins -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  creationTimestamp: "2025-01-04T01:44:15Z"
  name: kubeadm:cluster-admins
  resourceVersion: "204"
  uid: c0010b58-45ce-4d63-a0b4-e1a1632f3977
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin            # è¯¥è§’è‰²è¢«èµ‹äºˆäº†æ‰€æœ‰æƒé™
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: kubeadm:cluster-admins   # ç»„
  
# ä½¿ç”¨kubernetes-caé¢å‘è¯ä¹¦
[root@master1 pki]#openssl x509 -req -days 3650 -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -in ./admin.csr -out ./admin.crt
Certificate request self-signature ok
subject=CN = admin, O = kubeadm:cluster-admins

[root@master1 pki]#ls
admin.crt  admin.csr  admin.key  mystical.crt  mystical.csr  mystical.key

# ä¼ ç»™workerèŠ‚ç‚¹
[root@master1 ~]#scp -r pki/ 10.0.0.202:

# workèŠ‚ç‚¹ä½¿ç”¨è¯ä¹¦è®¿é—®æµ‹è¯•
[root@node1 ~]#kubectl get ns -s https://10.0.0.201:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --client-certificate=pki/admin.crt --client-key=pki/admin.key
NAME              STATUS   AGE
default           Active   3d11h
ingress-nginx     Active   3d9h
kube-flannel      Active   3d11h
kube-node-lease   Active   3d11h
kube-public       Active   3d11h
kube-system       Active   3d11h
metallb-system    Active   3d9h

# curlå‘½ä»¤ä½¿ç”¨è¯ä¹¦è®¿é—®
[root@node1 ~]#curl --cert pki/wang.crt --key pki/wang.key --key-type PEM --cacert /etc/kubernetes/pki/ca.crt https://10.0.0.201:6443/api
{
  "kind": "APIVersions",
  "versions": [
    "v1"
  ],
  "serverAddressByClientCIDRs": [
    {
      "clientCIDR": "0.0.0.0/0",
      "serverAddress": "10.0.0.201:6443"
    }
  ]

#æ³¨æ„ï¼šå¦‚æžœåœ¨masterèŠ‚ç‚¹æ‰§è¡Œä¼šå‡ºçŽ°ä¸‹é¢æç¤ºé”™
[root@master1 ~]#kubectl get ns -s https://10.0.0.201:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --client-certificate=pki/wang.crt --client-key=pki/wang.key
Error in configuration: 
* client-cert-data and client-cert are both specified for kubernetes-admin. client-cert-data will override.
* client-key-data and client-key are both specified for kubernetes-admin; client-key-data will override

#æç¤ºé”™è¯¯çš„åŽŸå› :$HOME/.kube/configæ–‡ä»¶è¿˜æœ‰å…¶å®ƒç”¨æˆ·èº«ä»½ï¼Œè§£å†³æ–¹æ³•å¦‚ä¸‹
[root@master1 ~]# mv ~/.kube/config /tmp

#å†æ¬¡æ‰§è¡ŒæˆåŠŸ
[root@master1 ~]#]#kubectl get ns -s https://10.0.0.201:6443 --certificate-authority=/etc/kubernetes/pki/ca.crt --client-certificate=pki/wang.crt --client-key=pki/wang.key
pod-test-6d8c97ff75-qt8zq   1/1     Running   1 (10h ago)   2d
pod-test-6d8c97ff75-rhwkv   1/1     Running   1 (10h ago)   2d
pod-test-6d8c97ff75-tmtl9   1/1     Running   1 (10h ago)   2d
```



##### æ–¹æ³•2ï¼šä½¿ç”¨kubernetesèµ„æºæŽ¥ç®¡CSRè¯ä¹¦ç”³è¯·æ–‡ä»¶

```bash
# åˆ›å»ºç§é’¥
[root@master1 ~]#openssl genrsa -out test2.key 2048

# åˆ›å»ºè¯ä¹¦ç”³è¯·
[root@master1 pki]#openssl req -new -key test2.key -out test2.csr -subj "/CN=test2/O=devops"

# æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯
[root@master1 pki]#cat test2.csr|base64 |tr -d "\n"
LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1pqQ0NBVTRDQVFBd0lURU9NQXdHQTFVRUF3d0ZkR1Z6ZERJeER6QU5CZ05WQkFvTUJtUmxkbTl3Y3pDQwpBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUpoSUFOUzlra2x4ZFVxZjlqanRWZ2VnCm1ibkk1TUFYTjNJMU9WakZpQjd0UlhURzZuQngwOHFjM1lBc0NYcmQ5NFExYlVKbUNJR3Fyd0xVU1N4ZURJRlQKcEwreWR1QjlWdkN2MEhXbHFPbE9FcjNlUGtsV3pheUJpNUhqbUJYYlZrNUpsMlk2L1NZTkdzLzFhZWFFMk1FZApwSlAydTJFSDdqMFVvYVhSNlNVV1hwLzFGYjhkRXAvR2VaM29taFFKaC9uM0dvKzhCSlV5MStVRlF3b1VMMEtKCm05R2tKbnFPUkR4OTQ0RVptRmxKOFg1bXFFbHhkUUg3TGtRcXhpTkY4TitJUmZtdXplVVp6VncrbzFzRGo3STMKY2JrZCsrTGVVVmJkbC9VZThlUlphdHVZTzJZQy9TMk85S2loTWZONXR2K0ZnNjl1Ylc5RkhIK1g2L25XS3JjQwpBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQXFyVlVLR3VWaHdxdjRuZnBsQVV3T0NaSkFNemcwCm5tMVpNYnFUeGM4ZE1BZFFBQTJOcTVOOEhMQzJ4NFhQeDdlUlFGL2hVSUh5SE0wZUNCcTVlV1htTlRlbERkdTUKWTVja1hkbjJOZmVVd0lJMmtNcGxyMXlxam9nTXc3QTIzemVYdHB6R29PbkxvZ1ZkV3Z0c1ludmNIS0hHSUVnWApSRUwwdDRtY0d2UkMrMFFRVjVEd1pBb2FTdnE0d3pzdllQSktFUmNSdzBNT2dzVGZ2ZXBlMW1mWVNYUCtMRUswCkVHYVVaY0tuY3FpTFFLdzY2SzVyU1ZMa25VMDBhcktIUGlvWWNyb0pRYktWN0w5ekMrblFtNHRYNFJDWFRPd2UKZ1QrdFVxTEZHK1hwNDlSUWNvblZhU0tZWjgzVnlHa2lPMjZqWUpOWHJUSUFPYmsrQ1ZJajJQMngKLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==


[root@master1 pki]#cat security-certificaterequests-test2.yaml 
apiVersion: certificates.k8s.io/v1
kind: CertificateSigningRequest
metadata:
  name: test2
spec:
  # request: XXXX...
  requests: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURSBSRVFVRVNULS0tLS0KTUlJQ1pqQ0NBVTRDQVFBd0lURU9NQXdHQTFVRUF3d0ZkR1Z6ZERJeER6QU5CZ05WQkFvTUJtUmxkbTl3Y3pDQwpBU0l3RFFZSktvWklodmNOQVFFQkJRQURnZ0VQQURDQ0FRb0NnZ0VCQUpoSUFOUzlra2x4ZFVxZjlqanRWZ2VnCm1ibkk1TUFYTjNJMU9WakZpQjd0UlhURzZuQngwOHFjM1lBc0NYcmQ5NFExYlVKbUNJR3Fyd0xVU1N4ZURJRlQKcEwreWR1QjlWdkN2MEhXbHFPbE9FcjNlUGtsV3pheUJpNUhqbUJYYlZrNUpsMlk2L1NZTkdzLzFhZWFFMk1FZApwSlAydTJFSDdqMFVvYVhSNlNVV1hwLzFGYjhkRXAvR2VaM29taFFKaC9uM0dvKzhCSlV5MStVRlF3b1VMMEtKCm05R2tKbnFPUkR4OTQ0RVptRmxKOFg1bXFFbHhkUUg3TGtRcXhpTkY4TitJUmZtdXplVVp6VncrbzFzRGo3STMKY2JrZCsrTGVVVmJkbC9VZThlUlphdHVZTzJZQy9TMk85S2loTWZONXR2K0ZnNjl1Ylc5RkhIK1g2L25XS3JjQwpBd0VBQWFBQU1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQXFyVlVLR3VWaHdxdjRuZnBsQVV3T0NaSkFNemcwCm5tMVpNYnFUeGM4ZE1BZFFBQTJOcTVOOEhMQzJ4NFhQeDdlUlFGL2hVSUh5SE0wZUNCcTVlV1htTlRlbERkdTUKWTVja1hkbjJOZmVVd0lJMmtNcGxyMXlxam9nTXc3QTIzemVYdHB6R29PbkxvZ1ZkV3Z0c1ludmNIS0hHSUVnWApSRUwwdDRtY0d2UkMrMFFRVjVEd1pBb2FTdnE0d3pzdllQSktFUmNSdzBNT2dzVGZ2ZXBlMW1mWVNYUCtMRUswCkVHYVVaY0tuY3FpTFFLdzY2SzVyU1ZMa25VMDBhcktIUGlvWWNyb0pRYktWN0w5ekMrblFtNHRYNFJDWFRPd2UKZ1QrdFVxTEZHK1hwNDlSUWNvblZhU0tZWjgzVnlHa2lPMjZqWUpOWHJUSUFPYmsrQ1ZJajJQMngKLS0tLS1FTkQgQ0VSVElGSUNBVEUgUkVRVUVTVC0tLS0tCg==
  signerName: kubernetes.io/kube-apiserver-client
  expirationSeconds: 8640000
  usages:
  - client auth

# ç”ŸæˆCSRèµ„æºå¯¹è±¡
[root@master1 pki]#kubectl apply -f security-certificaterequests-test2.yaml 
certificatesigningrequest.certificates.k8s.io/test2 created

# æŸ¥çœ‹
[root@master1 pki]#kubectl get csr
NAME    AGE    SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION
test2   119s   kubernetes.io/kube-apiserver-client   kubernetes-admin   100d                Pending

# ä»¥kubernetesç®¡ç†å‘˜èº«ä»½ï¼Œé¢å‘è¯ä¹¦
[root@master1 pki]# kubectl certificate approve test2
certificatesigningrequest.certificates.k8s.io/test2 approved

# æŸ¥çœ‹çŠ¶æ€å·²é¢å‘
[root@master1 pki]#kubectl get csr
NAME    AGE    SIGNERNAME                            REQUESTOR          REQUESTEDDURATION   CONDITION
test2   3m4s   kubernetes.io/kube-apiserver-client   kubernetes-admin   100d                Approved,Issued

# èŽ·å–è¯ä¹¦
[root@master1 pki]#kubectl get csr test2 -o jsonpath={.status.certificate}|base64 -d > test2.crt

[root@master1 pki]#cat test2.crt 
-----BEGIN CERTIFICATE-----
MIIDBzCCAe+gAwIBAgIRAMjOBLtzoxNSnwuFWP0q0awwDQYJKoZIhvcNAQELBQAw
FTETMBEGA1UEAxMKa3ViZXJuZXRlczAeFw0yNTAxMDcxNDMxNDVaFw0yNTA0MTcx
NDMxNDVaMCExDzANBgNVBAoTBmRldm9wczEOMAwGA1UEAxMFdGVzdDIwggEiMA0G
CSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCYSADUvZJJcXVKn/Y47VYHoJm5yOTA
FzdyNTlYxYge7UV0xupwcdPKnN2ALAl63feENW1CZgiBqq8C1EksXgyBU6S/snbg
fVbwr9B1pajpThK93j5JVs2sgYuR45gV21ZOSZdmOv0mDRrP9WnmhNjBHaST9rth
B+49FKGl0eklFl6f9RW/HRKfxnmd6JoUCYf59xqPvASVMtflBUMKFC9CiZvRpCZ6
jkQ8feOBGZhZSfF+ZqhJcXUB+y5EKsYjRfDfiEX5rs3lGc1cPqNbA4+yN3G5Hfvi
3lFW3Zf1HvHkWWrbmDtmAv0tjvSooTHzebb/hYOvbm1vRRx/l+v51iq3AgMBAAGj
RjBEMBMGA1UdJQQMMAoGCCsGAQUFBwMCMAwGA1UdEwEB/wQCMAAwHwYDVR0jBBgw
FoAU1qvukPDcEq9gVsqNRan7GdWoTHswDQYJKoZIhvcNAQELBQADggEBAAenQ8eL
1+eOA7hpwuNcEZJs+OCn2CUFtYWQ+SHQQ0yhcfACcxXzXt7XagShKC4ZmP0oeAwq
YBgoFSGiJKetDhFLVdvN/ZeUsXoplg017QgfQZ0N3kOqhwkKeIPlY0dAB5S2v1Nb
CvMk/gyXqTGqGB57bVXYZUEHZ3G5xAB2mmskNa38tBykOFrhQfL7BB7rCD9HUZDE
QGbgyZxi7Oio8MDc7wEsG85GyE6FWyE+2ad6SLOLtB7pLvGltencMF2q0JWhqFzv
oWJ7T9b93TS5Xj2yQNg2zIDhZlNi8Wr9qdC0Qe2Kbr/Ose7I9M8gtmmUaNxj0UY/
ZMZO1382+baf02Q=
-----END CERTIFICATE-----

[root@master1 pki]#openssl x509 -in test2.crt -text -noout
Certificate:
    Data:
        Version: 3 (0x2)
        Serial Number:
            c8:ce:04:bb:73:a3:13:52:9f:0b:85:58:fd:2a:d1:ac
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN = kubernetes
        Validity
            Not Before: Jan  7 14:31:45 2025 GMT
            Not After : Apr 17 14:31:45 2025 GMT
        Subject: O = devops, CN = test2

# åŽç»­ä½¿ç”¨è¿™ä¸ªè¯ä¹¦å¯ä»¥æ­£å¸¸è®¿é—®ï¼ŒæŒ‰ä¸Šè¿°æ–¹æ³•
```





#### ä»¤ç‰Œè®¤è¯

#####  å¸¸è§çš„ä»¤ç‰Œè®¤è¯

- **å¼•å¯¼ä»¤ç‰Œ**

  - kubeadmåˆ›å»ºé›†ç¾¤åˆå§‹åŒ–çŽ¯å¢ƒæ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå¥½çš„ä¸€æ¬¡æ€§ä»¤ç‰Œï¼Œç”¨äºŽå…¶ä»–èŠ‚ç‚¹åŠ å…¥åˆ°é›†ç¾¤çŽ¯å¢ƒä¸­

  ```bash
  kubeadm join kubeapi.wang.org:6443 --token jizd9o.tjfoyvdoisbklfi5 \
  	--discovery-token-ca-cert-hash sha256:c27e15a7a39394b6d64e419b60df835f9dedb7b015a92c1d9285effa1fbea600 \  # è¿™é‡Œå°±æ˜¯å¼•å¯¼ä»¤ç‰Œ
  	--control-plane --certificate-key 9fa84696a800c6b995a9249972c1dd76735701e5ea2ae05191c9f612a0d1252c --cri-socket=unix:///run/cri-dockerd.sock # åŽé¢è¿½åŠ  --cri-socket=unix:///run/cri-dockerd.sock
  ```

  

- **é™æ€ä»¤ç‰Œ**
  - å°†ç”¨æˆ·å’Œä»¤ç‰Œå­˜æ”¾äºŽ**æ–‡æœ¬æ–‡ä»¶**ä¸­,å¹¶å¯åŠ¨API Serverè¿›ç¨‹æ—¶åŠ è½½æ­¤æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å†…å®¹ä¼šç”±API Serverç¼“å­˜äºŽå†…å­˜ä¸­
  - ç”±kube-apiserveråœ¨å¯åŠ¨æ—¶é€šè¿‡--token-auth-fileé€‰é¡¹åŠ è½½,**é»˜è®¤æ²¡æœ‰åŠ è½½æ­¤é€‰é¡¹**
  - åŠ è½½å®ŒæˆåŽçš„æ–‡ä»¶å˜åŠ¨ï¼Œä»…èƒ½é€šè¿‡é‡å¯ç¨‹åºè¿›è¡Œé‡è½½ï¼Œå› æ­¤ï¼Œç›¸å…³çš„ä»¤ç‰Œä¼šé•¿æœŸæœ‰æ•ˆ
  - å®¢æˆ·ç«¯åœ¨HTTPè¯·æ±‚ä¸­ï¼Œé€šè¿‡â€œ**Authorization Bearer TOKEN**â€æ ‡å¤´é™„å¸¦ä»¤ç‰Œä»¤ç‰Œä»¥å®Œæˆè®¤è¯
  - æ¯”å¦‚åœ¨ä½¿ç”¨kubeletçš„æ—¶å€™ï¼Œéœ€è¦ä¾èµ–çš„tokenæ–‡ä»¶



- **é™æ€å¯†ç **
  - å­˜å‚¨äºŽAPI Serverè¿›ç¨‹å¯ç›´æŽ¥åŠ è½½åˆ°çš„æ–‡ä»¶ä¸­ä¿å­˜çš„è´¦æˆ·å’Œå¯†ç ä»¤ç‰Œï¼Œè¯¥æ–‡ä»¶å†…å®¹ä¼šç”±API Server ç¼“å­˜äºŽå†…å­˜ä¸­
  - æ¯”å¦‚åœ¨ä½¿ç”¨kubeletçš„æ—¶å€™ï¼Œéœ€è¦ä¾èµ–çš„.kube/configæ–‡ä»¶



- **Service Account ä»¤ç‰Œ**
  - æ­¤ä»¤ç‰Œä¸“ç”¨äºŽServiceAccount
  - ç”¨äºŽå°†Podè®¤è¯åˆ°API Server ä¸Šï¼Œä»¥æ”¯æŒé›†ç¾¤å†…çš„è¿›ç¨‹ä¸ŽAPI Serveré€šä¿¡
  - è¯¥è®¤è¯æ–¹å¼å°†ç”±kube-apiserverç¨‹åºå†…ç½®ç›´æŽ¥å¯ç”¨å®ƒå€ŸåŠ©äºŽç»è¿‡ç­¾åçš„Bearer Tokenæ¥éªŒè¯è¯·æ±‚
  - ç­¾åæ—¶ä½¿ç”¨çš„å¯†é’¥å¯ä»¥ç”±--service-account-key-fileé€‰é¡¹æŒ‡å®šï¼Œä¹Ÿå¯ä»¥é»˜è®¤ä½¿ç”¨API Serverçš„tlsç§é’¥
  - Kuberneteså¯ä½¿ç”¨ServiceAccountå‡†å…¥æŽ§åˆ¶å™¨è‡ªåŠ¨ä¸ºPodå…³è”ServiceAccount



- **OIDCä»¤ç‰Œ**
  - OIDC å°±æ˜¯ OpenID Connectï¼Œæ˜¯ä¸€ç§åŠ¨æ€ä»¤ç‰Œ,ä¸»è¦åº”ç”¨äºŽé›†æˆç¬¬ä¸‰æ–¹è®¤è¯çš„ä¸€ç§é›†ä¸­å¼è®¤è¯æ–¹å¼
  - æ¯”å¦‚: KeyCloak,é€šå¸¸éµå¾ªOAuth 2åè®®ã€‚å°¤å…¶æ˜¯ç¬¬ä¸‰æ–¹äº‘æœåŠ¡å•†çš„è®¤è¯



- **Webhookä»¤ç‰Œ**
  - å¸¸åº”ç”¨äºŽè§¦å‘ç¬¬ä¸‰æ–¹çš„åŠ¨ä½œæ—¶å€™çš„ä¸€äº›è®¤è¯æœºåˆ¶ï¼Œä¸»è¦ä¾§é‡äºŽhttpåè®®åœºæ™¯ã€‚





##### é™æ€ä»¤ç‰Œè®¤è¯å®žçŽ°

- **é™æ€ä»¤ç‰Œè®¤è¯çš„é…ç½®è¯´æ˜Ž**

  - ä»¤ç‰Œä¿¡æ¯ä¿å­˜äºŽ**æ ¼å¼ä¸ºCSV**çš„æ–‡æœ¬æ–‡ä»¶ï¼Œæ¯è¡Œå®šä¹‰ä¸€ä¸ªç”¨æˆ·ï¼Œç”±â€œ**ä»¤ç‰Œã€ç”¨æˆ·åã€ç”¨æˆ·IDå’Œæ‰€å±žçš„ç”¨æˆ·ç»„**â€å››ä¸ªå­—æ®µç»„æˆï¼Œç”¨æˆ·ç»„ä¸ºå¯é€‰å­—æ®µ

  ```ABAP
  æ ¼å¼: token, user, uid, "group1, group2, ......"
  ```

  - ç”±kube-apiserveråœ¨å¯åŠ¨æ—¶é€šè¿‡--token-auth-fileé€‰é¡¹åŠ è½½
  - åŠ è½½å®ŒæˆåŽå¦‚æžœå†æœ‰æ–‡ä»¶å˜åŠ¨ï¼Œéœ€è¦é€šè¿‡é‡å¯kube-apiserverè¿›è¡Œé‡è½½
  - å¯åœ¨å®¢æˆ·ç«¯åœ¨HTTPè¯·æ±‚ä¸­ï¼Œé€šè¿‡â€œAuthorization Bearer TOKENâ€æ ‡å¤´é™„å¸¦ä»¤ç‰Œä»¤ç‰Œä»¥å®Œæˆè®¤è¯



- **é™æ€ä»¤ç‰Œè®¤è¯é…ç½®è¿‡ç¨‹**

  - ç”Ÿæˆtokenï¼Œå‘½ä»¤ï¼šecho "$(openssl rand -hex 3).$(openssl rand -hex 8)"

  ```bash
  echo "$(openssl rand -hex 3).$(openssl rand -hex 8)"  # 3å’Œ8è¡¨ç¤ºçš„å­—èŠ‚æ•°ï¼Œæ•´ä½“æ„æ€æ˜¯3ä¸ªå­—èŠ‚çš„16è¿›åˆ¶æ˜¾ç¤ºçš„éšæœºæ•°
  ```

  - ç”Ÿæˆstatic tokenæ–‡ä»¶
  - é…ç½®kube-apiserveråŠ è½½è¯¥é™æ€ä»¤ç‰Œæ–‡ä»¶ä»¥å¯ç”¨ç›¸åº”çš„è®¤è¯åŠŸèƒ½
  - æµ‹è¯•å‘½ä»¤

  ```bash
  #æ–¹æ³•1
  curl -k -H "Authorization: Bearer $TOKEN"
  https://API_SERVER:6443/api/v1/namespaces/default/pods/
  
  #æ–¹æ³•2
  kubectl --insecure-skip-tls-verify  --token=$TOKEN -s
  https://kubeapi.wang.org:6443 get pod
  
  #è¯´æ˜Žï¼š TOKENè¡¨ç¤ºä¸Šé¢ç”¨æˆ·ç”Ÿæˆçš„token 
  ```



**èŒƒä¾‹: åŸºäºŽé™æ€tokenä»¤ç‰Œå‘API Serveræ·»åŠ è®¤è¯ç”¨æˆ·**

```bash
#åœ¨æ‰€æœ‰MasterèŠ‚ç‚¹ä¸Šé…ç½®ä¸‹é¢è¿‡ç¨‹,å¦‚æžœåªæœ‰ä¸€ä¸ªMasterèŠ‚ç‚¹é…ç½®,åªèƒ½è¿žæŽ¥æ­¤MasterèŠ‚ç‚¹æµ‹è¯•
#å‡†å¤‡Tokenæ–‡ä»¶å­˜æ”¾çš„ç‹¬ç«‹ç›®å½•
[root@master1 ~]#mkdir /etc/kubernetes/auth

# åˆ›å»ºé™æ€ä»¤ç‰Œæ–‡ä»¶å¹¶æ·»åŠ ç”¨æˆ·ä¿¡æ¯
[root@master1 auth]#echo "$(openssl rand -hex 3).$(openssl rand -hex 8),wang,1001,ops" > /etc/kubernetes/auth/token.csv
[root@master1 auth]#echo "$(openssl rand -hex 3).$(openssl rand -hex 8),test,1002,dev" >> /etc/kubernetes/auth/token.csv

# æŸ¥çœ‹
[root@master1 auth]#cat /etc/kubernetes/auth/token.csv 
1ec32a.838c37d29a7c43b6,wang,1001,ops
fd3e78.2a0395a1c58fb561,test,1002,dev

#å…ˆå¤‡ä»½é…ç½®æ–‡ä»¶ï¼Œæ³¨æ„ï¼šä¸è¦å°†å¤‡ä»½æ–‡ä»¶æ”¾åœ¨åŽŸç›®å½•ä¸‹ï¼›
[root@master1 backup]#cp /etc/kubernetes/manifests/kube-apiserver.yaml .

#ç›´æŽ¥ä¿®æ”¹åŽŸæ–‡ä»¶
[root@master1 ~]#vim /etc/kubernetes/manifests/kube-apiserver.yaml 
......
  - command:
    - kube-apiserver
    - --advertise-address=10.0.0.200
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --token-auth-file=/etc/kubernetes/auth/token.csv  #æŒ‡å®šå‰é¢åˆ›å»ºæ–‡ä»¶çš„è·¯å¾„
.....
   volumeMounts:
   ......
    - mountPath: /etc/kubernetes/auth                   #æ·»åŠ ä¸‰è¡Œ,å®žçŽ°æ•°æ®å·çš„æŒ‚è½½é…
ç½®
     name: static-auth-token
     readOnly: true
 hostNetwork: true
......
 volumes:
 .......
  - hostPath:                                           #æ·»åŠ ä¸‰è¡Œæ•°æ®å·å®šä¹‰
     path: /etc/kubernetes/auth
     type: DirectoryOrCreate
   name: static-auth-token
   
# ä¸Šé¢æ–‡ä»¶ä¿®æ”¹åŽ,Kubernetesä¼šè‡ªåŠ¨é‡å¯åä¸ºkube-apiserver-master1.wang.orgçš„Pod,å¯èƒ½éœ€è¦ç­‰ä¸€ä¼šå„¿æ‰èƒ½å¯åŠ¨æˆåŠŸ
# apiServeré‡å¯æœŸé—´å¯èƒ½æŠ¥é”™ï¼Œè®¿é—®å¯èƒ½æŠ¥é”™ï¼Œéœ€ç­‰å¾…
[root@master1 backup]# kubectl get pod -n kube-system kube-apiserver
The connection to the server master1.mystical.org:6443 was refused - did you specify the right host or port?


# ä¸€æ®µæ—¶é—´åŽï¼Œé‡å¯æˆåŠŸ
[root@master1 backup]#kubectl get pod -n kube-system kube-apiserver-master1 
NAME                     READY   STATUS    RESTARTS   AGE
kube-apiserver-master1   1/1     Running   0          2m54s


#æŸ¥çœ‹å®¹å™¨æ˜¯å¦åŠ è½½äº†token.csvæ–‡ä»¶
[root@master1 backup]# docker ps |grep api
a8e08a3f681f   56ce0fd9fb53                                        "kube-apiserver --adâ€¦"   33 seconds ago   Up 32 seconds             k8s_kube-apiserver_kube-apiserver-master1_kube-system_a940e438a9aff369d80b49179ee0f235_0
a90cdbbf53f0   registry.aliyuncs.com/google_containers/pause:3.9   "/pause"                  33 seconds ago   Up 32 seconds             k8s_POD_kube-apiserver-master1_kube-system_a940e438a9aff369d80b49179ee0f235_0

[root@master1 backup]# docker inspect a8e08a3f681f |grep -n token.csv
11:            "--token-auth-file=/etc/kubernetes/auth/token.csv",
302:                "--token-auth-file=/etc/kubernetes/auth/token.csv",


#éªŒè¯æ–¹æ³•1:ä½¿ç”¨ä¸Šé¢ä»»æ„ç”¨æˆ·çš„tokenè®¿é—®,æç¤ºç”¨æˆ·wangè¢«ç¦æ­¢è®¿é—®ï¼Œè¯´æ˜Žç”¨æˆ·éªŒè¯æˆåŠŸï¼Œåªæ˜¯æƒé™ä¸è¶³
#æ³¨æ„:å¦‚æžœåªæ˜¯ä¿®æ”¹ä¸€ä¸‹masterèŠ‚ç‚¹çš„é…ç½®,åªèƒ½è¿žæŽ¥æ­¤èŠ‚ç‚¹æµ‹è¯•,ç¤ºä¾‹: "https://ä¿®æ”¹é…ç½®çš„masterèŠ‚ç‚¹:6443/api/....."

[root@master1 backup]#TOKEN="1ec32a.838c37d29a7c43b6";curl -k -H"Authorization: Bearer $TOKEN" https://10.0.0.201:6443/api/v1/namespaces/default/pods/
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "pods is forbidden: User \"wang\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\"",
  "reason": "Forbidden",
  "details": {
    "kind": "pods"
  },
  "code": 403

# éªŒè¯æ–¹æ³•2:åœ¨workerèŠ‚ç‚¹æ‰§è¡Œ,æç¤ºç”¨æˆ·wangè¢«ç¦æ­¢è®¿é—®ï¼Œè¯´æ˜Žç”¨æˆ·éªŒè¯æˆåŠŸï¼Œåªæ˜¯æƒé™ä¸è¶³
#æ³¨æ„:å¦‚æžœåªæ˜¯ä¿®æ”¹ä¸€ä¸‹masterèŠ‚ç‚¹çš„é…ç½®,åªèƒ½è¿žæŽ¥æ­¤èŠ‚ç‚¹æµ‹è¯•,ç¤ºä¾‹: -s "https://ä¿®æ”¹é…ç½®çš„masterèŠ‚ç‚¹:6443"

[root@node1 ~]#TOKEN="1ec32a.838c37d29a7c43b6";kubectl -s "https://10.0.0.201:6443" --token="$TOKEN" --insecure-skip-tls-verify=true get pod
Error from server (Forbidden): pods is forbidden: User "wang" cannot list resource "pods" in API group "" in the namespace "default"


# ä½¿ç”¨é”™è¯¯Tokenè®¿é—®ï¼Œè§‚å¯Ÿç»“æžœ
[root@master1 backup]#TOKEN="1ec32a.838c37d29a7c43b5";curl -k -H"Authorization: Bearer $TOKEN" https://10.0.0.201:6443/api/v1/namespaces/default/pods/
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "Unauthorized",
  "reason": "Unauthorized",
  "code": 401


#ä¸ä½¿ç”¨Tokenè®¿é—®ï¼Œè§‚å¯Ÿç»“æžœï¼Œå³åŒ¿åè®¿é—®
[root@master1 backup]##curl -k https://10.0.0.201:6443/api/v1/namespaces/default/pods/{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "pods is forbidden: User \"system:anonymous\" cannot list resource \"pods\" in API group \"\" in the namespace \"default\"",
  "reason": "Forbidden",
  "details": {
    "kind": "pods"
  },
  "code": 403
}
```



#### Kubeconfigç®¡ç†

kubeconfig æ˜¯YAMLæ ¼å¼çš„æ–‡ä»¶ï¼Œç”¨äºŽå­˜å‚¨èº«ä»½è®¤è¯ä¿¡æ¯ï¼Œä»¥ä¾¿äºŽå®¢æˆ·ç«¯åŠ è½½å¹¶è®¤è¯æŽ¥å…¥åˆ°API Server

kubeconfig ä¿å­˜æœ‰è®¤è¯åˆ°ä¸€æˆ–å¤šä¸ªKubernetesé›†ç¾¤çš„ç›¸å…³é…ç½®ä¿¡æ¯ï¼Œå¹¶å…è®¸ç®¡ç†å‘˜æŒ‰éœ€åœ¨å„é…ç½®é—´çµæ´»åˆ‡æ¢



##### Kubeconfig æ–‡ä»¶æ ¼å¼

KubeconfigåŒ…æ‹¬å¦‚ä¸‹ä¿¡æ¯

![image-20250108105650248](D:\git_repository\cyber_security_learning\markdown_img\image-20250108105650248.png)



- **clusters**ï¼šæ¯ä¸ªKubernetesé›†ç¾¤çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬é›†ç¾¤å¯¹åº”è®¿é—®ç«¯ç‚¹ï¼ˆAPI Serverï¼‰çš„åœ°å€
- **users**ï¼šè®¤è¯åˆ°API Serverçš„ç”¨æˆ·çš„èº«ä»½å‡­æ®åˆ—è¡¨
- **contexts**ï¼šå°†æ¯ä¸€ä¸ªuseråŒå¯è®¤è¯åˆ°çš„clusterå»ºç«‹å…³è”å…³ç³»çš„ä¸Šä¸‹æ–‡åˆ—è¡¨
- **current-context**ï¼šå½“å‰é»˜è®¤ä½¿ç”¨çš„context



**å®¢æˆ·ç«¯ç¨‹åºkubectl åŠ è½½çš„kubeconfigæ–‡ä»¶çš„é€”å¾„åŠä»Žé«˜åˆ°ä½Žä¼˜å…ˆçº§æ¬¡åº**



- --kubeconfigé€‰é¡¹,åªæ”¯æŒä¸€ä¸ªæ–‡ä»¶
- KUBECONFIGçŽ¯å¢ƒå˜é‡ï¼šå…¶å€¼æ˜¯åŒ…å«æœ‰kubeconfigæ–‡ä»¶çš„åˆ—è¡¨,æ”¯æŒå¤šä¸ªæ–‡ä»¶,ç”¨å†’å·éš”ç¦»
- é»˜è®¤è·¯å¾„ï¼š$HOME/.kube/config



**é»˜è®¤ /etc/kubernetes/*.conf çš„æ–‡ä»¶éƒ½å±žäºŽ Kubeconfig æ–‡ä»¶**

```bash
[root@master1 backup]# ls /etc/kubernetes/*.conf
/etc/kubernetes/admin.conf               /etc/kubernetes/scheduler.conf
/etc/kubernetes/controller-manager.conf  /etc/kubernetes/super-admin.conf
/etc/kubernetes/kubelet.conf

[root@master1 backup]#grep "^[a-z]" /etc/kubernetes/*.conf
/etc/kubernetes/admin.conf: apiVersion: v1
/etc/kubernetes/admin.conf: clusters:
/etc/kubernetes/admin.conf: contexts:
/etc/kubernetes/admin.conf: current-context: kubernetes-admin@kubernetes
/etc/kubernetes/admin.conf: kind: Config
/etc/kubernetes/admin.conf: preferences: {}
/etc/kubernetes/admin.conf: users:

/etc/kubernetes/controller-manager.conf: apiVersion: v1
/etc/kubernetes/controller-manager.conf: clusters:
/etc/kubernetes/controller-manager.conf: contexts:
/etc/kubernetes/controller-manager.conf: current-context: system:kube-controller-manager@kubernetes
/etc/kubernetes/controller-manager.conf: kind: Config
/etc/kubernetes/controller-manager.conf: preferences: {}
/etc/kubernetes/controller-manager.conf: users:

/etc/kubernetes/kubelet.conf: apiVersion: v1
/etc/kubernetes/kubelet.conf: clusters:
/etc/kubernetes/kubelet.conf: contexts:
/etc/kubernetes/kubelet.conf: current-context: system:node:master1@kubernetes
/etc/kubernetes/kubelet.conf: kind: Config
/etc/kubernetes/kubelet.conf: preferences: {}
/etc/kubernetes/kubelet.conf: users:

/etc/kubernetes/scheduler.conf: apiVersion: v1
/etc/kubernetes/scheduler.conf: clusters:
/etc/kubernetes/scheduler.conf: contexts:
/etc/kubernetes/scheduler.conf: current-context: system:kube-scheduler@kubernetes
/etc/kubernetes/scheduler.conf: kind: Config
/etc/kubernetes/scheduler.conf: preferences: {}
/etc/kubernetes/scheduler.conf: users:

/etc/kubernetes/super-admin.conf: apiVersion: v1
/etc/kubernetes/super-admin.conf: clusters:
/etc/kubernetes/super-admin.conf: contexts:
/etc/kubernetes/super-admin.conf: current-context: kubernetes-super-admin@kubernetes
/etc/kubernetes/super-admin.conf: kind: Config
/etc/kubernetes/super-admin.conf: preferences: {}
/etc/kubernetes/super-admin.conf: users:
```



**åˆ©ç”¨kubeconfigå®žçŽ°é›†ç¾¤å¤–ä¸»æœºè®¿é—®é›†ç¾¤èµ„æº**

```bash
#åœ¨é›†ç¾¤å¤–èŠ‚ç‚¹å®‰è£…kubectlå·¥å…·
#æ–¹æ³•1
[root@ubuntu2204 ~]# curl -s https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add -
Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
OK

[root@ubuntu2204 ~]# cat << EOF > /etc/apt/sources.list.d/kubernetes.list
> deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main
> EOF

# æŸ¥çœ‹
[root@ubuntu2204 ~]# cat /etc/apt/sources.list.d/kubernetes.list 
deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main

# æ›´æ–°å…ƒæ•°æ®å¹¶å®‰è£…
[root@ubuntu2204 ~]# apt update &> /dev/null && apt install -y kubectl &> /dev/null


# æ–¹æ³•2ï¼šç›´æŽ¥å°†masterèŠ‚ç‚¹çš„kubectlç¨‹åºæ–‡ä»¶å¤åˆ¶åˆ°é›†ç¾¤å¤–èŠ‚ç‚¹
[root@ubuntu2204 ~]#scp master1.wang.org:/usr/bin/kubectl /usr/local/bin/
[root@ubuntu2204 ~]#ls -l /usr/local/bin/
total 46904
-rwxr-xr-x 1 root root 48029696 Jul  6 14:23 kubectl
[root@ubuntu2204 ~]#ldd /usr/local/bin/kubectl 
 not a dynamic executable


# å°†ä¸»èŠ‚ç‚¹çš„./kube/configä¼ é€’åˆ°é›†ç¾¤å¤–èŠ‚ç‚¹
[root@master1 ~]# scp .kube/config 10.0.0.131:

# åœ¨é›†ç¾¤å¤–èŠ‚ç‚¹é…ç½®hostsæ–‡ä»¶ä½¿å…¶èƒ½å¤Ÿè§£æžconfigä¸­çš„apiServeråœ°å€çš„åŸŸå
echo "10.0.0.201 mater1.mystical.org" >> /etc/hosts

# æ‰§è¡Œkubectlæµ‹è¯•æ˜¯å¦èƒ½å¤Ÿè®¿é—®é›†ç¾¤
[root@ubuntu2204 ~]# kubectl get nodes --kubeconfig=./config
NAME      STATUS   ROLES           AGE    VERSION
master1   Ready    control-plane   4d1h   v1.30.8
node1     Ready    <none>          4d1h   v1.30.8
node2     Ready    <none>          4d1h   v1.30.8
node3     Ready    <none>          4d1h   v1.30.8
```





##### Kubeconfigåˆ›å»ºå’Œç®¡ç†



kubectl config å‘½ä»¤å¯ä»¥åˆ›å»ºå’Œç®¡ç†kubeconfigæ–‡ä»¶

æ‰©å±•å·¥å…·: **kubectx** å’Œ **kubens**

**kubectx** is a tool to switch between contexts (clusters) on kubectl faster.

**kubens** is a tool to switch between Kubernetes namespaces (and configure them for kubectl) easily.



**kubectl config å‘½ä»¤ç”¨æ³•**

```bash
#kubernetes é…ç½®æ–‡ä»¶ç®¡ç†
[root@master1 ~]#kubectl config -h
Modify kubeconfig files using subcommands like "kubectl config set
current-context my-context".

 The loading order follows these rules:
 
 # é…ç½®æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯
    1 ä½¿ç”¨ --kubeconfig å‚æ•°ç®¡ç†æŸä¸ªæŒ‡å®šçš„é…ç½®æ–‡ä»¶è·¯å¾„
    2 è¯¥æ–‡ä»¶å¯ä»¥ä½¿ç”¨ $KUBECONFIG å˜é‡æ¥ç®¡ç†
    3 å…¶ä»–æƒ…å†µä¸‹ï¼Œé…ç½®æ–‡ä»¶æŒ‡çš„å°±æ˜¯ ${HOME}/.kube/config 
   ä¼˜å…ˆçº§ï¼š 1 > 2 > 3

  1.  If the --kubeconfig flag is set, then only that file is loaded. The flag
may only be set once and no merging takes place.

  2.  If $KUBECONFIG environment variable is set, then it is used as a list of
paths (normal path delimiting rules for your system). These paths are merged.
When a value is modified, it is modified in the file that defines the stanza.
When a value is created, it is created in the first file that exists. If no
files in the chain exist, then it creates the last file in the list.

  3.  Otherwise, ${HOME}/.kube/config is used and no merging takes place.


Available Commands:
  current-context   Display the current-context
  delete-cluster    ä»Ž kubeconfig ä¸­åˆ é™¤æŒ‡å®šçš„é›†ç¾¤
  delete-context    ä»Ž kubeconfig ä¸­åˆ é™¤æŒ‡å®šçš„ä¸Šä¸‹æ–‡
  delete-user       Delete the specified user from the kubeconfig
  get-clusters      æ˜¾ç¤ºåœ¨ kubeconfig ä¸­å®šä¹‰çš„é›†ç¾¤
  get-contexts      æè¿°ä¸€ä¸ªæˆ–å¤šä¸ªä¸Šä¸‹æ–‡
  get-users         Display users defined in the kubeconfig
  rename-context    Rename a context from the kubeconfig file
  set               Set an individual value in a kubeconfig file
  set-cluster       Set a cluster entry in kubeconfig
  set-context       Set a context entry in kubeconfig
  set-credentials   Set a user entry in kubeconfig
  unset             Unset an individual value in a kubeconfig file
  use-context       Set the current-context in a kubeconfig file
  view              æ˜¾ç¤ºåˆå¹¶çš„ kubeconfig é…ç½®æˆ–ä¸€ä¸ªæŒ‡å®šçš„ kubeconfig æ–‡ä»¶

Usage:
  kubectl config SUBCOMMAND [options]

# é›†ç¾¤ç›¸å…³
  delete-cluster
  set-cluster
  get-clusters
  
# ç”¨æˆ·ç›¸å…³
  set-credentials
  get-users
  delete-user
  
# ä¸Šä¸‹æ–‡ç›¸å…³
  delete-context
  get-contexts
  set-context
  rename-context
  
# current-contextç›¸å…³å­å‘½ä»¤
  user-context
  current-context

# æŸ¥çœ‹
  view
  
#ç»“æžœæ˜¾ç¤ºï¼šå¯¹äºŽä¸€ä¸ªç”¨æˆ·è´¦å·ï¼Œè‡³å°‘åŒ…å«ä¸‰éƒ¨åˆ†ï¼š
1.ç”¨æˆ·æ¡ç›®-credentials è®¾å®šå…·ä½“çš„user accountåç§°
2.é›†ç¾¤-cluster è®¾å®šè¯¥user accountæ‰€å·¥ä½œçš„åŒºåŸŸ
3.ä¸Šä¸‹æ–‡çŽ¯å¢ƒ-context è®¾å®šç”¨æˆ·å’Œé›†ç¾¤çš„å…³ç³»
```



**åˆ›å»ºå’Œä½¿ç”¨kubeconfigæµç¨‹**

```bash
# 1) åœ¨kubeconfigä¸­æ·»åŠ é›†ç¾¤ä¿¡æ¯
# éœ€æŒ‡å®š3ä¸ªé‡è¦ä¿¡æ¯
# 1. Kubernetesé›†ç¾¤çš„CAè¯ä¹¦ä¿¡æ¯
# 2. apiServerçš„IPåœ°å€
# 3. æŒ‡å®šç”Ÿæˆçš„configæ–‡ä»¶æ‰€åœ¨è·¯å¾„
[root@node1 ~]# kubectl config set-cluster mykube --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server="https://10.0.0.201:6443" --kubeconfig=$HOME/.kube/mykube.conf
Cluster "mykube" set.

# æŸ¥çœ‹æ–‡ä»¶
[root@node1 ~]#ls .kube/
cache  mykube.conf

[root@node1 ~]#cat .kube/mykube.conf 
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJRmQ2UW5LYmkzK2t3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBeE1EUXdNVE01TURaYUZ3MHpOVEF4TURJd01UUTBNRFphTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURObjZibnVuWVZkV1kvQ1JPczVIaGE0TE8zYk81dEtZRlNOMnNYQ2pERXYyM0VWRTVDTE9qMmJlblkKRUt4YUcrdHR2UFJqWWpQUkZCWldjOFFJcmdQc2gzWHI4YzRHNFVMU1grdkJhdEdhVFhpSU9DQXNSRUxRcUExcgpXajkvZ0hrZlRvQlRCY2J5M0xEbms5RFJ3SXR4SXJYSTFxUUJLL2VLRmNFOVlBaG93YkpBK2I3TTJ3SHlPdFg2CmVnV09WVWRDQjRzN05qZHAvYytDamJXeStUYTBmbDQ4RVM4VHFFY3kxUXMvYXMybjAxOFdJei80TExDazFYSmwKTFdDRlJrOE5BOTVIcVZQbkRmVWVLK3RaSXpBS0dFbVpuM290RXNPdHgzanJBV2ZxbjV5UzVDVEZFZlRBU2FpWApFL3k4eFZrSzREQi8xNlFGSXM1cVBVSzVSMkhYQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJUV3ErNlE4TndTcjJCV3lvMUZxZnNaMWFoTWV6QVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQzRLOHRLaktMQQpUMWJaV1NHTmlGZStEVGRKZEx0NlEyRkdaTUdCT3Yyc04ybXhJZDJzMW1rSHFCbEJzQ1JEcDdpRXdwVE1EcWtjCjlJdWEzcG1hdDAxMWJZMVZmNUF6aktiVVYzYlplSXJUWWkrSEtZWThCWnZ2WTVUcDJOdTBOUjk5NkJjSE5zRWsKdlhCSS9JcmlOd0swUHZqRTNVeGFlMUx4T2MvcjdyZWI5bVZQSTlXYWorVDY3KzZZS3BhTHBYWXQ0dGFMWDFBOQpiU1lGekdFVzZqRFpJSG9hSDFxTDNXcGRud2VMcThldjRCV0dmdURHNUltY0tibHUrT3crNjRUZ05taC9oNk9CClVFa0FDQThqQVR4R2g4eEtQZFBtRHFNbEdET0kvOXVkc2U2b1E2QW40c1k2RldTb2NUYjEyWU1TUDVjbkhVa0sKTERhR0tWRUhmUFllCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://10.0.0.201:6443         # apiServeråœ°å€
  name: mykube
contexts: null
current-context: ""
kind: Config
preferences: {}
users: null

# 2) åœ¨kubeconfigä¸­æ·»åŠ ç”¨æˆ·å‡­è¯
# æ–¹å¼1ï¼šX509æ•°å­—è¯ä¹¦è®¤è¯
[root@node1 ~]# kubectl config set-credentials wang --embed-certs=true --client-certificate=pki/wang.crt --client-key=pki/wang.key --kubeconfig=$HOME/.kube/mykube.conf
User "wang" set.

# æŸ¥çœ‹
[root@node1 ~]#cat .kube/mykube.conf 
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJRmQ2UW5LYmkzK2t3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBeE1EUXdNVE01TURaYUZ3MHpOVEF4TURJd01UUTBNRFphTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUURObjZibnVuWVZkV1kvQ1JPczVIaGE0TE8zYk81dEtZRlNOMnNYQ2pERXYyM0VWRTVDTE9qMmJlblkKRUt4YUcrdHR2UFJqWWpQUkZCWldjOFFJcmdQc2gzWHI4YzRHNFVMU1grdkJhdEdhVFhpSU9DQXNSRUxRcUExcgpXajkvZ0hrZlRvQlRCY2J5M0xEbms5RFJ3SXR4SXJYSTFxUUJLL2VLRmNFOVlBaG93YkpBK2I3TTJ3SHlPdFg2CmVnV09WVWRDQjRzN05qZHAvYytDamJXeStUYTBmbDQ4RVM4VHFFY3kxUXMvYXMybjAxOFdJei80TExDazFYSmwKTFdDRlJrOE5BOTVIcVZQbkRmVWVLK3RaSXpBS0dFbVpuM290RXNPdHgzanJBV2ZxbjV5UzVDVEZFZlRBU2FpWApFL3k4eFZrSzREQi8xNlFGSXM1cVBVSzVSMkhYQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJUV3ErNlE4TndTcjJCV3lvMUZxZnNaMWFoTWV6QVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQzRLOHRLaktMQQpUMWJaV1NHTmlGZStEVGRKZEx0NlEyRkdaTUdCT3Yyc04ybXhJZDJzMW1rSHFCbEJzQ1JEcDdpRXdwVE1EcWtjCjlJdWEzcG1hdDAxMWJZMVZmNUF6aktiVVYzYlplSXJUWWkrSEtZWThCWnZ2WTVUcDJOdTBOUjk5NkJjSE5zRWsKdlhCSS9JcmlOd0swUHZqRTNVeGFlMUx4T2MvcjdyZWI5bVZQSTlXYWorVDY3KzZZS3BhTHBYWXQ0dGFMWDFBOQpiU1lGekdFVzZqRFpJSG9hSDFxTDNXcGRud2VMcThldjRCV0dmdURHNUltY0tibHUrT3crNjRUZ05taC9oNk9CClVFa0FDQThqQVR4R2g4eEtQZFBtRHFNbEdET0kvOXVkc2U2b1E2QW40c1k2RldTb2NUYjEyWU1TUDVjbkhVa0sKTERhR0tWRUhmUFllCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
    server: https://10.0.0.201:6443
  name: mykube
contexts: null
current-context: ""
kind: Config
preferences: {}
users:
- name: wang
  user:
    client-certificate-data: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR6RENDQXJRQ0ZGY3lqanV6VXpFUmVXcVV4MkNmVkpYcDJSTFhNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1CVXgKRXpBUkJnTlZCQU1UQ210MVltVnlibVYwWlhNd0hoY05NalV3TVRBM01UTXdNakU1V2hjTk16VXdNVEExTVRNdwpNakU1V2pBd01RMHdDd1lEVlFRRERBUjNZVzVuTVI4d0hRWURWUVFLREJacmRXSmxZV1J0T21Oc2RYTjBaWEl0CllXUnRhVzV6TUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUFyaDVoL1NOWDdSZHEKem04UzB1UUUwKzFRNkI3dklmQm5QK0xWbWkvS0crVHB5N0YwKzM1K2dsNy80NCsvc1RmcFR1SlNEYVh6VTVydwpOd3NyNlNqV2o3NVlYOCtBSVlja0VWVVNwS3hwUkJ0ZDJjbENUanF3bTVHZ21EUk1Ca1ptNzl1S1NmdmZKZnZqCjF5M3U1Q0lhTmNjZWJia29TdUZXeUtxWHQwcEM5WTFDTWhpV0FoNjFJRVU5UFZjSURqK0JoNjNSNS8yOXJSZHEKTk52ZlNuYUY0c2dVL09wRTZXd3lMdUQ4aVhLdFBMeUExa0tpbE5RaWlsS0NFbm13RmxLNVk5N3EwQU45RElRbgpmbStleGhDTnRwdHhvU3R6OXE1aHM2QWUvK041azBKZDQ1Q0dUZm5NbzMvYjE4SDdxSGlvaVlvUXNEaitlWkt3Ck9ua3A0YmVDZXAyZGZxNDlKcG1FOGprY0FUd2NtMFJoVFlUbG5IZ1crZWczSjV3SkRhT2RGRlVUQ29rOUhIS0kKMy9UMzVwdnZaNWRLcXJKYjJHajdFT210bUp5MGowQ2YvaVB1QkxBK0lwbm12NGg3TmFjaDAwb0p2LytBV3pUegpHOGRTcWhHMWR1ekFNOG9uZlBiU292Y0ZaYmZmSUhPSEpydlVxdkF1Y25aanNCQnFTbmt0d2U3L05hbWU0WDk5ClVZVU9TNVBHVGdBWG1WaUEyb1NpOWxaSnB4czVBZkhwUllKenpQRlFNZnFxS2o1VUhaV0ZzSW5JR25rTm5XcEkKNWtRcWZMUFNvSGVVQmp2TytqU3pLSnZyeTBJTGtyZmgzRHN0THlYV3kyK0pnaFQrUFprT0J5RnZma1VBVlpKRgpsUUtuN0czZlZXYmxDeUdOU0NjaHB0Z3FnNmxBVjBzQ0F3RUFBVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBCkpRdGRsblQvRm5PRklDeFY3NDFJNHRRT1dROEhWdVU4Y1F6eDV2b3FtZmU1OStZbUJxT2FPMjcxS0c2akVGMEsKTzM4RmNLVEltTGRhaHdXRkNWSkROV1B4cmFtM2FxUHoveXkxd0VXMkY1c0lSZ004VzAwc0tzTnNpMlR3MjJZawpiQ0NkUWYrZnhLTkh4TXJpS2FoYXYvNXFkWHA5elRkUFRLU1E2U0tTQm9Jd2NCYk1lTWZPWU1WZDdoSmJBdHFMCkh5ZmNOMkdHMW9LSjhMRDBrU1FHa1h2eEZQNFR6WThUenlEcnVFN0laMkJ3V0s1VFdlWXFXUTVXNjBNMnFMYncKLzlBMHJsMFhEM0hHZStpVkd3UWdYWXkxaWhhOUZaSUpTb3lVLzJhd2MvU3pENkFTWkFGNGpLOXZxa29iTHdjdgpQdTQzUmJicFl2WXJPNU9qakxWdm13PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=
    client-key-data: LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUpRZ0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQ1N3d2dna29BZ0VBQW9JQ0FRQ3VIbUg5STFmdEYyck8KYnhMUzVBVFQ3VkRvSHU4aDhHYy80dFdhTDhvYjVPbkxzWFQ3Zm42Q1h2L2pqNyt4TitsTzRsSU5wZk5UbXZBMwpDeXZwS05hUHZsaGZ6NEFoaHlRUlZSS2tyR2xFRzEzWnlVSk9PckNia2FDWU5Fd0dSbWJ2MjRwSis5OGwrK1BYCkxlN2tJaG8xeHg1dHVTaEs0VmJJcXBlM1NrTDFqVUl5R0pZQ0hyVWdSVDA5VndnT1A0R0hyZEhuL2IydEYybzAKMjk5S2RvWGl5QlQ4NmtUcGJESXU0UHlKY3EwOHZJRFdRcUtVMUNLS1VvSVNlYkFXVXJsajN1clFBMzBNaENkKwpiNTdHRUkyMm0zR2hLM1Aycm1Hem9CNy80M21UUWwzamtJWk4rY3lqZjl2WHdmdW9lS2lKaWhDd09QNTVrckE2CmVTbmh0NEo2bloxK3JqMG1tWVR5T1J3QlBCeWJSR0ZOaE9XY2VCYjU2RGNubkFrTm81MFVWUk1LaVQwY2NvamYKOVBmbW0rOW5sMHFxc2x2WWFQc1E2YTJZbkxTUFFKLytJKzRFc0Q0aW1lYS9pSHMxcHlIVFNnbS8vNEJiTlBNYgp4MUtxRWJWMjdNQXp5aWQ4OXRLaTl3Vmx0OThnYzRjbXU5U3E4QzV5ZG1Pd0VHcEtlUzNCN3Y4MXFaN2hmMzFSCmhRNUxrOFpPQUJlWldJRGFoS0wyVmttbkd6a0I4ZWxGZ25QTThWQXgrcW9xUGxRZGxZV3dpY2dhZVEyZGFram0KUkNwOHM5S2dkNVFHTzg3Nk5MTW9tK3ZMUWd1U3QrSGNPeTB2SmRiTGI0bUNGUDQ5bVE0SElXOStSUUJWa2tXVgpBcWZzYmQ5Vlp1VUxJWTFJSnlHbTJDcURxVUJYU3dJREFRQUJBb0lDQUE1Qm9waE5hb2VaSVQraHpKTEQ1TGxOCmR4QnFaLzRKWndyT0VkczhDbnBhTmVKZHQweFlRUmQvbThnUUh3dnRuZ2E5ZFNaMDdnVnNiRHExaVhUZnlTR2YKM2pDS0Z0Mm42UVlhUnhxQW0yWGVMOE1EUFpDV01adXJRdER6aHo0RVNhMWQ5bWEwWHNNSGF0SlZpbmZYYXZuNApRYitPSjRScUN1Y0hRTURiTGJ4WlFwQkRmeFRSV3RjM2xCb1BwRE0yYys2ZUJzL044TmZaVVBMZkJkdGM5UDFxCmtIMWMyU09ibmtoRVY2a1JZS25XYlY0ZHVwNGcrR3NHOG10ODF6UWN0ZDA5aFZCZTJNQkxtY2c2YjIrY0wxNUMKUC8ySVIwaHRZc2FJVjhGdjZLWnNDcS8xUjJuZkNDaGk4YWNxMU9Zb2F2UkgvN0hPR05mdmNNcDQzVHNFQVlUUgovcjVGSDVMQ2xCNlJDK2VaU29GNURvYU5MY25xZGFkV3FTcW0rYml2ZS85WGszMHF0TERQL0o4WGQ2Y1BXQjZZCjVUd2JOWmVnOHlPb0t4a0d6NDJMYzJ1UlV2VlR3bXJOVEdtVlNnUkZEdE5BeWZlbGNkOEtLank4VVpOSTJ1cTcKK3ZoenJsbVBPRnlHU2RFSEFFajBrbXVXM2xpUGRTNXRBOEJPUVlCQVVuVWRiVUVaSjdsSFpGdDNwYURoYVJuQwp0V2hqU3ZmZ0diS0ZzeldmOXlhRzZFYVhFMEgzQUJaSTBxcWhyeVdmQlhMb1YzY0lYbHNsbzFhanhLcmhSK0JVCjVKbUlyQlhiczh6VEFxbFZ6V2daK1ExL1JoSnkrUy95amtuZkhmMFUyOC9ZNkxyN1RIS0MyQTlnTW5RcnlRRjYKVDY2SkROcVdST1BaYjhlaS9nRFJBb0lCQVFESDFObUxnczdUdXB6dkhvN3ZYdkRnb3JWcGJkZ2l6WWNrejN6Zwp4a0lqTUNERkpVdmE1dTZ3ZEJZL1RUNlpPUDlTSXRxWlBEMjhJYmhySStPZkxlQzVJT2owbXFtSGdRSW94b3pvCmVleVdSNVdYWlpyUHVieVlrbCt2Sk1jNTRNRUp4ZHdPeHR2TkIzMkkwMXlhOVh0RmNkeVFLMWhEdG5kb0pseG8KY2NOaGczcjVRTmxNY1UxY3RHK2NzL2RrQWlSQTZ4OXRkcGdzWWFrVVVLdjlPUTB4VFpDTVN0R3U3VlNobC9MWgorRTdSbnFVQ3RkWU05dzRTRzNVQ2FtazNobENmUXAwb2RQZGg1eUJ6K0w5elk5OFdDOUZrWjFZeEp6L1FqbXVjClhxTVZ5ZGFrTTdCSHJWUFA4K0xLTjlmb2NaU0FpamJ5bGUxZ3kxZlJta1RQM1RoUEFvSUJBUURmRDFYYUIxbEsKd2ZvMCtlS2tiRDFadWRlU29DdkFkWW80ZEswY0wzRVY2TUxycmNmdFVWWGxVUW9EOTZHcVpaZlZodjFtTzg2bQpuRUF5UTg1SG91aG1EZy9teU9DRUVFMWxiVmpPTkl0c2ZxQ1JGNVBOSTZCc0NXTHpKS1pVUGtKOGhBRzdQbWxkCm02UTA3Z2wwb2VVUlRDVmZ3dXZycFdkd09SREUvSUxPbzI4aXFxNGRsNUNOWVpvUE91bDJYK3U4V2RkOHhUZk0KVFFJWlZwMm1OMTU0VnlDR29HUmxIVytzQ1k5QXgzZzNIUTI3Yjgzc2kvRzMyeTVSVmduWjNWeXdmRHRQazdaUApiUkYzMWpiUlNwU20xb3R4anJYamJzOUliWGg5eUZZbm4vSU5rZC90SVg3Sml5QTQ3RXN1MUtXTVVwVXNuQ2VVCkUvMDlLS3NiNkxaRkFvSUJBR2FadWF5dzErTE1FT0dSVGhCSExlUVlobzZBTUpZRjh0cUtrZktTdU1oNllJajQKa2s3dGZTWXFKSFlTQWc4SHZjZjlUMEdZTlpaUHRmR0V0czAyOEFmOWhyNTRYb3pOUnorS1dqVE96Uk9INDUyZApOSFJ0U0JFS0xvaXRtSUQyRGdjbmlNb3BmaGR5UGhrdmRIKzNoTGh1TXJIdkgxMTg1U2diY2h6S05HZnY2d2JwCkxlamF6NzdHZ2Z2eVJ4WVpKMllSa3N4UU5PZXNxUFJlUzBBenQ3dFZ1TjdmVjNPNk5WYld2b0Q5eGZKSXd5NTIKRUZZTnp6S3EyRlFLTU1XcWQrQ2RnaldRZ0tmSzFOWFdwTzNwSEZTa2NybGJlVnk1YTBGNHJuWFYvV1FsZ3NoQwpKY05Ya2czV2lkNEwrQlpIb3Rpd25tL0ZYT0R5NXI4ZXR6QUd4RzhDZ2dFQUUvNFo0Y3JhMC9xQzVKQ3BJYmVaCjRCcnFHWGhGczZCVlhTNEgvZ2k2aUE0dXVsVC9JR1F6NExQY3cvSkVDVFBGNGh1UlJzS0JpU2xrRDUxSU5kK0MKR1BPVnRVZTM1OTVXTVlzVmRKWDlFU0pnWGVEUkhJZmU3eEFBVUc2dWdjcDZ4eEpGM1hTQW1TVkVHSUpsVXBEWQpLUzY4QXRORHRnRkRQaW0vT1FpdzZMaDVVNUFjdndaQXJJdGM5WlNBTEYzNGtRODBZemlDQWN1OUxtdzNBUmpoClhNUGlaRzZuMFBCTWZBejNUQVVVMzB1NVdWMXlCWXVkaEs4ZWZhZktoajV5K2xhSU1sKzQ3WEdIS1VpSDdVWlUKQUlnbVEyMVpIQ05vYk1OekUwTUxoYzJ1TWswcTF1UXpxdmpQVUlyTlNrdEE4MHpMbGc0QTlpSzhoZWpKUFYwawpTUUtDQVFFQWxuWlMzR2NrTTBjRlJibm9VUmp4M2VEUFhrZldEUis0c29FUk9OTndLRnVLaDRRU3M0SGVONTIwCjlBOXlxald5NTVRNUJSamhaNHprOWhMdEVPTERsL3BSQWUxbjNGNmtxZGJocG5XTk9iOWhFRnFRWGJZdmY4bk8KRzdWbkwra0FqUDhXbHAwMERudEtzT0VvVUpGYWRMK3AxdDIrSnlCOXlhUmJjRUFneWxIM1ZUN3hpdUg1NFUwMwpCZ1hqQ0ZhMll0Mjg0L0FkWkRGMWx3c1E3alpUSFAxa3pSbVphYmhKemZCa3ZYTGtVL0JRZ0Q4amtzTFVmN2tICmVYTDFMbVJGTUwxejgxYjRXZE42RXBEUXNFckNWdGYzdnByMGFaRzFlcmZ4U2E1VWs4b3lWYnlvL0sxTHIremIKaytOc2wyQ1dtOUd5UWtSd3BZd0VkNk13MFNDcXR3PT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=
    
# æŸ¥çœ‹è¯ä¹¦
[root@node1 ~]#echo "LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUR6RENDQXJRQ0ZGY3lqanV6VXpFUmVXcVV4MkNmVkpYcDJSTFhNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1CVXgKRXpBUkJnTlZCQU1UQ210MVltVnlibVYwWlhNd0hoY05NalV3TVRBM01UTXdNakU1V2hjTk16VXdNVEExTVRNdwpNakU1V2pBd01RMHdDd1lEVlFRRERBUjNZVzVuTVI4d0hRWURWUVFLREJacmRXSmxZV1J0T21Oc2RYTjBaWEl0CllXUnRhVzV6TUlJQ0lqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FnOEFNSUlDQ2dLQ0FnRUFyaDVoL1NOWDdSZHEKem04UzB1UUUwKzFRNkI3dklmQm5QK0xWbWkvS0crVHB5N0YwKzM1K2dsNy80NCsvc1RmcFR1SlNEYVh6VTVydwpOd3NyNlNqV2o3NVlYOCtBSVlja0VWVVNwS3hwUkJ0ZDJjbENUanF3bTVHZ21EUk1Ca1ptNzl1S1NmdmZKZnZqCjF5M3U1Q0lhTmNjZWJia29TdUZXeUtxWHQwcEM5WTFDTWhpV0FoNjFJRVU5UFZjSURqK0JoNjNSNS8yOXJSZHEKTk52ZlNuYUY0c2dVL09wRTZXd3lMdUQ4aVhLdFBMeUExa0tpbE5RaWlsS0NFbm13RmxLNVk5N3EwQU45RElRbgpmbStleGhDTnRwdHhvU3R6OXE1aHM2QWUvK041azBKZDQ1Q0dUZm5NbzMvYjE4SDdxSGlvaVlvUXNEaitlWkt3Ck9ua3A0YmVDZXAyZGZxNDlKcG1FOGprY0FUd2NtMFJoVFlUbG5IZ1crZWczSjV3SkRhT2RGRlVUQ29rOUhIS0kKMy9UMzVwdnZaNWRLcXJKYjJHajdFT210bUp5MGowQ2YvaVB1QkxBK0lwbm12NGg3TmFjaDAwb0p2LytBV3pUegpHOGRTcWhHMWR1ekFNOG9uZlBiU292Y0ZaYmZmSUhPSEpydlVxdkF1Y25aanNCQnFTbmt0d2U3L05hbWU0WDk5ClVZVU9TNVBHVGdBWG1WaUEyb1NpOWxaSnB4czVBZkhwUllKenpQRlFNZnFxS2o1VUhaV0ZzSW5JR25rTm5XcEkKNWtRcWZMUFNvSGVVQmp2TytqU3pLSnZyeTBJTGtyZmgzRHN0THlYV3kyK0pnaFQrUFprT0J5RnZma1VBVlpKRgpsUUtuN0czZlZXYmxDeUdOU0NjaHB0Z3FnNmxBVjBzQ0F3RUFBVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBCkpRdGRsblQvRm5PRklDeFY3NDFJNHRRT1dROEhWdVU4Y1F6eDV2b3FtZmU1OStZbUJxT2FPMjcxS0c2akVGMEsKTzM4RmNLVEltTGRhaHdXRkNWSkROV1B4cmFtM2FxUHoveXkxd0VXMkY1c0lSZ004VzAwc0tzTnNpMlR3MjJZawpiQ0NkUWYrZnhLTkh4TXJpS2FoYXYvNXFkWHA5elRkUFRLU1E2U0tTQm9Jd2NCYk1lTWZPWU1WZDdoSmJBdHFMCkh5ZmNOMkdHMW9LSjhMRDBrU1FHa1h2eEZQNFR6WThUenlEcnVFN0laMkJ3V0s1VFdlWXFXUTVXNjBNMnFMYncKLzlBMHJsMFhEM0hHZStpVkd3UWdYWXkxaWhhOUZaSUpTb3lVLzJhd2MvU3pENkFTWkFGNGpLOXZxa29iTHdjdgpQdTQzUmJicFl2WXJPNU9qakxWdm13PT0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo=" |base64 -d|openssl x509 -noout -text
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
            57:32:8e:3b:b3:53:31:11:79:6a:94:c7:60:9f:54:95:e9:d9:12:d7
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN = kubernetes
        Validity
            Not Before: Jan  7 13:02:19 2025 GMT
            Not After : Jan  5 13:02:19 2035 GMT
        Subject: CN = wang, O = kubeadm:cluster-admins    # ç®¡ç†å‘˜ç»„
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (4096 bit)
                Modulus:
                ......
                
# æ–¹æ³•2ï¼šé™æ€ä»¤ç‰Œè®¤è¯
kubectl config set-credentials wang --token="xxxxxxx" -- kubeconfig=$HOME/.kube/mykube.conf

# 3) åœ¨kubeconfigä¸­æ·»åŠ context,å®žçŽ°é›†ç¾¤å’Œç”¨æˆ·å…³è”
[root@node1 ~]# kubectl config set-context wang@mykube --cluster=mykube --user=wang --kubeconfig=$HOME/.kube/mykube.conf
Context "wang@mykube" created.

# ä½¿ç”¨æŒ‡å®šçš„contextè®¿é—®é›†ç¾¤
[root@node1 ~]#kubectl get ns --context="wang@mykube"  --kubeconfig=.kube/mykube.conf
NAME              STATUS   AGE
default           Active   4d2h
ingress-nginx     Active   4d
kube-flannel      Active   4d2h
kube-node-lease   Active   4d2h
kube-public       Active   4d2h
kube-system       Active   4d2h
metallb-system    Active   4d

# è®¾ç½®é»˜è®¤context
[root@node1 ~]#kubectl config use-context wang@mykube --kubeconfig=.kube/mykube.conf
Switched to context "wang@mykube".

# æŸ¥çœ‹
[root@node1 ~]#kubectl get nodes --kubeconfig=.kube/mykube.conf
NAME      STATUS   ROLES           AGE    VERSION
master1   Ready    control-plane   4d2h   v1.30.8
node1     Ready    <none>          4d2h   v1.30.8
node2     Ready    <none>          4d2h   v1.30.8
node3     Ready    <none>          4d2h   v1.30.8

# æŸ¥çœ‹kubeconfigå†…å®¹
[root@node1 ~]#kubectl config view --kubeconfig=.kube/mykube.conf --raw


# ä½¿ç”¨kubeconfigæ€»ç»“
1)kubectl get pods --kubeconfig=$HOME/.kube/mykube.conf
2)export KUBECONFIG="$HOME/.kube/mykube.conf"; kubectl get pods 
3)kubectl get pods 
```



**æŸ¥çœ‹é»˜è®¤çš„kubeconfigé…ç½®å†…å®¹**

```bash
# æŸ¥çœ‹é»˜è®¤çš„é…ç½®æ–‡ä»¶å†…å®¹
[root@master1 ~]# kubectl config view
apiVersion: v1
clusters:                                                  # é›†ç¾¤åˆ—è¡¨
- cluster:
    certificate-authority-data: DATA+OMITTED               # è¯ä¹¦è®¤è¯æ–¹å¼
    server: https://master1.mystical.org:6443              # api_serverçš„åœ°å€
  name: kubernetes                                         # å½“å‰é›†ç¾¤åç§°
contexts:                                                  # ä¸Šä¸‹æ–‡åˆ—è¡¨ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å¤šé›†ç¾¤é—´ç”¨æˆ·çš„åˆ‡æ¢æ‰€éœ€çš„çŽ¯å¢ƒå±žæ€§
- context:
    cluster: kubernetes                                    # é›†ç¾¤åç§°ï¼škubernetes
    user: kubernetes-admin                                 # ä½¿ç”¨kubernetes-adminç”¨æˆ·æ¥è®¿é—®é›†ç¾¤kubernetes
  name: kubernetes-admin@kubernetes                        # è¯¥contextçš„åç§°æ ‡å‡†å†™æ³•
current-context: kubernetes-admin@kubernetes               # å½“å‰æ­£åœ¨ä½¿ç”¨çš„ä¸Šä¸‹æ–‡çš„åç§°
kind: Config
preferences: {}
users:                                                     # ç”¨æˆ·åˆ—è¡¨
- name: kubernetes-admin                                   # ç”¨æˆ·åç§°
  user:                                                    # ç”¨æˆ·è‡ªå·±è®¤è¯å±žæ€§
    client-certificate-data: DATA+OMITTED                  # å®¢æˆ·ç«¯è¯ä¹¦
    client-key-data: DATA+OMITTED                          # å®¢æˆ·ç«¯ç§é’¥

# ç»“æžœæ€»ç»“
# ä¸€ä¸ªconfigä¸»è¦åŒ…å«äº†ä¸‰éƒ¨åˆ†å†…å®¹ï¼šusersã€clustersã€contextsï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰ä¸¤éƒ¨åˆ†ç»„æˆï¼š
# nameå’Œuser|cluster|context
# å¯¹äºŽclusterï¼Œå¯¹å¤–çš„åœ°å€-server å’Œ åŸºæœ¬çš„è®¤è¯æ–¹å¼-certificate-authority-data
# å¯¹äºŽcontextï¼Œè¿žæŽ¥åˆ°çš„é›†ç¾¤-cluster å’Œ è¿žæŽ¥é›†ç¾¤çš„ç”¨æˆ·-user
# å¯¹äºŽuserï¼Œè¿žæŽ¥é›†ç¾¤çš„è®¤è¯æ–¹å¼-client-certificate-data å’Œ ç§é’¥ä¿¡æ¯-client-key-data
# current-contextè¡¨æ˜Žæˆ‘ä»¬æ˜¯å¤„äºŽå“ªä¸€ä¸ªçŽ¯å¢ƒä¸­ã€‚
```



##### åˆå¹¶å¤šä¸ªkubeconfigæ–‡ä»¶

å®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡å¤šç§é€”å¾„èŽ·å–åˆ°kubeconfigæ–‡ä»¶æ—¶ï¼Œå°†éµå¾ªå¦‚ä¸‹ä¼˜å…ˆçº§é¡ºåºè¿›è¡Œæ–‡ä»¶åˆå¹¶

- è®¾ç½®äº†**--kubeconfigå‚æ•°**æ—¶ï¼Œåˆ™ä»…ä½¿ç”¨æŒ‡å®šçš„æ–‡ä»¶ï¼Œä¸”ä¸è¿›è¡Œåˆå¹¶ï¼›è¯¥å‚æ•°åªèƒ½ä½¿ç”¨ä¸€æ¬¡ï¼Œå³**ä¸æ”¯æŒå¤šä¸ªæ–‡ä»¶åˆå¹¶**
- è‹¥è®¾ç½®äº†**KUBECONFIGçŽ¯å¢ƒå˜é‡**ï¼Œåˆ™**å¯ä»¥æŒ‡å®šç”¨å†’å·åˆ†éš”çš„å¤šä¸ªæ–‡ä»¶**ï¼Œ**è¿›è¡Œåˆå¹¶å¤„ç†è§„åˆ™**
  - å¿½ç•¥ä¸å­˜åœ¨çš„æ–‡ä»¶
  - é‡åˆ°å†…å®¹æ— æ³•ååºåˆ—åŒ–çš„æ–‡ä»¶æ—¶ï¼Œå°†ç”Ÿæˆé”™è¯¯ä¿¡æ¯
  - æ–‡ä»¶åˆ—è¡¨ä¸­ï¼Œç¬¬ä¸€ä¸ªè®¾å®šäº†ç‰¹å®šå€¼æˆ–æ˜ å°„é”®(map key)çš„æ–‡ä»¶æ˜¯ä¸ºç”Ÿæ•ˆæ–‡ä»¶ï¼Œå³**ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¼˜å…ˆç”Ÿæ•ˆ**
    - ä¿®æ”¹æŸä¸ªæ˜ å°„é”®çš„å€¼æ—¶ï¼Œå°†ä¿®æ”¹åˆ—è¡¨ä¸­ç¬¬ä¸€ä¸ªå‡ºçŽ°è¯¥é”®çš„æ–‡ä»¶ä¸­çš„å†…å®¹
    - åˆ›å»ºä¸€ä¸ªé”®æ—¶ï¼Œå…¶å°†ä¿å­˜äºŽåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ä¸­
    - è‹¥åˆ—è¡¨ä¸­æŒ‡å®šçš„æ–‡ä»¶å‡ä¸å­˜åœ¨æ—¶ï¼Œåˆ™è‡ªåŠ¨åˆ›å»ºåˆ—è¡¨ä¸­çš„æœ€åŽä¸€ä¸ªæ–‡ä»¶
- å°†ä½¿ç”¨é»˜è®¤çš„${HOME}/**.kube/config**ï¼Œä¸”**ä¸è¿›è¡Œåˆå¹¶**

```ABAP
ä»¥ä¸Šè¯´æ˜Ž: åªæœ‰KUBECONFIGå˜é‡ä¸€ç§æ–¹å¼æ‰æ”¯æŒåˆå¹¶å¤šä¸ªkubeconfigæ–‡ä»¶
```



**åˆ©ç”¨KUBECONFIGå˜é‡åˆå¹¶å¤šä¸ªæ–‡ä»¶**

```bash
# è®¾ç½®çŽ¯å¢ƒå˜é‡
[root@node1 ~]#export KUBECONFIG="/root/.kube/config:/root/.kube/mykube.conf"

# æŸ¥çœ‹
[root@node1 ~]#kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://master1.mystical.org:6443
  name: kubernetes
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://10.0.0.201:6443
  name: mykube
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
- context:
    cluster: mykube
    user: wang
  name: wang@mykube
current-context: kubernetes-admin@kubernetes           # é»˜è®¤å·¦è¾¹çš„æ–‡ä»¶ç”Ÿæ•ˆ
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: DATA+OMITTED
    client-key-data: DATA+OMITTED
- name: wang
  user:
    client-certificate-data: DATA+OMITTED
    client-key-data: DATA+OMITTED
    
    
#ä½¿ç”¨å½“å‰contextèº«ä»½kubernetes-admin@kubernetesè®¿é—®
[root@node1 ~]# kubectl get nodes
NAME      STATUS   ROLES           AGE    VERSION
master1   Ready    control-plane   4d4h   v1.30.8
node1     Ready    <none>          4d4h   v1.30.8
node2     Ready    <none>          4d4h   v1.30.8
node3     Ready    <none>          4d4h   v1.30.8
```



#### User Account ç»¼åˆæ¡ˆä¾‹



##### UAåˆ›å»ºæµç¨‹

ä»¥åŸºäºŽX509çš„å®¢æˆ·ç«¯ä¸ºä¾‹,ç”¨æˆ·è®¤è¯çš„åˆ›å»ºæµç¨‹

**åˆ›å»ºè¯ä¹¦**

- åˆ›å»ºç§é’¥æ–‡ä»¶
  - å¯¹äºŽç”¨æˆ·åå’Œç”¨æˆ·ç»„éœ€è¦æå‰è§„åˆ’å¥½ï¼Œå¦‚æžœç”¨æˆ·å¤šæƒé™é›†ä¸­çš„æƒ…å†µä¸‹ï¼Œä¸€å®šè¦è§„åˆ’å¥½ç”¨æˆ·ç»„ä¿¡æ¯
- åŸºäºŽç§é’¥æ–‡ä»¶åˆ›å»ºè¯ä¹¦ç­¾åè¯·æ±‚
  - è¦åŸºäºŽæˆ‘ä»¬è‡ªå»ºçš„ç§é’¥æ¥åˆ›å»ºç­¾è¯è¯·æ±‚æ–‡ä»¶
- åŸºäºŽç§é’¥å’Œç­¾åè¯·æ±‚ç”Ÿæˆè¯ä¹¦æ–‡ä»¶
  - å› ä¸ºç”Ÿæˆçš„è¯ä¹¦è¦åº”ç”¨åœ¨kubernetesçŽ¯å¢ƒä¸­ï¼Œæ‰€ä»¥å¿…é¡»ç”±kubernetesçš„å…¨å±€è¯ä¹¦æ¥è®¤è¯



**åˆ›å»ºuser**

- åŸºäºŽè¯ä¹¦æ–‡ä»¶åœ¨k8sä¸Šåˆ›å»ºç”¨æˆ· credentials

  ```bash
  kubectl config set-credentials wang --embed-certs=true --client-certificate=pki/wang.crt --client-key=pki/wang.key --kubeconfig=$HOME/.kube/mykube.conf
  ```



**åˆ›å»ºCluster**

- åˆ›å»ºå·¥ä½œåŒºåŸŸ-cluster

  - æ‰€è°“çš„å·¥ä½œåŒºåŸŸæ˜¯ç”¨æˆ·çš„å·¥ä½œåœºæ™¯ï¼Œå¿…é¡»å®šåˆ¶å¥½ï¼Œä¸€ä¸ªclusterå¯ä»¥è¢«å¤šä¸ªç”¨æˆ·ä½¿ç”¨

  ```bash
  kubectl config set-cluster mykube --embed-certs=true --certificate-authority=/etc/kubernetes/pki/ca.crt --server="https://10.0.0.201:6443" --kubeconfig=$HOME/.kube/mykube.conf
  ```

  

**å…³è” user å’Œ cluster**

- å°†clusterå’Œuserå…³è”èµ·æ¥-context

- å…³è”çš„ä½œç”¨å°±æ˜¯ï¼Œå°†ç”¨æˆ·å’ŒåŒºåŸŸæ•´åˆåœ¨ä¸€èµ·ï¼Œä½¿ç”¨èµ„æºçš„æ—¶å€™ä¾¿äºŽè°ƒç”¨

  ```bash
  kubectl config set-context wang@mykube --cluster=mykube --user=wang --kubeconfig=$HOME/.kube/mykube.conf
  ```

  

**éªŒè¯ç”¨æˆ·**

- å› ä¸ºå‰é¢åªåšäº†è®¤è¯ï¼Œè€Œç”¨æˆ·çš„æ“ä½œæ¶‰åŠåˆ°èµ„æºæƒé™ï¼Œè¿™éƒ¨åˆ†æ˜¯éœ€è¦ç»“åˆæŽˆæƒæœºåˆ¶æ‰èƒ½è¿›è¡Œ
- é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æžœå¦å¤–çš„æ²¡æœ‰æŽˆæƒ, åŸºäºŽåˆ›å»ºå¥½çš„æ–‡ä»¶æ¥èŽ·å–èµ„æºæ˜¯è¢«forbiddençš„





#####  åˆ›å»ºç§é’¥æ–‡ä»¶

```bash
# ç»™ç”¨æˆ·fengåˆ›å»ºä¸€ä¸ªç§é’¥ï¼Œå‘½åæˆï¼šfeng.keyï¼ˆæ— åŠ å¯†ï¼‰
[root@master1 ~]# (umask 077; openssl genrsa -out pki/feng.key 2048)

#å‘½ä»¤è§£æžï¼š
#    genrsa è¯¥å­å‘½ä»¤ç”¨äºŽç”ŸæˆRSAç§é’¥ï¼Œä¸ä¼šç”Ÿæˆå…¬é’¥ï¼Œå› ä¸ºå…¬é’¥æå–è‡ªç§é’¥
#    -out filename ç”Ÿæˆçš„ç§é’¥ä¿å­˜è‡³filenameæ–‡ä»¶ï¼Œè‹¥æœªæŒ‡å®šè¾“å‡ºæ–‡ä»¶ï¼Œåˆ™ä¸ºæ ‡å‡†è¾“å‡º
#    -numbits æŒ‡å®šç§é’¥çš„é•¿åº¦ï¼Œé»˜è®¤1024ï¼Œè¯¥é¡¹å¿…é¡»ä¸ºå‘½ä»¤è¡Œçš„æœ€åŽä¸€é¡¹å‚æ•°

# æŸ¥çœ‹
[root@master1 ~]# ls pki/
admin.crt  feng.key      mystical.key                             test2.csr  wang.csr
admin.csr  mystical.crt  security-certificaterequests-test2.yaml  test2.key  wang.key
admin.key  mystical.csr  test2.crt 
```



#####  ç­¾åè¯·æ±‚

```bash
# ç”¨åˆšåˆ›å»ºçš„ç§é’¥åˆ›å»ºä¸€ä¸ªè¯ä¹¦ç­¾åè¯·æ±‚æ–‡ä»¶ï¼šfeng.csr
[root@master1 ~]#openssl req -new -key pki/feng.key -out feng.csr -subj "/CN=feng/O=kubeadm:cluster-admins"

#å‚æ•°è¯´æ˜Žï¼š
    -new ç”Ÿæˆè¯ä¹¦è¯·æ±‚æ–‡ä»¶
    -key   æŒ‡å®šå·²æœ‰çš„ç§˜é’¥æ–‡ä»¶ç”Ÿæˆç­¾åè¯·æ±‚ï¼Œå¿…é¡»ä¸Ž-newé…åˆä½¿ç”¨
    -out è¾“å‡ºè¯ä¹¦æ–‡ä»¶åç§°
    -subj è¾“å…¥è¯ä¹¦æ‹¥æœ‰è€…ä¿¡æ¯ï¼Œè¿™é‡ŒæŒ‡å®š CN ä»¥åŠ O çš„å€¼ï¼Œ/è¡¨ç¤ºå†…å®¹åˆ†éš”
           CNä»¥åŠOçš„å€¼å¯¹äºŽkuberneteså¾ˆé‡è¦ï¼Œå› ä¸ºkubernetesä¼šä»Žè¯ä¹¦è¿™ä¸¤ä¸ªå€¼å¯¹åº”èŽ·å–ç›¸å…³ä¿¡æ¯ï¼š
       "CN"ï¼šCommon Nameï¼Œç”¨äºŽä»Žè¯ä¹¦ä¸­æå–è¯¥å­—æ®µä½œä¸ºè¯·æ±‚çš„ç”¨æˆ·å (User Name)ï¼›æµè§ˆå™¨ä½¿ç”¨è¯¥å­—æ®µéªŒè¯ç½‘ç«™æ˜¯å¦åˆæ³•ï¼›
       "O"ï¼š Organizationï¼Œç”¨äºŽåˆ†ç»„è®¤è¯
# æ³¨æ„ï¼š ç”¨æˆ·æ˜¯feng,ç»„æ˜¯kubeadm:cluster-admins

# æŸ¥çœ‹
[root@master1 ~]#ls pki/
admin.crt  feng.csr      mystical.csr                             test2.crt  wang.crt
admin.csr  feng.key      mystical.key                             test2.csr  wang.csr
admin.key  mystical.crt  security-certificaterequests-test2.yaml  test2.key  wang.key
#ç»“æžœæ˜¾ç¤ºï¼š*.key æ˜¯ç§é’¥ï¼Œ*.csræ˜¯ç­¾åè¯·æ±‚æ–‡ä»¶
```



##### **ç”Ÿæˆè¯ä¹¦**

åˆšæ‰çš„ç§é’¥å’Œè®¤è¯å¹¶æ²¡æœ‰è¢«Kubernetesé›†ç¾¤çº³å…¥åˆ°ç®¡ç†ä½“ç³»ï¼Œéœ€è¦åŸºäºŽkubeadmé›†ç¾¤çš„CAç›¸å…³è¯ä¹¦æ¥ è¿›è¡Œè®¤è¯

CAç›¸å…³æ–‡ä»¶ä½äºŽ/etc/kubernetes/pki/ç›®å½•ä¸‹é¢ï¼Œåˆ©ç”¨è¯¥ç›®å½•ä¸‹é¢çš„ca.crtå’Œca.keyä¸¤ä¸ªæ–‡ä»¶æ¥æ‰¹å‡†ä¸Šé¢ çš„è¯ä¹¦è¯·æ±‚

```bash
[root@master1 ~]# cd /etc/kubernetes/pki
[root@master1 pki]#openssl x509 -req -CA ./ca.crt -CAkey ./ca.key -CAcreateserial -in /root/pki/feng.csr -out /root/pki/feng.crt  -days 365 
Certificate request self-signature ok
subject=CN = feng, O = kubeadm:cluster-admins


#å‚æ•°è¯´æ˜Žï¼š
    -req                 äº§ç”Ÿè¯ä¹¦ç­¾å‘ç”³è¯·å‘½ä»¤
    -in                  æŒ‡å®šéœ€è¦ç­¾åçš„è¯·æ±‚æ–‡ä»¶
    -CA                  æŒ‡å®šCAè¯ä¹¦æ–‡ä»¶
    -CAkey               æŒ‡å®šCAè¯ä¹¦çš„ç§˜é’¥æ–‡ä»¶
    -CAcreateserial      ç”Ÿæˆå”¯ä¸€çš„è¯ä¹¦åºåˆ—å·
    -x509                è¡¨ç¤ºè¾“å‡ºä¸€ä¸ªX509æ ¼å¼çš„è¯ä¹¦
    -days                æŒ‡å®šè¯ä¹¦è¿‡æœŸæ—¶é—´ä¸º365å¤©
    -out                 è¾“å‡ºè¯ä¹¦æ–‡ä»¶
    
# æ£€æŸ¥æ–‡ä»¶æ•ˆæžœ[root@master1 pki]# ls /root/pki/
admin.crt  feng.csr      mystical.key                             test2.key
admin.csr  feng.key      security-certificaterequests-test2.yaml  wang.crt
admin.key  mystical.crt  test2.crt                                wang.csr
feng.crt   mystical.csr  test2.csr                                wang.key
#ç»“æžœæ˜¾ç¤ºï¼š*.crtå°±æ˜¯æœ€ç»ˆç”Ÿæˆçš„ç­¾è¯è¯ä¹¦

# æŸ¥çœ‹è¯ä¹¦ä¿¡æ¯
[root@master1 pki]#openssl x509 -in /root/pki/feng.crt -noout -text
Certificate:
    Data:
        Version: 1 (0x0)
        Serial Number:
            08:b6:f7:4d:94:a6:7f:15:ed:18:36:29:c0:4b:1a:d0:85:1c:de:f9
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: CN = kubernetes
        Validity
            Not Before: Jan  8 06:38:55 2025 GMT
            Not After : Jan  8 06:38:55 2026 GMT
        Subject: CN = feng, O = kubeadm:cluster-admins
        Subject Public Key Info:
            Public Key Algorithm: rsaEncryption
                Public-Key: (2048 bit)
                ......
#ç»“æžœæ˜¾ç¤ºï¼šIssuer: è¡¨ç¤ºæ˜¯å“ªä¸ªCAæœºæž„å¸®æˆ‘ä»¬è®¤è¯çš„,æˆ‘ä»¬å…³æ³¨çš„é‡ç‚¹åœ¨äºŽSubjectå†…å®¹ä¸­çš„è¯·æ±‚ç”¨æˆ·æ‰€å±žçš„ç»„ä¿¡æ¯
```



##### åˆ›å»ºKubernetesç”¨æˆ·

```bash
#åˆ›å»ºç”¨æˆ·ä¿¡æ¯
[root@master1 pki]# kubectl config set-credentials feng --client-certificate=/root/pki/feng.crt --client-key=/root/pki/feng.key --embed-certs=true --kubeconfig=/tmp/feng.conf
User "feng" set.

#å‚æ•°è¯¦è§£ï¼š
set-credentials                          #å­å‘½ä»¤çš„ä½œç”¨å°±æ˜¯ç»™kubeconfigè®¤è¯æ–‡ä»¶åˆ›å»ºä¸€ä¸ªç”¨æˆ·æ¡ç›®
--client-certificate=path/to/certfile    #æŒ‡å®šç”¨æˆ·çš„ç­¾è¯è¯ä¹¦æ–‡ä»¶
--client-key=path/to/keyfile             #æŒ‡å®šç”¨æˆ·çš„ç§é’¥æ–‡ä»¶
--embed-certs=true                       #åœ¨kubeconfigä¸­ä¸ºç”¨æˆ·æ¡ç›®åµŒå…¥å®¢æˆ·ç«¯è¯ä¹¦/å¯†é’¥ï¼Œé»˜è®¤å€¼æ˜¯false
--kubeconfig=/path/other_config.file     #è¡¨ç¤ºå°†å±žæ€§ä¿¡æ¯å•ç‹¬è¾“å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ï¼Œå¦‚ä¸æŒ‡å®šï¼Œé»˜è®¤å­˜æ”¾åœ¨ ~/.kube/configæ–‡ä»¶ä¸­

# æŸ¥çœ‹ç”Ÿæˆæ–‡ä»¶
[root@master1 pki]#cat /tmp/feng.conf
apiVersion: v1
clusters: null
contexts: null
current-context: ""
kind: Config
preferences: {}
users:
- name: feng
  user:
......

# æŸ¥çœ‹æ•ˆæžœ
kubect
[root@master1 pki]# kubectl config view --kubeconfig=/tmp/feng.conf 
apiVersion: v1
clusters: null
contexts: null
current-context: ""
kind: Config
preferences: {}
users:
- name: feng
  user:
    client-certificate-data: DATA+OMITTED
    client-key-data: DATA+OMITTED
```



##### åˆ›å»ºé›†ç¾¤

```bash
#åˆ›å»ºä¸€ä¸ªæ–°çš„é›†ç¾¤mycluster
[root@master1 pki]# kubectl config set-cluster fengcluster --server="https://10.0.0.201:6443" --certificate-authority=./ca.crt --embed-certs=true --kubeconfig=/tmp/feng.conf 
Cluster "fengcluster" set.

#å‚æ•°è¯¦è§£ï¼š
--server=cluster_api_server
--certificate-authority=path/to/certificate/authority
--embed-certs=true  #é»˜è®¤ä¸ºfalse,ä¼šå°†è¯ä¹¦æ–‡ä»¶è·¯å¾„å­˜å…¥kubeconfigæ–‡ä»¶ä¸­,trueæ—¶ä¼šå°†è¯ä¹¦å†…å®¹å­˜å…¥kubdconfigæ–‡ä»¶ä¸­
#æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨åˆ°çš„è¯ä¹¦å¿…é¡»æ˜¯kubernetesçš„caè¯ä¹¦

# æ£€æŸ¥æ•ˆæžœ
[root@master1 pki]#kubectl config view --kubeconfig=/tmp/feng.conf
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://10.0.0.201:6443
  name: fengcluster
contexts: null
current-context: ""
kind: Config
preferences: {}
users:
- name: feng
  user:
    client-certificate-data: DATA+OMITTED
    client-key-data: DATA+OMITTED
```



##### å…³è”ç”¨æˆ·å’Œé›†ç¾¤

æ‰€è°“å…³è”å®žé™…ä¸Šå°±æ˜¯è®¾ç½®ç”¨æˆ·èƒ½åœ¨å“ªä¸ªé›†ç¾¤çš„ä½¿ç”¨

```bash
#é…ç½®ä¸Šä¸‹æ–‡ä¿¡æ¯
[root@master1 pki]#kubectl config set-context feng@fengcluster --cluster=fengcluster --user=feng --kubeconfig=/tmp/feng.conf 
Context "feng@fengcluster" created.

#å±žæ€§è¯¦è§£
--cluster=cluster_nickname     # å…³è”çš„é›†ç¾¤åç§°
--user=user_nickname           # å…³è”çš„ç”¨æˆ·åç§°
--namespace=namespace          # å¯ä»¥è®¾ç½®è¯¥ç”Ÿæ•ˆçš„å‘½åç©ºé—´

#æœ€ç»ˆæ•ˆæžœ
[root@master1 pki]#kubectl config view --kubeconfig=/tmp/feng.conf
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://10.0.0.201:6443
  name: fengcluster
contexts:
- context:
    cluster: fengcluster
    user: feng
  name: feng@fengcluster
current-context: ""
kind: Config
preferences: {}
users:
- name: feng
  user:
    client-certificate-data: DATA+OMITTED
    client-key-data: DATA+OMITTED
```



##### éªŒè¯æ•ˆæžœ

```bash
#æ ¹æ®åˆšæ‰çš„ä¿¡æ¯æ˜¾ç¤ºï¼Œcurrent-contextçš„ä¿¡æ¯æ˜¯ç©ºï¼Œé‚£ä¹ˆåˆ‡æ¢ä¸Šä¸‹æ–‡
#æ›´æ”¹ä¸Šä¸‹æ–‡
[root@master1 pki]# kubectl config use-context feng@fengcluster --kubeconfig=/tmp/feng.conf 
Switched to context "feng@fengcluster".

# éªŒè¯è®¿é—®
[root@master1 pki]#kubectl get nodes --kubeconfig=/tmp/feng.conf 
NAME      STATUS   ROLES           AGE    VERSION
master1   Ready    control-plane   4d5h   v1.30.8
node1     Ready    <none>          4d5h   v1.30.8
node2     Ready    <none>          4d5h   v1.30.8
node3     Ready    <none>          4d5h   v1.30.8
```





#### Service Account ç®¡ç†

#####  Service Account åŸºç¡€

**Service Account åŠŸèƒ½**

- KubernetesåŽŸç”Ÿï¼ˆkubernetes-nativeï¼‰åº”ç”¨æ‰˜ç®¡è¿è¡ŒäºŽKubernetesä¹‹ä¸Šï¼Œé€šå¸¸éœ€è¦ç›´æŽ¥ä¸ŽAPI  Serverè¿›è¡Œäº¤äº’ä»¥èŽ·å–å¿…è¦çš„ä¿¡æ¯
- API ServeråŒæ ·éœ€è¦å¯¹è¿™ç±»æ¥è‡ªäºŽPodèµ„æºä¸­å®¢æˆ·ç«¯ç¨‹åºè¿›è¡Œèº«ä»½éªŒè¯ï¼ŒService Accountä¹Ÿå°±æ˜¯è®¾è®¡ä¸“ç”¨äºŽè¿™ç±»åœºæ™¯çš„è´¦å·
- ServiceAccountæ˜¯API Serveræ”¯æŒçš„æ ‡å‡†èµ„æºç±»åž‹ä¹‹ä¸€





**ServiceAccontï¼šæ ‡å‡†çš„APIèµ„æºç±»åž‹**

- åŸºäºŽèµ„æºå¯¹è±¡ä¿å­˜ServiceAccountçš„æ•°æ®
- è®¤è¯ä¿¡æ¯ä¿å­˜äºŽServiceAccountå¯¹è±¡ä¸“ç”¨çš„Secretä¸­
- éš¶å±žåç§°ç©ºé—´çº§åˆ«ï¼Œä¸“ä¾›é›†ç¾¤ä¸Šçš„Podä¸­çš„è¿›ç¨‹è®¿é—®API Serveræ—¶ä½¿ç”¨
- éœ€è¦ç”¨åˆ°ç‰¹æ®Šæƒé™æ—¶ï¼Œå¯ä¸ºPodæŒ‡å®šè¦ä½¿ç”¨çš„è‡ªå®šä¹‰ServiceAccountèµ„æºå¯¹è±¡





**åœ¨Podä¸Šä½¿ç”¨Service Account**

- è‡ªåŠ¨è®¾å®šï¼šService Accounté€šå¸¸ç”±API Serverè‡ªåŠ¨åˆ›å»ºå¹¶é€šè¿‡ ServiceAccountå‡†å…¥æŽ§åˆ¶å™¨è‡ªåŠ¨å…³ è”åˆ°é›†ç¾¤ä¸­åˆ›å»ºçš„æ¯ä¸ªPodä¸Š

  - K8Sè‡ªåŠ¨ä¸ºæ¯ä¸ªPodæ³¨å…¥ä¸€ä¸ª ServiceAccount åŠé…å¥—çš„ä»¤ç‰Œ

  ```bash
  # é»˜è®¤å«defaultï¼Œæ¯ä¸ªåç§°ç©ºé—´éƒ½æœ‰ä¸€ä¸ªåä¸ºdefaultçš„saï¼Œè¯¥saæƒé™å¾ˆå°
  [root@master1 pki]#kubectl get sa -A |grep default
  default           default                                       0         4d5h
  ingress-nginx     default                                       0         4d3h
  kube-flannel      default                                       0         4d5h
  kube-node-lease   default                                       0         4d5h
  kube-public       default                                       0         4d5h
  kube-system       default                                       0         4d5h
  metallb-system    default                                       0         4d3h
  ```

- è‡ªå®šä¹‰ï¼šåœ¨Podè§„èŒƒä¸Šï¼Œä½¿ç”¨serviceAccountNameæŒ‡å®šè¦ä½¿ç”¨çš„ç‰¹å®šServiceAccount

- Podä¸­çš„å­—æ®µimagePullSecretsï¼Œå¯ä¸ºPodæä¾›ä»Žç§æœ‰image registryèŽ·å–æ—¶ä½¿ç”¨çš„è®¤è¯å‡­æ®

  ```bash
  imagePullSecrets:
        - name: harbor-docker-registry-secret  # æŒ‡å®šdocker-registryç±»åž‹çš„secretï¼Œå¦‚æžœæœ‰å¤šä¸ªä¼šé€ä¸ªéªŒè¯
  ```

  



**ä¸ºPodæä¾›å‘ç§æœ‰image registryæä¾›è®¤è¯å‡­æ®çš„æ–¹æ³•**

- pods.spec.imagePullSecrets: ç›´æŽ¥è°ƒç”¨çš„æ–¹å¼

- pods.spec.serviceAccountNameæŒ‡å®šä½¿ç”¨çš„ç‰¹æœ‰ServiceAccountï¼Œè€ŒåŽåœ¨ServiceAccountèµ„æºå¯¹è±¡ä¸Šï¼Œä½¿ç”¨serviceaccounts.imagePullSecrets æŒ‡å®š secret ,æ­¤ä¸ºé—´æŽ¥è°ƒç”¨çš„æ–¹å¼

  ```ABAP
  podä½¿ç”¨ServiceAccountï¼Œè¯¥SAä¸Šè®¾ç½®imagePullSecretsï¼Œä»Žè€Œå®žçŽ°Podèƒ½å¤Ÿä»Žç§æœ‰ä»“æ‹‰é•œåƒçš„æƒé™
  ```



**KubernetesåŸºäºŽä¸‰ä¸ªç»„ä»¶å®ŒæˆPodä¸Šservice accountçš„è‡ªåŠ¨åŒ–**

- ServiceAccount Admission Controller
- Token Controller
- ServiceAccount Controller



åœ¨æ¯ä¸ªåç§°ç©ºé—´ä¸­ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆ(ç”±ServiceAccountå‡†å…¥æŽ§åˆ¶å™¨è´Ÿè´£)ä¸€ä¸ªåç§°ä¸ºdefaultçš„ ServiceAccountï¼Œå¹¶é»˜è®¤å°†å…¶è‡ªåŠ¨åˆ†é…ç»™è¯¥ç©ºé—´ä¸‹çš„æ¯ä¸ªPodå…±äº«ä½¿ç”¨ã€‚

```bash
[root@master1 pki]#kubectl get sa -A |grep default
default           default                                       0         4d5h
ingress-nginx     default                                       0         4d3h
kube-flannel      default                                       0         4d5h
kube-node-lease   default                                       0         4d5h
kube-public       default                                       0         4d5h
kube-system       default                                       0         4d5h
metallb-system    default                                       0         4d3h
```

è®¤è¯ä»¤ç‰Œä¿å­˜äºŽè¯¥åç§°ç©ºé—´ä¸‹çš„ä¸€ä¸ªSecretå¯¹è±¡ä¸­ï¼Œè¯¥å¯¹è±¡ä¸­å…±æœ‰ä¸‰ä¸ªä¿¡æ¯ï¼šnamespaceã€ca.crtã€ token



**SA å°±æ˜¯é›†ç¾¤å†…éƒ¨èµ„æºæ“ä½œçš„è´¦å·**

- æ¯ä¸ªå‘½åç©ºé—´è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªåç§°ä¸ºdefaultçš„saç”¨æˆ·
- æ¯ä¸ªå‘½åç©ºé—´å¯ä»¥æœ‰å¾ˆå¤šsa
- saå†…éƒ¨æ˜¯secretsç±»åž‹çš„token



**ServiceAccountä½¿ç”¨ä¸“ç”¨çš„Secretç±»åž‹å­˜å‚¨ç›¸å…³çš„æ•æ„Ÿä¿¡æ¯**

- ç±»åž‹æ ‡è¯†ä¸ºâ€œkubernetes.io/serviceaccountâ€
- data å­—æ®µæœ‰ä¸‰ä¸ªå›ºå®šçš„å±žæ€§å­—æ®µï¼Œåç§°åˆ†åˆ«ä¸º
  - ca.crtï¼šKubernetes CAçš„æ•°å­—è¯ä¹¦
  - namespaceï¼šè¯¥ServiceAccountå¯é€‚ç”¨çš„åç§°ç©ºé—´
  - tokenï¼šè®¤è¯åˆ°API Serverçš„ä»¤ç‰Œ



**Podç”¨saä¸Šé™„åŠ çš„è®¤è¯å‡­æ®ï¼š**

- **Secretå·**ï¼šKubernetes-v1.23ç‰ˆæœ¬ä¹‹å‰,è¢«æŒ‚è½½è‡³ä¸€ä¸ªå›ºå®šè·¯å¾„`/var/run/secrets/kubernetes.io/serviceaccount`

  - åœ¨è¯¥è·¯å¾„ä¸‹å°†ä¼šå­˜åœ¨ä¸‰ä¸ªæ–‡ä»¶
    - ca.crtï¼škubernetes root caçš„è¯ä¹¦
    - namesapceï¼šç”Ÿæ•ˆçš„åç§°ç©ºé—´
    - tokenï¼šè®¤è¯ä»¤ç‰Œ

- **Projectedå·**ï¼šKubernetes-v1.24ç‰ˆæœ¬ä»¥åŽ, åŒæ ·æ˜ å°„åˆ°å›ºå®šè·¯å¾„`/var/run/secrets/kubernetes.io/serviceaccount/`

  - serviceAccountTokenï¼šç”¨äºŽServiceAccountçš„Tokenä¿¡æ¯æä¾›ç»™Podï¼ŒåŒæ ·ä¸ºtokenæ–‡ä»¶
  - configMap/kube-root-ca.crtï¼šå°†kubernetes root caè‡ªèº«çš„è¯ä¹¦æä¾›ç»™Podï¼ŒåŒæ ·ä¸ºca.crt
  - downwardAPI: metadata.namespaceï¼Œç”¨äºŽé™åˆ¶è¯¥SAå¯ç”Ÿæ•ˆçš„åç§°ç©ºé—´ï¼ŒåŒæ ·ä¸º namespaceæ–‡ä»¶

  ```bash
  [root@master1 yaml]#kubectl exec -it myapp-7b94444f8d-hws2b -- /bin/sh
  / # cd /var/run/secrets/kubernetes.io/serviceaccount/
  /var/run/secrets/kubernetes.io/serviceaccount # ls
  ca.crt     namespace  token
  /var/run/secrets/kubernetes.io/serviceaccount # ls -l
  total 0
  lrwxrwxrwx    1 root     root            13 Jan  8 16:11 ca.crt -> ..data/ca.crt
  lrwxrwxrwx    1 root     root            16 Jan  8 16:11 namespace -> ..data/namespace
  lrwxrwxrwx    1 root     root            12 Jan  8 16:11 token -> ..data/token
  /var/run/secrets/kubernetes.io/serviceaccount # ls -la
  total 4
  drwxrwxrwt    3 root     root           140 Jan  8 16:11 .
  drwxr-xr-x    3 root     root          4096 Jan  8 16:11 ..
  drwxr-xr-x    2 root     root           100 Jan  8 16:11 ..2025_01_08_08_11_17.4084613224
  lrwxrwxrwx    1 root     root            32 Jan  8 16:11 ..data -> ..2025_01_08_08_11_17.4084613224
  lrwxrwxrwx    1 root     root            13 Jan  8 16:11 ca.crt -> ..data/ca.crt
  lrwxrwxrwx    1 root     root            16 Jan  8 16:11 namespace -> ..data/namespace
  lrwxrwxrwx    1 root     root            12 Jan  8 16:11 token -> ..data/token
  ```

  

**ServiceAccount Admission Controllerè´Ÿè´£å®ŒæˆPodä¸Šçš„ServiceAccountçš„è‡ªåŠ¨åŒ–**

- ä¸ºæ¯ä¸ªåç§°ç©ºé—´ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„default **ServiceAccountåŠå…¶**ä¾èµ–åˆ°çš„**Secretå¯¹è±¡**
- ä¸ºæœªå®šä¹‰serviceAccountNameçš„Podèµ„æºè‡ªåŠ¨é™„åŠ åç§°ç©ºé—´ä¸‹çš„serviceaccounts/default
- ä¸ºå®šä¹‰äº†serviceAccountNameçš„Podèµ„æºæ£€æŸ¥å…¶å¼•ç”¨çš„ç›®æ ‡å¯¹è±¡æ˜¯å¦å­˜åœ¨



æ¯ä¸ªserviceaccountï¼Œè¢«API Serverè®¤è¯ä¸º**`â€œsystem:serviceaccount:NAMESPACE:SAâ€`**

ServiceAccountç”¨åˆ°çš„tokenï¼Œä¹Ÿå¯ä»¥ä¸ºè¢«åˆ›å»ºä¸ºkubeconfigæ–‡ä»¶ï¼Œä»Žè€Œè¢«kubectlç­‰å…¶å®ƒå®¢æˆ·ç«¯å¼•ç”¨ï¼›

```BASH
kubectl config set-cluster myk8s --server=https://kubernetes.default -certificate-authority=ca.crt
kubectl config set-credentials user --token={serviceaccount_token}
kubectl config set-context user@myk8s --cluster=myk8s
kubectl config set-context user@myk8s --user=user
kubectl config use-context user@myk8s
```





**é»˜è®¤è®¤è¯ç¤ºä¾‹**

```bash
#åœ¨k8sçŽ¯å¢ƒä¸­åˆ›å»ºä»»æ„ä¸€ä¸ªpodçš„æ—¶å€™ï¼Œå®ƒéƒ½ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªå±žæ€§ä¿¡æ¯ï¼š
# æ–°ç‰ˆæƒ…å†µ
[root@master1 yaml]#kubectl get pod myapp-7b94444f8d-hws2b -o yaml
...
 volumes:
  - name: kube-api-access-6ffvs
    projected:
      defaultMode: 420
      sources:
      - serviceAccountToken:
          expirationSeconds: 3607
          path: token
      - configMap:
          items:
          - key: ca.crt
            path: ca.crt
          name: kube-root-ca.crt
      - downwardAPI:
          items:
          - fieldRef:
              apiVersion: v1
              fieldPath: metadata.namespace
            path: namespace
...

# é»˜è®¤çš„sa:defaultæƒé™å¾ˆå°
# éªŒè¯defaultæƒé™
[root@master1 yaml]#kubectl cp myapp-7b94444f8d-hws2b:var/run/secrets/kubernetes.io/serviceaccount/..data/token token

# æŸ¥çœ‹tokenæ–‡ä»¶
[root@master1 yaml]#cat token 
eyJhbGciOiJSUzI1NiIsImtpZCI6IjVyZ2VtUUFRUk0zdnhNVUpRRHlqcUxCUGRVOGhqbFRTMDlCdEZTNmpSbE0ifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzY3ODU5ODc1LCJpYXQiOjE3MzYzMjM4NzUsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwianRpIjoiMTlhMzMzZjQtZWJjMi00MDYxLWFkNTYtZGZjZWFiZmY2ZmNmIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJkZWZhdWx0Iiwibm9kZSI6eyJuYW1lIjoibm9kZTEiLCJ1aWQiOiJmN2NkYjk5Yy1iYjQ5LTQ0N2MtOTQ4MS1jMzZjMTNhNWU3NTMifSwicG9kIjp7Im5hbWUiOiJteWFwcC03Yjk0NDQ0ZjhkLWh3czJiIiwidWlkIjoiZGEyYTk1MTctZTM1Mi00N2RlLWJiMDEtOGU1NDUwYmUzOTkxIn0sInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJkZWZhdWx0IiwidWlkIjoiMDIyNjYxODItNzRlYS00NWRjLWIwZDctNmY3NDQ5ZjlhZTExIn0sIndhcm5hZnRlciI6MTczNjMyNzQ4Mn0sIm5iZiI6MTczNjMyMzg3NSwic3ViIjoic3lzdGVtOnNlcnZpY2VhY2NvdW50OmRlZmF1bHQ6ZGVmYXVsdCJ9.HERqhyZGaNj5juZWrfCJBJvoAGRfiHyzjqKyv8lNpwoBhH86ujnD4ql_f4thXY2lsM_1YCLrjtGssFLD7blaO4Ln91ekJLm-uMOvFZQKjCXwMxuLNNviC-OzqHrSmzoXyEqCaNGa5yJkjmpxbdXOk_zn0nu_HSkqk_qaegxYt9sDW_alQcWIsBtec2oN4CSnwUDTt_X7QvWceib5_2oKIgZlZXDpFViT9K2KtT3SxWUUFeFXGCLd7CaEGVckO1GhDI35oUobLZ2RjWrtoBsHYRzLa-zQhI43t9zpu7I1ss0bylFFOTdQkf7RtJzitpC1LKN70qYOf4GIlF4i2fqOIA

# å°†è¿™ä¸ªtokenè§£ç 
# SA çš„ Token æ˜¯ JWT æ ¼å¼ï¼Œå¹¶éžç®€å•çš„ Base64 ç¼–ç æ•°æ®ï¼Œå› æ­¤ç›´æŽ¥ç”¨ Base64 è§£ç å¯èƒ½å¤±è´¥ã€‚
# JWT çš„æ ¼å¼ï¼š{Header}.{Payload}.{Signature}

# è§£å¯†æ–¹æ³•å¦‚ä¸‹
[root@master1 yaml]#cat token |cut -d '.' -f1 | base64 -d |jq
{
  "alg": "RS256",
  "kid": "5rgemQAQRM3vxMUJQDyjqLBPdU8hjlTS09BtFS6jRlM"
}

[root@master1 yaml]#cat token |cut -d '.' -f2 | base64 -d |jq
{
  "aud": [
    "https://kubernetes.default.svc.cluster.local"
  ],
  "exp": 1767859875,
  "iat": 1736323875,
  "iss": "https://kubernetes.default.svc.cluster.local",
  "jti": "19a333f4-ebc2-4061-ad56-dfceabff6fcf",
  "kubernetes.io": {
    "namespace": "default",
    "node": {
      "name": "node1",
      "uid": "f7cdb99c-bb49-447c-9481-c36c13a5e753"
    },
    "pod": {
      "name": "myapp-7b94444f8d-hws2b",
      "uid": "da2a9517-e352-47de-bb01-8e5450be3991"
    },
    "serviceaccount": {
      "name": "default",
      "uid": "02266182-74ea-45dc-b0d7-6f7449f9ae11"
    },
    "warnafter": 1736327482
  },
  "nbf": 1736323875,
  "sub": "system:serviceaccount:default:default"
}

# é»˜è®¤çš„defaultçš„Saæƒé™è¿‡å°
[root@ubuntu2204 ~]#kubectl get pod --insecure-skip-tls-verify -s https://10.0.0.201:6443 --token `cat token`
Error from server (Forbidden): pods is forbidden: User "system:serviceaccount:default:default" cannot list resource "pods" in API group "" in the namespace "default"
```



**saèµ„æºå±žæ€§**

```bash
apiVersion: v1                           # ServiceAccountæ‰€å±žçš„APIç¾¤ç»„åŠç‰ˆæœ¬
kind: ServiceAccount                     # èµ„æºç±»åž‹æ ‡è¯†
metadata:
  name <string>                          # èµ„æºåç§°
  namespace <string>                     # ServiceAccountæ˜¯åç§°ç©ºé—´çº§åˆ«çš„èµ„æº
automountServiceAccountToken <boolean>   # æ˜¯å¦è®©Podè‡ªåŠ¨æŒ‚è½½APIä»¤ç‰Œ
secrets <[]Object>                       # ä»¥è¯¥SAè¿è¡Œçš„Podæ‰€è¦ä½¿ç”¨çš„Secretå¯¹è±¡ç»„æˆçš„åˆ—è¡¨
  apiVersion <string>                    # å¼•ç”¨çš„Secretå¯¹è±¡æ‰€å±žçš„APIç¾¤ç»„åŠç‰ˆæœ¬ï¼Œå¯çœç•¥
  kind <string>                          # å¼•ç”¨çš„èµ„æºçš„ç±»åž‹ï¼Œè¿™é‡Œæ˜¯æŒ‡Secretï¼Œå¯çœç•¥
  name <string>                          # å¼•ç”¨çš„Secretå¯¹è±¡çš„åç§°ï¼Œé€šå¸¸ä»…ç»™å‡ºè¯¥å­—æ®µå³å¯
  namespace <string>                     # å¼•ç”¨çš„Secretå¯¹è±¡æ‰€å±žçš„åç§°ç©ºé—´
  uid <string>                           # å¼•ç”¨çš„Secretå¯¹è±¡çš„æ ‡è¯†ç¬¦ï¼›
imagePullSecrets <[]Object>              # å¼•ç”¨çš„ç”¨äºŽä¸‹è½½Podä¸­å®¹å™¨é•œåƒçš„Secretå¯¹è±¡åˆ—è¡¨
  name <string>                          # docker-registryç±»åž‹çš„Secretèµ„æºçš„åç§°
```





#### åˆ›å»ºå’Œä½¿ç”¨SAè´¦å·

##### åˆ›å»ºæ–¹æ³•

```bash
# å‘½ä»¤æ ¼å¼
[root@master1 yaml]# kubectl create serviceaccount NAME [--dry-run] [options]
#ä½œç”¨ï¼šåˆ›å»ºä¸€ä¸ª"æœåŠ¡è´¦å·"

#å‚æ•°è¯¦è§£
--dry-run=false                  # æ¨¡æ‹Ÿåˆ›å»ºæ¨¡å¼
--generator='serviceaccount/v1'  # è®¾å®šapiç‰ˆæœ¬ä¿¡æ¯
-o, --output=''                  # è®¾å®šè¾“å‡ºä¿¡æ¯æ ¼å¼ï¼Œå¸¸è§çš„æœ‰ï¼šjson|yaml|name|template|...
--save-config=false              # ä¿å­˜é…ç½®ä¿¡æ¯
--template=''                    # è®¾å®šé…ç½®æ¨¡æ¿æ–‡ä»¶

#æ–‡ä»¶æ ¼å¼:
apiVersion: v1
kind: ServiceAccount
metadata:
  name: <SAåç§°>

#åˆ›å»ºSAèµ„æºæ–‡ä»¶çš„ç®€å•æ–¹æ³•
[root@master1 yaml]# kubectl create serviceaccount mysa --dry-run -o yaml
apiVersion: v1
kind: ServiceAccount
metadata:
 name: mysa
```



**èŒƒä¾‹: åˆ›å»ºSAåŠå…¶å¯¹åº”çš„Token**

```yaml
# æ¸…å•æ–‡ä»¶
[root@master1 sa] # cat security-sa-admin.yaml 
apiVersion: v1
kind: ServiceAccount
metadata:
  name: admin

---
# v1.24ç‰ˆä¹‹åŽæ·»åŠ ä¸‹é¢å†…å®¹æ‰‹åŠ¨åˆ›å»ºsecret
apiVersion: v1
kind: Secret
type: kubernetes.io/service-account-token
metadata:
  name: admin-secret
  annotations:
    kubernetes.io/service-account.name: "admin"

---
apiVersion: v1
kind: Pod
metadata:
  name: pod-sa-admin
spec:
  containers:
  - name: pod-sa-admin
    image: registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    imagePullPolicy: IfNotPresent
  serviceAccountName: admin
  
# åº”ç”¨
[root@master1 sa] # kubectl apply -f security-sa-admin.yaml 
serviceaccount/admin created
secret/admin-secret created
pod/pod-sa-admin created

# æŸ¥çœ‹
[root@master1 sa] # kubectl describe sa admin 
Name:                admin
Namespace:           default
Labels:              <none>
Annotations:         <none>
Image pull secrets:  <none>
Mountable secrets:   <none>
Tokens:              admin-secret
Events:              <none>
```





### æŽˆæƒæœºåˆ¶

k8sé›†ç¾¤é»˜è®¤çš„è®¤è¯æ’ä»¶æœ‰ **Node** å’Œ **RBAC**ï¼Œå…¶ä»–çš„éƒ½æ˜¯ä½¿ç”¨å¤§é‡çš„è¯ä¹¦æ¥è¿›è¡Œçš„

å¦‚æžœæ²¡æœ‰é‰´æƒæ–¹å¼å…è®¸,åˆ™é»˜è®¤ä¸ºæ‹’ç»



**é…ç½®æ–¹æ³•**

- åœ¨kube-apiserverä¸Šä½¿ç”¨ --authorization-mode é€‰é¡¹è¿›è¡Œå®šä¹‰
- å¤šä¸ªæ¨¡å—å½¼æ­¤é—´ä»¥é€—å·åˆ†éš”

```bash
[root@master1 sa]#cat /etc/kubernetes/manifests/kube-apiserver.yaml 
apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 10.0.0.201:6443
  creationTimestamp: null
  labels:
    component: kube-apiserver
    tier: control-plane
  name: kube-apiserver
  namespace: kube-system
spec:
  containers:
  - command:
    - kube-apiserver
    - --advertise-address=10.0.0.201
    - --allow-privileged=true
    - --authorization-mode=Node,RBAC       # è¿™é‡Œè¿›è¡Œå®šä¹‰
    - --client-ca-file=/etc/kubernetes/pki/ca.crt
    - --token-auth-file=/etc/kubernetes/auth/token.csv
    - --enable-admission-plugins=NodeRestriction
    - --enable-bootstrap-token-auth=true
    ......
```



![image-20250108193615349](D:\git_repository\cyber_security_learning\markdown_img\image-20250108193615349.png)





####  RBAC æœºåˆ¶



##### RBACåŸºç¡€æ¦‚å¿µ

- **å®žä½“ï¼ˆEntityï¼‰**ï¼šåœ¨RBACä¹Ÿç§°ä¸º**Subject**ï¼Œé€šå¸¸æŒ‡çš„æ˜¯**User**ã€**Group** æˆ–è€… **ServiceAccount**,å³å¯¹å“ªäº›äººè¿›è¡ŒæŽˆæƒ
- **èµ„æºï¼ˆResourceï¼‰**ï¼šåœ¨RBACä¸­ä¹Ÿç§°ä¸º**Object**ï¼ŒæŒ‡ä»£SubjectæœŸæœ›æ“ä½œçš„ç›®æ ‡ï¼Œä¾‹å¦‚**Secretã€PodåŠ Serviceå¯¹è±¡**ç­‰
  - ä»…é™äºŽ/api/v1/ æˆ– /apis/// å¼€å§‹çš„è·¯å¾„
  - å…¶å®ƒè·¯å¾„å¯¹åº”çš„ç«¯ç‚¹å‡è¢«è§†ä½œâ€œéžèµ„æºç±»è¯·æ±‚ï¼ˆNon-Resource Requestsï¼‰â€ï¼Œä¾‹å¦‚: /healthz  ç«¯ç‚¹
- **åŠ¨ä½œï¼ˆActionsï¼‰**ï¼šSubjectå¯ä»¥äºŽObjectä¸Šæœ‰æƒé™æ‰§è¡Œçš„ç‰¹å®šæ“ä½œï¼Œå…·ä½“çš„å¯ç”¨åŠ¨ä½œå–å†³äºŽKubernetesçš„å®šä¹‰
  - **Object**
    - è¯»æ“ä½œï¼šgetã€listã€watchç­‰
    - å†™æ“ä½œï¼šcreateã€updateã€patchã€deleteã€deletecollectionç­‰
  - **éžObject**: ä»…æ”¯æŒgetæ“ä½œ
- **è§„åˆ™Rules**: æ˜¯ä¸€ç»„å±žäºŽä¸åŒ API Group èµ„æºä¸Šçš„æ“ä½œçš„æƒé™é›†åˆ,å³èµ„æºResourceå’ŒåŠ¨ä½œActions çš„ç»„åˆçš„æŽˆæƒè§„åˆ™
- **è§’è‰²ï¼ˆRoleï¼‰**ï¼šæ‰¿è½½èµ„æºæ“ä½œæƒé™çš„å®¹å™¨,åŒ…å«ä¸€ç»„æƒé™çš„è§„åˆ™,åªæœ‰å…è®¸æ²¡æœ‰æ‹’ç»æƒé™
- **Roleï¼š**åç§°ç©ºé—´çº§åˆ«ï¼Œç”Ÿæ•ˆèŒƒå›´ä¸ºå…¶æ‰€å±žçš„åç§°ç©ºé—´
  - **ClusterRoleï¼š**é›†ç¾¤çº§åˆ«ï¼Œç”Ÿæ•ˆèŒƒå›´ä¸ºæ•´ä¸ªé›†ç¾¤
- **è§’è‰²ç»‘å®šï¼ˆRole Bindingï¼‰**ï¼šå°†è§’è‰²å…³è”è‡³å®žä½“ä¸Šï¼Œå®ƒèƒ½å¤Ÿå°†è§’è‰²å…·ä½“çš„æ“ä½œæƒé™èµ‹äºˆç»™å®žä½“,å³å°†è§’è‰²ä¸Šçš„æƒé™æŽˆäºˆç»™è´¦å·ï¼Œæ ‡å‡†çš„èµ„æºç±»åž‹
- **RoleBinding:** ç»‘å®šåœ¨åç§°ç©ºé—´çº§åˆ«,å³åªæŽˆæƒæ‹¥æœ‰æŒ‡å®šåç§°ç©ºé—´èŒƒå›´çš„æƒé™ 
  - **ClusterRoleBinding:** ç»‘å®šåœ¨é›†ç¾¤çº§åˆ«,å³æŽˆæƒæ‹¥æœ‰é›†ç¾¤èŒƒå›´ä¸­æ‰€æœ‰åç§°ç©ºé—´çš„æƒé™





#####  RBAC æŽˆæƒæœºåˆ¶

 **è§’è‰²å’Œè§’è‰²ç»‘å®š**

æŽˆæƒæŒ‡çš„æ˜¯å°†æŸäº›subjectå¯¹è±¡èµ‹äºˆæ‰§è¡ŒæŸäº›èµ„æºåŠ¨ä½œçš„æƒé™ã€‚æœ‰æ—¶å€™ä¼šå°†å…¶ç§°ä¸ºGroup(æƒé™ç»„)ï¼Œæœ‰ä¸¤ éƒ¨åˆ†ç»„æˆï¼šè§’è‰²ï¼ˆç»„åï¼‰å’Œè§’è‰²ç»‘å®š(ç»„å…³è”)ã€‚

ç®€å•æ¥è¯´ï¼š**æŽˆæƒä¸ºç”¨æˆ·æŽˆäºˆæŸç§è§’è‰²**

| ç»„ æˆ    | è§£æž                                                         |
| -------- | ------------------------------------------------------------ |
| è§’è‰²     | å…¶å®žæ˜¯é™„åŠ åœ¨æŸäº›èµ„æºä¸Šçš„ä¸€ç³»åˆ—æƒé™çš„é›†åˆï¼Œå¯¹äºŽk8sæ¥è¯´ï¼Œå®ƒä¸»è¦æœ‰ä¸¤ç±»ï¼š**Roleå’Œ clusterRole**<br />å…¶ä¸­Roleä¸»è¦æ˜¯ä½œç”¨äºŽnamespaceï¼Œè€ŒclusterRoleä¸»è¦ä½œç”¨äºŽå¤šä¸ªnamespaceï¼Œå®ƒä»¬ä¹‹é—´ æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚<br />ä¸ºäº†å°†æƒé™åº”ç”¨å’Œå…·ä½“æƒé™åˆ—è¡¨åˆ†å¼€æè¿°ï¼Œä¸€èˆ¬ç§°æƒé™åˆ—è¡¨ä¸ºè§„åˆ™-rules |
| è§’è‰²ç»‘å®š | å°†ä¹‹å‰å®šä¹‰çš„Subjectå’Œå¯¹åº”çš„æƒé™ç»„å…³è”åœ¨ä¸€èµ·ï¼Œè¡¨ç¤ºæŸä¸ªSubjectå…· æœ‰æ‰§è¡ŒæŸä¸ªèµ„æºçš„ä¸€ç³»åˆ—åŠ¨ä½œæƒé™ã€‚<br />å®ƒä¸»è¦æ¶‰åŠåˆ°ä¸¤ä¸ªRoleBindingå’Œ ClusterRoleBindingã€‚ |



![image-20250108195742108](D:\git_repository\cyber_security_learning\markdown_img\image-20250108195742108.png)



**è§’è‰²Roleåˆ†ç±»ï¼š**

- **ClusterRoleï¼š**é›†ç¾¤èŒƒå›´å†…çš„èµ„æºçš„æ“ä½œæƒé™çš„é›†åˆ,å­˜åœ¨äºŽæ‰€æœ‰åç§°ç©ºé—´
- **Roleï¼š**åç§°ç©ºé—´èŒƒå›´å†…èµ„æºæ“ä½œçš„æƒé™çš„é›†åˆ,åªå­˜åœ¨äºŽç‰¹å®šçš„åç§°ç©ºé—´



**è§’è‰²ç»‘å®š RoleBinding åˆ†ç±»**

- **ClusterRoleBinding**ï¼šé›†ç¾¤èŒƒå›´å†…çš„è§’è‰²ç»‘å®š,å³åˆ†é…ç»™é›†ç¾¤ä¸­æ‰€æœ‰åç§°ç©ºé—´ç›¸åº”çš„æƒé™
- **RoleBinding**ï¼šåç§°ç©ºé—´èŒƒå›´å†…çš„è§’è‰²ç»‘å®š,,å³åªåˆ†é…ç»™æŒ‡å®šåç§°ç©ºé—´ç›¸åº”çš„æƒé™



##### è§’è‰²å’Œè§’è‰²ç»‘å®šç»„åˆ

![image-20250108201908367](D:\git_repository\cyber_security_learning\markdown_img\image-20250108201908367.png)



- namespace çº§åˆ«
- cluster çº§åˆ«
- æ··åˆçº§åˆ«



**namespaceçº§åˆ«ç»„åˆ**

| æœ¯è¯­        | è§£æž                                                         |
| ----------- | ------------------------------------------------------------ |
| rules       |                                                              |
| role        | åç§°ç©ºé—´çº§åˆ«ï¼Œç”Ÿæ•ˆèŒƒå›´ä¸ºå…¶æ‰€å±žçš„åç§°ç©ºé—´<br />è¡¨ç¤ºåœ¨ä¸€ä¸ªnamespaceä¸­åŸºäºŽrulesä½¿ç”¨èµ„æºçš„æƒé™ï¼Œå±žäºŽé›†ç¾¤å†…éƒ¨çš„ API èµ„æºï¼Œ ä¸»è¦æ¶‰åŠåˆ°æ“ä½œå’Œå¯¹è±¡ |
| RoleBinding | å°†Subjectå…³è”è‡³Role,æŽˆæƒç»™Subjectå¯ä»¥åœ¨RoleBindingæ‰€åœ¨çš„åç§°ç©ºé—´ä½¿ç”¨æŒ‡å®š èµ„æºçš„roleè§’è‰²æƒé™<br />ä¹Ÿå¯ä»¥å°†Subjectä½¿ç”¨RoleBindingå…³è”è‡³ClusterRoleä¸Šï¼Œ**è¯¥è§’è‰²èµ‹äºˆåˆ°Subjectçš„ æƒé™ä¹Ÿä¼šé™çº§åˆ°RoleBindingæ‰€å±žçš„NamespaceèŒƒå›´ä¹‹å†…** |

```ABAP
æ³¨æ„: åœ¨åç§°ç©ºé—´çº§æŽˆæƒæ—¶,å¿…é¡»è¦ä¿è¯ServiceAccounts (SA) and RoleBindings éƒ½åœ¨åŒä¸ªåç§°ç©ºé—´ä¸‹
```



**clusterçº§åˆ«ç»„åˆ**

| æœ¯è¯­               | è§£æž                                                         |
| ------------------ | ------------------------------------------------------------ |
| ClusterRole        | å®šä¹‰é›†ç¾¤èŒƒå›´å†…çš„èµ„æºæ“ä½œæƒé™é›†åˆï¼ŒåŒ…æ‹¬é›†ç¾¤çº§åˆ«åŠåç§°ç©ºé—´çº§åˆ«çš„èµ„æºå¯¹è±¡<br />è¡¨ç¤ºåœ¨ä¸€ä¸ªclusterä¸­åŸºäºŽrulesä½¿ç”¨èµ„æºçš„æƒé™ï¼Œå±žäºŽé›†ç¾¤å†…éƒ¨çš„ API èµ„ æºï¼Œä¸€ä¸ªclusteræœ‰å¤šä¸ªnamespaceå³æœ‰å¤šä¸ªrole |
| ClusterRoleBinding | å°†Subjectå…³è”è‡³ClusterRoleï¼ŒæŽˆæƒç»™Subjectå¯ä»¥åœ¨é›†ç¾¤ä¸­ä½¿ç”¨æŒ‡å®šèµ„æº çš„ClusterRoleè§’è‰²æƒé™<br />å³å°†å®žä½“ï¼ˆUserã€Groupæˆ–ServiceAccountï¼‰å…³è”è‡³ClusterRole |



**æ··åˆçº§åˆ«ç»„åˆ**

| æœ¯è¯­        | è§£æž                                                         |
| ----------- | ------------------------------------------------------------ |
| ClusterRole | å®šä¹‰é›†ç¾¤èŒƒå›´å†…çš„èµ„æºæ“ä½œæƒé™é›†åˆï¼ŒåŒ…æ‹¬é›†ç¾¤çº§åˆ«åŠåç§°ç©ºé—´çº§åˆ«çš„èµ„æºå¯¹è±¡ è¡¨ç¤ºåœ¨ä¸€ä¸ªclusterä¸­åŸºäºŽrulesä½¿ç”¨èµ„æºçš„æƒé™ï¼Œå±žäºŽé›†ç¾¤å†…éƒ¨çš„ API èµ„æºï¼Œä¸€ä¸ª clusteræœ‰å¤šä¸ªnamespaceå³æœ‰å¤šä¸ªrole |
| RoleBinding | å°†SubjectåŸºäºŽRoleBindingä¸ŽClusterRoleç»‘å®šåœ¨ä¸€èµ·ï¼Œè¡¨ç¤ºSubjectå¯ä»¥ä½¿ç”¨æ‰€æœ‰ namespaceä¸­æŒ‡å®šèµ„æºçš„roleè§’è‰²ï¼Œä»Žè€Œé¿å…äº†å¤šæ¬¡roleå’Œuserçš„RoleBindingã€‚ åŒæ ·çš„æ“ä½œï¼Œç«™åœ¨ClusterRoleçš„è§’åº¦ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£ä¸ºï¼Œç”¨æˆ·å¾—åˆ°çš„æƒé™ä»…æ˜¯ ClusterRoleçš„æƒé™åœ¨Rolebindingæ‰€å±žçš„åç§°ç©ºé—´ä¸Šçš„ä¸€ä¸ªå­é›†ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“ çš„"æƒé™é™çº§" |



**RoleBinding ç»‘å®š ClusterRole çš„åœºæ™¯å’ŒåŽŸå› **

**åœºæ™¯1ï¼šé™å®šé›†ç¾¤çº§æƒé™åœ¨ç‰¹å®šå‘½åç©ºé—´ä¸­**

- `ClusterRole` é€šå¸¸å®šä¹‰é›†ç¾¤çº§åˆ«çš„æƒé™ï¼Œä½†æŸäº›æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½å¸Œæœ›å°†è¿™äº›é›†ç¾¤çº§æƒé™é™åˆ¶åˆ°ä¸€ä¸ªç‰¹å®šçš„å‘½åç©ºé—´ã€‚
- é€šè¿‡ `RoleBinding` ç»‘å®š `ClusterRole`ï¼Œä½ å¯ä»¥æœ‰æ•ˆåœ°**å°†é›†ç¾¤çº§çš„æ“ä½œæƒé™ä»…åº”ç”¨äºŽæŸä¸ªå‘½åç©ºé—´**ã€‚

**ç¤ºä¾‹ï¼š**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: admin-binding
  namespace: my-namespace
subjects:
- kind: User
  name: alice
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: admin
  apiGroup: rbac.authorization.k8s.io
```

- é‡Œçš„ `admin` æ˜¯ä¸€ä¸ªé›†ç¾¤çº§åˆ«çš„è§’è‰²ï¼ˆ`ClusterRole`ï¼‰ï¼Œä½†é€šè¿‡ `RoleBinding` å°†å…¶æƒé™é™åˆ¶åœ¨ `my-namespace` å‘½åç©ºé—´ä¸­ã€‚



**ç”¨é€”**

- é™åˆ¶ç”¨æˆ·ï¼ˆå¦‚å¼€å‘äººå‘˜ï¼‰åœ¨ç‰¹å®šå‘½åç©ºé—´ä¸­çš„æ“ä½œæƒé™ï¼Œé˜²æ­¢å…¶å¯¹é›†ç¾¤å…¶ä»–éƒ¨åˆ†é€ æˆå½±å“ã€‚



**åœºæ™¯2ï¼šé‡ç”¨ ClusterRole**

- æœ‰æ—¶é›†ç¾¤ç®¡ç†å‘˜å¯èƒ½å·²ç»å®šä¹‰äº†ä¸€äº›é€šç”¨çš„ `ClusterRole`ï¼Œå¦‚ `view`ã€`edit`ã€`admin`ï¼Œè¿™äº›è§’è‰²å¯ä»¥è¦†ç›–å¾ˆå¤šåœºæ™¯ã€‚
- ä¸ºäº†é¿å…é‡æ–°åˆ›å»ºä¸€ä¸ªç›¸åŒè§„åˆ™çš„ `Role`ï¼Œå¯ä»¥ç›´æŽ¥é€šè¿‡ `RoleBinding` ç»‘å®šå·²æœ‰çš„ `ClusterRole`ã€‚



**ç¤ºä¾‹ï¼š**

- ä¸ºäº†é¿å…é‡æ–°åˆ›å»ºä¸€ä¸ªç›¸åŒè§„åˆ™çš„ `Role`ï¼Œå¯ä»¥ç›´æŽ¥é€šè¿‡ `RoleBinding` ç»‘å®šå·²æœ‰çš„ `ClusterRole`ã€‚
- è¿™æ ·å¯ä»¥å‡å°‘ç®¡ç†å¤æ‚åº¦ï¼Œå¹¶é‡ç”¨å·²æœ‰çš„æƒé™æ¨¡åž‹ã€‚



##### é»˜è®¤çš„ClusterRoleåŠClusterRoleBinding

å¯ç”¨RBACé‰´æƒæ¨¡å—æ—¶ï¼ŒAPI Serverä¼šè‡ªåŠ¨åˆ›å»ºä¸€ç»„ClusterRoleå’ŒClusterRoleBindingå¯¹è±¡

- å¤šæ•°éƒ½ä»¥â€œsystem:â€ä¸ºå‰ç¼€ï¼Œä¹Ÿæœ‰å‡ ä¸ªé¢å‘ç”¨æˆ·çš„ClusterRoleæœªä½¿ç”¨è¯¥å‰ç¼€ï¼Œå¦‚cluster-adminã€ adminç­‰
- å®ƒä»¬éƒ½é»˜è®¤ä½¿ç”¨â€œkubernetes.io/bootstrapping: rbac-defaultsâ€è¿™ä¸€æ ‡ç­¾



**é»˜è®¤çš„ClusterRoleå¤§ä½“å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹5ä¸ªç±»åˆ«**

- **APIå‘çŽ°ç›¸å…³çš„è§’è‰²**
  - åŒ…æ‹¬system:basic-userã€system:discoveryå’Œsystem:public-info-viewer
- **é¢å‘ç”¨æˆ·çš„è§’è‰²**
  - åŒ…æ‹¬cluster-adminã€adminã€editå’Œview
- **æ ¸å¿ƒç»„ä»¶ä¸“ç”¨çš„è§’è‰²**
  - åŒ…æ‹¬system:kube-schedulerã€system:volume-schedulerã€system:kube-controller-managerã€ system:nodeå’Œsystem:node-proxierç­‰
- **å…¶å®ƒç»„ä»¶ä¸“ç”¨çš„è§’è‰²**
  - åŒ…æ‹¬system:kube-dnsã€system:node-bootstrapperã€system:node-problem-detectorå’Œ system:monitoringç­‰
- **å†…ç½®æŽ§åˆ¶å™¨ä¸“ç”¨çš„è§’è‰²**





**ç”¨äºŽäº¤äº’å¼ç”¨æˆ·æŽˆæƒç›®çš„çš„å¸¸è§è§’è‰²**

```bash
# æŸ¥çœ‹cluster-admin
#å¯ä»¥é€šè¿‡clusterrole èµ„æºæ¥æŸ¥çœ‹cluster-adminçš„æ‰€æœ‰æƒé™ä¿¡æ¯
[root@master1 sa]# kubectl get clusterrole cluster-admin  -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2025-01-04T01:44:14Z"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin
  resourceVersion: "74"
  uid: 7defd096-536a-4bd1-890c-e496d1c5f35e
rules:
- apiGroups:
  - '*'
  resources:
  - '*'
  verbs:
  - '*'
- nonResourceURLs:
  - '*'
  verbs:
  - '*'

#æŸ¥çœ‹roleè§’è‰²cluster-adminåŒåçš„clusterrolebinding
[root@master1 sa]# kubectl get clusterrolebinding cluster-admin -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2025-01-04T01:44:14Z"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: cluster-admin
  resourceVersion: "138"
  uid: 969955ea-19c0-4590-836c-68652f9deb73
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: Group
  name: system:masters    #å¯¹ç»„system:mastersè¿›è¡Œè§’è‰²ç»‘å®š

# æŸ¥çœ‹admin
[root@master1 sa]#kubectl get clusterrole admin  -o yaml
aggregationRule:
  clusterRoleSelectors:
  - matchLabels:
      rbac.authorization.k8s.io/aggregate-to-admin: "true"
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  annotations:
    rbac.authorization.kubernetes.io/autoupdate: "true"
  creationTimestamp: "2025-01-04T01:44:14Z"
  labels:
    kubernetes.io/bootstrapping: rbac-defaults
  name: admin
  resourceVersion: "355"
  uid: 74c723db-9eac-4c11-89eb-172f8c98ec7b
rules:
- apiGroups:
  - ""          # ""ï¼ˆç©ºå­—ç¬¦ä¸²ï¼‰è¡¨ç¤ºé»˜è®¤çš„ Core API ç»„ï¼Œå³å±žäºŽ Kubernetes æ ¸å¿ƒ API çš„èµ„æº
  resources:
  - pods/attach
  - pods/exec
  - pods/portforward
  - pods/proxy
  - secrets
  - services/proxy
  verbs:
  - get
  - list
  - watch
......

# é‡å¯apiServerçš„æ–¹æ³•
# åˆ æŽ‰å½“å‰çš„API Server Podï¼Œkubelet ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»º
kubectl delete pod kube-apiserver-<node-name> -n kube-system
```





#### Role å’Œ RoleBinding ç»„åˆå®žçŽ°



##### åˆ›å»ºRole

**å±žæ€§è§£æž**

```bash
#å› ä¸ºè§’è‰²ç”±äºŽçº§åˆ«ä¸ä¸€æ ·ï¼Œä½œç”¨çš„èŒƒå›´ä¹Ÿä¸åŒï¼ŒRoleçš„å±žæ€§ï¼Œå¯ä»¥ä½¿ç”¨ kubectl explain role çš„æ–¹å¼æ¥æŸ¥çœ‹
[root@master1 ~]#kubectl explain role.rules
apiVersion <string>
kind <string>
metadata     <Object>
rules       <[]Object>
  apiGroups   <[]string>
  nonResourceURLs     <[]string>
  resourceNames       <[]string>
  resources   <[]string>
  verbs       <[]string> -required-
  
#ç»“æžœæ˜¾ç¤ºï¼š
å¯¹äºŽroleæ¥è¯´ï¼Œå…¶æ ¸å¿ƒçš„å†…å®¹ä¸»è¦æ˜¯rulesçš„æƒé™è§„åˆ™
åœ¨è¿™ä¹ˆå¤šruleså±žæ€§ä¸­ï¼Œæœ€é‡è¦çš„æ˜¯verbså°±æ˜¯æƒé™æ¡ç›®ï¼Œè€Œä¸”æ‰€æœ‰çš„å±žæ€§éƒ½æ˜¯å¯ä»¥ä»¥åˆ—è¡¨çš„å½¢å¼ç´¯åŠ å­˜åœ¨

#å‘½ä»¤å¼å‘½ä»¤
kubectl create role NAME --verb=verb --resource=resource.group/subresource [--resource-name=resourcename]
verbï¼š#å…è®¸åœ¨èµ„æºä¸Šä½¿ç”¨çš„æ“ä½œï¼ˆverbï¼‰åˆ—è¡¨
resources.group/subresourceï¼š#æ“ä½œå¯æ–½åŠ çš„ç›®æ ‡èµ„æºç±»åž‹æˆ–å­èµ„æºåˆ—è¡¨
resourcenameï¼š#ç‰¹å®šçš„èµ„æºå¯¹è±¡åˆ—è¡¨ï¼Œå¯é€‰

# ç¤ºä¾‹
# åˆ›å»ºä¸€ä¸ªå¯¹æ‰€æœ‰pod,service,deploymentå…·æœ‰get,listæƒé™çš„roleçš„èµ„æºå®šä¹‰æ–‡ä»¶æ ¼å¼
[root@master1 ~]# kubectl create role pods-viewer --verb=get,list --resource=pods,services,deployments --dry-run -o yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  creationTimestamp: null
  name: pods-viewer            
rules:                          
- apiGroups:                 
  - ""
  resources:
  - pods
  - services
  verbs:
  - get
  - list
- apiGroups:
  - apps
  resources:
  - deployments
  verbs:
  - get
  - list

#ç»“æžœæ˜¾ç¤ºï¼š
#roleå¿…å¤‡çš„rulesä¸»è¦æœ‰ä¸‰éƒ¨åˆ†ç»„æˆï¼šapiGroupã€resourcesã€verbs
apiGroups #è®¾å®šåŒ…å«èµ„æºçš„apiç»„ï¼Œå¦‚æžœæ˜¯å¤šä¸ªï¼Œè¡¨ç¤ºåªè¦å±žäºŽapiç»„èŒƒå›´ä¸­çš„ä»»æ„èµ„æºéƒ½å¯ä»¥æ“ä½œ
resources #ä½äºŽapiGroupèŒƒå›´ä¸­çš„æŸäº›å…·ä½“çš„èµ„æºå¯¹è±¡
verbs #é’ˆå¯¹å…·ä½“èµ„æºå¯¹è±¡çš„ä¸€äº›å…·ä½“æ“ä½œ
```



##### è§’è‰²ç»‘å®šrolebinding

RoleBinding æˆ–è€… ClusterRoleBinding å¯ç»‘å®šè§’è‰²åˆ°æŸä¸»ä½“ï¼ˆSubjectï¼‰ ä¸Šã€‚ ä¸»ä½“å¯ä»¥æ˜¯ç»„ï¼Œç”¨æˆ·æˆ–è€… æœåŠ¡è´¦æˆ·ã€‚

Kubernetes ç”¨å­—ç¬¦ä¸²æ¥è¡¨ç¤ºç”¨æˆ·åã€‚ 

- ç”¨æˆ·åå¯ä»¥æ˜¯æ™®é€šçš„ç”¨æˆ·åï¼Œåƒ "alice"ï¼›
- é‚®ä»¶é£Žæ ¼çš„å ç§°ï¼Œå¦‚ "bob@example.com"ï¼Œ 
- ä»¥å­—ç¬¦ä¸²å½¢å¼è¡¨è¾¾çš„æ•°å­— IDã€‚



**æ³¨æ„ï¼š**

å‰ç¼€ system: æ˜¯ Kubernetes ç³»ç»Ÿä¿ç•™çš„ï¼Œæ‰€ä»¥ä½ **è¦ç¡®ä¿æ‰€é…ç½®çš„ç”¨æˆ·åæˆ–è€…ç»„åä¸èƒ½å‡ºçŽ°ä¸Šè¿° system: å‰ç¼€**ã€‚é™¤äº†å¯¹å‰ç¼€çš„é™åˆ¶ä¹‹å¤–ï¼ŒRBAC é‰´æƒç³»ç»Ÿä¸å¯¹ç”¨æˆ·åæ ¼å¼ä½œä»»ä½•è¦æ±‚ã€‚

æœåŠ¡è´¦æˆ·ï¼ˆServiceAccountï¼‰ çš„ç”¨æˆ·åå‰ç¼€ä¸º system:serviceaccount:ï¼Œå±žäºŽå‰ç¼€ä¸º system:serviceaccounts: çš„ç”¨æˆ·ç»„ã€‚

- **system:serviceaccount**: ï¼ˆå•æ•°ï¼‰æ˜¯ç”¨äºŽæœåŠ¡è´¦æˆ·ç”¨æˆ·åçš„å‰ç¼€
- **system:serviceaccounts**: ï¼ˆå¤æ•°ï¼‰æ˜¯ç”¨äºŽæœåŠ¡è´¦æˆ·ç»„åçš„å‰ç¼€



**RoleBinding ç¤ºä¾‹**

ä¸‹é¢ç¤ºä¾‹æ˜¯ RoleBinding ä¸­çš„ç‰‡æ®µï¼Œä»…å±•ç¤ºå…¶ subjects çš„éƒ¨åˆ†



**å¯¹äºŽåç§°ä¸º alice@example.com çš„ç”¨æˆ·ï¼š**

```yaml
subjects:
- kind: User
  name: "alice@example.com"
  apiGroup: rbac.authorization.k8s.io
```



**å¯¹äºŽåç§°ä¸º frontend-admins çš„ç”¨æˆ·ç»„ï¼š**

```yaml
subjects:
- kind: Group
  name: "frontend-admins"
  apiGroup: rbac.authorization.k8s.io

```



**å¯¹äºŽ kube-system åå­—ç©ºé—´ä¸­çš„é»˜è®¤æœåŠ¡è´¦æˆ·ï¼š**

```yaml
subjects:
- kind: ServiceAccount
  name: default
  namespace: kube-system
```



**å¯¹äºŽ "qa" åç§°ç©ºé—´ä¸­çš„æ‰€æœ‰æœåŠ¡è´¦æˆ·ï¼š**

```yaml
subjects:
- kind: Group
  name: system:serviceaccounts:qa
  apiGroup: rbac.authorization.k8s.io
```



**å¯¹äºŽåœ¨ä»»ä½•åå­—ç©ºé—´ä¸­çš„æœåŠ¡è´¦æˆ·ï¼š**

```yaml
subjects:
- kind: Group
  name: system:serviceaccounts
  apiGroup: rbac.authorization.k8s.io
```



**å¯¹äºŽæ‰€æœ‰å·²ç»è¿‡èº«ä»½è®¤è¯çš„ç”¨æˆ·ï¼š**

```yaml
subjects:
- kind: Group
  name: system:authenticated
  apiGroup: rbac.authorization.k8s.io
```



**å¯¹äºŽæ‰€æœ‰æœªé€šè¿‡èº«ä»½è®¤è¯çš„ç”¨æˆ·ï¼š**

```yaml
subjects:
- kind: Group
  name: system:unauthenticated
  apiGroup: rbac.authorization.k8s.io
```



**å¯¹äºŽæ‰€æœ‰ç”¨æˆ·ï¼š**

```yaml
subjects:
- kind: Group
  name: system:authenticated
  apiGroup: rbac.authorization.k8s.io
- kind: Group
  name: system:unauthenticated
  apiGroup: rbac.authorization.k8s.io
```





##### UAç»‘å®š

**ç”¨æˆ·ç»‘å®šå±žæ€§ç®€ä»‹**

```bash
#æŸ¥çœ‹rolebindingçš„å±žæ€§ä¿¡æ¯
[root@master1 ~]# kubectl explain rolebinding
apiVersion        <string>
kind              <string>
metadata          <Object>
roleRef           <Object> -required
subjects          <[]Object>

#ç»“æžœæ˜¾ç¤ºï¼šå¯¹äºŽè§’è‰²ç»‘å®šæ¥è¯´ï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸¤ç‚¹ï¼šsubjectå’Œå¯¹åº”çš„roleæƒé™åˆ—è¡¨ï¼Œå…¶ä¸­roleRefæ˜¯å¿…é€‰é¡¹ã€‚

#å‘½ä»¤å¼å‘½ä»¤ï¼š
kubectl create rolebinding NAME --clusterrole=NAME|--role=NAME [--user=username] [--group=groupname] [--namespace=namespace_name]

#å¯ä»¥ç»‘å®šåˆ°Roleï¼Œä¹Ÿå¯ä»¥ç»‘å®šåˆ°ClusterRoleï¼ŒåŽè€…ä¼šå°†ClusterRoleçš„æƒé™ç¼©å‡è‡³å½“å‰åç§°ç©ºé—´ä¹‹å†…
#Subjectå¯ä»¥æ˜¯Userã€Groupæˆ–è€…ServiceAccount

#ç¤ºä¾‹ï¼šå°†ç”¨æˆ·tomç»‘å®šè‡³è§’è‰²pods-viewerä¹‹ä¸Š,æ³¨æ„ï¼špods-viewerå’Œtom-attachto-pods-vieweréƒ½è¦æ±‚åœ¨defaultåç§°ç©ºé—´ä¸­
kubectl create rolebinding tom-attachto-pods-viewer --role=pods-viewer --user=tom --namespace=default
#è€ŒåŽå¯æµ‹è¯•tomç”¨æˆ·æ˜¯å¦å¯è¯»å–defaultåç§°ç©ºé—´å†…çš„podsèµ„æºï¼Œä»¥åŠå…¶å®ƒèµ„æº
```



**èŒƒä¾‹: é…ç½®æ–‡ä»¶**

```yaml
# ä»¥pod-sa-adminæˆ–è€…wangçš„subjectæ¥ä¸Žmyroleè¿›è¡Œä¸€æ¬¡æ¨¡æ‹Ÿç»‘å®šæŸ¥çœ‹å±žæ€§æ•ˆæžœ
[root@master1 ~]#kubectl create rolebinding wang-myrole --role=myrole --user=wang -o yaml --dry-run
W0109 22:24:54.445293  235536 helpers.go:703] --dry-run is deprecated and can be replaced with --dry-run=client.
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  creationTimestamp: null
  name: wang-myrole
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: myrole
subjects:
- apiGroup: rbac.authorization.k8s.io
  kind: User
  name: wang

```







# çŸ¥è¯†æ‰©å±•



## Watchæœºåˆ¶



**watch æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªåŸºäºŽ HTTPS çš„é•¿è¿žæŽ¥è¯·æ±‚**ã€‚åœ¨è¿™ä¸ªé•¿è¿žæŽ¥ä¸­ï¼Œ**API Server ä¼šå‘å®¢æˆ·ç«¯ä¸»åŠ¨æŽ¨é€èµ„æºå˜æ›´äº‹ä»¶**ï¼Œä½†è¦æ³¨æ„çš„æ˜¯ï¼Œ**å®¢æˆ·ç«¯åœ¨å‘èµ· watch è¯·æ±‚åŽä¸ä¼šåå¤å‘é€è¯·æ±‚ï¼ŒåŽç»­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ç”± API Server ä¸»åŠ¨æŽ¨é€çš„**ã€‚



### HTTP/2å®žçŽ°

#### **1. æŠ€æœ¯æ ¸å¿ƒï¼šHTTP/2 çš„ç‰¹æ€§**

Kubernetes çš„ watch æœºåˆ¶ä¾èµ–äºŽ**HTTP/2 åè®®**çš„**å¤šè·¯å¤ç”¨å’Œæµå¼æ•°æ®ä¼ è¾“**ã€‚å’Œä¼ ç»Ÿçš„ HTTP/1.1 ä¸åŒï¼Œ**HTTP/2 æä¾›äº†æŒä¹…çš„åŒå‘æ•°æ®æµ**ï¼Œè¿™æ˜¯å®žçŽ°â€œ**ä¸€æ¬¡è¯·æ±‚ï¼Œå¤šæ¬¡å“åº”**â€çš„æ ¸å¿ƒã€‚



##### **HTTP/2 çš„å…³é”®ç‰¹æ€§**

| **ç‰¹æ€§**            | **æè¿°**                                   | **åœ¨ watch ä¸­çš„ä½œç”¨**                                  |
| ------------------- | ------------------------------------------ | ------------------------------------------------------ |
| **å¤šè·¯å¤ç”¨**        | å•ä¸ª TCP è¿žæŽ¥ä¸­å…è®¸å¤šä¸ªæµçš„å¹¶è¡Œäº¤ä»˜        | å…è®¸ kubelet å’Œ apiserver é€šè¿‡å•è¿žæŽ¥ä¼ è¾“å¤šä¸ªè¯·æ±‚å’Œå“åº” |
| **æ•°æ®æµ (Stream)** | æ•°æ®ä»¥æµçš„å½¢å¼å‘é€ï¼Œæµ ID ç”¨äºŽæ ‡è¯†æ•°æ®æ®µ   | kube-apiserver ä¸æ–­å‘ kubelet å‘é€æµæ•°æ®               |
| **æµå¼å“åº”**        | ä¸å¿…ç­‰å¾…è¯·æ±‚å®Œæˆï¼Œå¯ä»¥å¤šæ¬¡ä¼ è¾“åˆ†æ®µå“åº”æ•°æ® | åœ¨ watch ä¸­ï¼Œæ¯æ¬¡ Pod å˜åŒ–éƒ½ä¼šç«‹åˆ»æŽ¨é€åˆ°å®¢æˆ·ç«¯         |
| **é•¿è¿žæŽ¥**          | è¿žæŽ¥ä¸å…³é—­ï¼Œç»´æŒå®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯çš„é•¿è¿žæŽ¥     | å®¢æˆ·ç«¯çš„ watch è¯·æ±‚ä¸€ç›´ä¿æŒè¿žæŽ¥ï¼Œç›´åˆ°ä¸­æ–­              |
| **å¤´éƒ¨åŽ‹ç¼©**        | HTTP å¤´çš„ HPACK åŽ‹ç¼©ï¼Œå‡å°‘ç½‘ç»œæµé‡æ¶ˆè€—     | kube-apiserver çš„è¯·æ±‚å’Œå“åº”çš„å¤´éƒ¨å˜å°ï¼Œå‡å°‘å»¶è¿Ÿ        |



##### **HTTP/2 æ˜¯å¦‚ä½•å®žçŽ°â€œè¯·æ±‚-å¤šæ¬¡å“åº”â€çš„ï¼Ÿ**

1. **å¤šè·¯å¤ç”¨**ï¼š
   - åœ¨ HTTP/2 ä¸­ï¼Œå®¢æˆ·ç«¯ä¸ŽæœåŠ¡ç«¯ä¹‹é—´åªå»ºç«‹ä¸€ä¸ª TCP è¿žæŽ¥ï¼Œä½†å¯ä»¥åœ¨è¯¥è¿žæŽ¥ä¸ŠåŒæ—¶å¤„ç†å¤šä¸ª HTTP è¯·æ±‚ã€‚
   - watch è¯·æ±‚ï¼ˆ`GET /api/v1/pods?watch=true`ï¼‰**åªå ç”¨ä¸€ä¸ª HTTP æµ**ï¼Œå³ä½¿æœ‰å…¶ä»–è¯·æ±‚ï¼ˆä¾‹å¦‚ List Podsï¼‰ä¹Ÿä¸ä¼šå½±å“ watch æµã€‚
2. **æ•°æ®æµ (Stream)**ï¼š
   - HTTP/2 ä½¿ç”¨â€œ**æ•°æ®æµ**â€çš„æ¦‚å¿µã€‚
   - å½“ kube-apiserver ç›‘æµ‹åˆ° Pod å˜åŒ–æ—¶ï¼Œ**å°†å˜åŒ–çš„äº‹ä»¶æ‰“åŒ…ä¸ºä¸€æ¡æ¶ˆæ¯**ï¼ŒæŽ¨é€åˆ°ä¸Žå®¢æˆ·ç«¯çš„æµä¸­ã€‚
   - **å®¢æˆ·ç«¯ç›‘å¬åˆ°äº‹ä»¶åŽå¯ä»¥ç«‹åˆ»æŽ¥æ”¶å¹¶å¤„ç†ï¼Œè€Œä¸éœ€è¦å…³é—­æˆ–é‡æ–°è¯·æ±‚ã€‚**
3. **æµå¼å“åº”**ï¼š
   - åœ¨ HTTP/1.1 ä¸­ï¼Œå“åº”æ•°æ®å¿…é¡»ç­‰å¾…è¯·æ±‚å®ŒæˆåŽï¼Œæ‰èƒ½å®Œæ•´è¿”å›žã€‚
   - åœ¨ HTTP/2 ä¸­ï¼ŒæœåŠ¡ç«¯å¯ä»¥**ä¸€æ®µä¸€æ®µåœ°å°†æ•°æ®å‘é€å›žå®¢æˆ·ç«¯**ï¼Œè¿™æ­£æ˜¯ Kubernetes ä¸­ watch æœºåˆ¶çš„å…³é”®ã€‚
   - **æ¯æ¬¡ Pod çŠ¶æ€å˜åŒ–æ—¶ï¼ŒAPI Server ä¼šå°†äº‹ä»¶æŽ¨é€åˆ°å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ç«‹å³æ”¶åˆ°å˜åŒ–æ•°æ®ã€‚**



#### **2. åœ¨ Kubernetes ä¸­çš„å®žçŽ°**

##### **Watch è¯·æ±‚**

``` 
GET /api/v1/pods?watch=true&resourceVersion=123456 HTTP/2
Host: kube-apiserver:6443
```

- **GET** è¯·æ±‚ï¼Œè·¯å¾„æ˜¯ `/api/v1/pods`ï¼Œå¸¦æœ‰å‚æ•° `watch=true`ã€‚
- `resourceVersion=123456`ï¼šè¿™è¡¨ç¤ºå®¢æˆ·ç«¯å¸Œæœ›**ä»Žç‰ˆæœ¬ 123456 ä¹‹åŽçš„äº‹ä»¶å¼€å§‹ç›‘å¬**ã€‚
- è¿™æ˜¯ä¸€ä¸ª HTTP/2 è¯·æ±‚ï¼Œå®ƒ**ä¸å…³é—­è¿žæŽ¥**ï¼Œç›¸å½“äºŽåœ¨ TCP ä¸Šåˆ›å»ºä¸€ä¸ª**é•¿è¿žæŽ¥**ï¼Œå¹¶ä¿æŒæ•°æ®æµã€‚



##### **å“åº”æ•°æ®**

API Server æ£€æµ‹åˆ° Pod å˜åŒ–åŽï¼Œä¼šä¸æ–­åœ°**æµå¼ä¼ è¾“**å˜æ›´äº‹ä»¶ã€‚

```json
jsonCopy code{
  "type": "ADDED",
  "object": {
    "metadata": {
      "name": "nginx-pod",
      "namespace": "default",
      "resourceVersion": "123457"
    },
    "status": {
      "phase": "Running"
    }
  }
}
{
  "type": "MODIFIED",
  "object": {
    "metadata": {
      "name": "nginx-pod",
      "namespace": "default",
      "resourceVersion": "123458"
    },
    "status": {
      "phase": "Terminating"
    }
  }
}
{
  "type": "DELETED",
  "object": {
    "metadata": {
      "name": "nginx-pod",
      "namespace": "default",
      "resourceVersion": "123459"
    }
  }
}
```

- è¿™äº›äº‹ä»¶æ˜¯**åˆ†æ®µè¿”å›žçš„ JSON æ¶ˆæ¯**ã€‚
- æ¯æ¡äº‹ä»¶éƒ½æœ‰ä¸€ä¸ª**äº‹ä»¶ç±»åž‹ (type)**ï¼Œå¯ä»¥æ˜¯ `ADDED`, `MODIFIED`, `DELETED`ã€‚
- **æµå¼æ•°æ®ä¼ è¾“**ï¼šæ¯ä¸ªäº‹ä»¶éƒ½æ˜¯ç‹¬ç«‹çš„ JSON å—ï¼Œkubelet ç«‹åˆ»èƒ½è¯»å–è¿™äº›æ•°æ®ï¼Œè€Œä¸éœ€è¦ç­‰å¾…æ‰€æœ‰æ•°æ®è¿”å›žã€‚
- **ä¸å…³é—­è¿žæŽ¥**ï¼šAPI Server **åªä¼šåœ¨è¿žæŽ¥æ–­å¼€æ—¶å…³é—­æµ**ï¼Œå¦åˆ™ä¼šæŒç»­å‘é€æ•°æ®ã€‚



#### **3. è¿™ä¸Ž WebSocket çš„å¯¹æ¯”**

| **ç‰¹æ€§**     | **HTTP/2**               | **WebSocket**              |
| ------------ | ------------------------ | -------------------------- |
| **è¿žæŽ¥ç±»åž‹** | HTTP/2 é•¿è¿žæŽ¥ï¼Œæµå¼å“åº”  | TCP é•¿è¿žæŽ¥ï¼Œç±»ä¼¼åŒå·¥é€šä¿¡   |
| **åè®®å±‚**   | TCP + HTTP/2             | TCP + WebSocket (ws://)    |
| **å¤šè·¯å¤ç”¨** | æ”¯æŒ                     | ä¸æ”¯æŒï¼ˆä¸€ä¸ªè¯·æ±‚ä¸€ä¸ªé€šé“ï¼‰ |
| **å¹¶å‘æ€§**   | é«˜å¹¶å‘ï¼Œå¤šè¯·æ±‚ä¸€ä¸ª TCP   | éœ€è¦å¤šä¸ª TCP è¿žæŽ¥          |
| **æ•°æ®ä¼ è¾“** | ä»¥**æ•°æ®æµ**ä¼ è¾“åˆ†æ®µæ•°æ® | ä»¥æ•°æ®åŒ…/æ¶ˆæ¯æ–¹å¼ä¼ è¾“      |
| **ä½¿ç”¨åœºæ™¯** | Kubernetes watchã€APIæµ  | èŠå¤©å®¤ã€æ¸¸æˆç­‰åŒå·¥é€šä¿¡     |
| **ç½‘ç»œæ•ˆçŽ‡** | è¾ƒé«˜ï¼Œèµ„æºåˆ©ç”¨çŽ‡é«˜       | è¾ƒé«˜ï¼Œé€‚åˆåŒå·¥é€šä¿¡         |



#### **4. å…³é”®çš„ç½‘ç»œåè®®ç‰¹æ€§**

| **ç½‘ç»œåè®®/ç‰¹æ€§** | **HTTP/2** | **æè¿°**                             |
| ----------------- | ---------- | ------------------------------------ |
| **TCP**           | éœ€è¦       | HTTP/2 æ˜¯åŸºäºŽ TCP ä¼ è¾“çš„ï¼ˆTLS/SSLï¼‰  |
| **TLS/SSL**       | å¿…é¡»       | ä¼ è¾“æ—¶ä½¿ç”¨ TLS åŠ å¯†ï¼Œå¢žå¼ºæ•°æ®å®‰å…¨    |
| **å¤šè·¯å¤ç”¨**      | æ”¯æŒ       | å•ä¸ª TCP è¿žæŽ¥å¯ä¼ è¾“å¤šä¸ª HTTP è¯·æ±‚    |
| **æµæŽ§åˆ¶**        | æ”¯æŒ       | æŽ§åˆ¶æ¯ä¸ªæµçš„æµé‡ï¼Œé¿å…æŸä¸ªæµå æ»¡å¸¦å®½ |
| **åˆ†æ®µä¼ è¾“**      | æ”¯æŒ       | ä¸å¿…ç­‰å¾…æ‰€æœ‰æ•°æ®ï¼Œæµå¼ä¼ è¾“å“åº”ç‰‡æ®µ   |
| **å¤´éƒ¨åŽ‹ç¼©**      | æ”¯æŒ       | ä½¿ç”¨ HPACK åŽ‹ç¼©å¤´éƒ¨ï¼Œå‡å°‘å¸¦å®½        |



#### **5. å…³é”®é—®é¢˜è§£ç­”**

1. **â€œä¸€æ¬¡è¯·æ±‚ï¼Œå¤šæ¬¡å“åº”â€ æ˜¯æ€Žä¹ˆå®žçŽ°çš„ï¼Ÿ**

- ä½¿ç”¨**HTTP/2 ä¸­çš„æµå¼å“åº”**ã€‚
- é€šè¿‡åœ¨ HTTP/2 ä¸­ç»´æŒä¸€ä¸ª**é•¿è¿žæŽ¥**ï¼ŒæœåŠ¡ç«¯ API Server ä¼šä¸æ–­åœ°å°†äº‹ä»¶æŽ¨é€ç»™å®¢æˆ·ç«¯ã€‚
- è¿™äº›äº‹ä»¶æ˜¯ä¸€ä¸ªä¸ª**åˆ†æ®µçš„ JSON æ•°æ®å—**ï¼Œæµå¼è¿”å›žç»™å®¢æˆ·ç«¯ã€‚
- **å®¢æˆ·ç«¯åªéœ€è¦å‘èµ·ä¸€æ¬¡è¯·æ±‚**ï¼ŒAPI Server ä¼šä¸»åŠ¨æŽ¨é€èµ„æºçš„å˜åŒ–æ•°æ®ã€‚



2. **watch æœºåˆ¶ä¸Žä¼ ç»Ÿçš„â€œè½®è¯¢ (polling)â€ æœ‰ä½•ä¸åŒï¼Ÿ**

- **ä¼ ç»Ÿè½®è¯¢**ï¼šå®¢æˆ·ç«¯å®šæœŸå‘é€è¯·æ±‚ï¼ŒèŽ·å–å…¨é‡èµ„æºåˆ—è¡¨ï¼Œå¼€é”€å¤§ï¼Œå»¶è¿Ÿé«˜ã€‚
- **watch æœºåˆ¶**ï¼šå®¢æˆ·ç«¯åªå‘é€ä¸€æ¬¡è¯·æ±‚ï¼ŒAPI Server æŒç»­æŽ¨é€å˜æ›´ï¼Œå®žæ—¶æ€§å¼ºï¼Œèµ„æºå¼€é”€å°ã€‚



3. **å¦‚æžœè¿žæŽ¥æ–­å¼€äº†æ€Žä¹ˆåŠžï¼Ÿ**

- å®¢æˆ·ç«¯ä¼šæ£€æµ‹åˆ°æ–­å¼€ï¼Œå¹¶è‡ªåŠ¨é‡æ–°å‘èµ· watch è¯·æ±‚ã€‚
- å¦‚ä½•é¿å…ä¸¢å¤±æ•°æ®ï¼Ÿ
  - å®¢æˆ·ç«¯ä¼šä½¿ç”¨æœ€åŽçš„ `resourceVersion` æ¥æ¢å¤ã€‚
  - å¦‚æžœ `resourceVersion` å¤ªæ—§ï¼ŒAPI Server ä¼šè¿”å›ž**HTTP 410 Gone**ï¼Œè¿™æ—¶å®¢æˆ·ç«¯ä¼šè§¦å‘**List + Watch**æ“ä½œæ¥é‡æ–°åŒæ­¥æ•°æ®ã€‚



#### **æ€»ç»“**

- **ä¸€æ¬¡è¯·æ±‚ã€å¤šæ¬¡å“åº”**çš„å…³é”®åœ¨äºŽ**HTTP/2 çš„é•¿è¿žæŽ¥å’Œæµå¼ä¼ è¾“**ã€‚
- watch ä½¿ç”¨çš„**HTTP/2 åè®®ã€æµå¼å“åº”ã€å¤šè·¯å¤ç”¨å’Œé•¿è¿žæŽ¥**æŠ€æœ¯ï¼Œé¿å…äº†å®¢æˆ·ç«¯çš„é‡å¤è¯·æ±‚ï¼Œæå‡äº†æ€§èƒ½ã€‚
- **ä¸éœ€è¦å®¢æˆ·ç«¯åå¤è¯·æ±‚**ï¼Œä¸€æ¡è¯·æ±‚ï¼ŒAPI Server æŒç»­æŽ¨é€ã€‚
- **ç½‘ç»œåè®®çš„æ”¯æ’‘**ï¼šHTTP/2 æµã€é•¿è¿žæŽ¥ã€TLS åŠ å¯†å’Œæ•°æ®åˆ†æ®µä¼ è¾“ã€‚





### å„ç»„ä»¶åœ¨HTTP/2çš„è§’è‰²

#### **1. å„ç»„ä»¶åœ¨ HTTP/2 è¯·æ±‚ä¸­çš„è§’è‰²**

| **ç»„ä»¶å¯¹**                 | **å®¢æˆ·ç«¯ (Client)** | **æœåŠ¡ç«¯ (Server)** | **åè®®**   | **æ˜¯å¦ä½¿ç”¨é•¿è¿žæŽ¥** | **é•¿è¿žæŽ¥çš„ä½œç”¨**                           |
| -------------------------- | ------------------- | ------------------- | ---------- | ------------------ | ------------------------------------------ |
| **Scheduler - API Server** | **Scheduler**       | **API Server**      | **HTTP/2** | æ˜¯                 | Scheduler å‘ API Server ç”³è¯·è°ƒåº¦çš„èµ„æºæ›´æ–° |
| **Kubelet - API Server**   | **Kubelet**         | **API Server**      | **HTTP/2** | æ˜¯                 | Kubelet ç›‘å¬ Pod å˜æ›´ (watch)              |
| **API Server - etcd**      | **API Server**      | **etcd**            | **gRPC**   | æ˜¯                 | API Server æŸ¥è¯¢/æ›´æ–° etcd æ•°æ®             |

------

#### **2. è§’è‰²è§£æž**

##### **(1) Scheduler - API Server**

- **å®¢æˆ·ç«¯**ï¼šScheduler æ˜¯å®¢æˆ·ç«¯ã€‚

- **æœåŠ¡ç«¯**ï¼šAPI Server æ˜¯æœåŠ¡ç«¯ã€‚

- **é€šä¿¡æ–¹å¼**ï¼šScheduler é€šè¿‡**HTTP/2 é•¿è¿žæŽ¥**è¯·æ±‚ API Serverã€‚

- **è¯·æ±‚ç±»åž‹**ï¼š

  - Scheduler å‘ API Server å‘é€è¯·æ±‚ï¼Œç­›é€‰å‡ºæœªç»‘å®šçš„ Podã€‚

  - å½“ Scheduler å†³å®šå°† Pod ç»‘å®šåˆ°æŸä¸ªèŠ‚ç‚¹æ—¶ï¼Œå®ƒä¼šå‘ API Server å‘é€ **Bind API è¯·æ±‚**ã€‚

  - è¯·æ±‚ç¤ºä¾‹ï¼š

    ```http
    POST /api/v1/namespaces/default/pods/<pod-name>/binding HTTP/2
    ```

- **é•¿è¿žæŽ¥ä½œç”¨**ï¼š

  - ç”±äºŽ Scheduler ä¸éœ€è¦**watch**èµ„æºï¼ˆä¸åƒ kubelet ç›‘å¬ Pod å˜æ›´ï¼‰ï¼Œæ‰€ä»¥ Scheduler çš„é•¿è¿žæŽ¥æ›´å¤šæ˜¯ä¸ºäº†**æé«˜è¯·æ±‚æ€§èƒ½**ï¼Œé¿å…é¢‘ç¹å»ºç«‹å’Œå…³é—­ TCP è¿žæŽ¥ã€‚
  - å½“æœ‰å¤šä¸ªè°ƒåº¦è¯·æ±‚æ—¶ï¼Œé•¿è¿žæŽ¥çš„**å¤šè·¯å¤ç”¨**ç‰¹æ€§æ˜¾è‘—æé«˜äº†æ•ˆçŽ‡ã€‚



##### **(2) Kubelet - API Server**

- **å®¢æˆ·ç«¯**ï¼šKubelet æ˜¯å®¢æˆ·ç«¯ã€‚

- **æœåŠ¡ç«¯**ï¼šAPI Server æ˜¯æœåŠ¡ç«¯ã€‚

- **é€šä¿¡æ–¹å¼**ï¼š**HTTP/2 é•¿è¿žæŽ¥**ï¼Œ**watch æœºåˆ¶**ã€‚

- **è¯·æ±‚ç±»åž‹**ï¼š

  - kubelet ç›‘å¬ç‰¹å®šçš„èµ„æºï¼ˆå¦‚ Podsï¼‰ï¼š

    ```http
    GET /api/v1/nodes/<node-name>/pods?watch=true&resourceVersion=<RV> HTTP/2
    ```

  - é€šè¿‡ watch æœºåˆ¶ï¼ŒKubelet å¯ä»¥**å®žæ—¶ç›‘å¬ Pod çš„å˜åŒ–**ï¼ˆæ–°å¢žã€ä¿®æ”¹ã€åˆ é™¤ï¼‰ã€‚

  - watch æœºåˆ¶é€šè¿‡**æµå¼å“åº”**ï¼ŒAPI Server åœ¨èµ„æºå˜æ›´æ—¶ï¼Œ**ä¸»åŠ¨æŽ¨é€å˜æ›´äº‹ä»¶**åˆ° Kubeletã€‚

- **é•¿è¿žæŽ¥ä½œç”¨**ï¼š

  - Kubelet åªå‘é€**ä¸€æ¬¡è¯·æ±‚**ï¼ŒAPI Server ä¿æŒé•¿è¿žæŽ¥ï¼ŒæŽ¨é€èµ„æºå˜æ›´äº‹ä»¶ã€‚
  - å¦‚æžœ watch è¿žæŽ¥æ–­å¼€ï¼ŒKubelet ä¼šä½¿ç”¨æœ€åŽçš„ `resourceVersion` é‡æ–°å‘èµ· watch è¯·æ±‚ã€‚



##### **(3) API Server - etcd**

- **å®¢æˆ·ç«¯**ï¼šAPI Server æ˜¯å®¢æˆ·ç«¯ã€‚

- **æœåŠ¡ç«¯**ï¼šetcd æ˜¯æœåŠ¡ç«¯ã€‚

- **é€šä¿¡æ–¹å¼**ï¼š**gRPC é•¿è¿žæŽ¥**ï¼ˆHTTP/2ï¼‰ã€‚

- **è¯·æ±‚ç±»åž‹**ï¼š

  - è¯»æ“ä½œï¼š

    ```go
    etcdClient.Get(ctx, "/registry/pods/default/nginx-pod")
    ```

  - å†™æ“ä½œï¼š

    ```go
    etcdClient.Put(ctx, "/registry/pods/default/nginx-pod", "<pod-data>")
    ```

- **é•¿è¿žæŽ¥ä½œç”¨**ï¼š

  - gRPC æ˜¯åŸºäºŽ **HTTP/2** çš„è¿œç¨‹è¿‡ç¨‹è°ƒç”¨ï¼ˆRPCï¼‰æ¡†æž¶ã€‚
  - **API Server ä¸ä¼šåœ¨æ¯æ¬¡è¯·æ±‚æ—¶é‡æ–°åˆ›å»º TCP è¿žæŽ¥**ï¼Œè€Œæ˜¯ç»´æŒä¸€ä¸ª**æŒä¹…çš„ HTTP/2 è¿žæŽ¥**ï¼Œè¿™æ˜¾è‘—å‡å°‘äº† etcd å’Œ API Server ä¹‹é—´çš„ç½‘ç»œå¼€é”€ã€‚
  - **etcd ä½¿ç”¨ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æŽ§åˆ¶ï¼‰** æœºåˆ¶ï¼Œæ¯ä¸ªå˜æ›´éƒ½ä¼šç”Ÿæˆä¸€ä¸ª**æ–°çš„ revision**ï¼ŒAPI Server ä½¿ç”¨è¿™ä¸ª revision æ¥è¿›è¡Œå¢žé‡ç›‘å¬ã€‚



#### **3. HTTPS è¯ä¹¦çš„ä½¿ç”¨**

> **åœ¨ Kubernetes ä¸­çš„ "ä¸‰å¥—è¯ä¹¦" æ˜¯æŒ‡ï¼š**

1. **ETCD ç»„ä»¶é€šä¿¡è¯ä¹¦**ï¼ˆAPI Server â†” ETCDï¼‰
2. **Kubernetes ç»„ä»¶ä¹‹é—´çš„é€šä¿¡è¯ä¹¦**ï¼ˆAPI Serverã€Schedulerã€Kubeletã€Controller Managerï¼‰
3. **å¤–éƒ¨ç”¨æˆ·çš„é€šä¿¡è¯ä¹¦**ï¼ˆkubectlã€å¤–éƒ¨ API è¯·æ±‚ï¼‰



##### **(1) Scheduler - API Server**

- **è¯ä¹¦ç±»åž‹**ï¼š**Kubernetes ç»„ä»¶å†…éƒ¨é€šä¿¡è¯ä¹¦**
- è¯ä¹¦è¯´æ˜Žï¼š
  - Scheduler éœ€è¦ä¸Ž API Server è¿›è¡Œ HTTPS è®¤è¯ã€‚
  - API Server å…¬å¼€äº†**kube-apiserver.crt** å’Œ **kube-apiserver.key**ã€‚
  - Scheduler ä½¿ç”¨ **kube-controller-manager.crt** å’Œ **kube-controller-manager.key** æ¥ä¸Ž API Server é€šä¿¡ã€‚
  - è¿™äº›è¯ä¹¦å­˜å‚¨åœ¨ **/etc/kubernetes/pki** ç›®å½•ä¸‹ã€‚
  - ç»„ä»¶ä¹‹é—´çš„**å®¢æˆ·ç«¯è¯ä¹¦**å’Œ**æœåŠ¡å™¨è¯ä¹¦**å‡ç”± **Kubernetes CA è¯ä¹¦**ç­¾åã€‚



##### **(2) Kubelet - API Server**

- **è¯ä¹¦ç±»åž‹**ï¼š**Kubernetes ç»„ä»¶å†…éƒ¨é€šä¿¡è¯ä¹¦**
- è¯ä¹¦è¯´æ˜Žï¼š
  - Kubelet éœ€è¦ä¸Ž API Server é€šä¿¡ä»¥èŽ·å– Pod ä¿¡æ¯ã€‚
  - Kubelet è¯ä¹¦ï¼š**kubelet.crt** å’Œ **kubelet.key**ã€‚
  - Kubelet ä½¿ç”¨ **client-certificate-data** å’Œ **client-key-data** è¿›è¡Œå®¢æˆ·ç«¯èº«ä»½éªŒè¯ã€‚
  - API Server ç«¯çš„ **kube-apiserver.crt** å’Œ **kube-apiserver.key** ç”¨äºŽæä¾› HTTPS è¿žæŽ¥çš„æœåŠ¡ç«¯è¯ä¹¦ã€‚



##### **(3) API Server - etcd**

- **è¯ä¹¦ç±»åž‹**ï¼š**ETCD ç»„ä»¶é€šä¿¡è¯ä¹¦**

- è¯ä¹¦è¯´æ˜Ž

  ï¼š

  - API Server ä½œä¸º**å®¢æˆ·ç«¯**ï¼Œetcd ä½œä¸º**æœåŠ¡ç«¯**ã€‚
  - etcd è¯ä¹¦ï¼š**etcd-server.crt** å’Œ **etcd-server.key**ã€‚
  - API Server ä½œä¸ºå®¢æˆ·ç«¯å‘èµ·è¯·æ±‚æ—¶ï¼Œä½¿ç”¨ **etcd-client.crt** å’Œ **etcd-client.key** è¿›è¡ŒåŒå‘è®¤è¯ã€‚
  - è¿™ä¹Ÿæ˜¯ä¸‰å¥—è¯ä¹¦ä¸­**ä¸“é—¨ä¸º ETCD ç»„ä»¶é€šä¿¡ç”Ÿæˆçš„è¯ä¹¦**ã€‚



##### **æ€»ç»“ä¸‰å¥—è¯ä¹¦çš„ä½œç”¨**

| **è¯ä¹¦ç±»åž‹**      | **é€šä¿¡åœºæ™¯**                    | **è¯ä¹¦è·¯å¾„**               | **ä½œç”¨**                                  |
| ----------------- | ------------------------------- | -------------------------- | ----------------------------------------- |
| **ETCD ç»„ä»¶è¯ä¹¦** | API Server â†” etcd               | /etc/kubernetes/pki/etcd/  | etcd å’Œ API Server ä¹‹é—´çš„åŠ å¯†é€šä¿¡         |
| **K8s ç»„ä»¶è¯ä¹¦**  | kubeletã€Scheduler â†” API Server | /etc/kubernetes/pki/       | Kubeletã€Schedulerã€API Server ä¹‹é—´çš„é€šä¿¡ |
| **ç”¨æˆ· API è¯ä¹¦** | kubectl â†” API Server            | /etc/kubernetes/admin.conf | ç”¨æˆ·ä½¿ç”¨ kubectl è®¿é—® API Server          |



#### **4. å…³é”®æ€»ç»“**

1. **è°æ˜¯å®¢æˆ·ç«¯ï¼Œè°æ˜¯æœåŠ¡ç«¯ï¼Ÿ**
   - **Scheduler â†” API Server**: Scheduler æ˜¯å®¢æˆ·ç«¯ï¼ŒAPI Server æ˜¯æœåŠ¡ç«¯ã€‚
   - **Kubelet â†” API Server**: Kubelet æ˜¯å®¢æˆ·ç«¯ï¼ŒAPI Server æ˜¯æœåŠ¡ç«¯ã€‚
   - **API Server â†” etcd**: API Server æ˜¯å®¢æˆ·ç«¯ï¼Œetcd æ˜¯æœåŠ¡ç«¯ã€‚
2. **é•¿è¿žæŽ¥**
   - **Scheduler å’Œ API Server ä¹‹é—´**ï¼šHTTP/2 é•¿è¿žæŽ¥ã€‚
   - **Kubelet å’Œ API Server ä¹‹é—´**ï¼šHTTP/2 é•¿è¿žæŽ¥ï¼ˆwatch æœºåˆ¶ï¼ŒæŽ¨é€å˜åŒ–äº‹ä»¶ï¼‰ã€‚
   - **API Server å’Œ etcd ä¹‹é—´**ï¼šgRPCï¼ˆåŸºäºŽ HTTP/2 çš„é•¿è¿žæŽ¥ï¼‰ã€‚
3. **ä¸‰å¥—è¯ä¹¦çš„ä½¿ç”¨**
   - **ETCD è¯ä¹¦**ï¼šAPI Server â†” etcd é€šä¿¡ã€‚
   - **Kubernetes ç»„ä»¶è¯ä¹¦**ï¼šSchedulerã€Kubeletã€Controller Manager ä¸Ž API Server ä¹‹é—´çš„é€šä¿¡ã€‚
   - **ç”¨æˆ· API è¯ä¹¦**ï¼šå¤–éƒ¨ç”¨æˆ·ï¼ˆå¦‚ kubectlï¼‰ä¸Ž API Server ä¹‹é—´çš„é€šä¿¡ã€‚





## Controller Managerè¯¦è§£

æŽ§åˆ¶å™¨æœ‰å¾ˆå¤šç§ï¼Œä½†æ˜¯é‡Œé¢çš„é€»è¾‘æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯thinkloop, æ¯ä¸€ä¸ªControlleréƒ½æ˜¯ä¸€ä¸ªç”Ÿäº§è€…ï¼Œæ¶ˆè´¹è€…æ¨¡åž‹ï¼Œä¸€è¾¹ç›‘æŽ§API Serverçš„å˜åŒ–ï¼ŒAPI Serveræ”¯æŒwatchable,ä»»ä½•äº‹ä»¶å‘ç”Ÿäº†å˜åŒ–ï¼Œé€šè¿‡watchæœºåˆ¶å°±ä¼šé€šçŸ¥ï¼Œcontroller managerä¸­çš„ç”Ÿäº§è€…å°±ä¼šè§‚æµ‹åˆ°è¿™äº›å˜åŒ–ï¼Œè¿™äº›å˜åŒ–å‘ç”ŸåŽï¼Œä¼šæœ‰å°†å…¶æ”¾å…¥ä¸­å¿ƒé˜Ÿåˆ—ä¸­ï¼Œæ¶ˆè´¹è€…ä»Žè¿™é‡Œå–æ•°æ®ï¼Œå–å‡ºæ¥ä¹‹åŽåŽ»åšé…ç½®ï¼Œæ‰€ä»¥ä»»ä½•æŽ§åˆ¶å™¨éƒ½æ˜¯ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡åž‹

- Controller Manageræ˜¯é›†ç¾¤å¤§è„‘ï¼Œæ˜¯ç¡®ä¿æ•´ä¸ªé›†ç¾¤åŠ¨èµ·æ¥çš„å…³é”®ï¼›
- ä½œç”¨æ˜¯ç¡®ä¿Kuberneteséµå¾ªå£°æ˜Žå¼ç³»ç»Ÿè§„èŒƒï¼Œç¡®ä¿ç³»ç»Ÿçš„çœŸå®žçŠ¶æ€(Actual State)ä¸Žç”¨æˆ·å®šä¹‰çš„æœŸæœ›çŠ¶æ€ï¼ˆDesired Stateï¼‰ä¸€è‡´ï¼›
- Controller Manageræ˜¯å¤šä¸ªæŽ§åˆ¶å™¨çš„ç»„åˆï¼Œæ¯ä¸ªControlleräº‹å®žä¸Šéƒ½æ˜¯ä¸€ä¸ªControll loopï¼Œè´Ÿè´£ä¾¦å¬å…¶ç®¡æŽ§çš„å¯¹è±¡ï¼Œå½“å¯¹è±¡å‘ç”Ÿå˜æ›´æ—¶å®Œæˆé…ç½®ï¼›
- Controlleré…ç½®å¤±è´¥é€šå¸¸ä¼šè§¦å‘è‡ªåŠ¨é‡è¯•ï¼Œæ•´ä¸ªé›†ç¾¤ä¼šåœ¨æŽ§åˆ¶å™¨ä¸æ–­é‡è¯•çš„æœºåˆ¶ä¸‹ç¡®ä¿æœ€ç»ˆä¸€è‡´æ€§ï¼ˆEventual Consistencyï¼‰



### æŽ§åˆ¶å™¨å·¥ä½œæµç¨‹

![image-20241220161159816](D:\git_repository\cyber_security_learning\markdown_img\image-20241220161159816.png)

Informer and lister Overview

- Informer: Informers are responsible for watching Kubernetes resources and reacting to changes(events).They efficiently monitor resouces state by subscribing to API events like `add`,`update`and`Delete`.These events are produced by the Kubernetes API Server whenever relevant objects changed

- Lister: Listers provide cached access to resources. Instead of directly querying the API server, they interact with a local cache that is populated by informers. This makes controllers more efficient by reducing the number of API requests needed to get the current state of objects

Event Handling with Informers

- Event Registration: Informers register event handlers to listen for changes(like add, update,delete)to resources. Whenerver an event occurs (e.g.,a Pod is added or deleted), the informer triggers the corresponding handler

- Key Extraction: The handler processes the event by extracting the key of the affected object, typically composed of its namespace and name. This key uniquely identifies the object in the cluster

Queue and Rate-Limited Queue

- Work Queues: when an event occurs, instead of processing it immediately, the object's key is placed into a rate-limited queue. the rate-limiting aspect helps prevent overwhelming the controllers with too many requests, especially if there are repeated failures. if a failure occurs, the item can be re-enqueued after a delay based on the rate-limiting policy

- Rate Limiting: Rate limiting is crucial for handing failures gracefully. If processing an event fails (e.g., due to a temporary error or unavailability of resources),the object is re-enqueued after a backoff period, allowing the controller to retry the operation without overloading the system.

Worker and Consumer Logic:

- Workers: On the other side of the queue, worker goroutines continuously dequeue and process these events.Each worker pull a key from the queue and reconclies the state of the corresponding object by querying its details using the lister and then performing the required actions to converge the cluster's state towards the desired configuration.
- Reconciliation Loop: The worker performs a reconciliation loop,which consists of checking the current state of the resource,comparing it to the desired state, and taking corrective action if there is a discrepancy.For instance, if a Pod should be running but isn't the controller will take steps to start it.

Error Handling and Retry

- If the processing of an event fails, the key is re-queued with a delay(rate limiting) so that the controller can retry later. This mechanism helps handle transient error without discarding events and ensures that all objects eventually converge to their desired state.

Producer-Consumer Model

- THis entire flow is a classic producer-consumer model:
  - Producers: The informers produce events and enqueue the affected objects'keys.
  - Consumers: Workers act as consumers, dequeueing keys, and processing them until the queue is empty.

- æ³¨æ„ï¼š
  - Informer ç›‘å¬çš„æ˜¯å½“å‰çŠ¶æ€çš„å˜åŒ–ï¼Œé€šè¿‡å¤„ç† API Server æŽ¨é€çš„äº‹ä»¶ï¼Œç¡®ä¿æœ¬åœ°ç¼“å­˜ä¸­çš„æ•°æ®å§‹ç»ˆä¸Ž Kubernetes é›†ç¾¤ä¸­çš„å®žé™…çŠ¶æ€ä¿æŒåŒæ­¥ã€‚
  - Lister æä¾›çš„æ˜¯å¯¹å½“å‰çŠ¶æ€çš„è®¿é—®ï¼Œä½†è¿™ä¸ªçŠ¶æ€æ˜¯ä»Ž informer çš„ç¼“å­˜ä¸­èŽ·å–çš„ã€‚å®ƒæ˜¯ä¸ºäº†å‡å°‘é¢‘ç¹çš„ API è¯·æ±‚ï¼Œæå‡è®¿é—®æ€§èƒ½ã€‚



### Informerçš„å†…éƒ¨æœºåˆ¶

![image-20241220161252961](D:\git_repository\cyber_security_learning\markdown_img\image-20241220161252961.png)



- kubernetesæä¾›äº†ä¸€ç³»åˆ—çš„é¡¹ç›®ï¼Œè¯¥é¡¹ç›®å«code generatorï¼Œï¼ˆKubernetes æä¾›äº†å·¥å…·ï¼Œå¦‚ code-generatorï¼Œå¯ä»¥è‡ªåŠ¨ä¸ºä½ ç”Ÿæˆ Go è¯­è¨€çš„å®¢æˆ·ç«¯ã€informerã€lister å’Œæ·±åº¦æ‹·è´å‡½æ•°ã€‚è¿™äº›å·¥å…·èƒ½å¤§å¤§ç®€åŒ–è‡ªå®šä¹‰æŽ§åˆ¶å™¨çš„å¼€å‘ã€‚ä½ åªéœ€ä¸“æ³¨äºŽå®šä¹‰è‡ªå®šä¹‰èµ„æºçš„ç»“æž„ä½“ï¼Œå‰©ä¸‹çš„ä»£ç ç”Ÿæˆå·¥ä½œäº¤ç”± code-generator å®Œæˆã€‚ï¼‰è¿™ä¸ªé¡¹ç›®çš„ä½œç”¨å°±æ˜¯ä½ è¦å®šä¹‰ä»»ä½•Kuberneteså¯¹è±¡ï¼Œå®šä¹‰è¿™äº›å¯¹è±¡æ—¶ï¼Œåªéœ€è¦åŽ»å®šä¹‰å®ƒçš„æ•°æ®ç»“æž„ï¼Œè¿™ä¸ªæ•°æ®ç»“æž„ä¸€æ—¦åˆ›å»ºå¥½ï¼Œåœ¨API Serverè¿™è¾¹å‘å¸ƒï¼Œä½ å°±å¯ä»¥é€šè¿‡api ServeråŽ»è®¿é—®è¿™ä¸ªæ•°æ®

- Informeré¦–å…ˆä¼šæä¾›ä¸€ä¸ªlist&watchæœºåˆ¶ï¼ˆinformeråœ¨å¯åŠ¨åŽä¼šå‘èµ·ä¸€ä¸ªé•¿è¿žæŽ¥åˆ°API serverï¼Œé€šå¸¸æ¥è®²ï¼Œä¼šåœ¨ç¬¬ä¸€æ—¶é—´listä¸€ä¸‹ï¼Œæ¯”å¦‚ä¸€ä¸ªpod list&watchï¼Œå®ƒä¼šæŠŠå½“å‰æ‰€æœ‰çš„podlistä¸‹æ¥ï¼Œç„¶åŽå›žåˆ›å»ºwatchè¿žæŽ¥ï¼Œé‚£ä¹ˆapi serverä¸Šæœ‰å“ªäº›podçš„å˜åŒ–ï¼Œå°±ä¼šå‘Šè¯‰informerï¼‰
  - API Serveræ˜¯ä¸€ä¸ªæ ‡å‡†çš„RESTfulAPIï¼Œ å®ƒæä¾›äº†ä¸€ä¸ªstringï¼Œä¸€ä¸ªjsonæ ¼å¼çš„åºåˆ—åŒ–æ•°æ®ï¼Œå¦‚æžœæˆ‘ä»¬çš„ç¨‹åºè¦åŽ»æ¶ˆè´¹è¿™ä¸ªåºåˆ—åŒ–çš„æ•°æ®ï¼Œé‚£ä¹ˆå°±è¦ååºåˆ—åŒ–ï¼Œï¼ˆå°±æ˜¯æŠŠè¿™ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªä¸ªgoå¯¹è±¡ï¼Œè¿™é‡Œä½¿ç”¨åå°„æœºåˆ¶å®žçŽ°ï¼Œåå°„æœºåˆ¶å›žåŽ»è§£æžapi serverä¸­çš„keyï¼Œæ¯ä¸€ä¸ªå¯¹è±¡çš„å®šä¹‰ï¼Œå®ƒéƒ½ä¼šæœ‰json_tagï¼Œé€šè¿‡json tagï¼Œæˆ‘ä»¬å°±ä¼šçŸ¥é“ï¼Œè¿™ä¸ªjsonçš„key,å¯¹åº”goè¯­è¨€ä¸­çš„å“ªä¸ªå±žæ€§ï¼Œé€šè¿‡è¿™ç§åå°„æœºåˆ¶ï¼Œå°±æŠŠä¸€ä¸ªåºåˆ—åŒ–çš„å¯¹è±¡ï¼Œè½¬æ¢ä¸ºgoçš„structï¼‰
  - åŽç»­æœ‰ä¸€ä¸ªDelta buffï¼Œä¸€ä¸ªçŽ¯çŠ¶å†…å­˜ç»“æž„ï¼ˆä»»ä½•æ—¶å€™éƒ½å¯ä»¥ä¸€ç›´å¾€é‡Œå†™ï¼‰ï¼Œå¦‚æžœæˆ‘çš„bufferæ»¡äº†ï¼Œå°±ä¼šè‡ªåŠ¨è¦†ç›–æœ€è€çš„æ•°æ®çš„
  - ç„¶åŽä»–ä¼šåšä¸€ä¸ªé€šçŸ¥ï¼Œè®©informeræ¥å¤„ç†è¿™äº›æ•°æ®
  - informerä¼šæŠŠè¿™äº›ååºåˆ—åŒ–å¥½çš„æ•°æ®ï¼Œæ”¾å…¥thread Safe Storeé‡Œé¢ï¼Œè¿™é‡Œæœ‰indexerï¼Œä¼šæœ‰ç´¢å¼•ï¼Œæˆ‘ä»¬åœ¨æœªæ¥è¦åŽ»è®¿é—®è¿™äº›Kuberneteå¯¹è±¡çš„æ—¶å€™ï¼Œå°±ä¸éœ€è¦åŽ»api serveråŽ»è®¿é—®äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å¯¹local storeè®¿é—®ï¼Œå‡å°‘å¯¹api serverçš„è®¿é—®ï¼Œç„¶åŽåŒæ—¶è¿™ä¸ªå¯¹è±¡çš„å˜åŒ–ä¼šé€šè¿‡eventå‘ç»™event handlerï¼Œç„¶åŽå°†å¯¹åº”çš„keyæå–å‡ºæ¥æ”¾å…¥queueä¸­ï¼Œç”±å¦ä¸€è¾¹çš„wokerå°†å…¶å–èµ°è¿›è¡Œå¤„ç†


- ä»»ä½•çš„æŽ§åˆ¶å™¨éƒ½åº”è¯¥ä½¿ç”¨shareinformerçš„freemokeï¼Œæ‰€æœ‰çš„å¯¹è±¡åªè¦ç”¨äº†shareinformerçš„freemokeï¼Œæ‰€æœ‰å¯¹è±¡åœ¨å®¢æˆ·ç«¯ï¼Œæ¯”æ–¹ä½ è¦å†™ä¸ªæŽ§åˆ¶å™¨ï¼Œåœ¨ä½ æŽ§åˆ¶å™¨ç«¯ï¼Œæ‰€æœ‰api serverå¯¹è±¡å·²ç»æœ‰ä¸€ä»½æœ¬åœ°çš„ç¼“å­˜äº†ï¼Œç”±shareinformerä¿è¯æœ¬åœ°ç¼“å­˜å’Œapiserverä¸­å¯¹è±¡çš„ç‰ˆæœ¬ä¸€è‡´æ€§ï¼Œæ‰€ä»¥å½“æˆ‘ä»¬å†™æŽ§åˆ¶å™¨ä»£ç çš„æ—¶å€™ï¼Œåº”è¯¥é¿å…ç›´æŽ¥è®¿é—®api serverã€‚è¯»å–ä»»ä½•å¯¹è±¡éƒ½åº”è¯¥åŽ»local storeåŽ»è¯»å–ï¼ˆThread safe storeï¼‰ï¼Œè€Œä¸æ˜¯ç›´æŽ¥åŽ»api serveråŽ»è¯»ã€‚ä¸€èˆ¬æ¥è®²ï¼Œåªæœ‰æ›´æ–°ä¸€ä¸ªå¯¹è±¡çš„æ—¶å€™æ‰ä¼šåŽ»apiserverä¸­æ›´æ–°ï¼Œè¦åŽ»è°ƒç”¨api server. 

- æ³¨æ„ä¸Šè¿°çš„local storeæŒ‡çš„æ˜¯ä»£ç é‡Œï¼Œå†…å­˜é‡Œçš„storeä¸æ˜¯æœ¬åœ°çš„é‚£ä¸ªcacheç›®å½•ï¼Œé‚£ä¸ªåœ°æ–¹åªæ˜¯åŽ»æ‹‰å–ä¸€ä¸‹å½“å‰æ”¯æŒçš„apiï¼Œå®ƒä¸ä¼šå­˜å‚¨å¯¹è±¡ï¼ŒçœŸå®žçš„å¯¹è±¡æ˜¯å­˜åœ¨æŽ§åˆ¶å™¨çš„local storeçš„




### æŽ§åˆ¶å™¨çš„ååŒå·¥ä½œåŽŸç†

![image-20241220161329298](D:\git_repository\cyber_security_learning\markdown_img\image-20241220161329298.png)

- åˆ›å»ºä¸€ä¸ªdeploymentçš„èµ„æºæ¸…å•ï¼Œä½¿ç”¨kubectlåœ¨å®¢æˆ·ç«¯åˆ›å»ºåŽï¼Œå‘ç»™API Server

```shell
kubectl apply -f myapp-deployment.yaml
```

- API Serverå¯¹æˆ‘è¿›è¡Œè®¤è¯ï¼ˆé€šè¿‡è¯»æœ¬åœ°é…ç½®æ–‡ä»¶ï¼ŒçŸ¥é“æˆ‘æ˜¯è°ï¼‰ï¼Œç„¶åŽé‰´æƒï¼Œå› ä¸ºæˆ‘ç”¨çš„æ˜¯adminçš„èº«ä»½åŽ»ç™»å½•çš„ï¼Œæ‰€ä»¥æˆ‘æ˜¯æœ‰åˆ›å»ºdeploymentçš„æƒé™çš„ï¼Œç„¶åŽæˆ‘çš„deploymentåˆæ˜¯åˆæ³•çš„ï¼Œæ‰€ä»¥æˆ‘å¾—deploymentå¯¹è±¡è¢«API ServeræŽ¥æ”¶ï¼Œå¹¶å­˜å…¥etcdä¸­
- `kube-controller-manager`é‡Œé¢æœ‰ä¸€ä¸ªdeployment controllerï¼Œé¡¾åæ€ä¹‰ï¼Œå®ƒæ„Ÿå…´è¶£çš„å¯¹è±¡æ˜¯deploymentï¼Œå®ƒå›žåŽ»æ ¹æ®èµ„æºæ¸…å•çš„å±žæ€§ï¼ŒåŽ»åˆ›å»ºä¸€ä¸ªreplicasetçš„å¯¹è±¡

```shell
# æŸ¥çœ‹deploymentå¯¹è±¡
kubectl describe deployment myapp -n learn01
Name:                   myapp
Namespace:              learn01
CreationTimestamp:      Tue, 01 Oct 2024 16:02:31 +0800
Labels:                 app=myapp
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               app=myapp
Replicas:               3 desired | 3 updated | 3 total | 3 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  app=myapp
  Containers:
   pod-test2:
    Image:         registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    Port:          <none>
    Host Port:     <none>
    Environment:   <none>
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   myapp-7547f4df6 (3/3 replicas created)
Events:
  Type    Reason             Age    From                   Message
  ----    ------             ----   ----                   -------
  Normal  ScalingReplicaSet  6m31s  deployment-controller  Scaled up replica set myapp-7547f4df6 to 3
```

- `kube-controller-manager`é‡Œé¢åˆæœ‰ReplicaSet Controllerï¼Œå®ƒä¹Ÿåœ¨ç›‘å¬API Serverï¼Œç„¶åŽå®ƒç›‘å¬åˆ°éœ€è¦åˆ›å»º3ä¸ªpodï¼Œç„¶åŽå½“å‰podä¸å­˜åœ¨ï¼Œä¸€æ¬¡å°±éœ€è¦å®ƒåŽ»åˆ›å»ºè¿™3ä¸ªpodï¼Œç„¶åŽè¿™ä¸ªpodçš„å¯¹è±¡ç”±replicasetå‘åˆ°API Server

```shell
[root@master201 iventory]#kubectl get replicaset -n learn01
NAME              DESIRED   CURRENT   READY   AGE
myapp-7547f4df6   3         3         3       7m37s
[root@master201 iventory]#kubectl describe replicaset -n learn01
Name:           myapp-7547f4df6
Namespace:      learn01
Selector:       app=myapp,pod-template-hash=7547f4df6
Labels:         app=myapp
                pod-template-hash=7547f4df6
Annotations:    deployment.kubernetes.io/desired-replicas: 3
                deployment.kubernetes.io/max-replicas: 4
                deployment.kubernetes.io/revision: 1
Controlled By:  Deployment/myapp
Replicas:       3 current / 3 desired
Pods Status:    3 Running / 0 Waiting / 0 Succeeded / 0 Failed
Pod Template:
  Labels:  app=myapp
           pod-template-hash=7547f4df6
  Containers:
   pod-test2:
    Image:         registry.cn-beijing.aliyuncs.com/wangxiaochun/pod-test:v0.1
    Port:          <none>
    Host Port:     <none>
    Environment:   <none>
    Mounts:        <none>
  Volumes:         <none>
  Node-Selectors:  <none>
  Tolerations:     <none>
Events:
  Type    Reason            Age   From                   Message
  ----    ------            ----  ----                   -------
  Normal  SuccessfulCreate  8m5s  replicaset-controller  Created pod: myapp-7547f4df6-fr2hh
  Normal  SuccessfulCreate  8m5s  replicaset-controller  Created pod: myapp-7547f4df6-nkgnd
  Normal  SuccessfulCreate  8m5s  replicaset-controller  Created pod: myapp-7547f4df6-s74wv
```

- API Serverå°†è¯¥POdå¯¹è±¡å›ºåŒ–ä¸‹æ¥ï¼Œå­˜å…¥etcd
- Podå¯¹è±¡è¢«åˆ›å»ºä¸‹æ¥åŽï¼Œåœ¨åˆå§‹çŠ¶æ€ä¸‹ï¼Œpodå†…çš„nodenameå±žæ€§æ˜¯æ²¡æœ‰è¢«å†™å€¼çš„

```shell
kubectl get pod myapp-7547f4df6-fr2hh -n learn01 -o yaml|grep -i nodename
nodeName: node205.feng.org
```

- è¿™ä¸ªæ—¶å€™ç”±äºŽnodenameæ˜¯ç©ºï¼Œæ­¤æ—¶è°ƒåº¦å™¨Schedulerå°±ä¼šåŽ»åšè°ƒåº¦ï¼Œè°ƒåº¦å™¨åœ¨API Serverä¸Šwatchäº†æ²¡æœ‰è°ƒåº¦è¿‡çš„(nodenameä¸ºç©º)podå¯¹è±¡ï¼Œä»¥åŠå½“å‰èŠ‚ç‚¹çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç„¶åŽæ ¹æ®è°ƒåº¦ç­–ç•¥ï¼Œåˆ¤æ–­å½“å‰é‚£ä¸ªèŠ‚ç‚¹æœ€é€‚åˆè¿™ä¸ªpodï¼Œç„¶åŽå°†è¿™ä¸ªèŠ‚ç‚¹å’Œpodåšç»‘å®šï¼Œå¹¶å°†ç»“æžœå†™å…¥API Server

- å†™å›žåˆ°API ServeråŽï¼ŒèŠ‚ç‚¹ä¸Šçš„kubeletä¼šå…³æ³¨å½“å‰API Serverä¸­ï¼Œè·Ÿæˆ‘çš„èŠ‚ç‚¹ç›¸å…³çš„podæœ‰å“ªäº›ï¼Œè¯¥èŠ‚ç‚¹å‘ç”Ÿäº†ä¸€ä¸ªpodç»‘å®šåŽï¼Œä¼šè¢«kubeletå‘çŽ°ï¼Œå°±ä¼šåŽ»æœ¬åœ°æŸ¥å½“å‰è¿è¡Œçš„podæœ‰æ²¡æœ‰è¿™ä¸ªpodï¼Œå¦‚æžœæ²¡æœ‰ï¼Œå°±ä¼šè¿›å…¥create podçš„æµç¨‹ï¼Œèµ·podï¼Œå¦‚æžœpodæ²¡æœ‰å¤–æŒ‚å­˜å‚¨ï¼Œå°±ä¼šä½¿ç”¨runtimeæ‹‰èµ·podï¼Œå¹¶è°ƒç”¨ç½‘ç»œæ’ä»¶ä¸ºpod setupç½‘ç»œï¼Œå¦‚æžœéœ€è¦å¤–æŒ‚å­˜å‚¨ï¼Œå°±éœ€è¦ä½¿ç”¨csiï¼Œä¸ºè¿™ä¸ªpodæŒ‚è½½ç£ç›˜


- å¦‚æžœæˆ‘åˆ é™¤ä¸€ä¸ªpodï¼Œæ­¤æ—¶ä¾ç„¶ä¼šäº§ç”Ÿä¸€ä¸ªäº‹ä»¶eventï¼Œè¿™ä¸ªäº‹ä»¶æ˜¯pod deleteäº‹ä»¶ï¼Œè¯¥äº‹ä»¶è¢«replicaset controllerç›‘å¬åˆ°ï¼Œå®ƒçš„èŒè´£æ˜¯é‡Œé¢çš„æ‰€æœ‰podçš„æ•°é‡ä¹Ÿç”¨æˆ·çš„æœŸæœ›çš„æ•°é‡åº”è¯¥æ˜¯ä¸€æ ·çš„ï¼Œæˆ‘åˆ é™¤äº†ä¸€ä¸ªï¼Œæ­¤æ—¶å®žé™…podæ•°é‡å’ŒæœŸæœ›æ•°é‡ä¸ç­‰ï¼Œå°±ä¼šè¢«replicasetç›‘æµ‹åˆ°ï¼Œæ­¤æ—¶ä¸ºäº†ç¡®ä¿ä¸€è‡´ï¼Œä»–å°±ä¼šåŽ»åˆ›å»ºä¸€ä¸ªæ–°çš„pod







## SRVè®°å½•è¯¦è§£

SRVï¼ˆ**Service Locator Record**ï¼‰æ˜¯ DNS ä¸­çš„ä¸€ç§è®°å½•ç±»åž‹ï¼Œç”¨äºŽ**æŒ‡å®šæŸä¸ªæœåŠ¡çš„ä¸»æœºåï¼ˆhostnameï¼‰å’Œç«¯å£å·ï¼ˆport numberï¼‰**ï¼Œä»¥ä¾¿å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å®ƒæ‰¾åˆ°æŒ‡å®šæœåŠ¡çš„å®žä¾‹ã€‚å®ƒçš„**ä¸»è¦ä½œç”¨æ˜¯æ”¯æŒåŸºäºŽæœåŠ¡çš„å‘çŽ°**ï¼Œç‰¹åˆ«æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­éžå¸¸æœ‰ç”¨ã€‚



### SRV è®°å½•çš„ç»“æž„

SRV è®°å½•çš„ç»“æž„ç”±ä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†ç»„æˆï¼š

```kotlin
_service._protocol.name TTL class SRV priority weight port target
```

| **å­—æ®µ**    | **å«ä¹‰**                                                     |
| ----------- | ------------------------------------------------------------ |
| `_service`  | æœåŠ¡åç§°ï¼Œä»¥ `_` å¼€å¤´ã€‚ä¾‹å¦‚ï¼Œ`_http` è¡¨ç¤º HTTP æœåŠ¡ã€‚        |
| `_protocol` | ä½¿ç”¨çš„åè®®ï¼Œä¾‹å¦‚ `_tcp` è¡¨ç¤º TCP åè®®ï¼Œ`_udp` è¡¨ç¤º UDP åè®®ã€‚ |
| `name`      | æœåŠ¡çš„åŸŸåï¼Œè¡¨ç¤ºæ­¤æœåŠ¡æ‰€å±žçš„åŸŸã€‚ä¾‹å¦‚ï¼Œ`service-test.default.svc.cluster.local`ã€‚ |
| `TTL`       | è®°å½•çš„ç”Ÿå­˜æ—¶é—´ï¼ˆTime To Liveï¼‰ï¼Œä»¥ç§’ä¸ºå•ä½ï¼Œè¡¨ç¤ºè¯¥è®°å½•åœ¨ DNS ç¼“å­˜ä¸­çš„æœ‰æ•ˆæœŸã€‚ |
| `class`     | é€šå¸¸ä¸º `IN`ï¼Œè¡¨ç¤º Internet ç±»åˆ«çš„è®°å½•ã€‚                      |
| `SRV`       | è¡¨ç¤ºè¯¥è®°å½•æ˜¯ SRV ç±»åž‹ã€‚                                      |
| `priority`  | ä¼˜å…ˆçº§ï¼Œæ•°å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå®¢æˆ·ç«¯åº”ä¼˜å…ˆä½¿ç”¨ä¼˜å…ˆçº§è¾ƒé«˜çš„ç›®æ ‡æœåŠ¡å™¨ã€‚ |
| `weight`    | æƒé‡ï¼Œç”¨äºŽåœ¨åŒä¸€ä¼˜å…ˆçº§ä¸‹çš„è´Ÿè½½å‡è¡¡ã€‚æƒé‡è¶Šé«˜ï¼Œè¯¥æœåŠ¡å™¨è¢«é€‰ä¸­çš„æ¦‚çŽ‡è¶Šé«˜ã€‚ |
| `port`      | æœåŠ¡è¿è¡Œçš„ç«¯å£å·ã€‚ä¾‹å¦‚ï¼ŒHTTP é€šå¸¸æ˜¯ `80`ï¼ŒHTTPS æ˜¯ `443`ã€‚   |
| `target`    | æœåŠ¡å¯¹åº”çš„ä¸»æœºåï¼ˆåŸŸåï¼‰ï¼ŒæŒ‡å‘æä¾›æ­¤æœåŠ¡çš„ä¸»æœºï¼ˆå¯ä»¥æ˜¯ Service çš„åç§°æˆ– Pod çš„ IPï¼‰ã€‚ |



### **SRV è®°å½•çš„ç¤ºä¾‹**

å‡è®¾ Kubernetes ä¸­æœ‰ä¸€ä¸ªåä¸º `service-test` çš„ **Service**ï¼Œä½äºŽ `default` å‘½åç©ºé—´ï¼ŒåŸŸååŽç¼€ä¸º `cluster.local`ï¼Œå…¶ IP ä¸º `10.97.72.1`ï¼Œå¹¶æä¾› TCP åè®®çš„ HTTP æœåŠ¡ï¼Œç›‘å¬ç«¯å£ `80`ã€‚å¯¹åº”çš„ SRV è®°å½•å¦‚ä¸‹ï¼š

```kotlin
_http._tcp.service-test.default.svc.cluster.local. 30 IN SRV 0 100 80 service-test.default.svc.cluster.local.
```



### SRVè®°å½•çš„ä½œç”¨å’Œç”¨é€”

**æœåŠ¡å‘çŽ°ï¼š**

- SRV è®°å½•å¯ä»¥è®©å®¢æˆ·ç«¯åŠ¨æ€å‘çŽ°æœåŠ¡çš„ä¸»æœºåå’Œç«¯å£ï¼Œè€Œæ— éœ€ç¡¬ç¼–ç ã€‚
- åœ¨ Kubernetes ä¸­ï¼ŒService çš„ SRV è®°å½•ç”¨äºŽå®¢æˆ·ç«¯é€šè¿‡ DNS æŸ¥è¯¢æ‰¾åˆ°ç›¸åº”çš„æœåŠ¡å®žä¾‹ã€‚

**è´Ÿè½½å‡è¡¡ï¼š**

- SRV è®°å½•æ”¯æŒé€šè¿‡ **priority** å’Œ **weight** å­—æ®µå®žçŽ°ç®€å•çš„è´Ÿè½½å‡è¡¡ã€‚
- åŒä¸€ä¼˜å…ˆçº§çš„æœåŠ¡å®žä¾‹æŒ‰ç…§æƒé‡åˆ†é…æµé‡ï¼Œä¼˜å…ˆçº§è¾ƒé«˜çš„æœåŠ¡ä¼šè¢«ä¼˜å…ˆé€‰æ‹©ã€‚

**åŠ¨æ€åˆ†å¸ƒå¼ç³»ç»Ÿï¼š**

- åœ¨å¾®æœåŠ¡æž¶æž„æˆ–åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼ŒæœåŠ¡çš„å®žä¾‹å¯èƒ½åŠ¨æ€æ‰©ç¼©å®¹ã€‚SRV è®°å½•å…è®¸å®¢æˆ·ç«¯æ ¹æ® DNS åŠ¨æ€èŽ·å–æœåŠ¡çš„æœ€æ–°ä¿¡æ¯ã€‚

**çµæ´»æ€§ï¼š**

- SRV è®°å½•å¯ä»¥ä¸ºæœåŠ¡å®šä¹‰å¤šä¸ªå®žä¾‹ï¼Œæ¯ä¸ªå®žä¾‹çš„ä¼˜å…ˆçº§å’Œæƒé‡å¯ä»¥çµæ´»è°ƒæ•´ï¼Œä»Žè€Œå®žçŽ°æ›´å¤æ‚çš„è´Ÿè½½åˆ†é…ç­–ç•¥ã€‚





## K8Sä¸­å®‰å…¨æœºåˆ¶çš„è¯ä¹¦ä½“ç³»



### Kubelet å’Œ apiServerä¹‹é—´é€šä¿¡

Kubernetes ä¸­ **kubelet å’Œ API Server ä¹‹é—´çš„é€šä¿¡**ç¡®å®žå¾ˆå¥½åœ°ä½“çŽ°äº† Kubernetes **åŒå‘ TLSï¼ˆmTLSï¼ŒMutual TLSï¼‰**çš„åŠ å¯†æœºåˆ¶ã€‚è¿™ç§æœºåˆ¶é€šè¿‡åŒå‘éªŒè¯ç¡®ä¿äº†é€šä¿¡çš„å®‰å…¨æ€§å’Œèº«ä»½çš„å¯ä¿¡æ€§ã€‚



#### Kubernetes åŒå‘ TLS é€šä¿¡çš„å·¥ä½œæœºåˆ¶

**åŒå‘ TLS åŠ å¯†ï¼š**

- åŒå‘ TLS æ„å‘³ç€ï¼š
  - **å®¢æˆ·ç«¯ï¼ˆkubeletï¼‰éªŒè¯æœåŠ¡ç«¯ï¼ˆAPI Serverï¼‰çš„èº«ä»½**ã€‚
  - **æœåŠ¡ç«¯ï¼ˆAPI Serverï¼‰éªŒè¯å®¢æˆ·ç«¯ï¼ˆkubeletï¼‰çš„èº«ä»½**ã€‚
- è¿™ç§åŒå‘è®¤è¯ç¡®ä¿äº†åŒæ–¹éƒ½æ˜¯å¯ä¿¡ä»»çš„ï¼Œå¹¶é˜²æ­¢äº†ä¸­é—´äººæ”»å‡»ï¼ˆMitMï¼‰ã€‚



**æ¶‰åŠçš„è¯ä¹¦ï¼š**

- **kubelet çš„å®¢æˆ·ç«¯è¯ä¹¦** 

  ```bash
  [root@node1 pki]# ls /var/lib/kubelet/pki/kubelet-client-current.pem
  
  [root@node1 pki]# openssl x509 -in /var/lib/kubelet/pki/kubelet-client-current.pem -text -noout
  Certificate:
      Data:
          Version: 3 (0x2)
          Serial Number:
              f4:4c:9d:a8:f2:82:e8:fd:07:5a:3b:64:57:45:ed:cc
          Signature Algorithm: sha256WithRSAEncryption
          Issuer: CN = kubernetes            # ä¸Šçº§CA
          Validity
              Not Before: Jan  4 01:40:29 2025 GMT
              Not After : Jan  4 01:40:29 2026 GMT
          Subject: O = system:nodes, CN = system:node:node1
          Subject Public Key Info:
              Public Key Algorithm: id-ecPublicKey
              ......
  ```

  - kubelet ç”¨äºŽå‘ API Server è¯æ˜Žè‡ªå·±çš„èº«ä»½ã€‚

- **API Server çš„æœåŠ¡ç«¯è¯ä¹¦**

  ```bash
  /etc/kubernetes/pki/apiserver.crt
  
  [root@master1 pki]#openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text -noout
  Certificate:
      Data:
          Version: 3 (0x2)
          Serial Number: 8495257128868470889 (0x75e5375951cf6069)
          Signature Algorithm: sha256WithRSAEncryption
          Issuer: CN = kubernetes            # ä¸Šçº§CA
          Validity
              Not Before: Jan  4 01:39:06 2025 GMT
              Not After : Jan  4 01:44:06 2026 GMT
          Subject: CN = kube-apiserver
          Subject Public Key Info:
          ......
  ```

  - API Server ç”¨äºŽå‘ kubelet è¯æ˜Žè‡ªå·±çš„èº«ä»½ã€‚

- **CA è¯ä¹¦**

  ```bash
  /etc/kubernetes/pki/ca.crt
  
  [root@node1 pki]# openssl x509 -in ca.crt -text -noout
  Certificate:
      Data:
          Version: 3 (0x2)
          Serial Number: 1575855922115436521 (0x15de909ca6e2dfe9)
          Signature Algorithm: sha256WithRSAEncryption
          Issuer: CN = kubernetes            # ä¸Šçº§CA
          Validity
              Not Before: Jan  4 01:39:06 2025 GMT
              Not After : Jan  2 01:44:06 2035 GMT
          Subject: CN = kubernetes          # ä¸Šçº§CAä¸€è‡´ï¼Œå› æ­¤æ˜¯è‡ªç­¾è¯ä¹¦
          Subject Public Key Info:
          ......
  ```

  - kubelet å’Œ API Server éƒ½é€šè¿‡è¯¥ CA è¯ä¹¦éªŒè¯å¯¹æ–¹çš„è¯ä¹¦æ˜¯å¦åˆæ³•ã€‚



**é€šä¿¡è¿‡ç¨‹ï¼š**

- kubelet è¿žæŽ¥åˆ° API Serverï¼š
  1. kubelet å‘èµ· HTTPS è¯·æ±‚ï¼Œå¹¶å‘é€è‡ªå·±çš„å®¢æˆ·ç«¯è¯ä¹¦å’Œç§é’¥ã€‚
  2. API Server éªŒè¯ kubelet çš„å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦ç”±å¯ä¿¡ CA ç­¾å‘ã€‚
  3. éªŒè¯é€šè¿‡åŽï¼ŒAPI Server ç¡®è®¤ kubelet æ˜¯ä¸€ä¸ªå¯ä¿¡çš„å®¢æˆ·ç«¯ã€‚

- API Server è¿”å›žå“åº”ï¼š
  1. API Server è¿”å›žè‡ªå·±çš„æœåŠ¡ç«¯è¯ä¹¦ã€‚
  2. kubelet ä½¿ç”¨æœ¬åœ°çš„ CA è¯ä¹¦éªŒè¯ API Server çš„æœåŠ¡ç«¯è¯ä¹¦ã€‚
  3. éªŒè¯é€šè¿‡åŽï¼Œkubelet ç¡®è®¤ API Server æ˜¯å¯ä¿¡çš„æœåŠ¡ç«¯ã€‚

- æœ€ç»ˆï¼ŒåŒå‘ TLS éªŒè¯å®Œæˆï¼Œé€šä¿¡å»ºç«‹ã€‚





### Kubectl å’Œ apiServerä¹‹é—´é€šä¿¡

`Kubectl` æ˜¯ Kubernetes çš„å‘½ä»¤è¡Œå·¥å…·ï¼Œç”¨äºŽä¸Žé›†ç¾¤çš„ API Server é€šä¿¡ã€‚å®ƒæ˜¯ç”¨æˆ·å’Œ Kubernetes é›†ç¾¤ä¹‹é—´çš„æ¡¥æ¢ï¼Œæ‰€æœ‰å¯¹é›†ç¾¤çš„æ“ä½œéƒ½æ˜¯é€šè¿‡ `kubectl` å‘å‡ºçš„è¯·æ±‚å®žçŽ°çš„ã€‚ä»¥ä¸‹æ˜¯ `kubectl` å’Œ API Server ä¹‹é—´é€šä¿¡çš„è¯¦ç»†è®²è§£ï¼š



#### é€šä¿¡çš„åŸºç¡€æ¦‚å¿µ

**kubectl çš„å·¥ä½œåŽŸç†ï¼š**

- `kubectl` é€šè¿‡ **REST API** ä¸Ž API Server é€šä¿¡ã€‚
- `kubectl` ä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆé€šå¸¸æ˜¯ **`~/.kube/config`**ï¼‰æ¥ç¡®å®šéœ€è¦è¿žæŽ¥çš„ API Server çš„åœ°å€ã€è®¤è¯ä¿¡æ¯ã€å‘½åç©ºé—´ç­‰ã€‚



**API Server çš„èŒè´£**

- API Server æ˜¯ Kubernetes æŽ§åˆ¶å¹³é¢çš„æ ¸å¿ƒç»„ä»¶ã€‚
- å®ƒæŽ¥æ”¶ `kubectl` å‘å‡ºçš„ REST è¯·æ±‚ï¼ŒéªŒè¯ã€æŽˆæƒè¯·æ±‚ï¼Œå¹¶å°†å…¶è·¯ç”±åˆ°ç›¸åº”çš„æŽ§åˆ¶å™¨æˆ– etcd å­˜å‚¨ã€‚



**ä½¿ç”¨çš„åè®®**

- `kubectl` å’Œ API Server çš„é€šä¿¡ä½¿ç”¨ **HTTPS** åè®®ã€‚
- é€šä¿¡é€šè¿‡ **åŒå‘ TLSï¼ˆmTLSï¼‰** è®¤è¯è¿›è¡ŒåŠ å¯†å’Œèº«ä»½éªŒè¯ã€‚



#### é€šä¿¡è¿‡ç¨‹è¯¦è§£

**åŠ è½½é…ç½®æ–‡ä»¶**

- `kubectl` åœ¨è¿è¡Œæ—¶ï¼Œä¼šè¯»å–é»˜è®¤çš„ `~/.kube/config` æ–‡ä»¶ï¼ŒåŠ è½½ä»¥ä¸‹ä¿¡æ¯ï¼š
  - **API Server çš„åœ°å€ï¼š** å¦‚ `https://<api-server-ip>:6443`ã€‚
  - **è®¤è¯ä¿¡æ¯ï¼š** åŒ…æ‹¬å®¢æˆ·ç«¯è¯ä¹¦ã€å¯†é’¥ã€æˆ– Bearer Tokenã€‚
  - **å‘½åç©ºé—´ï¼š** å¦‚æžœæœªæŒ‡å®šï¼Œé»˜è®¤æ˜¯ `default`ã€‚
  - **ä¸Šä¸‹æ–‡ï¼š** ç”¨äºŽé€‰æ‹©å½“å‰é›†ç¾¤çš„é…ç½®ã€‚



**è®¤è¯ä¸ŽæŽˆæƒ**

- **è®¤è¯ï¼š**
  - `kubectl` æä¾›å®¢æˆ·ç«¯è¯ä¹¦æˆ– Token ç»™ API Serverã€‚
  - API Server ä½¿ç”¨ CA è¯ä¹¦ï¼ˆå¦‚ `/etc/kubernetes/pki/ca.crt`ï¼‰éªŒè¯å®¢æˆ·ç«¯è¯ä¹¦çš„åˆæ³•æ€§
  - è‹¥éªŒè¯æˆåŠŸï¼ŒAPI Server è¯†åˆ«ç”¨æˆ·èº«ä»½
- **æŽˆæƒ**
  - API Server æ ¹æ®ç”¨æˆ·èº«ä»½å’ŒRBACï¼ˆRole-Based Access Controlï¼‰ç­–ç•¥ï¼Œæ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡Œè¯¥æ“ä½œã€‚

- **è¯·æ±‚çš„å…·ä½“å¤„ç†**
  - è¯·æ±‚å¯ä»¥æ˜¯ `kubectl get pods`ã€`kubectl apply -f deployment.yaml` ç­‰ã€‚
  - API Server å¤„ç†æµç¨‹ï¼š
    - **è§£æžè¯·æ±‚ï¼š** æ ¹æ®è¯·æ±‚è·¯å¾„å’Œæ–¹æ³•ï¼ˆå¦‚ GETã€POSTã€DELETEï¼‰åˆ¤æ–­æ“ä½œç›®æ ‡å’Œç±»åž‹ã€‚
    - **éªŒè¯è¯·æ±‚ï¼š** æ£€æŸ¥è¯·æ±‚ä½“æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚
    - **è·¯ç”±è¯·æ±‚ï¼š** å°†è¯·æ±‚è½¬å‘ç»™å¯¹åº”çš„æŽ§åˆ¶å™¨æˆ–ç»„ä»¶ï¼ˆå¦‚ Schedulerã€Controller Managerï¼‰ã€‚
    - **è¿”å›žå“åº”ï¼š** è¿”å›žæ“ä½œç»“æžœæˆ–æ•°æ®ï¼ˆå¦‚ Pod åˆ—è¡¨ï¼‰ã€‚
- **ä¼ è¾“å®‰å…¨æ€§**
  - é€šä¿¡ä½¿ç”¨ **TLS åŠ å¯†**ï¼Œé˜²æ­¢æ•°æ®è¢«çªƒå¬æˆ–ç¯¡æ”¹ã€‚
  - åŒå‘ TLS ç¡®ä¿ï¼š
    - **API Server çš„èº«ä»½ï¼š** `kubectl` ä½¿ç”¨ CA è¯ä¹¦éªŒè¯ API Server çš„æœåŠ¡ç«¯è¯ä¹¦ã€‚
    - **kubectl çš„èº«ä»½ï¼š** API Server ä½¿ç”¨ CA éªŒè¯ `kubectl` çš„å®¢æˆ·ç«¯è¯ä¹¦ã€‚



#### åŒå‘ TLS å®žçŽ°ç»†èŠ‚

**kubectl å®¢æˆ·ç«¯è¯ä¹¦ï¼š**

- é€šå¸¸å­˜å‚¨åœ¨ `~/.kube/config` æ–‡ä»¶ä¸­ï¼ŒæŒ‡å‘ä»¥ä¸‹å­—æ®µï¼š
  - `client-certificate`ï¼šå®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„ã€‚
  - `client-key`ï¼šå®¢æˆ·ç«¯ç§é’¥è·¯å¾„ã€‚
  - `certificate-authority`ï¼šCA è¯ä¹¦è·¯å¾„ï¼Œç”¨äºŽéªŒè¯ API Server çš„æœåŠ¡ç«¯è¯ä¹¦ã€‚



**API Server æœåŠ¡ç«¯è¯ä¹¦ï¼š**

- å­˜å‚¨åœ¨ `/etc/kubernetes/pki/apiserver.crt`ã€‚
- é…ç½®åœ¨ API Server çš„å¯åŠ¨å‚æ•°ä¸­ï¼Œç”¨äºŽå¯¹å¤–æä¾› HTTPS æœåŠ¡ã€‚



**äº¤äº’è¿‡ç¨‹**

- `kubectl` ä½¿ç”¨è‡ªå·±çš„å®¢æˆ·ç«¯è¯ä¹¦ä¸Ž API Server æ¡æ‰‹ï¼Œè¯æ˜Žèº«ä»½ã€‚
- API Server ä½¿ç”¨æœåŠ¡ç«¯è¯ä¹¦æä¾› HTTPS æœåŠ¡ï¼Œ`kubectl` éªŒè¯å…¶èº«ä»½



#### é€šä¿¡ç¤ºä¾‹

**kubectl å‘½ä»¤ï¼š**

```bash
kubectl get pods
```

**å®Œæ•´é€šä¿¡æµç¨‹ï¼š**

- **kubectl å‘èµ·è¯·æ±‚ï¼š**
  - è¯·æ±‚åœ°å€ï¼šä»Žé…ç½®æ–‡ä»¶ä¸­è¯»å–ï¼Œå¦‚ `https://<api-server-ip>:6443/api/v1/pods`ã€‚
  - è¯·æ±‚æ–¹æ³•ï¼š`GET`ã€‚
  - é™„å¸¦è®¤è¯ä¿¡æ¯ï¼ˆå®¢æˆ·ç«¯è¯ä¹¦æˆ– Tokenï¼‰ã€‚
- **API Server éªŒè¯èº«ä»½ï¼š**
  - éªŒè¯ `kubectl` æä¾›çš„å®¢æˆ·ç«¯è¯ä¹¦æ˜¯å¦ç”±å¯ä¿¡ CA ç­¾å‘ã€‚
  - æ ¹æ® RBAC æƒé™æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ `list pods` çš„æƒé™ã€‚

- **API Server æ‰§è¡Œæ“ä½œï¼š**
  - æŸ¥è¯¢ etcd æ•°æ®åº“ä¸­çš„ Pod ä¿¡æ¯ã€‚
  - æ ¼å¼åŒ–æŸ¥è¯¢ç»“æžœä¸º JSONã€‚
- **API Server è¿”å›žç»“æžœï¼š**
  - å°† JSON æ•°æ®é€šè¿‡ HTTPS è¿”å›žç»™ `kubectl`ã€‚
  - `kubectl` æ ¼å¼åŒ–å¹¶åœ¨ç»ˆç«¯æ˜¾ç¤ºç»“æžœã€‚



#### é…ç½®æ–‡ä»¶ç¤ºä¾‹

**`~/.kube/config` æ–‡ä»¶ï¼š**

```yaml
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority: /etc/kubernetes/pki/ca.crt # CA è¯ä¹¦è·¯å¾„ï¼Œç”¨äºŽéªŒè¯ API Server çš„æœåŠ¡ç«¯è¯ä¹¦ã€‚
    server: https://<api-server-ip>:6443
  name: kubernetes
users:
- name: admin
  user:
    client-certificate: /etc/kubernetes/pki/admin.crt   # å®¢æˆ·ç«¯è¯ä¹¦è·¯å¾„
    client-key: /etc/kubernetes/pki/admin.key
contexts:
- context:
    cluster: kubernetes
    user: admin
  name: admin@kubernetes
current-context: admin@kubernetes

```

