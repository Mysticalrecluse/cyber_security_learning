# 协议层次和服务模型

我们首先要承认一点，网络是一个非常复杂的系统。

为什么复杂呢？因为在网络中有各种各样的复杂应用，各种各样的终端形式，各种各样的链路形式，
网络所具备的功能除了
- 局部的点到点的传输功能外， --------- MAC 链路层
- 还有端到端的路由的功能，   --------- IP  网络层
- 还有可靠数据传输的功能，   --------- TCP 传输层
- 还有各种各样的网络应用的功能 -------  APP 应用层

由此可以得出一个结论，就是计算机网络是一个异常复杂的“大系统”

从互联网的角度来看，互联网有数百亿个设备，几十亿个用户，数千种流行的应用,可以说是人类历史上最复杂的规模最大的人工系统。

那么问题来了，当初的工程师群体，科学家实体们，如何设计实现组织这样庞大复杂的计算机网络的功能呢？

解决这个问题的思路：就是模块化的思路，模块化的方式就是把一个比较复杂的功能，分解为一个个的模块，模块之间相互调用，而且是平面调用，任何一个模块都可以调用任何其他模块所提供的功能和服务，这样就可以把比较复杂的功能通过模块化的分解和实现，将一个复杂问题拆解成多个简单的小问题，这样才有希望将其设计出来。

而互联网解决的方法就是分层的方法，来解决：将一个复杂的功能分为一个个的模块，而模块和模块之间调用与被调用的关系是仅相邻的两层的模块之间能够调用和被调用，它不允许或者说不推荐跨层的调用

计算机网络就是采用这种分层的方式，这种特殊的模块化的方式，来解决设计和实现的。这样将功能非常复杂的计算机网络的功能，分解为一个个功能明确的层次，每一层实现了一个或一组功能，而每一层的功能通过层间的接口，向上层提供服务，这样的话，一层落一层，一层落一层，最后实现比较复杂的计算机网络的功能

我们的计算机网络，包括互联网都是采用分层的方法来设计和实现的，那么我们具体来看计算机网路如何通过分层的方法来解决计算机网络的设计和实现的。我们举两个现实生活中的例子来方便大家理解

## 两个异地哲学家做思想交流

场景：两个异地的哲学家，要使用不同的语言，来进行哲学思想的沟通

哲学家A          --------------------------             哲学家B


翻译A           ----------------------------             翻译B


秘书A            ----------------------------            秘书B
 
           这种运输形式（马车，飞鸽，物流，圆通，京东）


我们来看一下，两个异地哲学家使用不同语言来进行哲学思想交流这种复杂的问题，是如何解决的

我们设置三个层次：
- 最下面的是秘书层：解决异地通讯问题

- 翻译层：解决表示转换的问题，比如哲学家A原来用的英语，哲学家用的法语或者德语，翻译将这两个哲学家的语言做一个转换，转换成一个公用的语言，来进行交流

- 哲学家层：两个哲学家交换哲学思想，从而完成深层次的哲学的学术交流，对应我们的网络就是两个应用进程交换应用报文，来实现各种各样丰富多彩的网络应用，包括电子交易，数据库查询，包括域名解析，包括远程登录，包括文件上传下载


那么我们是如何利用这三层解决这个问题的呢：

哲学家把他的哲学思想通过本地的层间接口，交给下层的翻译层，

翻译层拿到这个哲学的思想之后，把上面交下来的信件，转换成双方商量好的公用语言描述的文稿，加上一些头部信息，一些控制信息（比如交给对方的那个秘书，哪个翻译），让翻译好的文稿交给秘书层

秘书层借助于下层所一共的服务，下层可以是电信公司提供的服务，可以马车提供的服务，也可以是飞鸽传书，当然也可以是互联网提供的服务来传递这个信件


信件到了对方的秘书层，得到这封信，将信封拆下来，交给相应的翻译B，翻译B根据他们两者商量好的语言，将其翻译成哲学家B所能够理解的语言

此时哲学家B就能收到哲学家A发出的哲学上探讨的文本，而且是语义层面上收到的

总的来说，它设置了3个层面来解决两个异地哲学家使用不同语言做哲学交流的复杂问题


秘书层： 解决异地通讯问题

翻译层：解决表示转换问题

应用层，也就是哲学家层：在下面两层所提供的服务基础上，完成了哲学思想的交流。

这里我们之前说的，两个翻译，所商量好的共用的语言，就是他们的“协议”所规范的内容  ------------ 协议

两个秘书所采用的通信方式，也是他们协议所规范的内容


由此我们很直接的看到这种分层解决问题所带来的两个好处：

- 我们可以把一个非常复杂的问题，把它转换成3个子问题，每个问题的解决相对比较独立，比较单一

- 秘书层之间通信的方式，可以使用新的技术来替换老的技术，比如原来使用马车通信，现在使用电报，电话通信； 两个翻译之间的语言也可以比如之前使用英语，现在可以换成效率更高的语言。

也就是说使用层次化解决问题的最大的好处：
- 把大的问题分解成小问题，便于问题的解决
- 各层之间相对独立，便于采用新技术，而不会影响其他层



## 网络分层

这里我们把分层的思想做一个正式的描述，就是把网络非常复杂的功能，分解成若干个功能明确的层次

每一层实现一个或一组功能，其中有的功能可以被上层通过层间接口调用，上层的一些模块可以使用下层提供的功能，这个功能的子集，我们把它叫做服务 -------- 服务

我有很强大的功能，但是不能为别人所用，算不算服务？ --- 当然不算，所谓服务是功能的一部分，是上层面可以通过接口使用下层提供的功能，我们把这种功能的子集叫做服务Servers

每个层次通过层间接口向上层提供服务，对等层的模块（协议实体）通过协议来交换控制信息，从而实现各自的功能

这里如何将PDU（协议数据单元）在两个对等层实体之间进行传递：借助下层所提供的服务，通过层间接口上层使用下层的服务，

也就是说，本层协议实体要交换PDU（协议数据单元），要通过层间接口，访问下层提供的服务，这样对等层之间才能交换PDU(即数据)

那对等层协议实体交换报文的目的是什么：通过本地的处理，通过与对等层信息的交换，通过一些协议的动作，来实现更复杂的功能，而更复杂的功能，通过上层的层间接口，再向紧邻的上层来提供服务


总结起来就是：把计算机网络复杂的功能分层一个个功能明确的层次，每一层通过层间接口向上层提供服务，
这里每一层如何向上层提供服务（它的功能怎么来呢）：要借助于下层提供的服务，来跟对方交换PDU，包括内部的一些处理，从而加上下层的服务，加上它跟对方的交流，实现更复杂，更新特性的功能，通过层间接口，再向上层提供更好的服务，这样一层落一层，一层落一层，最终实现比较复杂的计算机网络功能

这里本层协议实体交互的过程当中，应该遵守的动作的规则的集合，我们将其称之为协议。
协议的目的是什么：是为了向上层提供更好的服务；
协议怎么实现：通过层间接口，访问下层提供的服务才能实现

这就是协议和服务之间的关系，协议是对等的水平关系，而服务是垂直关系

这部分内容是整个网络核心的架构性内容，就是怎么设计，实现，组织比较复杂的计算机网络的这样一个功能，

就是把它分成一个个功能明确的层次，每一层实现一个或一组功能，具体实现的时候，就采用协议实体的相关动作来实现的

协议实体如何实现的，如何实现交互的动作？借助于层间的接口，借助于下层提供的服务，来交换相应的PDU来实现的，实现PDU的协议动作的目的：是为了向上层提供更好的服务，每一次层向上层提供的服务，包括了所有下层向上提供服务的总和，还包括跟对等层实体在交互过程中，形成的新的服务特性，通过层间接口，向上提供服务。


## 术语
- 服务（Service）：底层实体向上提供他们之间的通信的能力
    - 服务用户(Service user)
    - 服务访问点：(Service provider)

- 服务访问点SAP(Service Access Point)：上层使用下层提供的服务通过层间的接口——地点：
    - 比如TCP向一些应用提供服务，这些应用就是服务用户，TCP实体就是服务提供者，在哪里提供服务：SAP服务访问点（这个场景下就是Port）
    - 下层的一个实体支撑着上层的多个实体，SAP有标志不同上层实体的作用
    - SAP是一个抽象的概念，用于标识传输层服务和应用层服务之间的接口，比如，端口号在传输层就是一种SAP，帮助传输层将数据传输到对应的应用程序
    - 例子：传输层的SAP：端口Port

- 原语(Primitive)：上层使用下层服务的形式，高层使用低层提供的服务，以及低层向高层提供服务都是通过服务访问原语来进行交互的---形式

                  A1（telnet）             A2(ftp)              A3(http)

-----------------    (sap)      ----------  (sap)     --------   (sap)      ------------

                                           TCP实体

这里服务可能有一个服务用户和服务访问点的问题，所谓服务用户就是：例如，TCP实体上有很多应用（A1（telnet）, A2(fpt), A3(web)），比如在tcp实体上可以跑telnet应用，可以跑FTP应用，可以跑http应用，那么此时对于这个TCP实体来说，是不是有三个同时存在的用户，TCP实体向三个应用提供服务，这里TCP实体是“服务的提供者”，A1, A2, A3是“服务的用户”
而服务访问点是：TCP实体同时向三个应用实体提供服务，这里就有一个问题，就是来了报文之后，我要区分出，这个报文是给A1的，还是给A2的，还是给A3的，为了解决这个问题，就有服务访问点，也就是在层间接口上有一系列点，用来区分不同的上层用户，例如：套接字，就是层间的SAP的一种实现，它里面包含着端口信息，

寄信人 -------->     邮政公司  ---------->   寄给谁

例如：邮政公司，我们都要通过它寄信，谁寄给它的，最后它寄给谁，这里邮政公司就相当于服务访问点，用于下层的服务提供者来区分不同上层用户的一些信息，穿过层间访问点，这个信息就叫做服务访问点，比如传输层向应用层提供的服务socket(4元组)，从上层应用层传下来到传输层的时候加以标注，传输到对方后加以区分，从而知道是谁传输给谁，就是层间的服务访问点

再举例：比如顺丰快递，寄快递要标注谁寄的，寄给谁，

总结：主体问题就是服务用户，和服务提供者，在哪里：层间界面上的SAP（服务访问点），形式呢？就是所谓的原语,即服务用户究竟使用什么形式来使用服务提供者提供的服务，服务提供者采用什么形式向服务用户提供服务，即使所谓的原语

比如：Socket API，应用程序接口，上面的一堆函数，就是原语
Socket API，就是应用程序接口，通过这个应用程序接口，可以采用应用进程和操作系统约定的一系列函数来创建Socket，使用SOcket进行发送，来关闭socket，都是一系列的函数，这些函数在这个场景中就是原语

形式就是所谓的原语，即服务用户使用什么形式，来使用服务提供者提供的服务,例如传输层向应用层提供服务，其实现方式就是Socket API，即各种socket函数，而Tcp

当然网络层向TCP/UDP提供的服务，也有形式问题，也就是所谓的原语



## 服务的类型
- 面向连接的服务
  - 两个通讯进程在实质性通讯之前，需要握手建立连接，即TCP
- 无连接的服务
  - 两个通讯进程在实质性通讯之前，不需要握手建立连接，即UDP


服务和协议的差别
协议是什么呢，对等层的实体在通信的过程当中遵守规则的许可，服务是什么呢？通过层间的接口，在系统的内部，通过层间的接口，在SAP上，通过原语的形式，向上层提供服务，为什么使用SAP呢，因为很多用户都可以使用下层的服务，下层的协议实体可以同时为多个用户提供服务，必须要用SAP来区分，那么形式呢，通过原语形式加以规范和区分


服务与协议的差别
本层协议实现的时候，要借助下层所提供的服务才能实现。实现本能协议的目的是什么？是为了向上层提供更好到的服务，这样，比较复杂的网络功能，就可以通过一层落一层，一层落一层而得以实现


## 数据单元
SDU: 上层传递到下层的数据就是SDU（Service Date Unit），当然在传输SDU的过程中，需要穿过层间接口，可能要添加一些本层需要附加的控制信息（头部），形成本层的PDU，这个控制信息叫做ICI（Interface Contorl Information）接口控制信息，ICI加SDU要传的数据，一起叫IDU

PDU：上层来的数据SDU，加上本层的控制信息ICI（头部），形成本层的PDU(Protocl Data Unit)，对等层协议实体在交换的过程中，都是由第N层的PDU来交换的

当然情况可能没有那么简单，上层来的SDU，刚好作为本层的数据部分是一种理想情况，还有两种常见情况，SDU过大，我们必须将SDU分解成一个个小块，每一块是SDU的一部分，在加上第N成的头部，形成第N层的PDU，还有一种情况就是，SDU很小，在穿过层间接口的时候，将多个SDU串联在一起，再加上前面的头部信息，形成第N层的PDU


头部信息的来源，一部分是ICI转过来的，一部分是本层附加上去的

每一层的PDU都有它自己的称呼
- 应用层：message 应用报文
- 传输层：segment 报文段
- 网络层：package 分组
- 链路层：iframe  帧
- 物理层： bit    位


## (TCP/IP)网络协议栈

TCP/IP协议栈没有表示层和会话层！！，这两层的功能交给应用层去做

### 物理层
对于物理层来说，上层交下来的帧iframe，把帧中的每个bit，变成物理信号，在介质中传送给对方，这是发送端做的事，接收端负责把物理媒体上承载的物理信号，电磁波信号，光信号，把它还原回原来的数字数据0101

### 链路层
链路层的作用：在物理层提供服务的基础上，在相邻的两点之间，传输以帧为单位的数据，

### 网络层
在链路成提供的相邻两点数据传输的服务的基础上，传输以分组为单位的端到端的数据传输
转发（局部），路由（全局）

### 传输层
仅仅有端到端的数据传输还不够，传输层在网络层之上，借助于以分组为单位的主机到主机的数据传输的基础上，完成进程到进程的区分，
其次，网络层提供的传输本身是不可靠的，可能会发生数据包丢了，错了，乱序，重复等等，传输层另一个可能得服务是需要将网络层提供的不可靠的数据传输，把它变成可靠的数据传输

(表示层)

(会话层)

### 应用层
应用进程在传输层所提供的服务的基础上，完成应用报文之间的交互，从而实现各种各样的功能，比如订单查询，文件上传，文件下载，邮件通信等等


## 封装与解封装
在源端和目标端，要做一个大封装和解封装，在路由器上还要做一个三层封装和解封装，假设一个路由器两个网卡，从其中一个链路的网卡上收到电磁波信号，通过物理层将一个个信号还原出数字信号，然后区分出哪里是帧头哪里是帧尾，然后把帧里的数据部分取出来交给网络层，网络层分析分组的头部，头部有一些目标IP地址等控制信息，根据目标IP地址，使用路由表决定将给分组通过另一个网卡放出去，，将分组交给另一个网卡，然后该网卡拿到分组后，再封装上链路层的头部形成链路层的帧，在交给物理层，将每个bit变成电信号或光信号将其打出去。到交换机的时候还要进行一个两层的解封装

