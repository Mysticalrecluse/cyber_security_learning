# 微服务实验

## Nacos

### Nacos部署

**环境准备** 

- 安装好 JDK，需要 1.8 及其以上版本 
- 建议: 2核 CPU / 4G 内存 及其以上 
- 建议: 生产环境 3 个节点 及其以上



#### Nacos 单机部署

**二进制安装**

```bash
[root@ubuntu2204 ~]#aptupdate && apt install -y openjdk-11-jdk
[root@ubuntu2204 ~]#wget https://github.com/alibaba/nacos/releases/download/2.2.3/nacos-server-2.2.3.tar.gz
[root@ubuntu2204 ~]#tar xf nacos-server-2.2.3.tar.gz -C /usr/local/

# 查看 
[root@ubuntu2204 ~]#ls /usr/local/nacos/
bin  conf  LICENSE  NOTICE  target

[root@ubuntu2204 ~]#ls /usr/local/nacos/bin
shutdown.cmd  shutdown.sh  startup.cmd  startup.sh

[root@ubuntu2204 ~]#ls /usr/local/nacos/conf/
1.4.0-ipv6_support-update.sql  application.properties          cluster.conf.example  mysql-schema.sql
announcement.conf              application.properties.example  derby-schema.sql      nacos-logback.xml

[root@ubuntu2204 ~]#ls /usr/local/nacos/target/
nacos-server.jar

# 添加PATH变量，可选
[root@ubuntu2204 ~]#echo 'PATH=/usr/local/nacos/bin:$PATH' >> /etc/profile
[root@ubuntu2204 ~]#. /etc/profile
```



**单机模式部署MySQL**

```bash
[root@ubuntu2204 logs]#apt update && apt install -y mysql-server
[root@ubuntu2204 logs]#mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.43-0ubuntu0.22.04.2 (Ubuntu)

Copyright (c) 2000, 2025, Oracle and/or its affiliates.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

# 创建数据库
mysql> create database nacos;
Query OK, 1 row affected (0.00 sec)

# 需要指定验证插件，不支持默认插件CachingSha2Password
mysql> create user nacos@'127.0.0.1' identified with  mysql_native_password by '123456';
Query OK, 0 rows affected (0.00 sec)

mysql> grant all on nacos.* to nacos@'127.0.0.1';
Query OK, 0 rows affected (0.00 sec)


# 生成表结构
[root@ubuntu2204 logs]#mysql -unacos -p123456 -h127.0.0.1  nacos  < /usr/local/nacos/conf/mysql-schema.sql
[root@ubuntu2204 ~]#vim /usr/local/nacos/conf/application.properties
......
#*************** Config Module Related Configurations ***************#
### If use MySQL as datasource:
### Deprecated configuration property, it is recommended to use `spring.sql.init.platform` replaced.
# spring.datasource.platform=mysql
spring.sql.init.platform=mysql   # 添加此行

### Count of DB:
db.num=1     # 添加此行

### Connect URL of DB:
# db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=truee
&useUnicode=true&useSSL=false&serverTimezone=UTC
# db.user.0=nacos
# db.password.0=nacos
# 加下面三行
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&uu
seUnicode=true&useSSL=false&serverTimezone=UTC
db.user.0=nacos
db.password.0=123456
```



**开启鉴权**

```bash
#生成toke的值，至少32位，否则无法启动
[root@ubuntu2204 logs]#openssl rand -base64 33
cb0VkpiQJgnvbHaNOz2qBnhT7E0XbZN+g73mkPoq4FQZ

# 修改配置文件,共四行内容
[root@ubuntu2204 logs]#vim /usr/local/nacos/conf/application.properties
......
### The auth system to use, currently only 'nacos' and 'ldap' is supported:
nacos.core.auth.system.type=nacos

### If turn on auth system:
#nacos.core.auth.enabled=false
nacos.core.auth.enabled=true     # 修改此行为true

......

nacos.core.auth.server.identity.key=mystical    #指定值,否则无法启动
nacos.core.auth.server.identity.value=mystical  #指定值,否则无法启动

......

# 添加前面生成的token的值
nacos.core.auth.plugin.nacos.token.secret.key=cb0VkpiQJgnvbHaNOz2qBnhT7E0XbZN+g73mkPoq4FQZk

# 启动
[root@ubuntu2204 logs]#startup.sh -m standalone
```

测试访问,默认用户名和密码都是nacos

```http
http://nacos.wang.org:8848/nacos
```

![image-20250929151902436](../../markdown_img/image-20250929151902436.png)

![image-20250929152722013](../../markdown_img/image-20250929152722013.png)

**修改密码**

![image-20250929152904730](D:\git_repository\cyber_security_learning\markdown_img\image-20250929152904730.png)

![image-20250929152933621](../../markdown_img/image-20250929152933621.png)

**密码保存在nacos库中的users表中**

```bash
[root@ubuntu2204 logs]#mysql -unacos -p123456 -h127.0.0.1  nacos -e 'select * from users'
mysql: [Warning] Using a password on the command line interface can be insecure.
+----------+--------------------------------------------------------------+---------+
| username | password                                                     | enabled |
+----------+--------------------------------------------------------------+---------+
| nacos    | $2a$10$1dD8fxMD8EqqgodivLLwO.0ALnoNdaq2U9QhIHZMR.XA6KFMbwQnK |       1 |
+----------+--------------------------------------------------------------+---------+
```

**后续访问需要经过鉴权后才能访问**

```bash
# 直接访问失败
[root@ubuntu2204 logs]#curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance?serviceName=nacos.wang.serviceName&ip=1.2.3.4&port=8080''
# 返回失败提示如下
{"timestamp":"2025-09-29T15:38:36.266+08:00","status":403,"error":"Forbidden","message":"user not found!","path":"/nacos/v1/ns/instance"}

# 登录验证，获取Token，这里使用自己的账号密码
[root@ubuntu2204 logs]#curl -X POST 'http://127.0.0.1:8848/nacos/v1/auth/login' -d 'username=nacos&password=123456'
{"accessToken":"eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTc1OTE0OTYzMX0.eXn5bptVa2Es5msmlb82q7KUakxN4HVkwww4dTxGS64","tokenTtl":18000,"globalAdmin":true,"username":"nacos"}

# 利用 token 访问
# 服务注册
[root@ubuntu2204 logs]#curl -X POST 'http://127.0.0.1:8848/nacos/v1/ns/instance?accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTc1OTE0OTYzMX0.eXn5bptVa2Es5msmlb82q7KUakxN4HVkwww4dTxGS64&serviceName=nacos.mystical.serviceName&ip=1.2.3.4&port=8080'
ok

#后续服务访问需要在原URL后添加
&accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTc1OTE0OTYzMX0.eXn5bptVa2Es5msmlb82q7KUakxN4HVkwww4dTxGS64

# 服务发现
[root@ubuntu2204 logs]#curl -X GET 'http://127.0.0.1:8848/nacos/v1/ns/instance/list?accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTc1OTE0OTYzMX0.eXn5bptVa2Es5msmlb82q7KUakxN4HVkwww4dTxGS64&serviceName=nacos.mystical.serviceName'
{"name":"DEFAULT_GROUP@@nacos.mystical.serviceName","groupName":"DEFAULT_GROUP","clusters":"","cacheMillis":10000,"hosts":[{"instanceId":"1.2.3.4#8080#DEFAULT#DEFAULT_GROUP@@nacos.mystical.serviceName","ip":"1.2.3.4","port":8080,"weight":1.0,"healthy":false,"enabled":true,"ephemeral":true,"clusterName":"DEFAULT","serviceName":"DEFAULT_GROUP@@nacos.mystical.serviceName","metadata":{},"instanceHeartBeatInterval":5000,"instanceHeartBeatTimeOut":15000,"ipDeleteTimeout":30000,"instanceIdGenerator":"simple"}],"lastRefTime":1759132837131,"checksum":"","allIPs":false,"reachProtectionThreshold":false,"valid":true}

# 发布配置
[root@ubuntu2204 logs]#curl -X POST "http://127.0.0.1:8848/nacos/v1/cs/configs?accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTc1OTE0OTYzMX0.eXn5bptVa2Es5msmlb82q7KUakxN4HVkwww4dTxGS64&dataId=nacos.cfg.dataId&group=test&content=HelloWorld"
true

# 获取配置
[root@ubuntu2204 logs]#curl -X GET "http://127.0.0.1:8848/nacos/v1/cs/configs?accessToken=eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJuYWNvcyIsImV4cCI6MTc1OTE0OTYzMX0.eXn5bptVa2Es5msmlb82q7KUakxN4HVkwww4dTxGS64&dataId=nacos.cfg.dataId&group=test"
HelloWorld
```

![image-20250929162124562](../../markdown_img/image-20250929162124562.png)

![image-20250929162157922](../../markdown_img/image-20250929162157922.png)





#### Nacos集群部署

**环境准备**

- 三个 Nacos 节点
- 一个 MySQL 服务器
- 两台 haproxy 配置 Keepalived



**下载Nacos**

```bash
[root@ubuntu2204 ~]#apt update && apt install -y openjdk-11-jdk
[root@ubuntu2204 ~]#wget https://github.com/alibaba/nacos/releases/download/2.2.3/nacos-server-2.2.3.tar.gz
[root@ubuntu2204 ~]#scp nacos-server-2.2.3.tar.gz 10.0.0.202:
[root@ubuntu2204 ~]#scp nacos-server-2.2.3.tar.gz 10.0.0.203:

# 三个节点，加压
[root@ubuntu2204 ~]#tar xf nacos-server-2.2.3.tar.gz  -C /usr/local/
```



**部署MySQL做数据源**

```bash
[root@ubuntu2204 ~]#apt update && apt -y install mysql-server 
[root@ubuntu2204 ~]#sed -i '/127.0.0.1/s/^/#/' /etc/mysql/mysql.conf.d/mysqld.cnf
[root@ubuntu2204 ~]#systemctl restart mysql

[root@ubuntu2204 ~]#mysql
Welcome to the MySQL monitor.  Commands end with ; or \g.
Your MySQL connection id is 8
Server version: 8.0.43-0ubuntu0.22.04.2 (Ubuntu)

Copyright (c) 2000, 2025, Oracle and/or its affiliates.
Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.
Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.

mysql> create user nacos@'10.0.0.%' identified with  mysql_native_password by '123456';
Query OK, 0 rows affected (0.00 sec)

mysql> create database nacos;
Query OK, 1 row affected (0.00 sec)

mysql> grant all on nacos.* to nacos@'10.0.0.%' ;
Query OK, 0 rows affected (0.01 sec)

mysql> exit
Bye

[root@ubuntu2204 ~]#apt -y install mysql-client

# 在 10.0.0.202 将mysql-schema.sql

[root@ubuntu2204 ~]#mysql -unacos -p123456 -h10.0.0.204 nacos  < /root/mysql-schema.sql
mysql: [Warning] Using a password on the command line interface can be insecur
```



**配置集群配置文件**

```bash
# 10.0.0.201,10.0.0.202,10.0.0.203 都执行下列命令
[root@ubuntu2204 ~]#mv /usr/local/nacos/conf/cluster.conf.example /usr/local/nacos/conf/cluster.conf
[root@ubuntu2204 ~]#vim /usr/local/nacos/conf/cluster.conf 
10.0.0.201:8848
10.0.0.202:8848
10.0.0.203:8848
```



**修改 Nacos 配置文件 application.properties**

如果使用MySQL数据源，在所有集群节点上需要执行下面操作

```bash
# 10.0.0.201,10.0.0.202,10.0.0.203 都执行下列命令
```

