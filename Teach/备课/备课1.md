# ç¬¬ä¸€å¤©











## å— ä¸ inode



ä¸€å—ç£ç›˜ä¼šè¢«åˆ’åˆ†ä¸ºè®¸å¤šæ‰‡åŒºï¼Œæ¯ä¸ªæ‰‡åŒºæ˜¯æœ€å°çš„å¯å¯»å€è¯»å†™å•å…ƒï¼›



ç¡¬ç›˜åˆ†æˆç›¸åŒå¤§å°çš„å•å…ƒï¼Œæˆ‘ä»¬ç§°ä¸ºå—ã€‚ä¸€å—çš„å¤§å°é€šå¸¸æ˜¯æ‰‡åŒºï¼ˆ512Bï¼‰çš„æ•´æ•°å€ï¼Œé»˜è®¤æ˜¯4Kï¼ˆ8ä¸ªæ‰‡åŒºï¼‰ï¼Œæ–‡ä»¶ç³»ç»Ÿçš„å—ä¸èƒ½å°äºæ‰‡åŒºï¼Œå¦åˆ™ä¼šé€ æˆæ— æ³•ç²¾ç¡®æ˜ å°„



## å—å¤§å°æ˜¯åœ¨æ ¼å¼åŒ–æ—¶è®¾å®šçš„

æ–‡ä»¶ç³»ç»Ÿæ ¼å¼åŒ–æ—¶ï¼Œå¯ä»¥æŒ‡å®šå—å¤§å°

å¦‚ext4:

```bash
mkfs.ext4 -b 4096 /dev/sdX
```

å—è¶Šå¤§ï¼Œ**é¡ºåºè¯»å†™æ•ˆç‡è¶Šé«˜**ï¼Œä½†ä¼šæµªè´¹ç©ºé—´ï¼ˆ**å†…å­˜ç¢ç‰‡**ï¼‰ï¼›

- é€‚åˆå¤§æ–‡ä»¶ â†’ å—å¤§ï¼›
- é€‚åˆå°æ–‡ä»¶ â†’ å—å°ï¼›



## **æ‰‡åŒºå¤§å°æ˜¯ç¡¬ç›˜ç¡¬ä»¶å›ºå®šçš„ï¼Œä¸å¯æ›´æ”¹**

- æ‰‡åŒºå¤§å°ç”±ç¡¬ç›˜å›ºä»¶å†™æ­»ï¼Œç”¨æˆ·æ— æ³•æ›´æ”¹ï¼›
- ä½¿ç”¨å‘½ä»¤å¦‚ `fdisk -l` æˆ– `lsblk -t` å¯ä»¥æŸ¥çœ‹å½“å‰ç¡¬ç›˜æ‰‡åŒºå¤§å°ï¼›
- æœ‰äº› SSD å’Œé«˜çº§ç¡¬ç›˜æ”¯æŒ **çœŸå® 4K æ‰‡åŒºï¼ˆ4096Bï¼‰**ï¼Œæ€§èƒ½æ›´å¥½ã€‚





## æŸ¥çœ‹ç¡¬ç›˜æ‰‡åŒº/å—å¤§å°çš„å‘½ä»¤ï¼ˆLinuxï¼‰

```bash
# æŸ¥çœ‹æ‰‡åŒºå¤§å°
cat /sys/block/sdX/queue/hw_sector_size
cat /sys/block/sdX/queue/logical_block_size

# æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿå—å¤§å°
sudo blockdev --getbsz /dev/sdX
sudo tune2fs -l /dev/sdX1 | grep "Block size"
```

> **é€šå¸¸æƒ…å†µä¸‹ï¼Œæ“ä½œç³»ç»Ÿä¼šè¦æ±‚å†…å­˜é¡µå¤§å°ä¸æ–‡ä»¶ç³»ç»Ÿå—å¤§å°ä¿æŒå¯¹é½å…³ç³»**ï¼Œå³ï¼š
>
> > **å†…å­˜é¡µå¤§å° â‰¥ å—å¤§å°ï¼Œä¸”é€šå¸¸æ˜¯å—å¤§å°çš„æ•´æ•°å€**
> >  ä»¥ç¡®ä¿**é¡µä¸å—ä¹‹é—´å¯ä»¥é«˜æ•ˆæ˜ å°„**ï¼Œé¿å…æµªè´¹æˆ–æ‹†åˆ†ã€‚







# ç¬¬äºŒå¤©







## ä»€ä¹ˆæ˜¯Shell

Shell æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œè§£é‡Šå™¨ï¼Œå®ƒæ˜¯ç”¨æˆ·ä¸æ“ä½œç³»ç»Ÿï¼ˆç‰¹åˆ«æ˜¯å†…æ ¸ï¼‰ä¹‹é—´çš„æ¥å£ï¼Œè´Ÿè´£è§£é‡Šç”¨æˆ·å‘½ä»¤ã€è°ƒåº¦ç¨‹åºæ‰§è¡Œã€æ§åˆ¶è¾“å…¥è¾“å‡ºç­‰ã€‚

Shell æ˜¯æ“ä½œç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯å†…æ ¸ï¼‰å’Œç”¨æˆ·ä¹‹é—´çš„ä¸€ä¸ªå‘½ä»¤è§£é‡Šå™¨/ç¿»è¯‘å·¥å…·ï¼Œä¸»è¦è´Ÿè´£æŠŠäººç±»å¯è¯»çš„å‘½ä»¤ç¿»è¯‘æˆç³»ç»Ÿè°ƒç”¨æˆ–ç¨‹åºæ‰§è¡Œã€‚





## ä¸¾ä¸ªä¾‹å­æ¥è¯´æ˜ï¼š

å½“ä½ åœ¨ç»ˆç«¯ä¸­è¾“å…¥ï¼š

```bash
ls -l /home/user
```

Shell ä¼šåšä»€ä¹ˆï¼Ÿ

1. **è§£æå‘½ä»¤**ï¼šå°†å‘½ä»¤è§£æä¸ºç¨‹åºå `ls` å’Œå‚æ•° `-l /home/user`
2. **æŸ¥æ‰¾å¯æ‰§è¡Œæ–‡ä»¶**ï¼šåœ¨ `$PATH` ä¸­æ‰¾åˆ° `/bin/ls`
3. **è°ƒç”¨ç³»ç»Ÿè°ƒç”¨**ï¼š
   - ä½¿ç”¨ `fork()` åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹
   - åœ¨å­è¿›ç¨‹ä¸­ `exec()` æ‰§è¡Œ `/bin/ls`
4. **ls ç¨‹åºè¿è¡Œæ—¶è®¿é—®å†…æ ¸æä¾›çš„æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯**
5. **å°†è¾“å‡ºæ‰“å°å›ç»ˆç«¯**







## Shell ä¸ç”¨æˆ· & å†…æ ¸çš„äº¤äº’å›¾ï¼š

```css
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ç”¨æˆ·ï¼ˆUserï¼‰        â”‚
â”‚  âŒ¨ é”®ç›˜è¾“å…¥ã€ğŸ‘€ æŸ¥çœ‹è¾“å‡º     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      ç»ˆç«¯ï¼ˆTerminalï¼‰       â”‚
â”‚  å›¾å½¢ç»ˆç«¯/TTY/SSH/PTTY     â”‚
â”‚  æä¾›è¾“å…¥è¾“å‡ºç•Œé¢ï¼ˆ/dev/ttyï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Shellï¼ˆå¦‚ bashï¼‰       â”‚
â”‚ ğŸ§  è§£æå‘½ä»¤ã€è„šæœ¬           â”‚
â”‚ ğŸ“¦ è°ƒç”¨å†…æ ¸ç³»ç»ŸæœåŠ¡         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      å†…æ ¸ï¼ˆKernelï¼‰        â”‚
â”‚ ğŸ§© è¿›ç¨‹è°ƒåº¦ã€æ–‡ä»¶ç³»ç»Ÿã€ç½‘ç»œ â”‚
â”‚ ğŸ› ï¸ æä¾›ç³»ç»Ÿè°ƒç”¨æ¥å£         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¡¬ä»¶èµ„æºï¼ˆç£ç›˜/CPU/ç½‘å¡ç­‰ï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```



## Shell å’Œç»ˆç«¯çš„åŒºåˆ«

å¾ˆå¤šäººä¼šæ··æ·† **Shell** å’Œ **ç»ˆç«¯**ï¼Œå®ƒä»¬æ˜¯**ä¸¤ä¸ªä¸åŒå±‚æ¬¡çš„ç»„ä»¶**ï¼š

| é¡¹ç›® | Shell                            | ç»ˆç«¯ï¼ˆTerminalï¼‰                  |
| ---- | -------------------------------- | --------------------------------- |
| æœ¬è´¨ | å‘½ä»¤è§£é‡Šå™¨ç¨‹åº                   | æä¾›ç”¨æˆ·ä¸è®¡ç®—æœºäº¤äº’çš„ç•Œé¢ï¼ˆTTYï¼‰ |
| ä¸¾ä¾‹ | bash, zsh, fish                  | xterm, gnome-terminal, tty        |
| ä½œç”¨ | è§£é‡Šæ‰§è¡Œç”¨æˆ·è¾“å…¥çš„å‘½ä»¤           | æ¥æ”¶é”®ç›˜è¾“å…¥ & æ˜¾ç¤ºç¨‹åºè¾“å‡º       |
| å±äº | åº”ç”¨å±‚ç¨‹åº                       | æ›´æ¥è¿‘è®¾å¤‡é©±åŠ¨/ç•Œé¢å±‚             |
| åœ°ä½ | **ç”¨æˆ·å’Œå†…æ ¸ä¹‹é—´çš„å‘½ä»¤è§£é‡Šæ¡¥æ¢** | **ç”¨æˆ·å’Œ Shell ä¹‹é—´çš„æ¥å£æ¡¥æ¢**   |





## ç»ˆç«¯çš„ä¸¤ç§ç±»å‹

### â–¶ï¸ ç‰©ç†ç»ˆç«¯ï¼ˆttyï¼‰

- é”®ç›˜ + å±å¹• + tty é©±åŠ¨
- åœ¨ Linux ä¸‹å« `/dev/tty1`, `/dev/tty2` ...

### â–¶ï¸ è™šæ‹Ÿç»ˆç«¯ï¼ˆpseudo terminalï¼ŒPTYï¼‰

- å›¾å½¢ç»ˆç«¯æˆ–è¿œç¨‹ç»ˆç«¯æ¨¡æ‹Ÿå‡ºæ¥çš„ TTYï¼Œå¦‚ï¼š
  - `xterm`, `gnome-terminal`, `ssh`
  - å®é™…è®¾å¤‡ï¼š`/dev/pts/0`, `/dev/pts/1`...





## ä»€ä¹ˆæ˜¯ç»ˆç«¯

**Terminalï¼ˆç»ˆç«¯ï¼‰æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè¿è¡Œåœ¨ç”¨æˆ·æ€çš„åº”ç”¨ç¨‹åº**ï¼Œ
 ä½œç”¨æ˜¯**æä¾›ä¸€ä¸ªå­—ç¬¦è¾“å…¥/è¾“å‡ºç•Œé¢**ï¼Œå¹¶æŠŠç”¨æˆ·è¾“å…¥ä¼ é€’ç»™ Shellï¼ˆä¹Ÿæ˜¯ä¸€ä¸ªç”¨æˆ·æ€ç¨‹åºï¼‰ã€‚





## ä»€ä¹ˆæ˜¯PTYï¼Ÿ

**å®ç° PTY çš„ä»£ç ï¼Œæœ¬è´¨ä¸Šå°±æ˜¯ Linux å†…æ ¸ä¸­å®šä¹‰çš„ä¸€ç»„â€œé©±åŠ¨å‡½æ•°â€**ï¼Œè¿™äº›å‡½æ•°è¿è¡Œåœ¨å†…æ ¸æ€ï¼Œç”¨äºå“åº”ç³»ç»Ÿè°ƒç”¨ï¼Œæ˜¯å†…æ ¸é©±åŠ¨æ¡†æ¶ä¸­çš„æ ¸å¿ƒç»„æˆéƒ¨åˆ†

PTY æ˜¯å†…æ ¸æä¾›çš„ä¸€ç§**å­—ç¬¦è®¾å¤‡æœºåˆ¶**ï¼Œä¸æ˜¯å•ç‹¬çš„â€œå†…æ ¸æ€ç¨‹åºâ€ï¼Œä¹Ÿ**ä¸æ˜¯æŸä¸ªç³»ç»Ÿè°ƒç”¨å‡½æ•°æœ¬èº«**ï¼Œä½†å®ƒç¡®å®ç”±å†…æ ¸è´Ÿè´£ç»´æŠ¤ã€è°ƒåº¦å’Œæä¾›æ¥å£ã€‚

ä¹Ÿå°±æ˜¯è¯´PTYæ˜¯å†…æ ¸å­—ç¬¦è®¾å¤‡

åœ¨ç±» Unix ç³»ç»Ÿä¸­ï¼š

- PTYï¼ˆä¼ªç»ˆç«¯ï¼‰æ¨¡æ‹Ÿä¸€ä¸ªç‰©ç†ç»ˆç«¯è®¾å¤‡ï¼ˆæ¯”å¦‚ä½ æ’çš„ä¸²å£ç»ˆç«¯ï¼‰ï¼Œç”¨äºå®ç°å›¾å½¢ç»ˆç«¯ã€è¿œç¨‹ç»ˆç«¯ç­‰
- PTY ç”±å†…æ ¸ç»´æŠ¤ï¼Œåˆ†ä¸ºä¸¤ç«¯ï¼š

| ç«¯å£               | ä½œç”¨                                           | è¡¨ç°ä¸º                          |
| ------------------ | ---------------------------------------------- | ------------------------------- |
| **Masterï¼ˆä¸»ç«¯ï¼‰** | ç”±ç»ˆç«¯ç¨‹åºæŒæœ‰ï¼Œç”¨äºå‘é€ç”¨æˆ·è¾“å…¥ã€è¯»å–ç¨‹åºè¾“å‡º | `/dev/ptmx`ï¼ˆä¼ªç»ˆç«¯åˆ†é…å™¨ï¼‰     |
| **Slaveï¼ˆä»ç«¯ï¼‰**  | æä¾›ç»™ Shell æˆ–è¿è¡Œç¨‹åºï¼Œæ¨¡æ‹Ÿæ ‡å‡†ç»ˆç«¯æ¥å£      | `/dev/pts/N`ï¼ˆå¦‚ `/dev/pts/0`ï¼‰ |





## æ‰§è¡Œç»ˆç«¯ç¨‹åºåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

æ¯æ‰§è¡Œä¸€æ¬¡ç»ˆç«¯ç¨‹åºï¼ˆå¦‚ `xterm`ã€`ssh`ã€`script`ã€`tmux` ç­‰ï¼‰æ—¶ï¼Œç³»ç»Ÿéƒ½ä¼šä¸ºå…¶åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„ pty master/slave å¯¹ã€‚

å†…æ ¸å°†ï¼š

1. åˆ†é…ä¸€ä¸ªæ–°çš„ **pty master è®¾å¤‡ï¼ˆåŒ¿åï¼‰**
2. è‡ªåŠ¨åˆ›å»ºå¹¶æ³¨å†Œå¯¹åº”çš„ **slave è®¾å¤‡ `/dev/pts/N`**
3. ç»‘å®šè¿™ä¸¤ä¸ªè®¾å¤‡ï¼Œç»´æŠ¤ä¸€ä¸ªå¯¹åº”çš„å…±äº«ç¼“å†²åŒº
4. è¿”å›ä½ æ‹¿åˆ°çš„ **`master_fd` æ˜¯å”¯ä¸€çš„**



## ä½ è¾“å…¥ä¸€è¡Œå‘½ä»¤å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

ä»¥ç”¨æˆ·åœ¨ç»ˆç«¯ï¼ˆæ¯”å¦‚ scriptã€xtermã€sshï¼‰è¾“å…¥å‘½ä»¤ `ls -l` ä¸ºä¾‹ï¼š

0. ç”¨æˆ·åœ¨ç‰©ç†é”®ç›˜ä¸Šè¾“å…¥å­—ç¬¦ï¼›æ“ä½œç³»ç»Ÿçš„è¾“å…¥è®¾å¤‡é©±åŠ¨æ•è·æŒ‰é”®äº‹ä»¶ï¼›å›¾å½¢ç»ˆç«¯ç¨‹åºï¼ˆå¦‚ `xterm` / `gnome-terminal` / `script`ï¼‰è¿è¡Œåœ¨**ç”¨æˆ·æ€**ï¼Œç›‘å¬æŒ‰é”®äº‹ä»¶ï¼›å®ƒæŒæœ‰ master ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ `master_fd`ï¼ˆæ‰“å¼€ `/dev/ptmx` å¾—åˆ°ï¼‰ï¼›å®ƒå°†å­—ç¬¦å†™å…¥ `master_fd` â†’ æ•°æ®é€šè¿‡å†…æ ¸ç¼“å†²åŒºæµå‘ slave

   ```bash
   ç”¨æˆ·åœ¨ç‰©ç†é”®ç›˜ä¸Šè¾“å…¥å­—ç¬¦
   â¬‡
   æ“ä½œç³»ç»Ÿçš„è¾“å…¥è®¾å¤‡é©±åŠ¨æ•è·æŒ‰é”®äº‹ä»¶
   â¬‡
   å›¾å½¢ç»ˆç«¯ç¨‹åºï¼ˆå¦‚ xterm / gnome-terminal / scriptï¼‰è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼Œç›‘å¬æŒ‰é”®äº‹ä»¶
   â¬‡
   å®ƒæŒæœ‰ master ç«¯çš„æ–‡ä»¶æè¿°ç¬¦ master_fdï¼ˆæ‰“å¼€ /dev/ptmx å¾—åˆ°ï¼‰
   â¬‡
   å®ƒå°†å­—ç¬¦å†™å…¥ master_fd â†’ æ•°æ®é€šè¿‡å†…æ ¸ç¼“å†²åŒºæµå‘ slave
   â¬‡
   slave æ˜¯ä¸€ä¸ªä¼ªç»ˆç«¯ï¼ˆ/dev/pts/Nï¼‰ï¼Œshell ç»‘å®šåœ¨ slave ä¸Šï¼Œä»ä¸­è¯»å–æ•°æ®
   â¬‡
   shell æ‰§è¡Œå‘½ä»¤ã€è¾“å‡ºç»“æœå†™å…¥ slave
   â¬‡
   master è¯»å–è¿™äº›ç»“æœ â†’ å›åˆ°ç»ˆç«¯ç¨‹åº â†’ æ˜¾ç¤ºåœ¨å±å¹•ä¸Š
   ```

1. ç”¨æˆ·çš„ **æŒ‰é”®æ•°æ®**ï¼ˆä¾‹å¦‚å­—ç¬¦ `'l'`, `'s'`, `'\n'`ï¼‰æ˜¯é€šè¿‡ **è¾“å…¥è®¾å¤‡é©±åŠ¨**é€å…¥ç”¨æˆ·æ€ç¨‹åºï¼ˆå¦‚ `xterm`ã€`script`ï¼‰

   > **`pty master/slave` å¯¹å…±äº«ä¸€ä¸ªå†…æ ¸ç¼“å†²åŒº** â€”â€” å®ƒä»¬ä¹‹é—´é€šä¿¡çš„æœ¬è´¨æ˜¯ï¼š**master ç«¯å’Œ slave ç«¯ä¹‹é—´é€šè¿‡ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºè¿›è¡Œæ•°æ®äº¤äº’**ï¼Œè¿™ä¸ªç¼“å†²åŒºç”±å†…æ ¸ç®¡ç†ã€‚
   >
   > `pty master`ï¼ˆä¸»ç«¯ï¼‰æ¨¡æ‹Ÿä¸€ä¸ªç»ˆç«¯è®¾å¤‡çš„æ§åˆ¶ç«¯ï¼ˆé€šå¸¸ç”± sshã€tmuxã€xterm ç­‰æ§åˆ¶ç¨‹åºä½¿ç”¨ï¼‰
   >
   > `pty slave`ï¼ˆä»ç«¯ï¼‰æ¨¡æ‹Ÿä¸€ä¸ªå®é™…çš„ç»ˆç«¯è®¾å¤‡ï¼ˆè¢« shell æˆ–ç”¨æˆ·ç¨‹åºæ„ŸçŸ¥ï¼‰
   >
   > 
   >
   > **ç¼“å†²åŒºç»†èŠ‚**
   >
   > - å†…æ ¸ä¸­ä¸ºæ¯ä¸ª `pty` å¯¹åˆ†é…ä¸€ä¸ªç¼“å†²åŒºï¼ˆé€šå¸¸æ˜¯**åŒå‘ç¼“å†²ç¯**ï¼‰
   > - æ•°æ®æµæ–¹å‘ï¼š
   >   - **å†™å…¥ masterï¼Œæ•°æ®å‡ºç°åœ¨ slave çš„è¯»å–ç«¯**ï¼ˆå°±åƒé”®ç›˜è¾“å…¥ï¼‰
   >   - **å†™å…¥ slaveï¼Œæ•°æ®å‡ºç°åœ¨ master çš„è¯»å–ç«¯**ï¼ˆæ¯”å¦‚ shell è¾“å‡ºï¼‰
   >
   > è¿™ä¸ªç¼“å†²åŒºåœ¨ Linux å†…æ ¸é‡Œç”± `tty` å­ç³»ç»Ÿç»Ÿä¸€è°ƒåº¦å’Œç»´æŠ¤ã€‚
   >
   > æƒ…å¢ƒï¼šä½ è¿è¡Œ `script`ï¼Œshell ä½¿ç”¨ä¼ªç»ˆç«¯ slave
   >
   > ```bash
   > script -q /dev/null
   > ```
   >
   > ```text
   > ç”¨æˆ·é”®ç›˜ â”€â–¶ master â”€â–¶ [å†…æ ¸ç¼“å†²] â”€â–¶ slave â”€â–¶ bash
   >                                    â–²         â”‚
   >                                    â”‚         â–¼
   >                                script â—€â”€â”€â”€â”€ slave è¾“å‡ºï¼ˆbashæ‰§è¡Œç»“æœï¼‰
   > ```
   >
   > ```ABAP
   > ç”¨æˆ·è¾“å…¥å‘½ä»¤ç»™masterï¼Œmasterå°†å‘½ä»¤å­˜å‚¨åœ¨å†…æ ¸ç¼“å†²åŒºï¼Œbashä»slaveè¯»å–è¿™ä¸ªå­—ç¬¦ä¸²ï¼Œè§£æå‡ºå‘½ä»¤ï¼Œæ‰¾åˆ°å‘½ä»¤åï¼Œä¸ºè¿™ä¹ˆå‘½ä»¤forkå­è¿›ç¨‹å¹¶æ‰§è¡Œï¼Œç¨‹åºæ‰§è¡Œåå°†è¾“å‡ºç»“æœå‘é€ç»™slaveï¼Œæ•°æ®ä»masterä¸­è¯»å‡ºï¼Œè¾“å‡ºåœ¨å±å¹•ä¸Š
   > ```

2. fork å‡ºä¸€ä¸ªå­è¿›ç¨‹ï¼Œæ‰§è¡Œ `/bin/bash`
3. å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥ã€è¾“å‡ºã€é”™è¯¯ éƒ½æŒ‡å‘ `/dev/pts/0`ï¼ˆä¹Ÿå°±æ˜¯ pty slaveï¼‰
4. ç”¨æˆ·åœ¨ç»ˆç«¯ä¸­é”®å…¥ `ls -l`
   - ç»ˆç«¯ç¨‹åºå°†å­—ç¬¦å†™å…¥ **pty master**
   - å†…æ ¸å°†è¿™äº›å­—ç¬¦ç¼“å†²åœ¨ **pty slave çš„è¯»ç¼“å†²åŒº**
5. Shell ä» pty slave ä¸­è¯»å–è¿™è¡Œå‘½ä»¤ï¼Œè§£é‡Šæ‰§è¡Œ
6. è¾“å‡ºé€šè¿‡ stdout å†™å…¥ pty slave â†’ å†…æ ¸è½¬å‘ç»™ pty master â†’ ç»ˆç«¯ç¨‹åºè¯»å–åæ˜¾ç¤º





## é©±åŠ¨å‡½æ•°æ˜¯ä»€ä¹ˆ

æ‰€è°“é©±åŠ¨å‡½æ•°ï¼Œå®é™…æ˜¯å†…æ ¸ä¸­çš„ä¸€ç»„å›è°ƒå‡½æ•°ï¼Œå®ƒä»¬é€šè¿‡ç»“æ„ä½“ `file_operations` æ³¨å†Œç»™ VFSï¼ˆè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼‰

```C
static const struct file_operations ptmx_fops = {
    .open = ptmx_open,
    .read = tty_read,
    .write = tty_write,
    .ioctl = tty_ioctl,
    ...
};
```

å½“ç”¨æˆ·æ€ç¨‹åºè°ƒç”¨ `open("/dev/ptmx")`ï¼š

- ç³»ç»Ÿè°ƒç”¨è¿›å…¥å†…æ ¸
- å†…æ ¸æ ¹æ®è®¾å¤‡èŠ‚ç‚¹æŸ¥æ‰¾åˆ°å¯¹åº”çš„ `file_operations`
- ç„¶åè°ƒç”¨ `.open = ptmx_open` è¿™ä¸ªå†…æ ¸å‡½æ•°ï¼ˆé©±åŠ¨å‡½æ•°ï¼‰



**é©±åŠ¨å‡½æ•°çš„â€œç”Ÿå‘½å‘¨æœŸâ€ï¼š**

| äº‹ä»¶            | ç”¨æˆ·æ€è°ƒç”¨                   | è¿›å…¥å†…æ ¸åå®é™…è°ƒç”¨çš„é©±åŠ¨å‡½æ•° |
| --------------- | ---------------------------- | ---------------------------- |
| æ‰“å¼€ PTY master | `open("/dev/ptmx")`          | `ptmx_open()`                |
| è¯»æ•°æ®          | `read(fd, ...)`              | `tty_read()`                 |
| å†™æ•°æ®          | `write(fd, ...)`             | `tty_write()`                |
| è®¾ç½®ç»ˆç«¯å±æ€§    | `ioctl(fd, TIOCSWINSZ, ...)` | `tty_ioctl()`                |



`ptmx_open()` é©±åŠ¨å‡½æ•°åŸå‹

```C
static int ptmx_open(struct inode *inode, struct file *filp) {
    return tty_open(inode, filp);
}
```

è¿™ä¸ªå‡½æ•°æ˜¯ `/dev/ptmx` è®¾å¤‡çš„ open handler

æ˜¯ç³»ç»Ÿè°ƒç”¨ `open()` æœ€ç»ˆè°ƒç”¨åˆ°çš„å‡½æ•°



**é©±åŠ¨å‡½æ•°æ˜¯é¢å‘â€œè®¾å¤‡æ“ä½œâ€çš„æœ€åº•å±‚å†…æ ¸å‡½æ•°æ¥å£ä¹‹ä¸€ï¼Œå®ƒæ˜¯ç³»ç»Ÿè°ƒç”¨é€šå¾€ç¡¬ä»¶ï¼ˆæˆ–è™šæ‹Ÿè®¾å¤‡ï¼‰çš„å…³é”®æ¡¥æ¢ã€‚**



## åˆ†å±‚ç†è§£ Linux è®¾å¤‡é©±åŠ¨ç»“æ„ï¼š

```css
   ç”¨æˆ·æ€åº”ç”¨ç¨‹åº
        â”‚
    ç³»ç»Ÿè°ƒç”¨ (open, read, write, ioctl, ...)
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼ˆVFSï¼‰ â”‚   â† ç»Ÿä¸€ç®¡ç†æ‰€æœ‰è®¾å¤‡çš„è®¿é—®
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
   file_operations
        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ é©±åŠ¨å‡½æ•°ï¼ˆé©±åŠ¨ç¨‹åºï¼‰ â”‚ â† ä½ æåˆ°çš„â€œé©±åŠ¨å‡½æ•°â€å°±å¤„äºè¿™ä¸€å±‚
â”‚  å¦‚ .open, .read      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
  è®¾å¤‡æ§åˆ¶å±‚ï¼ˆä¾‹å¦‚ï¼šä¸²å£æ§åˆ¶ã€I2Cæ§åˆ¶ã€TTYæ ¸å¿ƒå±‚ï¼‰
        â”‚
  ç¡¬ä»¶æŠ½è±¡æ¥å£ï¼ˆI/O æ˜ å°„ã€MMIOã€ç«¯å£IOï¼‰
        â”‚
  ç¡¬ä»¶å¯„å­˜å™¨ã€ä¸­æ–­çº¿ã€DMA æ§åˆ¶å™¨ç­‰
```







ä»**çº¯ç²¹çš„ä»£ç å®ç°è§’åº¦æ¥çœ‹ Linux æ“ä½œç³»ç»Ÿçš„æ•´ä½“ç»“æ„**

| ä½ æåˆ°çš„å±‚ | æ˜¯å¦å‡†ç¡® | è¡¥å……è¯´æ˜                                                     | è¯­è¨€å®ç° |
| ---------- | -------- | ------------------------------------------------------------ | -------- |
| ç”¨æˆ·æ€ç¨‹åº | âœ…        | å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œè§¦å‘ä¸Šä¸‹æ–‡åˆ‡æ¢                                 | é«˜çº§è¯­è¨€ |
| ç³»ç»Ÿè°ƒç”¨   | âœ…        | æ˜¯ç”¨æˆ·æ€è®¿é—®å†…æ ¸æ€çš„å”¯ä¸€å…¥å£                                 | C        |
| æŠ½è±¡å±‚     | âœ…        | VFSã€ç½‘ç»œåè®®æ ˆã€è¿›ç¨‹è°ƒåº¦å™¨ã€å†…å­˜ç®¡ç†ã€IPCå­ç³»ç»Ÿï¼ˆç®¡é“ï¼Œä¿¡å·ï¼Œå…±äº«å†…å­˜ï¼‰ç­‰ | C        |
| é©±åŠ¨å±‚     | âœ…        | å®ç°ç¡¬ä»¶æ§åˆ¶é€»è¾‘ã€æ³¨å†Œæ¥å£ï¼Œå¦‚å­—ç¬¦è®¾å¤‡é©±åŠ¨ï¼ˆ`/dev/ttyS0`, `/dev/input/mouse0`ï¼‰å—è®¾åˆ«é©±åŠ¨ï¼ˆNVMeã€SATAã€MMCï¼‰ï¼Œç½‘ç»œè®¾å¤‡é©±åŠ¨ï¼ˆe1000e, r8169ï¼‰ï¼Œæ˜¾å¡é©±åŠ¨ï¼ˆi915, amdgpuï¼‰ | C        |
| åº•å±‚æ§åˆ¶å±‚ | âœ…        | é©±åŠ¨å†…éƒ¨ç›´æ¥æ“ä½œç¡¬ä»¶çš„ä»£ç ï¼šå¯¹å¯„å­˜å™¨è¯»å†™ã€DMAã€ä¸­æ–­å“åº”ç­‰ã€‚  | C/æ±‡ç¼–   |
| ç‰©ç†å±‚     | âœ…        | çœŸæ­£çš„ç¡¬ä»¶è®¾å¤‡ï¼Œä¸å±äºä»£ç èŒƒç•´ï¼Œä½†æ˜¯æ“ä½œç›®æ ‡                 | N/A      |





**ä»Linuxå®˜æ–¹æ¨¡å—ç»„ç»‡è§†è§’**









## Linuxç™»å½•

Linuxç™»å½•æµç¨‹ï¼š`/etc/login.defs`ã€`PAM`æ¨¡å—ã€`getty` å’Œ `login`







# ç¬¬ä¸‰å¤©





![image-20250611113334930](D:\git_repository\cyber_security_learning\markdown_img\image-20250611113334930.png)



## ç½‘ç»œ

ä»€ä¹ˆæ˜¯äº’è”ç½‘ï¼Œå®ƒçš„ç»„æˆæ˜¯ä»€ä¹ˆ

ç½‘ç»œä¸­æ”¯æ’‘ç½‘ç»œå·¥ä½œçš„éå¸¸é‡è¦çš„ä¸œè¥¿å«åè®® protocolï¼Œä»€ä¹ˆæ˜¯åè®®

ç½‘ç»œåˆ†ä¸º3ä¸ªéƒ¨åˆ†ï¼Œè¾¹ä¸Šï¼ˆedgeï¼‰ï¼Œä¸­é—´ï¼ˆcoreæ ¸å¿ƒï¼‰å’ŒæŠŠè¾¹ä¸Šå’Œä¸­é—´æ¥åœ¨ä¸€èµ·çš„æ¥å…¥ç½‘ï¼ˆaccessï¼‰ï¼Œ

3ä¸ªéƒ¨é—¨çš„ç»„æˆï¼Œä½œç”¨å’ŒåŸºæœ¬åŸç†

ç½‘ç»œçš„è¾¹ç¼˜ï¼Œå°†è¾¹ç¼˜æ¥å…¥æ ¸å¿ƒçš„æ¥å…¥ç½‘ä»¥åŠæ”¯æ’‘æ¥å…¥ç½‘çš„mediaåª’ä»‹ï¼Œæ ¸å¿ƒï¼Œæ ¸å¿ƒçš„å·¥ä½œæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ä¸ªæ˜¯çº¿è·¯äº¤æ¢ï¼Œä¸€ä¸ªæ˜¯åˆ†ç»„äº¤æ¢

ä»€ä¹ˆæ˜¯çº¿è·¯äº¤æ¢

ä»€ä¹ˆæ˜¯åˆ†ç»„äº¤æ¢


å®é™…ä¸Šäº’è”ç½‘æ˜¯ä¸€å †ç½‘ç»œæ„æˆçš„ï¼Œä»–ä¸æ˜¯ä¸€ä¸ªå¹³é¢ï¼Œä¸€ä¸ªç½‘ç»œï¼Œå®ƒæ˜¯ç”±ä¸€å †ç½‘ç»œé€šè¿‡ç½‘ç»œäº’è”è®¾å¤‡ï¼ˆè·¯ç”±å™¨ï¼‰è¿åœ¨ä¸€èµ·çš„ç½‘ç»œçš„ç½‘ç»œï¼Œæˆ‘ä»¬å«äº’è”ç½‘

ä¸åŒçš„ç½‘ï¼Œå¤„åœ¨æ•´ä¸ªäº’è”ç½‘çš„å±‚æ¬¡ä¹Ÿä¸ä¸€æ ·ï¼Œæœ‰çš„æ˜¯level1ï¼Œæœ‰çš„Level2ï¼ŒLevel3...,



### ç½‘ç»œ

ç½‘ç»œçš„å±‚æ¬¡ç»“æ„


ä¹‹åæˆ‘ä»¬ä»‹ç»ï¼Œç½‘ç»œé‚£ä¹ˆå¤æ‚ï¼Œä¸æ˜¯ä¸€ä¸ªå¹³é¢å°±èƒ½å¤Ÿè§£å†³çš„ï¼Œå®ƒæ˜¯ä¸€å±‚ä¸€å±‚è§£å†³çš„ï¼Œæ¯ä¸€å±‚å®ç°ä¸€ç»„ç‰¹å®šçš„åŠŸèƒ½ï¼Œä¸Šä¸€å±‚åˆå€ŸåŠ©ä¸‹ä¸€æ¬¡æä¾›çš„æœåŠ¡ï¼Œé€šè¿‡å’Œå¯¹ç­‰å±‚çš„åè®®å®ä½“ç›¸äº’äº¤æ¢åè®®çš„æŠ¥æ–‡æ¥å®ç°çš„ï¼Œå®ç°çš„ç›®çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä¸ºäº†å‘ä¸Šå±‚æä¾›æ›´å¥½çš„æœåŠ¡ï¼Œç„¶åä¸€å±‚è½ä¸€å±‚ï¼Œä¸€å±‚è½ä¸€å±‚ï¼Œæœ€åè½åˆ°äº†ä¼ è¾“å±‚

åº”ç”¨å±‚æ˜¯å€ŸåŠ©ä¼ è¾“å±‚æä¾›çš„æœåŠ¡ï¼Œäº¤æ¢åº”ç”¨æŠ¥æ–‡ï¼Œå®ç°å„ç§å„æ ·çš„ç½‘ç»œåº”ç”¨ï¼Œæ•´ä¸ªå·¥ä½œçš„è¿‡ç¨‹å¤§è‡´å°±æ˜¯è¿™æ ·çš„è¿‡ç¨‹

å±‚æ¬¡æ€§çš„åŸç†æ˜¯éå¸¸é‡è¦çš„ç†è§£è®¡ç®—æœºç½‘ç»œå·¥ä½œçš„æ ¸å¿ƒæ€æƒ³ï¼Œå¸Œæœ›å¤§å®¶èƒ½å¤ŸæŠŠæ¡




1. ä»€ä¹ˆæ˜¯ç½‘ç»œ -> è®¡ç®—æœºç½‘ç»œ -> äº’è”ç½‘

ä¸¾å‡ ä¸ªç½‘ç»œçš„ä¾‹å­ï¼šç”µè¯ç½‘ï¼Œèœ˜è››ç½‘ï¼Œèœ˜è››ç½‘ä¹Ÿæ˜¯ç½‘ç»œï¼Œæ‰€ä»¥ç½‘ç»œæœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿï¼ŒèŠ‚ç‚¹å’Œè¾¹æ˜¯å§ï¼Œ

 ![image-20250611095517824](D:\git_repository\cyber_security_learning\markdown_img\image-20250611095517824.png) è¿™ä¸¤ä¸ªç½‘ç»œæ˜¯ä¸æ˜¯ä¸€ç§ç½‘ç»œï¼Œæ‰€ä»¥ç½‘ç»œæ˜¯ç½‘ç»œå°±æ˜¯å’Œå¤§å°æ— å…³çš„ï¼ŒèŠ‚ç‚¹å’Œè¾¹çš„å…³ç³»ï¼Œå’Œå½¢çŠ¶æ— å…³ï¼Œå¦‚è¿™ä¸ªå›¾é‡Œçš„èŠ‚ç‚¹ï¼Œå¯ä»¥æ˜¯ä¸ªäººï¼Œé‚£è¿™ä¸ªè¾¹å¯èƒ½å°±æ˜¯ä»–ä»¬çš„æœ‹å‹å…³ç³»ï¼Œè¿™ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªèœ˜è››ç½‘çš„å‡ ç‚¹åˆ°å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸­é—´æ˜¯èœ˜è››çº¿ï¼Œè¿™ä¹Ÿæ˜¯ç½‘ç»œï¼Œåˆæˆ–è€…ç¥ç»å…ƒå³å®ƒçš„æ ‘çªç­‰ï¼Œä¹Ÿæ˜¯ç½‘ç»œ

 å†æ‹‰å›åˆ°èœ˜è››ç½‘ï¼Œèœ˜è››ç½‘å°±æ˜¯ä¸å¤§å°ï¼Œå½¢çŠ¶æ— å…³çš„ç½‘ç»œçš„æ‹“æ‰‘ï¼Œè¿™å«ç½‘ç»œã€‚é‚£ä»€ä¹ˆæ˜¯è®¡ç®—æœºç½‘ç»œ



### è®¡ç®—æœºç½‘ç»œ

è®¡ç®—æœºç½‘ç»œï¼šè®¡ç®—æœºç½‘ç»œæ˜¯è”ç½‘çš„è®¡ç®—æœºï¼Œæ‰€æ„æˆçš„ç³»ç»Ÿã€‚æˆ‘ä»¬éƒ½çŸ¥é“ç½‘ç»œæœ‰èŠ‚ç‚¹å’Œçº¿æ„æˆï¼Œé‚£ä¹ˆè®¡ç®—æœºç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹éƒ½æ˜¯ä»€ä¹ˆï¼Ÿ

åŒ…æ‹¬

- **ä¸»æœºèŠ‚ç‚¹**ï¼Œæ¯”å¦‚ï¼šç¬”è®°æœ¬ï¼Œæ‰‹æœºï¼Œipadï¼Œè”ç½‘çš„å†°ç®±ï¼Œæœºé¡¶ç›’ç­‰ç­‰ï¼Œå®ƒæ˜¯æ•°æ®çš„æºï¼Œä¹Ÿæ˜¯æ•°æ®çš„ç›®æ ‡

æ¯”å¦‚å®ƒæ˜¯ä¸€ä¸ªwebæœåŠ¡å™¨ï¼Œç®—ä¸ç®—ä¸€ä¸ªä¸»æœºèŠ‚ç‚¹ï¼Œä¹Ÿç®—ä¸€ä¸ªèŠ‚ç‚¹ã€‚



- å¦å¤–ä¸€ç§æ˜¯**æ•°æ®äº¤æ¢èŠ‚ç‚¹**ï¼Œæ¯”å¦‚äº¤æ¢æœºï¼Œè·¯ç”±å™¨ï¼Œå®ƒå³ä¸æ˜¯æ•°æ®çš„æºï¼Œä¹Ÿä¸æ˜¯æ•°æ®çš„ç›®æ ‡ï¼Œæ¥ä¸€ä¸ªåˆ†ç»„ä»ä¸€ä¸ªç«¯å£è¿›æ¥ï¼ŒæŒ‰ç…§ä¸€å®šçš„å·¥ä½œæ–¹å¼ï¼Œå¦‚æœæ˜¯**äº¤æ¢æœº**çš„è¯å°±æ˜¯æŒ‰ç…§ç›®æ ‡macåœ°å€ï¼Œå†³å®šä»æŸä¸ªæ–¹å‘è½¬ï¼Œå¦‚æœæ˜¯ä¸€ä¸ª**è·¯ç”±å™¨**çš„è¯ï¼Œæ¥ä¸€ä¸ªåˆ†ç»„ï¼Œä»ä¸€ä¸ªç«¯å£é€šè¿‡ç½‘å¡æ”¶è¿›æ¥ï¼Œæ”¶è¿›æ¥ä¹‹åï¼Œé€šè¿‡æŸ¥è·¯ç”±è¡¨ï¼Œå†³å®šä»å¦ä¸€ä¸ªæ–¹å‘æ”¾å‡ºå»ï¼Œå®ƒæ˜¯è½¬å‘æ•°æ®çš„ï¼Œå®ƒæ—¢ä¸æ˜¯æºï¼Œä¹Ÿä¸æ˜¯ç›®æ ‡ã€‚
  - åˆšæ‰æˆ‘ä»¬ä»‹ç»äº†è·¯ç”±å™¨å’Œäº¤æ¢æœºï¼Œæœ‰ä¸¤ä¸ªæœ¯è¯­äº†ï¼Œä»–åªæ˜¯å±‚æ¬¡ä¸åŒï¼Œä½œç”¨ä¸åŒï¼Œè·¯ç”±å™¨æ˜¯å·¥ä½œåœ¨ç½‘ç»œå±‚ï¼Œäº¤æ¢æœºå·¥ä½œåœ¨é“¾è·¯å±‚ï¼Œå½“ç„¶è¿˜æœ‰æ›´é«˜å±‚çš„ç½‘ç»œäº¤æ¢è®¾åˆ«ï¼Œæ¯”å¦‚è¿˜æœ‰ç¬¬4å±‚ï¼Œç¬¬5å±‚çš„è´Ÿè½½å‡è¡¡è®¾å¤‡ç­‰ç­‰ï¼Œè¿™äº›è®¾å¤‡æœ‰ä»€ä¹ˆç‰¹ç‚¹ï¼Ÿå®ƒä¹Ÿæ˜¯èŠ‚ç‚¹ï¼Œä½†æ˜¯å®ƒæ—¢ä¸æ˜¯æ•°æ®çš„æºï¼Œä¹Ÿä¸æ˜¯æ•°æ®çš„ç›®æ ‡ï¼Œå®ƒæ˜¯æ•°æ®çš„ä¸­è½¬èŠ‚ç‚¹ã€‚æ”¶åˆ°æ•°æ®åå°†å®ƒè½¬èµ°ï¼Œåˆ°ä¸‹ä¸€èŠ‚ç‚¹åï¼Œæ”¶åˆ°ä¹‹åè½¬èµ°ï¼Œé€šè¿‡è¿™äº›ä¸­è½¬èŠ‚ç‚¹çš„ç›¸äº’é…åˆï¼Œæœ€ç»ˆå®ç°ä»æºèŠ‚ç‚¹åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚



æ‰€ä»¥å®ƒæœ‰ä¸¤ç§ç±»å‹çš„èŠ‚ç‚¹ï¼Œç”»æ–¹çš„æ˜¯ä¸»æœºèŠ‚ç‚¹ï¼Œç”»å›­çš„æ˜¯æ•°æ®äº¤æ¢èŠ‚ç‚¹ã€‚æ•°æ®äº¤æ¢èŠ‚ç‚¹æ ¹æ®å®ƒå·¥ä½œçš„å±‚æ¬¡ä¸åŒï¼Œå¯ä»¥åˆ†ä¸ºï¼Œä¸­ç»§å™¨ï¼Œäº¤æ¢æœºï¼ˆäºŒå±‚ï¼‰ï¼Œè·¯ç”±å™¨ï¼ˆä¸‰å±‚ï¼‰ï¼Œè¿˜æœ‰ä¸€äº›è´Ÿè½½å‡è¡¡è®¾å¤‡ï¼Œæ›´é«˜å±‚ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯ä»ä¸€ä¸ªåœ°æ–¹è¿›ï¼Œä»ä¸¤ä¸€ä¸ªåœ°æ–¹å‡ºï¼Œé€šè¿‡è¿™äº›ä¸­è½¬èŠ‚ç‚¹çš„ç›¸äº’é…åˆï¼Œä»è€Œå®ç°æ•°æ®ä»æºä¸»æœºåˆ°ç›®æ ‡ä¸»æœºã€‚



æŠŠèŠ‚ç‚¹è¿åœ¨ä¸€èµ·çš„æ˜¯ä»€ä¹ˆï¼Ÿå«é“¾è·¯ã€‚æŠŠä¸»æœºè·Ÿäº¤æ¢èŠ‚ç‚¹è¿åœ¨ä¸€èµ·ï¼ŒæŠŠäº¤æ¢èŠ‚ç‚¹å’Œäº¤æ¢èŠ‚ç‚¹è¿åœ¨ä¸€èµ·ï¼Œæœ€åæ„æˆä¸€ä¸ªç½‘ï¼Œç„¶åä¹‹é—´æ‰èƒ½å¤Ÿç›¸äº’é€šä¿¡ï¼Œè¿™ä¸ªå«é“¾è·¯ï¼Œå°±æ˜¯è¾¹



æ‰€ä»¥è¯´ï¼Œè¿ç½‘çš„è®¡ç®—æœºç³»ç»Ÿï¼Œç”±èŠ‚ç‚¹å’Œè¾¹æ„æˆçš„è¿™æ ·ä¸€ä¸ªç³»ç»Ÿï¼Œæˆ‘ä»¬æŠŠå®ƒå«åšè®¡ç®—æœºç½‘ç»œ



è¾¹å‘¢ä¹Ÿåˆ†ä¸ºä¸¤ç±»

- ç¬¬ä¸€ç±»ï¼šæˆ‘çš„ä¸»æœºé€šè¿‡ä»¥å¤ªç½‘çš„ç½‘çº¿ï¼Œæ¥åˆ°æœ€è¿‘çš„ä¸€ä¸ªäº¤æ¢æœºï¼Œæ‰€ä»¥å«æ¥å…¥ç½‘ï¼Œæ¥å…¥çš„é“¾è·¯(link)
- ç¬¬äºŒç±»ï¼šè·¯ç”±å™¨å’Œè·¯ç”±å™¨ï¼Œè·¯ç”±å™¨å’Œäº¤æ¢æœºï¼Œäº¤æ¢æœºå’Œäº¤æ¢æœºï¼Œä¹Ÿå°±æ˜¯äº¤æ¢èŠ‚ç‚¹ä¹‹é—´çš„éª¨å¹²é“¾è·¯



æ€»ç»“èµ·æ¥å°±æ˜¯æ–¹çš„å’Œå›­çš„è¿åœ¨ä¸€èµ·çš„ï¼Œä¸»è¦å’Œä¸»æœºç›¸å…³ï¼Œå®ƒå°±æ˜¯æ¥å…¥é“¾è·¯ï¼Œå¦‚æœä¸¤ä¸ªåœ†çš„æ¥åœ¨ä¸€èµ·ï¼Œå°±æ˜¯éª¨å¹²é“¾è·¯ï¼Œå› æ­¤æ€»çš„åˆ†ä¸ºæ¥å…¥é“¾è·¯ï¼ˆaccessï¼‰å’Œéª¨å¹²é“¾è·¯(backbone)



è®¡ç®—æœºç½‘ç»œï¼Œä»æ„æˆçš„è§’åº¦ï¼šèŠ‚ç‚¹å’Œè¾¹

èŠ‚ç‚¹åŒ…æ‹¬ä¸»æœºå’Œäº¤æ¢èŠ‚ç‚¹ï¼Œæ•°æ®äº¤æ¢èŠ‚ç‚¹å·¥ä½œçš„å±‚æ¬¡ä¸åŒæœ‰åˆ†ä¸ºäº¤æ¢æœºï¼Œè·¯ç”±å™¨ï¼Œä¸€äº›é«˜å±‚çš„è´Ÿè½½å‡è¡¡è®¾å¤‡ç­‰ç­‰

 

é“¾è·¯çš„æŒ‰ç…§å®ƒè¿æ¥çš„ä¸»æœºå’Œè·¯ç”±å™¨ï¼Œè¿˜æ˜¯äº¤æ¢èŠ‚ç‚¹ä¹‹é—´é“¾è·¯å¯ä»¥åˆ†ä¸ºaccesså’Œbackboneï¼Œå°±æ¥å…¥é“¾è·¯å’Œéª¨å¹²é“¾è·¯









#### åè®®

å½“ç„¶é™¤äº†äº’è”ç½‘æ„æˆçš„è¿™æ ·ä¸€äº›é›¶ä»¶çš„ç»„æˆï¼ŒèŠ‚ç‚¹å’Œè¾¹ä¹‹å¤–çš„ï¼Œè¿˜æœ‰å¦å¤–ä¸€äº›æ„æˆï¼Œä¸€äº›è½¯çš„ï¼Œæ¯”å¦‚åè®®ã€‚åè®®æŒ‡çš„æ˜¯æ”¯æ’‘äº’è”ç½‘å·¥ä½œçš„æ ‡å‡†ã€‚å„ä¸ªå‚å•†æŒ‰ç…§æ ‡å‡†å’Œåè®®æ¥åˆ¶ä½œå®ƒçš„ç½‘ç»œè®¾å¤‡ï¼Œè¿™äº›ä¸åŒçš„ç½‘ç»œè®¾å¤‡ä¹‹é—´ï¼Œå°±å¯ä»¥å½¢æˆäº’æ“ä½œï¼Œå«inter-operativeã€‚å°±æ˜¯æˆ‘è¿™ä¸ªç½‘å¡å’Œä½ è¿™ä¸ªç½‘å¡ï¼Œè™½ç„¶æ¥è‡ªä¸åŒçš„å‚å•†ï¼Œä½†åªè¦æŒ‰ç…§åŒæ ·çš„æ ‡å‡†ï¼Œå°±å¯ä»¥å·¥ä½œã€‚å½“ç„¶ï¼Œåè®®æŒ‰ç…§å®ƒçš„å±‚æ¬¡ä¸åŒåˆå¯ä»¥åˆ†ä¸ºç‰©ç†å±‚åè®®ï¼Œé“¾è·¯å±‚åè®®ï¼Œç½‘ç»œå±‚åè®®ï¼Œä¼ è¾“å±‚åè®®ï¼Œåº”ç”¨å±‚åè®®ï¼Œè€Œæ¯å±‚åè®®åˆåˆ†ä¸ºè‹¥å¹²ç§ï¼Œæ¯”å¦‚ä¼ è¾“å±‚çš„TCPï¼ŒUDP.ç½‘ç»œå±‚æœ‰IPè¿˜æœ‰ä¸€äº›è·¯ç”±é€‰æ‹©åè®®ã€‚è¿™äº›éƒ½æ˜¯åè®®ï¼Œä¹Ÿå°±æ˜¯æ ‡å‡†



åè®®çš„å®šä¹‰ï¼šå¯¹ç­‰å±‚å®ä½“åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œåº”è¯¥éµå¾ªçš„è§„åˆ™çš„é›†åˆï¼ŒåŒ…æ‹¬è¯­æ³•ï¼Œè¯­ä¹‰å’Œæ—¶åºã€‚å½“ç„¶å’±ä»¬ä¸å¤ªé€‚åˆè¿™ä¹ˆè®²ï¼Œæ€•ä½ ä»¬æƒŠæ…Œè¯•é”™ï¼Œè½è’è€Œé€ƒã€‚

å¬ç€å¥½åƒå¾ˆå¤æ‚ï¼Œä½†æ˜¯å¬åç»­å’±ä»¬å¨“å¨“é“æ¥ï¼Œå…¶å®ä¹Ÿæ²¡é‚£ä¹ˆå¤æ‚



è®¡ç®—æœºç½‘ç»œè®²æ¸…æ¥šäº†ï¼Œé‚£äº’è”ç½‘æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ



### äº’è”ç½‘

äº’è”ç½‘æ˜¯ä»¥TCPåè®®å’ŒIPåè®®ä¸ºä¸»çš„ä¸€ç°‡åè®®ã€‚å°±åè®®æ—ï¼Œåè®®å¥—ï¼Œæœ‰è¿™äº›åè®®æ„æˆçš„é‚£ä¸ªç½‘ç»œï¼Œå°±æˆ‘ä»¬ç›®å‰åœ¨ç”¨çš„ï¼Œè§„æ¨¡æœ€å¤§çš„ç½‘ç»œå°±å«äº’è”ç½‘ï¼ˆinternetï¼‰ã€‚





å½“ç„¶ä½ è¯´æˆ‘ä¹ŸæŒ‰è¿™ä¸ªæ–¹å¼å·¥ä½œï¼Œä¹Ÿæ˜¯ä»¥TCPå’ŒIPåè®®æ—ä¸ºä¸»çš„ï¼Œä½†æ˜¯æˆ‘å’Œåˆ«äººä¸è¿ï¼Œæˆ‘å‚é‡Œè‡ªå·±ç”¨ï¼Œä¹Ÿè¡Œï¼Œã€‚è¿™ä¸ªä¸å«Internetï¼Œè¿™ä¸ªå«intronetï¼Œå«ä¼ä¸šç½‘ï¼Œä¹Ÿå«å†…éƒ¨ç½‘





ä»æ„æˆçš„è§’åº¦æ¥çœ‹ï¼Œè®¡ç®—æœºç½‘ç»œï¼Œäº’è”ç½‘ï¼Œäº’è”ç½‘å½“ç„¶ä¹Ÿæ˜¯è®¡ç®—æœºç½‘ç»œä¸­çš„ä¸€ç§ï¼Œäº’è”ç½‘æœ‰å“ªäº›ç«¯èŠ‚ç‚¹ï¼ŒPCï¼Œä¸»æœºï¼Œserverï¼Œæ‰‹æœºï¼Œipadç­‰ç­‰...ä»¥åŠä¸€äº›æœ‰è¶£çš„ç«¯ç³»ç»Ÿï¼Œèµ‹äºˆåäº¿è®¡çš„ç«¯ç³»ç»Ÿã€‚



é‚£ä¹ˆç«¯ç³»ç»ŸåŒ…æ‹¬ä»€ä¹ˆå‘¢ï¼Ÿè®¡ç®—æœºæœ¬èº«â€”ç¡¬ä»¶ï¼Œèƒ½å¤ŸæŠŠç¡¬ä»¶ç®¡ç†èµ·æ¥çš„æ“ä½œç³»ç»Ÿï¼Œè¿™ä¸ªæ“ä½œç³»ç»Ÿè¦æ”¯æŒé€šè®¯å§ï¼›ç„¶ååœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šé©»ç•™çš„æµè§ˆå™¨ï¼ŒwebæœåŠ¡å™¨ï¼Œä¸Šé¢çš„ä¸€äº›appç­‰ç½‘ç»œåº”ç”¨ç¨‹åºã€‚



æ‰€ä»¥æ•´ä¸ªç«¯ç³»ç»Ÿåˆ†ä¸ºï¼Œç¡¬ä»¶æœ¬èº«ï¼Œæ”¯æŒç½‘ç»œé€šè®¯çš„æ“ä½œç³»ç»Ÿï¼Œä»¥åŠåŸºäºæ“ä½œç³»ç»Ÿï¼Œåœ¨æ“ä½œç³»ç»Ÿä¸Šè¿è¡Œçš„å„ç§ç½‘ç»œåº”ç”¨ç¨‹åºï¼›è¿™äº›æ„æˆäº†ç«¯ç³»ç»Ÿ,è¿™ä¸ªç«¯ç³»ç»Ÿæˆ‘ä»¬é€šå¸¸ç§°ä½œ`end System` æˆ–è€… `host`







è¾¹ç¼˜ï¼šè¾¹ç¼˜ç³»ç»Ÿä¸Šé¢çš„åº”ç”¨æ˜¯ç½‘ç»œå­˜åœ¨çš„ç†ç”±ï¼Œä¸‹é¢çš„è®¾å¤‡æ˜¯æ”¯æ’‘ç½‘ç»œé€šè®¯çš„åè®®æ ˆ

æ¥å…¥ï¼šå°†è¾¹ç¼˜çš„ä¸»æœºç³»ç»Ÿæ¥å…¥åˆ°ç½‘ç»œæ ¸å¿ƒ

æ ¸å¿ƒï¼šæŠŠæ‰€æœ‰çš„è¾¹ç¼˜èŠ‚ç‚¹æ¥åœ¨ä¸€èµ·ï¼Œä»è€Œè®©ä»»æ„ä¸¤ä¸ªç«¯ç³»ç»Ÿä¹‹é—´èƒ½å¤Ÿç›¸äº’é€šä¿¡ï¼Œæ‰€ä»¥ç½‘ç»œæ ¸å¿ƒçš„ä½œç”¨å°±æ˜¯æ•°æ®äº¤æ¢



#### ç½‘ç»œè¾¹ç¼˜

åº”ç”¨è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡æ¨¡å¼

- CSæ¨¡å¼
- P2Pæ¨¡å¼
  

ä¸ç®¡æ˜¯CSæ¨¡å¼ï¼Œè¿˜æ˜¯P2Pæ¨¡å¼ï¼Œå®ƒä»¬éƒ½è¦å€ŸåŠ©äºåŸºç¡€è®¾æ–½æä¾›çš„é€šè®¯æœåŠ¡æ‰èƒ½å®ç°ç›¸äº’é€šä¿¡ã€‚

åŸºç¡€è®¾æ–½ä¸ºç½‘ç»œåº”ç”¨æä¾›çš„é€šä¿¡æœåŠ¡æœ‰ä¸¤ç§æ–¹å¼

- **é¢å‘è¿æ¥çš„é€šä¿¡æ–¹å¼**
  - ä¾‹å¦‚ï¼šTCPåè®®å®ä½“å‘åº”ç”¨è¿›ç¨‹æä¾›çš„æœåŠ¡å°±æ˜¯é¢å‘è¿æ¥çš„æœåŠ¡
  - ç‰¹ç‚¹ï¼šåˆ†å¸ƒå¼åº”ç”¨ä¹‹é—´ç›¸äº’é€šä¿¡ï¼Œé¦–å…ˆè¦å»ºç«‹è¿æ¥ï¼Œåº•å±‚çš„åè®®æ ˆè¦ä¸ºä¸¤ä¸ªåº”ç”¨è¿›ç¨‹ä»¥åçš„é€šä¿¡å‡†å¤‡å¥½ç›¸åº”çš„èµ„æºï¼Œåšå¥½æ ‡è®°ï¼ˆæ¯”å¦‚å‡†å¤‡ç¼“å†²åŒºï¼Œæ ‡è®°ä½ç½®ä½ï¼Œè¶…æ—¶å®šæ—¶å™¨è®¾ç½®ç­‰ï¼‰`ä¸¤ä¸ªåº”ç”¨è¿›ç¨‹åœ¨é€šä¿¡å‰ï¼Œä¸¤è€…è¦åšå¥½å‡†å¤‡ï¼Œåº•å±‚åè®®æ ˆä¹Ÿè¦åšå¥½å‡†å¤‡`ã€‚
  - é¢å‘è¿æ¥å’Œæœ‰è¿æ¥çš„åŒºåˆ«
    - é¢å‘è¿æ¥æ˜¯ï¼šé€šä¿¡åŒæ–¹åŠå…¶åº•å±‚åè®®æ ˆçŸ¥é“ï¼Œç½‘ç»œä¸çŸ¥é“ã€‚é€šè®¯çŠ¶æ€åªåœ¨ç«¯ç³»ç»Ÿä¸­ç»´æŠ¤
    - æœ‰è¿æ¥ï¼šä¸æ­¢é€šä¿¡åŒæ–¹è¦ç»´æŒé€šä¿¡çŠ¶æ€ï¼Œä¸­é—´èŠ‚ç‚¹ä¹Ÿè¦ç»´æŠ¤é€šä¿¡çŠ¶æ€ï¼ˆå…¸å‹çš„æœ‰è¿æ¥ï¼š**PSTNç”µè¯ç½‘ç»œ**ï¼Œä¸€æ—¦å»ºç«‹é€šè¯ï¼Œç½‘ç»œä¸­æ¯ä¸ªäº¤æ¢èŠ‚ç‚¹éƒ½ä¸ºè¿™æ¬¡é€šè¯åˆ†é…å›ºå®šèµ„æºï¼ˆç”µè·¯æ—¶éš™ï¼‰ï¼‰



TCPå‘ä¸Šå±‚æä¾›çš„æœåŠ¡çš„ç‰¹æ€§ï¼šå¯é çš„ï¼Œä¿åºçš„ï¼Œæµé‡æ§åˆ¶ï¼Œæ‹¥å¡æ§åˆ¶

å¯é çš„ï¼šä¸é‡å¤ï¼Œä¸å¤±åºï¼Œä¸ä¹±åºï¼Œä¸å‡ºé”™ã€‚æ€»ç»“ï¼šå°±æ˜¯åŸåŸæœ¬æœ¬ï¼Œå‘å‡ºçš„æ˜¯ä»€ä¹ˆï¼Œæ”¶åˆ°çš„å°±æ˜¯ä»€ä¹ˆã€‚

æµé‡æ§åˆ¶ï¼šæ¯”å¦‚ä½ æ˜¯ä¸€ä¸ªæ€§èƒ½å¼ºå¤§çš„æœåŠ¡å™¨ï¼Œè‡³å¼ºã€‚è€Œå¦ä¸€ç«¯æ˜¯æ€§èƒ½å¾ˆå·®çš„æœºå™¨ã€‚å¦‚æœä½ å‘é€å¤ªå¿«ï¼Œå¯¹æ–¹æ— æ³•å¤„ç†ï¼Œåˆ™ä¼šå‡ºç°é—®é¢˜ã€‚æµé‡æ§åˆ¶å°±æ˜¯è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚åè°ƒå‘é€æ–¹å‘é€é€Ÿåº¦å’Œæ¥æ”¶æ–¹æ¥æ”¶é€Ÿåº¦ï¼Œä»è€Œè®©ä¸¤è€…èƒ½å¤Ÿæœ‰æ•ˆé€šä¿¡ã€‚

æ‹¥å¡æ§åˆ¶ï¼šç½‘ç»œè·¯å¾„æœ‰å µå¡ï¼Œé™¤äº†è¦è€ƒè™‘æ¥æ”¶æ–¹çš„æ•°æ®å¤„ç†èƒ½åŠ›ï¼Œè¿˜è¦è€ƒè™‘åˆ°ç½‘ç»œè·¯å¾„çš„é€šè¡Œèƒ½åŠ›ã€‚æ ¹æ®è·¯å¾„çš„é˜»å¡ç¨‹åº¦ï¼Œåè°ƒå‘é€æ–¹çš„å‘é€é€Ÿåº¦ï¼Œé˜²æ­¢æ•°æ®äº¤æ¢èŠ‚ç‚¹å¤„ç†ä¸äº†å¯¼è‡´ä¸¢åŒ…ã€‚





- **é‡‡ç”¨åŸºç¡€è®¾æ–½çš„æ— è¿æ¥æœåŠ¡**
  - ä¾‹å¦‚ï¼šUDP-ç”¨æˆ·æ•°æ®æŠ¥åè®®
    - æ— è¿æ¥
    - ä¸å¯é æ•°æ®ä¼ è¾“
    - æ— æµé‡æ§åˆ¶ä¸æ— æ‹¥å¡æ§åˆ¶





#### ç½‘ç»œæ ¸å¿ƒ

ç½‘ç»œæ ¸å¿ƒçš„ç»„æˆï¼šç”±äº¤æ¢èŠ‚ç‚¹ä¸äº¤æ¢èŠ‚ç‚¹å®ƒä»¬çš„é“¾è·¯æ„æˆçš„ã€‚æœ€ä¸»è¦çš„ä½œç”¨æ˜¯æ•°æ®äº¤æ¢çš„åŠŸèƒ½ï¼Œæºä¸»æœºå‘å‡ºå»ï¼Œæ­£ç¡®çš„åˆ°è¾¾ç›®æ ‡ä¸»æœºã€‚



**åˆ†ç»„äº¤æ¢**

```bat
	ä¸ºäº†ä»æºç«¯ç³»ç»Ÿå‘ç›®çš„ç«¯ç³»ç»Ÿå‘é€ä¸€ä¸ªæŠ¥æ–‡ï¼Œæºå°†é•¿æŠ¥æ–‡åˆ’åˆ†ä¸ºè¾ƒå°çš„æ•°æ®å—ï¼Œç§°ä¹‹ä¸ºåˆ†ç»„  ï¼ˆpacketï¼‰ 
åœ¨æºå’Œç›®çš„åœ°ä¹‹é—´ï¼Œæ¯ä¸ªåˆ†ç»„éƒ½é€šè¿‡é€šä¿¡é“¾è·¯å’Œåˆ†ç»„äº¤æ¢æœºï¼ˆpacket switch ï¼‰ä¼ é€ã€‚ï¼ˆäº¤æ¢æœºä¸»è¦æœ‰ä¸¤ç±»ï¼šè·¯ç”±å™¨ï¼ˆrouterï¼‰å’Œé“¾è·¯å±‚äº¤æ¢æœºï¼ˆlink-layer* switchï¼‰ã€‚ï¼‰åˆ†ç»„ä»¥ç­‰äºè¯¥é“¾è·¯æœ€å¤§ä¼ è¾“é€Ÿç‡çš„é€Ÿåº¦ä¼ è¾“é€šè¿‡é€šä¿¡é“¾è·¯ã€‚  â€”â€” ã€Šè®¡ç®—æœºç½‘ç»œâ€”è‡ªé¡¶å‘ä¸‹ã€‹
```



![image-20250612115408514](D:\git_repository\cyber_security_learning\markdown_img\image-20250612115408514.png)

ä»¥åˆ†ç»„ä¸ºå•ä½å­˜å‚¨-è½¬å‘æ–¹å¼

- ç½‘ç»œå¸¦å®½èµ„æºä¸å†åˆ†ä¸ºä¸€ä¸ªä¸ªç‰‡ï¼Œä¼ è¾“æ—¶ä½¿ç”¨å…¨éƒ¨å¸¦å®½
- ä¸»æœºä¹‹é—´ä¼ è¾“çš„æ•°æ®è¢«åˆ†ä¸ºä¸€ä¸ªä¸ªåˆ†ç»„



**ä»€ä¹ˆæ˜¯åˆ†ç»„**

åˆ†ç»„äº¤æ¢æ˜¯ä¸€ç§é€šä¿¡æ–¹å¼ï¼Œæ•°æ®åœ¨å‘é€å‰è¢«**åˆ†å‰²æˆè¾ƒå°çš„å•å…ƒï¼ˆåˆ†ç»„ï¼‰**ï¼Œé€ä¸ªä¼ è¾“ã€‚

è¿™äº›åˆ†ç»„å…·æœ‰ä»¥ä¸‹ç‰¹å¾ï¼š

- ç‹¬ç«‹è·¯ç”±ï¼ˆå¯èƒ½èµ°ä¸åŒè·¯å¾„ï¼‰
- ç‹¬ç«‹å°è£…
- æ¯ä¸ªåˆ†ç»„åŒ…å«å®Œæ•´çš„ç›®æ ‡åœ°å€ä¿¡æ¯



**å­˜å‚¨è½¬å‘**

![image-20250612143716393](D:\git_repository\cyber_security_learning\markdown_img\image-20250612143716393.png)

å­˜å‚¨è½¬å‘ä¼ è¾“æ˜¯æŒ‡åœ¨äº¤æ¢æœºèƒ½å¤Ÿå¼€å§‹å‘è¾“å²€é“¾è·¯ä¼ è¾“è¯¥åˆ†ç»„çš„ç¬¬ä¸€ä¸ªæ¯”ç‰¹ä¹‹å‰ï¼Œå¿…é¡»æ¥æ”¶åˆ°æ•´ä¸ªåˆ†ç»„ã€‚

> å­˜å‚¨è½¬å‘ï¼Œä¸ºé“¾è·¯å…±äº«æä¾›äº†åŸºç¡€ã€‚





**ä¸¢åŒ…**

è·¯ç”±å™¨ä¸­çš„æ’é˜Ÿé˜Ÿåˆ—æ‰€å®¹çº³çš„åˆ†ç»„æ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ç­‰åˆ°è·¯ç”±å™¨é˜Ÿåˆ—å †æ»¡åï¼Œæ–°åˆ°è¾¾çš„åˆ†ç»„å°±æ— æ³•è¢«å®¹çº³ï¼Œå¯¼è‡´è·¯ç”±å™¨ `ä¸¢å¼ƒ(drop)` è¯¥åˆ†ç»„ï¼Œå³åˆ†ç»„ä¼š `ä¸¢å¤±(lost)`ã€‚











### Internetç»“æ„å’ŒISP

å‰é¢æˆ‘ä»¬ä»‹ç»äº†äº’è”ç½‘å¯ä»¥åˆ†ä¸ºèŠ‚ç‚¹å’Œé“¾è·¯ï¼Œç„¶åæˆ‘ä»¬å°†ä¸»æœºç³»ç»Ÿæ„æˆäº†è¾¹ç¼˜ç³»ç»Ÿï¼Œç”±ç½‘ç»œäº¤æ¢èŠ‚ç‚¹ä¹‹é—´æ„æˆçš„å­ç³»ç»Ÿï¼Œå«ç½‘ç»œæ ¸å¿ƒï¼Œå°†è¾¹ç¼˜æ¥å…¥ç½‘ç»œæ ¸å¿ƒï¼Œæˆ‘ä»¬å«æ¥å…¥accessï¼Œè¿™æ˜¯ä¸€ç§åˆ’åˆ†æ–¹å¼



è¿˜æœ‰ä¸€ç§åˆ’åˆ†æ–¹å¼ï¼šæˆ‘ä»¬æŠŠå…³ç³»æ¯”è¾ƒå¯†é›†çš„ï¼Œä¸€ä¸ªç½‘ç»œä¾›åº”å•†çš„ç½‘ç»œä½œä¸ºä¸€ä¸ªç½‘ç»œã€‚æ¯”å¦‚ï¼šé«˜æ ¡çš„æ ¡å›­ç½‘ï¼Œè¿™é‡Œæœ‰äº¤æ¢è®¾å¤‡ï¼Œæœ‰é“¾è·¯ï¼Œæœ‰ä¸»æœºã€‚è¿™æ„æˆä¸€ä¸ªå­ç³»ç»Ÿï¼Œè¿™ä¸ªå­ç³»ç»Ÿå«ä¸€ä¸ªISPç½‘ç»œã€‚å½“ç„¶è¿˜æœ‰å…¶ä»–ISPçš„ç½‘ç»œã€‚äº’è”ç½‘å°±æ˜¯ç”±è¿™äº›ISPçš„ç½‘ç»œé€šè¿‡ç½‘ç»œäº’è”è®¾å¤‡ï¼Œæ¯”å¦‚è·¯ç”±å™¨æ¥æ„å»ºæˆçš„ã€‚



ä¹‹å‰çš„åˆ’åˆ†æ˜¯æŒ‰ç…§ç½‘ç»œèŠ‚ç‚¹å’Œé“¾è·¯çš„åˆ†ç±»ï¼Œåˆ†ä¸ºäº†è¾¹ç¼˜ï¼Œæ¥å…¥ï¼Œæ ¸å¿ƒ

ç°åœ¨ï¼Œæˆ‘ä»¬æŒ‰ç…§ä¸€ä¸ªèŒƒå›´å†…ï¼Œå…³ç³»å¯†é›†çš„ä¸€ä¸ªç½‘ç»œä¸­çš„è®¾å¤‡ï¼Œç§°ä¹‹ä¸ºä¸€ä¸ªISPç½‘ç»œï¼Œäº’è”ç½‘æ˜¯æœ‰å¾ˆå¤šISPçš„ç½‘ç»œæ„æˆçš„ï¼Œå½“ç„¶ISPé‡Œè¿˜åŒ…æ‹¬å¾ˆå¤šå°ISPã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥è¯´äº’è”ç½‘æ˜¯ç”±ä¸€å †ISPç½‘ç»œæ„æˆçš„ï¼Œé€šè¿‡ç½‘ç»œäº’è”è®¾å¤‡ï¼Œé€šè¿‡è·¯ç”±å™¨è¿åœ¨ä¸€èµ·çš„ï¼Œæ˜¯ç½‘ç»œçš„ç½‘ç»œã€‚



æˆ‘ä»¬ä½¿ç”¨æ¸è¿›æ¼”åŒ–çš„æ–¹æ³•ï¼Œæ¥æè¿°äº’è”ç½‘å½“ä»Šçš„ç»“æ„ã€‚



æˆ‘ä»¬å¾ˆå¤šçš„ç«¯ç³»ç»Ÿï¼Œéƒ½æ˜¯é€šè¿‡æ¥å…¥ISPè®¿é—®çš„äº’è”ç½‘ã€‚æ¯”å¦‚ç§»åŠ¨æ‰‹æœºï¼Œæ˜¯é€šè¿‡ç§»åŠ¨ISPæ¥å…¥äº’è”ç½‘ã€‚ä»»ä½•ä¸€ä¸ªç«¯ç³»ç»Ÿéƒ½æ˜¯é€šè¿‡æ¥å…¥ISPæ¥æ¥å…¥äº’è”ç½‘çš„ã€‚æ¯”å¦‚æˆ‘ä»¬å®¶ç”¨çš„ä¸»æœºï¼Œé€šå¸¸æ˜¯ä¸ä¼šç§»åŠ¨çš„ï¼Œä½†æ˜¯ç§»åŠ¨æ¥å…¥æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿä½ æ‹¿ç€ä¸€ä¸ªæ‰‹æœºï¼Œåœ¨å¾ˆå¤šæœ‰è”é€šåŸºç«™çš„åœ°æ–¹éƒ½èƒ½æŠŠä½ æ¥å…¥ã€‚ä¸ç®¡æ€æ ·ä½ æ˜¯é€šè¿‡ç§»åŠ¨ï¼Œè”é€šåŸºç«™æ¥å…¥äº’è”ç½‘ã€‚æœ‰å¾ˆå¤šå¾ˆå¤šçš„æ¥å…¥ISPï¼Œæœ‰å¤šå°‘ï¼Ÿå‡ åä¸‡ï¼Œä¸Šç™¾ä¸‡æ¥å…¥ISPï¼Œæ¥å…¥ISPä¹‹é—´è¦ä¸è¦äº’è”ã€‚



æˆ‘é€šè¿‡æ¥å…¥ISPæ¥å…¥äº’è”ç½‘ï¼Œä»–é€šè¿‡å¦ä¸€ä¸ªæ¥å…¥ISPæ¥å…¥äº’è”ç½‘ã€‚å¦‚æœæ¥å…¥ISPä¹‹é—´ä¸èƒ½äº’è”ï¼Œæ˜¯ä¸æ˜¯æˆ‘å’Œä»–ä¹‹é—´çš„è®¿é—®å°±ä¼šæœ‰é—®é¢˜ã€‚



å› æ­¤è¿™äº›æ¥å…¥ISPéƒ½è¦äº’è”çš„ã€‚ä½†æ˜¯è¿™äº›æ¥å…¥ISPæ˜¯æ€æ ·äº’è”çš„ã€‚

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ï¼Œå‘å±•å’Œæ¼”åŒ–æ˜¯é€šè¿‡ä¸€äº›ç»æµçš„å’Œæ”¿æ²»ç­–ç•¥æ¥é©±åŠ¨å®ƒæ¼”åŒ–åˆ°å½“å‰çš„æƒ…å†µã€‚æˆ‘ä»¬çœ‹ä¸‹å®ƒæ˜¯å¦‚ä½•æ¼”åŒ–çš„ã€‚



ç”¨æˆ·æ˜¯é€šè¿‡æ¥å…¥ISPæ¥è®¿é—®äº’è”ç½‘ã€‚è¿™äº›æ¥å…¥ISPè¦ç›¸äº’äº’è”ï¼Œé—®é¢˜æ˜¯ä»–ä»¬æ€ä¹ˆäº’è”ã€‚

æœ‰ä¸€ç§æ–¹å¼ï¼ŒæŠŠå®ƒä»¬å…¨è¿æ¥å¯ä»¥å—ï¼Ÿå½“ç„¶ä¸å¯ä»¥ï¼Œæƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æœ‰Nä¸ªISPï¼Œé‚£ä¹ˆå…¨è¿æ¥å°±æ˜¯n(n-1)/2ï¼ŒåŸºæœ¬ä¸Šæ˜¯nçš„å¹³æ–¹çš„çº§åˆ«ã€‚å¦‚æœæœ‰10wä¸ªISPï¼Œå…¨è¿æ¥å°±æ˜¯10wçš„å¹³æ–¹ï¼Œè¿™ä¸ªæ˜¯ä¸å¯ç›¸ä¿¡çš„ï¼Œä»£ä»·å¤ªå¤§äº†ã€‚è¿™ç§æ–¹å¼æ˜¯ä¸å¯æ‰©å±•çš„ã€‚



é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿå¯¹äºISPæ¥è¯´ï¼Œä½ æ¥å…¥äº’è”ç½‘æ˜¯ä¸æ˜¯è¦ç»™ISPä»˜è´¹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰åˆ©å¯å›¾çš„ã€‚é‚£å°±æ„å‘³ç€æœ‰äº›ä¾›åº”å•†ä¼šæŠŠå…¨çƒçš„è¿™äº›æ¥å…¥ISPéƒ½è¿åœ¨ä¸€èµ·ï¼Œåœ¨å…¨çƒèŒƒå›´å†…ï¼Œéƒ¨ç½²è‡ªå·±çš„è·¯ç”±å™¨å’Œçº¿è·¯ï¼ŒæŠŠè¿™äº›è·¯ç”±å™¨å’Œè®¾å¤‡éƒ½è¿åœ¨ä¸€èµ·ã€‚ç„¶åè¿™ä¸ªå…¨çƒçš„ISPä¼šæŠŠæ¥å…¥ISPéƒ½è¿åœ¨ä¸€èµ·ï¼Œä¹Ÿå°±æ˜¯è¿™äº›æ¥å…¥ISPï¼Œéƒ½è¿åœ¨è¿™ä¸ªGLOBAL ISPä¸Šã€‚è¿™æ ·çš„è¯ï¼Œæ¥å…¥ISPä¹‹é—´çš„é€šä¿¡ï¼Œå°±å¯ä»¥å€ŸåŠ©äºGLOBAL ISPè¿åœ¨ä¸€èµ·ã€‚



æœ‰åˆ©å¯å›¾ï¼Œæ¯”å¦‚æœ‰äººä¼šæŠ•èµ„ï¼Œè¿™å°±æ˜¯ç»æµé©±åŠ¨çš„å¿…ç„¶ã€‚



æˆ‘ä»¬æŠŠå¾ˆå¤šæ¥å…¥ISPè¿åœ¨ä¸€èµ·ï¼Œåœ¨ä»–ä»¬ä¹‹é—´å®Œæˆæ•°æ®çš„æ”¶å‘ï¼Œé‚£ä¹ˆæˆ‘åœ¨å…¨çƒéƒ¨ç½²æˆ‘çš„è¿™äº›èŠ‚ç‚¹ï¼Œä¹Ÿæ˜¯æŠ€æœ¯ä¸Šå¯è¡Œçš„ï¼Œåœ¨ç»æµä¸Šä¹Ÿæ˜¯æœ‰æ”¶ç›Šçš„ã€‚é‚£ä¸€å®šæœ‰GLOBAL ISPå»åšè¿™ä¸ªäº‹æƒ…ï¼Œ



ä½ çš„access netæ˜¯é€šè¿‡ä¸€äº›ç»æµåˆçº¦å’ŒGLOBAL ISPè°ˆå¥½ï¼Œæ¯”å¦‚æµé‡ä¸Šè¡Œä¸‹è¡Œæ˜¯å¤šå°‘ï¼Œæ€ä¹ˆç»“ç®—ï¼Œæ˜¯åŒ…æœˆè¿˜æ˜¯æŒ‰é‡ä»˜è´¹ç­‰ç­‰ã€‚å› æ­¤access netå’ŒGLOBAL ISPä¹‹é—´é€šå¸¸æœ‰åˆçº¦ï¼Œæ¥çº¦æŸå®ƒä»¬çš„è¡Œä¸ºã€‚



ä½†æ˜¯å¦‚æœåªæœ‰ä¸€ä¸ªGLOBAL ISPï¼Œé‚£æœåŠ¡è´¨é‡å¿…ç„¶ä¸ä¼šé«˜ï¼Œä½†æ˜¯ä»·æ ¼ä¸€å®šå¾ˆé«˜ã€‚è¿™æ—¶å€™å¿…ç„¶ä¼šæœ‰ä¸€äº›å…¶ä»–ISPå‚ä¸åˆ°è¿™ä¸ªç«äº‰ã€‚



å› æ­¤å°±æœ‰å¤šä¸ªGLOBAL ISPï¼ŒæŠŠä¸€äº›æ¥å…¥ISPæ¥å…¥è¿›æ¥ã€‚ä¸åŒçš„æ¥å…¥ISPï¼Œæ¥å…¥ä¸åŒçš„GLOBAL ISPã€‚



å¦ä¸€æ–¹é¢ï¼Œé™¤äº†æœ‰ç«äº‰è¿˜æœ‰åˆä½œï¼Œæ¯”å¦‚æˆ‘æ¥å¦‚åˆ€è¿™äº›access netï¼Œä½ æ¥å…¥é‚£äº›access netã€‚æˆ‘è¦æŠŠä½ çš„å®¢æˆ·æ¥è¿›æ¥ï¼Œä»£ä»·æ˜¯å¾ˆé«˜çš„ã€‚è¿™æ—¶æˆ‘æœ‰ä¸€ä¸ªé€‰æ‹©ï¼Œæˆ‘é€šè¿‡ä½ æ¥å…¥ä½ çš„å®¢æˆ·ï¼Œä½ é€šè¿‡æˆ‘æ¥å…¥æˆ‘çš„å®¢æˆ·ï¼Œè¿™æ ·çš„è¯ã€‚æˆ‘å¯¹æˆ‘çš„æ–°å®¢æˆ·è€Œè¨€ï¼Œæˆ‘è¯´æˆ‘å¯ä»¥æ¥å…¥æ‰€æœ‰çš„access netï¼Œä½ ä¹Ÿå¯ä»¥å’Œä½ çš„ç”¨æˆ·è¯´ï¼Œä½ å¯ä»¥æ¥å…¥æ‰€æœ‰access netã€‚

é‚£è¿™æ ·å°±æœ‰ä¸€ä¸ªåˆä½œçš„æ¦‚å¿µã€‚åˆä½œå¯èƒ½æ¶‰åŠåˆ°ç»“ç®—ã€‚ä¹Ÿå¯èƒ½ä¸æ¶‰åŠæµé‡çš„ç»“ç®—ã€‚æˆ‘ä»¬æ˜¯å¯¹ç­‰çš„ï¼Œå¦‚æœå¤§å®¶æ¥å…¥çš„å„è‡ªçš„access netå·®ä¸å¤šï¼Œå‘è¿‡å»çš„å’Œå›æ¥çš„æµé‡å·®ä¸å¤šï¼Œé‚£å°±ä¸ç”¨ä»˜è´¹äº†ï¼Œå¯¹å†²äº†ã€‚å¯¹äºè¿è¥å•†è€Œè¨€ï¼Œæˆ‘ä¸ç”¨èŠ±é’±ï¼Œå’Œä½ è°ˆä¸ªåˆçº¦ï¼Œå‡ºä¸€ä¸ªæ¡è·¯ç”±å™¨ï¼Œå‡ºä¸ªé“¾è·¯ï¼Œå°±èƒ½å’Œä½ ç›¸è¿ï¼Œä»è€Œæ‰©å±•æˆ‘ä¸šåŠ¡çš„ç‰©ç†èŒƒå›´ã€‚



è¿™æ ·ï¼Œæ—¢æœ‰ç«äº‰ä¹Ÿæœ‰åˆä½œã€‚è¿™ç§è¿æ¥å«åšå¯¹ç­‰çš„è¿æ¥ã€‚



è¿˜æœ‰ä¸€ç§è¿æ¥æ˜¯å¤§å®¶éƒ½æ¥å…¥åˆ°IXPï¼Œä¹Ÿå°±æ˜¯äº’è”ç½‘è¿æ¥äº¤æ¢ç‚¹ï¼Œåœ¨è¿™äº›äº¤æ¢ç‚¹ä¹‹é—´ï¼Œå®Œæˆaåˆ°bï¼Œbåˆ°cï¼Œcåˆ°açš„æ•°æ®äº¤æ¢ã€‚



è¿™ä¸ªäº¤æ¢ç‚¹å½“ç„¶éå¸¸é‡è¦ï¼Œå¾ˆå¤šéª¨å¹²çš„ISPï¼Œå®ƒçš„æµé‡éƒ½é€šè¿‡IXPçš„äº¤æ¢ç‚¹ï¼Œå®Œæˆç½‘é—´æµé‡çš„äº¤æ¢ã€‚



å½“ç„¶ä¸šåŠ¡è¿˜æœ‰ä¸ªç»†åˆ†çš„é—®é¢˜ã€‚ISPAæ˜¯å®Œæˆå…¨çƒèŒƒå›´å†…çš„access netæ¥å…¥ï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸€äº›å°çš„è¿è¥å•†ï¼Œå¯ä»¥åšç²¾ç»†åŒ–çš„æœåŠ¡ï¼Œå¯ä»¥åœ¨ä¸€ä¸ªå›½å®¶æˆ–è€…å‡ ä¸ªå¤§å·ä¹‹é—´ï¼Œæˆ‘æœ‰æˆ‘çš„åŠ¿åŠ›èŒƒå›´ï¼Œæˆ‘å¯ä»¥åšç²¾ç»†åŒ–çš„æœåŠ¡ï¼Œæˆ‘å¯ä»¥éƒ¨ç½²å¾ˆå¤šè·¯ç”±å™¨ï¼Œé“¾è·¯ä»è€ŒæŠŠæ›´å¤šçš„ç”¨æˆ·æ¥è¿›æ¥ã€‚æ‰€ä»¥å°±æœ‰ä¸šåŠ¡ç»†åˆ†ã€‚



global ISP å®Œæˆå…¨çƒæ–¹ä½å†…çš„äº¤æ¢ï¼Œè€ŒReginalï¼Œè¦å®ŒæˆåŒºåŸŸèŒƒå›´å†…ï¼ŒæŠŠè¿™äº›access netæ¥è¿›æ¥ï¼Œå®ƒä»¬ä¹‹é—´è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œå¦‚æœè¦è®¿é—®äº’è”ç½‘å…¶ä»–åœ°æ–¹çš„ï¼Œå†é€šè¿‡global ISPå®Œæˆå…¨çƒèŒƒå›´çš„äº¤æ¢ã€‚



ç°åœ¨æƒ…å†µæ›´åŠ å¤æ‚ï¼Œäº’è”ç½‘æœ‰å¾ˆå¤šè§’è‰²ï¼Œç«¯ç³»ç»Ÿæœ‰ç”¨æˆ·ï¼Œè¿˜æœ‰æœåŠ¡æä¾›å•†ISPï¼Œè¿˜æœ‰ICPå°±äº’è”ç½‘å†…å®¹æä¾›å•†ï¼Œæ¯”å¦‚googleï¼Œbaiduç­‰ã€‚æä¾›ä¸Šå±‚ä¸šåŠ¡çš„ã€‚



åƒGoogleè¿™æ ·çš„ICPï¼Œæœ‰åå‡ äº¿ç”¨æˆ·æä¾›æœåŠ¡çš„ICPï¼Œè¿™äº›å†…å®¹æä¾›å•†å½“ç„¶ä¹Ÿéœ€è¦é€šè¿‡ISPæ¥å…¥äº’è”ç½‘ã€‚ä½†æ˜¯æˆ‘ä½œä¸ºå†…å®¹æä¾›å•†ï¼Œæ¥å…¥äº’è”ç½‘ï¼Œæ˜¯ä¸æ˜¯ä¹Ÿéœ€è¦å‘ISPä»˜è´¹ï¼Œè€Œä¸”ä»˜è´¹è¿˜å¾ˆé«˜ã€‚å¯¹äºGoogleæ¥è¯´ï¼Œå¦‚æœä»˜è´¹éå¸¸é«˜ã€‚è€Œä¸”æœåŠ¡è´¨é‡ä¹Ÿæ²¡åŠæ³•ä¿è¯ã€‚æ¯”å¦‚æˆ‘æ˜¯ç¾æ´²çš„ISPï¼Œç„¶åå—éçš„ç”¨æˆ·è®¿é—®æˆ‘ï¼Œè¿™ä¸ªè·ç¦»å°±å¾ˆè¿œï¼Œä¸­é—´è¦ç»è¿‡å¾ˆå¤šæ•°æ®äº¤æ¢è®¾å¤‡ã€‚å°±å¾ˆéº»çƒ¦ã€‚æ€ä¹ˆåŠå‘¢ã€‚


åƒGoogleè¿™æ ·çš„å†…å®¹æä¾›å•†å°±ä¼šåœ¨å…¨çƒå„åœ°å¸ƒç½®æ•°æ®ä¸­å¿ƒæœºæˆ¿ã€‚æˆ‘é€šè¿‡æˆ‘è‡ªå·±éƒ¨ç½²çš„ä¸“ç½‘ï¼Œæˆ–è€…ç§Ÿç”¨çº¿ç¼†ã€‚æŠŠè¿™äº›æ•°æ®ä¸­å¿ƒæœºæˆ¿è¿åœ¨ä¸€èµ·ã€‚è€Œä¸”è¿™äº›æ•°æ®ä¸­å¿ƒé€šå¸¸å¸ƒç½®åœ¨ç¦»ISPçš„æ•°æ®ä¸­å¿ƒæœºæˆ¿æ¯”è¾ƒè¿‘çš„åœ°æ–¹ã€‚è¿™æ ·ç”¨æˆ·é€šè¿‡ISPæ¥è¿›æ¥ï¼Œå¾ˆå¿«å°±èƒ½æ¥å…¥googleçš„æ•°æ®ä¸­å¿ƒæœºæˆ¿ã€‚ç„¶åè¿”å›å»ï¼Œè¿™æ ·ä½“éªŒå°±å¾ˆå¥½ã€‚è€Œä¸”å› ä¸ºåœ¨å¾ˆå¤šé“¾è·¯ä¸Šï¼Œæˆ‘ç”¨çš„è‡ªå·±çš„ä¸“ç½‘ï¼Œå› æ­¤å‘ISPæ”¯ä»˜çš„è´¹ç”¨å°±ä¼šå¾ˆå°‘ã€‚



æ‰€ä»¥ä¸€ä¸ªæˆæœ¬åŸå› ï¼Œä¸€ä¸ªç”¨æˆ·ä½“éªŒçš„åŸå› ï¼Œä¿ƒä½¿Googleéƒ¨ç½²è‡ªå·±çš„æ•°æ®ä¸­å¿ƒæœºæˆ¿ã€‚



é€šå¸¸æ¥è¯´å…¨çƒèŒƒå›´å†…çš„è¦†ç›–ç‚¹ä¼šå°‘ä¸€äº›ï¼Œå› ä¸ºæˆæœ¬å¤ªé«˜ï¼Œç‚¹å’Œç‚¹ä¹‹é—´ï¼Œå¸¦å®½ä¼šå¾ˆå®½ã€‚å› ä¸ºä»˜äº†é‚£ä¹ˆå¤§ä»£ä»·ï¼Œä½¿ç”¨æµ·åº•ç”µç¼†è¿æ¥æ´›æ‰çŸ¶åˆ°ä¸Šæµ·ã€‚å¸¦å®½æä¸€ä¸ª1kï¼Œé‚£ä¸æ˜¯æœ‰ç—…å—ã€è‡ªå·±ç”¨ä¸äº†è¿˜å¯ä»¥ç§Ÿå‡ºå»å˜›â€¦â€¦



åƒ















### åè®®å±‚æ¬¡å’ŒæœåŠ¡æ¨¡å‹



#### æ¨¡å—åŒ–åˆ†å±‚æ€è·¯

æˆ‘ä»¬é¦–å…ˆè¦æ‰¿è®¤ä¸€ç‚¹ï¼šç½‘ç»œæ˜¯ä¸€ä¸ªéå¸¸å¤æ‚çš„ç³»ç»Ÿã€‚æœ‰å„ç§å„æ ·çš„ç»ˆç«¯è®¾å¤‡ï¼Œå„ç§å„æ ·çš„é“¾è·¯ï¼Œå„ç§å„æ ·çš„åº”ç”¨ã€‚é‚£ä¹ˆä½œä¸ºä¸€ä¸ªç§‘å­¦å®¶æˆ–è€…å·¥ç¨‹å¸ˆå®ä½“ï¼Œå¦‚ä½•è®¾è®¡å’Œå®ç°ç»„ç»‡å¤æ‚çš„ç½‘ç»œåŠŸèƒ½ï¼Ÿ



è§£å†³è¿™ä¸ªé—®é¢˜çš„æ€è·¯ï¼šæ¨¡å—åŒ–çš„æ€è·¯ã€‚



ä»€ä¹ˆæ˜¯æ¨¡å—åŒ–çš„æ€è·¯å‘¢ï¼Ÿå°±æ˜¯æŠŠä¸€ä¸ªå¤æ‚çš„åŠŸèƒ½ï¼Œåˆ†è§£æˆä¸€ä¸ªä¸ªæ¨¡å—ï¼Œæ¨¡å—ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œè€Œä¸”å¹³é¢æ€§çš„è°ƒç”¨ï¼Œä»»ä½•ä¸€ä¸ªæ¨¡å—éƒ½å¯ä»¥è°ƒç”¨ä»»ä½•æ¨¡å—æä¾›çš„åŠŸèƒ½å’ŒæœåŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„åŠŸèƒ½é€šè¿‡æ¨¡å—åŒ–çš„åˆ†è§£æ¥è¿›è¡Œå®ç°ã€‚

![image-20250613100710715](D:\git_repository\cyber_security_learning\markdown_img\image-20250613100710715.png)



å…¶ä¸­ä¸€ä¸ªæ¨¡å—åŒ–çš„åˆ†è§£æ€è·¯å°±æ˜¯åˆ†å±‚çš„æ–¹æ³•æ¥è§£å†³ã€‚

å°†ä¸€ä¸ªå¤æ‚çš„åŠŸèƒ½åˆ†ä¸ºä¸€ä¸ªä¸ªæ¨¡å—ï¼Œæ¨¡å—ä¹‹é—´çš„è°ƒç”¨å’Œè¢«è°ƒç”¨å…³ç³»æ˜¯**ä»ä»…ç›¸é‚»**çš„ä¸¤å±‚çš„æ¨¡å—ä¹‹é—´èƒ½å¤Ÿè°ƒç”¨å’Œè¢«è°ƒç”¨ï¼Œä»–ä¸å…è®¸æˆ–è€…è¯´ä¸æ¨èè·¨å±‚è°ƒç”¨ã€‚

è€Œ**è®¡ç®—æœºç½‘ç»œå®ç°**è¿™ç§å¤æ‚çš„é—®é¢˜ï¼Œå°±æ˜¯é‡‡ç”¨åˆ†å±‚çš„æ¨¡å—åŒ–çš„æ–¹å¼æ¥è§£å†³ï¼Œè®¾è®¡å’Œå®ç°çš„ã€‚å°†åŠŸèƒ½éå¸¸å¤æ‚çš„è®¡ç®—æœºç½‘ç»œçš„åŠŸèƒ½åˆ†è§£ä¸ºä¸€ä¸ªä¸ªåŠŸèƒ½æ˜ç¡®çš„å­æ¨¡å—ï¼Œæ¯ä¸€å±‚å®ç°ä¸€ä¸ªæˆ–ä¸€ç»„åŠŸèƒ½ã€‚æ¯ä¸€å±‚çš„åŠŸèƒ½é€šè¿‡å±‚é—´çš„æ¥å£ï¼Œå‘ä¸Šå±‚æä¾›æœåŠ¡ã€‚åƒè¿™æ ·ä¸€å±‚è½ä¸€å±‚ï¼Œä¸€æ¬¡è½ä¸€å±‚ï¼Œæœ€åå®ç°æ¯”è¾ƒå¤æ‚çš„è®¡ç®—æœºç½‘ç»œçš„åŠŸèƒ½









#### å¼‚åœ°å“²å­¦å®¶äº¤æµå“²å­¦æ€æƒ³

è®¡ç®—æœºç½‘ç»œä½¿ç”¨åˆ†å±‚çš„æ–¹å¼å¦‚ä½•è§£å†³æ¯”è¾ƒå¤æ‚çš„è®¡ç®—æœºç½‘ç»œçš„åŠŸèƒ½å®ç°ï¼Œå¯ä»¥é€šè¿‡ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼ˆå¼‚åœ°å“²å­¦å®¶ä½¿ç”¨ä¸åŒè¯­è¨€è¿›è¡Œå“²å­¦æ€æƒ³äº¤æµçš„å¤æ‚é—®é¢˜ï¼‰ï¼Œæ¥æ–¹ä¾¿å¤§å®¶çš„ç†è§£

![image-20250613094506502](D:\git_repository\cyber_security_learning\markdown_img\image-20250613094506502.png)

 

- æœ€ä¸‹é¢æ˜¯ç§˜ä¹¦å±‚ï¼šè§£å†³çš„æ˜¯å¼‚åœ°é€šè®¯çš„é—®é¢˜ã€‚ï¼ˆåè®®ï¼šçº¦å®šé€šä¿¡çš„æ–¹å¼ï¼‰
- ç¬¬äºŒå±‚æ˜¯ç¿»è¯‘å±‚ï¼šè§£å†³çš„æ˜¯è¡¨ç¤ºè½¬æ¢çš„é—®é¢˜ã€‚å°†ä¸¤ä½å“²å­¦å®¶ä¸åŒçš„è¯­è¨€è½¬æ¢ä¸ºå…±ç”¨çš„è¯­è¨€è¿›è¡Œäº¤æµï¼ˆåè®®ï¼šçº¦å®šå…±ç”¨çš„è¯­è¨€ï¼‰
- æœ€ä¸Šé¢æ˜¯å“²å­¦å®¶å±‚ï¼šä¸¤ä¸ªå“²å­¦å®¶äº¤æ¢å“²å­¦æ€æƒ³ï¼Œä»è€Œå®Œæˆæ·±å±‚æ¬¡çš„å­¦æœ¯äº¤æµ



é€šè¿‡ä¸Šè¿°è¿‡ç¨‹ç±»æ¯”ï¼šä¸¤ä¸ªåº”ç”¨è¿›ç¨‹é€šè¿‡äº¤æ¢åº”ç”¨æŠ¥æ–‡æ¥å®ç°å„ç§å„æ ·çš„ç½‘ç»œåº”ç”¨ã€‚åŒ…æ‹¬ï¼šç”µå­å•†åŠ¡ï¼ŒåŸŸåè§£æï¼Œæ–‡ä»¶ä¸‹è½½ç­‰ã€‚



ä¸Šè¿°åˆ†å±‚è§£å†³é—®é¢˜çš„ä¼˜åŠ¿ï¼š

- æŠŠä¸€ä¸ªå¤æ‚çš„é—®é¢˜è½¬æ¢æˆ3ä¸ªå­é—®é¢˜ï¼Œæ¯ä¸ªé—®é¢˜çš„è§£å†³ç›¸å¯¹ç‹¬ç«‹ï¼Œå•ä¸€ã€‚
- æ¯ä¸€å±‚ç‹¬ç«‹è¿›è¡ŒæŠ€æœ¯æ›´æ–°ï¼Œä¸ä¼šå½±å“å…¶ä»–å±‚ã€‚



å±‚æ¬¡åŒ–æ–¹å¼å®ç°å¤æ‚ç½‘ç»œåŠŸèƒ½ï¼š

- å°†ç½‘ç»œå¤æ‚çš„åŠŸèƒ½åˆ†å±‚åŠŸèƒ½æ˜ç¡®çš„å±‚æ¬¡ï¼Œæ¯ä¸€å±‚å®ç°äº†å…¶ä¸­ä¸€ä¸ªæˆ–ä¸€ç»„åŠŸèƒ½ï¼ŒåŠŸèƒ½ä¸­æœ‰å…¶ä¸Šå±‚å¯ä»¥ä½¿ç”¨çš„åŠŸèƒ½ï¼š**æœåŠ¡**ï¼ˆæœ¬å±‚åŠŸèƒ½çš„å­é›†ï¼Œèƒ½å¤Ÿä¸ºä¸Šå±‚æä¾›æœåŠ¡çš„éƒ¨åˆ†ï¼‰
- æœ¬å±‚åè®®ï¼ˆæ¯ä¸€å±‚äº¤äº’åº”è¯¥éµå®ˆçš„è§„åˆ™çš„é›†åˆï¼‰å®ä½“ç›¸äº’äº¤äº’æ‰§è¡Œæœ¬å±‚çš„åè®®åŠ¨ä½œï¼Œç›®çš„æ˜¯å®ç°æœ¬å±‚çš„åŠŸèƒ½ï¼Œé€šè¿‡æ¥å£**ä¸ºä¸Šå±‚æä¾›æ›´å¥½çš„æœåŠ¡**
- æœ¬å±‚çš„æœåŠ¡ï¼šå€ŸåŠ©ä¸‹å±‚æœåŠ¡å®ç°çš„æœ¬å±‚åè®®å®ä½“ä¹‹é—´äº¤äº’å¸¦æ¥çš„æ–°åŠŸèƒ½ï¼ˆä¸Šå±‚å¯ä»¥é‡Œåˆ©ç”¨ï¼‰+æ›´æ–°å±‚æä¾›çš„æœåŠ¡ã€‚





#### åè®®å’ŒæœåŠ¡çš„å…³ç³»

åè®®çš„ç›®çš„ï¼šä¸ºä¸Šå±‚æä¾›æ›´å¥½çš„æœåŠ¡

åè®®çš„å®ç°ï¼šé€šè¿‡å±‚é—´çš„æ¥å£ï¼Œå€ŸåŠ©äºä¸‹å±‚æä¾›çš„æœåŠ¡ï¼Œäº¤æ¢å¯¹ç­‰å±‚ç›¸åº”çš„PDUï¼Œä»è€Œå®ç°æ–°çš„åè®®åŠ¨ä½œï¼Œç›®çš„æ˜¯ä¸ºä¸Šå±‚æä¾›æ›´å¥½çš„æœåŠ¡

```bat
æ¯ä¸€å±‚å‘ä¸Šå±‚æä¾›çš„æœåŠ¡ï¼ŒåŒ…æ‹¬äº†æ‰€æœ‰ä¸‹å±‚æä¾›æœåŠ¡çš„æ€»å’Œï¼ŒåŠ ä¸Šå’Œå¯¹ç­‰å±‚å®ä½“äº¤äº’è¿‡ç¨‹ä¸­å½¢æˆçš„æ–°çš„æœåŠ¡ç‰¹æ€§ï¼Œé€šè¿‡å±‚é—´æ¥å£å‘ä¸Šå±‚æä¾›æ›´å¥½çš„æœåŠ¡
```







#### äº’è”ç½‘ä¸­çš„åˆ†å±‚ç»“æ„ â€” TCP/IPåè®®æ ˆ

![image-20250613141157388](D:\git_repository\cyber_security_learning\markdown_img\image-20250613141157388.png)



**å„å±‚çš„ä½œç”¨**

- **åº”ç”¨ç¨‹ï¼š**ç½‘ç»œåº”ç”¨

  > ä¸ºäººç±»ç”¨æˆ·æˆ–è€…å…¶ä»–åº”ç”¨è¿›ç¨‹æä¾›ç½‘ç»œåº”ç”¨æœåŠ¡
  >
  > FTPï¼ŒSMTPï¼ŒHTTPï¼ŒDNS

- **ä¼ è¾“å±‚ï¼š**ä¸»æœºä¹‹é—´çš„æ•°æ®ä¼ è¾“

  > åœ¨ç½‘ç»œå±‚æä¾›çš„ç«¯åˆ°ç«¯é€šä¿¡åŸºç¡€ä¸Šï¼Œ1. ç»†åˆ†ä¸ºè¿›ç¨‹åˆ°è¿›ç¨‹ï¼Œ2. å°†ç½‘ç»œå±‚ä¸å¯é çš„é€šä¿¡å˜æˆå¯é åœ°é€šä¿¡

- **ç½‘ç»œå±‚ï¼š**ä¸ºæ•°æ®æŠ¥ï¼ˆPackageï¼‰ä»æºåˆ°ç›®çš„é€‰æ‹©è·¯ç”±

  > ä¸»æœºä¸»æœºä¹‹é—´çš„é€šä¿¡ï¼Œç«¯åˆ°ç«¯é€šä¿¡ï¼Œä¸å¯é 
  >
  > IPï¼Œè·¯ç”±åè®®

- **æ•°æ®é“¾è·¯å±‚ï¼š**ç›¸é‚»ç½‘ç»œèŠ‚ç‚¹é—´çš„æ•°æ®ä¼ è¾“

  > **æ•°æ®é“¾è·¯å±‚çš„ä¸»è¦ä½œç”¨**æ˜¯ï¼šä»¥**å¸§ï¼ˆFrameï¼‰ä¸ºå•ä½åœ¨ç›¸é‚»èŠ‚ç‚¹ä¹‹é—´å¯é ä¼ è¾“æ•°æ®ã€‚ å®ƒè´Ÿè´£å°†æ¥è‡ªç‰©ç†å±‚çš„è¿ç»­æ¯”ç‰¹æµï¼ˆbit streamï¼‰åˆ’åˆ†ä¸ºæœ‰ç•Œçš„å¸§ï¼Œè¯†åˆ«å‡ºæ¯ä¸€å¸§çš„\**èµ·å§‹å’Œç»“æŸä½ç½®**ï¼Œä»è€Œå®ç°å¯¹æ•°æ®çš„ç»„ç»‡å’Œç®¡ç†ã€‚
  >
  > ç‚¹å¯¹å¯¹åè®®PPPï¼Œ802.11(wifi)ï¼ŒEthernet

- **ç‰©ç†å±‚ï¼š**åœ¨çº¿è·¯ä¸Šä¼ é€’bitï¼ˆæä¾›ç›¸é‚»ä¸¤ç‚¹ï¼Œå°†æ•°å­—ä¿¡å·å’Œç‰©ç†ä¿¡å·ä¹‹é—´çš„ç›¸äº’è½¬æ¢ï¼‰

  > å‘é€ç«¯ï¼šä¸Šå±‚ä¼ ä¸‹æ¥çš„å¸§ï¼Œå˜ä¸ºç‰©ç†ä¿¡å·ï¼Œåœ¨ä»‹è´¨ä¸­è½¬æ’­ç»™å¯¹ç«¯ã€‚
  >
  > æ¥æ”¶ç«¯ï¼šå°†åª’ä½“ä¸­æ‰¿è½½çš„ç”µç£æ³¢æˆ–è€…å…‰ä¿¡å·è¿˜åŸå›æ•°å­—ä¿¡å·ã€‚





#### ISO/OSI å‚è€ƒæ¨¡å‹



- **è¡¨ç¤ºå±‚**ï¼šå…è®¸åº”ç”¨è§£é‡Šä¼ è¾“çš„æ•°æ®ã€‚egï¼šåŠ å¯†ï¼Œå‹ç¼©ï¼ŒåŠå…¶ç›¸å…³çš„è½¬æ¢
- **ä¼šè¯å±‚ï¼š**æ•°æ®äº¤æ¢çš„åŒæ­¥ï¼Œæ£€æŸ¥ç‚¹ï¼Œæ¢å¤ã€‚



äº’è”ç½‘åè®®æ ˆæ²¡æœ‰è¿™ä¸¤å±‚ï¼è¿™äº›æœåŠ¡ï¼Œå¦‚æœéœ€è¦çš„è¯ï¼Œå¿…é¡»è¢«**åº”ç”¨å®ç°**ã€‚





#### æœåŠ¡å’ŒæœåŠ¡è®¿é—®ç‚¹

- **æœåŠ¡ï¼ˆServiceï¼‰ï¼š**ä½å±‚å®ç°å‘ä¸Šå±‚å®ä½“æä¾›å®ƒä»¬ä¹‹é—´çš„é€šä¿¡èƒ½åŠ›
  - æœåŠ¡ç”¨æˆ·ï¼ˆService Userï¼‰
  - æœåŠ¡æä¾›è€…ï¼ˆService Providerï¼‰



- **åŸè¯­ï¼ˆPrimitiveï¼‰ï¼š**ä¸Šå±‚ä½¿ç”¨ä¸‹å±‚æœåŠ¡çš„å½¢å¼ï¼Œé«˜å±‚ä½¿ç”¨åº•å±‚æä¾›çš„æœåŠ¡ï¼Œä»¥åŠä½å±‚å‘é«˜å±‚æä¾›æœåŠ¡éƒ½æ˜¯é€šè¿‡æœåŠ¡è®¿é—®åŸè¯­æ¥è¿›è¡Œäº¤äº’çš„ --- å½¢å¼

  > æ¯”å¦‚ï¼šä¼ è¾“å±‚å‘åº”ç”¨ç¨‹æä¾›æœåŠ¡çš„å½¢å¼æ˜¯Socketï¼Œä¸Šå±‚å‘ä¸‹å±‚å‘é€SDUæ—¶ï¼Œè¿›è¡Œæ ‡æ³¨ã€‚åœ¨å¯¹ç­‰ç«¯ï¼Œä¸‹å±‚å‘ä¸Šå±‚æ ¹æ®æ ‡æ³¨ä¿¡æ¯é€‰æ‹©å¯¹åº”çš„åº”ç”¨æ¥æ”¶æ•°æ®



- **æœåŠ¡è®¿é—®ç‚¹SAPï¼ˆService Access Pointï¼‰ï¼š**ä¸Šå±‚ä½¿ç”¨ä¸‹å±‚æä¾›çš„æœåŠ¡é€šè¿‡å±‚é—´çš„æ¥å£â€”åœ°ç‚¹ï¼š
  - ä¸‹å±‚çš„ä¸€ä¸ªå®ä½“æ”¯æ’‘ç€ä¸Šå±‚çš„å¤šä¸ªå®ä½“ï¼ŒSAPæœ‰æ ‡å¿—ä¸åŒä¸Šå±‚å®ä½“çš„ä½œç”¨ã€‚
  - ä¾‹å­ï¼šä¼ è¾“å±‚çš„SAPï¼Œç«¯å£ï¼ˆPortï¼‰

![image-20250613113513040](D:\git_repository\cyber_security_learning\markdown_img\image-20250613113513040.png)



#### å°è£…å’Œè§£å°è£…

 

â€‹                                          ![image-20250613145928480](D:\git_repository\cyber_security_learning\markdown_img\image-20250613145928480.png)





ä»æºä¸»æœºåˆ°ç›®æ ‡ä¸»æœºå‘é€çš„æŠ¥æ–‡ï¼Œé€»è¾‘ä¸Šæ¥çœ‹ï¼Œæ˜¯åº”ç”¨è¿›ç¨‹**ç›´æ¥**å‘å¯¹ç«¯çš„åº”ç”¨è¿›ç¨‹å‘é€æŠ¥æ–‡ï¼Œä½†è¿™ä¸ªç›´æ¥æ˜¯è¦æ‰“ä¸Šå¼•å·çš„ã€‚æ˜¯é€»è¾‘ä¸Šé€šä¿¡çš„ã€‚çœ‹ä¼¼å¥½åƒæ˜¯å®¢æˆ·ç«¯æµè§ˆå™¨ç›´æ¥å‘ç»™webæœåŠ¡ç«¯è¯·æ±‚æŠ¥æ–‡ï¼ŒwebæœåŠ¡ç«¯å‘å®¢æˆ·ç«¯è¿”å›å“åº”æŠ¥æ–‡ã€‚å¥½åƒæ˜¯å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›´æ¥é€šä¿¡ï¼Œä½†æ˜¯å®é™…ä¸Šmessageæ˜¯ä¸å¯ä»¥ç›´æ¥ä¼ é€ç»™ç›®æ ‡çš„åº”ç”¨è¿›ç¨‹çš„ã€‚

å®é™…ä¸Šæ˜¯é€šè¿‡å±‚é—´çš„æ¥å£ï¼Œå€ŸåŠ©äºä¸‹å±‚æä¾›çš„æœåŠ¡æ¥å®ç°çš„ã€‚

ä¹Ÿå°±æ˜¯æºä¸»æœºçš„åº”ç”¨å±‚å°†messageå‘é€ç»™ä¸‹å±‚çš„ä¼ è¾“å±‚ï¼Œä¼ è¾“å±‚åœ¨SDUåŸºç¡€ä¸Šï¼ŒåŠ ä¸Šæœ¬å±‚çš„æ§åˆ¶ä¿¡æ¯å¤´ï¼Œç”Ÿæˆæœ¬å±‚çš„PDUã€‚åœ¨ä¼ è¾“å±‚å«åšæŠ¥æ–‡æ®µsegmentã€‚

æŠ¥æ–‡æ®µä¹Ÿæ— æ³•ç›´æ¥ä¼ è¾“ç»™å¯¹ç«¯çš„ä¼ è¾“å±‚å®ä½“ã€‚å› æ­¤è¦é€šè¿‡å±‚é—´çš„æ¥å£å€ŸåŠ©äºä¸‹å±‚çš„ç½‘ç»œå±‚çš„æœåŠ¡å®ç°ã€‚æ‰€ä»¥è¦å°†æ•°æ®å‘é€ç½‘ç»œå±‚ï¼Œç½‘ç»œå±‚æ”¶åˆ°æŠ¥æ–‡åï¼ŒåŠ ä¸Šæœ¬å±‚çš„å¤´éƒ¨æ§åˆ¶ä¿¡æ¯ï¼ˆæºIPï¼Œç›®æ ‡IPç­‰æ•°æ®ï¼‰ï¼Œç”Ÿæˆæœ¬å±‚çš„PDUï¼Œä¹Ÿå°±æ˜¯åˆ†ç»„ï¼ˆPackageï¼‰ã€‚

> å¤´éƒ¨ä¿¡æ¯æ˜¯ä¸Šå±‚ä¼ ä¸‹æ¥çš„ICIï¼Œé€šè¿‡è§£æè½¬æ¢ç”Ÿæˆæœ¬å±‚çš„å¤´éƒ¨æ§åˆ¶ä¿¡æ¯

ç½‘ç»œå±‚ä¹Ÿå¯èƒ½æ— æ³•ç›´æ¥ä¼ è¾“ç»™å¯¹ç«¯çš„ç½‘ç»œå±‚å®ä½“ï¼Œå› æ­¤è¦é€šè¿‡å±‚é—´çš„æ¥å£å€ŸåŠ©äºä¸‹å±‚çš„æ•°æ®é“¾è·¯å±‚çš„æœåŠ¡å®ç°ã€‚æ‰€ä»¥è¿˜è¦å°†æ•°æ®å‘é€ç»™é“¾è·¯å±‚ï¼Œåœ¨é“¾è·¯å±‚æ”¶åˆ°æŠ¥æ–‡åï¼ŒåŠ ä¸Šæœ¬å±‚çš„å¤´éƒ¨ä¿¡æ¯ï¼ˆæºMACåœ°å€ï¼Œç›®æ ‡MACåœ°å€ï¼‰ï¼Œç”Ÿæˆæœ¬å±‚çš„PDUï¼Œä¹Ÿå°±æ˜¯åˆ†ç»„ï¼ˆå¸§ï¼‰ã€‚

ç‰©ç†å±‚æ”¶åˆ°é“¾è·¯å±‚ä¼ ä¸‹çš„æ•°æ®åï¼Œå°†æ•°å­—ä¿¡å·è½¬æ¢ä¸ºç”µä¿¡å·æˆ–è€…å…‰ä¿¡å·ï¼Œä»è€Œé€šè¿‡åª’ä½“ä»‹è´¨ï¼Œå°†æ•°æ®å‘é€ç»™å¯¹ç«¯ã€‚

 











## æ›´æ”¹ç½‘å¡å â€” é…ç½®å¯åŠ¨é¡¹

Rocky9ä»¥ä¸Šï¼Œé»˜è®¤ä½¿ç”¨åŠŸèƒ½BLSï¼ˆBoot Loader Specificationï¼‰é…ç½®æ–¹å¼ï¼Œä¸ä¼šä½¿ç”¨ `/etc/default/grub` ä¸­çš„ `GRUB_CMDLINE_LINUX` å‚æ•°ã€‚



### ä»€ä¹ˆæ˜¯BLS

**BLS æ˜¯ä¸€å¥—æ ‡å‡†**ï¼Œç”±ç³»ç»Ÿå¼•å¯¼ç¨‹åºï¼ˆå¦‚ GRUBï¼‰ä½¿ç”¨ï¼Œç”¨æ¥ **ç®¡ç†æ¯ä¸ªå†…æ ¸å¯åŠ¨é¡¹çš„é…ç½®**ï¼Œä»¥ **æ–‡ä»¶å½¢å¼**å­˜å‚¨åœ¨ `/boot/loader/entries/` ç›®å½•ä¸‹ï¼Œæ¯ä¸€ä¸ªå¯åŠ¨é¡¹éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„ `.conf` æ–‡ä»¶ã€‚

> âœ… æœ¬è´¨ä¸Šï¼š
>  BLS æ˜¯ Linux æ–°çš„â€œå¯åŠ¨é…ç½®æ–¹å¼â€ï¼Œç›®çš„æ˜¯ **æ›´æ¨¡å—åŒ–ã€æ˜“äºè‡ªåŠ¨ç®¡ç†å’Œå‡çº§å†…æ ¸å¯åŠ¨é¡¹**ã€‚



### BLS ä¸ä¼ ç»Ÿ grub.cfg æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

| ç‰¹æ€§               | ä¼ ç»Ÿ grub.cfg                          | BLS æ¨¡å¼                                      |
| ------------------ | -------------------------------------- | --------------------------------------------- |
| å¯åŠ¨é¡¹é…ç½®å­˜å‚¨ä½ç½® | `/boot/grub2/grub.cfg`                 | `/boot/loader/entries/*.conf`                 |
| ç®¡ç†æ–¹å¼           | å…¨éƒ¨å†…æ ¸ç‰ˆæœ¬å…±äº«ä¸€ä¸ª grub.cfg          | æ¯ä¸ªå†…æ ¸ç‰ˆæœ¬éƒ½æœ‰ç‹¬ç«‹å¯åŠ¨é¡¹é…ç½®æ–‡ä»¶            |
| å‚æ•°è®¾ç½®æ–¹å¼       | `/etc/default/grub` + `grub2-mkconfig` | `.conf` æ–‡ä»¶ç›´æ¥å†™å…¥ `options=...` è¡Œ         |
| ä¼˜åŠ¿               | çµæ´»ä½†å®¹æ˜“ä¹±                           | æ¨¡å—åŒ–ã€é€‚åˆè‡ªåŠ¨æ›´æ–°ï¼ˆå¦‚ dnf install kernelï¼‰ |
| æ˜¯å¦ä½¿ç”¨ BLS       | `GRUB_ENABLE_BLSCFG=true` æ—¶å¯ç”¨       | å¦æ—¶ç”¨ä¼ ç»Ÿ grub.cfg                           |



### ä¸€ä¸ªå…¸å‹çš„ BLS å¯åŠ¨é¡¹æ–‡ä»¶ï¼ˆç¤ºä¾‹ï¼‰

è·¯å¾„ï¼š`/boot/loader/entries/rocky-5.14.0-427.el9.x86_64.conf`

```ini
title Rocky Linux (5.14.0-427.el9.x86_64) 9.4
version 5.14.0-427.el9.x86_64
linux /vmlinuz-5.14.0-427.el9.x86_64
initrd /initramfs-5.14.0-427.el9.x86_64.img
options root=/dev/mapper/rl-root ro crashkernel=auto net.ifnames=0 biosdevname=0 quiet
```

- `title`ï¼šæ˜¾ç¤ºåœ¨å¼•å¯¼èœå•ä¸­çš„åç§°
- `linux`ï¼šå†…æ ¸é•œåƒè·¯å¾„
- `initrd`ï¼šå†…æ ¸åˆå§‹æ–‡ä»¶ç³»ç»Ÿ
- `options`ï¼šå†…æ ¸å¯åŠ¨å‚æ•° â† å°±æ˜¯ä½ è¦åŠ  `net.ifnames=0 biosdevname=0` çš„åœ°æ–¹ï¼





### BLSç›¸å…³æ“ä½œ

#### æ£€æŸ¥æ˜¯å¦å¯ç”¨ BLS æ¨¡å¼

```bash
cat /etc/default/grub | grep GRUB_ENABLE_BLSCFG
```

ä¸º `true` è¡¨ç¤ºå¯ç”¨äº† BLS



#### ä¸´æ—¶ä¿®æ”¹å†…æ ¸å‚æ•°ï¼ˆä¸å»ºè®®ï¼‰

ç¼–è¾‘å½“å‰é»˜è®¤å†…æ ¸çš„å¯åŠ¨é¡¹ï¼š

```bash
vim /boot/loader/entries/xxx.conf
```

åœ¨ `options=` è¡Œå°¾åŠ ä¸Šä½ çš„å‚æ•°



#### æ°¸ä¹…å…³é—­ BLS

```bash
sed -i 's/GRUB_ENABLE_BLSCFG=true/GRUB_ENABLE_BLSCFG=false/' /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg
```





#### ç¡®è®¤å½“å‰å†…æ ¸å‚æ•°æ˜¯å¦ç”Ÿæ•ˆ

```bash
# æŸ¥çœ‹/proc/cmdline
[root@localhost ~]# cat /proc/cmdline 
BOOT_IMAGE=/vmlinuz-5.14.0-427.13.1.el9_4.x86_64 root=/dev/mapper/rl-root ro crashkernel=1G-4G:192M,4G-64G:256M,64G-:512M resume=/dev/mapper/rl-swap rd.lvm.lv=rl/root rd.lvm.lv=rl/swap rhgb quiet net.ifnames=0 biosdevname=0
```



## é…ç½®é™æ€IP â€” é…ç½®ç½‘ç»œæœåŠ¡



### Rocky

**å…¼å®¹æ€§è¯´æ˜ï¼š**

| ç³»ç»Ÿç‰ˆæœ¬      | é»˜è®¤æ–¹å¼                         | æ˜¯å¦å…¼å®¹ ifcfg-* | å»ºè®®           |
| ------------- | -------------------------------- | ---------------- | -------------- |
| CentOS 7      | NetworkManager + network-scripts | âœ…                | å¯ç»§ç»­ä½¿ç”¨è„šæœ¬ |
| Rocky 8       | NetworkManager + è„šæœ¬å…¼å®¹æ¨¡å¼    | âœ…                | é€æ­¥è¿‡æ¸¡       |
| Rocky 9/RHEL9 | NetworkManager + `.nmconnection` | âš ï¸ï¼ˆéƒ¨åˆ†å…¼å®¹ï¼‰    | æ¨èå…¨é¢è¿ç§»   |



**NetworkManageré™æ€IPçš„`.nmconnection`æ–‡ä»¶é…ç½®**

```bash
[connection]
id=eth0
uuid=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx   # uuidgenç”Ÿæˆï¼Œä½œä¸ºç½‘å¡å”¯ä¸€æ ‡è¯†
type=ethernet
interface-name=eth0
autoconnect=true

[ethernet]
mac-address-blacklist=

[ipv4]
method=manual
address1=192.168.1.100/24,192.168.1.1        # é…ç½®é™æ€IPå’Œç½‘å…³
dns=8.8.8.8;114.114.114.114;
dns-search=
may-fail=false

[ipv6]
method=ignore             # ç¦ç”¨ipv6
```

```bash
nmcli conn reload
nmcli conn up eth0   # å¯ç”¨é…ç½®
```



- NetworkManagerå®¢æˆ·ç«¯å·¥å…· â€” nmcliï¼ˆåŠŸèƒ½å¼ºå¤§ï¼Œå¯ä»¥é€šè¿‡å®¢æˆ·ç«¯å·¥å…·ä¿®æ”¹ç½‘ç»œé…ç½®ï¼‰



### Ubuntu

- **Netplan æ˜¯ Ubuntu çš„ç»Ÿä¸€ç½‘ç»œé…ç½®å‰ç«¯**

- ç”¨æˆ·åªéœ€è¦ç¼–å†™ **YAML æ–‡ä»¶**ï¼ˆä½ç½®ï¼š`/etc/netplan/*.yaml`ï¼‰

- ç„¶åè¿è¡Œï¼š

```bash
sudo netplan apply
```

- Netplan ä¼šæ ¹æ® YAML ä¸­æŒ‡å®šçš„ `renderer` å­—æ®µï¼š

  - å¦‚æœæ˜¯ `NetworkManager`ï¼š
    - å°±æŠŠé…ç½®â€œä¼ é€’â€ç»™ NetworkManagerï¼ˆé€šè¿‡ D-Busï¼Œ**ä¸ä¼šç”Ÿæˆ .nmconnection æ–‡ä»¶**ï¼‰

  - å¦‚æœæ˜¯ `systemd-networkd`ï¼š
    - å°±è‡ªåŠ¨ç”Ÿæˆ `.network` æ–‡ä»¶ï¼Œæ”¾åœ¨ `/run/systemd/network/` ä¸‹ï¼ˆ**ä¸æ˜¯ /etc/systemd/network/**ï¼‰



- Netplan æœ¬èº« **ä¸è´Ÿè´£ç®¡ç†ç½‘å¡**ï¼Œå®ƒåªæ˜¯ **ç¿»è¯‘å™¨**ï¼ŒçœŸæ­£è´Ÿè´£ç®¡ç†çš„æ˜¯ï¼š
  - `systemd-networkd`ï¼ˆè½»é‡ï¼‰
  - `NetworkManager`ï¼ˆåŠŸèƒ½å¤šï¼Œå¦‚ Wi-Fiã€VPNï¼‰





#### NetworkManager

Netplanä¼šæŠŠé…ç½®â€œä¼ é€’â€ç»™ NetworkManagerï¼ˆé€šè¿‡ D-Busï¼ˆä¸€ç§IPCé€šä¿¡æœºåˆ¶ï¼‰ï¼Œ**ä¸ä¼šç”Ÿæˆ .nmconnection æ–‡ä»¶**ï¼‰



#### systemd-networkd

ç”±netplanè‡ªåŠ¨ç”Ÿæˆ

```bash
/run/systemd/network/10-netplan-eth0.network
```



- systemd-networkçš„å®¢æˆ·ç«¯å·¥å…· â€” networkctlï¼ˆåªè¯»ï¼‰
  - `systemd-networkd` çš„é…ç½®æ˜¯é€šè¿‡ç¼–å†™é…ç½®æ–‡ä»¶å®Œæˆçš„ï¼š
  - é…ç½®è·¯å¾„ï¼š`/etc/systemd/network`
    - `*.netdev`ï¼šå®šä¹‰è™šæ‹Ÿè®¾å¤‡ï¼ˆå¦‚ bridge, bond, vlanï¼‰
    - `*.network`ï¼šå®šä¹‰ç½‘ç»œæ¥å£é…ç½®ï¼ˆIPåœ°å€ã€è·¯ç”±ã€DNSç­‰ï¼‰
    - `*.link`ï¼šå®šä¹‰æ¥å£å‘½åå’Œå±æ€§ï¼ˆMAC åœ°å€ç­–ç•¥ç­‰ï¼‰









## HTTPåè®®

### HTTPåè®®ä»‹ç»

HTTPï¼šï¼ˆHyperText Transfer Protocolï¼‰è¶…æ–‡æœ¬ä¼ è¾“åè®®

HTTP æ˜¯ä¸€ä¸ªå·¥ä½œåœ¨åº”ç”¨å±‚çš„é€šä¿¡åè®®ï¼Œå®ƒå…è®¸å°†è¶…æ–‡æœ¬æ ‡è®°è¯­è¨€ï¼ˆHTMLï¼‰æ–‡æ¡£ä» WEB æœåŠ¡å™¨ä¼ é€åˆ° å®¢æˆ·ç«¯çš„æµè§ˆå™¨





### HTTP åè®®ç‰ˆæœ¬å’Œå‘å±•å†å²









### Cookie ä¸ Session



#### Cookieçš„æ ¼å¼ä¸çº¦æŸ

Cookieæ˜¯å‰ç«¯ç¼–ç¨‹ä¸­ç»å¸¸ä½¿ç”¨çš„æ¦‚å¿µã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨cookieåˆ©ç”¨æµè§ˆå™¨å¸®åŠ©æˆ‘ä»¬å­˜æ”¾ç”¨æˆ·çš„ç›¸å…³çŠ¶æ€ä¿¡æ¯ï¼Œä¿å­˜ç”¨æˆ·å·²ç»åšäº†å“ªäº›äº‹æƒ…ã€‚

- Cookieçš„å·¥ä½œåŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

- Cookieçš„é™åˆ¶åˆæ˜¯ä»€ä¹ˆï¼Ÿ

- Sessionæ˜¯æœåŠ¡å™¨ç«¯æ‰€ç»´æŠ¤çš„ä¼šè¯çŠ¶æ€ï¼ŒSessionåˆæ€æ ·ä¸Cookieå…³è”èµ·æ¥ï¼Ÿ 





##### Cookieæ˜¯ä»€ä¹ˆï¼Ÿ

![image-20250618091730167](D:\git_repository\cyber_security_learning\markdown_img\image-20250618091730167.png)



**RFC6265ï¼ŒHTTP State Management Mechanism**



Cookieä¿æŒåœ¨å®¢æˆ·ç«¯ï¼Œç”±æµè§ˆå™¨ç»´æŠ¤ï¼ˆä½†æ˜¯æ˜¯ç”±æœåŠ¡ç«¯ç”Ÿæˆçš„ï¼‰ï¼Œè¡¨ç¤ºåº”ç”¨çŠ¶æ€çš„HTTPå¤´éƒ¨

- å­˜æ”¾åœ¨å†…å­˜æˆ–è€…ç£ç›˜ä¸­
- æœåŠ¡å™¨ç«¯ç”ŸæˆCookieåœ¨å“åº”ä¸­é€šè¿‡Set-Cookieå¤´éƒ¨å‘ŠçŸ¥å®¢æˆ·ç«¯ï¼ˆå…è®¸å¤šä¸ªSet-Cookieå¤´éƒ¨ä¼ é€’å¤šä¸ªå€¼ï¼‰
- å®¢æˆ·ç«¯å¾—åˆ°Cookieåï¼Œåç»­è¯·æ±‚éƒ½ä¼šè‡ªåŠ¨å°†Cookieå¤´éƒ¨æºå¸¦è‡³è¯·æ±‚ä¸­





##### Cookie ä¸ Set-Cookieå¤´éƒ¨çš„å®šä¹‰

Cookie å¤´éƒ¨ä¸­å¯ä»¥å­˜æ”¾å¤šä¸ª **name/value** åå€¼å¯¹

```haskell
cookie-header = "Cookie:" OWS cookie-string OWS
  cookie-string = cookie-pai r*( ";" SP cookie-pair )
  cookie-pair = cookie-name "=" cookie-value
```



Set-Cookieå¤´éƒ¨ä¸€æ¬¡åªèƒ½ä¼ é€’1ä¸ª **name/value** åå€¼å¯¹ï¼Œå“åº”ä¸­å¯ä»¥å«å¤šä¸ªå¤´éƒ¨

```haskell
set-cookie-header = "Set-Cookie:" SP set-cookie-string
  set-cookie-string = cookie-pair *( ";" SP cookie-av )
  cookie-pair = cookie-name "=" cookie-value
  cookie-av: æè¿° cookie-pair çš„å¯é€‰å±æ€§
```



æµè§ˆå™¨æŸ¥çœ‹Set-Cookie

![image-20250618093022285](D:\git_repository\cyber_security_learning\markdown_img\image-20250618093022285.png)



##### Set-Cookie ä¸­æè¿°cookie-pairçš„å±æ€§

![image-20250618093427872](D:\git_repository\cyber_security_learning\markdown_img\image-20250618093427872.png)



##### Cookie ä½¿ç”¨çš„é™åˆ¶

RFCè§„èŒƒå¯¹æµè§ˆå™¨ä½¿ç”¨Cookieçš„è¦æ±‚

- æ¯æ¡Cookieçš„é•¿åº¦ï¼ˆåŒ…æ‹¬ name, value ä»¥åŠæè¿°çš„å±æ€§ç­‰æ€»é•¿åº¦ï¼‰è‡³å°‘è¦æ”¯æŒè¾¾åˆ° 4KB
- æ¯ä¸ªåŸŸåä¸‹è‡³å°‘æ”¯æŒ50 ä¸ª Cookie
- è‡³å°‘è¦æ”¯æŒ 3000 ä¸ª Cookie



ä»£ç†æœåŠ¡å™¨ä¼ é€’Cookieæ—¶ä¼šæœ‰é™åˆ¶ï¼ˆNginxé»˜è®¤32kï¼‰



##### Cookie åœ¨åè®®è®¾è®¡ä¸Šçš„é—®é¢˜

- Cookieä¼šè¢«é™„åŠ åœ¨æ¯ä¸ªHTTPè¯·æ±‚ä¸­ï¼Œæ‰€ä»¥æ— å½¢ä¸­å¢åŠ äº†æµé‡
- ç”±äºåœ¨HTTPè¯·æ±‚ä¸­çš„ Cookie æ˜¯æ˜æ–‡ä¼ é€’çš„ï¼Œæ‰€ä»¥å®‰å…¨æ€§æˆé—®é¢˜ï¼ˆé™¤éç”¨HTTPSï¼‰
- Cookieçš„å¤§å°ä¸åº”è¶…è¿‡4KBï¼Œå› ä¸ºå¯¹äºå¤æ‚çš„å­˜å‚¨éœ€æ±‚æ¥è¯´æ˜¯ä¸å¤Ÿç”¨çš„ã€‚





#### Session åŠç¬¬ä¸‰æ–¹Cookieçš„å·¥ä½œåŸç†

##### ç™»å½•åœºæ™¯ä¸‹ Cookieä¸Sessionçš„å¸¸è§ç”¨æ³•

![image-20250618094437692](D:\git_repository\cyber_security_learning\markdown_img\image-20250618094437692.png)

- é¦–å…ˆç™»å½•è¯·æ±‚å‘èµ·ä¸€ä¸ªPOSTè¡¨å•çš„loginæ“ä½œã€‚
- æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œä»è¡¨å•ä¸­è¯»å–ç”¨æˆ·åå’Œå¯†ç ï¼Œå’ŒæŒä¹…åŒ–æ•°æ®ä¸­çš„æ•°æ®è¿›è¡Œæ¯”å¯¹ï¼Œæ¯”å¯¹é€šè¿‡åï¼ŒæŠŠç™»å½•çŠ¶æ€ç”Ÿæˆsessionï¼ˆè¿™ä¸ªsessionæ˜¯æœ‰æ—¶æ•ˆçš„ï¼‰ã€‚
- å°†æœ‰æ—¶æ•ˆçš„sessionæ•°æ®å†™å…¥å†…å­˜æ•°æ®åº“
- å°†sessionä¸­çš„session_IDåœ¨å“åº”ä¸­è¿”å›ç»™æµè§ˆå™¨ï¼ŒSESSIOINè¿”å›çš„æ–¹å¼æ˜¯Set-Cookie
- æµè§ˆå™¨åœ¨å®ƒçš„Storageä¸­ä¿å­˜æ”¶åˆ°çš„Cookie
- æµè§ˆå™¨å‘èµ·çš„åç»­è¯·æ±‚ä¼šæºå¸¦è¿™ä¸ªCookieä¿¡æ¯
- æœåŠ¡å™¨æ”¶åˆ°æºå¸¦Cookieçš„ä¿¡æ¯åï¼Œä¼šåœ¨åç«¯è§£æCookieæºå¸¦çš„Session_IDï¼Œåˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦æ˜¯ç™»å½•çš„ï¼Œå¦‚æœåˆ¤æ–­æˆåŠŸï¼Œåˆ™æ‰§è¡Œè¯¥ç”¨æˆ·çš„ç›¸å…³ä¸šåŠ¡ï¼Œå¹¶å°†ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚

| æ­¥éª¤                                    | å»ºè®®æˆ–è¡¥å……                                                   |
| --------------------------------------- | ------------------------------------------------------------ |
| 1. ç”¨æˆ·å‘é€ POST /login è¯·æ±‚            | å¯ä»¥å¸¦è¡¨å•æˆ– JSON æ ¼å¼ç™»å½•ä¿¡æ¯                               |
| 2. æœåŠ¡ç«¯è¯»å–ç”¨æˆ·åå¯†ç ï¼Œä¸æŒä¹…åŒ–åº“æ¯”å¯¹ | å®é™…ä¸Šå¯ä½¿ç”¨æ•°æ®åº“æˆ–è®¤è¯ä¸­å¿ƒï¼ˆå¦‚ LDAPï¼‰                      |
| 3. éªŒè¯é€šè¿‡ï¼Œç”Ÿæˆ sessionï¼ˆå«æœ‰æ•ˆæœŸï¼‰   | é€šå¸¸ `session = { user_id, expires_at, ... }`                |
| 4. å°† session å­˜å…¥â€œå†…å­˜æ•°æ®åº“â€          | é€šå¸¸æ˜¯ Redisï¼Œæˆ–è€…å†…å­˜ hashmapï¼ˆå¦‚ Java `HttpSession`ï¼‰      |
| 5. è¿”å› Set-Cookieï¼Œè®¾ç½® `session_id`   | ç¤ºä¾‹ï¼š`Set-Cookie: session=abc123; Path=/; HttpOnly; Secure` |
| 6. æµè§ˆå™¨æ¥æ”¶å¹¶ä¿å­˜ Cookie              | æµè§ˆå™¨è‡ªåŠ¨ä¿å­˜ï¼Œå¹¶æ ¹æ® Path/Domain æ§åˆ¶ä½•æ—¶å‘é€              |
| 7. åç»­è¯·æ±‚è‡ªåŠ¨å¸¦ä¸Š Cookie              | æµè§ˆå™¨è‡ªåŠ¨åŠ ä¸Š `Cookie: session=abc123`                      |
| 8. æœåŠ¡ç«¯è¯»å– Cookie å¹¶éªŒè¯ session     | æŸ¥ Redis åˆ¤æ–­ session æ˜¯å¦å­˜åœ¨ã€æ˜¯å¦è¿‡æœŸ                     |
| 9. æ‰§è¡Œä¸šåŠ¡å¹¶è¿”å›ç»“æœ                   | æ­¤æ—¶è¯´æ˜ç”¨æˆ·å·²è®¤è¯ï¼ŒæŒ‰æƒé™æ‰§è¡Œå¯¹åº”ä¸šåŠ¡                       |











## Webç«™ç‚¹ç¯å¢ƒéƒ¨ç½²



### å¸¸è§WebæœåŠ¡ä»‹ç»











# ç¬¬å››å¤©

## æ–‡ä»¶ç³»ç»Ÿ

**æ–‡ä»¶å†…éƒ¨çš„æ•°æ®åº”è¯¥æ€æ ·ç»„ç»‡èµ·æ¥**

æ— ç»“æ„æ–‡ä»¶ï¼ˆå¦‚æ–‡æœ¬æ–‡ä»¶ï¼‰- ç”±ä¸€äº›äºŒè¿›åˆ¶æˆ–å­—ç¬¦æµç»„æˆï¼Œåˆç§°ä¸ºâ€œæµå¼æ–‡ä»¶â€

æœ‰ç»“æ„æ–‡ä»¶ï¼ˆå¦‚æ•°æ®åº“è¡¨ï¼‰- ç”±ä¸€ç»„ç›¸ä¼¼çš„è®°å½•ç»„æˆï¼Œåˆç§°ä¸ºâ€œè®°å½•å¼æ–‡ä»¶â€

- å…¶ä¸­è®°å½•æ˜¯ä¸€ç»„ç›¸å…³æ•°æ®é¡¹(field)çš„é›†åˆï¼Œæ•°æ®é¡¹æ˜¯æ–‡ä»¶ç³»ç»Ÿçš„åŸºæœ¬å•ä½
- è®°å½•é—´å…·æœ‰ç›¸ä¼¼æ€§
- æ•°æ®é¡¹æ˜¯æ–‡ä»¶ç³»ç»Ÿæœ€åŸºæœ¬çš„æ•°æ®å•ä½
- ç›®å½•å…¶å®æ˜¯ä¸€ç§ç‰¹æ®Šçš„æœ‰ç»“æ„æ–‡ä»¶ï¼ˆç”±è®°å½•ç»„æˆ ï¼‰

### ç›®å½•

ç›®å½•å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„æ–‡ä»¶ï¼Œå…¶å†…å®¹æ˜¯ä¸€ä¸ªä¸ªâ€œç›®å½•é¡¹è®°å½•â€ï¼ˆdirectory entriesï¼‰ç»„æˆçš„ç»“æ„æ•°ç»„ï¼Œç”¨äºè¡¨ç¤ºâ€œæ–‡ä»¶å â†’ inodeå·â€çš„æ˜ å°„å…³ç³»ã€‚



#### ç›®å½•é¡¹ï¼ˆdirectory entryï¼‰çš„åŸºæœ¬ç»„æˆ

ä»¥ **ext2/ext3/ext4 æ–‡ä»¶ç³»ç»Ÿ**ä¸ºä¾‹ï¼Œæ¯ä¸ªç›®å½•é¡¹ï¼ˆ`struct ext4_dir_entry`ï¼‰ä¸€èˆ¬åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µå      | è¯´æ˜                               |
| ----------- | ---------------------------------- |
| `inode`     | å¯¹åº”æ–‡ä»¶çš„ inode ç¼–å·ï¼ˆ`inum`ï¼‰    |
| `rec_len`   | å½“å‰ç›®å½•é¡¹å ç”¨çš„æ€»å­—èŠ‚æ•°ï¼ˆå«å¡«å……ï¼‰ |
| `name_len`  | æ–‡ä»¶åçš„é•¿åº¦                       |
| `file_type` | æ–‡ä»¶ç±»å‹ï¼ˆå¦‚æ™®é€šæ–‡ä»¶/ç›®å½•/é“¾æ¥ï¼‰   |
| `name`      | æ–‡ä»¶åå­—ç¬¦ä¸²ï¼ˆä¸å«ç»“æŸç¬¦ `\\0`ï¼‰   |



#### ç¤ºä¾‹ç»“æ„ä½“ï¼ˆext4ï¼‰

```C
struct ext4_dir_entry {
    __le32 inode;        // 4 bytes
    __le16 rec_len;      // 2 bytesï¼šå½“å‰ç›®å½•é¡¹æ€»é•¿åº¦
    __u8   name_len;     // 1 byteï¼šæ–‡ä»¶åé•¿åº¦
    __u8   file_type;    // 1 byteï¼šæ–‡ä»¶ç±»å‹ï¼ˆext4 ä¸“æœ‰ï¼‰
    char   name[];       // ä¸å®šé•¿ï¼šæ–‡ä»¶åï¼ˆä¸å« '\\0' ç»“å°¾ï¼‰
};
```

 **å­—æ®µè§£æè¯´æ˜ï¼š**

1. **`inode`ï¼ˆinumï¼‰**

- è¡¨ç¤ºè¯¥æ–‡ä»¶/ç›®å½•å¯¹åº”çš„ inode ç¼–å·
- æ“ä½œç³»ç»Ÿå¯ç”¨å®ƒè®¿é—®è¯¥æ–‡ä»¶çš„å…·ä½“å…ƒä¿¡æ¯

2. **`rec_len`ï¼ˆrecord lengthï¼‰**

- å½“å‰ç›®å½•é¡¹åœ¨ç›®å½•æ–‡ä»¶ä¸­å®é™…å æ®çš„æ€»å­—èŠ‚æ•°
- ç”±äºæ–‡ä»¶åé•¿åº¦å¯å˜ï¼Œä¸ºäº†ä¿æŒå¯¹é½ï¼Œrec_len é€šå¸¸ä¼š > å®é™…æ‰€éœ€ç©ºé—´ï¼ˆå†…å«å¡«å……ï¼‰

3. **`name_len`**

- å®é™…æ–‡ä»¶åçš„é•¿åº¦ï¼Œå•ä½æ˜¯å­—èŠ‚
- ä¸åŒ…æ‹¬ `\\0` ç»“å°¾å­—ç¬¦

4. **`file_type`ï¼ˆext4 ä¸“æœ‰ï¼Œext2/3 ä¸ä¸€å®šæœ‰ï¼‰**

- è¡¨ç¤ºè¯¥ç›®å½•é¡¹æ˜¯æ™®é€šæ–‡ä»¶ã€ç›®å½•ã€ç¬¦å·é“¾æ¥ç­‰
- ç±»å‹ä»£ç ä¾‹å¦‚ï¼š
  - `1`ï¼šæ™®é€šæ–‡ä»¶
  - `2`ï¼šç›®å½•
  - `7`ï¼šsocketï¼ˆUnix åŸŸï¼‰

5. **`name[]`**

- å­—ç¬¦ä¸²å½¢å¼çš„æ–‡ä»¶å
- ç´§è·Ÿåœ¨ç»“æ„ä½“åé¢ï¼Œ**å˜é•¿å­—æ®µ**



#### ç¤ºä¾‹ï¼šç›®å½•ç»“æ„ä¸­çš„è®°å½•å†…å®¹ï¼ˆå‡è®¾æ˜¯ ext4ï¼‰

ä¸€ä¸ªç›®å½•æ–‡ä»¶å†…å®¹ç¤ºä¾‹ï¼ˆåå…­è¿›åˆ¶ï¼‰å¯è§£æå‡ºå¦‚ä¸‹å†…å®¹ï¼š

| inode | rec_len | name_len | file_type | name  |
| ----- | ------- | -------- | --------- | ----- |
| 12    | 12      | 1        | 2         | .     |
| 2     | 12      | 2        | 2         | ..    |
| 1002  | 24      | 5        | 1         | readm |

ğŸ‘‰ è¯´æ˜ï¼š

- `.` è¡¨ç¤ºå½“å‰ç›®å½•
- `..` è¡¨ç¤ºä¸Šçº§ç›®å½•
- `readm` æ˜¯æ™®é€šæ–‡ä»¶ï¼ˆå®é™…æ˜¯ `readme`ï¼Œå› å¯¹é½å¯èƒ½è¢«æˆªæ–­æ˜¾ç¤ºï¼‰



#### å¦‚ä½•æ‰‹åŠ¨ç”¨ `hexdump` åˆ†æ ext4 çš„ç›®å½•ç»“æ„

**æ•´ä½“æµç¨‹æ¦‚è§ˆ**

1. æ‰¾åˆ°ç›®æ ‡ç›®å½•å¯¹åº”çš„ inodeï¼ˆä½¿ç”¨ `debugfs`ï¼‰
2. è·å–è¯¥ inode æŒ‡å‘çš„æ•°æ®å—åœ°å€
3. ä»è®¾å¤‡ä¸­æå–å¯¹åº”æ•°æ®å—å†…å®¹
4. ç”¨ `hexdump` æŸ¥çœ‹ï¼Œå¹¶æ‰‹åŠ¨è§£æç›®å½•é¡¹ç»“æ„



##### å®éªŒæ­¥éª¤è¯¦è§£

> å‡è®¾æˆ‘ä»¬çš„æŒ‚è½½è®¾å¤‡æ˜¯ `/dev/vda1`ï¼ŒæŒ‚è½½ç‚¹ä¸º `/`ï¼Œè¦åˆ†æçš„ç›®å½•ä¸º `/home`

**ç¬¬ 1 æ­¥ï¼šè¿›å…¥ debugfs æŸ¥çœ‹ç›®æ ‡ç›®å½• inode ä¿¡æ¯**

```bash
debugfs /dev/vda1
```

è¿›å…¥äº¤äº’åï¼š

```bash
debugfs: stat /home
```

```bash
Inode: 1518   Type: directory    Mode:  0755   Flags: 0x80000
Generation: 2375206807    Version: 0x00000000:00000002
User:     0   Group:     0   Project:     0   Size: 4096
File ACL: 0
Links: 3   Blockcount: 8
Fragment:  Address: 0    Number: 0    Size: 0
 ctime: 0x64be8b93:0a7d8c00 -- Mon Jul 24 14:32:51 2023
 atime: 0x683ca913:e6065518 -- Sun Jun  1 19:25:07 2025
 mtime: 0x64be8b93:0a7d8c00 -- Mon Jul 24 14:32:51 2023
crtime: 0x64ae0bd7:e5c38f74 -- Wed Jul 12 02:11:35 2023
Size of extra inode fields: 32
Inode checksum: 0xeeec52cf
EXTENTS:
(0):16735
```

**è¯¦ç»†è§£é‡Šï¼š**

ğŸ“Œ `EXTENTS:` æ˜¯ ext4 æ–‡ä»¶ç³»ç»Ÿçš„å—å¯»å€æ–¹å¼ä¹‹ä¸€

- ext2/ext3 ä½¿ç”¨ã€Œç›´æ¥å— + é—´æ¥å—ã€æ–¹å¼ï¼ˆæœ€å¤š 15 ä¸ªæŒ‡é’ˆï¼‰
- ext4 é»˜è®¤ä½¿ç”¨ **Extent treeï¼ˆæ‰©å±•æ ‘ï¼‰**ï¼Œæ›´é€‚åˆå¤§æ–‡ä»¶ã€é«˜è¿ç»­æ€§

ğŸ“Œ `(0):16735` çš„å«ä¹‰æ˜¯ï¼š

- `0` è¡¨ç¤ºè¿™æ˜¯ç¬¬ 0 ä¸ª extentï¼ˆèµ·å§‹åç§»å—å·ä¸º 0ï¼‰
- `16735` æ˜¯è¯¥ extent åœ¨ç‰©ç†è®¾å¤‡ä¸­çš„ç¬¬ä¸€ä¸ªå®é™… **ç‰©ç†å—å·**



**ç¬¬ 2 æ­¥ï¼šæ ¹æ®ä¸Šæ–‡çš„è¾“å‡ºï¼Œå¯ä»¥å¾—åˆ°å¦‚ä¸‹ä¿¡æ¯**

```ABAP
è¿™æ˜¯ä¸€ä¸ª ext4 æ–‡ä»¶ç³»ç»Ÿ
è¯¥ inode ä½¿ç”¨ Extentï¼ˆæ‰©å±•å—æ˜ å°„ï¼‰æ ¼å¼
ç¬¬ä¸€ä¸ªæ•°æ®å—å·æ˜¯ 16735

å­—èŠ‚åç§» = 16735 Ã— 4096 = 68575232 å­—èŠ‚
```



**ç¬¬ 3 æ­¥ï¼šä»è®¾å¤‡ä¸­æå–è¿™ä¸ªæ•°æ®å—**

```bash
dd if=/dev/vda1 bs=4096 skip=16735 count=1 of=dirblock.bin
```



**ç¬¬ 4 æ­¥ï¼šä½¿ç”¨ hexdump åˆ†æç›®å½•å—å†…å®¹**

```bash
hexdump -C dirblock.bin | less
```

```bash
00000000  ee 05 00 00 0c 00 01 02  2e 00 00 00 02 00 00 00  |................|
00000010  0c 00 02 02 2e 2e 00 00  01 f0 03 00 dc 0f 06 02  |................|
00000020  75 62 75 6e 74 75 00 00  00 00 00 00 00 00 00 00  |ubuntu..........|
00000030  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00  |................|
*
00000ff0  00 00 00 00 00 00 00 00  0c 00 00 de 14 63 1c 37  |.............c.7|
00001000
```



##### æ‰‹åŠ¨è§£æè§„åˆ™ï¼ˆåŸºäº `ext4_dir_entry`ï¼‰

æ¯ä¸ªç›®å½•é¡¹æ ¼å¼å¦‚ä¸‹ï¼š

| å­—èŠ‚åç§» | å­—æ®µå    | é•¿åº¦   | å«ä¹‰                             |
| -------- | --------- | ------ | -------------------------------- |
| 0        | inode     | 4B     | æ–‡ä»¶/ç›®å½•çš„ inode ç¼–å·           |
| 4        | rec_len   | 2B     | å½“å‰ç›®å½•é¡¹å ç”¨çš„æ€»é•¿åº¦           |
| 6        | name_len  | 1B     | æ–‡ä»¶åé•¿åº¦ï¼ˆä¸å«ç»“å°¾ï¼‰           |
| 7        | file_type | 1B     | æ–‡ä»¶ç±»å‹ï¼ˆ1: æ™®é€šæ–‡ä»¶, 2: ç›®å½•ï¼‰ |
| 8        | name      | N å­—èŠ‚ | æ–‡ä»¶åï¼ˆå˜é•¿ï¼‰                   |



**ç¤ºä¾‹è§£æ**

```bash
 01 f0 03 00 dc 0f 06 02  # 
 75 62 75 6e 74 75        # Ubuntu(æ–‡ä»¶å)
```

é€é¡¹è§£é‡Šï¼š

- `01 f0 03 00` â†’ `inode = 0x0003f001 = 258,049`
- `dc 0f` â†’ `rec_len = 0x0fdc = 4060`
- `06` â†’ name_len = 6ï¼ˆUbuntuï¼Œ6ä¸ªå­—ç¬¦ï¼‰
- `02` â†’ file_type = 2 ï¼ˆç›®å½•ï¼‰
- `2e` â†’ æ–‡ä»¶å = "."ï¼ˆASCIIï¼‰

```bash
[root@devops-custom ~]# ll -i /home
æ€»è®¡ 12
  1518 drwxr-xr-x  3 root   root   4096  7æœˆ 24  2023 ./
     2 drwxr-xr-x 19 root   root   4096  5æœˆ 26 08:53 ../
258049 drwxr-x--- 17 ubuntu ubuntu 4096  5æœˆ  4 12:53 ubuntu/
```



### ä»€ä¹ˆæ˜¯ Extentsï¼Ÿ

#### ä½¿ç”¨è€…ï¼šext4ã€xfsã€btrfs ç­‰ç°ä»£æ–‡ä»¶ç³»ç»Ÿ

âœ… å®šä¹‰ï¼š

> **Extent æ˜¯ä¸€ä¸ªç»“æ„ï¼šè¡¨ç¤ºâ€œæŸä¸ªé€»è¾‘å—èŒƒå›´ â†’ å¯¹åº”çš„ç‰©ç†å—èŒƒå›´â€æ˜ å°„ã€‚**
>  ç®€åŒ–å­˜å‚¨ï¼š**ä¸å­˜å‚¨æ¯ä¸ªå—åœ°å€ï¼Œè€Œæ˜¯å­˜ä¸€æ®µè¿ç»­å—çš„èµ·å§‹åœ°å€å’Œé•¿åº¦ã€‚**



Extent ç»“æ„ï¼ˆç®€åŒ–ç¤ºæ„ï¼‰

```C
struct ext4_extent {
  __le32 ee_block;      // æ–‡ä»¶ä¸­çš„èµ·å§‹é€»è¾‘å—å·
  __le16 ee_len;        // è¿ç»­å—æ•°é‡
  __le16 ee_start_hi;   // èµ·å§‹ç‰©ç†å—é«˜16ä½
  __le32 ee_start_lo;   // èµ·å§‹ç‰©ç†å—ä½32ä½
};
```

ä¸€ä¸ª extent å°±è¡¨ç¤ºï¼š

> â€œä»æ–‡ä»¶çš„ç¬¬ N ä¸ªå—å¼€å§‹ï¼Œæœ‰ X ä¸ªè¿ç»­å—ï¼Œåœ¨ç£ç›˜ä¸Šçš„èµ·å§‹ç‰©ç†å—å·æ˜¯ Yã€‚â€



**ä¸¾ä¾‹ï¼š**

å¦‚æœä¸€ä¸ªæ–‡ä»¶çš„å‰ 1 MB æ˜¯è¿ç»­çš„ï¼Œå®ƒåªéœ€è¦ä¸€ä¸ª extentï¼š

```C
(é€»è¾‘å—)0 â†’ 255  â†’ (ç‰©ç†å—) 5000 â†’ 5255
```

åªéœ€ä¸€æ¡è®°å½•ï¼Œè€Œæ—§å¼é—´æ¥å—éœ€è¦å†™ 256 ä¸ªæŒ‡é’ˆï¼



#### Extents ä¸ é—´æ¥ç´¢å¼•å—çš„åŒºåˆ«æ€»ç»“

| å¯¹æ¯”é¡¹           | Extents                      | é—´æ¥å—ç´¢å¼•               |
| ---------------- | ---------------------------- | ------------------------ |
| ä½¿ç”¨è€…           | ext4ï¼ˆé»˜è®¤ï¼‰ã€xfsã€btrfs     | ext2ã€ext3               |
| æ•°æ®ç»“æ„         | `é€»è¾‘èµ·ç‚¹ + é•¿åº¦ + ç‰©ç†èµ·ç‚¹` | ä¸€ä¸ªä¸ªæŒ‡é’ˆæ•°ç»„           |
| è®¿é—®æ•ˆç‡         | âœ… é«˜ï¼ŒæŸ¥ä¸€æ¬¡å°±æ˜¯ä¸€æ®µ         | âŒ æŸ¥å¤šæ¬¡ï¼ŒæŒ‡é’ˆè·³è½¬å¤š     |
| å¯¹è¿ç»­æ–‡ä»¶çš„æ•ˆç‡ | âœ… éå¸¸é«˜                     | âŒ æ•ˆç‡ä½ï¼Œæµªè´¹ç©ºé—´       |
| ç©ºé—´ä½¿ç”¨         | âœ… ç´§å‡‘ï¼Œä»…éœ€å°‘é‡å…ƒæ•°æ®       | âŒ å¤šçº§æŒ‡é’ˆå ç”¨å¤§é‡ç´¢å¼•å— |
| æ–‡ä»¶ç¢ç‰‡å¤„ç†     | âœ… å‡å°‘ç¢ç‰‡                   | âŒ å®¹æ˜“äº§ç”Ÿç¢ç‰‡           |
| æ”¯æŒæœ€å¤§æ–‡ä»¶å¤§å° | æ›´å¤§ï¼ˆæ”¯æŒ extent treeï¼‰     | è¾ƒå°ï¼Œå—é™äºæŒ‡é’ˆå±‚æ•°     |
| å…ƒæ•°æ®ç»´æŠ¤å¤æ‚åº¦ | è¾ƒå¤æ‚ï¼ˆæ ‘ç»“æ„ï¼‰             | ç®€å•ï¼ˆçº¿æ€§ç»“æ„ï¼‰         |



#### å››ã€Extent Treeï¼ˆæ‰©å±•æ ‘ï¼‰

å½“ä¸€ä¸ªæ–‡ä»¶åŒ…å«å¤šä¸ª extentï¼ˆä¸è¿ç»­å—ï¼‰æ—¶ï¼Œext4 ä¼šå°†è¿™äº› extents ç»„ç»‡ä¸ºä¸€æ£µ B+ æ ‘ï¼š

- inode ä¸­å­˜çš„æ˜¯ **Extent root**
- æ¯ä¸ªä¸­é—´èŠ‚ç‚¹ç§°ä¸º `index node`
- å¶å­èŠ‚ç‚¹æ˜¯ extent entry
- æ‰€ä»¥è¯»å–æ–‡ä»¶æ—¶ï¼šå…ˆæŸ¥æ ¹ â†’ ä¸­é—´ â†’ å¶ â†’ æ•°æ®å—

ğŸ“Œ å°±åƒ ext3 çš„ä¸‰çº§é—´æ¥å—ï¼Œä½†ä½¿ç”¨çš„æ˜¯ **B+ æ ‘ç»“æ„ï¼Œæ›´çµæ´»ã€æ•ˆç‡é«˜**



#### äº”ã€ä½ åœ¨ debugfs çœ‹åˆ°çš„ `(0):16735` æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

```C
EXTENTS:
(0):16735
```

è¡¨ç¤ºï¼š

- è¿™æ˜¯ extent æ ‘ä¸­çš„ç¬¬ 0 ä¸ªå¶èŠ‚ç‚¹
- å®ƒèµ·å§‹äºæ–‡ä»¶é€»è¾‘å—å· 0ï¼Œå¯¹åº”çš„ç£ç›˜ç‰©ç†å—å·ä¸º 16735
- å®ƒè¿˜åŒ…å«å¤šå°‘ä¸ªè¿ç»­å—ï¼Ÿä½ å¯ä»¥é€šè¿‡ `debugfs` çš„ `stat` çœ‹ `Blockcount`

> **é—´æ¥å—ç´¢å¼•æ˜¯â€œä¸€ä¸ªå—ä¸€ä¸ªæŒ‡é’ˆâ€ï¼Œè€Œ Extent æ˜¯â€œä¸€æ¡è®°å½•æ˜ å°„ä¸€æ•´æ®µå—â€ã€‚**
>  Ext4 ä½¿ç”¨ Extent æ˜¯ä¸ºäº†æ›´å¿«ã€æ›´èŠ‚çœã€æ›´é€‚åˆå¤§æ–‡ä»¶ï¼Œæ˜¯ç°ä»£æ–‡ä»¶ç³»ç»Ÿæ¼”è¿›çš„é‡è¦æ ‡å¿—ã€‚









### æ“ä½œç³»ç»Ÿä¸­é€šè¿‡æ–‡ä»¶è®¿é—®æ•°æ®çš„è¿‡ç¨‹(ç®€å•ç‰ˆ)

**å®é™…æµç¨‹å¦‚ä¸‹ï¼š**

1. **inode â†’ å—å·ï¼ˆç£ç›˜å—å·ï¼‰**
2. **æ–‡ä»¶ç³»ç»Ÿå±‚å°†å—å· â†’ é€»è¾‘æ‰‡åŒºå·**
3. **I/Oè°ƒåº¦å±‚è½¬åŒ–ä¸ºç‰©ç†è®¾å¤‡çš„æ‰‡åŒºè®¿é—®è¯·æ±‚**
4. **ç¡¬ç›˜æ§åˆ¶å™¨ï¼ˆå¦‚SATA/NVMeï¼‰æ”¶åˆ°è¯·æ±‚ â†’ è®¿é—®ç£ç›˜**

```css
[ inode ]
   |
   |â€”> ç›´æ¥å— â†’ [ ç‰©ç†å—åœ°å€(é€»è¾‘å—å·) ]
   |
   |â€”> é—´æ¥å— â†’ [ å—å·æ•°ç»„ ] â†’ [ å¤šä¸ªç‰©ç†å—åœ°å€ ]
                         â†“
                æ–‡ä»¶ç³»ç»Ÿè®¡ç®—åç§»ï¼ˆç‰©ç†å—å·->é€»è¾‘æ‰‡åŒºï¼‰
                         â†“
              è®¾å¤‡é©±åŠ¨æ¢ç®—ä¸ºæ‰‡åŒºåœ°å€ï¼ˆé€»è¾‘æ‰‡åŒº-> ç‰©ç†æ‰‡åŒºï¼‰
                         â†“
            ç¡¬ç›˜æ§åˆ¶å™¨è¯»å–ç£ç›˜æ‰‡åŒºçš„æ•°æ®
```

```ABAP
æ–‡ä»¶é€šè¿‡ inode ä¸­çš„æ˜ å°„ç»“æ„ï¼ˆå¦‚ extents æˆ–å—æŒ‡é’ˆï¼‰ï¼Œå°†è¿ç»­çš„é€»è¾‘å—å·æ˜ å°„ä¸ºä¸è¿ç»­çš„ç£ç›˜å—å·ã€‚æ–‡ä»¶ç³»ç»Ÿæ ¹æ®ç£ç›˜å—å·è®¡ç®—å‡ºå¯¹åº”çš„é€»è¾‘æ‰‡åŒºå·ï¼Œç”±å†…æ ¸å—è®¾å¤‡é©±åŠ¨å‘å‡º I/O è¯·æ±‚ï¼Œå†ç”±ç¡¬ç›˜æ§åˆ¶å™¨ï¼ˆå¦‚ SATAã€NVMeï¼‰å°†é€»è¾‘æ‰‡åŒºè½¬æ¢ä¸ºå®é™…ç‰©ç†æ‰‡åŒºæˆ– Flash é¡µé¢ï¼Œæœ€åè®¿é—®ç£ç›˜å®Œæˆæ•°æ®è¯»å–ã€‚
```





### è®¿é—®ä¸€ä¸ªæ–‡ä»¶æ—¶çš„å®Œæ•´è¿‡ç¨‹ï¼ˆä»¥ ext4 ä¸ºä¾‹ï¼‰

#### 1. **è·¯å¾„è§£æ â†’ æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶çš„ inode**

- **ä»æ ¹ç›®å½• `/` å¼€å§‹**ï¼Œé€å±‚è§£æè·¯å¾„ï¼š

  ```bash
  /home/zhangyifeng/secret.txt
  ```

- æ¯ä¸€å±‚ç›®å½•é¡¹ï¼ˆå¦‚ `home`ï¼‰æ˜¯ä¸€ä¸ª**ç›®å½•æ–‡ä»¶**ï¼Œå…¶å†…å®¹æ˜¯è‹¥å¹²ä¸ªç›®å½•é¡¹è®°å½•ï¼ˆå«å­æ–‡ä»¶/ç›®å½•çš„ inode ç¼–å· + åå­—ï¼‰ã€‚

- ç³»ç»Ÿä¼šï¼š

  - æ‰“å¼€ `/` å¯¹åº”çš„ inodeï¼Œè¯»å–å…¶æ•°æ®å—ï¼ˆå«ç›®å½•é¡¹ï¼‰
  - æ‰¾åˆ°åä¸º `home` çš„ç›®å½•é¡¹ï¼Œæå–å…¶ inode ç¼–å·
  - æ‰“å¼€ `home` çš„ inodeï¼Œé‡å¤ä¸Šè¿°æ“ä½œï¼Œç›´åˆ° `secret.txt` çš„ inode è¢«æ‰¾åˆ°

> ğŸ” è¿™ä¸ªè¿‡ç¨‹ç”¨åˆ°äº† `dentry` å’Œ `inode` ç¼“å­˜ï¼ˆslab æœºåˆ¶æå‡é€Ÿåº¦ï¼‰



#### 2. **è®¿é—®ç›®æ ‡æ–‡ä»¶ inode â†’ è·å–é€»è¾‘å—æ˜ å°„**

- æ‰¾åˆ° `secret.txt` çš„ inode åï¼Œè¯»å–å…¶ä¸­çš„ï¼š
  - æ–‡ä»¶å¤§å°ã€ç±»å‹ã€æƒé™ç­‰å…ƒæ•°æ®
  - æŒ‡å‘å†…å®¹æ•°æ®çš„å—æŒ‡é’ˆï¼ˆç›´æ¥å— / é—´æ¥å— / extentsï¼‰



#### 3. **æ–‡ä»¶ç³»ç»Ÿå±‚ï¼šé€»è¾‘å—å· â†’ ç£ç›˜å—å· â†’ é€»è¾‘æ‰‡åŒºå·**

- ä» inode å¾—åˆ°çš„â€œå—æŒ‡é’ˆâ€å…¶å®æ˜¯**ç£ç›˜å—å·**
- å°†ç£ç›˜å—å· Ã— å—å¤§å°ï¼ˆå¦‚ 4KBï¼‰ â†’ æ–‡ä»¶å†…å®¹åœ¨ç£ç›˜ä¸Šçš„åç§»åœ°å€ï¼ˆé€»è¾‘æ‰‡åŒºå·ï¼‰



#### 4. **å†…æ ¸å—è®¾å¤‡å±‚ï¼šæ„é€  bio è¯·æ±‚ï¼Œäº¤ç»™é©±åŠ¨**

- æ„é€  bio â†’ å˜æˆ I/O è¯·æ±‚ï¼ˆå¯èƒ½åˆå¹¶å¤šä¸ªï¼‰
- ä¼ é€’ç»™è®¾å¤‡é©±åŠ¨å±‚ï¼ˆå¦‚ `sd.c`ã€`nvme.c`ï¼‰



####  5. **ç¡¬ç›˜æ§åˆ¶å™¨ï¼šé€»è¾‘æ‰‡åŒº â†’ ç‰©ç†æ‰‡åŒº**

- æ§åˆ¶å™¨ï¼ˆSATA/NVMeï¼‰æ¥æ”¶åˆ°è¯·æ±‚åï¼š
  - å¦‚æœæ˜¯ HDDï¼šç›´æ¥è·³è½¬åˆ°æ‰‡åŒºè¯»å–
  - å¦‚æœæ˜¯ SSDï¼šFTL æœºåˆ¶æ˜ å°„åˆ° NAND Flash ä¸­çš„é¡µå—



#### 6. **è¿”å›æ•°æ®ç»™ç”¨æˆ·æ€ç¨‹åº**

- æ•°æ®å…ˆè¿›å…¥ **é¡µç¼“å­˜ï¼ˆPage Cacheï¼‰**
- ç„¶åé€šè¿‡ `read()` ç³»ç»Ÿè°ƒç”¨å°†æ•°æ®æ‹·è´ç»™ç”¨æˆ·ç©ºé—´







## buff/cache

### buff/cache çš„ç»„æˆï¼š

| ç±»åˆ«               | æè¿°                            | æ˜¯å¦åæ˜ åœ¨ meminfo ä¸­ï¼Ÿ         |
| ------------------ | ------------------------------- | ------------------------------- |
| âœ… **Page Cache**   | ç¼“å­˜ç£ç›˜æ–‡ä»¶å†…å®¹ï¼ˆæœ€ä¸»è¦éƒ¨åˆ†ï¼‰  | âŒ æ²¡æœ‰å•ç‹¬åˆ—å‡º                  |
| âœ… **Slab Cache**   | ç¼“å­˜å†…æ ¸ç»“æ„ä½“ï¼ˆinodeã€dentryï¼‰ | âœ… `SReclaimable` + `SUnreclaim` |
| âœ… **Buffer Cache** | å—è®¾å¤‡å…ƒæ•°æ®ç¼“å­˜                | âœ… `Buffers` å­—æ®µ                |





### æŸ¥çœ‹å®ƒä»¬çš„ç‹¬ç«‹å€¼ï¼ˆæ¥è‡ª /proc/meminfoï¼‰ï¼š

```bash
grep -E 'Buffers|Cached|Slab' /proc/meminfo
```

ä½ ä¼šçœ‹åˆ°ç±»ä¼¼ï¼š

```bash
Buffers:          20000 kB   # å—è®¾å¤‡ buffer cache
Cached:          300000 kB   # page cache
Slab:             97972 kB   # = SReclaimable + SUnreclaim
```

ç„¶åï¼š

```bash
buff/cache â‰ˆ Buffers + Cached + Slab
```

> **`Buffers` è¡¨ç¤ºå—è®¾å¤‡çš„å…ƒæ•°æ®ç¼“å­˜**ï¼Œæ¯”å¦‚ superblockã€inode bitmapã€block bitmapã€ç›®å½•é¡¹ç­‰ï¼Œè¿™äº›å±äºæ–‡ä»¶ç³»ç»Ÿçš„ç»“æ„å…ƒä¿¡æ¯ï¼Œä¸æ˜¯ç”¨æˆ·æ–‡ä»¶æ•°æ®æœ¬èº«ã€‚





### Slab

#### ä»€ä¹ˆæ˜¯ Slabï¼Ÿï¼ˆæ ¸å¿ƒæ¦‚å¿µï¼‰

**å®šä¹‰ï¼š**

**slab æ˜¯ç¼“å­˜æŸ¥æ‰¾æ–‡ä»¶æ‰€éœ€çš„ç»“æ„ä½“æ•°æ®ï¼ˆå¦‚ dentryã€inode ç­‰ï¼‰æ¥æå‡æ–‡ä»¶æŸ¥æ‰¾æ•ˆç‡**

> **Slab æ˜¯ Linux å†…æ ¸ç”¨äºç®¡ç†å†…å­˜å¯¹è±¡åˆ†é…çš„ä¸€ç§é«˜æ•ˆç¼“å­˜æœºåˆ¶ï¼Œ**
>  ä¸“é—¨ç”¨äºé‡å¤åˆ†é…/é‡Šæ”¾ç›¸åŒå¤§å°å’Œç»“æ„çš„å†…æ ¸å¯¹è±¡ã€‚

**ä¸¾ä¾‹ï¼š**

- `dentry`ï¼ˆç›®å½•é¡¹ç¼“å­˜ï¼‰
- `inode`ï¼ˆæ–‡ä»¶ inode ç¼“å­˜ï¼‰
- `vm_area_struct`ï¼ˆè¿›ç¨‹è™šæ‹Ÿå†…å­˜æ˜ å°„ï¼‰
- `ext4_inode_cache`ï¼ˆæ–‡ä»¶ç³»ç»Ÿä¸­çš„ inode ç¼“å­˜ï¼‰



#### Slabä½œç”¨çš„ä¸¾ä¾‹è¯´æ˜

```bash
ls /etc/
```

**è¿™ä¸ªå‘½ä»¤åœ¨èƒŒåä¼šï¼š**

1. æŸ¥ / â†’ æŸ¥æ‰¾ /etc çš„ dentry
2. å¦‚æœå·²ç»ç¼“å­˜ï¼ˆåœ¨ slab çš„ dentry_cache ä¸­ï¼‰ï¼Œç›´æ¥è¿”å›
3. ç„¶åè¯»å– /etc çš„ inodeï¼ˆä» inode_cache slabï¼‰
4. å±•ç¤ºå†…å®¹ï¼Œæ— éœ€å†æ¬¡ä»ç£ç›˜è¯»å–å…ƒä¿¡æ¯

â¡ï¸ **å¦‚æœè¿™äº›ç¼“å­˜éƒ½ä¸åœ¨ slab ä¸­ï¼Œå°±ä¼šï¼š**

- æŸ¥ç£ç›˜ inode è¡¨
- æŸ¥ç£ç›˜ç›®å½•é¡¹è¡¨
- å¢åŠ è®¿é—®å»¶è¿Ÿ



#### åˆ¤æ–­å“ªäº› slab å¯æ¸…ç†ï¼Ÿ

ä½ å¯ä»¥æ‰§è¡Œï¼š

```bash
grep -A 3 "slab_reclaimable" /proc/meminfo
```

- `SReclaimable`ï¼šå¯ä»¥å›æ”¶çš„ slabï¼ˆå¦‚ dentry/inodeï¼‰
- `SUnreclaim`ï¼šä¸å¯å›æ”¶ï¼ˆæ¯”å¦‚ anon_vmaã€vm_structï¼‰



#### å…³äºSlabç¼“å­˜çš„å®éªŒ

```bash
# æ¸…ç©ºæœªåˆ©ç”¨çš„slabç¼“å­˜
[root@devops-custom ~]# echo 3 > /proc/sys/vm/drop_caches

# æŸ¥çœ‹
[root@devops-custom ~]# grep -E 'dentry_cache|inode_cache' /proc/slabinfo | awk '{printf "  %-20s objs=%-10s size=%s\n", $1, $2, $8}'
  mqueue_inode_cache   objs=17         size=tunables
  ecryptfs_inode_cache objs=0          size=tunables
  fat_inode_cache      objs=21         size=tunables
  squashfs_inode_cache objs=622        size=tunables
  ext4_inode_cache     objs=1216       size=tunables       # è§‚å¯Ÿè¿™ä¸ªå€¼
  hugetlbfs_inode_cache objs=24         size=tunables
  sock_inode_cache     objs=855        size=tunables
  proc_inode_cache     objs=482        size=tunables
  shmem_inode_cache    objs=2282       size=tunables
  inode_cache          objs=16375      size=tunables
  
  
# è®¿é—®/bin
[root@devops-custom ~]# ls -l /bin/ > /dev/null

# å†æ¬¡æŸ¥çœ‹
[root@devops-custom ~]# grep -E 'dentry_cache|inode_cache' /proc/slabinfo | awk '{printf "  %-20s objs=%-10s size=%s\n", $1, $2, $8}'
  mqueue_inode_cache   objs=17         size=tunables
  ecryptfs_inode_cache objs=0          size=tunables
  fat_inode_cache      objs=21         size=tunables
  squashfs_inode_cache objs=622        size=tunables
  ext4_inode_cache     objs=2883       size=tunables    # æ˜æ˜¾å˜å¤šï¼Œå¤šäº†2883-1216=1667
  hugetlbfs_inode_cache objs=24         size=tunables
  sock_inode_cache     objs=855        size=tunables
  proc_inode_cache     objs=482        size=tunables
  shmem_inode_cache    objs=2282       size=tunables
  inode_cache          objs=16375      size=tunables
  
```









### **è¯»ç¼“å­˜ï¼ˆpage cacheï¼‰** ä¸ **å†™ç¼“å†²ï¼ˆwrite-back bufferï¼‰**

#### **è¯»æ“ä½œä¸ºä½•è¦è¿›å…¥ç¼“å­˜ï¼ˆPage Cacheï¼‰ï¼Ÿ**

> ä¸ºäº† **é¿å…é¢‘ç¹ç£ç›˜è®¿é—®ã€æé«˜è¯»å–æ•ˆç‡**ï¼Œå†…æ ¸ä¼šæŠŠ**è¯»è¿‡çš„æ•°æ®é¡µ**ç¼“å­˜è¿›å†…å­˜ï¼ˆPage Cacheï¼‰ã€‚ä¸‹æ¬¡è®¿é—®æ—¶ç›´æ¥ä»å†…å­˜è¯»ï¼Œé€Ÿåº¦å¿«æ•°ç™¾å€ã€‚

- è¿™éƒ¨åˆ†æ•°æ®ç”± `/proc/meminfo` ä¸­çš„ `Cached:` å­—æ®µç»Ÿè®¡
- å±äº **åªè¯»é¡µç¼“å­˜ï¼ˆclean pagesï¼‰**ï¼Œå¯ä»¥éšæ—¶è¢«å›æ”¶



#### **å†™æ“ä½œä¸ºä½•å…ˆè¿›å…¥å†…å­˜ç¼“å†²åŒºï¼Ÿ**

> ä¸ºäº† **é¿å…é¢‘ç¹ I/O ç³»ç»Ÿè°ƒç”¨ã€å‡å°‘ç£ç›˜å†™å…¥æ¬¡æ•°ã€æé«˜ååé‡**ï¼Œå†™æ“ä½œä¸æ˜¯ç›´æ¥è½ç›˜ï¼Œè€Œæ˜¯è¿›å…¥ Page Cacheï¼Œå¹¶æ ‡è®°ä¸º dirtyï¼ˆè„é¡µï¼‰

- è¿™äº›å†™å…¥æ•°æ®æš‚å­˜åœ¨ç¼“å­˜ä¸­
- åç»­ç”±å†…æ ¸çš„ **å†™å›çº¿ç¨‹**ï¼ˆ`pdflush`/`kupdate`/`kswapd`ï¼‰æ‰¹é‡è½ç›˜
- å†™å…¥æ—¶ä½ çœ‹åˆ°çš„ â€œç¼“å­˜è¡Œä¸ºâ€ä¹Ÿè¢«è®°å½•ä¸º `Cached` å­—æ®µï¼ˆä½†å®ƒä»¬æ˜¯ **dirty cache**ï¼‰





è¯»å†™ä¸¤ç§æ•°æ®ç¼“å­˜åœ¨ç¼“å­˜åŒº**éƒ½ç®—åœ¨ `/proc/meminfo` ä¸­çš„ `Cached:` é‡Œï¼Œä½†ç±»å‹ä¸åŒ**ï¼š

| æ“ä½œç±»å‹ | ç¼“å­˜ç±»å‹         | æ˜¯å¦ç®—è¿› Cached | ç‰¹ç‚¹                   |
| -------- | ---------------- | --------------- | ---------------------- |
| è¯»æ–‡ä»¶   | Page Cache       | âœ… æ˜¯            | å¹²å‡€é¡µï¼Œå¯ç›´æ¥å›æ”¶     |
| å†™æ–‡ä»¶   | Dirty Page Cache | âœ… æ˜¯            | è„é¡µï¼Œä¸è½ç›˜å‰ä¸å¯å›æ”¶ |



#### æ€ä¹ˆçŸ¥é“ `Cached` ä¸­åŒ…å«äº†å¤šå°‘è„é¡µï¼Ÿ

æŸ¥çœ‹ `/proc/meminfo` ä¸­çš„ä»¥ä¸‹å­—æ®µï¼š

```bash
grep -E 'Cached|Dirty|Writeback' /proc/meminfo
```

| å­—æ®µ        | å«ä¹‰                                 |
| ----------- | ------------------------------------ |
| `Cached`    | æ‰€æœ‰é¡µç¼“å­˜æ€»é‡ï¼ˆåŒ…æ‹¬ clean + dirtyï¼‰ |
| `Dirty`     | æ­£åœ¨ç­‰å¾…è½ç›˜çš„è„é¡µ                   |
| `Writeback` | æ­£åœ¨è¢«å†™å…¥ç£ç›˜çš„è„é¡µ                 |

ä½ ä¼šå‘ç°ï¼š

```bash
Cached:    400000 kB
Dirty:      20000 kB
Writeback:   5000 kB
```

â¡ï¸ è¯´æ˜ `Cached` ä¸­çš„ **20000 + 5000 = 25000 kB æ˜¯è„é¡µå†™ç¼“å­˜**ï¼Œå…¶ä»–çš„æ˜¯æ­£å¸¸è¯»ç¼“å­˜ã€‚



### free -h ä¸­å„æŒ‡æ ‡çš„å…³ç³»

```ABAP
otal = used + free + buff/cache âœ…
available â‰ˆ free + å¯å›æ”¶çš„ buff/cache éƒ¨åˆ† âœ…
```







## å®éªŒ

### å®éªŒ1ï¼šLinux æ–‡ä»¶ç³»ç»Ÿå–è¯å®æ“ï¼šé€šè¿‡ inode æ‰‹åŠ¨æ¢å¤å·²åˆ é™¤æ–‡ä»¶



#### å®éªŒç¯å¢ƒå‡†å¤‡

**åˆ›å»ºè™šæ‹Ÿç£ç›˜å¹¶æ ¼å¼åŒ–ä¸º ext4**

> **ext4 å¯ç”¨æ—¥å¿—åçš„åˆ é™¤è¡Œä¸º**
>
> `rm file` åœ¨ journal ext4 ä¸­è§¦å‘äº†ä»€ä¹ˆï¼Ÿ
>
> | å†…å®¹ç±»å‹       | æ˜¯å¦è®°å½•æ—¥å¿—    | è¯´æ˜                                      |
> | -------------- | --------------- | ----------------------------------------- |
> | æ–‡ä»¶å†…å®¹æ•°æ®å— | âŒï¼ˆé»˜è®¤ä¸è®°å½•ï¼‰ | æ•°æ®å—ç›´æ¥å†™å…¥ç£ç›˜ï¼ˆé journalï¼‰          |
> | inode å…ƒæ•°æ®   | âœ…               | åˆ é™¤æ“ä½œä¼šå°† inodeã€dentry çš„å˜æ›´å†™å…¥æ—¥å¿— |
> | block bitmap   | âœ…               | bitmap çš„é‡Šæ”¾ä¹Ÿä¼šåŒæ­¥åˆ° journal           |
>
> 
>
> è¿™æ„å‘³ç€ï¼š
>
> - `inode` åœ¨è¢«åˆ é™¤æ—¶ï¼Œä¼šå°†**åŸå§‹ inode æ¸…ç©ºåŠ¨ä½œ**å†™å…¥æ—¥å¿—åŒº
> - journal commit åï¼ŒåŸå§‹ inode è¡¨ä¸­çš„å†…å®¹å°†è¢«æ¸…ç©º
> - block bitmap ä¹Ÿä¼šæ›´æ–°ï¼Œæ•°æ®å—æ ‡è®°ä¸ºç©ºé—²

```bash
fallocate -l 200M /tmp/ext4.img
mkfs.ext4 -O ^has_journal /tmp/ext4.img  # å…³é—­æ—¥å¿—
mkdir /mnt/ext4test
mount -o loop /tmp/ext4.img /mnt/ext4test
```



#### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæµ‹è¯•æ–‡ä»¶

```bash
mkdir test
cd test
echo 'Secret Data in file' > secret.txt
sync  # ç¡®ä¿æ•°æ®è½ç›˜
```



#### ç¬¬äºŒæ­¥ï¼šåˆ é™¤æµ‹è¯•æ–‡ä»¶

```bash
rm secret.txt
sync
```

æ­¤æ—¶ `secret.txt` å·²è¢«åˆ é™¤ï¼Œæ— æ³•é€šè¿‡æ™®é€šæ‰‹æ®µæ‰¾åˆ°ã€‚



#### ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨ debugfs æŸ¥æ‰¾ inode å’Œæ•°æ®å—

```bash
debugfs /dev/vda1

lsdel

# è¾“å‡ºç±»ä¼¼
 Inode  Owner  Mode    Size   Blocks   Time Deleted
  12     0    100644   22     1        2024-06-01

# è®°å½•è¯¥ inode ç¼–å·ï¼ˆå¦‚ï¼š12ï¼‰ï¼Œç„¶åæŸ¥çœ‹ inode å†…å®¹ï¼š
stat <12>

# æ‰¾åˆ°ï¼š
EXTENTS:
(0): 42   # è¡¨ç¤ºæ•°æ®å­˜å‚¨åœ¨ç¬¬ 42 ä¸ªå—ä¸­ï¼ˆè¿™æ˜¯é€»è¾‘å—å·ï¼‰
```



#### ç¬¬å››æ­¥ï¼šè®¡ç®—å¹¶æå–æ•°æ®å—å†…å®¹ï¼ˆæ–¹æ³•ä¸€ï¼šä½¿ç”¨ ddï¼‰

### è®¡ç®—åç§»ï¼š

å—å¤§å°é€šå¸¸ä¸º 4096 å­—èŠ‚ï¼Œåç§» = 42 Ã— 4096 = 172032

### æå–å†…å®¹ï¼š

```bash
dd if=/tmp/ext4.img of=recovered.txt bs=4096 skip=42 count=1
cat recovered.txt
```

åº”è¾“å‡ºï¼š

```
Secret Data in file
```

âœ… æˆåŠŸæ¢å¤å·²åˆ é™¤æ–‡ä»¶çš„å†…å®¹ï¼





# ç¬¬äº”å¤©

## vimç”¨æ³•



- **æ­£å¸¸ï¼ˆnormalï¼‰æ¨¡å¼**

  > ï¼ˆä¹Ÿç§°ä¸ºæ™®é€šæ¨¡å¼ï¼‰ï¼Œç¼ºçœçš„ç¼–è¾‘æ¨¡å¼ï¼›å¦‚æœä¸åŠ ç‰¹æ®Šè¯´æ˜ï¼Œä¸€èˆ¬æåˆ°çš„å‘½ä»¤éƒ½ç›´æ¥åœ¨æ­£å¸¸æ¨¡å¼ä¸‹è¾“å…¥ï¼›åœ¨ä»»ä½•å…¶ä»–æ¨¡å¼ä¸­ï¼Œéƒ½å¯ä»¥é€šè¿‡é”®ç›˜ä¸Šçš„ Esc é”®å›åˆ°æ­£å¸¸æ¨¡å¼ã€‚

- **æ’å…¥ï¼ˆinsertï¼‰æ¨¡å¼**

  > è¾“å…¥æ–‡æœ¬æ—¶ä½¿ç”¨ï¼›æ¯”å¦‚åœ¨æ­£å¸¸æ¨¡å¼ä¸‹é”®å…¥ iï¼ˆinsertï¼‰æˆ– aï¼ˆappendï¼‰å³å¯è¿›å…¥æ’å…¥æ¨¡å¼ã€‚

- **å¯è§†ï¼ˆvisualï¼‰æ¨¡å¼**

  > ç”¨äºé€‰å®šæ–‡æœ¬å—ï¼›æ•™ç¨‹ä¸­å·²ç»æåˆ°å¯ä»¥ç”¨é”® vï¼ˆå°å†™ï¼‰æ¥æŒ‰å­—ç¬¦é€‰å®šï¼ŒVim é‡Œä¹Ÿæä¾›å…¶ä»–ä¸åŒçš„é€‰å®šæ–¹æ³•ï¼ŒåŒ…æ‹¬æŒ‰è¡Œå’ŒæŒ‰åˆ—å—ã€‚

- **å‘½ä»¤è¡Œï¼ˆcommand-lineï¼‰æ¨¡å¼**

  > ç”¨äºæ‰§è¡Œè¾ƒé•¿ã€è¾ƒå¤æ‚çš„å‘½ä»¤ï¼›åœ¨æ­£å¸¸æ¨¡å¼ä¸‹é”®å…¥å†’å·ï¼ˆ:ï¼‰å³å¯è¿›å…¥è¯¥æ¨¡å¼ï¼›ä½¿ç”¨æ–œæ ï¼ˆ/ï¼‰å’Œé—®å·ï¼ˆ?ï¼‰å¼€å§‹æœç´¢ä¹Ÿç®—ä½œå‘½ä»¤è¡Œæ¨¡å¼ã€‚å‘½ä»¤è¡Œæ¨¡å¼ä¸‹çš„å‘½ä»¤è¦è¾“å…¥å›è½¦é”®ï¼ˆEnterï¼‰æ‰ç®—å®Œæˆã€‚





### vimæ ‡å‡†é”®æè¿°æ–¹å¼



- `<Esc>` è¡¨ç¤º Esc é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‹â€
- `<CR>` è¡¨ç¤ºå›è½¦é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ†©â€
- `<Space>` è¡¨ç¤ºç©ºæ ¼é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ£â€
- `<Tab>` è¡¨ç¤º Tab é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡¥â€
- `<BS>` è¡¨ç¤ºé€€æ ¼é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâŒ«â€
- `<Del>` è¡¨ç¤ºåˆ é™¤é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâŒ¦â€
- `<lt>` è¡¨ç¤º < é”®ï¼›æ˜¾ç¤ºä¸ºâ€œ<â€
- `<Up>` è¡¨ç¤ºå…‰æ ‡ä¸Šç§»é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡¡â€
- `<Down>` è¡¨ç¤ºå…‰æ ‡ä¸‹ç§»é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡£â€
- `<Left>` è¡¨ç¤ºå…‰æ ‡å·¦ç§»é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡ â€
- `<Right>` è¡¨ç¤ºå…‰æ ‡å³ç§»é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡¢â€
- `<PageUp>` è¡¨ç¤º Page Up é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡â€
- `<PageDown>` è¡¨ç¤º Page Down é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡Ÿâ€
- `<Home>` è¡¨ç¤º Home é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ†–â€
- `<End>` è¡¨ç¤º End é”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ†˜â€
- `<F1> - <F12>` è¡¨ç¤ºåŠŸèƒ½é”® 1 åˆ° 12ï¼›æ˜¾ç¤ºä¸ºâ€œF1â€åˆ°â€œF12â€
- `<S-â€¦>` Shift ç»„åˆé”®ï¼›æ˜¾ç¤ºä¸ºâ€œâ‡§â€ï¼ˆè¾ƒå°‘ä½¿ç”¨ï¼Œå› ä¸ºæˆ‘ä»¬éœ€è¦å†™ ! è€Œä¸æ˜¯ `<S-1>`ï¼›å’Œç‰¹æ®Šé”®ç»„åˆæ—¶ä»ç„¶æœ‰ç”¨ï¼‰
- `<C-â€¦>` Control ç»„åˆé”®ï¼›æ˜¾ç¤ºä¸ºâ€œâŒƒâ€<M-â€¦> Alt ç»„åˆé”®ï¼›æ˜¾ç¤ºä¸ºâ€œâŒ¥â€ï¼ˆå¯¹äºå¤§éƒ¨åˆ†ç”¨æˆ·ï¼Œå®ƒçš„åŸå§‹é”®å Meta åº”è¯¥åªå…·æœ‰å†å²æ„ä¹‰ï¼‰
- `<D-â€¦>` Command ç»„åˆé”®ï¼›æ˜¾ç¤ºä¸ºâ€œâŒ˜â€ï¼ˆMac é”®ç›˜ï¼‰



### vimé…ç½®

ä½œä¸ºä¸€ä¸ªå¯ä»¥è¶Šç”¨è¶Šé¡ºæ‰‹çš„åº”ç”¨ç¨‹åºï¼ŒVim æ˜¯éœ€è¦é…ç½®çš„ã€‚

æ ¹æ® Unix ä¸‹çš„æƒ¯ä¾‹ï¼ŒVim çš„é…ç½®æ–‡ä»¶æ”¾åœ¨ç”¨æˆ·çš„ä¸»ç›®å½•ä¸‹ï¼Œæ–‡ä»¶åé€šå¸¸æ˜¯ `.vimrc`ï¼›è€Œå®ƒåœ¨ Windows ä¸‹åå­—æ˜¯ `_vimrc`ã€‚



åŸºæœ¬é…ç½®

```bash
set undodir=~/.vim/undodir                # è¿™æ ·ä¸€å®šè¦å†™åœ¨åˆ›å»ºç›®å½•å‰é¢
let undodir_path = expand(&undodir)
if !isdirectory(undodir_path)
    call mkdir(undodir_path, 'p', 0700)
endif

syntax on
set background=dark
set enc=utf-8                          # è®¾ç½®ç¼–è¾‘æ–‡ä»¶çš„å†…ç æ˜¯ UTF-8
set nocompatible                       # è®¾ç½® Vim ä¸éœ€è¦å’Œ vi å…¼å®¹(ç›®å‰å¤§éƒ¨åˆ†æƒ…å†µä¸‹è¿™æ˜¯ç¼ºçœæƒ…å†µ)
source $VIMRUNTIME/vimrc_example.vim   # å¯¼å…¥ Vim çš„ç¤ºä¾‹é…ç½®ï¼ˆè¿™ä¼šæ‰“å¼€ä¸€äº›æœ‰ç”¨çš„é€‰é¡¹ï¼Œå¦‚è¯­æ³•åŠ äº®ã€æœç´¢åŠ äº®ã€å‘½ä»¤å†å²ã€è®°ä½ä¸Šæ¬¡çš„æ–‡ä»¶ä½ç½®ï¼Œç­‰ç­‰ï¼‰
set nobackup                           # ä¸å¤‡ä»½
set scrolloff=1
colorscheme murphy
```



### vimä½¿ç”¨

#### å…‰æ ‡ç§»åŠ¨

Vim é‡Œçš„åŸºæœ¬å…‰æ ‡ç§»åŠ¨æ˜¯é€šè¿‡ **hã€jã€kã€l** å››ä¸ªé”®å®ç°çš„ã€‚ä¹‹æ‰€ä»¥ä½¿ç”¨è¿™å››ä¸ªé”®ï¼Œæ˜¯æœ‰å†å²åŸå› çš„ã€‚ä½ çœ‹ä¸€ä¸‹ Bill Joy å¼€å‘ vi æ—¶ä½¿ç”¨çš„é”®ç›˜å°±æ˜ç™½äº†ï¼šè¿™ä¸ªé”®ç›˜ä¸Šæ²¡æœ‰ç‹¬ç«‹çš„å…‰æ ‡é”®ï¼Œè€Œå››ä¸ªå…‰æ ‡ç¬¦å·ç›´æ¥æ ‡æ³¨åœ¨ Hã€Jã€Kã€L å››ä¸ªå­—æ¯æŒ‰é”®ä¸Šã€‚

<img src="D:\git_repository\cyber_security_learning\markdown_img\image-20250610103229515.png" alt="image-20250610103229515" style="zoom:1150%;" />

å½“ç„¶ï¼Œé™¤äº†å†å²åŸå› å¤–ï¼Œè¿™å››ä¸ªé”®ä¸€ç›´ä½¿ç”¨è‡³ä»Šï¼Œè¿˜æ˜¯æœ‰å…¶åˆç†æ€§çš„ã€‚å®ƒä»¬éƒ½å¤„äºæ‰“å­—æœºçš„æœ¬ä½æ’ï¼ˆhome rowï¼‰ä¸Šï¼Œè¿™æ ·æ‰“å­—çš„æ—¶å€™ï¼Œæ‰‹æŒ‡åŸºæœ¬ä¸ç”¨ç§»åŠ¨å°±å¯ä»¥æ•²å‡»åˆ°ã€‚å› æ­¤ï¼Œå³ä½¿åˆ°äº†é”®ç›˜ä¸Šå…¨éƒ½æœ‰äº†å…‰æ ‡ç§»åŠ¨é”®çš„ä»Šå¤©ï¼Œå¾ˆå¤š Vim çš„ç”¨æˆ·ä»ç„¶ä¼šä½¿ç”¨è¿™å››ä¸ªé”®æ¥ç§»åŠ¨å…‰æ ‡ã€‚



Vim è·³è½¬åˆ°è¡Œé¦–çš„å‘½ä»¤æ˜¯ **0**ï¼Œè·³è½¬åˆ°è¡Œå°¾çš„å‘½ä»¤æ˜¯ **$**ï¼Œæˆ‘ä»¬ä¹Ÿæœ‰ **^**ï¼Œç”¨æ¥è·³è½¬åˆ°è¡Œé¦–çš„ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦ã€‚



å¯¹äºä¸€æ¬¡ç§»åŠ¨è¶…è¿‡ä¸€ä¸ªå­—ç¬¦çš„æƒ…å†µï¼ŒVim æ”¯æŒä½¿ç”¨ **b/w** å’Œ **B/W**ï¼Œæ¥è¿›è¡Œä»¥å•è¯ä¸ºå•ä½çš„è·³è½¬ã€‚å°å†™å’Œå¤§å†™å‘½ä»¤çš„åŒºåˆ«åœ¨äºï¼Œå°å†™çš„è·Ÿç¼–ç¨‹è¯­è¨€é‡Œçš„æ ‡è¯†ç¬¦çš„è§„åˆ™ç›¸ä¼¼ï¼Œè®¤ä¸ºä¸€ä¸ªå•è¯æ˜¯ç”±å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ç»„æˆçš„ï¼ˆä¸ä¸¥æ ¼çš„è¯´æ³•ï¼‰ï¼Œè€Œå¤§å†™çš„å‘½ä»¤åˆ™è®¤ä¸ºéç©ºæ ¼å­—ç¬¦éƒ½æ˜¯å•è¯ã€‚



ä½¿ç”¨ **fï¼ˆfindï¼‰**å’Œ **tï¼ˆtillï¼‰**äº†ã€‚å®ƒä»¬çš„ä½œç”¨éƒ½æ˜¯æ‰¾åˆ°ä¸‹ä¸€ä¸ªï¼ˆå¦‚æœåœ¨è¾“å…¥å®ƒä»¬ä¹‹å‰å…ˆè¾“å…¥æ•°å­— n çš„è¯ï¼Œé‚£å°±æ˜¯ä¸‹é¢ç¬¬ n ä¸ªï¼‰ç´§æ¥ç€è¾“å…¥çš„å­—ç¬¦ã€‚å¦‚æœéœ€è¦åæ–¹å‘æœç´¢çš„è¯ï¼Œä½¿ç”¨å¤§å†™çš„ **F** å’Œ **T** å°±å¯ä»¥ã€‚



- `(` å’Œ `)` ç§»åˆ°ä¸Šä¸€å¥å’Œä¸‹ä¸€å¥
- `{` å’Œ `}` ç§»åˆ°ä¸Šä¸€æ®µå’Œä¸‹ä¸€æ®µ

- `gg`è·³è½¬åˆ°å¼€å¤´ï¼Œ`G`è·³è½¬åˆ°ç»“å°¾



#### æ–‡æœ¬ä¿®æ”¹

- `d` åŠ åŠ¨ä½œæ¥è¿›è¡Œåˆ é™¤ï¼ˆ`dd` åˆ é™¤æ•´è¡Œï¼‰ï¼›`D` åˆ™ç›¸å½“äº `d$`ï¼Œåˆ é™¤åˆ°è¡Œå°¾ã€‚
- `c` åŠ åŠ¨ä½œæ¥è¿›è¡Œä¿®æ”¹ï¼ˆ`cc` ä¿®æ”¹æ•´è¡Œï¼‰ï¼›`C` åˆ™ç›¸å½“äº `c$`ï¼Œåˆ é™¤åˆ°è¡Œå°¾ç„¶åè¿›å…¥æ’å…¥æ¨¡å¼ã€‚
- `s` ç›¸å½“äº `cl`ï¼Œåˆ é™¤ä¸€ä¸ªå­—ç¬¦ç„¶åè¿›å…¥æ’å…¥æ¨¡å¼ï¼›`S` ç›¸å½“äº `cc`ï¼Œæ›¿æ¢æ•´è¡Œçš„å†…å®¹ã€‚
- `i` åœ¨å½“å‰å­—ç¬¦å‰é¢è¿›å…¥æ’å…¥æ¨¡å¼ï¼›`I` åˆ™ç›¸å½“äº `^i`ï¼ŒæŠŠå…‰æ ‡ç§»åˆ°è¡Œé¦–éç©ºç™½å­—ç¬¦ä¸Šç„¶åè¿›å…¥æ’å…¥æ¨¡å¼ã€‚
- `a` åœ¨å½“å‰å­—ç¬¦åé¢è¿›å…¥æ’å…¥æ¨¡å¼ï¼›`A` ç›¸å½“äº `$a`ï¼ŒæŠŠå…‰æ ‡ç§»åˆ°è¡Œå°¾ç„¶åè¿›å…¥æ’å…¥æ¨¡å¼ã€‚
- `o` åœ¨å½“å‰è¡Œä¸‹æ–¹æ’å…¥ä¸€ä¸ªæ–°è¡Œï¼Œç„¶ååœ¨è¿™è¡Œè¿›å…¥æ’å…¥æ¨¡å¼ï¼›`O` åœ¨å½“å‰è¡Œä¸Šæ–¹æ’å…¥ä¸€ä¸ªæ–°è¡Œï¼Œç„¶ååœ¨è¿™è¡Œè¿›å…¥æ’å…¥æ¨¡å¼ã€‚
- `r` æ›¿æ¢å…‰æ ‡ä¸‹çš„å­—ç¬¦ï¼›`R` åˆ™è¿›å…¥æ›¿æ¢æ¨¡å¼ï¼Œæ¯æ¬¡æŒ‰é”®ï¼ˆç›´åˆ° ï¼‰æ›¿æ¢ä¸€ä¸ªå­—ç¬¦ã€‚
- `u` æ’¤é”€æœ€è¿‘çš„ä¸€ä¸ªä¿®æ”¹åŠ¨ä½œï¼› `U` æ’¤é”€å½“å‰è¡Œä¸Šçš„æ‰€æœ‰ä¿®æ”¹ã€‚



#### æ–‡æœ¬å¯¹è±¡é€‰æ‹©

```bash
if (message == "sesame open")
```

æˆ‘ä»¬è¿›ä¸€æ­¥å‡è®¾å…‰æ ‡åœåœ¨â€œsesameâ€çš„â€œaâ€ä¸Šï¼Œé‚£ä¹ˆï¼ˆå’Œä¸€èˆ¬çš„è¡Œæ–‡æƒ¯ä¾‹ä¸åŒï¼Œä¸‹é¢åœ¨å‘½ä»¤å¤–é¢ä¹ŸåŠ ä¸Šäº†å¼•å·ï¼Œé¿å…å¯èƒ½çš„æ­§ä¹‰ï¼‰

- `dw`ï¼ˆç†è§£ä¸º delete wordï¼‰ä¼šåˆ é™¤â€œameâ£â€ï¼Œç»“æœæ˜¯â€œif (message == "sesopen")â€
- `diw`ï¼ˆç†è§£ä¸º delete inside wordï¼‰ä¼šåˆ é™¤â€œsesameâ€ï¼Œç»“æœæ˜¯â€œif (message == " open")â€
- `daw`ï¼ˆç†è§£ä¸º delete a wordï¼‰ä¼šåˆ é™¤â€œsesameâ£â€ï¼Œç»“æœæ˜¯â€œif (message == "open")â€
- `diW` ä¼šåˆ é™¤â€œ"sesameâ€ï¼Œç»“æœæ˜¯â€œif (message == open")â€
- `daW` ä¼šåˆ é™¤â€œ"sesameâ£â€ï¼Œç»“æœæ˜¯â€œif (message == open")â€
- `di"` ä¼šåˆ é™¤â€œsesame openâ€ï¼Œç»“æœæ˜¯â€œif (message == "")â€
- `da"` ä¼šåˆ é™¤â€œ"sesame open"â€ï¼Œç»“æœæ˜¯â€œif (message ==)â€
- `di(` æˆ– `di)`ä¼šåˆ é™¤â€œmessage == "sesame open"â€ï¼Œç»“æœæ˜¯â€œif ()â€
- `da(` æˆ–  `da)`ä¼šåˆ é™¤â€œ(message == "sesame open")â€ï¼Œç»“æœæ˜¯â€œifâ£â€



ä¸Šé¢æ¼”ç¤ºäº† aã€i å’Œ wã€åŒå¼•å·ã€åœ†æ‹¬å·æ­é…ä½¿ç”¨ï¼Œè¿™äº›å¯¹äºä»»ä½•è¯­è¨€çš„ä»£ç ç¼–è¾‘éƒ½æ˜¯éå¸¸æœ‰ç”¨çš„ã€‚å®é™…ä¸Šï¼Œå¯ä»¥æ­é…çš„è¿˜æœ‰æ›´å¤šï¼š

- æ­é… `s`ï¼ˆsentenceï¼‰å¯¹å¥å­è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆè¥¿æ–‡æ–‡æœ¬ç¼–è¾‘
- æ­é… `p`ï¼ˆparagraph) å¯¹æ®µè½è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆè¥¿æ–‡æ–‡æœ¬ç¼–è¾‘ï¼ŒåŠå¸¦ç©ºè¡Œçš„ä»£ç ç¼–è¾‘
- æ­é… `t`ï¼ˆtagï¼‰å¯¹ HTML/XML æ ‡ç­¾è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆ HTMLã€XML ç­‰è¯­è¨€çš„ä»£ç ç¼–è¾‘
- æ­é… \` å’Œ `'` å¯¹è¿™ä¸¤ç§å¼•å·é‡Œçš„å†…å®¹è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆä½¿ç”¨è¿™äº›å¼•å·çš„ä»£ç ï¼Œå¦‚ shell å’Œ Python
- æ­é…æ–¹æ‹¬å·ï¼ˆ`[` å’Œ `]`ï¼‰å¯¹æ–¹æ‹¬å·é‡Œçš„å†…å®¹è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆå„ç§è¯­è¨€ï¼ˆå¤§éƒ¨åˆ†éƒ½ä¼šç”¨åˆ°æ–¹æ‹¬å·å§ï¼‰
- æ­é…èŠ±æ‹¬å·ï¼ˆ`{` å’Œ `}`å¯¹èŠ±æ‹¬å·é‡Œçš„å†…å®¹è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆç±» C çš„è¯­è¨€
- æ­é…è§’æ‹¬å·ï¼ˆ`<` å’Œ `>`ï¼‰å¯¹è§’æ‹¬å·é‡Œçš„å†…å®¹è¿›è¡Œæ“ä½œâ€”â€”é€‚åˆ C++ çš„æ¨¡æ¿ä»£ç 



ä½ çŸ¥é“å‡ºé”™ä½ç½®çš„è¡Œå·ï¼Œé‚£ä½ å¯ä»¥ç”¨`æ•°å­—åŠ  G` æ¥è·³è½¬åˆ°æŒ‡å®šè¡Œã€‚ç±»ä¼¼åœ°ï¼Œä½ å¯ä»¥ç”¨æ•°å­—åŠ  `|` æ¥è·³è½¬åˆ°æŒ‡å®šåˆ—ã€‚è¿™åœ¨è°ƒè¯•ä»£ç çš„æ—¶å€™éå¸¸æœ‰ç”¨ï¼Œå°¤å…¶é€‚åˆè¿›è¡Œè‡ªåŠ¨åŒ–ã€‚





#### å±å¹•æ»šåŠ¨

vimrc_example æœ‰ä¸€ä¸ªè®¾å®šï¼Œæˆ‘ä¸å¤ªå–œæ¬¢ï¼šå®ƒä¼šè®¾ set scrolloff=5ï¼Œå¯¼è‡´åªè¦å±å¹•èƒ½æ»šåŠ¨ï¼Œå…‰æ ‡å°±ç§»ä¸åˆ°æœ€ä¸Šé¢çš„ 4 è¡Œå’Œæœ€ä¸‹é¢çš„ 4 è¡Œé‡Œï¼Œå› ä¸ºä¸€ç§»è¿›å»å±å¹•å°±ä¼šè‡ªåŠ¨æ»šåŠ¨ã€‚è¿™åŒæ ·ä¹Ÿä¼šå¯¼è‡´ H å’Œ L çš„åŠŸèƒ½å‘ç”Ÿå˜åŒ–ï¼šæœ¬æ¥æ˜¯ç§»åŠ¨å…‰æ ‡åˆ°å±å¹•çš„æœ€ä¸Šé¢å’Œæœ€ä¸‹é¢ï¼Œç°åœ¨åˆ™å˜æˆäº†ç§»åŠ¨åˆ°ä¸Šæ•°ç¬¬ 6 è¡Œå’Œä¸‹æ•°ç¬¬ 6 è¡Œï¼Œå’Œæ²¡æœ‰è¿™ä¸ªè®¾å®šæ—¶çš„ 6H ä¸ 6L ä¸€æ ·äº†ã€‚æ‰€ä»¥æˆ‘ä¸€èˆ¬ä¼šåœ¨ Vim é…ç½®æ–‡ä»¶é‡Œè®¾ç½® set scrolloff=1ï¼ˆä½ ä¹Ÿå¯ä»¥è€ƒè™‘è®¾æˆ 0ï¼‰ï¼Œå‡å°‘è¿™ä¸ªè®¾ç½®çš„å¹²æ‰°ã€‚



åªè¦å…‰æ ‡è¿˜åœ¨å±å¹•ä¸Šï¼Œä½ ä¹Ÿå¯ä»¥æ»šåŠ¨å±å¹•è€Œä¸ç§»åŠ¨å…‰æ ‡ï¼ˆä¸åƒæŸäº›å…¶ä»–ç¼–è¾‘å™¨ï¼ŒVim ä¸å…è®¸å…‰æ ‡åœ¨å½“å‰å±å¹•ä»¥å¤–ï¼‰ã€‚éœ€è¦çš„æŒ‰é”®æ˜¯ `<C-E>` å’Œ `<C-Y>` ã€‚

å¦å¤–ä¸€ç§å¯èƒ½æ›´å®ç”¨çš„æ»šåŠ¨å±å¹•æ–¹å¼æ˜¯ï¼ŒæŠŠå½“å‰è¡Œâ€œæ»šåŠ¨â€åˆ°å±å¹•çš„é¡¶éƒ¨ã€ä¸­éƒ¨æˆ–åº•éƒ¨ã€‚Vim é‡Œçš„å¯¹åº”æŒ‰é”®æ˜¯ `zt`ã€`zz` å’Œ `zb`ã€‚å’Œä¸Šé¢çš„å‡ ä¸ªæ»šåŠ¨ç›¸å…³çš„æŒ‰é”®ä¸€æ ·ï¼Œå®ƒä»¬åŒæ ·å—é€‰é¡¹ scrolloff çš„å½±å“ã€‚





#### é‡å¤

- `;` é‡å¤æœ€è¿‘çš„å­—ç¬¦æŸ¥æ‰¾ï¼ˆ`f`ã€`t` ç­‰ï¼‰æ“ä½œ
- `,` é‡å¤æœ€è¿‘çš„å­—ç¬¦æŸ¥æ‰¾æ“ä½œï¼Œåæ–¹å‘
- `n` é‡å¤æœ€è¿‘çš„å­—ç¬¦ä¸²æŸ¥æ‰¾æ“ä½œï¼ˆ`/` å’Œ `?`ï¼‰
- `N` é‡å¤æœ€è¿‘çš„å­—ç¬¦ä¸²æŸ¥æ‰¾æ“ä½œï¼ˆ`/` å’Œ `?`ï¼‰ï¼Œåæ–¹å‘
- `.` é‡å¤æ‰§è¡Œæœ€è¿‘çš„ä¿®æ”¹æ“ä½œ





### å®šåˆ¶ vim åˆçº§

#### vimçš„ç›®å½•ç»“æ„

Vim çš„å·¥ä½œç¯å¢ƒæ˜¯ç”±è¿è¡Œæ”¯æŒæ–‡ä»¶æ¥è®¾å®šçš„ã€‚å¦‚æœä½ æƒ³è¦å®šåˆ¶ Vimï¼Œå°±è¦ç†ŸçŸ¥ Vim æœ‰å“ªäº›ä¸åŒç±»å‹çš„è¿è¡Œæ”¯æŒæ–‡ä»¶ï¼Œåˆ†åˆ«å­˜æ”¾åœ¨å“ªé‡Œï¼Œæ€æ ·èƒ½å¿«æ·åœ°æ‰¾åˆ°å®ƒä»¬ã€‚Vim æ¯”è¾ƒæœ‰æ„æ€çš„ä¸€ç‚¹çš„æ˜¯ï¼Œè™½ç„¶è¿è¡Œæ”¯æŒæ–‡ä»¶æ˜¯åœ¨ Vim çš„å®‰è£…ç›®å½•ä¸‹ï¼Œä½†ç”¨æˆ·è‡ªå·±æ˜¯å¯ä»¥â€œå…‹éš†â€è¿™ä¸ªç›®å½•ç»“æ„çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ è‡ªå·±ç›®å½•ä¸‹çš„ç”¨æˆ·é…ç½®ï¼Œåˆ°ä½ æ·±åº¦å®šåˆ¶çš„æ—¶å€™ï¼Œä¹Ÿæœ‰ç›¸ä¼¼çš„ç›®å½•ç»“æ„ã€‚æ‰€ä»¥ï¼Œæˆ‘å°±å…ˆä»è¿™äº›æ–‡ä»¶çš„ç›®å½•ç»“æ„å¼€å§‹è®²èµ·ã€‚



##### å®‰è£…ç›®å½•ä¸‹çš„è¿è¡Œæ”¯æŒæ–‡ä»¶

Vim çš„è¿è¡Œæ”¯æŒæ–‡ä»¶åœ¨ä¸åŒçš„å¹³å°ä¸Šæœ‰ç€ç›¸ä¼¼çš„ç›®å½•ç»“æ„ã€‚ä»¥ Vim 8.2 ä¸ºä¾‹ï¼Œå®ƒä»¬çš„æ ‡å‡†å®‰è£…ä½ç½®åˆ†åˆ«åœ¨ï¼š

- å¤§éƒ¨åˆ† Unix ä¸‹é¢ï¼š`/usr/share/vim/vim82`
- macOS Homebrew ä¸‹ï¼š`/usr/local/opt/macvim/MacVim.app/Contents/Resources/vim/runtime`
- Windows ä¸‹ï¼š`C:\Program Files (x86)\Vim\vim82`



åœ¨è¿™ä¸ªç›®å½•ä¸‹é¢ï¼Œä½ å¯ä»¥çœ‹åˆ°å¾ˆå¤šå­ç›®å½•ï¼Œå¦‚ autoloadã€colorsã€docã€packã€pluginã€syntax ç­‰ç­‰ã€‚è¿™äº›å­ç›®å½•ä¸‹é¢å°±æ˜¯åˆ†ç±»æ”¾ç½®çš„ Vim æ”¯æŒæ–‡ä»¶ã€‚æœ€å¸¸ç”¨çš„å­ç›®å½•åº”è¯¥æ˜¯ä¸‹é¢è¿™å‡ ä¸ªï¼š

- syntaxï¼šVim çš„è¯­æ³•åŠ äº®æ–‡ä»¶
- docï¼šVim çš„å¸®åŠ©æ–‡ä»¶
- colorsï¼šVim çš„é…è‰²æ–¹æ¡ˆ
- pluginï¼šVim çš„â€œæ’ä»¶â€ï¼Œå³ç”¨æ¥å¢å¼º Vim åŠŸèƒ½çš„å·¥å…·



**syntax ç›®å½•**

![image-20250610142943631](D:\git_repository\cyber_security_learning\markdown_img\image-20250610142943631.png)

è¿™é‡Œé¢çš„æ–‡ä»¶å»æ‰â€œ.vimâ€åç¼€åï¼Œå°±æ˜¯æ–‡ä»¶ç±»å‹çš„åå­—ï¼Œä½ å¯ä»¥ç”¨ç±»ä¼¼ `:setfiletype java` è¿™æ ·çš„å‘½ä»¤æ¥è®¾ç½®æ–‡ä»¶çš„ç±»å‹ï¼Œä»è€Œè¿›è¡Œè¯­æ³•åŠ äº®ã€‚



**docç›®å½•**

æˆ‘ä»¬ç”¨â€œ:helpâ€å‘½ä»¤æŸ¥çœ‹çš„å¸®åŠ©æ–‡ä»¶å°±æ”¾åœ¨ doc ç›®å½•ä¸‹ã€‚



**colors ç›®å½•**

æˆ‘ä»¬å¯ä»¥ç”¨èœå•â€œç¼–è¾‘ > é…è‰²æ–¹æ¡ˆâ€ï¼ˆâ€œEdit > Color Schemeâ€ï¼‰æµè§ˆé…è‰²æ–¹æ¡ˆï¼Œç›¸åº”çš„æ–‡ä»¶å°±åœ¨ colors ç›®å½•ä¸‹ã€‚

> vimé…è‰²æ–¹æ¡ˆä½¿ç”¨
>
> è¾“å…¥:colorschemeå‘½ä»¤ï¼Œç´§æ¥ç€ä¸€ä¸ªç©ºæ ¼åï¼Œç„¶åç‚¹å‡»Tabé”®ï¼Œå°†å¯ä»¥éå†æ‰€æœ‰å·²å®‰è£…çš„é…è‰²æ–¹æ¡ˆï¼ŒæŒ‰ä¸‹Enteré”®å¯ä»¥åº”ç”¨é€‰ä¸­çš„é…è‰²æ–¹æ¡ˆã€‚
>
> å¦‚æœä½ å¸Œæœ›åœ¨Vimå¯åŠ¨æ—¶å¯ç”¨æŒ‡å®šçš„é…è‰²æ–¹æ¡ˆï¼Œé‚£ä¹ˆå¯ä»¥åœ¨[vimrc](https://link.zhihu.com/?target=http%3A//yyq123.blogspot.com/2012/01/vim-vimrc.html)æ–‡ä»¶ä¸­ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š
>
> ```bash
> :colorscheme name
> ```

![image-20250610160036317](D:\git_repository\cyber_security_learning\markdown_img\image-20250610160036317.png)



**plugin ç›®å½•**

<img src="D:\git_repository\cyber_security_learning\markdown_img\image-20250610160537331.png" alt="image-20250610160537331" style="zoom:150%;" />

åœ¨ plugin ç›®å½•ä¸‹çš„ç³»ç»Ÿå†…ç½®æ’ä»¶ä¸å¤šï¼Œæˆ‘ä»¬ä¸‹é¢å°±å¿«é€Ÿè®²è§£ä¸€ä¸‹

- **getscriptPlugin**ï¼šè·å¾—æœ€æ–°çš„ Vim è„šæœ¬çš„æ’ä»¶ï¼ˆåœ¨ç›®å‰å¹¿æ³›ä½¿ç”¨ Git çš„å¹´ä»£ï¼Œè¿™ä¸ªæ’ä»¶è¿‡æ—¶äº†ï¼Œæˆ‘ä»¬ä¸è®²ï¼‰
- **gzip**ï¼šç¼–è¾‘ .gz å‹ç¼©æ–‡ä»¶ï¼ˆèƒ½åœ¨ç¼–è¾‘åç¼€ä¸º .gz çš„æ–‡ä»¶æ—¶è‡ªåŠ¨è§£å‹å’Œå‹ç¼©ï¼Œä½ ä¼šæ„Ÿè§‰ä¸åˆ°è¿™ä¸ªæ–‡ä»¶æ˜¯å‹ç¼©çš„ï¼‰
- **logiPat**ï¼šæ¨¡å¼åŒ¹é…çš„é€»è¾‘è¿ç®—ç¬¦ï¼ˆå…è®¸ä»¥é€»è¾‘è¿ç®—ã€è€Œéæ ‡å‡†æ­£åˆ™è¡¨è¾¾å¼çš„æ–¹å¼æ¥å†™æ¨¡å¼åŒ¹é…è¡¨è¾¾å¼ï¼‰
- **manpager**ï¼šä½¿ç”¨ Vim æ¥æŸ¥çœ‹ man å¸®åŠ©ï¼ˆå¼ºçƒˆå»ºè®®è¯•ä¸€ä¸‹ï¼Œè®°å¾—ä½¿ç”¨ Vim çš„è·³è½¬é”® C-] å’Œ C-Tï¼‰
- **matchparen**ï¼šå¯¹æ‹¬å·è¿›è¡Œé«˜äº®åŒ¹é…ï¼ˆç°ä»£ç¼–è¾‘å™¨åŸºæœ¬éƒ½æœ‰ç±»ä¼¼çš„åŠŸèƒ½ï¼‰
- **netrwPlugin**ï¼šä»ç½‘ç»œä¸Šç¼–è¾‘æ–‡ä»¶å’Œæµè§ˆï¼ˆè¿œç¨‹ï¼‰ç›®å½•ï¼ˆæ”¯æŒå¤šç§å¸¸è§åè®®å¦‚ ftp å’Œ scpï¼Œå¯ç›´æ¥æ‰“å¼€ç›®å½•æ¥é€‰æ‹©æ–‡ä»¶ï¼‰
- **rrhelper**ï¼šç”¨äºæ”¯æŒ --remote-wait ç¼–è¾‘ï¼ˆVim çš„å¤šæœåŠ¡å™¨ä¼šç”¨åˆ°è¿™ä¸€åŠŸèƒ½ï¼‰
- **spellfile**ï¼šåœ¨æ‹¼å†™æ–‡ä»¶ç¼ºå¤±æ—¶è‡ªåŠ¨ä¸‹è½½ï¼ˆVim ä¸€èˆ¬åªå®‰è£…äº†è‹±æ–‡çš„æ‹¼å†™æ–‡ä»¶ï¼‰
- **tarPlugin**ï¼šç¼–è¾‘ï¼ˆå‹ç¼©çš„ï¼‰tar æ–‡ä»¶ï¼ˆæ³¨æ„ï¼Œå’Œ gzip æƒ…å†µä¸åŒï¼Œè¿™å„¿ä¸æ”¯æŒå†™å…¥ï¼‰
- **tohtml**ï¼šæŠŠè¯­æ³•åŠ äº®çš„ç»“æœè½¬æˆ HTMLï¼ˆè‡ªå·±æ‰“å¼€ä¸ªæ–‡ä»¶ï¼Œè¾“å…¥å‘½ä»¤â€œ**:TOhtml**â€å°±çŸ¥é“æ•ˆæœäº†ï¼‰
- **vimballPlugin**ï¼šåˆ›å»ºå’Œè§£å¼€ .vba æ–‡ä»¶ï¼ˆè¿™ä¸ªç›®å‰ä¹Ÿç•¥è¿‡æ—¶äº†ï¼Œæˆ‘ä»¬ä¸è®²ï¼‰
- **zipPlugin**ï¼šç¼–è¾‘ zip æ–‡ä»¶ï¼ˆå’Œ tar æ–‡ä»¶ä¸åŒï¼Œzip æ–‡ä»¶å¯æ”¯æŒå†™å…¥ï¼‰



é™¤äº† rrhelper å’Œ spellfile å±äºåŠŸèƒ½æ”¯æŒæ’ä»¶ï¼Œæ²¡æœ‰è‡ªå·±çš„å¸®åŠ©é¡µé¢ï¼Œå…¶ä»–åŠŸèƒ½éƒ½å¯ä»¥ä½¿ç”¨â€œ`:help`â€å‘½ä»¤æ¥æŸ¥çœ‹å¸®åŠ©ã€‚æŸ¥çœ‹å¸®åŠ©æ—¶ï¼Œæ’ä»¶åç§°ä¸­çš„â€œPluginâ€åç¼€éœ€è¦å»æ‰ï¼šæŸ¥çœ‹ zip æ–‡ä»¶ç¼–è¾‘çš„å¸®åŠ©æ—¶ï¼Œåº”å½“ä½¿ç”¨â€œ`:help zip`â€è€Œä¸æ˜¯â€œ`:help zipPlugin`â€ã€‚



**netwæ’ä»¶çš„ç”¨æ³•**

```bash
# æ³¨æ„äº‹é¡¹1ï¼šç”¨æˆ·åå’Œå½“å‰ç”¨æˆ·åä¸€è‡´ï¼Œæˆ–è€…vim scp://user@www.mysticalrecluse.com//www/wwwroot/www.mysticalrecluse.com/script/
# æ³¨æ„äº‹é¡¹2ï¼šå¦‚æœæ˜¯è®¿é—®ç›®å½•ï¼Œç»“å°¾è¦åŠ /
# æ³¨æ„äº‹é¡¹3ï¼šå»ºè®®å†™ç»å¯¹è·¯å¾„ï¼švim scp://user@url/<ç»å¯¹è·¯å¾„>
[root@magedu ~]# vim scp://www.mysticalrecluse.com//www/wwwroot/www.mysticalrecluse.com/script/
```

![image-20250610164613309](D:\git_repository\cyber_security_learning\markdown_img\image-20250610164613309.png)



**ä½¿ç”¨vimæŸ¥çœ‹manæ‰‹å†Œ**

```bash
[root@magedu ~]# export MANPAGER="vim -M +MANPAGER -"
```

![image-20250610170738176](D:\git_repository\cyber_security_learning\markdown_img\image-20250610170738176.png)



#### ç”¨æˆ·çš„vimé…ç½®ç›®å½•

Vim çš„å®‰è£…ç›®å½•ä½ æ˜¯ä¸åº”è¯¥å»ä¿®æ”¹çš„ã€‚é¦–å…ˆï¼Œä½ å¯èƒ½æ²¡æœ‰æƒé™å»ä¿®æ”¹è¿™ä¸ªç›®å½•ï¼›å…¶æ¬¡ï¼Œå³ä½¿ä½ æœ‰ä¿®æ”¹æƒé™ï¼Œè¿™ä¸ªç›®å½•ä¼šåœ¨ Vim å‡çº§æ—¶è¢«è¦†ç›–ï¼Œä½ åšçš„ä¿®æ”¹ä¹Ÿä¼šä¸¢å¤±ã€‚ç”¨æˆ·è‡ªå·±çš„é…ç½®åº”å½“æ”¾åœ¨è‡ªå·±çš„ç›®å½•ä¸‹ï¼Œè¿™ä¹Ÿå°±æ˜¯ç”¨æˆ·è‡ªå·±çš„ä¸»ç›®å½•ä¸‹çš„ Vim é…ç½®ç›®å½•ï¼ˆUnix ä¸‹çš„ **.vim**ï¼ŒWindows ä¸‹çš„ **vimfiles**ï¼‰ã€‚è¿™ä¸ªç›®å½•åº”å’Œ Vim å®‰è£…ç›®å½•ä¸‹çš„è¿è¡Œæ”¯æŒæ–‡ä»¶ç›®å½•æœ‰ç›¸åŒçš„ç»“æ„ï¼Œä½†ä¸‹é¢çš„å­ç›®å½•ä½ åœ¨éœ€è¦ä¿®æ”¹ Vim çš„ç›¸å…³è¡Œä¸ºæ—¶æ‰æœ‰å¿…è¦åˆ›å»ºã€‚å¦‚æœä¸€ä¸ªåŒåæ–‡ä»¶å‡ºç°ç”¨æˆ·è‡ªå·±çš„ Vim é…ç½®ç›®å½•é‡Œå’Œ Vim çš„å®‰è£…ç›®å½•é‡Œï¼Œ**ç”¨æˆ·çš„æ–‡ä»¶ä¼˜å…ˆ**ã€‚



å…³äº Vim çš„å…¬ç”¨è„šæœ¬ï¼Œè¿™å„¿å†å¤šè¯´å‡ å¥ã€‚Vim çš„ç½‘ç«™è¿‡å»æ˜¯ç”¨æ¥é›†ä¸­è·å–å„ç§è„šæœ¬â€”â€”å¦‚æ’ä»¶å’Œé…è‰²æ–¹æ¡ˆâ€”â€”çš„åœ°æ–¹ï¼Œè€Œ getscriptPlugin å¯ä»¥å¸®åŠ©ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ã€‚ä»Šå¤©ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ï¼Œä½† Git å’Œ GitHub çš„å¹¿æ³›ä½¿ç”¨å·²ç»æ”¹å˜äº†äººä»¬è·å–å’Œæ›´æ–°è„šæœ¬çš„æ–¹å¼ã€‚ç°åœ¨ï¼Œæœ€ä¸»æµçš„åˆ†å‘ Vim è„šæœ¬çš„æ–¹å¼æ˜¯åˆ©ç”¨ GitHubï¼Œè€Œç”¨æˆ·åˆ™ä½¿ç”¨åŒ…ç®¡ç†å™¨æ¥è°ƒç”¨ Git ä» GitHubï¼ˆæˆ–ç±»ä¼¼çš„ Git åº“ï¼‰è·å–å’Œæ›´æ–°è„šæœ¬ã€‚







#### vim8 æ–°åŠŸèƒ½



##### vimè½¯ä»¶åŒ… (é‡è¦)

vimçš„é…ç½®ç›®å½•ç»“æ„

```bat
.
â”œâ”€â”€ colors
â”œâ”€â”€ doc
â”œâ”€â”€ pack
â”‚   â”œâ”€â”€ minpac
â”‚   â”‚   â”œâ”€â”€ opt
â”‚   â”‚   â”‚   â”œâ”€â”€ minpac
â”‚   â”‚   â”‚   â”œâ”€â”€ vim-airline
â”‚   â”‚   â”‚   â””â”€â”€ vimcdoc
â”‚   â”‚   â””â”€â”€ start
â”‚   â”‚       â”œâ”€â”€ VimExplorer
â”‚   â”‚       â”œâ”€â”€ asyncrun.vim
â”‚   â”‚       â”œâ”€â”€ fzf.vim
â”‚   â”‚       â”œâ”€â”€ gruvbox
â”‚   â”‚       â”œâ”€â”€ killersheep
â”‚   â”‚       â”œâ”€â”€ nerdcommenter
â”‚   â”‚       â”œâ”€â”€ nerdtree
â”‚   â”‚       â”œâ”€â”€ tagbar
â”‚   â”‚       â”œâ”€â”€ undotree
â”‚   â”‚       â”œâ”€â”€ vim-fugitive
â”‚   â”‚       â”œâ”€â”€ vim-matrix-screensaver
â”‚   â”‚       â”œâ”€â”€ vim-rainbow
â”‚   â”‚       â”œâ”€â”€ vim-repeat
â”‚   â”‚       â”œâ”€â”€ vim-rhubarb
â”‚   â”‚       â””â”€â”€ vim-surround
â”‚   â””â”€â”€ my
â”‚       â”œâ”€â”€ opt
â”‚       â”‚   â”œâ”€â”€ YouCompleteMe
â”‚       â”‚   â”œâ”€â”€ ale
â”‚       â”‚   â”œâ”€â”€ clang_complete
â”‚       â”‚   â”œâ”€â”€ cvsmenu
â”‚       â”‚   â””â”€â”€ syntastic
â”‚       â””â”€â”€ start
â”‚           â”œâ”€â”€ vim-gitgutter
â”‚           â””â”€â”€ ycmconf
â”œâ”€â”€ plugin
â”œâ”€â”€ syntax
â””â”€â”€ undodir
```

Vim 8 åœ¨å¯åŠ¨æ—¶ä¼šåŠ è½½æ‰€æœ‰ pack/*/start ä¸‹é¢çš„åŒ…ï¼Œè€Œç”¨æˆ·å¯ä»¥ç”¨ :packadd å‘½ä»¤æ¥åŠ è½½æŸä¸ª opt ç›®å½•ä¸‹çš„åŒ…ï¼Œå¦‚ `:packadd vimcdoc` å‘½ä»¤å¯åŠ è½½ vimcdoc åŒ…ï¼Œæ¥æ˜¾ç¤ºä¸­æ–‡å¸®åŠ©ä¿¡æ¯ã€‚

æœ‰äº†è¿™æ ·çš„ç›®å½•ç»“æ„ï¼Œç”¨æˆ·è¦è‡ªå·±å®‰è£…ã€ç®¡ç†åŒ…å°±æ–¹ä¾¿å¤šäº†ã€‚æ¨èä¸€ä¸ªåŒ…ç®¡ç†å™¨ `minpac`ã€‚åŒ…ç®¡ç†å™¨å¯ä»¥å¸¦æ¥ä¸‹é¢çš„å¥½å¤„ï¼š

- æ ¹æ®æ–‡æœ¬çš„é…ç½®ï¼ˆä¸€èˆ¬å†™åœ¨ vimrc é…ç½®æ–‡ä»¶é‡Œï¼‰å†³å®šè¦å®‰è£…å“ªäº›åŒ…
- è‡ªåŠ¨åŒ–å®‰è£…ã€å‡çº§å’Œå¸è½½ï¼ŒåŒ…æ‹¬å¸®åŠ©æ–‡ä»¶çš„ç´¢å¼•ç”Ÿæˆ



###### å®‰è£…minpac

```ABAP
ä»è¿™é‡Œä¹‹åçš„æ“ä½œï¼Œè¦æ±‚ç§‘å­¦ä¸Šç½‘
```

æ ¹æ® minpac ç½‘é¡µä¸Šçš„è¯´æ˜ï¼Œæˆ‘ä»¬åœ¨ Windows ä¸‹å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤

```bash
cd /d %USERPROFILE%
git clone https://github.com/k-takata/minpac.git ^
    vimfiles\pack\minpac\opt\minpac
```

åœ¨ Linux å’Œ macOS ä¸‹åˆ™å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼š

```bash
git clone https://github.com/k-takata/minpac.git \
    ~/.vim/pack/minpac/opt/minpac
```

ç„¶åï¼Œæˆ‘ä»¬åœ¨ vimrc é…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼ˆå…ˆä¸ç”¨ç†è§£å…¶å«ä¹‰ï¼‰ï¼š

```bash
if exists('*minpac#init')
  " Minpac is loaded.
  call minpac#init()
  call minpac#add('k-takata/minpac', {'type': 'opt'})

  " Other plugins
endif

if has('eval')
  " Minpac commands
  command! PackUpdate packadd minpac | source $MYVIMRC | call minpac#update('', {'do': 'call minpac#status()'})
  command! PackClean  packadd minpac | source $MYVIMRC | call minpac#clean()
  command! PackStatus packadd minpac | source $MYVIMRC | call minpac#status()
endif
```

å­˜ç›˜ã€é‡å¯ Vim ä¹‹åï¼Œæˆ‘ä»¬å°±æœ‰äº†ä¸‰ä¸ªæ–°çš„å‘½ä»¤ï¼Œå¯ä»¥ç”¨æ¥æ›´æ–°ï¼ˆå®‰è£…ï¼‰åŒ…ã€æ¸…ç†åŒ…å’Œæ£€æŸ¥å½“å‰åŒ…çš„çŠ¶æ€



###### é€šè¿‡ minpac å®‰è£…æ‰©å±•åŒ…

è¯•éªŒä¸€ä¸‹é€šè¿‡ minpac æ¥å®‰è£…æ‰©å±•åŒ…ã€‚åœ¨â€œOther pluginsâ€é‚£è¡Œä¸‹é¢åŠ å…¥ä»¥ä¸‹å†…å®¹ï¼š

```bash
call minpac#add('tpope/vim-eunuch')
```

ä¿å­˜æ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬ä½¿ç”¨ `:PackUpdate` å‘½ä»¤ã€‚ç•¥å¾®ç­‰å¾…ä¹‹åï¼Œå®‰è£…æˆåŠŸåï¼Œä½¿ç”¨`:PackStatus`æŸ¥çœ‹ï¼Œæˆ‘ä»¬å°±èƒ½çœ‹åˆ°ç±»ä¼¼ä¸‹é¢çš„ç•Œé¢

![image-20250610195213333](D:\git_repository\cyber_security_learning\markdown_img\image-20250610195213333.png)



###### æœ€è¿‘ä½¿ç”¨çš„æ–‡ä»¶

å®‰è£…å¥½ Vim è½¯ä»¶åŒ…ä¹‹åï¼Œæˆ‘ä»¬è¿›ä¸€æ­¥æ¥å®ç°ä¸€ä¸ªå°åŠŸèƒ½ã€‚

Vim çš„ç¼ºçœå®‰è£…ç¼ºäº†ä¸€ä¸ªå¾ˆå¤šç¼–è¾‘å™¨éƒ½æœ‰çš„åŠŸèƒ½ï¼šæœ€è¿‘ä½¿ç”¨çš„æ–‡ä»¶ã€‚

æˆ‘ä»¬å°±æŠŠè¿™ä¸ªåŠŸèƒ½è¡¥ä¸Šå§ã€‚ä½ åªéœ€è¦æŒ‰ç…§ä¸Šä¸€èŠ‚çš„æ­¥éª¤å®‰è£… yegappan/mru åŒ…å°±å¯ä»¥äº†ï¼ˆMRU ä»£è¡¨ most recently usedï¼‰ã€‚å®‰è£…å®Œä¹‹åï¼Œé‡æ–°æ‰“å¼€ vimrc æ–‡ä»¶ï¼Œä½ å°±å¯ä»¥åœ¨å›¾å½¢ç•Œé¢é‡Œçœ‹åˆ°ä¸‹é¢çš„èœå•äº†ï¼š

```bash
[root@magedu ~]# vim .vimrc
......
  " Other plugins
  call minpac#add('tpope/vim-eunuch')
  call minpac#add('yegappan/mru')     # æ·»åŠ è¿™è¡Œï¼Œåæ‰§è¡Œ:PackUpdate
......
```

```bat
å¦‚æœæ‰§è¡ŒPackUpdateæ˜¾ç¤ºè·¯å¾„ä¸å¯¹ï¼Œä¿®æ”¹ä¸‹é¢è·¯å¾„ä¸‹æ–‡ä»¶ï¼Œå°†å…¶æ”¹ä¸ºgithubåœ°å€å³å¯
[root@magedu ~]# vim /root/.vim/pack/minpac/opt/minpac/.git/config
[core]
        repositoryformatversion = 0
        filemode = true
        bare = false
        logallrefupdates = true
[remote "origin"]
        url = https://github.com/k-takata/minpac.git     # è¿™é‡Œè¦æ”¹ä¸ºgithubåœ°å€
        fetch = +refs/heads/*:refs/remotes/origin/*
[branch "master"]
        remote = origin
        merge = refs/heads/master
```



å®‰è£…æˆåŠŸåï¼Œåœ¨`.vimrc`é‡Œæ·»åŠ ä»¥ä¸‹å†…å®¹ï¼ˆæˆ‘ä»¬æš‚æ—¶å…ˆä¸ç”¨å»ç†è§£å…¶æ„ä¹‰ï¼‰

```bash
if !has('gui_running')
  " è®¾ç½®æ–‡æœ¬èœå•
  if has('wildmenu')
    set wildmenu
    set cpoptions-=<
    set wildcharm=<C-Z>
    nnoremap <F10>      :emenu <C-Z>
    inoremap <F10> <C-O>:emenu <C-Z>
  endif
endif
```

åœ¨å¢åŠ ä¸Šé¢çš„é…ç½®ä¹‹åï¼Œä½ å°±å¯ä»¥ä½¿ç”¨é”® `<F10>`ï¼ˆå½“ç„¶ä½ ä¹Ÿå¯ä»¥æ¢ç”¨å…¶ä»–é”®ï¼‰åŠ  `<Tab>`æ¥å”¤èµ· Vim çš„æ–‡æœ¬èœå•äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![image-20250610201716910](D:\git_repository\cyber_security_learning\markdown_img\image-20250610201716910.png)



### å¤šæ–‡ä»¶æ‰“å¼€ä¸ç¼“å†²åŒº

#### å¤šæ–‡ä»¶çš„æ‰“å¼€æ–¹å¼

```ABAP
å‡è®¾ä¸€ä¸ªç®€å•çš„ä½¿ç”¨åœºæ™¯ï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦åœ¨æŸä¸ªç›®å½•ä¸‹çš„æ‰€æœ‰ .cpp å’Œ .h æ–‡ä»¶å¼€å¤´è´´å…¥ä¸€æ®µç‰ˆæƒå£°æ˜ï¼Œè¯¥å¦‚ä½•æ“ä½œï¼Ÿ
```



é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ï¼ŒVim æ”¯æŒä¸€æ¬¡æ€§æ‰“å¼€å¤šä¸ªæ–‡ä»¶ï¼Œä½ åªéœ€è¦åœ¨å‘½ä»¤è¡Œä¸Šå†™å‡ºå¤šä¸ªæ–‡ä»¶å³å¯ï¼Œæˆ–è€…ä½¿ç”¨é€šé…ç¬¦ã€‚æ¯”å¦‚ï¼Œå°±æˆ‘ä»¬åˆšæ‰æ‰€è¯´çš„ç¼–è¾‘åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ vim *.cpp *.hã€‚

```bash
[root@magedu ~/test]# vim *.txt
```



ä¸ºäº†ç¡®ä¿åœ¨é…ç½®è¾ƒå·®çš„ç¯å¢ƒé‡Œä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼ŒVim ç»å¯¹ä¸ä¼šä¸å¿…è¦åœ°æ¶ˆè€—å†…å­˜ï¼ŒåŒ…æ‹¬æ‰“å¼€ä¸å¿…è¦ç«‹å³æ‰“å¼€çš„æ–‡ä»¶ã€‚æ‰€ä»¥åœ¨ä¸Šé¢çš„å‘½ä»¤åï¼ŒVim å»ºç«‹äº†ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨ï¼Œå¹¶ä¸”æš‚æ—¶åªæ‰“å¼€å…¶ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶ã€‚æ¥ä¸‹æ¥ï¼Œç”¨æˆ·å¯ä»¥å†³å®šï¼Œè¦ç¼–è¾‘å“ªä¸ªæ–‡ä»¶ï¼Œæˆ–è€…æŸ¥çœ‹åˆ—è¡¨ï¼Œæˆ–è€…æå‰é€€å‡ºï¼Œç­‰ç­‰ã€‚



ä¸ºæ­¤ï¼ŒVim æä¾›äº†ä»¥ä¸‹å‘½ä»¤ï¼š

- `:args`ï¼šå¯ä»¥æ˜¾ç¤ºâ€œå‚æ•°â€ï¼Œå³éœ€è¦ç¼–è¾‘çš„å¤šä¸ªæ–‡ä»¶çš„åˆ—è¡¨
- **`:args æ–‡ä»¶å`**ï¼šä½¿ç”¨æ–°çš„æ–‡ä»¶åæ›¿æ¢å‚æ•°åˆ—è¡¨
- `:next`ï¼ˆå¯ç¼©å†™ä¸º **`:n`**ï¼‰ï¼šæ‰“å¼€ä¸‹ä¸€ä¸ªæ–‡ä»¶ï¼›å¦‚å½“å‰æ–‡ä»¶ä¿®æ”¹ï¼ˆæœªå­˜ç›˜ï¼‰åˆ™ä¼šæŠ¥é”™ä¸­æ­¢ï¼Œä½†å¦‚æœå‘½ä»¤åé¢åŠ  ! åˆ™ä¼šæ”¾å¼ƒä¿®æ”¹å†…å®¹ï¼Œå…¶ä»–å‘½ä»¤ä¹Ÿç±»ä¼¼
- `:Next`ï¼ˆç¼©å†™ **`:N`**ï¼‰æˆ– :previousï¼ˆç¼©å†™ `:prev`ï¼‰ï¼šæ‰“å¼€ä¸Šä¸€ä¸ªæ–‡ä»¶
- `:first` æˆ– `:rewind` ï¼šå›åˆ°åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶
- `:last`ï¼šæ‰“å¼€åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªæ–‡ä»¶



ä½¿ç”¨è¿™äº›å‘½ä»¤ï¼Œæˆ‘ä»¬çš„å·¥ä½œæµå½“ç„¶å°±ä¼šå‘ç”Ÿå˜åŒ–äº†ï¼š

1. åœ¨ç»ˆç«¯é‡Œè¿›å…¥åˆ°ç›®æ ‡ç›®å½•ä¸‹
2. ä½¿ç”¨ `vim *.cpp *.h` æˆ– `gvim *.cpp *.h` æ¥æ‰“å¼€éœ€è¦ç¼–è¾‘çš„æ–‡ä»¶
3. å¯¹äºç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼Œä½¿ç”¨ä¹‹å‰çš„æ–¹æ³•è´´å…¥æ‰€éœ€çš„æ–‡æœ¬
4. ä½¿ç”¨ V è¿›å…¥è¡Œé€‰æ‹©çš„å¯è§†æ¨¡å¼ï¼Œç§»åŠ¨å…‰æ ‡é€‰ä¸­æ‰€éœ€çš„æ–‡æœ¬ï¼Œç„¶åä½¿ç”¨ y å¤åˆ¶é€‰ä¸­çš„å„è¡Œ
5. æ‰§è¡Œå‘½ä»¤ `:set autowrite`ï¼Œå‘Šè¯‰ Vim åœ¨åˆ‡æ¢æ–‡ä»¶æ—¶è‡ªåŠ¨å­˜ç›˜
6. æ‰§è¡Œå‘½ä»¤ `:n|normal ggP`ï¼Œåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶å¹¶æ‰§è¡Œæ­£å¸¸æ¨¡å¼å‘½ä»¤ ggPï¼Œè·³è½¬åˆ°æ–‡ä»¶å¼€å¤´å¹¶è´´å…¥æ–‡æœ¬
7. ç¡®è®¤ä¿®æ”¹æ— è¯¯åï¼Œé”®å…¥` :`ã€ä¸Šç®­å¤´å’Œå›è½¦ï¼Œé‡å¤æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤
8. å¾… Vim æŠ¥é”™è¯´å·²ç»åœ¨æœ€åä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œä½¿ç”¨ :w å­˜ç›˜ï¼Œæˆ– :wqï¼ˆæŠ‘æˆ–æ›´å¿«çš„ ZZï¼‰å­˜ç›˜é€€å‡º



ç¬¬ 6 æ­¥å¯ä»¥æ‹†æˆ :n å’Œ ggP ä¸¤æ­¥ï¼Œä½†æ–‡ä»¶æ•°é‡è¾ƒå¤šæ—¶ï¼Œåå¤æ‰‹å·¥æ•² ggP ä¹ŸæŒºç´¯çš„ã€‚å› æ­¤ï¼Œæˆ‘è¿™å„¿ä½¿ç”¨äº† normal å‘½ä»¤ï¼Œåœ¨å‘½ä»¤è¡Œæ¨¡å¼ä¸‹æ‰§è¡Œæ­£å¸¸æ¨¡å¼å‘½ä»¤ï¼Œä¸‹é¢å°±å¯ä»¥ç›´æ¥é‡å¤åˆ‡æ¢å‘½ä»¤åŠ ç²˜è´´å‘½ä»¤ï¼Œæˆ‘ä»¬çš„ç¼–è¾‘æ•ˆç‡ä¹Ÿå¾—ä»¥å¤§å¤§æå‡ã€‚



Vim è¿˜èƒ½è§£å†³ä¸€ä¸ª shell ç›¸å…³çš„ä¸ä¸€è‡´æ€§é—®é¢˜ã€‚å¦‚æœæˆ‘ä»¬è¦ç¼–è¾‘çš„æ–‡ä»¶é™¤äº†å½“å‰ç›®å½•ä¸‹çš„ï¼Œè¿˜æœ‰æ‰€æœ‰å­ç›®å½•ä¸‹çš„ï¼Œåœ¨å¤§éƒ¨åˆ† shell ä¸‹ï¼ŒåŒ…æ‹¬ Linux ä¸Šç¼ºçœçš„ Bashï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨â€œ*.cpp *.h **/*.cpp **/*.hâ€æ¥æŒ‘é€‰è¿™äº›æ–‡ä»¶ï¼Œé‡å¤ã€éº»çƒ¦ã€‚Vim åœ¨æ­¤å¤„é‡‡ç”¨äº†ç±»ä¼¼äº Zsh çš„ç®€åŒ–è¯­æ³•ï¼Œâ€œ**â€ä¹ŸåŒ…å«äº†å½“å‰ç›®å½•ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬åªéœ€æŠŠä¸Šé¢ç¬¬ 2 æ­¥æ”¹æˆä¸‹é¢è¿™æ ·å³å¯ï¼š

```bash
vim
args **/*.txt
```



#### ç¼“å†²åŒºçš„ç®¡ç†å’Œåˆ‡æ¢

Vim é‡Œä¼šå¯¹æ¯ä¸€ä¸ªå·²æ‰“å¼€æˆ–è¦æ‰“å¼€çš„æ–‡ä»¶åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºï¼Œè¿™ä¸ªç¼“å†²åŒºå°±æ˜¯æ–‡ä»¶åœ¨ Vim ä¸­çš„æ˜ å°„ã€‚åœ¨å¤šæ–‡ä»¶ç¼–è¾‘çš„æ—¶å€™ä½ ä¹Ÿä¼šæœ‰åŒæ ·æ•°é‡çš„ç¼“å†²åŒºã€‚ä¸è¿‡ï¼Œç¼“å†²åŒºçš„æ•°é‡å¸¸å¸¸ä¼šæ›´é«˜ï¼Œå› ä¸ºä½ ç”¨ :e ç­‰å‘½ä»¤æ‰“å¼€çš„æ–‡ä»¶ä¸ä¼šæ”¹å˜â€œå‘½ä»¤è¡Œå‚æ•°â€ï¼ˆåªè¢«å‘½ä»¤è¡Œæˆ– :args å‘½ä»¤ä¿®æ”¹ï¼‰ï¼Œä½†åŒæ ·ä¼šå¢åŠ ç¼“å†²åŒºçš„æ•°é‡ã€‚



æ­¤å¤–ï¼Œ:args ä»£è¡¨å‚æ•°åˆ—è¡¨ / æ–‡ä»¶åˆ—è¡¨ï¼ŒçœŸçš„åªæ˜¯æ–‡ä»¶çš„åˆ—è¡¨è€Œå·²ã€‚ç¼“å†²åŒºä¸­æœ‰æ›´å¤šä¿¡æ¯çš„ï¼Œæœ€æœ€åŸºæœ¬çš„å°±æ˜¯è®°å¿†äº†å…‰æ ‡çš„ä½ç½®ã€‚åœ¨ Vim é‡Œï¼Œé™¤äº†åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªæ–‡ä»¶è¿™æ ·çš„æ‰¹å¤„ç†æ“ä½œå¤–ï¼Œæ“ä½œç¼“å†²åŒºçš„å‘½ä»¤æ¯”ç®€å•æ“ä½œæ–‡ä»¶çš„å‘½ä»¤æ›´ä¸ºæ–¹ä¾¿ã€‚ä½œä¸ºå¯¹æ¯”ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹æ–‡ä»¶åˆ—è¡¨å’Œç¼“å†²åŒºåˆ—è¡¨

![image-20250610221743636](D:\git_repository\cyber_security_learning\markdown_img\image-20250610221743636.png)

![image-20250610221930287](D:\git_repository\cyber_security_learning\markdown_img\image-20250610221930287.png)

å¯ä»¥çœ‹åˆ°ï¼Œä¸¤è€…éƒ½å±•ç¤ºäº†æ–‡ä»¶ï¼Œéƒ½æ ‡ç¤ºå‡ºäº†å½“å‰ç¼–è¾‘çš„æ–‡ä»¶ï¼ˆåˆ†åˆ«ä½¿ç”¨æ–¹æ‹¬å·å’Œâ€œ%aâ€ï¼‰ã€‚ä¸è¿‡ï¼Œç¼“å†²åŒºåˆ—è¡¨ä¸­æ˜æ˜¾æœ‰æ›´å¤šçš„ä¿¡æ¯ï¼š

- æ–‡ä»¶åå‰é¢æœ‰ç¼–å·ï¼›æˆ‘ä»¬ä¹Ÿé©¬ä¸Šå°±ä¼šè¯´åˆ°åˆ©ç”¨ç¼–å·çš„å‘½ä»¤ã€‚
- é™¤äº†å½“å‰æ´»è·ƒæ–‡ä»¶çš„æ ‡è®°â€œ%aâ€ï¼Œè¿˜æœ‰ä¸ªæ–‡ä»¶è¢«æ ‡æˆäº†â€œ#â€ï¼Œè¿™è¡¨ç¤ºæœ€è¿‘çš„ç¼“å†²åŒºï¼›ç¼“å†²åŒºåˆ—è¡¨é‡Œè¿˜å¯èƒ½æœ‰å…¶ä»–æ ‡è®°ï¼Œå¦‚â€œ+â€è¡¨ç¤ºç¼“å†²åŒºå·²ç»è¢«ä¿®æ”¹ã€‚
- æ–‡ä»¶ååé¢æœ‰è¡Œå·ï¼Œè¡¨ç¤ºå…‰æ ‡åœ¨æ–‡ä»¶ä¸­çš„ä½ç½®ã€‚



å¸¸ç”¨çš„ç¼“å†²åŒºå‘½ä»¤è·Ÿå‰é¢æ–‡ä»¶åˆ—è¡¨ç›¸å…³çš„å‘½ä»¤æœ‰å¾ˆå¤§çš„ç›¸ä¼¼æ€§ï¼Œå› æ­¤æˆ‘åœ¨è¿™å„¿ä¸€èµ·è®²ï¼Œå¯ä»¥å¸®åŠ©ä½ è®°å¿†ï¼š

- `:buffers` æˆ– `:ls`ï¼šå¯ä»¥æ˜¾ç¤ºç¼“å†²åŒºçš„åˆ—è¡¨
- `:buffer ç¼“å†²åŒºåˆ—è¡¨é‡Œçš„ç¼–å·`ï¼ˆ`:buffer` å¯ç¼©å†™ä¸º `:b`ï¼‰ï¼šè·³è½¬åˆ°ç¼–å·å¯¹åº”çš„ç¼“å†²åŒºï¼›å¦‚å½“å‰ç¼“å†²åŒºå·²è¢«ä¿®æ”¹ï¼ˆæœªå­˜ç›˜ï¼‰åˆ™ä¼šæŠ¥é”™ä¸­æ­¢ï¼Œä½†å¦‚æœå‘½ä»¤åé¢åŠ  ! åˆ™ä¼šæ”¾å¼ƒä¿®æ”¹å†…å®¹ï¼›å…¶ä»–å‘½ä»¤ä¹Ÿç±»ä¼¼
- `:bdelete` ç¼“å†²åŒºåˆ—è¡¨é‡Œçš„ç¼–å·ï¼ˆ`:bdelete` å¯ç¼©å†™ä¸º`:bd`ï¼‰ï¼šåˆ é™¤ç¼–å·å¯¹åº”çš„ç¼“å†²åŒºï¼›ç¼–å·çœç•¥çš„è¯åˆ é™¤å½“å‰ç¼“å†²åŒº
- `:bnext`ï¼ˆç¼©å†™ `:bn`ï¼‰ï¼šè·³è½¬åˆ°ä¸‹ä¸€ä¸ªç¼“å†²åŒº
- `:bNext`ï¼ˆç¼©å†™ `:bN`ï¼‰æˆ– :bpreviousï¼ˆç¼©å†™ :bpï¼‰ï¼šè·³è½¬åˆ°ä¸Šä¸€ä¸ªç¼“å†²åŒº
- `:bfirst` æˆ– `:brewind`ï¼šè·³è½¬åˆ°ç¼“å†²åŒºåˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶
- `:blast`ï¼šè·³è½¬åˆ°ç¼“å†²åŒºåˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªæ–‡ä»¶



è¿˜æœ‰å¾ˆå¸¸è§çš„ä¸€ç§æƒ…å†µæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´åˆ‡æ¢ã€‚Vim å¯¹æœ€è¿‘ç¼–è¾‘çš„æ–‡ä»¶ï¼ˆä¸Šé¢æåˆ°çš„åˆ—è¡¨é‡Œæ ‡æœ‰â€œ#â€çš„æ–‡ä»¶ï¼‰æœ‰ç‰¹æ®Šçš„æ”¯æŒï¼Œä½¿ç”¨å¿«æ·é”® `<C-^>`å¯ä»¥åœ¨æœ€è¿‘çš„ä¸¤ä¸ªç¼“å†²åŒºä¹‹é—´æ¥å›åˆ‡æ¢ã€‚è¿™ä¸ªå¿«æ·é”®è¿˜æœ‰ä¸€ä¸ªç”¨æ³•æ˜¯åœ¨å‰é¢è¾“å…¥ç¼“å†²åŒºçš„ç¼–å·ï¼šæ¯”å¦‚ï¼Œç”¨ `1<C-^>` å¯ä»¥è·³è½¬åˆ°ç¬¬ä¸€ä¸ªç¼“å†²åŒºï¼ˆè·Ÿå‘½ä»¤è¡Œæ¨¡å¼çš„å‘½ä»¤ `:bfirst` æˆ– `:b1` æ•ˆæœç›¸åŒï¼‰ã€‚



### çª—å£å’Œæ ‡ç­¾é¡µ

#### å¤šçª—å£ç¼–è¾‘







### æ–‡ä»¶ç±»å‹åˆ¤æ–­å’Œå…³è”è®¾å®š

#### æ–‡ä»¶ç±»å‹åˆ¤æ–­

Vim çš„æ–‡ä»¶ç±»å‹åˆ¤æ–­æ˜¯åœ¨ filetype.vim ä¸­æ‰§è¡Œçš„ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ¥æ‰“å¼€è¿™ä¸ªæ–‡ä»¶

```bat
:e $VIMRUNTIME/filetype.vim
```







### vimè„šæœ¬

#### æ‰“å°å’Œè¾“å‡ºå­—ç¬¦ä¸²

```bat
echo 'Hello World!'   # echo æ˜¯ Vim ç”¨æ¥æ˜¾ç¤ºä¿¡æ¯çš„å†…ç½®å‘½ä»¤ï¼Œè€Œ 'Hello world!' æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡ã€‚
```

Vim é‡Œä¹Ÿå¯ä»¥ä½¿ç”¨ " æ¥å¼•èµ·ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚' å’Œ " çš„åŒºåˆ«å’Œåœ¨ shell é‡Œæ¯”è¾ƒç›¸ä¼¼ï¼Œå‰è€…é‡Œé¢ä¸å…è®¸æœ‰ä»»ä½•è½¬ä¹‰å­—ç¬¦ï¼Œè€Œåè€…åˆ™å¯ä»¥ä½¿ç”¨å¸¸è§çš„è½¬ä¹‰å­—ç¬¦åºåˆ—ï¼Œå¦‚ \n å’Œ \u.... ç­‰ã€‚å’Œ shell ä¸åŒçš„æ˜¯ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ ' æ‹¬èµ·çš„å­—ç¬¦é‡ŒæŠŠ ' é‡å¤ä¸€æ¬¡æ¥å¾—åˆ°è¿™ä¸ªå­—ç¬¦æœ¬èº«ï¼Œå³ `'It''s'` ç›¸å½“äº `"It's"`ã€‚ä¸è¿‡ï¼Œåœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œæ˜¾ç„¶è¿˜æ˜¯åè€…æ›´æ¸…æ™°äº†ã€‚



å› ä¸º `"` è¿˜æœ‰å¼€å§‹æ³¨é‡Šçš„ä½œç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æ¨èåœ¨ Vim è„šæœ¬é‡Œä½¿ç”¨ `'`ï¼Œé™¤éä½ éœ€è¦è½¬ä¹‰å­—ç¬¦åºåˆ—æˆ–è€…éœ€è¦æŠŠ `'` æœ¬èº«æ”¾åˆ°å­—ç¬¦ä¸²é‡Œã€‚



å­—ç¬¦ä¸²å¯ä»¥ç”¨ `.` è¿ç®—ç¬¦æ¥æ‹¼æ¥ã€‚ç”±äºå­—å…¸è®¿é—®ä¹Ÿå¯ä»¥ç”¨ `.` ï¼Œä¸ºäº†é¿å…æ­§ä¹‰ï¼ŒBram æ¨èå¼€å‘è€…åœ¨æ–°çš„ Vim è„šæœ¬ä¸­ä½¿ç”¨` .. `æ¥æ‹¼æ¥ã€‚ä½†è¦æ³¨æ„ï¼Œè¿™ä¸ªå†™æ³•åœ¨ Vim 7 åŠä¹‹å‰çš„ç‰ˆæœ¬é‡Œä¸æ”¯æŒã€‚æˆ‘ç›®å‰ä»æš‚æ—¶ä½¿ç”¨ . è¿›è¡Œå­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå¹¶å’Œå…¶ä»–å¤§éƒ¨åˆ†è¿ç®—ç¬¦ä¸€æ ·ï¼Œå‰åç©ºä¸€æ ¼ã€‚è¿™æ ·è·Ÿä¸ç©ºæ ¼çš„å­—å…¸ç”¨æ³•æ¯”èµ·æ¥ï¼Œå·®å¼‚å°±ç›¸å½“æ˜æ˜¾äº†ã€‚

```bat
:echo 'hello' . 'world'
# è¾“å‡ºï¼šhelloworld
```





é™¤äº† `echo`ï¼ŒVim è¿˜å¯ä»¥ç”¨ `echomsg`ï¼ˆç¼©å†™ `echom`ï¼‰å‘½ä»¤ï¼Œæ¥æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯ã€‚è·Ÿ echo ä¸åŒçš„æ˜¯ï¼Œè¿™æ¡æ¶ˆæ¯ä¸ä»…ä¼šæ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œè¿˜ä¼šä¿ç•™åœ¨æ¶ˆæ¯å†å²é‡Œï¼Œå¯ä»¥åœ¨ä¹‹åç”¨ `message` å‘½ä»¤æŸ¥çœ‹



#### å˜é‡

```bat
let answer = 42   # å˜é‡èµ‹å€¼
```

```bash
let a = 'hello'
let b = 'world'
echo a . b
# è¾“å‡ºï¼šhelloworld
```

Vim çš„å˜é‡å¯ä»¥æ‰‹å·¥å–æ¶ˆï¼Œéœ€è¦çš„å‘½ä»¤æ˜¯ `unlet`ã€‚åœ¨ä½ å†™äº† `unlet answer` ä¹‹åï¼Œä½ å°±ä¸èƒ½å†è¯»å– `answer` è¿™ä¸ªå˜é‡äº†ã€‚



#### æ•°å­—

ä¸Šé¢çš„èµ‹å€¼è¯­å¥ç”¨åˆ°äº†æ•´æ•°ã€‚Vim è„šæœ¬é‡Œçš„æ•°å­—æ”¯æŒæ•´æ•°å’Œæµ®ç‚¹æ•°ï¼Œåœ¨å¤§éƒ¨åˆ†å¹³å°ä¸Šï¼Œä¸¤è€…éƒ½æ˜¯ 64 ä½çš„æœ‰ç¬¦å·æ•°å­—ç±»å‹ï¼ŒåŸºæœ¬å¯¹åº”äºå¤§éƒ¨åˆ† C è¯­è¨€ç¯å¢ƒé‡Œçš„ int64_t å’Œ doubleã€‚è¡¨ç¤ºæ–¹å¼ä¹Ÿå’Œ C é‡Œé¢å·®ä¸å¤šï¼šæ•´æ•°å¯ä»¥ä½¿ç”¨ 0ï¼ˆå…«è¿›åˆ¶ï¼‰ã€0bï¼ˆäºŒè¿›åˆ¶ï¼‰å’Œ 0xï¼ˆåå…­è¿›åˆ¶ï¼‰å‰ç¼€ï¼›æµ®ç‚¹æ•°å«å°æ•°ç‚¹ï¼ˆä¸å¯çœç•¥ï¼‰ï¼Œå¯é€‰ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•ã€‚



#### å¤æ‚æ•°æ®ç»“æ„

##### åˆ—è¡¨ï¼ˆlistï¼‰

```js
let primes = [2, 3, 5, 7, 11, 13, 17, 19]
echo primes[0]  // è¾“å‡ºï¼š2
```



##### å­—å…¸ï¼ˆmapï¼‰

```bat
let int_squares = {
      \0: 0,         # \æ˜¯ç»­è¡Œï¼Œä¸‹ä¸€è¡Œçš„ç¬¬ä¸€ä¸ªéç©ºç™½å­—ç¬¦å¦‚æœæ˜¯ \ï¼Œåˆ™è¡¨ç¤ºè¿™ä¸€è¡Œè·Ÿä¸Šä¸€è¡Œåœ¨é€»è¾‘ä¸Šæ˜¯åŒä¸€è¡Œ
      \1: 1,
      \2: 4,
      \3: 9,
      \4: 16,
      \}
      
# è®¿é—®
int_squares['2']
int_squares.2       # äºŒè€…ç­‰ä»·
```



#### è¡¨è¾¾å¼

åœ¨æ’å…¥æ¨¡å¼å’Œå‘½ä»¤è¡Œæ¨¡å¼ä¸‹éƒ½å¯ä»¥ä½¿ç”¨æŒ‰é”® `<C-R>=`ï¼ˆä¸¤ä¸ªé”®ï¼‰åé¢è·Ÿä¸€ä¸ªè¡¨è¾¾å¼æ¥ä½¿ç”¨è¡¨è¾¾å¼çš„ç»“æœ

åœ¨æ›¿æ¢å‘½ä»¤ä¸­ï¼Œæˆ‘ä»¬åœ¨ `\=` åé¢ä¹ŸåŒæ ·å¯ä»¥è·Ÿä¸€ä¸ªè¡¨è¾¾å¼ï¼Œæ¥è¡¨ç¤ºä½¿ç”¨è¯¥è¡¨è¾¾å¼çš„ç»“æœã€‚

```bat
:%s/^/\=line('.') . ' '/    # åœ¨å½“å‰ç¼–è¾‘æ–‡ä»¶çš„æ¯ä¸€è¡Œå‰é¢æ’å…¥è¡Œå·å’Œç©ºæ ¼; line æ˜¯ Vim çš„ä¸€ä¸ªå†…ç½®å‡½æ•°ï¼Œline('.') è¡¨ç¤ºâ€œå½“å‰â€è¡Œçš„è¡Œå·
```





#### æ§åˆ¶ç»“æ„

Vim æ”¯æŒæ ‡å‡†çš„ `if`ã€`while` å’Œ `for` è¯­å¥ã€‚

Vim çš„å†™æ³•æœ‰ç‚¹è€æ´¾ï¼Œæ¯ç§ç»“æ„éƒ½è¦ç”¨ä¸€ä¸ªå¯¹åº”çš„ endifã€endwhile å’Œ endfor æ¥ç»“æŸï¼Œå¦‚ä¸‹é¢æ‰€ç¤ºï¼š

```bat
" ç®€å•æ¡ä»¶è¯­å¥
if è¡¨è¾¾å¼
  è¯­å¥
endif

" æœ‰ else åˆ†æ”¯çš„æ¡ä»¶è¯­å¥
if è¡¨è¾¾å¼
  è¯­å¥
else
  è¯­å¥
endif

" æ›´å¤æ‚çš„æ¡ä»¶è¯­å¥
if è¡¨è¾¾å¼
  è¯­å¥
elseif è¡¨è¾¾å¼
  è¯­å¥
else
  è¯­å¥
endif

" å¾ªç¯è¯­å¥
while è¡¨è¾¾å¼
  è¯­å¥
endwhile
```

åœ¨ while å’Œ for å¾ªç¯è¯­å¥é‡Œï¼Œä½ å¯ä»¥ä½¿ç”¨ break æ¥é€€å‡ºå¾ªç¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ continue æ¥è·³è¿‡å¾ªç¯ä½“å†…çš„å…¶ä»–è¯­å¥ã€‚



Vim è„šæœ¬çš„ for è¯­å¥è·Ÿ Python éå¸¸ç›¸ä¼¼ï¼Œå½¢å¼æ˜¯ï¼š

```bat
for var in object  // è¡¨ç¤ºéå† objectï¼ˆé€šå¸¸æ˜¯ä¸ªåˆ—è¡¨ï¼‰å¯¹è±¡é‡Œé¢çš„æ‰€æœ‰å…ƒç´ ã€‚
  è¿™å„¿å¯ä»¥ä½¿ç”¨ var
endfor
```



#### å‡½æ•°å’ŒåŒ¿åå‡½æ•°

##### **Vimscript å¸¸è§å†…ç½®å‡½æ•°åˆ†ç±» + ç”¨æ³•**



ğŸ”¹ **1. å­—ç¬¦ä¸²å¤„ç†å‡½æ•°**

| å‡½æ•°                                       | è¯´æ˜                | ç¤ºä¾‹                                                   |
| ------------------------------------------ | ------------------- | ------------------------------------------------------ |
| `len({expr})`                              | è¿”å›å­—ç¬¦ä¸²/åˆ—è¡¨é•¿åº¦ | `echo len("hello")` â†’ `5`                              |
| `tolower({str})`                           | è½¬å°å†™              | `echo tolower("VIM")` â†’ `vim`                          |
| `toupper({str})`                           | è½¬å¤§å†™              | `echo toupper("vim")` â†’ `VIM`                          |
| `substitute({str}, {pat}, {sub}, {flags})` | æ›¿æ¢å­—ç¬¦ä¸²          | `echo substitute("abc123","[0-9]","X","g")` â†’ `abcXXX` |
| `matchstr({expr}, {pat})`                  | æå–åŒ¹é…å­ä¸²        | `echo matchstr("error:404","[0-9]\\+")` â†’ `404`        |
| `split({str}, {pat})`                      | æŒ‰æ­£åˆ™åˆ†å‰²å­—ç¬¦ä¸²    | `echo split("a,b,c",",")` â†’ `['a','b','c']`            |
| `join({list}, {sep})`                      | è¿æ¥åˆ—è¡¨ä¸ºå­—ç¬¦ä¸²    | `echo join(['a','b','c'], '-')` â†’ `a-b-c`              |
| `trim({str})`                              | å»æ‰é¦–å°¾ç©ºæ ¼        | `echo trim("  hello  ")` â†’ `hello`                     |



ğŸ”¹ **2. åˆ—è¡¨ & å­—å…¸å¤„ç†**

| å‡½æ•°                       | è¯´æ˜                 | ç¤ºä¾‹                        |
| -------------------------- | -------------------- | --------------------------- |
| `add({list}, {item})`      | å‘åˆ—è¡¨è¿½åŠ å…ƒç´        | `let l = [1,2]              |
| `remove({list}, {idx})`    | åˆ é™¤åˆ—è¡¨æŒ‡å®šç´¢å¼•å…ƒç´  | `let l=[1,2,3]              |
| `extend({list1}, {list2})` | åˆå¹¶åˆ—è¡¨             | `let l=[1]                  |
| `keys({dict})`             | è¿”å›å­—å…¸æ‰€æœ‰é”®       | `let d={'a':1,'b':2}        |
| `values({dict})`           | è¿”å›å­—å…¸æ‰€æœ‰å€¼       | `echo values(d)` â†’ `[1,2]`  |
| `has_key({dict}, {key})`   | åˆ¤æ–­å­—å…¸æ˜¯å¦å« key   | `echo has_key(d,"a")` â†’ `1` |



ğŸ”¹ **3. æ•°å­¦ & é€»è¾‘**

| å‡½æ•°                    | è¯´æ˜       | ç¤ºä¾‹                        |
| ----------------------- | ---------- | --------------------------- |
| `abs({expr})`           | ç»å¯¹å€¼     | `echo abs(-10)` â†’ `10`      |
| `max({list})`           | æœ€å¤§å€¼     | `echo max([1,5,3])` â†’ `5`   |
| `min({list})`           | æœ€å°å€¼     | `echo min([1,5,3])` â†’ `1`   |
| `round({expr})`         | å››èˆäº”å…¥   | `echo round(3.6)` â†’ `4`     |
| `float2nr({float})`     | æµ®ç‚¹è½¬æ•´æ•° | `echo float2nr(3.14)` â†’ `3` |
| `and({expr1}, {expr2})` | ä½ä¸       | `echo and(6,3)` â†’ `2`       |
| `or({expr1}, {expr2})`  | ä½æˆ–       | `echo or(6,3)` â†’ `7`        |



ğŸ”¹ **4. æ–‡ä»¶ & è·¯å¾„**

| å‡½æ•°                           | è¯´æ˜               | ç¤ºä¾‹                                                        |
| ------------------------------ | ------------------ | ----------------------------------------------------------- |
| `expand({expr})`               | å±•å¼€è·¯å¾„/ç‰¹æ®Šç¬¦å·  | `echo expand("%:p")` â†’ å½“å‰æ–‡ä»¶ç»å¯¹è·¯å¾„                     |
| `fnamemodify({fname}, {mods})` | ä¿®æ”¹è·¯å¾„æ ¼å¼       | `echo fnamemodify("/home/user/file.txt",":t")` â†’ `file.txt` |
| `isdirectory({path})`          | åˆ¤æ–­æ˜¯å¦ä¸ºç›®å½•     | `echo isdirectory("/tmp")` â†’ `1`                            |
| `filereadable({fname})`        | æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯è¯» | `echo filereadable("file.txt")` â†’ `1`                       |
| `readfile({fname})`            | è¯»å–æ–‡ä»¶å†…å®¹åˆ°åˆ—è¡¨ | `echo readfile("file.txt")`                                 |
| `writefile({list}, {fname})`   | å°†åˆ—è¡¨å†™å…¥æ–‡ä»¶     | `call writefile(["hello"],"out.txt")`                       |



ğŸ”¹ **5. ç¼“å†²åŒº & ç¼–è¾‘å™¨**

| å‡½æ•°                      | è¯´æ˜               | ç¤ºä¾‹                             |
| ------------------------- | ------------------ | -------------------------------- |
| `line({expr})`            | è·å–è¡Œå·           | `echo line(".")` â†’ å½“å‰è¡Œå·      |
| `col({expr})`             | è·å–åˆ—å·           | `echo col(".")` â†’ å½“å‰åˆ—å·       |
| `getline({lnum})`         | è¯»å–æŒ‡å®šè¡Œå†…å®¹     | `echo getline(1)` â†’ ç¬¬ä¸€è¡Œæ–‡æœ¬   |
| `setline({lnum}, {text})` | è®¾ç½®è¡Œæ–‡æœ¬         | `call setline(1,"new text")`     |
| `append({lnum}, {text})`  | åœ¨æŒ‡å®šè¡Œåè¿½åŠ æ–‡æœ¬ | `call append(1,"inserted line")` |
| `bufexists({expr})`       | ç¼“å†²åŒºæ˜¯å¦å­˜åœ¨     | `echo bufexists("file.txt")`     |
| `bufname({expr})`         | è·å–ç¼“å†²åŒºåç§°     | `echo bufname("%")`              |



ğŸ”¹ **6. ç³»ç»Ÿäº¤äº’**

| å‡½æ•°                | è¯´æ˜                   | ç¤ºä¾‹                    |
| ------------------- | ---------------------- | ----------------------- |
| `system({cmd})`     | æ‰§è¡Œ shell å‘½ä»¤        | `echo system("ls")`     |
| `systemlist({cmd})` | ä»¥åˆ—è¡¨å½¢å¼è¿”å›å‘½ä»¤è¾“å‡º | `echo systemlist("ls")` |
| `hostname()`        | è¿”å›ä¸»æœºå             | `echo hostname()`       |
| `getpid()`          | è·å–å½“å‰ Vim è¿›ç¨‹ ID   | `echo getpid()`         |



ğŸ”¹ **7. ç±»å‹æ£€æµ‹**

| å‡½æ•°             | è¯´æ˜                                            | ç¤ºä¾‹                            |
| ---------------- | ----------------------------------------------- | ------------------------------- |
| `type({expr})`   | è¿”å›ç±»å‹ç¼–å·ï¼ˆ0=string,1=number,3=list,4=dictï¼‰ | `echo type([1,2])` â†’ `3`        |
| `string({expr})` | è½¬æ¢ä¸ºå­—ç¬¦ä¸²                                    | `echo string([1,2])` â†’ `[1, 2]` |
| `eval({string})` | è®¡ç®—å­—ç¬¦ä¸²è¡¨è¾¾å¼                                | `echo eval("1+2")` â†’ `3`        |



###### ğŸ¯ **å®æˆ˜ä¾‹å­**

âœ… **ç¤ºä¾‹ 1ï¼šæå–å½“å‰æ–‡ä»¶æ‰©å±•å**

```js
let fname = expand("%:t")
let ext = fnamemodify(fname, ":e")
echo "å½“å‰æ–‡ä»¶æ‰©å±•å: " . ext
```



âœ… **ç¤ºä¾‹ 2ï¼šè¯»å–æ–‡ä»¶å¹¶æ›¿æ¢æ‰€æœ‰æ•°å­—**

```js
let lines = readfile("input.txt")
for i in range(len(lines))
    let lines[i] = substitute(lines[i], '\d', 'X', 'g')
endfor
call writefile(lines, "output.txt")
```



âœ… **ç¤ºä¾‹ 3ï¼šæ£€æŸ¥æŸä¸ªæ–‡ä»¶æ˜¯å¦å­˜åœ¨**

```js
let file="/etc/passwd"
if filereadable(file)
    echo file . " å­˜åœ¨"
else
    echo file . " ä¸å­˜åœ¨"
endif
```



Vim è„šæœ¬é‡Œå®šä¹‰å‡½æ•°ä½¿ç”¨ä¸‹é¢çš„è¯­æ³•ï¼š

```bat
function å‡½æ•°å(å‚æ•°1, å‚æ•°2, ...)
  å‡½æ•°å†…å®¹
endfunction
```

Vim é‡Œç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°å¿…é¡»é¦–å­—æ¯å¤§å†™ï¼ˆå’Œå†…ç½®å‡½æ•°ç›¸åŒºåˆ«ï¼‰æˆ–è€…ä½¿ç”¨ `s:` è¡¨ç¤ºè¯¥å‡½æ•°åªåœ¨å½“å‰è„šæœ¬æ–‡ä»¶æœ‰æ•ˆã€‚`...` å¯ä»¥å‡ºç°åœ¨å‚æ•°åˆ—è¡¨çš„ç»“å°¾ï¼Œè¡¨ç¤ºå¯ä»¥ä¼ é€’é¢å¤–çš„æ— åå‚æ•°ã€‚ä½¿ç”¨æœ‰åå­—çš„å‚æ•°æ—¶ï¼Œä½ éœ€è¦åŠ ä¸Š `a:` å‰ç¼€ã€‚è¦è®¿é—®é¢å¤–å‚æ•°ï¼Œåˆ™éœ€è¦ä½¿ç”¨ `a:1`ã€`a:2` è¿™æ ·çš„å½¢å¼ã€‚ç‰¹æ®Šåå­— `a:0` è¡¨ç¤ºé¢å¤–å‚æ•°çš„æ•°é‡ï¼Œ`a:000` è¡¨ç¤ºæŠŠé¢å¤–å‚æ•°å½“æˆåˆ—è¡¨æ¥ä½¿ç”¨ï¼Œå› è€Œ `a:000[0]` å°±ç›¸å½“äº `a:1`ã€‚



åœ¨å‡½æ•°é‡Œé¢ï¼Œè·Ÿå¤§éƒ¨åˆ†è¯­è¨€ä¸€æ ·ï¼Œä½ å¯ä»¥ä½¿ç”¨ return å‘½ä»¤è¿”å›ä¸€ä¸ªç»“æœï¼Œæˆ–æå‰ç»“æŸå‡½æ•°çš„æ‰§è¡Œã€‚





##### å‡½æ•°å¤–éƒ¨å¼•ç”¨

âœ… **1. ä½¿ç”¨ `:source` å¼•å…¥å¤–éƒ¨è„šæœ¬**

```bash
source ~/myvim/myplugin.vim
```

- `source {filename}` â†’ è¯»å–å¹¶æ‰§è¡ŒæŒ‡å®šçš„ Vimscript æ–‡ä»¶ã€‚
- æ”¯æŒç»å¯¹è·¯å¾„å’Œç›¸å¯¹è·¯å¾„ã€‚



âœ… **2. åœ¨ `.vimrc` ä¸­ä½¿ç”¨**

```bash
# " ä¾‹å¦‚å°†è‡ªå®šä¹‰å‡½æ•°æ”¾åœ¨ ~/.vim/scripts/myfuncs.vim
source ~/.vim/scripts/myfuncs.vim
```

ğŸ’¡ **è¿™æ · `.vimrc` å¯ä»¥ä¿æŒç®€æ´ï¼ŒæŠŠæ’ä»¶æˆ–é…ç½®æ‹†åˆ†åˆ°å¤šä¸ªæ–‡ä»¶ã€‚**



âœ… **3. ä½¿ç”¨ `runtime`ï¼ˆæŸ¥æ‰¾ runtimepathï¼‰**

```bash
runtime myplugin.vim
```

- `runtime {file}` ä¼šåœ¨ `runtimepath` ä¸‹æ‰€æœ‰ç›®å½•æŸ¥æ‰¾è¯¥æ–‡ä»¶ã€‚

  > æŸ¥çœ‹runtimepath
  >
  > ```bash
  > echo &runtimepath
  > ```

- é€‚ç”¨äºä½ æŠŠè„šæœ¬æ”¾åœ¨ `~/.vim/plugin/` æˆ– `~/.vim/scripts/`ã€‚



ç¤ºä¾‹ï¼š

```bash
:echo &runtimepath
/root/.vim,/root/.vim/pack/minpac/start/vim-translator,/root/.vim/pack/minpac/start/vim-eunuch,/root/.vim/pack/minpac/start/vim-cursorword,/root/.vim/pack/minpac/start/vim-auto-cursorline,/root/.vim/pack/minpac/start/vim-airline-themes,/root/.vim/pack/minpac/start/vim-airline,/root/.vim/pack/minpac/start/mru,/var/lib/vim/addons,/etc/vim,/usr/share/vim/vimfiles,/usr/share/vim/vim82,/usr/share/v
im/vimfiles/after,/etc/vim/after,/var/lib/vim/addons/after,/root/.vim/after
```

```bash
# åœ¨/root/.vimç›®å½•ä¸‹åˆ›å»ºtest.vim
[root@ubuntu2204 ~]#vim .vim/test.vim
function Add(num1, num2)                                                                                     
    echo eval("a:num1+a:num2")
endfunction
```

```bash
# åœ¨.vimrcä¸­æ·»åŠ 
[root@ubuntu2204 ~]#vim .vimrc
runtime test.vim   

# æ‰§è¡Œå‡½æ•°
:call Add(1,2) --> è¿”å›3
```





##### åŒ¿åå‡½æ•°

vim è„šæœ¬é‡Œå…è®¸åŒ¿åå‡½æ•°ï¼Œå½¢å¼æ˜¯ {é€—å·åˆ†éš”å¼€çš„å‚æ•° -> è¡¨è¾¾å¼}ã€‚

```bat
echo map(range(1, 5), {idx, val -> val * val})

# rang(1,5) = [1,2,3,4,5]
# idxä¸ºåˆ—è¡¨çš„ç´¢å¼•ï¼Œvalæ˜¯åˆ—è¡¨çš„å€¼
```



##### has()å‡½æ•°

`has({feature})` æ˜¯ **Vim å†…ç½®å‡½æ•°**ï¼Œè¿”å›ï¼š

- `1` â†’ æ”¯æŒè¯¥ç‰¹æ€§
- `0` â†’ ä¸æ”¯æŒ

**`has('eval')`**ï¼šæ£€æŸ¥ Vim æ˜¯å¦æ”¯æŒ `:eval`ï¼ˆè¡¨è¾¾å¼æ±‚å€¼ï¼‰ã€‚

- å‡ ä¹æ‰€æœ‰ç°ä»£ Vim éƒ½è¿”å› `1`ã€‚
- æœ‰äº›åŠŸèƒ½ï¼ˆå¦‚ `popup_create`ï¼‰ä¹Ÿå¯ä»¥é€šè¿‡ `has('popupwin')` æ£€æŸ¥ã€‚



å¯ä»¥é€šè¿‡`vim --version` æŸ¥çœ‹å½“å‰vimæ”¯æŒå“ªäº›ç‰¹æ€§ï¼Œä»è€Œä½¿ç”¨hasè¿›è¡Œåˆ¤æ–­

```bash
[root@ubuntu2204 ~]#vim --version
VIM - Vi IMproved 8.2 (2019 Dec 12, compiled Apr 02 2025 12:39:01)
åŒ…å«è¡¥ä¸: 1-16, 647, 17-579, 1969, 580-647, 678, 648-1848, 4975, 5016, 5023, 5072, 2068, 1849-1854, 1857, 1855-1857, 1331, 1858, 1858-1859, 1873, 1860-1969, 1992, 1970-1992, 2010, 1993-2068, 2106, 2069-2106, 2108, 2107-2109, 2109-3995, 4563, 4646, 4774, 4895, 4899, 4901, 4919, 213, 1840, 1846-1847, 2110-2112, 2121
ä¿®æ”¹è€… team+vim@tracker.debian.org
ç¼–è¯‘è€… team+vim@tracker.debian.org
å·¨å‹ç‰ˆæœ¬ æ— å›¾å½¢ç•Œé¢ã€‚  å¯ä½¿ç”¨(+)ä¸ä¸å¯ä½¿ç”¨(-)çš„åŠŸèƒ½:
+acl               +file_in_path      +mouse_urxvt       -tag_any_white
+arabic            +find_in_path      +mouse_xterm       -tcl
+autocmd           +float             +multi_byte        +termguicolors
+autochdir         +folding           +multi_lang        +terminal
-autoservername    -footer            -mzscheme          +terminfo
-balloon_eval      +fork()            +netbeans_intg     +termresponse
+balloon_eval_term +gettext           +num64             +textobjects
-browse            -hangul_input      +packages          +textprop
++builtin_terms    +iconv             +path_extra        +timers
+byte_offset       +insert_expand     -perl              +title
+channel           +ipv6              +persistent_undo   -toolbar
+cindent           +job               +popupwin          +user_commands
-clientserver      +jumplist          +postscript        +vartabs
-clipboard         +keymap            +printer           +vertsplit
+cmdline_compl     +lambda            +profile           +vim9script
+cmdline_hist      +langmap           -python            +viminfo
+cmdline_info      +libcall           +python3           +virtualedit
+comments          +linebreak         +quickfix          +visual
+conceal           +lispindent        +reltime           +visualextra
+cryptv            +listcmds          +rightleft         +vreplace
+cscope            +localmap          -ruby              +wildignore
+cursorbind        -lua               +scrollbind        +wildmenu
+cursorshape       +menu              +signs             +windows
+dialog_con        +mksession         +smartindent       +writebackup
+diff              +modify_fname      +sodium            -X11
+digraphs          +mouse             -sound             -xfontset
-dnd               -mouseshape        +spell             -xim
-ebcdic            +mouse_dec         +startuptime       -xpm
+emacs_tags        +mouse_gpm         +statusline        -xsmp
+eval              -mouse_jsbterm     -sun_workshop      -xterm_clipboard
+ex_extra          +mouse_netterm     +syntax            -xterm_save
+extra_search      +mouse_sgr         +tag_binary        
-farsi             -mouse_sysmouse    -tag_old_static  
```









#### vimç‰¹æ€§

##### å˜é‡çš„å‰ç¼€

- `a:` è¡¨ç¤ºè¿™ä¸ªå˜é‡æ˜¯å‡½æ•°å‚æ•°ï¼Œåªèƒ½åœ¨å‡½æ•°å†…ä½¿ç”¨ã€‚
- `g:` è¡¨ç¤ºè¿™ä¸ªå˜é‡æ˜¯å…¨å±€å˜é‡ï¼Œå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è®¿é—®ã€‚
- `l:` è¡¨ç¤ºè¿™ä¸ªå˜é‡æ˜¯æœ¬åœ°å˜é‡ï¼Œä½†ä¸€èˆ¬è¿™ä¸ªå‰ç¼€ä¸éœ€è¦ä½¿ç”¨ï¼Œé™¤éä½ è·Ÿç³»ç»Ÿçš„æŸä¸ªåå­—å‘ç”Ÿäº†å†²çªã€‚
- `s:`è¡¨ç¤ºè¿™ä¸ªå˜é‡ï¼ˆæˆ–å‡½æ•°ï¼Œå®ƒä¹Ÿèƒ½ç”¨åœ¨å‡½æ•°ä¸Šï¼‰åªèƒ½ç”¨äºå½“å‰è„šæœ¬ï¼Œæœ‰ç‚¹åƒ C é‡Œé¢çš„ static å˜é‡å’Œå‡½æ•°ï¼Œåªåœ¨å½“å‰è„šæœ¬æ–‡ä»¶æœ‰æ•ˆï¼Œå› è€Œä¸ä¼šå½±å“å…¶ä»–è„šæœ¬æ–‡ä»¶é‡Œå®šä¹‰çš„æœ‰å†²çªçš„åå­—ã€‚





#### æ¨¡å¼æ˜ å°„ Model Mapping

Normalæ¨¡å¼ï¼š`nmap`

Visualæ¨¡å¼ï¼š`vmap`

Insertæ¨¡å¼ï¼š`imap`

```bash
nmap - dd         # åœ¨ normal æ¨¡å¼ä¸‹ï¼šå°† dd æ›¿æ¢ä¸º -
vmap - <ESC>dd    # åœ¨ visual æ¨¡å¼ä¸‹ï¼šå°† ESC+dd æ›¿æ¢ä¸º -
imap - <ESC>dd    # åœ¨ insert æ¨¡å¼ä¸‹ï¼šå°† ESC+dd æ›¿æ¢ä¸º -
```





#### Autocommands

ä½¿ç”¨ `:edit foo` æ‰“å¼€ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œç„¶åç«‹å³ä½¿ç”¨ `:quit` å…³é—­å®ƒã€‚æŸ¥çœ‹ç¡¬ç›˜é©±åŠ¨å™¨ï¼Œä½ ä¼šå‘ç°è¯¥æ–‡ä»¶ä¸è§äº†ã€‚è¿™æ˜¯å› ä¸º Vim ç›´åˆ°ä½ ç¬¬ä¸€æ¬¡ä¿å­˜æ—¶æ‰ä¼šçœŸæ­£åˆ›å»ºè¯¥æ–‡ä»¶ã€‚

##### ç¤ºä¾‹æ¼”ç¤º

```bash
# åœ¨ .vimrc æ·»åŠ  
autocmd BufNewFile * :write
```

å†æ¬¡è¿è¡Œ :edit foo å‘½ä»¤ï¼Œç”¨ :quit å‘½ä»¤å…³é—­å®ƒï¼Œç„¶åæŸ¥çœ‹ä½ çš„ç¡¬ç›˜ã€‚è¿™æ¬¡æ–‡ä»¶è¿˜åœ¨ï¼ˆå½“ç„¶ï¼Œæ˜¯ç©ºçš„ï¼‰ã€‚



##### Autocommand ç»“æ„

```bash
:autocmd BufNewFile * :write
         ^          ^ ^
         |          | |
         |          | The command to run.
         |          |
         |          A "pattern" to filter the event.
         |
         The "event" to watch for.
```



å‘½ä»¤çš„ç¬¬ä¸€éƒ¨åˆ†æ˜¯æˆ‘ä»¬è¦ç›‘è§†çš„äº‹ä»¶ç±»å‹ã€‚Vim æä¾›äº†*è®¸å¤š*å¯ä¾›ç›‘è§†çš„äº‹ä»¶ã€‚å…¶ä¸­åŒ…æ‹¬ï¼š

- å¼€å§‹ç¼–è¾‘å°šä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚
- è¯»å–æ–‡ä»¶ï¼Œæ— è®ºå…¶æ˜¯å¦å­˜åœ¨ã€‚
- åˆ‡æ¢ç¼“å†²åŒºçš„`filetype`è®¾ç½®ã€‚
- ä¸€æ®µæ—¶é—´å†…æ²¡æœ‰æŒ‰ä¸‹é”®ç›˜ä¸Šçš„æŸä¸ªé”®ã€‚
- è¿›å…¥æ’å…¥æ¨¡å¼ã€‚
- é€€å‡ºæ’å…¥æ¨¡å¼ã€‚



å‘½ä»¤çš„ä¸‹ä¸€éƒ¨åˆ†æ˜¯ä¸€ä¸ªâ€œæ¨¡å¼â€ï¼Œå®ƒèƒ½è®©ä½ æ›´æ˜ç¡®åœ°æŒ‡å®šå‘½ä»¤çš„è§¦å‘æ—¶é—´ã€‚å¯åŠ¨ä¸€ä¸ªæ–°çš„ Vim å®ä¾‹å¹¶è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
:autocmd BufNewFile *.txt :write
```

è¿™ä¸ä¸Šä¸€ä¸ªå‘½ä»¤å‡ ä¹ç›¸åŒï¼Œä½†è¿™æ¬¡å®ƒåªé€‚ç”¨äºåç§°ä»¥ ç»“å°¾çš„æ–‡ä»¶`.txt`ã€‚



##### **Vim autocmd äº‹ä»¶é€ŸæŸ¥è¡¨ï¼ˆ50+ äº‹ä»¶ï¼‰**

| **åˆ†ç±»**          | **äº‹ä»¶**         | **è§¦å‘æ—¶æœº**      | **ç¤ºä¾‹**                                     |
| ----------------- | ---------------- | ----------------- | -------------------------------------------- |
| **æ–‡ä»¶è¯»å†™**      | `BufNewFile`     | æ–°å»ºæ–‡ä»¶ç¼“å†²åŒº    | `autocmd BufNewFile *.sh call SetTitle()`    |
|                   | `BufRead`        | è¯»å…¥æ–‡ä»¶          | `autocmd BufRead *.log set filetype=log`     |
|                   | `BufReadPre`     | è¯»å…¥æ–‡ä»¶å‰        | `autocmd BufReadPre * echo "å‡†å¤‡è¯»å–"`       |
|                   | `BufReadPost`    | è¯»å…¥æ–‡ä»¶å        | `autocmd BufReadPost *.py normal! gg=G`      |
|                   | `BufWritePre`    | å†™æ–‡ä»¶å‰          | `autocmd BufWritePre * %s/\s\+$//e`          |
|                   | `BufWritePost`   | å†™æ–‡ä»¶å          | `autocmd BufWritePost * echo "ä¿å­˜æˆåŠŸ"`     |
|                   | `FileWritePre`   | `:write` å†™æ–‡ä»¶å‰ |                                              |
|                   | `FileWritePost`  | `:write` å†™æ–‡ä»¶å |                                              |
|                   | `FileAppendPre`  | è¿½åŠ æ–‡ä»¶å‰        |                                              |
|                   | `FileAppendPost` | è¿½åŠ æ–‡ä»¶å        |                                              |
| **ç¼“å†²åŒº**        | `BufEnter`       | è¿›å…¥ç¼“å†²åŒº        | `autocmd BufEnter *.md setlocal spell`       |
|                   | `BufLeave`       | ç¦»å¼€ç¼“å†²åŒº        | `autocmd BufLeave * echo "ç¦»å¼€ç¼“å†²åŒº"`       |
|                   | `BufUnload`      | ç¼“å†²åŒºå¸è½½        |                                              |
|                   | `BufDelete`      | ç¼“å†²åŒºè¢«åˆ é™¤      |                                              |
| **çª—å£**          | `WinEnter`       | è¿›å…¥çª—å£          | `autocmd WinEnter * echo "è¿›å…¥çª—å£"`         |
|                   | `WinLeave`       | ç¦»å¼€çª—å£          | `autocmd WinLeave * echo "ç¦»å¼€çª—å£"`         |
| **æ’å…¥/å‘½ä»¤**     | `InsertEnter`    | è¿›å…¥æ’å…¥æ¨¡å¼      | `autocmd InsertEnter * echo "æ’å…¥æ¨¡å¼"`      |
|                   | `InsertLeave`    | é€€å‡ºæ’å…¥æ¨¡å¼      | `autocmd InsertLeave * echo "é€€å‡ºæ’å…¥"`      |
|                   | `CmdlineEnter`   | è¿›å…¥å‘½ä»¤è¡Œæ¨¡å¼    | `autocmd CmdlineEnter * echo "å‘½ä»¤è¡Œ"`       |
|                   | `CmdlineLeave`   | é€€å‡ºå‘½ä»¤è¡Œæ¨¡å¼    | `autocmd CmdlineLeave * echo "é€€å‡ºå‘½ä»¤è¡Œ"`   |
| **é€€å‡º/å¯åŠ¨**     | `VimEnter`       | Vim å¯åŠ¨å        | `autocmd VimEnter * echo "æ¬¢è¿ä½¿ç”¨Vim"`      |
|                   | `VimLeave`       | Vim é€€å‡ºæ—¶        | `autocmd VimLeave * echo "Bye~"`             |
|                   | `VimLeavePre`    | é€€å‡ºå‰            |                                              |
|                   | `VimResized`     | ç»ˆç«¯çª—å£å¤§å°å˜åŒ–  | `autocmd VimResized * wincmd =`              |
| **æ–‡ä»¶ç±»å‹/è¯­æ³•** | `FileType`       | æ–‡ä»¶ç±»å‹æ£€æµ‹å    | `autocmd FileType python setlocal tabstop=4` |
|                   | `Syntax`         | è¯­æ³•é«˜äº®åŠ è½½æ—¶    | `autocmd Syntax * echo "åŠ è½½è¯­æ³•"`           |
|                   | `ColorScheme`    | åˆ‡æ¢é¢œè‰²ä¸»é¢˜æ—¶    | `autocmd ColorScheme * echo "ä¸»é¢˜åˆ‡æ¢"`      |
| **å‰ªè´´æ¿/æ–‡æœ¬**   | `TextYankPost`   | æ–‡æœ¬ yank å      | `autocmd TextYankPost * echo "å¤åˆ¶æˆåŠŸ"`     |
|                   | `TextChanged`    | ç¼“å†²åŒºæ–‡æœ¬è¢«ä¿®æ”¹  | `autocmd TextChanged * echo "æ–‡ä»¶ä¿®æ”¹"`      |
|                   | `TextChangedI`   | æ’å…¥æ¨¡å¼ä¿®æ”¹æ–‡æœ¬  |                                              |
| **ä¼šè¯/æ ‡ç­¾é¡µ**   | `TabEnter`       | è¿›å…¥æ ‡ç­¾é¡µ        | `autocmd TabEnter * echo "è¿›å…¥Tab"`          |
|                   | `TabLeave`       | ç¦»å¼€æ ‡ç­¾é¡µ        | `autocmd TabLeave * echo "ç¦»å¼€Tab"`          |
| **å…¶ä»–æœ‰ç”¨**      | `FocusGained`    | Vim çª—å£è·å¾—ç„¦ç‚¹  | `autocmd FocusGained * checktime`            |
|                   | `FocusLost`      | Vim çª—å£å¤±å»ç„¦ç‚¹  | `autocmd FocusLost * wall`                   |
|                   | `CursorHold`     | å…‰æ ‡é™æ­¢ä¸€æ®µæ—¶é—´  | `autocmd CursorHold * echo "å…‰æ ‡åœç•™"`       |
|                   | `CursorMoved`    | å…‰æ ‡ç§»åŠ¨æ—¶        |                                              |



#### å¼¹çª—

##### åˆ›å»ºå¼¹çª—

å‡½æ•°åŸå‹

```bash
popup_create({text}, {options})
```

- **`{text}`** â†’ å¼¹çª—æ˜¾ç¤ºçš„æ–‡æœ¬ï¼Œå¯ä»¥æ˜¯ï¼š
  - å­—ç¬¦ä¸²
  - å­—ç¬¦ä¸²åˆ—è¡¨
- **`{options}`** â†’ é…ç½®è¡¨ï¼ˆå­—å…¸ï¼‰ï¼Œå¯ä»¥è®¾ç½®ï¼š
  - `line` / `col` â†’ å¼¹çª—ä½ç½®
  - `minwidth` / `minheight` â†’ å¼¹çª—å°ºå¯¸
  - `border` â†’ è¾¹æ¡†æ ·å¼
  - `title` â†’ æ ‡é¢˜
  - `highlight` â†’ é«˜äº®ç»„
  - `time` â†’ è‡ªåŠ¨å…³é—­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  - `wrap` â†’ æ˜¯å¦æ¢è¡Œ
  - `pos` â†’ ä½ç½®ï¼ˆ`topleft`, `center` ç­‰ï¼‰



ç¤ºä¾‹ï¼šæœ€ç®€å•çš„å¼¹çª—

```bash
call popup_create('Hello Vim!', {})
```



ç¤ºä¾‹ï¼šå¸¦ä½ç½®å’Œè¾¹æ¡†

```bash
call popup_create(['Line1','Line2'], #{line: 5, col: 10, border: [], title: 'MyPopup'})
```



ç¤ºä¾‹ï¼šè‡ªåŠ¨æ¶ˆå¤±çš„æç¤º

```bash
# å¼¹çª— 2 ç§’åè‡ªåŠ¨å…³é—­ã€‚
call popup_create('ä¿å­˜æˆåŠŸï¼', #{time: 2000, line: 3, col: 20})
```



**ç›¸å…³å‡½æ•°**

- `popup_close({id})` â†’ å…³é—­å¼¹çª—
- `popup_move({id}, {options})` â†’ ç§»åŠ¨å¼¹çª—
- `popup_settext({id}, {text})` â†’ ä¿®æ”¹å¼¹çª—å†…å®¹
- `popup_setoptions({id}, {options})` â†’ ä¿®æ”¹å¼¹çª—å±æ€§



#### runtimepath

Vim åœ¨å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨å°†ç”¨æˆ·çš„ `~/.vim` ç›®å½•ï¼ˆLinux/macOSï¼‰æˆ– `~/vimfiles`ï¼ˆWindowsï¼‰åŠ å…¥åˆ° `runtimepath` å˜é‡çš„å¼€å¤´ã€‚



`runtimepath` çš„ä½œç”¨

`runtimepath` (`&rtp`) æ˜¯ Vim **æœç´¢é…ç½®ã€æ’ä»¶ã€autoload è„šæœ¬ã€colorscheme** çš„è·¯å¾„åˆ—è¡¨ã€‚

```bash
# å¯ä»¥æŸ¥çœ‹
:set runtimepath?
:echo &runtimepath(rtp)
```



**Vim é»˜è®¤ä¼šåšä»€ä¹ˆï¼Ÿ**

**å¯åŠ¨æ—¶**ï¼š

1. è‡ªåŠ¨å°† `~/.vim` ä½œä¸ºé¦–ä¸ªç›®å½•åŠ å…¥ `runtimepath`ã€‚
2. è‡ªåŠ¨æŠŠ `~/.vim/after` æ”¾åœ¨æœ€åï¼ˆç”¨äºè¦†ç›–ç³»ç»Ÿé…ç½®ï¼‰ã€‚
3. è‡ªåŠ¨æŠŠç³»ç»Ÿè·¯å¾„ `/usr/share/vim/vimXX` æ’å…¥ä¸­é—´ã€‚



**ç›®å½•ç»“æ„å’Œè‡ªåŠ¨åŠ è½½**

åœ¨ `runtimepath` ä¸‹ï¼ŒVim ä¼šè‡ªåŠ¨è¯†åˆ«ä»¥ä¸‹å­ç›®å½•ï¼š

- `plugin/` â†’ å¯åŠ¨æ—¶è‡ªåŠ¨åŠ è½½æ‰€æœ‰ `.vim` æ–‡ä»¶
- `autoload/` â†’ ä»…åœ¨è°ƒç”¨ `#` å‡½æ•°æˆ– `:runtime` æ—¶åŠ è½½
- `colors/` â†’ ä¾› `:colorscheme` ä½¿ç”¨
- `syntax/` â†’ è¯­æ³•æ–‡ä»¶
- `after/` â†’ ååŠ è½½ï¼Œè¦†ç›–å‰é¢çš„é…ç½®



**ä¸ `pack/\*` æ’ä»¶çš„åŒºåˆ«**

- `pack/*/start/` â†’ è‡ªåŠ¨åŠ å…¥ runtimepathï¼ˆæ’ä»¶è‡ªåŠ¨ç”Ÿæ•ˆï¼‰
- `pack/*/opt/` â†’ **ä¸ä¼šè‡ªåŠ¨åŠ å…¥**ï¼Œéœ€æ‰‹åŠ¨ `packadd æ’ä»¶å` æ‰åŠ å…¥ `rtp`





## æ­£åˆ™è¡¨è¾¾å¼



### æ­£åˆ™è¡¨è¾¾å¼çš„ä¸‰ä¸ªæµæ´¾

#### POSIX æµæ´¾çš„æ­£åˆ™è¡¨è¾¾å¼

- **BREæ ‡å‡†**

  > ä¸‹åˆ—å­—ç¬¦ç”¨åˆ°ä¸»è¦è½¬ç§»ï¼š()ï¼Œ+ï¼Œ*ï¼Œï¼Ÿï¼Œ{}



- **EREæ ‡å‡†**



#### POSIX å­—ç¬¦ç»„

![img](https://static001.geekbang.org/resource/image/c3/ya/c32024952cb6af3f78d9c08d9b5b3yya.png?wh=1162*1022)

#### Perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼

åœ¨ 1987 å¹´ 12 æœˆï¼ŒLarry Wall å‘å¸ƒäº† Perl è¯­è¨€ç¬¬ä¸€ç‰ˆï¼Œå› å…¶åŠŸèƒ½å¼ºå¤§ä¸€ç¥¨èµ°çº¢ï¼Œæ‰€å¼•å…¥çš„æ­£åˆ™è¡¨è¾¾å¼åŠŸèƒ½å¤§æ”¾å¼‚å½©ã€‚ä¹‹å Perl è¯­è¨€ä¸­çš„æ­£åˆ™è¡¨è¾¾å¼ä¸æ–­æ”¹è¿›ï¼Œå½±å“è¶Šæ¥è¶Šå¤§ã€‚äºæ˜¯åœ¨æ­¤åŸºç¡€ä¸Šï¼Œ1997 å¹´åˆè¯ç”Ÿäº†PCREâ€”â€”Perl å…¼å®¹æ­£åˆ™è¡¨è¾¾å¼ï¼ˆPerl Compatible Regular Expressionsï¼‰ã€‚

PCRE æ˜¯ä¸€ä¸ªå…¼å®¹ Perl è¯­è¨€æ­£åˆ™è¡¨è¾¾å¼çš„è§£æå¼•æ“ï¼Œæ˜¯ç”± Philip Hazel å¼€å‘çš„ï¼Œä¸ºå¾ˆå¤šç°ä»£è¯­è¨€å’Œå·¥å…·æ‰€æ™®éä½¿ç”¨ã€‚é™¤äº† Unix ä¸Šçš„å·¥å…·éµå¾ª POSIX æ ‡å‡†ï¼Œ**PCRE ç°å·²æˆä¸ºå…¶ä»–å¤§éƒ¨åˆ†è¯­è¨€å’Œå·¥å…·éšç„¶éµå¾ªçš„æ ‡å‡†ã€‚**









### å•å­—ç¬¦

.ï¼šä»»æ„å­—ç¬¦ï¼ˆ\né™¤å¤–ï¼‰

```bash
echo -e "abc\ndef" | grep -E "a.*f"
```

**ä¸ä¼šåŒ¹é…æˆåŠŸ**ï¼Œå› ä¸º `.` æ— æ³•è·¨è¶Šæ¢è¡Œç¬¦ `\n`ã€‚



\d ï¼šæ•°å­—

\w ï¼š æ•°å­—ï¼Œå­—æ¯ï¼Œä¸‹åˆ’çº¿

\sï¼šç©ºç™½å­—ç¬¦



åº•çº¿ï¼šç”¨å¤šé€‰ä¸€è¡¨è¾¾\dï¼Œ\w

[ ]ï¼šå¤šé€‰ä¸€

[^ ]ï¼šå–åï¼Œåªæœ‰åœ¨ä¸­æ‹¬å·é‡Œæ˜¯å–åçš„æ„æ€ï¼Œæ³¨æ„ä¸è¦å’Œæ–­è¨€æ··æ·†



### é‡è¯

`*` ï¼š0åˆ°å¤šä¸ª

`+` : 1åˆ°å¤šä¸ª

`?`ï¼š0åˆ°1ä¸ª

{N}ï¼šNä¸ª

{M,N}ï¼šMåˆ°Nä¸ª



### æ–­è¨€

^ï¼šå¼€å¤´æ–­è¨€

$ï¼šç»“å°¾æ–­è¨€

\bï¼šå•è¯æ–­è¨€



ç¯è§†



### åˆ†ç»„å¼•ç”¨

æŠ€å·§ï¼šæ ¹æ®å·¦æ‹¬å·åˆ¤æ–­\numä¸­çš„æ•°å­—

```bash
[root@magedu ~]# echo forwardfor|grep -P "((for)(ward))\2"
forwardfor
[root@magedu ~]# echo forwardward|grep -P "((for)(ward))\3"
forwardward
[root@magedu ~]# echo forwardforward|grep -P "((for)(ward))\1"
forwardforward
```



[root@magedu ~]# echo "abc def" | sed -E 's/(abc) (def)/\1-&/'ï¼ˆ& == \0ï¼‰
abc-abc def





### æ¨¡å¼

g global å…¨å‘˜



i å¸¦å¤§å°å†™ä¸æ•æ„Ÿ









## ä¸‰å‰‘å®¢



grep, sed, awkéƒ½æ˜¯è¡Œå¤„ç†å·¥å…·



### grep

è¿‡æ»¤



-oï¼šåªè¾“å‡ºåŒ¹é…åˆ°çš„

-Eï¼šERE

-Pï¼šperlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼

-vï¼šå–å

-iï¼šå¤§å°å†™ä¸æ•æ„Ÿ

-nï¼šæ˜¾ç¤ºè¡Œå·

-rï¼šé€’å½’



--------------------------------------------------

-Anum   åŒ¹é…åˆ°çš„è¡ŒåŠä¹‹åå‡ è¡Œ



-Bnum   åŒ¹é…åˆ°çš„è¡ŒåŠä¹‹å‰å‡ è¡Œ



-Cnum   åŒ¹é…åˆ°çš„è¡ŒåŠä¹‹å‰åå‡ è¡Œ







### sed

è¯­æ³•ï¼š**sed   [é€‰é¡¹]   'å¤„ç†åŠ¨ä½œ'   file**

â€‹            å¤„ç†åŠ¨ä½œ = èŒƒå›´ + åŠ¨ä½œ ï¼ˆå¯¹å“ªäº›èŒƒå›´ï¼Œåšå“ªäº›åŠ¨ä½œï¼‰

â€‹            **sed [é€‰é¡¹] 'èŒƒå›´ + åŠ¨ä½œ'  file**  ï¼Œè¿™é‡Œçš„åŠ¨ä½œæŒ‡çš„æ˜¯å¯¹æ¨¡å¼ç©ºé—´çš„åŠ¨ä½œ









åŸºç¡€ç»“æ„

```bash
sed '' passwd    #é»˜è®¤è¾“å‡ºæ¯ä¸€è¡Œ

sed -n '' passwd    # é™åˆ¶è¾“å‡ºï¼Œå³ä½¿ç”¨äº† -nï¼Œæ¯ä¸€è¡Œè¿˜æ˜¯ä¼šè¢«è¯»å–è¿›æ¨¡å¼ç©ºé—´ï¼Œåªæ˜¯ä¸è¾“å‡ºè€Œå·²ã€‚

sed -n 'p' passwd   # å°†æ¨¡å¼ç©ºé—´ä¸­åŒ¹é…çš„è¾“å‡ºå‡ºæ¥ï¼Œä¸å†™èŒƒå›´ï¼Œé»˜è®¤å…¨æ–‡åŒ¹é…

# è¾“å‡ºç¬¬2è¡Œ
[root@magedu ~]# sed -n '2p' /etc/passwd
bin:x:1:1:bin:/bin:/sbin/nologin

```





é€‰é¡¹

-n

-E/-r

-iï¼šæ”¹å˜æºæ–‡ä»¶

-i.bakï¼šå¤‡ä»½



èŒƒå›´çš„æ ¼å¼ï¼š

- Nï¼šä»£è¡¨ç¬¬å‡ è¡Œ
- N,Mï¼šnåˆ°mè¡Œ

- /pattern/ï¼šè¾“å‡ºåŒ¹é…çš„è¡Œ

- /pattern1/,/pattern2/



åŠ¨ä½œï¼š

pï¼šæ‰“å°

s@@@ï¼šæ›¿æ¢             æ¨¡å¼ï¼šg,i

a\ -------------- å‘ä¸‹ä¸€è¡Œè¿½åŠ 

i\ ---------- å‘å‰ä¸€è¡Œè¿½åŠ 

c\ --------- æ›¿æ¢æ•´è¡Œ

d ------ åˆ é™¤





### awk

è¯­æ³•ï¼šawk  [é€‰é¡¹]  'å¤„ç†åŠ¨ä½œ' file

â€‹            åŠ¨ä½œï¼šåˆ¤æ–­ + åŠ¨ä½œ

åŸºæœ¬æ ¼å¼

```bash
# ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œåˆ™æ²¡æ¡ä»¶ï¼Œä¹Ÿæ²¡åŠ¨ä½œ
[root@magedu ~]# seq 5 |awk ''

# åªç»™ä¸€ä¸ªåŠ¨ä½œï¼Œé»˜è®¤ä¸ºçœŸ
[root@magedu ~]# seq 5 |awk '{print}'
1
2
3
4
5

# awkæ‰§è¡Œé»˜è®¤åŠ¨ä½œ {print $0}
[root@magedu ~]# seq 5 | awk '1'
1
2
3
4
5


```



é€‰é¡¹ï¼š

-v ï¼šå˜é‡

-Fï¼šåˆ†éš”ç¬¦ï¼Œç­‰ä»·äº-v FS=''

> -v FS=":" = -F:



å˜é‡ï¼š

O: output

F: field å­—æ®µï¼ˆåˆ—ï¼‰

R: record è®°å½•ï¼ˆè¡Œï¼‰

Sï¼š Separator    åˆ†éš”

Nï¼šnumber æ•°å­—ï¼Œå·



FSï¼šField Separator   å­—æ®µåˆ†éš”ç¬¦



NFï¼šå­—æ®µå·

NRï¼šè¡Œå·

RSï¼šè¡Œåˆ†éš”

OFSï¼šoutput Field Separaotr ï¼šè¾“å‡ºå­—æ®µåˆ†éš”ç¬¦





åˆ¤æ–­+åŠ¨ä½œï¼š

print

```bash
# awkä¸­å˜é‡æœªå®šä¹‰ï¼Œé»˜è®¤æ˜¯0
seq 10|awk 'i=!i'   # æ³¨æ„è¿™é‡Œ=æ˜¯èµ‹å€¼ï¼Œä¸æ˜¯æ¯”è¾ƒ
```



å¤„ç†é¡ºåº

seq 10|awk 'BEGIN{}{}END{}'





# ç¬¬Nå¤©ï¼ˆShellï¼‰



## è„šæœ¬è°ƒè¯•

```bash
-n           # æ£€æŸ¥è„šæœ¬ä¸­çš„è¯­æ³•é”™è¯¯
-v           # å…ˆæ˜¾ç¤ºè„šæœ¬æ‰€æœ‰å†…å®¹ï¼Œç„¶åæ‰§è¡Œè„šæœ¬ï¼Œç»“æœè¾“å‡ºï¼Œå¦‚æœæ‰§è¡Œé‡åˆ°é”™è¯¯ï¼Œå°†é”™è¯¯è¾“å‡ºã€‚
-x           # å°†æ‰§è¡Œçš„æ¯ä¸€æ¡å‘½ä»¤å’Œæ‰§è¡Œç»“æœéƒ½æ‰“å°å‡ºæ¥
```



### è¯­æ³•æ£€æŸ¥

```bash
[root@rocky9 ~]# /bin/bash -n get_netinfo-error.sh
get_netinfo-error.sh:è¡Œ19: å¯»æ‰¾åŒ¹é…çš„ `"' æ˜¯é‡åˆ°äº†æœªé¢„æœŸçš„æ–‡ä»¶ç»“æŸç¬¦
get_netinfo-error.sh:è¡Œ20: è¯­æ³•é”™è¯¯: æœªé¢„æœŸçš„æ–‡ä»¶ç»“å°¾
```





### è„šæœ¬è·Ÿè¸ª

```bash
# å¤±è´¥æ¼”ç¤º
[root@rocky9 ~]# /bin/bash -x get_netinfo-error.sh
 + :
 + ifconfig eth0
 + awk '{print $2}'
 + grep -w inet
 + xargs echo 'IP: '
 IP:  10.0.0.12
 + ifconfig eth0
 + grep -w inet
 + awk '{print $4}'
 + xargs echo 'NetMask: '
 NetMask:  255.255.255.0
 + ifconfig eth0
 + grep -w inet
 + xargs echo 'Broadcast: '
 + awk '{print $6}'
 Broadcast:  10.0.0.255
 get_netinfo-error.sh:è¡Œ19: å¯»æ‰¾åŒ¹é…çš„ `"' æ˜¯é‡åˆ°äº†æœªé¢„æœŸçš„æ–‡ä»¶ç»“æŸç¬¦
 get_netinfo-error.sh:è¡Œ20: è¯­æ³•é”™è¯¯: æœªé¢„æœŸçš„æ–‡ä»¶ç»“å°¾
```







## å˜é‡

### å˜é‡å®šä¹‰

```bat
åŸºæœ¬æ ¼å¼
	å˜é‡å=å˜é‡å€¼
æ³¨æ„ï¼š
	= ä¸¤ä¾§ä¸å…è®¸æœ‰ç©ºæ ¼
```



ç¤ºä¾‹ï¼š

```bash
#æŸ¥çœ‹ä¸€ä¸ªç©ºå€¼å˜é‡å
[root@rocky9 ~]#  echo $myname

#å®šåˆ¶å˜é‡å®è·µ
[root@rocky9 ~]# myname=shuji
[root@rocky9 ~]#  echo $myname
shuji
```



#### declareå˜é‡å®šä¹‰

```bat
å‘½ä»¤è¯­æ³•
    declare å‚æ•° å˜é‡å=å˜é‡å€¼
å‚æ•°è§£æï¼š
	-i å°†å˜é‡çœ‹æˆæ•´æ•° 
	-r ä½¿å˜é‡åªè¯»  readonly,==**è¯¥å˜é‡çš„å€¼æ— æ³•æ”¹å˜ï¼Œå¹¶ä¸”ä¸èƒ½ä¸ºunset**==
	-x æ ‡è®°å˜é‡ä¸ºå…¨å±€å˜é‡ï¼Œç±»ä¼¼äºexport
	-a æŒ‡å®šä¸ºç´¢å¼•æ•°ç»„ï¼ˆæ™®é€šæ•°ç»„ï¼‰ï¼›æŸ¥çœ‹æ™®é€šæ•°ç»„
	-A æŒ‡å®šä¸ºå…³è”æ•°ç»„ï¼›æŸ¥çœ‹å…³è”æ•°ç»„
```



ç¤ºä¾‹

```bat
è®¾å®šåˆ¶å®šç±»å‹çš„å˜é‡å€¼
[root@rocky9 ~]# declare -i mynum='shuzi'
[root@rocky9 ~]# echo $mynum
0

[root@rocky9 ~]# declare -i mynum='123456'
[root@rocky9 ~]# echo $mynum
123456
```

```bat
è®¾å®šåªè¯»ç±»å‹å˜é‡
[root@rocky9 ~]# declare -r myread1="aaa"
[root@rocky9 ~]# myread2=myread
[root@rocky9 ~]# readonly myread2

æŸ¥çœ‹åªè¯»å˜é‡
root@localhost:~# declare -r
declare -r BASHOPTS="checkwinsize:cmdhist:complete_fullquote:expand_aliases:extglob:extquote:force_fignore:globasciiranges:globskipdots:histappend:interactive_comments:login_shell:patsub_replacement:progcomp:promptvars:sourcepath"
declare -ar BASH_VERSINFO=([0]="5" [1]="2" [2]="26" [3]="1" [4]="release" [5]="x86_64-redhat-linux-gnu")
declare -ir EUID="0"
declare -ir PPID="2600"
declare -r SHELLOPTS="braceexpand:emacs:hashall:histexpand:history:interactive-comments:monitor"
declare -ir UID="0"
declare -r myread1="aaa"
declare -r myread2="myread"

æ— æ³•ä½¿ç”¨unsetåˆ é™¤åªè¯»å˜é‡ï¼Œä¹Ÿæ— æ³•æ›´æ”¹åªè¯»å˜é‡
root@localhost:~# unset myread1
-bash: unset: myread1: cannot unset: readonly variable
root@localhost:~# myread1=bbb
-bash: myread1: readonly variable
```



### å˜é‡ç§»é™¤

```bat
åŸºæœ¬æ ¼å¼
    unset å˜é‡å
```





### å…¨å±€å˜é‡

åŸºæœ¬è¯­æ³•

```bat
æŸ¥çœ‹å…¨å±€ç¯å¢ƒå˜é‡
    env               #åªæ˜¾ç¤ºå…¨å±€å˜é‡,ä¸€èˆ¬ç»“åˆ grep å’Œç®¡é“ç¬¦æ¥ä½¿ç”¨    
    printenv          #æ•ˆæœä¸envç­‰åŒ 
    
    export            #æŸ¥çœ‹æ‰€æœ‰çš„ç¯å¢ƒå˜é‡ï¼ŒåŒ…æ‹¬å£°æ˜çš„è¿‡ç¨‹ç­‰ä¿¡æ¯ï¼Œä¸€èˆ¬ä¸ç”¨  
    declare -x  æ•ˆæœä¸exportç±»
```



#### envç”¨æ³•

```bash
env VAR=hello command
```

- `command` ä¼šåœ¨ä¸€ä¸ªæ–°çš„è¿›ç¨‹é‡Œè¿è¡Œï¼Œå¸¦æœ‰ `VAR=hello` è¿™ä¸ªå˜é‡ã€‚
- æ‰§è¡Œå®Œ `command` ä¹‹åï¼Œå½“å‰ shell å¹¶ä¸ä¼šä¿ç•™ `VAR`ã€‚



#### envä¸exportçš„åŒºåˆ«

```bash
# ä½¿ç”¨ export
VAR=hello
export VAR
bash -c 'echo $VAR'   # è¾“å‡º hello

# ä½¿ç”¨ env
VAR=hello
env VAR=world bash -c 'echo $VAR'  # è¾“å‡º world
echo $VAR    # ä»ç„¶æ˜¯ helloï¼Œä¸å—å½±å“
```

- å¦‚æœä½ éœ€è¦è®©å˜é‡å¯¹ **åç»­æ‰€æœ‰å‘½ä»¤éƒ½ç”Ÿæ•ˆ** â†’ ç”¨ `export`ã€‚
-  å¦‚æœåªæ˜¯æƒ³ **åœ¨æŸä¸ªå‘½ä»¤æ‰§è¡Œæ—¶ä¸´æ—¶ç”Ÿæ•ˆ** â†’ ç”¨ `env`ã€‚

ls









```bash
>|        #  å¼ºåˆ¶è¦†ç›–ï¼ˆå…è®¸åœ¨set -Cçš„æƒ…å†µä¸‹ï¼Œå¼ºåˆ¶è¦†ç›–ï¼‰
```

```bash
set -C ç¦æ­¢å°†å†…å®¹è¦†ç›–å·²æœ‰æ–‡ä»¶ï¼Œä½†å¯è¿½åŠ 
set +C å…è®¸è¦†ç›–ï¼Œé»˜è®¤

# è¯¥çŸ¥è¯†ç‚¹ä»…ä½œäº†è§£
```









# wireshark åŸºæœ¬ç”¨æ³•





## å¦‚ä½•æ•è·æŠ¥æ–‡

- **ç‚¹å‡»æ•è· -> é€‰é¡¹ï¼Œæ‰“å¼€æ•è·çª—å£**
  - ç½‘å¡è®¾å¤‡/æµé‡/æ•è·è¿‡æ»¤å™¨ï¼Œç‚¹å‡»â€œå¼€å§‹â€æŒ‰é’®å¼€å§‹æŠ“åŒ…
- **ç‚¹å‡»æ•è· -> åœæ­¢ï¼Œåœæ­¢æŠ“åŒ…**

![image-20250619174044113](D:\git_repository\cyber_security_learning\markdown_img\image-20250619174044113.png)





### è¾“å‡º

æ•è·åˆ°çš„æ•°æ®ï¼Œè¦ä¹ˆä¿å­˜åˆ°ä¸´æ—¶æ–‡ä»¶ï¼Œè¦ä¹ˆä¿å­˜åˆ°æ°¸ä¹…æ–‡ä»¶ä¸­

- å¦‚æœè¦ä¿å­˜åˆ°**æ°¸ä¹…æ–‡ä»¶**ä¸­ï¼Œå¯ä»¥æŒ‡å®šå¥½è¦ä¿å­˜çš„è·¯å¾„åŠæ–‡ä»¶å

- å¦‚æœæ˜¯**ä¸´æ—¶æ–‡ä»¶**ï¼Œå¯ä»¥ç‚¹å‡»è‡ªåŠ¨åˆ›å»ºæ–°æ–‡ä»¶ï¼Œç»è¿‡å¤šå°‘ç§’æˆ–è€…å¤šå°‘å­—èŠ‚ï¼Œè‡ªåŠ¨æ¢ä¸€ä¸ªæ–°æ–‡ä»¶ï¼Œå¹¶ä¸æ–­æ–°å¢

  > æŠ“åŒ…æ•°æ®è¢«å…ˆå†™å…¥ä¸€ä¸ªä¸´æ—¶åŒºåŸŸï¼ˆé€šå¸¸æ˜¯å†…å­˜æˆ–ç£ç›˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶ï¼‰ï¼Œå½“ä½ â€œåœæ­¢æ•è·â€æ—¶ï¼Œå·¥å…·æ‰ä¼šæç¤ºä½ æ˜¯å¦ä¿å­˜è¿™ä¸ªä¸´æ—¶å†…å®¹ä¸ºæ­£å¼æ–‡ä»¶ã€‚

- ç¯å½¢ç¼“å†²åŒºï¼ˆring bufferï¼‰æœºåˆ¶æœ¬èº«åªæ˜¯é™åˆ¶æ–‡ä»¶ä¸ªæ•°ï¼Œå¹¶ä¸ä¼šä¸»åŠ¨è§¦å‘æ–‡ä»¶è½®è½¬ï¼›ä½ éœ€è¦é…åˆâ€œè‡ªåŠ¨åˆ›å»ºæ–°æ–‡ä»¶â€è®¾ç½®ï¼ˆåŸºäºæ—¶é—´æˆ–å¤§å°ï¼‰æ¥å®ç°ç¯å½¢å†™å…¥æ•ˆæœã€‚

![image-20250619174915407](D:\git_repository\cyber_security_learning\markdown_img\image-20250619174915407.png)



### é€‰é¡¹

é€‰é¡¹ä¸»è¦ä½œç”¨æ˜¯å†³å®šå¤šé•¿æ—¶é—´æˆ–è€…å¤šå°‘æ–‡ä»¶æˆ–è€…å¤šå°‘æ•°æ®åï¼Œè‡ªåŠ¨åœæ­¢æ•è·ã€‚ä»¥åŠæ˜¯å¦è§£æåç§°

![image-20250619175521009](D:\git_repository\cyber_security_learning\markdown_img\image-20250619175521009.png)

å„ä¸ªåç§°è§£æé€‰é¡¹å«ä¹‰ä¸ç¤ºä¾‹ï¼š

**`Resolve MAC addresses`ï¼ˆå·²å¯ç”¨ï¼‰**

- **ä½œç”¨**ï¼šå°† MAC åœ°å€è½¬æ¢ä¸ºå¯¹åº”å‚å•†çš„åç§°ï¼ˆæ ¹æ® OUI æ•°æ®åº“ï¼‰

  | åŸå§‹å­—æ®µ            | è§£æå            |
  | ------------------- | ----------------- |
  | `00:1C:42:00:00:08` | `Parallels, Inc.` |
  | `00:0C:29:5B:A4:21` | `VMware, Inc.`    |



**`Resolve network names`**

- **ä½œç”¨**ï¼šå°† IP åœ°å€è§£ææˆä¸»æœºåï¼ˆDNS æˆ–æœ¬åœ°è§£æï¼‰

  | åŸå§‹ IP       | è§£æå                             |
  | ------------- | ---------------------------------- |
  | `8.8.8.8`     | `dns.google`                       |
  | `192.168.1.1` | `router.local`ï¼ˆå¦‚æœä¸»æœºåå¯è§£æï¼‰ |

âš ï¸ æ³¨æ„ï¼š**å¯ç”¨åå¯èƒ½é€ æˆæŠ“åŒ…æ—¶å¡é¡¿**ï¼Œå› ä¸ºå®ƒå¯èƒ½è§¦å‘å®é™…çš„ DNS æŸ¥è¯¢ï¼



 **`Resolve transport names`**

- **ä½œç”¨**ï¼šå°†ç«¯å£å·è§£ææˆå¸¸è§åè®®åï¼ˆåŸºäº `/etc/services` æˆ–å†…ç½®æ˜ å°„ï¼‰

  | åŸå§‹ç«¯å£ | åè®®å  |
  | -------- | ------- |
  | `443`    | `HTTPS` |
  | `53`     | `DNS`   |
  | `22`     | `SSH`   |







## wireshark é¢æ¿

![image-20250619180200930](D:\git_repository\cyber_security_learning\markdown_img\image-20250619180200930.png)







### å¿«æ·æ–¹å¼å·¥å…·æ 

![image-20250619180505886](D:\git_repository\cyber_security_learning\markdown_img\image-20250619180505886.png)



### æ•°æ®åŒ…çš„é¢œè‰²ï¼ˆè§†å›¾->ç€è‰²è§„åˆ™ï¼‰

![image-20250619181042041](D:\git_repository\cyber_security_learning\markdown_img\image-20250619181042041.png)







### è®¾å®šæ—¶é—´æ˜¾ç¤ºæ ¼å¼

**ç»å¯¹æ—¶é—´**

![image-20250619181321755](D:\git_repository\cyber_security_learning\markdown_img\image-20250619181321755.png)

**ç›¸å¯¹æ—¶é—´**

![image-20250619181358844](D:\git_repository\cyber_security_learning\markdown_img\image-20250619181358844.png)



**åŸºäºæŸä¸ªæ•°æ®åŒ…çš„ç›¸å¯¹æ—¶é—´**

![image-20250619181459082](D:\git_repository\cyber_security_learning\markdown_img\image-20250619181459082.png)







### æ•°æ®åŒ…åˆ—è¡¨é¢æ¿çš„æ ‡è®°ç¬¦å·

![image-20250619181645488](D:\git_repository\cyber_security_learning\markdown_img\image-20250619181645488.png)





## æ•è·è¿‡æ»¤å™¨













## æ˜¾ç¤ºè¿‡æ»¤å™¨













æ˜¯çš„ âœ…ï¼Œä½ å½“å‰æ“ä½œçš„æ˜¯ä½ è‡ªå·±çš„å·²å®‰è£…ç³»ç»Ÿï¼ˆä¾‹å¦‚å‡çº§äº†å†…æ ¸å’Œé©±åŠ¨çš„ CentOS 7.9ï¼‰ï¼Œ**ä½ éœ€è¦ã€ŒæŒ‚è½½ä¸€ä¸ªå®˜æ–¹åŸå§‹ ISOã€å¹¶åŸºäºå®ƒæ„å»ºä¸€ä¸ªæ–°çš„å®‰è£… ISO**ã€‚è¿™ä¸ªæ­¥éª¤æ˜¯å¿…é¡»çš„ã€‚

------

## ğŸ¯ ä¸ºä»€ä¹ˆè¦æŒ‚è½½ä¸€ä¸ª ISOï¼Ÿ

å› ä¸ºä½ åˆ¶ä½œçš„è‡ªåŠ¨å®‰è£…é•œåƒï¼ˆå« Kickstart + è‡ªå®šä¹‰é©±åŠ¨ + 5.x å†…æ ¸ï¼‰å¿…é¡»æœ‰ä¸€ä¸ªã€ŒåŸå§‹å®‰è£…ç¯å¢ƒã€çš„åŸºç¡€ï¼Œæ¯”å¦‚ï¼š

- å®‰è£…ç¨‹åº (`anaconda`)
- åˆå§‹åŒ–é•œåƒ (`initrd.img`)
- å¼•å¯¼åŠ è½½å™¨ (`isolinux/`, `EFI/`)
- è½¯ä»¶ä»“åº“ (`Packages/`, `repodata/`)

è¿™äº›å†…å®¹**ä½ ä¸å¯èƒ½ä»å½“å‰ç³»ç»Ÿå¤åˆ¶å‡ºæ¥**ï¼Œè€Œæ˜¯ä»åŸå§‹ ISO æ‹·è´æ¥çš„ã€‚

------

## âœ… æ‰€ä»¥ä½ éœ€è¦åšçš„ï¼š

### â‘  ä¸‹è½½åŸå§‹ ISOï¼ˆå¦‚æœä½ è¿˜æ²¡ä¸‹è½½ï¼‰

æ¨èä½¿ç”¨æ¸…åé•œåƒï¼š

```
bash


CopyEdit
wget -O /root/CentOS-7-x86_64-DVD-2009.iso https://mirrors.tuna.tsinghua.edu.cn/centos-vault/7.9.2009/isos/x86_64/CentOS-7-x86_64-DVD-2009.iso
```

> ä¸‹è½½å®Œæˆåä¼šä¿å­˜åˆ° `/root/CentOS-7-x86_64-DVD-2009.iso`

------

### â‘¡ æŒ‚è½½ ISO

```
bashCopyEditmkdir -p /mnt/iso
mount -o loop /root/CentOS-7-x86_64-DVD-2009.iso /mnt/iso
```

------

### â‘¢ å¤åˆ¶åŸå§‹ ISO å†…å®¹åˆ°ä½ è¦ä¿®æ”¹çš„ç›®å½•ï¼š

```
bashCopyEditmkdir -p /root/custom_iso
cp -rT /mnt/iso /root/custom_iso
```

> æ‰€æœ‰åç»­æ“ä½œï¼ˆåŠ å†…æ ¸ã€åŠ  ks.cfgã€æ”¹èœå•ç­‰ï¼‰éƒ½åœ¨ `/root/custom_iso` é‡Œè¿›è¡Œã€‚

------

## ğŸ“ æ€»ç»“

| æ“ä½œç›®çš„       | æ˜¯å¦å¿…é¡» | è¯´æ˜                                           |
| -------------- | -------- | ---------------------------------------------- |
| æŒ‚è½½ ISO       | âœ… æ˜¯     | æå–åŸå§‹å®‰è£…å†…å®¹ï¼ˆinitrdã€vmlinuzã€èœå•ç­‰ï¼‰    |
| ç”¨å½“å‰ç³»ç»Ÿæ“ä½œ | âœ… å¯ä»¥   | ä½ å‡çº§äº†å†…æ ¸/é©±åŠ¨ï¼Œä½†è¿™äº›ä¸ä¼šè‡ªåŠ¨å‡ºç°åœ¨ ISO ä¸­ |
| å¤åˆ¶ ISO å†…å®¹  | âœ… æ˜¯     | åç»­æ‰€æœ‰ä¿®æ”¹éƒ½åœ¨å‰¯æœ¬ `/root/custom_iso` ä¸­å®Œæˆ |



------

æ˜¯å¦éœ€è¦æˆ‘æä¾›ä¸€ä¸ªä¸€é”®å®ŒæˆæŒ‚è½½ + è§£åŒ… + æ‹·è´çš„è„šæœ¬ï¼Ÿåªéœ€ä¸€æ¡å‘½ä»¤å³å¯å®Œæˆåˆå§‹åŒ–æ“ä½œã€‚





##### You said:

[root@localhost custom_iso]# mkisofs -o /root/CentOS7-auto.iso \ >   -b isolinux/isolinux.bin -c isolinux/boot.cat \ >   -no-emul-boot -boot-load-size 4 -boot-info-table \ >   -R -J -v -T \ >   -V "CentOS 7 x86_64"  I: -input-charset not specified, using utf-8 (detected in locale settings) genisoimage 1.1.11 (Linux) genisoimage: Missing pathspec. Usage: genisoimage [options] -o file directory ... Use genisoimage -help to get a list of valid options. Report problems to debburn-devel@lists.alioth.debian.org.



###### ChatGPT said:

ä½ æ‰§è¡Œçš„ `mkisofs`ï¼ˆæˆ– `genisoimage`ï¼‰ å‘½ä»¤å‡ºé”™äº†ï¼š

```
makefile


CopyEdit
genisoimage: Missing pathspec.
```

è¿™è¯´æ˜ï¼š**ä½ å¿˜äº†æŒ‡å®šè¦æ‰“åŒ…çš„ç›®å½•è·¯å¾„äº†**ï¼ˆä¹Ÿå°±æ˜¯æœ€ååº”è¯¥åŠ ä¸Š `.` æˆ– `/root/custom_iso`ï¼‰ã€‚

------

## âœ… æ­£ç¡®å‘½ä»¤å†™æ³•

ä½ å½“å‰ç›®å½•å·²ç»æ˜¯ `/root/custom_iso`ï¼Œæ‰€ä»¥æœ€ååŠ ä¸ª `.` å³å¯ï¼š

```
bashCopyEditmkisofs -o /root/CentOS7-auto.iso \
  -b isolinux/isolinux.bin -c isolinux/boot.cat \
  -no-emul-boot -boot-load-size 4 -boot-info-table \
  -R -J -v -T \
  -V "CentOS 7 x86_64" \
  .
```

æœ€åé‚£ä¸ª `.` è¡¨ç¤ºï¼š**æŠŠå½“å‰ç›®å½•æ‰€æœ‰å†…å®¹æ‰“åŒ…ä¸º ISOã€‚**

------

### âœ… å¦‚æœä½ æƒ³æ˜ç¡®ä¸€ç‚¹ï¼Œä¹Ÿå¯ä»¥å†™ï¼š

```
bashCopyEditmkisofs -o /root/CentOS7-auto.iso \
  -b isolinux/isolinux.bin -c isolinux/boot.cat \
  -no-emul-boot -boot-load-size 4 -boot-info-table \
  -R -J -v -T \
  -V "CentOS 7 x86_64" \
  /root/custom_iso
```

------

## ğŸ§ª å»ºè®®

ç”Ÿæˆåä½ å¯ä»¥éªŒè¯ï¼š

```
bashCopyEditls -lh /root/CentOS7-auto.iso
file /root/CentOS7-auto.iso
```

å¦‚æœåç»­è¦æ”¯æŒ USB å¯åŠ¨ï¼ˆHybrid ISOï¼‰ï¼Œå†è¿è¡Œï¼š

```
bash


CopyEdit
isohybrid /root/CentOS7-auto.iso
```

------

æ˜¯å¦ä¹Ÿéœ€è¦æˆ‘å¸®ä½ åŠ ä¸Š `implantisomd5` å’Œ `UEFI` å…¼å®¹å‚æ•°ï¼Ÿå¯ä»¥å°è£…æˆä¸€æ¡å®Œæ•´çš„ç”Ÿäº§è„šæœ¬ã€‚





##### You said:

![Uploaded image](https://files08.oaiusercontent.com/file-K5X1sGbRxUC84tR5ZPzAZc?se=2025-06-21T01%3A09%3A56Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D299%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3Ddea6ee48-0be4-4a0b-b59d-b738f4967c13.png&sig=VozaBHm%2BaMvtaA0qRx7tW%2BrFkJJY5/H8uAqzIQmG5Pw%3D)



###### ChatGPT said:

ä½ è¿™å¼ æˆªå›¾æ˜¾ç¤ºï¼š

```
nginxCopyEditThe following problem occurred on line 28 of the kickstart file:
no such option: --lock:contentReference[oacite:01<index
```

------

## âœ… é—®é¢˜åˆ†æï¼š

è¿™æ˜¯å…¸å‹çš„ **Kickstart æ–‡ä»¶ä¸­å­˜åœ¨éæ³•æˆ–æŸåçš„å­—ç¬¦** é”™è¯¯ã€‚

> `--lock:contentReference[oacite:01<index` æ ¹æœ¬ä¸æ˜¯ Kickstart æ”¯æŒçš„å‚æ•°ï¼Œæå¯èƒ½æ˜¯ä½ åœ¨ `ks.cfg` ä¸­æŸä¸€è¡Œå¤åˆ¶ç²˜è´´è¿‡ç¨‹ä¸­æ··å…¥äº†ç½‘é¡µä»£ç ï¼ˆæ¯”å¦‚ä½ ä»æµè§ˆå™¨ç²˜äº†æŸä¸ªå‘½ä»¤ï¼‰ã€‚

------

## âœ… å¦‚ä½•è§£å†³ï¼š

### âœ… ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ä½ ç¬¬ 28 è¡Œçš„å†…å®¹

æ‰“å¼€ä½ çš„ `ks.cfg` æ–‡ä»¶ï¼š

```
bash


CopyEdit
vim /root/custom_iso/ks.cfg
```

è·³è½¬åˆ°ç¬¬ 28 è¡Œï¼š

```
vim


CopyEdit
:28
```

ä½ åº”è¯¥ä¼šçœ‹åˆ°æŸä¸€è¡Œç±»ä¼¼è¿™æ ·é”™è¯¯çš„å†…å®¹ï¼š

```
bash


CopyEdit
rootpw --lock:contentReference[oacite:01<index
```

æ”¹ä¸ºæ­£å¸¸çš„ï¼š

```
bash


CopyEdit
rootpw --lock
```

æˆ–è€…ä½¿ç”¨åŠ å¯†å¯†ç ï¼š

```
bash


CopyEdit
rootpw --iscrypted $6$abcdef1234$xxxxxxxxxxxxxxx
```

------

### âœ… ç¬¬äºŒæ­¥ï¼šç§»é™¤æ½œåœ¨çš„éšè—å­—ç¬¦

ä½ å¯ä»¥ä½¿ç”¨ `dos2unix` è½¬æ¢æ¢è¡Œç¬¦ï¼ˆç‰¹åˆ«æ˜¯åœ¨ Windows ä¸Šç¼–è¾‘è¿‡çš„æƒ…å†µä¸‹ï¼‰ï¼š

```
bash


CopyEdit
dos2unix /root/custom_iso/ks.cfg
```

æˆ–æ¸…ç†æ§åˆ¶å­—ç¬¦ï¼š

```
bash


CopyEdit
cat -v /root/custom_iso/ks.cfg | less
```

æ£€æŸ¥æœ‰æ²¡æœ‰ç±»ä¼¼ `^M` æˆ–å¥‡æ€ªçš„ä¹±ç ï¼Œæ‰‹åŠ¨æ¸…é™¤æˆ–é‡å†™ã€‚

------

### âœ… ç¬¬ä¸‰æ­¥ï¼šéªŒè¯ Kickstart æ˜¯å¦è¯­æ³•æ­£ç¡®

ä½ å¯ä»¥ä½¿ç”¨ `ksvalidator` å·¥å…·æ£€æŸ¥ï¼š

```
bashCopyEdityum install -y pykickstart
ksvalidator /root/custom_iso/ks.cfg
```

å¦‚æœæœ‰è¯­æ³•é—®é¢˜ï¼Œå®ƒä¼šå‘Šè¯‰ä½ è¡Œå·å’Œé”™è¯¯è¯¦æƒ…ã€‚

------

## âœ… æ€»ç»“

| æ“ä½œ         | å‘½ä»¤                                  |
| ------------ | ------------------------------------- |
| æ‰“å¼€ ks.cfg  | `vim /root/custom_iso/ks.cfg`         |
| è·³è½¬åˆ°ç¬¬28è¡Œ | `:28`                                 |
| è½¬æ¢æ ¼å¼     | `dos2unix /root/custom_iso/ks.cfg`    |
| éªŒè¯åˆæ³•æ€§   | `ksvalidator /root/custom_iso/ks.cfg` |



------

ä¿®å¤å®Œ `ks.cfg` åï¼Œé‡æ–°æ‰“åŒ… ISO æˆ–è¦†ç›–è¿›å»ï¼Œå†æ¬¡æµ‹è¯•å³å¯ã€‚å¦‚æœä½ å¸Œæœ›æˆ‘å¸®ä½ æ£€æŸ¥ä¸€ä»½å®Œæ•´çš„ `ks.cfg`ï¼Œå¯ä»¥ç›´æ¥è´´ç»™æˆ‘ã€‚





##### You said:

![Uploaded image](https://files.oaiusercontent.com/file-F9ZRMW93t7xNthZpq1YXe3?se=2025-06-21T01%3A09%3A56Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D299%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3D86474cc9-5d4c-4433-8869-a3f6dba0cc85.png&sig=meXfDU7JP6zohviqo86R4khq89DFTHOL9AyQo/Z6k0c%3D)

è¿™ä¸ªæ˜¯ä»€ä¹ˆæ„æ€



###### ChatGPT said:

ä½ è¿™å¼ æˆªå›¾çš„æŠ¥é”™æç¤ºéå¸¸æ¸…æ¥šï¼š

```
kotlinCopyEditYou have specified that the package 'kmod-r8168' should be installed.
This package does not exist.
Would you like to ignore this package and continue with installation?
```

------

## âœ… è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ

ä½ çš„ Kickstart æ–‡ä»¶é‡Œå†™äº†ï¼š

```
bashCopyEdit%packages
...
kmod-r8168
...
%end
```

ä½†å®‰è£…ç¨‹åºåœ¨ä½ æ„å»ºçš„ ISO ä¸­ **æ‰¾ä¸åˆ°è¿™ä¸ªåŒ…**ï¼Œæ‰€ä»¥æç¤ºä½ æ˜¯å¦å¿½ç•¥å®ƒç»§ç»­å®‰è£…ã€‚

------

## ğŸ¯ ä¸ºä»€ä¹ˆä¼šæ‰¾ä¸åˆ°ï¼Ÿ

æœ€å¯èƒ½çš„åŸå› æœ‰ä¸¤ç§ï¼š

------

### ğŸŸ¥ åŸå›  1ï¼šä½ åœ¨ ISO é‡Œæ²¡æœ‰çœŸæ­£æ”¾å…¥ `kmod-r8168.rpm` åŒ…

- å¦‚æœä½ å¸Œæœ›ä½¿ç”¨è¿™ä¸ªåŒ…ï¼Œ**ä½ å¿…é¡»æ‰‹åŠ¨å°†è¯¥ RPM åŒ…æ‹·è´åˆ°ä½ çš„ ISO ä¸­çš„ `Packages/` ç›®å½•**
- ç„¶åè¿è¡Œä¸€æ¬¡ `createrepo` æ›´æ–°å…ƒæ•°æ®ï¼ˆ`repodata`ï¼‰

ç¤ºä¾‹ï¼š

```
bashCopyEditcp /root/kmod-r8168-xxx.rpm /root/custom_iso/Packages/
cd /root/custom_iso
createrepo -g repodata/*comps.xml Packages/
```

------

### ğŸŸ¥ åŸå›  2ï¼šä½ å†™é”™äº†åŒ…åï¼ˆæˆ–æ²¡æœ‰æ·»åŠ å®‰è£…æºï¼‰

- `kmod-r8168` é€šå¸¸æ¥è‡ª [ELRepo](https://elrepo.org) ç¬¬ä¸‰æ–¹ä»“åº“
- å®˜æ–¹ ISO é»˜è®¤ä¸å¸¦å®ƒï¼Œæ‰€ä»¥ä½ è¦è‡ªå·±æä¾›

------

## âœ… æ­£ç¡®åšæ³•ï¼ˆæ¨èï¼‰

### âœ… æ–¹æ¡ˆ Aï¼ˆä½ æƒ³ç”¨ `kmod-r8168` è¿™ä¸ªåŒ…ï¼‰ï¼š

1. ä¸‹è½½è¯¥åŒ…åˆ°æœ¬åœ°ï¼š

   ```
   bash
   
   
   CopyEdit
   yum install --downloadonly --enablerepo=elrepo-kernel --downloaddir=/root kmod-r8168
   ```

2. æ‹·è´åˆ°ä½ çš„ ISOï¼š

   ```
   bash
   
   
   CopyEdit
   cp /root/kmod-r8168*.rpm /root/custom_iso/Packages/
   ```

3. é‡å»ºä»“åº“å…ƒæ•°æ®ï¼š

   ```
   bashCopyEditcd /root/custom_iso
   createrepo -g repodata/*comps.xml Packages/
   ```

------

### âœ… æ–¹æ¡ˆ Bï¼ˆä¸ç”¨è¿™ä¸ªåŒ…ï¼Œç›´æ¥å†…æ ¸æ¨¡å—æ‰“åŒ…è¿› initrdï¼‰

å¦‚æœä½ å·²ç»ï¼š

- ç¼–è¯‘å®‰è£…äº† `r8168.ko`
- å¹¶ä¸”ç”¨ `dracut` æ‰“è¿›äº† `initramfs`
- é‚£ä½  **å¯ä»¥ä¸åœ¨ `%packages` é‡Œå†™ `kmod-r8168`**

ç›´æ¥åˆ æ‰é‚£ä¸€è¡Œå³å¯ã€‚

------

## âœ… ç»“è®º

| é€‰é¡¹                   | è¯´æ˜                                                         |
| ---------------------- | ------------------------------------------------------------ |
| ä¿ç•™ `kmod-r8168` åŒ…å | å¿…é¡»æŠŠ RPM åŠ å…¥ ISO å¹¶é‡å»º `repodata`                        |
| ä¸æƒ³ä½¿ç”¨ RPM å®‰è£…      | ä» `%packages` åˆ æ‰ `kmod-r8168`ï¼Œåªç”¨ `.ko` æ¨¡å—å’Œ `dracut` æ‰“åŒ…å³å¯ |



------

æ˜¯å¦å¸Œæœ›æˆ‘ç»™ä½ è¾“å‡ºä¸€æ¡å®Œæ•´çš„ã€Œå°† kmod é©±åŠ¨åŒ…æ·»åŠ è¿› ISOã€è„šæœ¬ï¼Ÿä¸€æ­¥æ‰“åŒ…å¥½å¹¶é‡å»º metadataã€‚





##### You said:

![Uploaded image](https://files.oaiusercontent.com/file-9YApKy3MMRyeUgdKSmiwKV?se=2025-06-21T01%3A09%3A56Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D299%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3D555ca847-b68f-43c0-bd5a-2e105b86f00c.png&sig=Jk7DsDL5V3Tt/h/0yzoP6Q/Xj5kzGjPkSGioWs937pE%3D)

å•¥æƒ…å†µï¼Œæˆ‘æœ¬æ¥çš„æ“ä½œç³»ç»Ÿçš„å†…æ ¸å’Œç½‘å¡éƒ½å¼„å¥½çš„ï¼Œè¿™é‡Œæ€ä¹ˆåˆè¦é‡è£…ï¼Ÿ



###### ChatGPT said:

ä½ é—®å¾—éå¸¸å…³é”®ï¼Œè¿™æ¶‰åŠã€Œä½ å½“å‰è¿è¡Œç³»ç»Ÿ vs å®‰è£…é•œåƒã€çš„æ ¸å¿ƒåŒºåˆ«ã€‚

------

## ğŸ§  **ä¸ºä»€ä¹ˆä½ æœ¬æ¥å¼„å¥½çš„å†…æ ¸å’Œç½‘å¡é©±åŠ¨ï¼Œç°åœ¨è‡ªåŠ¨å®‰è£…æ—¶åˆâ€œå¤±æ•ˆâ€äº†ï¼Ÿ**

å› ä¸ºä½ ç°åœ¨è·‘çš„æ˜¯ä¸€å¼  **æ–°çš„å®‰è£… ISO é•œåƒï¼ˆanaconda å®‰è£…å™¨ï¼‰**ï¼Œå®ƒå¹¶ä¸æ˜¯ä½ å½“å‰è¿è¡Œç³»ç»Ÿçš„å…‹éš†ï¼Œå®ƒæ˜¯é‡æ–°æ ¹æ® Kickstart æ–‡ä»¶ï¼š

- è£…ä¸€ä¸ªæ–°ç³»ç»Ÿï¼›
- ç„¶å**æŒ‰ç…§ `%packages` ä¸­åˆ—çš„åŒ…åé‡æ–°è£…å†…æ ¸å’Œé©±åŠ¨**ï¼›
- å¦‚æœä½ æ²¡æœ‰æŠŠè¿™äº›åŒ…æ”¾è¿› ISOï¼Œå®ƒå½“ç„¶å°±æç¤ºä½ â€œæ‰¾ä¸åˆ°â€ã€‚

------

## â—**ä½ å½“å‰ç³»ç»Ÿé‡Œè£…å¥½çš„é©±åŠ¨å’Œå†…æ ¸ï¼Œä¸ä¼šè‡ªåŠ¨å‡ºç°åœ¨ ISO é‡Œï¼**

ä½ ç³»ç»Ÿä¸Šåšçš„è¿™äº›ï¼š

- `yum install kernel-ml`
- ç¼–è¯‘ r8168ã€igc é©±åŠ¨
- `dracut` é‡å»º initramfs

**éƒ½åªä½œç”¨äºä½ è¿™å°å·²ç»å®‰è£…å®Œæˆçš„æœºå™¨**ï¼Œè€Œ ISO æ˜¯ç‹¬ç«‹çš„ï¼Œè¦ä½ æ‰‹åŠ¨å†æ‰“è¿›å»ã€‚

------

## ğŸ§± å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ

ä½ æœ‰ä¸¤ä¸ªé€‰æ‹© ğŸ‘‡ğŸ‘‡ğŸ‘‡

------

### âœ… æ–¹æ¡ˆ Aï¼š**ç»§ç»­ä½¿ç”¨ ks.cfg ä¸­çš„åŒ…åå®‰è£…æ–¹å¼ï¼ˆæ¨èåˆå­¦è€…ï¼‰**

ä½ éœ€è¦ï¼š

1. **ä¸‹è½½å¯¹åº” `.rpm` åŒ…åˆ°æœ¬åœ°**

```
bashCopyEdityum install --downloadonly --enablerepo=elrepo-kernel --downloaddir=/root kernel-ml
yum install --downloadonly --enablerepo=elrepo-kernel --downloaddir=/root kmod-r8168 kmod-igc kmod-e1000e
```

1. **æ”¾è¿› ISO çš„ `Packages/` ç›®å½•**

```
bash


CopyEdit
cp /root/*.rpm /root/custom_iso/Packages/
```

1. **é‡å»º repo å…ƒæ•°æ®**

```
bashCopyEditcd /root/custom_iso
createrepo -g repodata/*comps.xml Packages/
```

1. **é‡æ–°æ‰“åŒ… ISO**

è¿™æ · `%packages` é‡Œåˆ—çš„åŒ…éƒ½èƒ½æ‰¾åˆ°äº†ï¼Œä¸ä¼šå†æç¤ºä½ â€œæ‰¾ä¸åˆ°â€ã€‚

------

### âœ… æ–¹æ¡ˆ Bï¼š**ä¸ç”¨ `%packages` å®‰è£…è¿™äº›åŒ…ï¼Œç›´æ¥é›†æˆåˆ° initrd + å®‰è£…åè„šæœ¬ä¸­**

ä½ å¯ä»¥ï¼š

- ä» `%packages` é‡Œåˆ é™¤ï¼š

  ```
  CopyEditkmod-r8168
  kmod-igc
  kmod-e1000e
  kernel-ml
  ```

- åœ¨ `%post` è„šæœ¬ä¸­è§£å‹ `.ko` é©±åŠ¨ï¼Œæˆ–é¢„å…ˆæ‰“è¿› `initrd.img`

- ä½¿ç”¨ `dracut` + `modprobe` åŠ è½½é©±åŠ¨æ¨¡å—

------

## âœ… ç»“è®º

| åœºæ™¯                 | è¯´æ˜                                                      |
| -------------------- | --------------------------------------------------------- |
| ä½ è¿è¡Œçš„ç³»ç»Ÿè®¾ç½®å¥½äº† | âœ… æ˜¯ä½ çš„ç³»ç»Ÿç¯å¢ƒï¼Œä½†ä¸æ˜¯å®‰è£…é•œåƒå†…å®¹                      |
| å®‰è£…é•œåƒå†…å®¹æ¥æº     | âŒ ä¸æ˜¯ä»å½“å‰ç³»ç»Ÿå…‹éš†ï¼Œè€Œæ˜¯ `ks.cfg` å®šä¹‰çš„é‡è£…æµç¨‹        |
| `%packages` æ‰¾ä¸åˆ°åŒ… | æ˜¯å› ä¸ºè¿™äº› `.rpm` æ²¡æœ‰è¢«æ‰“åŒ…è¿› ISO                        |
| è§£å†³æ–¹æ³•             | âœ… è¦ä¹ˆåˆ æ‰åŒ…åï¼Œç”¨ `.ko` é©±åŠ¨ï¼›è¦ä¹ˆè¡¥é½ `.rpm` + é‡å»ºä»“åº“ |



------

å¦‚æœä½ æƒ³è®©æˆ‘ä¸€æ­¥å¸®ä½ ç”Ÿæˆã€Œæ‰“åŒ…æŒ‡å®š rpm åˆ° ISO å¹¶è‡ªåŠ¨ rebuild repoã€çš„è„šæœ¬ï¼Œæˆ‘å¯ä»¥ç›´æ¥è¾“å‡ºã€‚æ˜¯å¦éœ€è¦ï¼Ÿ





##### You said:

![Uploaded image](https://files09.oaiusercontent.com/file-8JUikWLC2XAbjbkq8Bop1j?se=2025-06-21T01%3A09%3A56Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D299%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3Dc2c2263a-fabd-4644-a3ec-5ef427e58faa.png&sig=PeW5M%2BRCdtUBnRVrAkhjhr39bzBtsCO/Q93/fXEJSFw%3D)

è¿™äº›æ–‡ä»¶éƒ½æ”¾åˆ°Packageç›®å½•ä¸‹ï¼Œå°±èƒ½è‡ªåŠ¨å‡çº§å†…æ ¸æ˜¯å—



###### ChatGPT said:

æ˜¯çš„ âœ…ï¼Œä½ è¿™ä¸‰ä¸ª RPM åŒ…ï¼š

```
CopyEditkernel-ml-5.15.154-1.el7.x86_64.rpm
kernel-ml-devel-5.15.154-1.el7.x86_64.rpm
kernel-ml-headers-5.15.154-1.el7.x86_64.rpm
```

å¦‚æœæ­£ç¡®æ”¾å…¥ **ISO çš„ `Packages/` ç›®å½•ä¸­ï¼Œå¹¶é…åˆ `%packages` å—å†™å…¥ `ks.cfg`**ï¼Œå°±èƒ½åœ¨å®‰è£…æ—¶è‡ªåŠ¨è£…ä¸Š **5.15 å†…æ ¸**ã€‚

------

## âœ… æ­£ç¡®æ“ä½œæµç¨‹å¦‚ä¸‹ï¼š

### ğŸ“ 1. æ‹·è´ `.rpm` åˆ° ISO æ„å»ºç›®å½•

```
bash


CopyEdit
cp kernel-ml-*.rpm /root/custom_iso/Packages/
```

> è¿™é‡Œ `/root/custom_iso` æ˜¯ä½ ä¹‹å‰ä»å®˜æ–¹ ISO è§£å¼€çš„ç›®å½•ã€‚

------

### ğŸ”„ 2. è¿›å…¥ `custom_iso` ç›®å½•ï¼Œé‡æ–°ç”Ÿæˆä»“åº“ç´¢å¼•ï¼ˆrepodataï¼‰

```
bashCopyEditcd /root/custom_iso
createrepo -g repodata/*comps.xml Packages/
```

å¦‚æœæ²¡æœ‰ `createrepo`ï¼Œå…ˆå®‰è£…ï¼š

```
bash


CopyEdit
yum install -y createrepo
```

------

### âœï¸ 3. ç¡®ä¿ Kickstart æ–‡ä»¶ï¼ˆ`ks.cfg`ï¼‰é‡ŒåŒ…å«ï¼š

```
bashCopyEdit%packages
@^minimal
kernel-ml
kernel-ml-devel
kernel-ml-headers
%end
```

è¿™æ ·ï¼Œå®‰è£…å™¨æ‰èƒ½ä» `Packages/` æ‰¾åˆ°å¹¶è£…ä¸Šä½ å‡†å¤‡çš„ `kernel-ml`ã€‚

------

## ğŸš« æ³¨æ„äº‹é¡¹

- åƒä¸‡ä¸è¦å¿˜è®° **æ‰§è¡Œ `createrepo`**ï¼Œå¦åˆ™å®‰è£…å™¨ä¸ä¼šçŸ¥é“ä½ åŠ äº†è¿™äº›åŒ…ã€‚
- å¦‚æœä½ ä¹Ÿç”¨ `kmod-r8168`ã€`kmod-igc` ç­‰é©±åŠ¨ `.rpm`ï¼Œå®ƒä»¬ä¹Ÿè¦æ”¾è¿› `Packages/`ï¼Œå¹¶ä¸€èµ·è·‘ `createrepo`ã€‚
- å®‰è£…åé»˜è®¤å¼•å¯¼å†…æ ¸æ˜¯æœ€åè£…çš„é‚£ä¸€ä¸ªï¼Œå› æ­¤è¿™ä¸ª `5.15` ä¼šæˆä¸ºé»˜è®¤å†…æ ¸ âœ…ã€‚

------

## âœ… æœ€åé‡æ‰“åŒ… ISO

```
bashCopyEditmkisofs -o /root/CentOS7-auto.iso \
  -b isolinux/isolinux.bin -c isolinux/boot.cat \
  -no-emul-boot -boot-load-size 4 -boot-info-table \
  -R -J -v -T \
  -V "CentOS 7 x86_64" \
  .
```

> å¦‚æœæ”¯æŒ UEFIï¼Œå†åŠ  `-eltorito-alt-boot -e images/efiboot.img -no-emul-boot` ç­‰å‚æ•°ã€‚

------

å¦‚æœä½ å¸Œæœ›æˆ‘æä¾›å®Œæ•´çš„ `ä¸€é”®å¤åˆ¶ rpm + createrepo + æ‰“åŒ… ISO` è„šæœ¬ï¼Œæˆ‘å¯ä»¥ç«‹åˆ»ç”Ÿæˆã€‚æ˜¯å¦éœ€è¦ï¼Ÿ





##### You said:

å¥½å§ï¼Œå†…æ ¸è§£å†³äº†ï¼Œé‚£ç½‘å¡é©±åŠ¨å‘¢ï¼Ÿæˆ‘èƒ½ç›´æ¥æŠŠå‡çº§è¿‡çš„å†…æ ¸å’Œç½‘å¡é©±åŠ¨æ¨¡å—ç›´æ¥åŠ è½½åˆ°æ–°çš„ISOä¸­å—



###### ChatGPT said:

å¾ˆå¥½ï¼Œä½ å·²ç»æå®šäº†å†…æ ¸ï¼Œç°åœ¨æˆ‘ä»¬æ¥è§£å†³ **ç½‘å¡é©±åŠ¨æ¨¡å—ï¼ˆ`.ko`ï¼‰** çš„é›†æˆé—®é¢˜ã€‚

------

## âœ… ä½ çš„ç›®æ ‡ï¼š

> **æŠŠä½ å½“å‰ç³»ç»Ÿä¸­å·²ç»ç¼–è¯‘å¥½çš„ r8168.koã€igc.koã€e1000e.ko ç­‰é©±åŠ¨æ¨¡å—ï¼Œç›´æ¥æ‰“è¿›æ–°çš„å®‰è£… ISO ä¸­ï¼Œå¹¶åœ¨å®‰è£…è¿‡ç¨‹ä¸­è‡ªåŠ¨ç”Ÿæ•ˆã€‚**

æ˜¯çš„ï¼Œè¿™æ˜¯å®Œå…¨å¯ä»¥åšåˆ°çš„ï¼Œè€Œä¸”æ¯”ç”¨ `.rpm` å®‰è£…æ›´ç¨³å¦¥ã€‚

------

## ğŸ¯ æœ€æ¨èçš„åšæ³•ï¼š

### âœ… **æ–¹æ³•ï¼šå°†é©±åŠ¨æ¨¡å—æ‰“åŒ…è¿›å®‰è£…å™¨çš„ `initrd.img`ï¼ˆinitramfsï¼‰ä¸­**

è¿™æ˜¯ Anaconda å®‰è£…å™¨å¯åŠ¨æ—¶åŠ è½½çš„å†…å­˜æ–‡ä»¶ç³»ç»Ÿï¼Œé‡Œé¢åŒ…å«äº†åˆå§‹å†…æ ¸æ¨¡å—ã€‚

ä¸€æ—¦ `.ko` åœ¨ initrd é‡Œï¼Œå®‰è£…å™¨å°±èƒ½è¯†åˆ«ç½‘å¡ï¼Œå®‰è£…è¿‡ç¨‹ä¸­ç½‘ç»œåŠŸèƒ½ä¹Ÿèƒ½ç”¨ï¼ˆå¦‚ NFSã€HTTP Kickstart å®‰è£…ï¼‰ï¼Œè€Œå®‰è£…åçš„ç³»ç»Ÿä¹Ÿèƒ½ç»§ç»­ä½¿ç”¨å®ƒã€‚

------

## ğŸ§± è¯¦ç»†æ“ä½œæ­¥éª¤ï¼š

### â‘  å‡†å¤‡ `.ko` æ¨¡å—

å‡è®¾ä½ å·²ç»ç¼–è¯‘å¥½äº†è¿™äº›æ¨¡å—ï¼Œæ¯”å¦‚ï¼š

```
swiftCopyEdit/lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/realtek/r8168.ko
/lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/igc.ko
/lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/e1000e/e1000e.ko
```

å…ˆæŠŠå®ƒä»¬æ”¶é›†èµ·æ¥ï¼š

```
bashCopyEditmkdir -p /root/custom_drivers
cp /lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/realtek/r8168.ko /root/custom_drivers/
cp /lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/igc.ko /root/custom_drivers/
cp /lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/e1000e/e1000e.ko /root/custom_drivers/
```

------

### â‘¡ è§£å¼€å®‰è£…é•œåƒä¸­çš„ `initrd.img`

```
bashCopyEditmkdir /mnt/initrd
cd /mnt/initrd

# å‡è®¾ä» ISO ä¸­æå–çš„æ˜¯ images/pxeboot/initrd.img
gzip -dc /root/custom_iso/images/pxeboot/initrd.img | cpio -idmv
```

------

### â‘¢ æŠŠ `.ko` æ‹·è´è¿›å»å¯¹åº”å†…æ ¸æ¨¡å—è·¯å¾„ä¸­ï¼ˆä¾‹å¦‚ä½ ä½¿ç”¨çš„æ˜¯ 5.15ï¼‰

```
bashCopyEditmkdir -p lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/realtek/
cp /root/custom_drivers/r8168.ko lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/realtek/

mkdir -p lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/
cp /root/custom_drivers/igc.ko lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/
cp /root/custom_drivers/e1000e.ko lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/intel/
```

------

### â‘£ ç”Ÿæˆä¾èµ–ä¿¡æ¯ï¼ˆå¯é€‰ä½†æ¨èï¼‰

```
bash


CopyEdit
depmod -b . 5.15.154-1.el7.x86_64
```

------

### â‘¤ æ‰“åŒ…å›æ–°çš„ initrd.img

```
bash


CopyEdit
find . | cpio -H newc -o | gzip -c > /root/custom_iso/images/pxeboot/initrd.img
```

ä¹Ÿè¯·åŒæ—¶è¦†ç›– `isolinux/initrd.img` å’Œ `EFI/BOOT/initrd.img` ä¸­çš„å‰¯æœ¬ã€‚

------

### âœ… å¯é€‰è¡¥å……ï¼ˆé»‘åå•é»˜è®¤çš„é©±åŠ¨ï¼‰

ä¸ºäº†é˜²æ­¢å†…æ ¸è¯¯åŠ è½½ `r8169`ï¼š

```
bash


CopyEdit
echo "blacklist r8169" > /mnt/initrd/etc/modprobe.d/blacklist-r8169.conf
```

------

### âœ… é‡æ–°æ‰“åŒ… ISO

ä½ å·²ç»åšè¿‡ï¼Œå¯ä»¥ç…§å¸¸æ‰§è¡Œ `mkisofs` æˆ– `xorriso`ã€‚

------

## âœ… æœ€ç»ˆæ•ˆæœ

ä½ å°è£…å‡ºçš„å®‰è£… ISOï¼š

- å« 5.15 kernel
- å«ä½ å½“å‰æµ‹è¯•é€šè¿‡çš„ `.ko` ç½‘å¡é©±åŠ¨
- å®‰è£…è¿‡ç¨‹èƒ½ç›´æ¥è¯†åˆ«èƒèŸ¹ç½‘å¡ã€I225/I226 ç­‰
- å®‰è£…åç³»ç»Ÿä¹Ÿèƒ½ç›´æ¥é©±åŠ¨è¿™äº›ç½‘å¡

------

## âœ… æ€»ç»“

| é©±åŠ¨é›†æˆæ–¹å¼              | æ¨èç¨‹åº¦ | è¯´æ˜                    |
| ------------------------- | -------- | ----------------------- |
| æ”¾è¿› `%packages` + åŠ  RPM | ğŸŒ•ğŸŒ•ğŸŒ•      | éœ€è¦ `.rpm`ã€ä¾èµ–ã€repo |
| ç›´æ¥æ‰“è¿› `initrd.img`     | ğŸŒ•ğŸŒ•ğŸŒ•ğŸŒ•ğŸŒ•    | æ›´çµæ´»ã€æœ€ç¨³å¦¥ï¼Œæ¨è    |



------

æ˜¯å¦éœ€è¦æˆ‘ä¸ºä½ è¾“å‡ºä¸€ä¸ªè‡ªåŠ¨æ‰§è¡Œæ•´ä¸ªæµç¨‹çš„ bash è„šæœ¬ï¼Ÿå¯è‡ªåŠ¨æ”¶é›† `.ko`ã€è§£åŒ…ã€æ‰“è¿› initrdã€‚





##### You said:

[root@localhost initrd]# gzip -dc /root/custom_iso/images/pxeboot/initrd.img | cpio -idmv gzip: /root/custom_iso/images/pxeboot/initrd.img: not in gzip format cpio: premature end of archive



###### ChatGPT said:

ä½ è¿™ä¸ªæŠ¥é”™è¯´æ˜ä½ å°è¯•ç”¨ `gzip -dc` è§£å‹ `initrd.img`ï¼Œä½†è¯¥æ–‡ä»¶ **å¹¶ä¸æ˜¯ gzip æ ¼å¼**ï¼Œæ‰€ä»¥å¤±è´¥äº†ã€‚

------

## ğŸ” æŠ¥é”™è¯¦æƒ…è§£è¯»ï¼š

```
vbnetCopyEditgzip: ...initrd.img: not in gzip format
cpio: premature end of archive
```

è¿™è¡¨ç¤ºï¼š

- `/root/custom_iso/images/pxeboot/initrd.img` å®é™…æ˜¯ **xz æˆ– lzma æˆ– raw cpio** æ ¼å¼ï¼›
- è€Œä½ ç”¨çš„æ˜¯ `gzip` è§£å‹ï¼Œè‡ªç„¶å¤±è´¥ã€‚

------

## âœ… æ­£ç¡®è§£å‹æ–¹å¼ï¼šå…ˆåˆ¤æ–­å‹ç¼©æ ¼å¼

ä½ éœ€è¦è¿è¡Œï¼š

```
bash


CopyEdit
file /root/custom_iso/images/pxeboot/initrd.img
```

çœ‹çœ‹å®ƒå±äºå“ªç§ç±»å‹ã€‚ä¸¾ä¾‹è¾“å‡ºå¯èƒ½æœ‰ï¼š

| è¾“å‡º                   | è§£å‹å‘½ä»¤                 |
| ---------------------- | ------------------------ |
| `gzip compressed data` | âœ… ç”¨ `gzip -dc`          |
| `XZ compressed data`   | âœ… ç”¨ `xz -dc`            |
| `ASCII cpio archive`   | âœ… ç›´æ¥ç”¨ `cpio -idmv`    |
| `LZ4 compressed data`  | âœ… ç”¨ `lz4 -dc`ï¼ˆå¾ˆå°‘è§ï¼‰ |



------

## ğŸ’¡ ç¤ºä¾‹ï¼šå¦‚æœæ˜¯ XZ æ ¼å¼ï¼ˆCentOS 7 å¾ˆå¯èƒ½æ˜¯ï¼‰

```
bashCopyEditmkdir /mnt/initrd
cd /mnt/initrd
xz -dc /root/custom_iso/images/pxeboot/initrd.img | cpio -idmv
```

å¦‚æœæ˜¯ raw cpioï¼ˆæ²¡æœ‰å‹ç¼©ï¼‰ï¼Œé‚£ç›´æ¥ï¼š

```
bash


CopyEdit
cpio -idmv < /root/custom_iso/images/pxeboot/initrd.img
```

------

## âœ… è§£å®Œä¹‹åä½ å¯ä»¥ç»§ç»­ï¼š

- æ‹·è´ `.ko` æ¨¡å—è¿›å»åˆé€‚è·¯å¾„ï¼›
- `depmod -b . 5.15.xxxx`ï¼›
- ç„¶åé‡æ–°æ‰“åŒ…ï¼š

```
bash


CopyEdit
find . | cpio -H newc -o | gzip -c > /root/custom_iso/images/pxeboot/initrd.img
```

ï¼ˆæˆ–ç”¨ `xz -c` é‡æ–°å‹ç¼©ï¼Œçœ‹åŸå§‹æ ¼å¼æ¥é€‰ï¼‰

------

å¦‚æœä½ å¸Œæœ›æˆ‘ç»™ä½ å‡ºä¸€ä¸ªè‡ªåŠ¨åˆ¤æ–­æ ¼å¼å¹¶è§£å‹çš„è„šæœ¬ï¼Œä¹Ÿå¯ä»¥ç«‹åˆ»å¸®ä½ ç”Ÿæˆã€‚éœ€è¦å—ï¼Ÿ





##### You said:

[root@localhost initrd]# depmod -b . 5.15.154-1.el7.x86_64 depmod: WARNING: could not open /mnt/initrd/./lib/modules/5.15.154-1.el7.x86_64/modules.order: No such file or directory depmod: WARNING: could not open /mnt/initrd/./lib/modules/5.15.154-1.el7.x86_64/modules.builtin: No such file or directory



###### ChatGPT said:

ä½ æ‰§è¡Œ `depmod -b . 5.15.154-1.el7.x86_64` æ—¶çš„è¿™ä¸ªè­¦å‘Šæ˜¯å› ä¸ºï¼š

> `depmod` éœ€è¦ä½ æä¾›å®Œæ•´çš„å†…æ ¸æ¨¡å—ç›®å½•ç»“æ„ï¼Œä½†ä½  **åªå¤åˆ¶äº†å°‘é‡ `.ko` æ–‡ä»¶è¿›å»**ï¼Œæ²¡æœ‰æŠŠå®Œæ•´çš„ `/lib/modules/5.15...` ç›®å½•æ‰“è¿›å»ï¼Œæ‰€ä»¥å®ƒæç¤ºæ‰¾ä¸åˆ°ï¼š

```
vbnetCopyEditmodules.order
modules.builtin
```

è¿™äº›æ–‡ä»¶æ˜¯å†…æ ¸æ¨¡å—åŠ è½½é¡ºåºå’Œå†…ç½®æ¨¡å—åˆ—è¡¨çš„ç´¢å¼•ã€‚

------

## âœ… è¿™æ˜¯å¦æ˜¯è‡´å‘½é”™è¯¯ï¼Ÿ

ä¸æ˜¯ã€‚**å¯¹äº initrd ä¸­åªæƒ³è®©ç‰¹å®šæ¨¡å— `.ko` å¯åŠ è½½çš„åœºæ™¯ï¼Œè¿™ä¸ªè­¦å‘Šå¯ä»¥å¿½ç•¥**ï¼Œä½ æ‰‹åŠ¨ `modprobe` æˆ–å®ƒè‡ªåŠ¨æ¢æµ‹ `.ko` æ–‡ä»¶æ—¶æ˜¯å¯ä»¥å·¥ä½œçš„ â€”â€” å‰ææ˜¯æ¨¡å—è·¯å¾„æ­£ç¡®ã€‚

------

## âœ… æ­£ç¡®åšæ³•ï¼ˆä¸¤ç§é€‰æ‹©ï¼‰ï¼š

------

### âœ… æ–¹æ³•ä¸€ï¼ˆæœ€å°å¯ç”¨æ–¹å¼ï¼‰ï¼š

ä½ åªéœ€è¦æŠŠ `.ko` æ”¾åœ¨æ ‡å‡†è·¯å¾„ï¼Œæ¯”å¦‚ï¼š

```
swift


CopyEdit
lib/modules/5.15.154-1.el7.x86_64/kernel/drivers/net/ethernet/realtek/r8168.ko
```

ç„¶åä½ å¯ä»¥å®Œå…¨è·³è¿‡ `depmod`ï¼Œå®‰è£…å™¨ä»ç„¶å¯ä»¥å‘ç°å¹¶åŠ è½½å®ƒã€‚

------

### âœ… æ–¹æ³•äºŒï¼ˆæ›´å¹²å‡€çš„æ–¹å¼ï¼Œæ¨èç”Ÿäº§ç¯å¢ƒï¼‰ï¼š

ä»å½“å‰ç³»ç»Ÿå®Œæ•´å¤åˆ¶ `/lib/modules/5.15.154-1.el7.x86_64` æ¨¡å—ç›®å½•åˆ° initrd ä¸­ï¼š

```
bash


CopyEdit
cp -a /lib/modules/5.15.154-1.el7.x86_64 ./lib/modules/
```

ç„¶åå†æ‰§è¡Œï¼š

```
bash


CopyEdit
depmod -b . 5.15.154-1.el7.x86_64
```

å°±ä¸ä¼šæŠ¥é”™äº†ã€‚è¿™æ ·ï¼š

- `modules.dep`ã€`modules.alias`ã€`modules.order` éƒ½ä¼šè‡ªåŠ¨ç”Ÿæˆ
- å®‰è£…å™¨å¯ä»¥æ­£ç¡®è§£æä¾èµ–å¹¶åŠ è½½æ¨¡å—

------

## âœ… æœ€ç»ˆæ€»ç»“ï¼š

| æ–¹æ¡ˆ                                     | æ˜¯å¦èƒ½ç”¨                     | å¤‡æ³¨                               |
| ---------------------------------------- | ---------------------------- | ---------------------------------- |
| åªå¤åˆ¶ `.ko` æ–‡ä»¶ï¼Œä¸è·‘ `depmod`         | âœ… **èƒ½ç”¨**ï¼ˆåªè¦æ¨¡å—è·¯å¾„å¯¹ï¼‰ | ç”¨äºå°ä½“ç§¯å¿«é€Ÿæ‰“åŒ…                 |
| å®Œæ•´å¤åˆ¶ `/lib/modules/` å¹¶æ‰§è¡Œ `depmod` | âœ… æ›´ç¨³å¦¥ã€æ¨è               | å¦‚æœä½ æƒ³å®Œå…¨è¿˜åŸä½ å½“å‰ç³»ç»Ÿå†…æ ¸æ”¯æŒ |



------

éœ€è¦æˆ‘ç”Ÿæˆä¸€ä¸ªè‡ªåŠ¨åŒ–è„šæœ¬ï¼ŒæŠŠå½“å‰ç³»ç»Ÿçš„ `.ko` é©±åŠ¨æ¨¡å—å’Œ `/lib/modules` æ•´ä½“æ‰“è¿› initrdï¼Œå¹¶è‡ªåŠ¨æ‰“åŒ…ï¼Ÿ





##### You said:

y



###### ChatGPT said:

å¾ˆå¥½ ğŸ‘ï¼ä¸‹é¢æ˜¯ä¸€ä¸ª **ä¸€é”®è‡ªåŠ¨åŒ–è„šæœ¬**ï¼Œå°†ä½ å½“å‰ç³»ç»Ÿä¸‹çš„å†…æ ¸æ¨¡å—ï¼ˆåŒ…æ‹¬å·²ç¼–è¯‘çš„ç½‘å¡é©±åŠ¨ `.ko` æ–‡ä»¶ï¼‰ï¼Œæ‰“åŒ…åˆ°ä½ å®šåˆ¶ ISO ä¸­çš„ `initrd.img` ä¸­ï¼Œå¹¶è‡ªåŠ¨é‡æ–°æ‰“åŒ…ã€‚

------

## âœ… è„šæœ¬ç”¨é€”

- è‡ªåŠ¨è§£å‹ `initrd.img`
- è‡ªåŠ¨å¤åˆ¶ `/lib/modules/<kernel>` ä¸‹æ‰€æœ‰æ¨¡å—
- è‡ªåŠ¨æ‰§è¡Œ `depmod` æ„å»ºæ¨¡å—ç´¢å¼•
- è‡ªåŠ¨é‡æ–°æ‰“åŒ… `initrd.img`ï¼ˆgzip æˆ– xz è‡ªåŠ¨åˆ¤æ–­ï¼‰

------

## ğŸ›  è„šæœ¬å†…å®¹ï¼š`inject_modules_to_initrd.sh`

```
bashCopyEdit#!/bin/bash

set -e

# å†…æ ¸ç‰ˆæœ¬è‡ªåŠ¨è·å–ï¼ˆä¹Ÿå¯ä»¥æ‰‹åŠ¨æŒ‡å®šï¼‰
KVER=$(uname -r)
INITRD_PATH="/root/custom_iso/images/pxeboot/initrd.img"
WORKDIR="/tmp/initrd-unpack"

echo "[*] æ­£åœ¨æ£€æµ‹ initrd å‹ç¼©æ ¼å¼..."
file "$INITRD_PATH"

FORMAT=$(file "$INITRD_PATH")
if echo "$FORMAT" | grep -q "gzip"; then
  DECOMPRESS="gzip -dc"
  COMPRESS="gzip -c"
  EXT="gz"
elif echo "$FORMAT" | grep -q "XZ"; then
  DECOMPRESS="xz -dc"
  COMPRESS="xz -c"
  EXT="xz"
else
  echo "âŒ ä¸æ”¯æŒçš„ initrd æ ¼å¼ï¼"
  exit 1
fi

echo "[*] ä½¿ç”¨è§£å‹æ–¹å¼: $DECOMPRESS"
echo "[*] ä½¿ç”¨å‹ç¼©æ–¹å¼: $COMPRESS"

# æ¸…ç†å¹¶åˆ›å»ºå·¥ä½œç›®å½•
rm -rf "$WORKDIR"
mkdir -p "$WORKDIR"
cd "$WORKDIR"

echo "[*] è§£å‹ initrd..."
$DECOMPRESS "$INITRD_PATH" | cpio -idmv

echo "[*] æ‹·è´å½“å‰ç³»ç»Ÿçš„æ¨¡å— $KVER..."
mkdir -p "./lib/modules/$KVER"
cp -a /lib/modules/$KVER/* "./lib/modules/$KVER/"

echo "[*] æ„å»ºæ¨¡å—ä¾èµ–ç´¢å¼• (depmod)..."
depmod -b . $KVER

echo "[*] é‡æ–°æ‰“åŒ… initrd.img åˆ°: $INITRD_PATH"
find . | cpio -H newc -o | $COMPRESS > "$INITRD_PATH"

echo "âœ… å®Œæˆï¼æ–° initrd å·²ç”Ÿæˆï¼š$INITRD_PATH"

# å¯é€‰ï¼šåŒæ—¶è¦†ç›– isolinux/ å’Œ EFI/BOOT/ ä¸­çš„ initrd.imgï¼ˆå¦‚æœ‰ï¼‰
cp "$INITRD_PATH" /root/custom_iso/isolinux/initrd.img 2>/dev/null || true
cp "$INITRD_PATH" /root/custom_iso/EFI/BOOT/initrd.img 2>/dev/null || true

echo "âœ… å·²è¦†ç›– pxeboot / isolinux / EFI çš„ initrd.img"
```

------

## âœ… ä½¿ç”¨æ–¹æ³•

1. ä¿å­˜ä¸ºè„šæœ¬ï¼š`inject_modules_to_initrd.sh`
2. èµ‹äºˆå¯æ‰§è¡Œæƒé™ï¼š

```
bash


CopyEdit
chmod +x inject_modules_to_initrd.sh
```

1. è¿è¡Œï¼š

```
bash


CopyEdit
./inject_modules_to_initrd.sh
```

------

## âœ… è„šæœ¬æ•ˆæœ

| åŠ¨ä½œ                                            | è‡ªåŠ¨å®Œæˆ                             |
| ----------------------------------------------- | ------------------------------------ |
| è‡ªåŠ¨è¯†åˆ« gzip/xz æ ¼å¼                           | âœ…                                    |
| è§£å‹ initrd.img                                 | âœ…                                    |
| æ³¨å…¥å®Œæ•´ `/lib/modules/<kernel>`                | âœ… åŒ…å«æ‰€æœ‰ `.ko` å’Œ `modules.dep` ç­‰ |
| `depmod` æ„å»ºæ¨¡å—ç´¢å¼•                           | âœ…                                    |
| é‡æ–°æ‰“åŒ… initrd.img                             | âœ…                                    |
| è‡ªåŠ¨è¦†ç›– pxeboot / isolinux / EFI çš„ initrd.img | âœ…                                    |



------

æ˜¯å¦è¿˜éœ€è¦æˆ‘é™„å¸¦ä¸€ä¸ªè‡ªåŠ¨æŠŠ `kmod-xxx.rpm` ä¹Ÿæ‰“è¿› ISO çš„ç‰ˆæœ¬ï¼Ÿå¯ä»¥ç»“åˆ `%packages` ç”¨ RPM å®‰è£…é©±åŠ¨ã€‚





##### You said:

æˆ‘ç›´æ¥cp -a /lib/modules/5.15.154-1.el7.x86_64 ./lib/modules/ï¼Œè¿™æ ·çš„è¯å°±ç›¸é‡å§å‡çº§å¥½çš„å†…æ ¸ç›´æ¥åŠ è½½è¿›å»äº†ï¼Œä¸éœ€è¦åœ¨å°†rpmåŒ…æ”¾å…¥packageé‡Œäº†æ˜¯å—



###### ChatGPT said:

æ˜¯çš„ï¼Œä½ çš„ç†è§£åŸºæœ¬æ­£ç¡® âœ…ï¼Œä¸‹é¢æˆ‘å¸®ä½ ç³»ç»Ÿæ¢³ç†ä¸€ä¸‹å…³é”®ç‚¹ï¼š

------

## âœ… ä½ å½“å‰æ“ä½œæ˜¯åšä»€ä¹ˆï¼Ÿ

ä½ æ‰§è¡Œï¼š

```
bash


CopyEdit
cp -a /lib/modules/5.15.154-1.el7.x86_64 ./lib/modules/
```

æ˜¯å°†å·²ç»å®‰è£…å¥½çš„å†…æ ¸æ¨¡å—ï¼ˆåŒ…æ‹¬ä½ è‡ªå·±ç¼–è¯‘å¥½çš„ `r8168.ko`ã€`igc.ko` ç­‰ç½‘å¡é©±åŠ¨ï¼‰**ç›´æ¥æ³¨å…¥åˆ° initrd.img è§£åŒ…åçš„ç›®å½•ç»“æ„é‡Œ**ã€‚

è¿™å°±æ„å‘³ç€â€”â€”

### âœ… å®‰è£…ç¨‹åºåœ¨å®‰è£…æ—¶ï¼Œåªè¦ä½¿ç”¨äº†è¯¥ `initrd.img`ï¼Œå°±ï¼š

- èƒ½è¯†åˆ« 5.15.154 å†…æ ¸ç‰ˆæœ¬
- è‡ªåŠ¨åŠ è½½æ‰€æœ‰ä½ é¢„å…ˆæ³¨å…¥çš„ç½‘å¡é©±åŠ¨æ¨¡å—ï¼ˆä¸ä¾èµ–æ˜¯å¦æœ‰ kmod RPMï¼‰
- ä¸éœ€è¦ç”¨æˆ·å†æ‰‹åŠ¨å®‰è£…ç½‘å¡é©±åŠ¨æˆ–å•ç‹¬æä¾› `.ko` æ–‡ä»¶

------

## ğŸ“¦ ä¸éœ€è¦æ”¾å…¥ RPM åŒ…çš„å‰ææ˜¯ï¼š

1. ä½ å·²ç»å°†ç›®æ ‡å†…æ ¸ç‰ˆæœ¬çš„ `/lib/modules/<version>` æ•´ä½“æ‰“åŒ…å…¥ `initrd.img`
2. åœ¨ Kickstart å®‰è£…è¿‡ç¨‹ä¸­ä¸éœ€è¦é€šè¿‡ `%packages` è‡ªåŠ¨å®‰è£… `kernel-ml`, `kmod-r8168` ç­‰é¢å¤–åŒ…

> æ¢å¥è¯è¯´ï¼Œä½ æ˜¯ä»¥ã€Œ**é¢„è£…å¥½çš„ initrd + å†…æ ¸æ¨¡å—ç›®å½•**ã€æ–¹å¼å®ç°é©±åŠ¨æ³¨å…¥ï¼Œè€Œä¸æ˜¯èµ° RPM å®‰è£…è·¯å¾„ã€‚

------

## ğŸŸ¡ ä»€ä¹ˆæ—¶å€™éœ€è¦æ”¾å…¥ RPMï¼Ÿ

åªæœ‰åœ¨ä½ èµ°ä¸‹é¢è¿™ä¸¤ç§è·¯å¾„æ—¶ï¼Œæ‰éœ€è¦ `.rpm` åŒ…ï¼š

| åœºæ™¯                                           | æ˜¯å¦éœ€è¦å†…æ ¸ RPM / é©±åŠ¨ RPM           |
| ---------------------------------------------- | ------------------------------------- |
| ç”¨ Kickstart + `%packages` è‡ªåŠ¨å®‰è£…            | âœ… éœ€è¦ `.rpm`                         |
| å®‰è£…è¿‡ç¨‹ä»ç½‘ç»œæˆ–æœ¬åœ°ä»“åº“å®‰è£…å†…æ ¸               | âœ… éœ€è¦ `.rpm`                         |
| ä½ æƒ³è®©ç³»ç»Ÿæœ€ç»ˆ **å¯ä»¥å†æ¬¡ yum reinstall é©±åŠ¨** | âœ… éœ€è¦ `.rpm`                         |
| å®Œå…¨é å®šåˆ¶ `initrd.img` å¹¶å¤åˆ¶æ¨¡å—ç›®å½•         | âŒ ä¸éœ€è¦ `.rpm`ï¼ˆä½ å½“å‰å°±æ˜¯è¿™ç§æ–¹å¼ï¼‰ |



------

## âœ… æ€»ç»“ä¸€å¥è¯ï¼š

ä½ åªè¦å°† `/lib/modules/5.15.154-1.el7.x86_64` æ•´ä¸ªç›®å½•æ‰“åŒ…è¿›äº† `initrd.img`ï¼Œ**å®‰è£…æ—¶å°±ä¼šè‡ªåŠ¨æ”¯æŒä½ çš„ 5.x å†…æ ¸å’Œé©±åŠ¨ï¼Œä¸å†éœ€è¦é¢å¤–æ”¾ RPM åŒ…è¿› Package ç›®å½•æˆ–å®‰è£…æµç¨‹ä¸­**ã€‚

å¦‚æœä½ è¿˜æƒ³è¿›ä¸€æ­¥è®©ç³»ç»Ÿå®‰è£…å®Œæˆå `/boot/vmlinuz-*` å’Œ `/lib/modules/*` éƒ½å®Œæ•´åŒ…å«å¯¹åº”å†…æ ¸ï¼ˆè€Œéåªé  initrdï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘åœ¨ kickstart `%post` é˜¶æ®µæ‰§è¡Œä¸€äº›å¤åˆ¶æ“ä½œã€‚

æ˜¯å¦éœ€è¦æˆ‘å†å¸®ä½ ç”Ÿæˆå®Œæ•´æ‰“åŒ…å’ŒéªŒè¯æµç¨‹è„šæœ¬ï¼Ÿ





##### You said:

![Uploaded image](https://files09.oaiusercontent.com/file-VRpAEoLQYYLgeSisY7VtwY?se=2025-06-21T01%3A25%3A03Z&sp=r&sv=2024-08-04&sr=b&rscc=max-age%3D299%2C%20immutable%2C%20private&rscd=attachment%3B%20filename%3Dd2e273c5-c6e6-4020-a070-042238e6ae8e.png&sig=u1CSws27SaqiR5/ZgzgwaQi/Km77O0hyAeYVWhwJQvM%3D)

æˆ‘å°†/root/custom_iso/isolinux ç›®å½•ä¸‹çš„initrd.imgè§£å‹åï¼Œå°†å…¶ä¸­çš„/lib/modules/æ›¿æ¢ä¸ºæˆ‘å½“å‰æ“ä½œç³»ç»Ÿçš„/lib/modulesï¼Œå› ä¸ºå½“å‰æ“ä½œç³»ç»Ÿçš„/lib/modulesæ˜¯ç½‘å¡é©±åŠ¨å’Œå†…æ ¸å‡çº§éƒ½æå®šçš„ï¼Œç„¶åé‡æ–°æ‰“åŒ…åè¦†ç›–initrd.imgï¼Œç„¶åç”Ÿæˆisoï¼Œè¿™ä¸ªæ€è·¯å¯¹å—ã€ä¸ºä»€ä¹ˆæœ€åç”Ÿæˆçš„é•œåƒï¼Œä½¿ç”¨çš„è¯ï¼Œæ˜¯è¿™æ ·ï¼Œåªæœ‰ä¸€ä¸ªå°å…‰æ ‡ä¸€ç›´åœ¨é—ª



###### ChatGPT said:

ä½ çš„æ€è·¯æ˜¯æ­£ç¡®çš„ï¼Œä½†æœ€ç»ˆå‡ºç°å¼•å¯¼å¡æ­»ã€å±å¹•åªæœ‰é—ªçƒå…‰æ ‡çš„é—®é¢˜ï¼Œè¯´æ˜é—®é¢˜ä¸åœ¨äº `lib/modules/` æ˜¯å¦æ›¿æ¢æˆåŠŸï¼Œè€Œå¯èƒ½å‡ºç°åœ¨ä¸‹é¢å‡ ä¸ª **å…³é”®ç‚¹** ä¸Šï¼š

------

## âœ… ä½ çš„æ“ä½œæ€»ç»“ï¼ˆæ€è·¯å¯¹ï¼‰

ä½ åšäº†ä»¥ä¸‹å‡ æ­¥ï¼š

1. è§£åŒ… `/root/custom_iso/isolinux/initrd.img`ï¼š

   ```
   bashCopyEditmkdir /mnt/initrd && cd /mnt/initrd
   gzip -dc /root/custom_iso/isolinux/initrd.img | cpio -idmv
   ```

2. ç”¨ä½ å½“å‰ç³»ç»Ÿä¸­å·²å‡çº§å¥½å†…æ ¸å’Œç½‘å¡é©±åŠ¨çš„æ¨¡å—ç›®å½•æ›¿æ¢åŸæ¥çš„ `/lib/modules/*`ï¼š

   ```
   bashCopyEditrm -rf ./lib/modules/*
   cp -a /lib/modules/5.15.154-1.el7.x86_64 ./lib/modules/
   ```

3. é‡æ–°æ‰“åŒ…ï¼š

   ```
   bash
   
   
   CopyEdit
   find . | cpio -o -H newc | gzip -9 > /root/custom_iso/isolinux/initrd.img
   ```

4. ä½¿ç”¨ `mkisofs` é‡æ–°ç”Ÿæˆ ISO

è¿™äº› **æ­¥éª¤æ²¡æœ‰é€»è¾‘é”™è¯¯**ï¼Œä½†è¿˜ä¸å¤Ÿ **å®Œæ•´å’Œä¸¥è°¨**ï¼Œä½ ç°åœ¨é‡åˆ°çš„é—®é¢˜æå¯èƒ½æ˜¯ä»¥ä¸‹æŸäº›é—æ¼å¯¼è‡´çš„ã€‚

------

## âŒ ä¸ºä»€ä¹ˆå¯åŠ¨åé»‘å± + å…‰æ ‡é—ªçƒ

### 1. **initrd.img åªåŒ…å«æ¨¡å—ï¼Œä½†æ²¡æœ‰å’Œ vmlinuz åŒ¹é…**

- ä½ å‡çº§åˆ°äº† 5.15.154 çš„å†…æ ¸æ¨¡å—ï¼Œä½† **vmlinuz æ–‡ä»¶å¯èƒ½ä»ç„¶æ˜¯ CentOS 7.9 åŸå§‹çš„å†…æ ¸ vmlinuz-3.10.x**ã€‚

- `initrd.img` å’Œ `vmlinuz` æ˜¯æˆå¯¹çš„ã€‚

- æ‰€ä»¥ä½ å¿…é¡»ç¡®è®¤ä½ åœ¨ `isolinux/` ç›®å½•ä¸‹ **æ˜¯å¦ä¹Ÿæ›¿æ¢äº†å¯¹åº”ç‰ˆæœ¬çš„å†…æ ¸æ–‡ä»¶**ï¼š

  ```
  bash
  
  
  CopyEdit
  cp /boot/vmlinuz-5.15.154-1.el7.x86_64 /root/custom_iso/isolinux/vmlinuz
  ```

> âš ï¸ å¦åˆ™å†…æ ¸åŠ è½½ `initrd.img` åæ ¹æœ¬æ— æ³•è¯†åˆ«æ¨¡å—ï¼Œç›´æ¥å†…æ ¸ panic æˆ–é»‘å±æ­»å¾ªç¯ï¼

------

### 2. **æ²¡æœ‰æ‰§è¡Œ `dracut` é‡æ–°ç”Ÿæˆ initramfs**

å¦‚æœä½ ä»…ä»…å¤åˆ¶äº† `/lib/modules/5.15.*` åˆ° initrd.imgï¼Œæ˜¯ä¸å¤Ÿçš„ï¼

ä½ åº”è¯¥åœ¨ä¸€ä¸ªå¹²å‡€ç›®å½•ï¼ˆchroot æˆ–æ¨¡æ‹Ÿç›®å½•ï¼‰ä¸­é‡æ–°æ‰§è¡Œï¼š

```
bash


CopyEdit
dracut --force --no-hostonly --kver 5.15.154-1.el7.x86_64 initrd.img
```

æˆ–è€…åœ¨åŸç³»ç»Ÿä¸­æ‰‹åŠ¨æ„é€ å¥½ `/lib/modules` å¹¶ç”Ÿæˆå®Œæ•´çš„ `initrd.img` åï¼Œå†æ‰“åŒ…è¿› ISOã€‚

------

### 3. **grub/isolinux/EFI é…ç½®æ²¡æœ‰æ›´æ–°**

ç¡®ä¿ä½ åœ¨ `isolinux/isolinux.cfg` æ–‡ä»¶ä¸­ä¹ŸåŒæ­¥æ›´æ–°äº† kernel è¡Œï¼š

```
cfgCopyEditlabel linux
  menu label ^Install Custom CentOS
  kernel vmlinuz
  append initrd=initrd.img ks=cdrom:/ks.cfg quiet
```

å¦åˆ™è€çš„ `vmlinuz` å’Œä½ æ–°çš„ `initrd.img` ä¸åŒ¹é…ï¼Œä¹Ÿæ˜¯é»‘å±ã€‚

------

### 4. **SELinux / æ–‡ä»¶æƒé™ç ´å**

ä½ åœ¨ä¿®æ”¹ `initrd.img` æˆ–æ•´ä¸ª ISO ç›®å½•ç»“æ„æ—¶ï¼Œå¯èƒ½ç ´åäº†ï¼š

- `/sbin/init` æˆ– `/init` çš„æƒé™ï¼ˆéœ€ `0755`ï¼‰
- `initrd.img` å†…éƒ¨ç¼ºå¤±å¿…è¦çš„ init è·¯å¾„æˆ–æ¨¡å—åŠ è½½é¡ºåº
- å¯¼è‡´å†…æ ¸æ— æ³•æ‰¾åˆ°æ ¹ç³»ç»Ÿå¹¶è¿›å…¥ shell

------

## âœ… æ­£ç¡®çš„æ“ä½œæ€è·¯æµç¨‹

å»ºè®®å¦‚ä¸‹ï¼š

### âœ… **æ¨èæ­¥éª¤ï¼ˆæœ€å¯é ï¼‰**ï¼š

1. **å®Œæ•´ç”Ÿæˆ initrd.imgï¼š**

   ```
   bash
   
   
   CopyEdit
   dracut -f /root/initrd-5.15.154.img 5.15.154-1.el7.x86_64
   ```

2. **å¤åˆ¶ vmlinuz å’Œ initrd.imgï¼š**

   ```
   bashCopyEditcp /boot/vmlinuz-5.15.154-1.el7.x86_64 /root/custom_iso/isolinux/vmlinuz
   cp /root/initrd-5.15.154.img /root/custom_iso/isolinux/initrd.img
   ```

3. **ç¡®è®¤ isolinux.cfg ä¸­ kernel å’Œ initrd æŒ‡å‘æ­£ç¡®**

4. **é‡æ–°æ‰“åŒ… ISO**

------

## âœ… æ˜¯å¦éœ€è¦æˆ‘ç”Ÿæˆä¸€ä»½å®Œæ•´çš„ã€Œå†…æ ¸ + ç½‘å¡é©±åŠ¨ + ISOåˆ¶ä½œã€è‡ªåŠ¨åŒ–è„šæœ¬ç»™ä½ ï¼Ÿ

åŒ…å«è¿™äº›éƒ¨åˆ†ï¼š

- æ£€æŸ¥å½“å‰å†…æ ¸å’Œæ¨¡å—æ˜¯å¦å­˜åœ¨
- æ‹·è´ vmlinuz + initrd
- è‡ªåŠ¨æ³¨å…¥ Kickstart æ–‡ä»¶
- è‡ªåŠ¨ mkisofs æ‰“åŒ…

æˆ‘å¯ä»¥æŒ‰ä½ å½“å‰ç³»ç»Ÿç»“æ„å’Œç›®æ ‡ä¸€é”®ç”Ÿæˆã€‚éœ€è¦è¯·ç›´æ¥è¯´â€œç”Ÿæˆâ€ã€‚









### æ­¥éª¤ 1ï¼šå®‰è£…å¿…è¦å·¥å…·

```
bash


CopyEdit
yum install -y genisoimage isomd5sum syslinux
```

------

### ğŸ“ æ­¥éª¤ 2ï¼šæŒ‚è½½åŸå§‹ ISO å¹¶æ‹·è´å†…å®¹

```
bashCopyEditmkdir -p /mnt/iso
mount -o loop CentOS-7-x86_64-Minimal.iso /mnt/iso

mkdir -p /tmp/iso_build
cp -r /mnt/iso/* /tmp/iso_build/
umount /mnt/iso
```

------

### ğŸ“¥ æ­¥éª¤ 3ï¼šå°† `ks.cfg` æ”¾å…¥æ ¹ç›®å½•

```
bash


CopyEdit
cp ks.cfg /tmp/iso_build/
```

ä½ å¯ä»¥ç”¨ä¸‹é¢å‘½ä»¤éªŒè¯ï¼š

```
bash


CopyEdit
ls /tmp/iso_build/ks.cfg
```





**å®Œæ•´ç”Ÿæˆ initrd.imgï¼š**

```
dracut -f /root/initrd-5.15.154.img 5.15.154-1.el7.x86_64
```

**å¤åˆ¶ vmlinuz å’Œ initrd.imgï¼š**

```
cp /boot/vmlinuz-5.15.154-1.el7.x86_64 /root/custom_iso/isolinux/vmlinuz
cp /root/initrd-5.15.154.img /root/custom_iso/isolinux/initrd.img
```



ç„¶ååœ¨/root/custom_isoä¸‹



/root/custom_iso/

â”œâ”€â”€ menu.sh

â”œâ”€â”€ ks.cfg              â† æ”¾åœ¨æ ¹ç›®å½• âœ…
â”œâ”€â”€ isolinux/
â”‚   â”œâ”€â”€ isolinux.cfg    â† é…ç½®ä¸­éœ€åŠ  ks=cdrom:/ks.cfg
â”‚   â”œâ”€â”€ vmlinuz
â”‚   â””â”€â”€ initrd.img



ç„¶åks.cfg

```ini
[root@localhost custom_iso]# cat ks.cfg 
#platform=x86, AMD64, or Intel EM64T
#version=RHEL7
# Install instead of upgrade
install
# ä½¿ç”¨æœ¬åœ°å…‰ç›˜ä½œä¸ºå®‰è£…æº
cdrom
# è¯­è¨€å’Œé”®ç›˜å¸ƒå±€
lang zh_CN.UTF-8
keyboard us
# æ—¶åŒºå’Œæ—¶é—´åŒæ­¥
timezone Asia/Shanghai --utc
# ç¦ç”¨é¦–æ¬¡å¯åŠ¨é…ç½®å‘å¯¼
firstboot --disable
# ç¦ç”¨é˜²ç«å¢™å’ŒSELinuxï¼ˆæ ¹æ®éœ€è¦å¼€å¯ï¼‰
firewall --disabled
selinux --disabled
# ç¦ç”¨å›¾å½¢ç•Œé¢å®‰è£…ï¼Œä½¿ç”¨æ–‡æœ¬æ¨¡å¼å®‰è£…
text
# åŒæ„è®¸å¯è¯
eula --agreed
# å®‰è£…å®Œæˆåè‡ªåŠ¨é‡å¯
reboot

# ç½‘ç»œé…ç½®ï¼ˆå®‰è£…è¿‡ç¨‹å¦‚éœ€è”ç½‘ï¼Œå¯é…ç½®ä¸º DHCPï¼‰
network --bootproto=dhcp --device=eth0 --onboot=on

# ç¦ç”¨Rootç™»å½•ï¼ˆé”å®šrootè´¦æˆ·ï¼‰ï¼Œè®¾ç½®æ™®é€šç®¡ç†å‘˜ç”¨æˆ·
rootpw --lock:contentReference[oaicite:0]{index=0}
user --name=admin --password=<å·²åŠ å¯†çš„å¯†ç > --iscrypted --groups=wheel

# å¼•å¯¼åŠ è½½å™¨å®‰è£…é…ç½®
bootloader --location=mbr --append="crashkernel=auto rhgb quiet"
# ç£ç›˜åˆ†åŒºï¼ˆç¤ºä¾‹ä¸ºè‡ªåŠ¨åˆ†åŒºï¼‰
zerombr
clearpart --all --initlabel
autopart  # æˆ–æ ¹æ®éœ€æ±‚æ‰‹åŠ¨å®šä¹‰å„åˆ†åŒº

# è½¯ä»¶åŒ…é€‰æ‹©ï¼ˆæœ€å°å®‰è£…å¹¶åŒ…å«è‡ªå®šä¹‰å†…æ ¸å’Œé©±åŠ¨ï¼‰
%packages
@^minimal  # å®‰è£…æœ€å°ç¯å¢ƒç»„
# å®‰è£…5.xå†…æ ¸ï¼ˆkernel-mlï¼‰åŠæ‰€éœ€é©±åŠ¨å’Œå·¥å…·
kernel-ml
kmod-r8168           # Realtek r8168 ç½‘å¡é©±åŠ¨ï¼ˆElRepo æä¾›çš„ kmod åŒ…ï¼‰
kmod-igc             # Intel I225/I226 ç½‘å¡é©±åŠ¨
kmod-e1000e          # Intel åƒå…†ç½‘å¡é©±åŠ¨
# å¯é€‰ï¼šå…¶ä»–å¿…è¦çš„è½¯ä»¶åŒ…
# ... (ä¾‹å¦‚ network-scripts, net-tools ç­‰)
%end

%post --nochroot
# å°†ISOä¸­çš„menu.shæ‹·è´åˆ°å®‰è£…ç›®æ ‡ç³»ç»Ÿä¸­
cp /mnt/source/menu.sh /mnt/sysimage/usr/local/bin/menu.sh
chmod +x /mnt/sysimage/usr/local/bin/menu.sh
%end

# å®‰è£…åé…ç½®è„šæœ¬
%post
# ç¦ç”¨rootè¿œç¨‹ç™»å½•ï¼ˆSSHï¼‰
echo "PermitRootLogin no" >> /etc/ssh/sshd_config

# æ·»åŠ Realteké©±åŠ¨é»‘åå•ï¼Œé˜²æ­¢ç³»ç»Ÿè¯¯ç”¨å†…æ ¸è‡ªå¸¦çš„r8169é©±åŠ¨
echo "blacklist r8169" > /etc/modprobe.d/blacklist-realtek.conf:contentReference[oaicite:1]{index=1}

# è®¾ç½®TTY1è‡ªåŠ¨ç™»å½•æ™®é€šç”¨æˆ·å¹¶å¯åŠ¨èœå•ç•Œé¢
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat <<EOL > /etc/systemd/system/getty@tty1.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin admin --noclear %I \$TERM
EOL

# å‡è®¾å®šåˆ¶èœå•è„šæœ¬ä¸º /usr/local/bin/menu.shï¼Œè®¾ç½®ç™»å½•åè‡ªåŠ¨è¿è¡Œèœå•
echo "if [ \$(tty) == '/dev/tty1' ]; then /usr/local/bin/menu.sh; logout; fi" >> /home/admin/.bash_profile

%end

```







isolinux/isolinux.cfgé‡Œé¢å†™

```ini
append initrd=initrd.img inst.stage2=hd:LABEL=CentOS\x207\x20x86_64 ks=cdrom:/ks.cfg quiet
```



ç„¶åç”ŸæˆISO

```bash
mkisofs -o /root/CentOS7-auto.iso \
  -b isolinux/isolinux.bin -c isolinux/boot.cat \
  -no-emul-boot -boot-load-size 4 -boot-info-table \
  -R -J -v -T \
  -V "CentOS 7 x86_64" \
  /root/custom_iso/
```



æˆ‘è¿™æ•´ä¸ªæ“ä½œå“ªé‡Œæœ‰é—®é¢˜å—ï¼Ÿä¸ºä»€ä¹ˆæœ€ç»ˆç”Ÿæˆçš„ISOï¼Œæ˜¾ç¤ºè¿™æ ·





===========================================================================================================================

ç¯å¢ƒå‡†å¤‡

```bash
yum install -y createrepo genisoimage isomd5sum
mkdir -p /root/custom_iso
mount -o loop CentOS-7-x86_64-DVD-2009.iso /mnt
rsync -av /mnt/ /root/custom_iso/
umount /mnt
```







å®‰è£…å¿…è¦å·¥å…·

```bash
yum install -y wget vim git gcc make rpm-build kernel-devel dracut dialog syslinux mkisofs
```





æ›´æ–°å†…æ ¸5.15.145

```bash
wget https://dl.lamp.sh/kernel/el7/kernel-ml-5.15.145-1.el7.x86_64.rpm
wget https://dl.lamp.sh/kernel/el7/kernel-ml-devel-5.15.145-1.el7.x86_64.rpm
wget https://dl.lamp.sh/kernel/el7/kernel-ml-headers-5.15.145-1.el7.x86_64.rpm

yum localinstall -y ./kernel-ml-5.15.145-1.el7.x86_64.rpm kernel-ml-devel-5.15.145-1.el7.x86_64.rpm kernel-ml-headers-5.15.145-1.el7.x86_64.rpm

grub2-set-default 0

reboot
```





 å°†å†…æ ¸ RPM æ”¾å…¥ ISO

```bash
cp kernel-ml*.rpm /root/custom_iso/Packages/
cd /root/custom_iso
createrepo .
```



ä¿®æ”¹ Kickstart æ–‡ä»¶ `ks.cfg`

ç¡®ä¿ `%packages` éƒ¨åˆ†åŒ…å«ä½ çš„ 5.x å†…æ ¸åŒ…åï¼š

```
kickstartCopyEdit%packages
@core
kernel-ml
%end
```



å®‰è£…ç½‘å¡é©±åŠ¨

```bash
# å‡çº§gcc
[localhost@root ~/net-drives/r8168]# yum install -y centos-release-scl

# æ›´æ–°å›½å†…æºsclo

[centos-sclo-sclo]
name=CentOS-7 - SCLo sclo
baseurl=https://mirrors.aliyun.com/centos-vault/7.9.2009/sclo/x86_64/sclo/
#mirrorlist=http://mirrorlist.centos.org?arch=$basearch&release=7&repo=sclo-sclo
gpgcheck=0
enabled=1
#gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo


[centos-sclo-sclo-rh]
name=CentOS-7 - SCLo sclo rh
baseurl=https://mirrors.aliyun.com/centos-vault/7.9.2009/sclo/x86_64/rh/
#mirrorlist=http://mirrorlist.centos.org?arch=$basearch&release=7&repo=sclo-sclo
gpgcheck=0
enabled=1
#gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-SIG-SCLo

[localhost@root /etc/yum.repos.d]# yum makecache

# å®‰è£… Devtoolsetï¼ˆä¾‹å¦‚ devtoolset-9ï¼‰
yum install -y devtoolset-9-toolchain


#RTL èƒèŸ¹ç½‘å¡ï¼ˆRTL8125/8168 ç­‰ï¼‰

git clone https://github.com/mtorromeo/r8168.git
cd r8168
make clean
make
make install
depmod -a
modprobe r8168

# igc ç½‘å¡
[localhost@root ~/net-drives]# modprobe igc




# dracut --force --add-drivers "r8168 igc e1000e" /boot/initramfs-$(uname -r).img $(uname -r)
```





å½“å‰ks.cfg

```ini
#version=RHEL7
auth --enableshadow --passalgo=sha512
cdrom
text
firstboot --disable
#ignoredisk --only-use=sda
keyboard --vckeymap=us --xlayouts='us'
lang en_US.UTF-8
network --bootproto=dhcp --device=ens33 --onboot=on --ipv6=auto
network --hostname=localhost.localdomain

rootpw --iscrypted $6$R.u.xEBYQ7vkfEQn$e/Uy6zUhM8X.sqPlzoyqA1dBN5PLmMHGYY.UaXm.1bKnQ78zhnvqO9oh.WREziR6Gu0.X3HP5JCEgDqWUEbK31
user --name=mystical --password=$6$N9xPeWGfZJBzzv1S$V2BVq/bkTbsHwvQqtkb/mcNWaMxIK8wM2haLc1AUhERQKz./yir/7CNhHFCJFTZC/HoriNNkmh5BBMLkzvqZz/ --iscrypted --gecos="mystical"

services --disabled="chronyd"
timezone Asia/Shanghai --isUtc --nontp
bootloader --append=" crashkernel=auto" --location=mbr
autopart --type=lvm
clearpart --none --initlabel


%packages
@^minimal
@core
kexec-tools
kernel-ml
kernel-ml-devel
kernel-ml-headers
menu-tools
%end


#%post --log=/root/ks-post.log
#
## è®¾ç½®é»˜è®¤ä½¿ç”¨5.xå†…æ ¸ï¼ˆæŒ‰menuentryåŒ¹é…ï¼‰
#grub2-set-default "$(grep '^menuentry' /boot/grub2/grub.cfg | grep '5.15.145' | head -1 | cut -d\" -f2)"
#
#%end


## ç¦æ­¢ root åœ¨æ§åˆ¶å°ç™»å½•
#echo 'tty1' > /etc/securetty
#chmod 0000 /etc/securetty
#
## å¼ºåˆ¶ root ç™»å½•å¤±è´¥ï¼ˆå¯é€‰åŠ å›ºï¼‰
#echo "auth required pam_deny.so" >> /etc/pam.d/login
#
## å®‰è£…r8168å’Œigcé©±åŠ¨ï¼ˆå‡è®¾rpmäº‹å…ˆæ”¾å…¥ISOå¹¶åœ¨ %packages å·²åŒ…å«ï¼Œæˆ–æ”¾äºæŒ‚è½½è·¯å¾„ï¼‰
##rpm -ivh /run/install/repo/Packages/r8168-*.rpm || true
##rpm -ivh /run/install/repo/Packages/igc-*.rpm || true
##rpm -ivh /run/install/repo/Packages/e1000e-*.rpm || true
#
#%end

#%post --nochroot
## æ‹·è´èœå•è„šæœ¬åˆ°å®‰è£…ç›®æ ‡ç³»ç»Ÿ
#cp /mnt/source/menu.sh /mnt/sysimage/usr/local/bin/menu.sh
#chmod +x /mnt/sysimage/usr/local/bin/menu.sh
#%end
#
#%post
## ç¦ç”¨ root é€šè¿‡ SSH ç™»å½•
#echo "PermitRootLogin no" >> /etc/ssh/sshd_config
#
## é»‘åå• r8169 é˜²æ­¢ä¸ r8168 å†²çª
##echo "blacklist r8169" > /etc/modprobe.d/blacklist-realtek.conf
#
## åˆ›å»º admin ç”¨æˆ·å¹¶è®¾ç½®å¯†ç 
#useradd admin
#echo admin:admin | chpasswd
#
## è®¾ç½® TTY1 è‡ªåŠ¨ç™»å½• admin ç”¨æˆ·
#mkdir -p /etc/systemd/system/getty@tty1.service.d
#cat <<EOL > /etc/systemd/system/getty@tty1.service.d/autologin.conf
#[Service]
#ExecStart=
#ExecStart=-/sbin/agetty --autologin admin --noclear %I \$TERM
#EOL
#
## é…ç½®ç™»å½•åè‡ªåŠ¨è¿è¡Œèœå•è„šæœ¬
#mkdir -p /home/admin
#touch /home/admin/.bash_profile
#chown admin:admin /home/admin/.bash_profile
#echo "if [ \$(tty) == '/dev/tty1' ]; then /usr/local/bin/menu.sh; logout; fi" >> /home/admin/.bash_profile
#
#%end

#%post --nochroot
## æ‹·è´ menu.sh åˆ°ç›®æ ‡ç³»ç»Ÿä¸­çš„ /usr/local/bin/
#mkdir -p /mnt/sysimage/usr/local/bin
#echo "$(pwd) [DEBUG] Created /usr/local/bin" >> /tmp/debug.log
#cp /mnt/source/menu.sh /mnt/sysimage/usr/local/bin/menu.sh && echo "[DEBUG] Copied menu.sh" >> /tmp/debug.log
#chmod +x /mnt/sysimage/usr/local/bin/menu.sh
#%end

%post
# åˆ›å»º admin ç”¨æˆ·
useradd admin
echo admin:admin | chpasswd

# admin ç”¨æˆ·åŠ å…¥ wheel ç»„ï¼ˆCentOS ä¸­ wheel å¯ sudoï¼‰
usermod -aG wheel admin

# å…è®¸ admin å…å¯†ç  sudo ç‰¹å®šå‘½ä»¤ï¼ˆå¯è§†å®é™…éœ€æ±‚æ‰©å±•ï¼‰
cat <<EOF > /etc/sudoers.d/admin_nopasswd
admin ALL=(ALL) NOPASSWD: /usr/bin/nmcli, /usr/sbin/ifconfig, /usr/bin/yum, /usr/bin/systemctl, /usr/bin/localectl
EOF

chmod 440 /etc/sudoers.d/admin_nopasswd

# è®¾ç½®è‡ªåŠ¨ç™»å½•
mkdir -p /etc/systemd/system/getty@tty1.service.d
cat <<EOL > /etc/systemd/system/getty@tty1.service.d/autologin.conf
[Service]
ExecStart=
ExecStart=-/sbin/agetty --autologin admin --noclear %I \$TERM
EOL



# è®¾ç½®ç™»å½•åè‡ªåŠ¨è¿è¡Œèœå•ï¼ˆå®‰å…¨åˆ¤æ–­ï¼‰
mkdir -p /home/admin
cat <<EOF > /home/admin/.bash_profile
if [ -t 1 ] && [ "\$(tty)" == "/dev/tty1" ] && [ -x /usr/local/bin/menu.sh ]; then
  /usr/local/bin/menu.sh
  logout
fi
EOF

chown -R admin:admin /home/admin
%end

%addon com_redhat_kdump --enable --reserve-mb='auto'
%end

%anaconda
pwpolicy root --minlen=6 --minquality=1 --notstrict --nochanges --notempty
pwpolicy user --minlen=6 --minquality=1 --notstrict --nochanges --emptyok
pwpolicy luks --minlen=6 --minquality=1 --notstrict --nochanges --notempty
%end

reboot
```



menu.sh

```bash
[localhost@root ~]# cat rpmbuild/SOURCES/menu-tools-1.0/usr/local/bin/menu.sh 
#!/bin/bash

LANG_ZH=(
  "è¿›å…¥è®¾ç½®ç•Œé¢"
  "1. ç¡¬ä»¶ä¿¡æ¯"
  "2. ç½‘ç»œé…ç½®"
  "3. ç³»ç»Ÿè®¾ç½®"
  "4. ç¯å¢ƒç›‘æµ‹"
  "5. ç»ˆç«¯ç™»å½•"
  "6. åˆ‡æ¢è¯­è¨€ [ä¸­æ–‡/English]"
  "7. å·¥å…·å‡çº§"
  "0. è¿”å›ä¸»èœå•"
  "è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹ï¼š"
  "æ­£åœ¨è¿”å›ä¸»èœå•..."
  "æ— æ•ˆé€‰é¡¹ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚"
)

LANG_EN=(
  "Enter Settings Menu"
  "1. Hardware Info"
  "2. Network Settings"
  "3. System Settings"
  "4. Environment Monitor"
  "5. Terminal Login"
  "6. Switch Language [ä¸­æ–‡/English]"
  "7. Tool Upgrade"
  "0. Return to Main Menu"
  "Please select an option: "
  "Returning to main menu..."
  "Invalid option, please try again."
)

# é»˜è®¤è¯­è¨€ä¸ºä¸­æ–‡
CURRENT_LANG="ZH"

# è·å–å½“å‰ç»ˆç«¯ç±»å‹ï¼ˆç”¨äºæ¸…å±ï¼‰
TTY=$(tty)

# æ¸…å±å‡½æ•°
clear_screen() {
  clear
}

# å±•ç¤ºèœå•å‡½æ•°
show_menu() {
  local lang_prefix="LANG_${CURRENT_LANG}"
  clear_screen
  eval "local lines=(\"\${${lang_prefix}[@]}\")"
  for line in "${lines[@]:0:9}"; do
    echo "$line"
  done
}

# æ‰§è¡Œæ“ä½œ
handle_choice() {
  local lang_prefix="LANG_${CURRENT_LANG}"
  case "$1" in
    1)
      echo -e "\n---- ç¡¬ä»¶ä¿¡æ¯ ----"
      lscpu
      lsblk
      read -rp "æŒ‰ Enter è¿”å›èœå•..."
      ;;
    2)
      echo -e "\n---- ç½‘ç»œé…ç½® ----"
      ip addr show
      read -rp "æŒ‰ Enter è¿”å›èœå•..."
      ;;
    3)
      echo -e "\n---- ç³»ç»Ÿè®¾ç½® ----"
      hostnamectl
      timedatectl
      read -rp "æŒ‰ Enter è¿”å›èœå•..."
      ;;
    4)
      echo -e "\n---- ç¯å¢ƒç›‘æµ‹ ----"
      top -b -n 1 | head -n 15
      read -rp "æŒ‰ Enter è¿”å›èœå•..."
      ;;
    5)
      echo -e "\n---- åˆ‡æ¢åˆ°ç™»å½•ç»ˆç«¯ ----"
      chvt 2 || echo "åˆ‡æ¢å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨ Ctrl+Alt+F2"
      sleep 1
      ;;
    6)
      if [ "$CURRENT_LANG" = "ZH" ]; then
        CURRENT_LANG="EN"
      else
        CURRENT_LANG="ZH"
      fi
      ;;
    7)
      echo -e "\n---- å·¥å…·å‡çº§ ----"
      echo "æ­¤åŠŸèƒ½å¾…å®ç°ï¼ŒæŒ‰ Enter è¿”å›"
      read -r
      ;;
    0)
      eval "echo \${${lang_prefix}[9]}"
      sleep 1
      exit 0
      ;;
    *)
      eval "echo \${${lang_prefix}[10]}"
      sleep 1
      ;;
  esac
}

# ä¸»å¾ªç¯
while true; do
  show_menu
  eval "read -rp \"\${LANG_${CURRENT_LANG}[8]}\" choice"
  handle_choice "$choice"
done


```





men.shå°è£…rpmåŒ…

```bash
# å‡†å¤‡ç›®å½•ç»“æ„
mkdir -p ~/rpmbuild/{SPECS,SOURCES,BUILD,RPMS,SRPMS}

# è®¾ç½®ç¯å¢ƒå˜é‡ï¼š
echo '%_topdir %(echo $HOME)/rpmbuild' > ~/.rpmmacros

# å‡†å¤‡ menu.sh å’Œå®‰è£…è·¯å¾„
mkdir -p ~/rpmbuild/SOURCES/menu-tools-1.0/usr/local/bin
cp menu.sh ~/rpmbuild/SOURCES/menu-tools-1.0/usr/local/bin/menu.sh
chmod +x ~/rpmbuild/SOURCES/menu-tools-1.0/usr/local/bin/menu.sh

#æ‰“ tar åŒ…ä½œä¸ºæºç åŒ…ï¼š
cd ~/rpmbuild/SOURCES
tar -czvf menu-tools-1.0.tar.gz menu-tools-1.0

# å†™ .spec æ–‡ä»¶
=====================================================================
Name:           menu-tools
Version:        1.0
Release:        1%{?dist}
Summary:        Custom system menu script

License:        Public Domain
BuildArch:      noarch
BuildRoot:      %{_tmppath}/%{name}-buildroot
Source0:        menu-tools-1.0.tar.gz

%description
A simple system menu script installed to /usr/local/bin/menu.sh

%prep
%setup -q

%build
# Nothing to build

%install
mkdir -p %{buildroot}/usr/local/bin
cp -a usr/local/bin/menu.sh %{buildroot}/usr/local/bin/

%files
%defattr(-,root,root,-)
/usr/local/bin/menu.sh

%changelog
* Mon Jun 24 2025 You <you@example.com> - 1.0-1
- Initial RPM
======================================================================

#æ„å»º RPM
cd ~/rpmbuild/SPECS
rpmbuild -ba menu-tools.spec

# æˆåŠŸåä½ ä¼šåœ¨ï¼š
~/rpmbuild/RPMS/noarch/menu-tools-1.0-1.el7.noarch.rpm

# æ”¾å…¥ ISO çš„ Packages/ ä¸­
cp ~/rpmbuild/RPMS/noarch/menu-tools-*.rpm /path/to/custom_iso/Packages/

# ks.cfg çš„ %packages åŠ ä¸Šï¼š
menu-tools

cd ~/custom_iso
# createrepo -g repodata/cca56f3cffa18f1e52302dbfcf2f0250a94c8a37acd8347ed6317cb52c8369dc-comps.xml .
```



# 

```bash
```







### å°†r8168ç½‘å¡é©±åŠ¨æ”¾å…¥3.10ç‰ˆæœ¬å†…æ ¸

æˆåŠŸå®šåˆ¶initrd.img

```bash
# æ³¨æ„åœ¨initrd.imgçš„æ ¹ç›®å½•ä¸‹æ“ä½œ
mkdir -p lib/modules/3.10.0-1160.el7.x86_64/extra/
cp /lib/modules/5.15.145-1.el7.x86_64/kernel/drivers/net/ethernet/realtek/r8168.ko lib/modules/3.10.0-1160.el7.x86_64/extra/
chmod 644 lib/modules/3.10.0-1160.el7.x86_64/extra/r8168.ko

depmod -b . 3.10.0-1160.el7.x86_64

find . | cpio -o -H newc | xz -C crc32 -9 --check=crc32 > /root/final-initrd.img

# è¦†ç›–æ—§çš„initrd.img
cp /root/final-initrd.img custom_iso/isolinux/initrd.img

# é‡æ–°æ‰“åŒ…ISO
mkisofs -o CentOS7-5xKernel-Auto.iso   -b isolinux/isolinux.bin   -c isolinux/boot.cat   -no-emul-boot -boot-load-size 4 -boot-info-tableltorito-alt-boot   -e images/efiboot.img -no-emul-boot -joliet-long  custom_iso/
```





# é‡è¦

#### âœ… 1. è‡ªå·±æ‰“åŒ… `r8168-dkms.rpm`ï¼ˆæ¨èï¼‰

ä½¿ç”¨ DKMS æœºåˆ¶åˆ¶ä½œ RPMï¼Œéå¸¸é€‚åˆä½ çš„è‡ªåŠ¨åŒ–æµç¨‹ã€‚

- å®˜æ–¹ Realtek é©±åŠ¨ï¼šhttps://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-pci-express-software
- ä¸‹è½½æºç åå¯ä½¿ç”¨å¦‚ä¸‹ `spec` æ„å»ºï¼š

```
specCopyEditName:       r8168-dkms
Version:    8.053.00
Release:    1%{?dist}
Summary:    Realtek 8168 DKMS driver
License:    GPL
Source0:    r8168-%{version}.tar.bz2

BuildArch:  noarch
Requires:   dkms, gcc, make, elfutils-libelf-devel

%description
Realtek r8168 driver packaged for DKMS support.

%prep
%setup -q -n r8168-%{version}

%install
mkdir -p %{buildroot}/usr/src/r8168-%{version}
cp -a * %{buildroot}/usr/src/r8168-%{version}

%files
/usr/src/r8168-%{version}

%post
dkms add -m r8168 -v %{version}
dkms build -m r8168 -v %{version}
dkms install -m r8168 -v %{version}

%preun
dkms remove -m r8168 -v %{version} --all
```

ç„¶åæ‰“åŒ…å¹¶æ”¾å…¥ ISO ä½¿ç”¨ã€‚



ä¸‹é¢æ˜¯ä¸€æ­¥æ­¥åœ¨ CentOS/Rocky 7/8/9 ä¸Šæ‰“åŒ… `r8168-dkms.rpm` çš„å®Œæ•´æµç¨‹ï¼Œé€‚åˆä½ è‡ªåŠ¨åŒ–é›†æˆï¼š

------

### âœ… 1. å‡†å¤‡æ„å»ºç¯å¢ƒ

```
bash


CopyEdit
yum install -y rpm-build dkms gcc elfutils-libelf-devel kernel-devel make wget
```

------

### âœ… 2. ä¸‹è½½ Realtek å®˜æ–¹é©±åŠ¨æºç 

è¿›å…¥ Realtek å®˜ç½‘ä¸‹è½½é¡µé¢ï¼š

ğŸ“¥ https://www.realtek.com/en/component/zoo/category/network-interface-controllers-10-100-1000m-gigabit-ethernet-pci-express-software

ä¸‹è½½ `r8168-8.053.00.tar.bz2`ï¼ˆæˆ–ä½ æƒ³è¦çš„ç‰ˆæœ¬ï¼‰ã€‚

------

### âœ… 3. åˆ›å»ºæ„å»ºç›®å½•ç»“æ„

```
bashCopyEditmkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
cd ~/rpmbuild/SOURCES
cp /path/to/r8168-8.053.00.tar.bz2 .
```

------

### âœ… 4. åˆ›å»º DKMS æ”¯æŒæ–‡ä»¶ç»“æ„

è§£å‹æºç å¹¶æ·»åŠ  `dkms.conf`ï¼š

```
bashCopyEdittar xf r8168-8.053.00.tar.bz2
cd r8168-8.053.00

cat > dkms.conf <<EOF
PACKAGE_NAME="r8168"
PACKAGE_VERSION="8.053.00"
CLEAN="make clean"
MAKE="make all"
BUILT_MODULE_NAME[0]="r8168"
DEST_MODULE_LOCATION[0]="/updates"
AUTOINSTALL="yes"
EOF

tar czf r8168-8.053.00-dkms.tar.gz *
mv r8168-8.053.00-dkms.tar.gz ~/rpmbuild/SOURCES/
```

------

### âœ… 5. ç¼–å†™ RPM SPEC æ–‡ä»¶

åˆ›å»º `~/rpmbuild/SPECS/r8168-dkms.spec`ï¼š

```
specCopyEditName:           r8168-dkms
Version:        8.053.00
Release:        1%{?dist}
Summary:        Realtek r8168 DKMS driver

License:        GPL
URL:            https://www.realtek.com
Source0:        %{name}-%{version}-dkms.tar.gz

BuildArch:      noarch
Requires:       dkms, make, gcc, elfutils-libelf-devel

%description
Realtek r8168 DKMS driver for automatic kernel support.

%prep
mkdir -p %{name}-%{version}
cd %{name}-%{version}
tar xzf %{SOURCE0}

%build
# No build step needed

%install
mkdir -p %{buildroot}/usr/src/r8168-%{version}
cp -a * %{buildroot}/usr/src/r8168-%{version}/

%files
%defattr(-,root,root,-)
/usr/src/r8168-%{version}

%changelog
* Wed Jun 25 2025 You <you@example.com> - 8.053.00-1
- Initial DKMS release
```

------

### âœ… 6. ç¼–è¯‘ RPM åŒ…

```
bash


CopyEdit
rpmbuild -ba ~/rpmbuild/SPECS/r8168-dkms.spec
```

ç”Ÿæˆçš„ RPM ä¼šåœ¨ï¼š

```
bash


CopyEdit
~/rpmbuild/RPMS/noarch/r8168-dkms-8.053.00-1.el7.noarch.rpm
```

------

### âœ… 7. å®‰è£…å¹¶æµ‹è¯•

```
bashCopyEdityum install -y ~/rpmbuild/RPMS/noarch/r8168-dkms-*.rpm
dkms install r8168/8.053.00
```

ä½ ä¹Ÿå¯ä»¥æŠŠ `.rpm` åŒ…é¢„ç½®åˆ° `%packages` è‡ªåŠ¨å®‰è£…åˆ—è¡¨ä¸­ï¼Œåœ¨ `%post` é˜¶æ®µå†™ï¼š

```
bashCopyEditdkms install r8168/8.053.00
dracut -f
```

------

å¦‚éœ€æˆ‘å¸®ä½ ç”Ÿæˆè¿™ä¸ª `spec` å’Œæ„å»ºè„šæœ¬ï¼Œå¯ç»§ç»­è¯´ï¼Œæˆ‘å¯ä»¥æ‰“åŒ…æˆå®Œæ•´æ–‡ä»¶ç»™ä½ ã€‚





##### You said:

è¿™ä¸ªdksmåŒ…å¯ä»¥è‡ªåŠ¨è¯†åˆ«å¹¶å®‰è£…å½“å‰æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬çš„é©±åŠ¨æ˜¯å—



###### ChatGPT said:

æ˜¯çš„ï¼Œ**ä½¿ç”¨ `r8168-dkms.rpm` åŒ…çš„æœ€å¤§ä¼˜åŠ¿ä¹‹ä¸€**å°±æ˜¯ï¼š

------

### âœ… **å®ƒèƒ½è‡ªåŠ¨ä¸ºç³»ç»Ÿä¸­ \*æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬\* æ„å»ºé©±åŠ¨æ¨¡å—**ï¼

å…·ä½“æ¥è¯´ï¼š

#### ğŸ¯ å½“ä½ å®‰è£… `r8168-dkms.rpm` åï¼Œå®ƒä¼šè‡ªåŠ¨ï¼š

1. æ£€æµ‹å½“å‰ç³»ç»Ÿå®‰è£…çš„æ‰€æœ‰å†…æ ¸ç‰ˆæœ¬ï¼ˆåŒ…æ‹¬æ—§çš„ã€åˆšå‡çº§è¿˜æ²¡é‡å¯çš„ï¼‰ï¼›
2. ä¸ºæ¯ä¸ªå†…æ ¸ç‰ˆæœ¬æ‰§è¡Œä¸€æ¬¡ `dkms build` å’Œ `dkms install`ï¼›
3. å°† `r8168.ko` å®‰è£…åˆ°æ¯ä¸ªå†…æ ¸çš„ `/lib/modules/<kernel-version>/updates/`ï¼›
4. è‡ªåŠ¨è¿è¡Œ `depmod -a` è®©å†…æ ¸è¯†åˆ«æ–°æ¨¡å—ï¼›
5. ï¼ˆä½ å¯é€‰ï¼‰åœ¨ `%post` é˜¶æ®µæ‰‹åŠ¨è¿è¡Œ `dracut -f`ï¼Œç¡®ä¿æ–°å†…æ ¸ initramfs ä¸­åŒ…å« `r8168.ko`ï¼Œå¼•å¯¼æ—¶å³å¯è¯†åˆ«ã€‚

------

### âœ… å®ƒè¿˜èƒ½åœ¨ **æœªæ¥æ–°å†…æ ¸å®‰è£…åè‡ªåŠ¨é‡ç¼–è¯‘**

å³ä½¿ä½ ä¹‹åé€šè¿‡ï¼š

```
bash


CopyEdit
yum install kernel-ml
```

å®‰è£…äº†æ–°å†…æ ¸ï¼Œåªè¦é‡å¯è¿›å…¥æ–°å†…æ ¸ï¼Œ`dkms` ä¼šè‡ªåŠ¨æ¢æµ‹ï¼Œå¹¶ä¸ºæ–°å†…æ ¸é‡æ–°æ„å»º `r8168.ko`ï¼Œä¸éœ€è¦ä½ æ‰‹åŠ¨å¹²é¢„ï¼

------

### ğŸ”§ ç¤ºä¾‹ï¼šæŸ¥çœ‹ DKMS çŠ¶æ€

```
bash


CopyEdit
dkms status
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
yamlCopyEditr8168, 8.053.00, 5.15.150-1.el7.elrepo.x86_64, x86_64: installed
r8168, 8.053.00, 3.10.0-1160.el7.x86_64, x86_64: installed
```

------

### âœ… ç»“è®º

åªè¦ä½ çš„ `r8168-dkms.rpm` æ˜¯æŒ‰å‰é¢æ­¥éª¤æ­£ç¡®åˆ¶ä½œçš„ï¼Œå®ƒå°±èƒ½**ä¸€æ¬¡æ„å»ºã€å¤šå†…æ ¸é€šç”¨ï¼Œæœªæ¥è‡ªåŠ¨é€‚é…æ–°å†…æ ¸**ï¼Œæ˜¯è‡ªåŠ¨åŒ–åœºæ™¯ä¸­é¦–é€‰ã€‚

å¦‚ä½ éœ€è¦ï¼Œæˆ‘å¯ä»¥ç»§ç»­ä¸ºä½ ç”Ÿæˆ RPM çš„æ‰“åŒ…è„šæœ¬ï¼Œä¾¿äºä½ ä¸€é”®é›†æˆã€‚













# å…¨CentOS7.9è‡ªåŠ¨å®‰è£…ä¸­æ–‡æ”¯æŒISOæ‰“åŒ…æµç¨‹



## menu_zh.shè„šæœ¬

```bash
[localhost@root ~]# cat menu_zh.sh 
#!/bin/bash
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8

# é¢œè‰²å®šä¹‰
RED='\e[31m'
GREEN='\e[32m'
YELLOW='\e[33m'
BLUE='\e[34m'
NC='\e[0m' # æ— é¢œè‰²

# ç³»ç»Ÿä¿¡æ¯
IP=$(hostname -I | awk '{print $1}')
TIME=$(date '+%Y-%m-%d %H:%M:%S')
SERIAL=$(cat /etc/machine-id 2>/dev/null || echo æœªçŸ¥)

# å·¥å…·ç‰ˆæœ¬ä¿¡æ¯
TOOL_VERSION="1.0.2"
SYSTEM_VERSION="Pedge-1.0.8-debian"

# æ¬¢è¿ç•Œé¢
function show_welcome() {
  clear
  echo -e "${BLUE}------------------------------------------------------------${NC}"
  echo -e "${YELLOW} å·¥å…·ç‰ˆæœ¬       :${NC} ${TOOL_VERSION}"
  echo -e "${YELLOW} å½“å‰æ—¶é—´       :${NC} ${TIME}"
  echo -e "${YELLOW} ç³»ç»Ÿç‰ˆæœ¬       :${NC} ${SYSTEM_VERSION}"
  echo -e "${YELLOW} èŠ‚ç‚¹ID         :${NC} ${SERIAL}"
  echo -e "${YELLOW} ç½‘ç»œçŠ¶æ€       :${NC} å·²è¿æ¥"
  echo -e "${YELLOW} IPåœ°å€         :${NC} ${IP}"
  echo -e "${YELLOW} åˆå§‹åŒ–çŠ¶æ€     :${NC} æ­£åœ¨æ£€æŸ¥..."
  echo -e "${BLUE}------------------------------------------------------------${NC}"
  echo -e "${GREEN} è¯·æŒ‰ä¸‹ ENTER é”®ç»§ç»­...${NC}"

  while true; do
    read -s -n1 key
    if [[ "$key" == "" ]]; then
      break
    fi
  done
}

# å‡½æ•°ï¼šé…ç½®ç½‘ç»œ
function config_network() {
    interfaces=($(nmcli device status | awk '$2 == "ethernet" {print $1}'))
    echo
    echo "å¯é…ç½®çš„ç½‘å¡:"
    for i in "${!interfaces[@]}"; do
        echo "$i: ${interfaces[$i]}"
    done

    read -p "è¯·è¾“å…¥ç½‘å¡ç¼–å·: " idx
    dev=${interfaces[$idx]}
    [ -z "$dev" ] && echo "æ— æ•ˆé€‰æ‹©" && read -n1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..." && return

    echo "è¯·é€‰æ‹©IPé…ç½®æ–¹å¼: 1. é™æ€ 2. åŠ¨æ€ï¼ˆDHCPï¼‰"
    read -p "è¯·è¾“å…¥åºå·: " mode

    # æ¸…é™¤æ—§è¿æ¥
    nmcli connection delete "$dev" &>/dev/null

    if [[ "$mode" == "1" ]]; then
        read -p "è¯·è¾“å…¥é™æ€IPåœ°å€: " ip
        read -p "è¯·è¾“å…¥å­ç½‘æ©ç ï¼ˆå¦‚ 255.255.255.0ï¼‰: " mask
        read -p "è¯·è¾“å…¥ç½‘å…³åœ°å€: " gateway
        read -p "è¯·è¾“å…¥DNSåœ°å€: " dns
        nmcli connection add type ethernet ifname "$dev" con-name "$dev" ipv4.method manual \
            ipv4.addresses "$ip/24" ipv4.gateway "$gateway" ipv4.dns "$dns" autoconnect yes
    else
        nmcli connection add type ethernet ifname "$dev" con-name "$dev" ipv4.method auto autoconnect yes
    fi

    nmcli connection up "$dev"
    echo "âœ… ç½‘å¡ $dev é…ç½®å®Œæˆ"
    read -n1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}

# å‡½æ•°ï¼šç½‘ç»œæ£€æµ‹
function network_check() {
    interfaces=($(nmcli device status | awk '$2 == "ethernet" {print $1}'))
    echo "å¯ç”¨ç½‘å¡:"
    for i in "${!interfaces[@]}"; do
        echo "$i: ${interfaces[$i]}"
    done
    read -p "è¯·è¾“å…¥ç½‘å¡ç¼–å·: " idx
    dev=${interfaces[$idx]}
    read -p "è¯·è¾“å…¥æµ‹è¯•ç›®æ ‡åœ°å€ï¼ˆé»˜è®¤ qq.comï¼‰: " target
    target=${target:-qq.com}
    echo "ä½¿ç”¨ $dev è¿›è¡Œæµ‹è¯•..."
    ping -I "$dev" -c 5 "$target"
    read -n1 -s -r -p "æŒ‰ä»»æ„é”®è¿”å›..."
}



# èœå•ç•Œé¢
function show_menu() {
  while true; do
    clear
    echo -e "${BLUE}===================== è®¾ç½®èœå• =====================${NC}"
    echo -e "${GREEN}1.${NC} æŸ¥çœ‹ç¡¬ä»¶ä¿¡æ¯"
    echo -e "${GREEN}2.${NC} ç½‘ç»œæŸ¥çœ‹"
    echo -e "${GREEN}3.${NC} ç½‘ç»œé…ç½®"
    echo -e "${GREEN}4.${NC} ç½‘ç»œæµ‹è¯•"
    echo -e "${GREEN}5.${NC} ç™»å½•ç»ˆç«¯"
    echo -e "${GREEN}0.${NC} è¿”å›ä¸»ç•Œé¢"
    echo -e "${BLUE}====================================================${NC}"
    echo -ne "${YELLOW}è¯·è¾“å…¥é€‰é¡¹ [0-5]: ${NC}"
    read choice
    case "$choice" in
      1)
        clear
        echo -e "${BLUE}---- CPU / å†…å­˜ / ç£ç›˜ä¿¡æ¯ ----${NC}"
        lscpu | grep -E 'Model name|CPU\(s\)|Thread|Core|Socket'
        echo
        free -h
        echo
        lsblk
        echo
        read -rp "æŒ‰ä¸‹ ENTER é”®è¿”å›èœå•..."
        ;;
      2)
        clear
        echo -e "${BLUE}---- ç½‘ç»œæŸ¥çœ‹ ----${NC}"
        ip a 
        echo
        read -rp "æŒ‰ä¸‹ ENTER é”®è¿”å›èœå•..."
        ;;
      3)
        clear
        echo -e "${BLUE}---- ç½‘ç»œé…ç½® ----${NC}"
        config_network
        echo
        read -rp "æŒ‰ä¸‹ ENTER é”®è¿”å›èœå•..."
        ;;
      4)
        clear
        echo -e "${BLUE}---- ç½‘ç»œé…ç½® ----${NC}"
        network_check
        echo
        read -rp "æŒ‰ä¸‹ ENTER é”®è¿”å›èœå•..."
        ;;
      5)
        clear
        exit || {
          echo -e "${RED}åˆ‡æ¢ç”¨æˆ·å¤±è´¥ã€‚è¯·ç¡®è®¤ç”¨æˆ· tikact å­˜åœ¨å¹¶å…·æœ‰åˆæ³•çš„ shell æƒé™ã€‚${NC}"
          read -rp "æŒ‰ä¸‹ ENTER é”®è¿”å›èœå•..."
        }
        ;;
      0)
        return
        ;;
      *)
        echo -e "${RED}æ— æ•ˆè¾“å…¥ï¼Œè¯·é‡è¯•...${NC}"
        sleep 1
        ;;
    esac
  done
}

# ä¸»å¾ªç¯
while true; do
  show_welcome
  show_menu
done
```



## æ‰“åŒ…fbterm

### ç¼–è¯‘fbtermå¹¶ä¿®æ”¹é…ç½®



### æ‰“åŒ…æˆRPMåŒ…

```bash
mkdir fbterm-bundle-1.0
cp fbterm fbterm-bundle-1.0/
cp .fbtermrc fbterm-bundle-1.0/
cp msyh.ttc fbterm-bundle-1.0/           # msyh.ttcè¿™ä¸ªå­—ä½“å¯ä»¥ä»windowså¤åˆ¶
tar -czvf fbterm-bundle-1.0.tar.gz fbterm-bundle-1.0
mv fbterm-bundle-1.0.tar.gz ~/rpmbuild/SOURCES/
```

### fbterm.spec

```ini
Name:           fbterm
Version:        1.0
Release:        1%{?dist}
Summary:        Framebuffer terminal with built-in font and config

License:        Custom
URL:            https://your.domain.local/fbterm
Source0:        fbterm-bundle-%{version}.tar.gz

BuildArch:      noarch
Requires:       fontconfig, freetype

%description
Precompiled fbterm with a bundled Chinese font and preconfigured .fbtermrc.
Includes msyh.ttc for Chinese display.

%prep
%setup -q -n fbterm-bundle-%{version}

%build
# Nothing to build

%install
install -Dm755 fbterm %{buildroot}/usr/bin/fbterm
install -Dm644 .fbtermrc %{buildroot}/etc/skel/.fbtermrc
install -Dm644 msyh.ttc %{buildroot}/usr/share/fonts/msyh/msyh.ttc

%post
# æ³¨å†Œå­—ä½“ç¼“å­˜
if [ -x /usr/bin/fc-cache ]; then
    fc-cache -f
fi

%files
%doc
/usr/bin/fbterm
/etc/skel/.fbtermrc
/usr/share/fonts/msyh/msyh.ttc

%changelog
* Wed Jun 25 2025 Zhang Yifeng <you@example.com> - 1.0-1
- First precompiled fbterm bundle with font and config

```















# å¼•å¯¼ä¸ç³»ç»Ÿç®¡ç†å®ˆæŠ¤è¿›ç¨‹



## æ•´ä¸ªè¿‡ç¨‹ä¸€èˆ¬æ€§æ¦‚è§ˆ

ä»NVRAMä¸­è£…è½½BIOS/UEFI   ---->  æ¢æµ‹ç¡¬ä»¶ ---->  é€‰æ‹©å¼•å¯¼è®¾å¤‡ï¼ˆç£ç›˜ï¼Œç½‘ç»œ ...ï¼‰----> è£…è½½å†…æ ¸ ----> ç¡®å®šå¼•å¯¼å“ªä¸ªå†…æ ¸  ---->  è½½å…¥å¼•å¯¼è£…è½½ç¨‹åºï¼ˆå¦‚Grubï¼‰

----->  è¯†åˆ«EFIç³»ç»Ÿåˆ†åŒº  ---->  å®ä¾‹åŒ– å†…æ ¸æ•°æ®ç»“æ„  ----> å¯åŠ¨ init / systemd  ----->  æ‰§è¡Œå¯åŠ¨è„šæœ¬







```bash
# åˆ†åŒºè¡¨ä¿¡æ¯
fdisk -l /dev/sda

# è¿™äº›ä¸ºGPTåˆ†åŒºè¡¨ä¿¡æ¯
Device       Start       End   Sectors  Size Type
/dev/sda1     2048      4095      2048    1M BIOS boot
/dev/sda2     4096   4198399   4194304    2G Linux filesystem
/dev/sda3  4198400 419428351 415229952  198G Linux filesystem

# MBRåˆ†åŒºè¡¨ä¿¡æ¯
Device     Boot   Start       End   Sectors  Size Id Type
/dev/sda1  *       2048   2099199   2097152    1G 83 Linux
/dev/sda2       2099200 419430399 417331200  199G 8e Linux LVM
# *ï¼ˆæ˜Ÿå·ï¼‰è¡¨ç¤ºè¯¥åˆ†åŒºä¸ºæ´»åŠ¨åˆ†åŒºï¼Œåˆ†åŒºä¿¡æ¯ç¬¬ä¸€å­—èŠ‚ä¸º80
```



> 









![image-20250627105142959](D:\git_repository\cyber_security_learning\markdown_img\image-20250627105142959.png)





## BIOS/UEFI é˜¶æ®µ

![image-20250627104737233](D:\git_repository\cyber_security_learning\markdown_img\image-20250627104737233.png)

**BIOS/UEFI é˜¶æ®µ**

| æ­¥éª¤                            | æè¿°                                                         |
| ------------------------------- | ------------------------------------------------------------ |
| BIOS/UEFI åˆå§‹åŒ–                | ä» NVRAM ä¸­åŠ è½½è®¾ç½®ï¼Œæ‰§è¡Œ POSTï¼ˆPower-On Self Testï¼‰æ£€æµ‹ CPUã€å†…å­˜ã€å¤–è®¾ç­‰ |
| æ£€æµ‹å¼•å¯¼è®¾å¤‡                    | æŸ¥æ‰¾å¯åŠ¨é¡ºåºï¼ˆç¡¬ç›˜ã€USBã€PXE ç­‰ï¼‰å¹¶é€‰æ‹©ä¸€ä¸ª                  |
| **æ‰§è¡Œå¯åŠ¨è®¾å¤‡çš„é¦–æ‰‡åŒºï¼ˆMBRï¼‰** | åŠ è½½ç¬¬ 0 æ‰‡åŒºçš„ bootloaderï¼ˆå¦‚ GRUB çš„ Stage1ï¼‰              |







## GRUBé˜¶æ®µ

![image-20250627103543465](D:\git_repository\cyber_security_learning\markdown_img\image-20250627103543465.png)

â€‹	



### Stage1ï¼ˆåŠ è½½ Stage1.5çš„core.imgåˆ°å†…å­˜ï¼‰

**Stage 1ï¼ˆä½äºç£ç›˜ç¬¬0æ‰‡åŒºçš„ bootloaderï¼‰**

| å†…å®¹              | è¯´æ˜                                                         |
| ----------------- | ------------------------------------------------------------ |
| bootloader stage1 | ä½“ç§¯æå°ï¼ˆ< 512å­—èŠ‚ï¼‰ï¼Œåªèƒ½åšä¸€ä»¶äº‹ï¼š**åŠ è½½ Stage1.5** æˆ– **ç›´æ¥è·³è½¬ Stage2** |
| æ‰¾ä¸åˆ° stage1.5ï¼Ÿ | åˆ™å¿…é¡»å°† GRUB çš„ Stage2 å®‰è£…åœ¨ BIOS å¯ç›´æ¥è¯»åˆ°çš„ä½ç½®ï¼ˆæ¯”å¦‚ `/boot` åˆ†åŒºçš„èµ·å§‹å¤„ï¼‰â€”â€” è¿™å°±æ˜¯æ—©æœŸç³»ç»Ÿçš„ä¸ä¾¿ä¹‹å¤„ |





### Stage1.5ï¼ˆåŠ è½½Stage2çš„/boot/grub2ï¼‰

Stage1 ä»£ç çŸ¥é“ **core.img** çš„èµ·å§‹æ‰‡åŒºä½ç½®ï¼ˆåœ¨å®‰è£… grub2 æ—¶å†™å…¥ï¼‰

```bash
 
```

> grubç›¸å…³å‘½ä»¤
>
> ```bash
> # æŠŠ GRUB å¼•å¯¼å™¨â€œè£…åˆ°å¯è¢«å›ºä»¶å¯åŠ¨çš„åœ°æ–¹â€ï¼Œå¹¶è®©å®ƒçŸ¥é“å»å“ªæ‰¾ /boot/grub ä¸ grub.cfgã€‚ä¸è´Ÿè´£ç”Ÿæˆ grub.cfgï¼ˆé‚£æ˜¯ update-grub/grub-mkconfig å¹²çš„äº‹ï¼‰
> [root@ubuntu2204 i386-pc]# grub-install
> ```
>
> åœ¨ **BIOS/MBR** æ¨¡å¼
>
> - æŠŠ **boot.img** å†™å…¥ç›®æ ‡ç£ç›˜çš„ **MBR**ï¼ˆ`/dev/sda` ä¹‹ç±»ï¼‰ã€‚
> - ç”Ÿæˆ/åµŒå…¥ **core.img**ï¼ˆå¸¦æœ€å°ç£ç›˜/åˆ†åŒº/æ–‡ä»¶ç³»ç»Ÿæ¨¡å—ã€ä»¥åŠæŒ‡å‘ `/boot/grub` çš„ **prefix**ï¼‰åˆ°ï¼š
>   - **MBR ä¸ç¬¬ä¸€ä¸ªåˆ†åŒºä¹‹é—´çš„ç©ºéš™**ï¼ˆpost-MBR gapï¼‰ï¼Œæˆ–
>   - **BIOS Boot åˆ†åŒº**ï¼ˆGPT ä¸Šå¿…é¡»æœ‰ä¸€ä¸ª 1â€“2MBã€ç±»å‹ `EF02` çš„å°åˆ†åŒºï¼‰ã€‚
> - å¾€ `/boot/grub/i386-pc/` å®‰è£…æ‰€éœ€çš„ **æ¨¡å—**ï¼ˆ`normal.mod` ç­‰ï¼‰ã€‚
>
> > ç»“æœï¼šBIOSâ†’MBR çš„ boot.imgâ†’core.imgâ†’åŠ è½½ `normal.mod`â†’è¯» `/boot/grub/grub.cfg`ã€‚





åœ¨MBRåç»­çš„æ‰‡åŒºä¸­ï¼ˆ<span style="color:red">1æ‰‡åŒºåˆ°2047æ‰‡åŒºï¼Œä¹Ÿå°±æ˜¯ å­˜åœ¨äºMBRå’Œç¬¬ä¸€ä¸ªåˆ†åŒºä¹‹é—´çš„ç©ºé—´</span>ï¼‰ï¼ŒStage 1.5 åŒ…å«äº†ä¸€äº›æ–‡ä»¶ç³»ç»Ÿçš„é©±åŠ¨ï¼Œè¿™å…è®¸å®ƒèƒ½å¤Ÿè¯»å–ä½äºä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸Šçš„ /boot åˆ†åŒº,å¯åŠ¨å…¶ä¸­çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶è¿›å…¥stage2

- åœ¨CentOS6ä¸­ï¼Œå®ƒä¼šå¯åŠ¨é…ç½®æ–‡ä»¶`/boot/grub/grub.conf`,
- åœ¨CentOS7ä»¥ä¸Šç‰ˆæœ¬ï¼Œå®ƒä¼šå¯åŠ¨é…ç½®æ–‡ä»¶`/boot/grub2/grub.cfg`
- åœ¨Ubuntuä¸­ï¼Œå¯åŠ¨é…ç½®æ–‡ä»¶æ˜¯`/boot/grub/grub.cfg`



- **ä½ç½®**ï¼šMBR å’Œç¬¬ä¸€ä¸ªåˆ†åŒºä¹‹é—´çš„ç©ºé—²æ‰‡åŒºï¼ˆç¬¬1~2047æ‰‡åŒºä¹‹é—´ï¼‰
- **ä½œç”¨**ï¼š
  - æä¾›æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼ˆext4ã€xfsã€btrfs ç­‰ï¼‰
  - èƒ½è¯»å–ç£ç›˜ä¸Šçš„ `/boot` åˆ†åŒº
  - ä» `/boot/grub2/` ä¸­åŠ è½½ grub.cfg å’Œ modules
  - ç„¶åå¯åŠ¨ Stage 2



### Stage2ï¼ˆgrub.cfg + GRUB æ¨¡å—ç³»ç»Ÿï¼‰

**ä½ç½®**ï¼š`/boot/grub2/`

**ä½œç”¨**ï¼š

- è¯»å– `grub.cfg`
- å±•ç¤ºèœå•ã€æ¥æ”¶é”®ç›˜è¾“å…¥
- é€‰æ‹©è¦å¯åŠ¨çš„å†…æ ¸ï¼ˆLinux æˆ–å…¶ä»–ç³»ç»Ÿï¼‰
- åŠ è½½ kernel å’Œ initrdï¼Œè·³è½¬æ‰§è¡Œ



![image-20250627180706630](D:\git_repository\cyber_security_learning\markdown_img\image-20250627180706630.png)

![image-20250829100324612](../../markdown_img/image-20250829100324612.png)



#### é˜¶æ®µä¸€ï¼šGRUB Stage2 å¤„ç†æµç¨‹

ğŸ”¹ 1. **è¯»å– `/boot/grub2/grub.cfg`**

- `core.img` åŠ è½½åä¼šæ‰§è¡Œ Stage2ï¼ŒStage2 å°±æ˜¯ GRUB ä¸»ç¨‹åºã€‚
- GRUB ä¼šæŒ‚è½½å¹¶è¯»å– `/boot/grub2/grub.cfg` æ–‡ä»¶ã€‚
- è¯¥æ–‡ä»¶ä¸­å®šä¹‰äº†å¯åŠ¨èœå•é¡¹ã€é»˜è®¤è¶…æ—¶æ—¶é—´ã€æ¯é¡¹çš„ `linux`ã€`initrd` å‚æ•°ç­‰ï¼š

```ini
menuentry 'CentOS Linux (5.15.0)' {
    linux16 /vmlinuz-5.15.0 root=/dev/sda2 ro quiet
    initrd16 /initramfs-5.15.0.img
}
```

ğŸ”¹ 2. **å±•ç¤ºèœå• / ç­‰å¾…é€‰æ‹©**

- GRUB å±•ç¤ºå¯åŠ¨èœå•ï¼Œå¯ä»¥æ‰‹åŠ¨é€‰æ‹©æˆ–è¶…æ—¶è‡ªåŠ¨é€‰æ‹©é»˜è®¤é¡¹ã€‚

ğŸ”¹ 3. **åŠ è½½ vmlinuz å†…æ ¸æ–‡ä»¶**

- GRUB è¯»å–å¹¶åŠ è½½ `/boot/vmlinuz-5.15.0` åˆ°å†…å­˜ä¸­ã€‚
  - è¿™æ˜¯ **å·²å‹ç¼©çš„ Linux å†…æ ¸é•œåƒ**ã€‚
  - åŠ è½½ç‚¹é€šå¸¸æ˜¯ 1MB æˆ– 16MB åœ°å€ã€‚

ğŸ”¹ 4. **åŠ è½½ initrd/initramfsï¼ˆä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿï¼‰**

- GRUB å†åŠ è½½ `/boot/initramfs-5.15.0.img` åˆ°å†…å­˜ä¸­ã€‚
  - å®ƒæ˜¯ä¸€ä¸ªå‹ç¼©çš„ CPIO æ–‡ä»¶ç³»ç»Ÿï¼ˆç”¨äºæŒ‚è½½ä¹‹å‰çš„ä¸´æ—¶æ ¹ç›®å½•ï¼‰ã€‚
  - åŒ…å«å¾ˆå¤š early stage å·¥å…·ï¼ˆudevã€lvmã€dracutã€mountã€shã€busyboxã€fs drivers...ï¼‰



#### é˜¶æ®µäºŒï¼šå¯åŠ¨å†…æ ¸ + ä¸´æ—¶æ ¹ç³»ç»Ÿï¼ˆinitramfsï¼‰

ğŸ”¹ 5. **GRUB æ‰§è¡Œ `linux` æŒ‡ä»¤ â†’ è·³è½¬åˆ°å†…æ ¸å…¥å£**

- GRUB æœ€åè°ƒç”¨ `boot` æŒ‡ä»¤ï¼Œè·³è½¬åˆ°åŠ è½½å¥½çš„å†…æ ¸å…¥å£ç‚¹ï¼Œæ§åˆ¶æƒè½¬äº¤ç»™ Linux å†…æ ¸ï¼ˆ`vmlinuz` è§£å‹æ‰§è¡Œï¼‰ã€‚

ğŸ”¹ 6. **å†…æ ¸è§£å‹ + ç¡¬ä»¶åˆå§‹åŒ–**

- `vmlinuz` å…ˆè‡ªè§£å‹æˆ `vmlinux`ï¼ˆELF æ ¼å¼çš„å†…æ ¸æ˜ åƒï¼‰
- åˆå§‹åŒ– CPU æ ¸å¿ƒç»“æ„ã€å†…æ ¸é¡µè¡¨ã€å†…æ ¸æ ˆã€IDTã€GDTã€å†…æ ¸å†…å­˜ç®¡ç†å™¨ç­‰ã€‚

ğŸ”¹ 7. **æŒ‚è½½ initramfs ä½œä¸ºä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿ**

- å†…æ ¸å°† initramfs è§£å‹åˆ° `/` ä½œä¸ºä¸´æ—¶æ ¹ã€‚
- æ­¤æ—¶ç³»ç»Ÿè¿˜ä¸èƒ½è®¿é—®çœŸæ­£çš„ç¡¬ç›˜ `/dev/sdaX`ï¼Œå› ä¸ºé©±åŠ¨è¿˜æ²¡åŠ è½½ã€‚

ğŸ”¹ 8. **æ‰§è¡Œ initramfs ä¸­çš„ `init` è„šæœ¬**

- `initramfs` ä¸­çš„ `/init` æˆ– dracut è„šæœ¬å¼€å§‹æ‰§è¡Œï¼Œå®ƒä¼šåšä»¥ä¸‹å·¥ä½œï¼š
  - åŠ è½½é©±åŠ¨ï¼ˆç½‘å¡ã€ç¡¬ç›˜ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼‰
  - å¯åŠ¨ `udev` æ¢æµ‹è®¾å¤‡ï¼ŒæŒ‚è½½çœŸæ­£çš„æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚ `/dev/sda2`ï¼‰
  - åˆ‡æ¢æ ¹ç›®å½•åˆ°ç¡¬ç›˜çš„çœŸæ­£æ ¹ï¼ˆ`switch_root` æˆ– `pivot_root`ï¼‰





####  é˜¶æ®µä¸‰ï¼šåˆ‡æ¢æ ¹ç›®å½•å¹¶å¯åŠ¨ systemdï¼ˆPID 1ï¼‰

ğŸ”¹ 9. **ä½¿ç”¨ `switch_root` åˆ‡æ¢åˆ°çœŸæ­£çš„ `/`**

- å†…æ ¸ä» `initramfs` çš„ `/` åˆ‡æ¢åˆ°ç¡¬ç›˜çš„ `/`ï¼ˆå¦‚ `/dev/sda2` æŒ‚è½½çš„çœŸå®ç³»ç»Ÿï¼‰ã€‚
- æ­¤å initramfs æ–‡ä»¶ç³»ç»Ÿä¼šé‡Šæ”¾ã€‚

ğŸ”¹ 10. **æ‰§è¡Œæ–°æ ¹æ–‡ä»¶ç³»ç»Ÿä¸­çš„ `/sbin/init`**

- ç°ä»£ç³»ç»Ÿä¸­ï¼Œ`/sbin/init` æ˜¯ `/lib/systemd/systemd` çš„ç¬¦å·é“¾æ¥ã€‚
- systemd æˆä¸º PID 1ï¼Œè´Ÿè´£åç»­æ•´ä¸ªç”¨æˆ·ç©ºé—´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚



```css
GRUB stage2
 â””â”€ è¯»å– grub.cfg
     â”œâ”€ åŠ è½½ vmlinuz
     â””â”€ åŠ è½½ initramfs/initrd.img
         â†“
Linux å†…æ ¸å¯åŠ¨ (vmlinuz è§£å‹ â†’ vmlinux)
 â”œâ”€ åˆå§‹åŒ–å†…æ ¸æ•°æ®ç»“æ„
 â”œâ”€ è§£å‹ initramfs ä¸ºä¸´æ—¶æ ¹
 â””â”€ æ‰§è¡Œ /initï¼ˆæˆ– dracut è„šæœ¬ï¼‰
         â†“
 æ¢æµ‹è®¾å¤‡ â†’ åŠ è½½æ¨¡å— â†’ æŒ‚è½½çœŸæ­£æ ¹æ–‡ä»¶ç³»ç»Ÿ
 â””â”€ switch_root åˆ°çœŸæ­£çš„ /
     â””â”€ æ‰§è¡Œ /sbin/initï¼ˆå³ systemdï¼‰
         â””â”€ systemd æˆä¸º PID 1ï¼Œå¯åŠ¨æ‰€æœ‰æœåŠ¡
```



### initè„šæœ¬

å¦‚æœä½ çš„ç³»ç»Ÿä½¿ç”¨ `dracut`ï¼ˆCentOS/Red Hat é»˜è®¤ï¼‰ï¼š

- `/init` æ˜¯ç”± dracut è‡ªåŠ¨ç”Ÿæˆçš„å¤æ‚ shell è„šæœ¬
- è„šæœ¬é‡Œä¼šåŒ…å« **LVM æ£€æµ‹ã€æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ã€udev å¯åŠ¨ã€switch_root** ç­‰è¿‡ç¨‹

ä½ å¯ä»¥è‡ªå·±æŸ¥çœ‹ `/init` å†…å®¹ï¼Œæ³¨é‡Šéå¸¸æ¸…æ™°





## å¼€æœºé˜¶æ®µçš„ä¸¤å¤§æ£€æµ‹é˜¶æ®µ

### **BIOS/UEFI é˜¶æ®µï¼šç¡¬ä»¶æ£€æµ‹ï¼ˆç¡¬ä»¶åˆå§‹åŒ–ï¼‰**

è¿™ä¸ªé˜¶æ®µä¸»è¦ç”± **å›ºä»¶ï¼ˆFirmwareï¼‰** æ‰§è¡Œï¼Œå¸¸è¢«ç§°ä¸º **POST**ï¼ˆPower-On Self Testï¼‰ã€‚å®ƒè´Ÿè´£ï¼š

| æ£€æµ‹é¡¹ç›®                         | ä½œç”¨                                             |
| -------------------------------- | ------------------------------------------------ |
| CPU                              | æ˜¯å¦å­˜åœ¨ã€å¯ç”¨ï¼ˆä¾‹å¦‚ä¸»é¢‘/æ ¸å¿ƒï¼‰                  |
| å†…å­˜ï¼ˆRAMï¼‰                      | æ˜¯å¦æ’å¥½ã€å¯å¯»å€ã€åŸºæœ¬è¯»å†™æ˜¯å¦æ­£å¸¸               |
| æ˜¾å¡/æ˜¾å­˜ï¼ˆVGAï¼‰                 | ç”¨äºæ˜¾ç¤ºå¯åŠ¨ç”»é¢æˆ–è¾“å‡ºé”™è¯¯ä¿¡æ¯                   |
| ä¸»æ¿èŠ¯ç‰‡ç»„ï¼ˆå¦‚å—æ¡¥ï¼‰             | æ£€æŸ¥æ€»çº¿æ˜¯å¦è¿é€š                                 |
| é”®ç›˜/USB/ç”µæºç­‰å¤–å›´              | æœ‰æ— çŸ­è·¯ã€ç¼ºå¤±                                   |
| BIOS è®¾ç½®ï¼ˆä» NVRAM è¯»å–ï¼‰       | åŒ…æ‹¬å¯åŠ¨é¡ºåºã€æ—¶é’Ÿç­‰é…ç½®                         |
| æŸ¥æ‰¾å¯åŠ¨è®¾å¤‡ï¼ˆHDDã€Uç›˜ã€ç½‘ç»œç­‰ï¼‰ | æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ´»åŠ¨çš„å¼•å¯¼è®¾å¤‡å¹¶è¯»å–å…¶ MBR æˆ– EFI æ–‡ä»¶ |

**å¦‚æœæ­¤é˜¶æ®µå¤±è´¥ï¼Œä¸€èˆ¬æŠ¥é”™ä¸ºé»‘å±ã€èœ‚é¸£ã€æ‰¾ä¸åˆ°å¯åŠ¨ç›˜ç­‰ã€‚**





### **initrd/initramfs é˜¶æ®µï¼šé©±åŠ¨åŠ è½½ï¼ˆè½¯ä»¶æ£€æµ‹ï¼‰**

è¿™ä¸ªé˜¶æ®µæ˜¯åœ¨ **Linux å†…æ ¸è§£å‹å®Œæˆå¹¶è¿è¡Œä¹‹å**ï¼Œå¼€å§‹æŒ‚è½½ä¸´æ—¶æ ¹æ–‡ä»¶ç³»ç»Ÿï¼ˆinitrd.img/initramfsï¼‰ï¼Œå¹¶ç”± `/init` æˆ–ç±»ä¼¼ `dracut`ã€`initramfs-tools` çš„è„šæœ¬è´Ÿè´£ï¼š

| æ£€æµ‹å†…å®¹                                           | ä½œç”¨                    |
| -------------------------------------------------- | ----------------------- |
| æ˜¯å¦å­˜åœ¨å¹¶åŠ è½½ç£ç›˜æ§åˆ¶å™¨é©±åŠ¨                       | å¦åˆ™æ‰¾ä¸åˆ°çœŸæ­£çš„ rootfs |
| æ˜¯å¦åŠ è½½ç½‘ç»œé©±åŠ¨ï¼ˆæŸäº›ç³»ç»Ÿç”¨ç½‘ç»œå¯åŠ¨ï¼‰             |                         |
| æ˜¯å¦æŒ‚è½½æˆåŠŸ LVMã€RAIDã€åŠ å¯†å·ç­‰                   |                         |
| æ˜¯å¦èƒ½ä» root= æŒ‡å®šè·¯å¾„æŒ‚è½½æ ¹æ–‡ä»¶ç³»ç»Ÿ              |                         |
| æ˜¯å¦æ‰¾åˆ°äº† `init` æˆ– `systemd` å¯åŠ¨è¿›ç¨‹            |                         |
| è®¾å¤‡èŠ‚ç‚¹ï¼ˆå¦‚ `/dev/sda`ï¼‰æ˜¯å¦æ­£å¸¸ç”Ÿæˆï¼ˆä¾èµ– udevï¼‰ |                         |

**å¦‚æœè¿™ä¸ªé˜¶æ®µå¤±è´¥ï¼Œå°±ä¼šæ‰è¿› `dracut emergency shell` æˆ– `BusyBox` æç¤ºä½ æ‰‹åŠ¨ä¿®å¤ã€‚**











## å¯åŠ¨é¡¹è¯¦è§£

è¿›å…¥ GRUB å‘½ä»¤è¡Œï¼ˆå¼€æœºæŒ‰ `c` è¿›å…¥çš„ `grub>` æç¤ºç¬¦ï¼‰

<img src="D:\git_repository\cyber_security_learning\markdown_img\image-20250829111555395.png" alt="image-20250829111555395" style="zoom:150%;" />



### GRUBå‘½ä»¤è¯¦è§£

#### æŸ¥çœ‹/è°ƒè¯•ç±»

**`set`**
 æ˜¾ç¤ºæ‰€æœ‰ç¯å¢ƒå˜é‡ï¼ˆ`prefix`ã€`root`ã€`timeout`ã€`default` ç­‰ï¼‰ã€‚

```bash
set
echo $prefix
```

**`ls`**
 åˆ—å‡ºå¯ç”¨è®¾å¤‡å’Œåˆ†åŒºï¼Œç›¸å½“äº Linux é‡Œçš„ `lsblk + ls`ã€‚

```bash
ls
# è¾“å‡ºç¤ºä¾‹: (hd0) (hd0,gpt1) (hd0,gpt2)
ls (hd0,gpt2)/
```

<img src="D:\git_repository\cyber_security_learning\markdown_img\image-20250829112000905.png" alt="image-20250829112000905" style="zoom:150%;" />

**`cat`**
 æŸ¥çœ‹é…ç½®æ–‡ä»¶æˆ–å†…æ ¸å‘½ä»¤è¡Œå‚æ•°æ–‡ä»¶å†…å®¹ã€‚

```bash
cat (hd0,gpt2)/etc/fstab
cat (hd0,gpt2)/grub2/grub.cfg
```

**`help`**
 æŸ¥çœ‹å‘½ä»¤å¸®åŠ©ã€‚

```bash
help ls
help linux
```



#### ç£ç›˜/æ–‡ä»¶ç³»ç»Ÿæ“ä½œç±»

- **`ls (hdX,gptY)/`**
   åˆ—å‡ºåˆ†åŒºä¸­çš„æ–‡ä»¶ã€‚

- **`search`**
   æŸ¥æ‰¾åŒ…å«æŒ‡å®š UUID æˆ–æ–‡ä»¶çš„åˆ†åŒºï¼Œç”¨æ¥ç¡®è®¤ `/boot` åœ¨å“ªé‡Œã€‚

  ```bash
  search --no-floppy --fs-uuid --set=root <UUID>
  search --file /vmlinuz --set=root
  ```

- **`insmod`**
   åŠ è½½ GRUB æ¨¡å—ï¼Œæ¯”å¦‚æ–‡ä»¶ç³»ç»Ÿé©±åŠ¨ï¼ˆå¸¸è§ ext2, xfs, lvmï¼‰ã€‚

  ```bash
  insmod xfs
  insmod lvm
  ```



#### å†…æ ¸/å¯åŠ¨ç±»ï¼ˆæ‰‹åŠ¨å¼•å¯¼ç³»ç»Ÿï¼‰

å½“ `grub.cfg` æŸåæ—¶ï¼Œå¯ä»¥æ‰‹åŠ¨æŒ‡å®šå¯åŠ¨å‚æ•°ï¼š

- **`set root=...`**
   æŒ‡å®šæ ¹åˆ†åŒºã€‚

  ```bash
  set root=(hd0,gpt2)
  ```

- **`linux` / `linuxefi`**
   åŠ è½½ Linux å†…æ ¸ï¼ˆè·¯å¾„é€šå¸¸æ˜¯ `/boot/vmlinuz-*`ï¼‰ã€‚

  ```bash
  linux /vmlinuz-5.14.0-427.el9.x86_64 root=UUID=xxxx ro
  ```

  - BIOS æ¨¡å¼å¸¸ç”¨ `linux`
  - UEFI æ¨¡å¼å¸¸ç”¨ `linuxefi`

- **`initrd` / `initrdefi`**
   åŠ è½½ initramfsã€‚

  ```
  initrd /initramfs-5.14.0-427.el9.x86_64.img
  ```

- **`boot`**
   å¯åŠ¨å†…æ ¸ã€‚

  ```
  boot
  ```

ğŸ‘‰ **å®Œæ•´æ‰‹åŠ¨å¯åŠ¨ç¤ºä¾‹**

```
set root=(hd0,gpt2)
linux /vmlinuz-5.14.0-427.el9.x86_64 root=UUID=1234-5678 ro
initrd /initramfs-5.14.0-427.el9.x86_64.img
boot
```



#### å…¶ä»–æœ‰ç”¨çš„å‘½ä»¤

- **`normal`**
   å°è¯•åŠ è½½æ­£å¸¸èœå•ï¼ˆå¦‚æœ `grub.cfg` å­˜åœ¨ä¸”èƒ½è§£æï¼‰ã€‚

  ```
  normal
  ```

- **`configfile`**
   æ‰‹åŠ¨æŒ‡å®šåŠ è½½æŸä¸ªé…ç½®æ–‡ä»¶ã€‚

  ```bash
  configfile (hd0,gpt2)/boot/grub2/grub.cfg
  ```

- **`terminal_output`**
   åˆ‡æ¢è¾“å‡ºæ–¹å¼ï¼ˆ`console`ã€`gfxterm` ç­‰ï¼‰ã€‚

- **`chainloader`**
   é“¾å¼åŠ è½½å¦ä¸€ä¸ªå¼•å¯¼ç¨‹åºï¼ˆå¸¸ç”¨äºå¤šç³»ç»Ÿï¼Œæ¯”å¦‚ Windows å¼•å¯¼ï¼‰ã€‚

  ```bash
  set root=(hd0,1)
  chainloader +1
  boot
  ```



### æ’é”™åœºæ™¯

**ä¸çŸ¥é“ /boot åœ¨å“ªé‡Œ** â†’ ç”¨ `ls` + `search` æ‰¾åˆ†åŒºã€‚

**æ²¡æœ‰èœå•ç›´æ¥è¿›å…¥ `grub>`** â†’ ç”¨ `configfile` æ‰‹åŠ¨åŠ è½½ `grub.cfg`ã€‚

**èœå•ä¸¢å¤±ï¼Œgrub.cfg æŸå** â†’ æ‰‹åŠ¨ç”¨ `linux + initrd + boot` å¯åŠ¨ã€‚

**UEFI ä¸‹ EFI æ–‡ä»¶æŸå** â†’ ç”¨ `chainloader /EFI/.../grubx64.efi` å°è¯•å¯åŠ¨



å®éªŒï¼šåˆ é™¤/boot/loaderç›®å½•åï¼Œé‡å¯ï¼Œç”±äºç¼ºå¤±å¯åŠ¨é¡¹é…ç½®ï¼Œä»è€Œè¿›å…¥grubç•Œé¢ï¼Œæ‰‹åŠ¨ä¿®å¤ï¼Œè¿›å…¥æ“ä½œç³»ç»Ÿ

```bash
# æ‰¾åˆ°/bootç›®å½•
grub> ls
(hd0) (hd0,gpt1) (hd0,gpt2) (hd0,gpt3)

# æŸ¥æ‰¾åå‘ç°åªæœ‰(hd0,gpt2)æœ‰æ“ä½œç³»ç»Ÿ
grub> ls (hd0,gpt2)

# æŸ¥çœ‹/bootä¸‹çš„æ–‡ä»¶
grub > ls (hd0,gpt2)/

# ç„¶åä¾æ¬¡æ‰§è¡Œåç»­å‘½ä»¤
set root=(hd0,gpt2)
linux /vmlinuz-6.12.0-55.el10.x86_64 root=/dev/mapper/rhel-root ro rd.lvm.lv=rhel/root
initrd /initramfs-6.12.0-55.el10.x86_64.img
boot

# ä¸Šè¿°å‘½ä»¤ï¼Œrootçš„è·¯å¾„å¯èƒ½éœ€è¦live CDè¿›å…¥æ•‘æ´æ¨¡å¼æ‰èƒ½çœ‹åˆ°ï¼Œä½†æ˜¯å°±å¦‚æ•‘æ´æ¨¡å¼ï¼Œè²Œä¼¼å°±ä¸éœ€è¦åœ¨grubç•Œé¢ä¿®å¤äº†â€¦â€¦ç•¥æ˜¾å°´å°¬
# æ›´ç®€å•çš„æ˜¯è¿›å…¥CDæ•‘æ´æ¨¡å¼ï¼Œç„¶åé‡æ–°ä¸‹è½½ä¸‹kernelï¼Œå³å¯ç”Ÿæˆloaderç›®å½•
dnf install -y kernel-core kernelrm -
```







### ä¼ ç»Ÿ GRUB èœå•æ–¹å¼

#### è¯»å–æµç¨‹

- BIOS/UEFI â†’ åŠ è½½ GRUBï¼ˆMBR/EFI åˆ†åŒºä¸­çš„ GRUB å¼•å¯¼ä»£ç ï¼‰ã€‚

- GRUB è¯»å– **é…ç½®æ–‡ä»¶ `grub.cfg`**ï¼š

  - BIOS å¯åŠ¨ï¼š**`/boot/grub2/grub.cfg`**

  - UEFI å¯åŠ¨ï¼š**`/boot/efi/EFI/<vendor>/grub.cfg`**ï¼ˆ/etc ä¸‹å¸¸æœ‰ä¾¿æ·é“¾æ¥ `/etc/grub2.cfg`ã€`/etc/grub2-efi.cfg`ï¼‰ã€‚

    ```bash
    root@localhost:~# ll /etc/grub2.cfg 
    lrwxrwxrwx. 1 root root 22 May 20 08:00 /etc/grub2.cfg -> ../boot/grub2/grub.cfg
    ```

- `grub.cfg` é‡ŒåŒ…å«å¤šä¸ª `menuentry` å—ï¼Œæ¯ä¸ªå—å¯¹åº”ä¸€ä¸ªå†…æ ¸/æ•‘æ´é¡¹ï¼ŒGRUB æŒ‰è¶…æ—¶æ˜¾ç¤ºèœå•ï¼Œç”¨æˆ·é€‰æ‹©åæ‰§è¡Œ `linux16/linuxefi` + `initrd16/initrdefi` è¡ŒåŠ è½½å†…æ ¸+initramfsã€‚



#### grub.cfg ç‰‡æ®µç¤ºä¾‹

```bash
set timeout=5
menuentry 'CentOS Linux (3.10.0-1160.el7.x86_64)' --class centos --class gnu-linux {
    set root='hd0,gpt2'
    linux16 /vmlinuz-3.10.0-1160.el7.x86_64 root=UUID=... ro crashkernel=auto rhgb quiet
    initrd16 /initramfs-3.10.0-1160.el7.x86_64.img
}
```

**ç”Ÿæˆæµç¨‹**

- ä½ ä¸ç›´æ¥ç¼–è¾‘ `grub.cfg`ï¼Œè€Œæ˜¯ç”± **è„šæœ¬+æ¨¡æ¿** ç»Ÿä¸€ç”Ÿæˆï¼š
  1. **é…ç½®å˜é‡**ï¼š`/etc/default/grub`ï¼ˆå¦‚ `GRUB_TIMEOUT`ã€`GRUB_CMDLINE_LINUX`ï¼‰ã€‚
  2. **ç”Ÿæˆè„šæœ¬**ï¼š`/etc/grub.d/`ï¼ˆå¦‚ `00_header`ã€`10_linux`ã€`30_os-prober`ã€`40_custom`ï¼‰ã€‚
- æœ€ç»ˆç”¨ä¸‹é¢å‘½ä»¤ç”Ÿæˆ `grub.cfg`ï¼š
  - BIOSï¼š`grub2-mkconfig -o /boot/grub2/grub.cfg`
  - UEFIï¼š`grub2-mkconfig -o /boot/efi/EFI/<vendor>/grub.cfg`
- **å†…æ ¸æ›´æ–°**æ—¶ï¼Œæ‰“åŒ…è„šæœ¬ä¼šæŠŠæ–°å†…æ ¸æ”¾åˆ° `/boot`ï¼Œéšåä½ é€šå¸¸éœ€è¦ï¼ˆæˆ–ç”±è„šæœ¬è§¦å‘ï¼‰é‡å»º `grub.cfg` æ‰èƒ½å‡ºç°æ–°æ¡ç›®ã€‚





### BLS æ–¹å¼

å…³é”®æ€æƒ³ï¼š**ä¸å†æŠŠæ‰€æœ‰æ¡ç›®å†™è¿›ä¸€ä¸ªå¤§ `grub.cfg`**ï¼Œè€Œæ˜¯æŠŠæ¯ä¸ªå¯åŠ¨é¡¹å†™æˆä¸€ä¸ª**ç‹¬ç«‹çš„å°æ–‡ä»¶**ï¼Œæ”¾åœ¨ç»Ÿä¸€ç›®å½•ä¸‹ï¼Œç”± GRUB åœ¨å¯åŠ¨æ—¶**è‡ªåŠ¨æšä¸¾**å¹¶å±•ç¤ºã€‚



**è¯»å–æµç¨‹**

1. BIOS/UEFI â†’ åŠ è½½ GRUBã€‚
2. GRUB è¯»åˆ°ä¸€ä¸ª**æç®€**çš„ `grub.cfg`ï¼ˆåªåšåˆå§‹åŒ– + å¯ç”¨ BLSï¼‰ï¼š
   - å®ƒä¼š `insmod blscfg` å¹¶æ‰§è¡Œ `blscfg`ï¼Œ**è‡ªåŠ¨æ‰«æ** `/boot/loader/entries/*.conf`ï¼ŒæŒ‰ BLS è§„èŒƒç”Ÿæˆèœå•ã€‚
3. ç”¨æˆ·é€‰æ‹©çš„ BLS æ¡ç›®è¢«è§£æï¼šä»æ¡ç›®æ–‡ä»¶é‡Œæ‹¿åˆ° kernelã€initrdã€å†…æ ¸å‚æ•°ï¼ŒåŠ è½½å¹¶å¯åŠ¨ã€‚



**BLS æ¨¡å¼ä¸‹ç²¾ç®€çš„ `grub.cfg` å¸¸è§æ ·å­**

```bash
set timeout=5
insmod blscfg
blscfg
```

> çœ‹ä¸è§å…·ä½“ menuentryï¼Œå› ä¸ºå®ƒç”± `blscfg` æŒ‰ BLS æ¡ç›®â€œå³å¸­ç”Ÿæˆâ€ã€‚



**æ–‡ä»¶ç»“æ„**

```bash
/boot/
â””â”€â”€ loader/
    â”œâ”€â”€ loader.conf          # å…¨å±€è®¾ç½®ï¼ˆé»˜è®¤å¯åŠ¨é¡¹ã€èœå•æ ·å¼ç­‰ï¼‰
    â””â”€â”€ entries/
        â”œâ”€â”€ <machine-id>-<kernel-ver>-<suffix>.conf
        â”œâ”€â”€ <machine-id>-<older-kernel>.conf
        â””â”€â”€ <machine-id>-rescue-<...>.conf
```



**BLS å¯åŠ¨é¡¹ï¼ˆentries/*.confï¼‰ç¤ºä¾‹**

```ini
title   Rocky Linux (5.14.0-427.22.1.el9_4.x86_64) 9.4
version 5.14.0-427.22.1.el9_4.x86_64
linux   /vmlinuz-5.14.0-427.22.1.el9_4.x86_64
initrd  /initramfs-5.14.0-427.22.1.el9_4.x86_64.img
options root=UUID=... ro crashkernel=auto rhgb quiet
# å¯é€‰ï¼šsort-keyã€grub_usersã€grub_argã€devicetree ç­‰
```



**`loader.conf` ç¤ºä¾‹**

```ini
default <machine-id>-5.14.0-427.22.1.el9_4.x86_64.conf
timeout 5
```

> **é»˜è®¤é¡¹**å¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®šï¼Œä¹Ÿå¯ä»¥é€šè¿‡ `grub2-set-default` / `grubby --set-default` è®¾ç½®ï¼Œå®é™…ä¼šè½åˆ° `grubenv` æˆ–æ›´æ–° `loader.conf`/BLS æ¡ç›®æ ‡è¯†ã€‚



#### BLS ç›¸å…³æ“ä½œ

```bash
# æŸ¥çœ‹å¯åŠ¨é¡¹å‚æ•°
grubby --info=ALL

# æŸ¥çœ‹é»˜è®¤å¯åŠ¨å†…æ ¸ç‰ˆæœ¬
grubby --default-kernrl

# è®¾ç½®é»˜è®¤å†…æ ¸
grubby --set-default /boot/vmlinuz-5.14.0-...
grub2-set-default <entry-id>

# æ·»åŠ ä¿®æ”¹å†…æ ¸å‚æ•°
# å¯¹å½“å‰é»˜è®¤å†…æ ¸ä¿®æ”¹å‚æ•°
grubby --args="net.ifnames=0" --update-kernel DEFAULT

# å¯¹æ‰€æœ‰å†…æ ¸ä¿®æ”¹å‚æ•°
grubby --args="net.ifnames=0" --update-kernel ALL

# ç§»é™¤å‚æ•°
grubby --remove-args="rhgb quiet" --update-kernel ALL
```



## systemd

### systemdç‰¹æ€§

- systemdï¼šä»CentOS7ç‰ˆæœ¬ä¹‹åå¼€å§‹ç”¨systemdå®ç°initè¿›ç¨‹ï¼Œç³»ç»Ÿå¯åŠ¨å’ŒæœåŠ¡å™¨å®ˆæŠ¤è¿›ç¨‹ç®¡ç†å™¨ï¼Œè´Ÿè´£åœ¨ç³»ç»Ÿå¯åŠ¨è¿è¡Œæ—¶ï¼Œæ¿€æ´»ç³»ç»Ÿèµ„æºï¼ŒæœåŠ¡å™¨è¿›ç¨‹å’Œå…¶ä»–è¿›ç¨‹


- systemdæ–°ç‰¹æ€§
  - ç³»ç»Ÿå¼•å¯¼æ—¶ï¼Œå®ç°æœåŠ¡**å¹¶è¡Œå¯åŠ¨**ï¼ˆå¹¶ä¸æ˜¯å®Œå…¨å¹¶è¡Œï¼Œæœ‰ä¾èµ–å…³ç³»çš„ä¼šæœ‰å‰åé¡ºåºï¼‰
  - **æŒ‰éœ€å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹**
  - **è‡ªåŠ¨åŒ–çš„æœåŠ¡ä¾èµ–å…³ç³»ç®¡ç†**
    - å¦‚æœéœ€è¦å¯åŠ¨ä¸€ä¸ªæœåŠ¡ï¼Œä½†è¿™ä¸ªæœåŠ¡éœ€è¦ä¾èµ–å…¶ä»–çš„æœåŠ¡æ‰èƒ½å¯åŠ¨ï¼Œåœ¨systemdçš„ç®¡ç†ä¸‹ï¼Œä¼šå°†å®ƒä»¥åŠå®ƒæ‰€ä¾èµ–çš„æ‰€æœ‰æœåŠ¡ä¸€å¹¶å¯åŠ¨
  - åŒæ—¶é‡‡ç”¨socketå¼ä¸D-Busæ€»çº¿å¼æ¿€æ´»æœåŠ¡
  - socketä¸æœåŠ¡ç¨‹åºåˆ†ç¦»
    - socketä»£è¡¨ipç«¯å£å·
    - serversæœåŠ¡ä»£è¡¨ä¸€ä¸ªè¿›ç¨‹
    - å¯ä»¥å®ç°ä¸€ä¸ªæ•ˆæœï¼Œå°±æ˜¯ç”±systemdè¿›è¡Œç›‘å¬socket,å¦‚æœæœ‰äººè®¿é—®è¯¥ç«¯å£ï¼Œæ‰ä¼šæ¿€æ´»è¿™ä¸ªæœåŠ¡ï¼Œè€Œä¸åƒä¹‹å‰é‚£æ ·ï¼Œä¸€æ—¦ä¸€ä¸ªç«¯å£å¤„äºç›‘å¬çŠ¶æ€ï¼Œå°±å¿…é¡»åœ¨ä¸Šé¢å¯åŠ¨ä¸€ä¸ªæœåŠ¡
  - å‘åå…¼å®¹sysvï¼Œinitè„šæœ¬
  - ä½¿ç”¨systemctlå‘½ä»¤ç®¡ç†ï¼Œsystemctlå‘½ä»¤å›ºå®šä¸å˜ï¼Œä¸å¯æ‰©å±•ï¼Œéç”±systemdå¯åŠ¨çš„æœåŠ¡ï¼Œsystemdæ— æ³•ä¸ä¹‹é€šä¿¡å’Œæ§åˆ¶
  - ç³»ç»ŸçŠ¶æ€å¿«ç…§



### systemdæ ¸å¿ƒæ¦‚å¿µï¼šunit



![image-20250627180458106](D:\git_repository\cyber_security_learning\markdown_img\image-20250627180458106.png)



#### ä»€ä¹ˆæ˜¯Unitï¼Ÿ

Unit æ˜¯ systemd ä¸­çš„åŸºæœ¬ç®¡ç†å¯¹è±¡ï¼Œç”¨äºæè¿°ä¸€ä¸ªå¯è¢« systemd æ§åˆ¶çš„ç³»ç»Ÿèµ„æºæˆ–è¡Œä¸ºå•å…ƒã€‚

é€šä¿—è¯´æ³•å°±æ˜¯ï¼š

> **ä¸€ä¸ª unit å°±æ˜¯ä¸€é¡¹ç”± systemd ç®¡ç†çš„â€œä¸œè¥¿â€**ï¼Œæ¯”å¦‚ä¸€ä¸ªæœåŠ¡ã€ä¸€ä¸ªæŒ‚è½½ç‚¹ã€ä¸€ä¸ª socketã€ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ç­‰ã€‚

æ¯ä¸ª unit æ–‡ä»¶å®é™…ä¸Šæè¿°äº†æŸç§â€œ**èµ„æº**â€ä»¥åŠå®ƒçš„å¯åŠ¨/åœæ­¢/ä¾èµ–/è¡Œä¸ºæ–¹å¼ã€‚

å®ƒç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š

```bat
<name>.<type>
```

**Unit æ˜¯ systemd çš„â€œé€šç”¨æŠ½è±¡å±‚â€**

ä»¥å‰ï¼š

- å¯åŠ¨æœåŠ¡é  `/etc/init.d/*`
- æŒ‚è½½é  `/etc/fstab`
- å®šæ—¶ä»»åŠ¡é  `cron`
- å¥—æ¥å­—é  `inetd`

ç°åœ¨ï¼š

- **æ‰€æœ‰è¿™äº›éƒ½ç»Ÿä¸€ç”± unit æ–‡ä»¶æ¥æè¿°å’Œç®¡ç†**ï¼Œsystemd ç»Ÿä¸€è°ƒåº¦ã€å¹¶å‘ã€ä¾èµ–ã€æ—¥å¿—ã€ç›‘æ§ï¼Œæˆä¸ºä¸€ä¸ªå®Œæ•´ç®¡ç†æ¡†æ¶ã€‚



#### âœ… 1. **æœåŠ¡ç®¡ç†** â€”â€” ä½¿ç”¨ `.service` unit æ›¿ä»£ `/etc/init.d/*`

ğŸ”§ ä¼ ç»Ÿæ–¹å¼ï¼š

```bash
/etc/init.d/nginx start
```

ğŸš€ systemd æ–¹å¼ï¼š

```bash
# å¯åŠ¨ nginx æœåŠ¡
systemctl start nginx.service

# æŸ¥çœ‹çŠ¶æ€
systemctl status nginx.service

# è®¾ç½®ä¸ºå¼€æœºå¯åŠ¨
systemctl enable nginx.service
```

unit æ–‡ä»¶è·¯å¾„ï¼ˆå¯èƒ½åœ¨ï¼‰ï¼š

```swift
/lib/systemd/system/nginx.service
```





#### âœ… 2. **æ–‡ä»¶ç³»ç»ŸæŒ‚è½½** â€”â€” ä½¿ç”¨ `.mount` unit æ›¿ä»£ `/etc/fstab`

ğŸ”§ ä¼ ç»Ÿæ–¹å¼ï¼š

åœ¨ `/etc/fstab` ä¸­æ·»åŠ ï¼š

```bash
/dev/sdb1 /data ext4 defaults 0 2
```

ğŸš€ systemd æ–¹å¼ï¼š

åˆ›å»º unit æ–‡ä»¶ï¼ˆè‡ªåŠ¨ä¸ `/data` åŒ¹é…ï¼‰ï¼š

```bash
/etc/systemd/system/data.mount
```

å†…å®¹å¦‚ä¸‹ï¼š

```ini
[Unit]
Description=Mount /data
Before=local-fs.target
# è¿™è¡¨ç¤ºä½ å®šä¹‰çš„è¿™ä¸ª .mount å•å…ƒï¼ˆæ¯”å¦‚æŒ‚è½½ /dataï¼‰ä¼šåœ¨ local-fs.target è§¦å‘ä¹‹å‰å®ŒæˆæŒ‚è½½ã€‚
# ä¹Ÿå°±æ˜¯è¯´ï¼š
# ä½ å‘Šè¯‰ systemdï¼šâ€œæˆ‘è¿™ä¸ªæŒ‚è½½ç‚¹éå¸¸é‡è¦ï¼Œå¿…é¡»åœ¨ç³»ç»Ÿè®¤ä¸ºâ€œæ‰€æœ‰æœ¬åœ°æŒ‚è½½éƒ½å®Œæˆâ€ä¹‹å‰æ‰§è¡Œã€‚â€
# åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œä½ ä¸éœ€è¦æ˜¾å¼å†™è¿™ä¸ªï¼Œå› ä¸ºï¼š
# systemd ä¼šè‡ªåŠ¨æ ¹æ® .mount å•å…ƒçš„è·¯å¾„å…³ç³»ï¼Œå†³å®šå¯åŠ¨é¡ºåº
# systemd ä¼šæŠŠå®ƒåŠ å…¥ local-fs.target çš„ä¾èµ–ä¸­

[Mount]
# What=UUID=4c2f00c2-7ec5-44d8-91fa-f0f9375ee5b4
What=/dev/sdb1
Where=/data
Type=ext4
Options=defaults

[Install]
WantedBy=multi-user.target
```

ç„¶åï¼š

```bash
systemctl daemon-reexec
systemctl enable --now data.mount
```

è¿™å°±å®Œæˆäº† `/data` çš„è‡ªåŠ¨æŒ‚è½½ï¼Œ**å®Œå…¨ä¸ä¾èµ– /etc/fstab**ã€‚

**`Where=/data`**

è¡¨ç¤ºæŒ‚è½½ç‚¹è·¯å¾„ï¼Œå®ƒ**å¿…é¡»åŒ¹é…æ–‡ä»¶å**ï¼ˆå¦åˆ™æ— æ•ˆï¼‰ï¼

ä¾‹ï¼š

- `/data` â†’ `data.mount`
- `/mnt/disk` â†’ `mnt-disk.mount`



#### âœ…3. **å®šæ—¶ä»»åŠ¡** â€”â€” ä½¿ç”¨ `.timer` unit æ›¿ä»£ `cron`

ğŸ”§ ä¼ ç»Ÿæ–¹å¼ï¼š

```bash
crontab -e
# æ·»åŠ ï¼š
0 1 * * * /usr/local/bin/backup.sh
```

systemd æ–¹å¼ï¼š

åˆ›å»ºä¸¤ä¸ª unitï¼š

`backup.service`ï¼ˆæ‰§è¡Œå†…å®¹ï¼‰ï¼š

```ini
[Unit]
Description=Backup MySQL database

[Service]
Type=oneshot
ExecStart=/usr/local/bin/backup.sh
```

ä¿å­˜ä¸º `/etc/systemd/system/backup.service`

`backup.timer`ï¼ˆå®šæ—¶è§¦å‘ï¼‰ï¼š

```ini
[Unit]
Description=Run backup daily at 1am

[Timer]
OnCalendar=*-*-* 01:00:00
Persistent=true

[Install]
WantedBy=timers.target
```

ä¿å­˜ä¸º `/etc/systemd/system/backup.timer`

å¯åŠ¨ï¼š

```bash
systemctl daemon-reload
systemctl enable --now backup.timer
```

ç°åœ¨ systemd ä¼š**æ¯å¤©å‡Œæ™¨1ç‚¹è‡ªåŠ¨æ‰§è¡Œä½ çš„è„šæœ¬**ï¼Œæ•ˆæœä¸ cron ç­‰ä»·ç”šè‡³æ›´å¼ºã€‚

**å‚æ•°è§£é‡Š**

**ğŸ”¹ `OnCalendar=*-*-* 01:00:00`**

è¿™æ˜¯ **è§¦å‘æ—¶é—´** çš„è®¾ç½®ã€‚æ ¼å¼ç±»ä¼¼äº `cron`ï¼Œä½†æ›´å¼ºå¤§ã€‚

- `*-*-*` è¡¨ç¤ºï¼š
  - `*` å¹´ï¼ˆä»»æ„å¹´ï¼‰
  - `*` æœˆï¼ˆä»»æ„æœˆï¼‰
  - `*` æ—¥ï¼ˆä»»æ„æ—¥ï¼‰
- `01:00:00` è¡¨ç¤ºï¼š
  - `01` ç‚¹
  - `00` åˆ†
  - `00` ç§’

ğŸ“Œ **æœ€ç»ˆå«ä¹‰**ï¼šæ¯å¤©å‡Œæ™¨ **1:00:00** è§¦å‘ä¸€æ¬¡ã€‚

**`OnCalendar` æ”¯æŒçš„è¯­æ³•æ ¼å¼ï¼ˆå‡ ä¸ªå¸¸ç”¨ä¾‹å­ï¼‰**

| æ—¶é—´                                   | ç¤ºä¾‹                  | è¯´æ˜                           |
| -------------------------------------- | --------------------- | ------------------------------ |
| æ¯å¤©å‡Œæ™¨ 1 ç‚¹                          | `*-*-* 01:00:00`      | æœ€å¸¸è§ç”¨æ³•                     |
| æ¯å°æ—¶æ•´ç‚¹                             | `hourly`              | ç®€å†™å½¢å¼                       |
| æ¯å¤©æ—©ä¸Š 8 ç‚¹                          | `*-*-* 08:00:00`      |                                |
| æ¯å‘¨ä¸€å‡Œæ™¨ 2 ç‚¹                        | `Mon *-*-* 02:00:00`  | æ”¯æŒå‘¨å‡                        |
| æ¯æœˆ 1 å·å‡Œæ™¨ 3 ç‚¹                     | `*-*-01 03:00:00`     |                                |
| æ¯å¹´ 12 æœˆ 25 æ—¥ä¸­åˆ                   | `*-12-25 12:00:00`    |                                |
| æ¯ 5 åˆ†é’Ÿï¼ˆéœ€é…åˆ `AccuracySec=1min`ï¼‰ | `*:0/5`               | systemd æœ‰è‡ªå·±çš„æ–¹å¼è¡¨è¾¾å‘¨æœŸæ€§ |
| å…·ä½“æ—¥æœŸ                               | `2025-07-01 00:00:00` | ç²¾ç¡®æ—¶é—´                       |



**å¦‚æœæœ‰ `Persistent=true`**

å¼€æœºåï¼Œsystemd ä¼šæ£€æµ‹åˆ°ï¼š

> â€œå“ï¼Ÿæ˜¨å¤©å‡Œæ™¨ 1 ç‚¹çš„ä»»åŠ¡é”™è¿‡äº†ï¼ä½†è¿™æ˜¯ä¸€ä¸ª `Persistent` ä»»åŠ¡ã€‚â€

äºæ˜¯ï¼Œå®ƒä¼šåœ¨ **ä»Šå¤©æ—©ä¸Š 9 ç‚¹ï¼ˆä¹Ÿå°±æ˜¯ä¸€å¼€æœºæ—¶ï¼‰ç«‹åˆ»è¡¥è·‘ä¸€æ¬¡æ˜¨å¤©çš„ä»»åŠ¡**ã€‚

è¿™å°±æ˜¯ **â€œè¡¥è·‘â€**ã€‚

------

**âŒ å¦‚æœæ˜¯ `Persistent=false`ï¼ˆé»˜è®¤ï¼‰**

- åˆ™ systemd ä¸ä¼šç†ä¼šæ˜¨å¤©é”™è¿‡çš„ä»»åŠ¡ã€‚
- å®ƒåªä¼šç­‰ä¸‹ä¸€ä¸ªè®¡åˆ’æ—¶é—´ï¼ˆæ¯”å¦‚ä»Šå¤©æ™šä¸Š 1 ç‚¹ï¼‰å†è·‘ã€‚





#### âœ… 4. **æŒ‰éœ€ socket æ¿€æ´»** â€”â€” ä½¿ç”¨ `.socket` unit æ›¿ä»£ `inetd/xinetd`

ğŸ”§ ä¼ ç»Ÿæ–¹å¼ï¼š

ç”¨ `xinetd` å¯åŠ¨ telnet æœåŠ¡ï¼Œå½“ç”¨æˆ·è¿æ¥ 23 ç«¯å£æ—¶å¯åŠ¨æœåŠ¡ã€‚

ğŸš€ systemd æ–¹å¼ï¼ˆä»¥ nginx ä¸¾ä¾‹ï¼‰ï¼š

`nginx.socket`ï¼š

```ini
[Unit]
Description=Socket for nginx

[Socket]
ListenStream=80
Accept=no

[Install]
WantedBy=sockets.target
```

`nginx.service`ï¼ˆæ³¨æ„é…åˆ socket æ¿€æ´»ï¼‰ï¼š

```ini
[Unit]
Description=nginx web server
After=network.target

[Service]
ExecStart=/usr/sbin/nginx -g 'daemon off;'
StandardInput=socket
```

æ“ä½œï¼š

```bash
systemctl enable --now nginx.socket
```

æ­¤æ—¶ systemd ä¼šç›‘å¬ 80 ç«¯å£ï¼Œæœ‰äººè¿æ¥åå†è‡ªåŠ¨å¯åŠ¨ nginxã€‚



#### è¯¦è§£Socketæ¿€æ´»æœºåˆ¶

**systemd** å¯ä»¥é¢„å…ˆç›‘å¬ç«¯å£ï¼ˆå¦‚ TCP 80ï¼‰ï¼Œç­‰æœ‰å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼Œå†å¯åŠ¨å¯¹åº”çš„æœåŠ¡è¿›ç¨‹ï¼Œå¹¶æŠŠ socket äº¤ç»™å®ƒã€‚

ä¼˜åŠ¿ï¼š

- æœåŠ¡**æŒ‰éœ€å¯åŠ¨**ï¼šç©ºé—²æ—¶ä¸å èµ„æºã€‚
- å¯åŠ¨æ›´å¿«ï¼šsocket å·²ç›‘å¬ï¼ŒæœåŠ¡å¯ç«‹å³ä½¿ç”¨ã€‚
- æ”¯æŒ**å¹¶å‘è¿æ¥**ï¼ˆç»“åˆ `Accept=yes` å’Œæ¨¡æ¿æœåŠ¡ `@.service`ï¼‰ã€‚
- é root æœåŠ¡ï¼šsystemd é¢„å…ˆç›‘å¬ root æƒé™çš„ç«¯å£ï¼ŒæœåŠ¡æœ¬èº«å¯è¿è¡Œä¸ºæ™®é€šç”¨æˆ·ã€‚



**äºŒã€Socket æ¿€æ´»çš„ä¸¤ç§æ¨¡å¼**

| æ¨¡å¼                     | Accept å€¼    | ç‰¹ç‚¹                                                    |
| ------------------------ | ------------ | ------------------------------------------------------- |
| å•å®ä¾‹æœåŠ¡               | `Accept=no`  | æ‰€æœ‰è¿æ¥ç”± **ä¸€ä¸ªæœåŠ¡è¿›ç¨‹**å¤„ç†ï¼ˆå¦‚ `nginx`, `ssh`ï¼‰    |
| å¤šå®ä¾‹æœåŠ¡ï¼ˆinetd é£æ ¼ï¼‰ | `Accept=yes` | æ¯ä¸ªè¿æ¥ç”±ä¸€ä¸ªæ–°çš„æœåŠ¡å®ä¾‹å¤„ç†ï¼Œéœ€ä½¿ç”¨ `@.service` æ¨¡æ¿ |





#### å®æˆ˜ï¼šæŒ‰è¿æ¥å¯åŠ¨æœåŠ¡ï¼ˆAccept=yes + @.serviceï¼‰

##### ç¤ºä¾‹ï¼šå†™ä¸€ä¸ª **æŒ‰è¿æ¥å¯åŠ¨ echo æœåŠ¡** çš„ä¾‹å­

âœ… `echo.socket` æ–‡ä»¶

```ini
[Unit]
Description=Echo socket (per connection)

[Socket]
ListenStream=2323
Accept=yes

[Install]
WantedBy=sockets.target
```

è¿™è¡¨ç¤ºç›‘å¬ TCP 2323 ç«¯å£ï¼Œæ¯ä¸ªè¿æ¥éƒ½ç‹¬ç«‹å¯åŠ¨ä¸€ä¸ªæœåŠ¡å®ä¾‹ã€‚



âœ… `echo@.service` æ–‡ä»¶

```ini
[Unit]
Description=Per-Connection Echo Service
After=network.target

[Service]
ExecStart=-/usr/bin/echo-server-wrapper %I
StandardInput=socket
```

- `%I` ä¼šè¢«æ›¿æ¢ä¸º socket è¿æ¥å®ä¾‹åï¼ˆå¦‚ IP:PORTï¼‰
- `StandardInput=socket`ï¼šæœåŠ¡ä» socket æ¥æ”¶è¾“å…¥
- `echo-server-wrapper` æ˜¯ä½ è¦æ‰§è¡Œçš„è„šæœ¬ï¼ˆå¿…é¡»èƒ½å¤„ç†ä» `stdin` è¯»æ•°æ®ï¼‰



âœ… ç¤ºä¾‹ echo è„šæœ¬ï¼ˆ`/usr/bin/echo-server-wrapper`ï¼‰

```bash
#!/bin/bash
echo "Connection ID: $1"
while read line; do
  echo "You said: $line"
done
```

åˆ«å¿˜äº†åŠ æ‰§è¡Œæƒé™ï¼š

```bash
chmod +x /usr/bin/echo-server-wrapper
```



ğŸš€ å››ã€å¯ç”¨å¹¶æµ‹è¯•

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now echo.socket
```

ç„¶åï¼š

```bash
telnet 127.0.0.1 2323
```

ä½ ä¼šçœ‹åˆ°ï¼š

- æ¯ä¸€ä¸ªè¿æ¥ï¼Œsystemd ä¼šè‡ªåŠ¨è¿è¡Œä¸€ä¸ª `echo@<è¿æ¥ ID>.service` å®ä¾‹
- æ¯ä¸ªè¿æ¥éƒ½æ˜¯ç‹¬ç«‹å¤„ç†çš„ï¼Œä¸éœ€è¦ä¸»æœåŠ¡ä¸€ç›´è¿è¡Œ



**è¡¥å……ç»†èŠ‚**

| æ¦‚å¿µ                   | è¯´æ˜                                                    |
| ---------------------- | ------------------------------------------------------- |
| `%i` vs `%I`           | `%i` æ˜¯ `@` ä¸­å®é™…ä¼ å…¥çš„å†…å®¹ï¼Œ`%I` æ˜¯æœªè¢«ç³»ç»Ÿè½¬ä¹‰çš„ç‰ˆæœ¬ |
| `StandardInput=socket` | è¡¨ç¤ºæœåŠ¡ä» systemd ä¼ å…¥çš„ socket æ¥æ”¶è¾“å…¥               |
| `Accept=yes`           | å…³é”®å¼€å…³ï¼šæ¯ä¸ªè¿æ¥åˆ›å»ºä¸€ä¸ªæœåŠ¡å®ä¾‹                      |
| `sockets.target`       | å¤šä¸ª socket æœåŠ¡çš„ç»Ÿä¸€æ¿€æ´»ç›®æ ‡                          |



```bash
[localhost@root ~]# telnet 127.0.0.1 2323
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
Connection ID: 1/127.0.0.1:2323/127.0.0.1:35878
hello
You said: hello
hahah
You said: hahah
```



#### æ‰€æœ‰ç±»å‹æŸ¥çœ‹

```bash
systemctl -t help

#service unit,  æ–‡ä»¶æ‰©å±•åä¸º.service, ç”¨äºå®šä¹‰ç³»ç»ŸæœåŠ¡
# Target unitï¼Œæ–‡ä»¶æ‰©å±•åä¸º.target, ç”¨äºæ¨¡æ‹Ÿå®ç°è¿è¡Œçº§åˆ«
# Device unitï¼Œç”¨äºå®šä¹‰å†…æ ¸è¯†åˆ«çš„è®¾å¤‡
# Mode unitï¼Œ å®šä¹‰æ–‡ä»¶ç³»ç»ŸæŒ‚è½½ç‚¹
# Socket unitï¼Œ å®šä¹‰è¿›ç¨‹é—´é€šä¿¡ç”¨çš„socketæ–‡ä»¶ï¼Œä¹Ÿå¯åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶ï¼Œå»¶è¿Ÿé©±åŠ¨æœåŠ¡ï¼Œå®ç°æŒ‰éœ€åˆ†é…
# Snapshotï¼Œ ç®¡ç†ç³»ç»Ÿå¿«ç…§
# Swap ç”¨äºæ ‡è¯†swapè®¾å¤‡
# Automount unitï¼šautomessageï¼Œæ–‡ä»¶ç³»ç»Ÿçš„è‡ªåŠ¨æŒ‚è½½ç‚¹
# Path unit ï¼š.path,ç”¨äºå®šä¹‰æ–‡ä»¶ç³»ç»Ÿä¸­çš„ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ–ç›®å½•ä½¿ç”¨, å¸¸ç”¨ç”¨äºæ–‡ä»¶ç³»ç»Ÿå˜åŒ–æ—¶ï¼Œå»¶è¿Ÿæ¿€æ´»æœåŠ¡ï¼Œå…¥ä¼å¾®ä¿¡ï¼Œspoolç›®å½•
```



#### âœ… 5.  Target Unit è¯¦è§£

##### ä¸€ã€ä»€ä¹ˆæ˜¯ Target Unitï¼Ÿ

**Target å•å…ƒï¼ˆ`.target`ï¼‰** æ˜¯ systemd ä¸­çš„ä¸€ç§ç‰¹æ®Šç±»å‹çš„å•å…ƒæ–‡ä»¶ï¼Œç”¨äºç»„ç»‡ä¸€ç»„å…¶ä»– unit çš„å¯åŠ¨é¡ºåºå’Œä¾èµ–å…³ç³»ã€‚

å¯ä»¥æŠŠ `.target` ç†è§£ä¸ºï¼š

> â€œ**ä¸€ç»„æœåŠ¡çš„é›†åˆ**ã€è¿è¡Œçº§åˆ«çš„æ›¿ä»£å“â€

å®ƒæœ¬èº« **ä¸æ‰§è¡Œä»»ä½•æ“ä½œ**ï¼Œè€Œæ˜¯ä½œä¸ºæŸç§â€œçŠ¶æ€â€æˆ–â€œé˜¶æ®µâ€çš„æ ‡è®°ã€‚



##### äºŒã€æ–‡ä»¶ä½ç½®ä¸å‘½åè§„åˆ™

æ–‡ä»¶æ‰©å±•åï¼š`.target`

å¸¸è§è·¯å¾„ï¼š

- `/usr/lib/systemd/system/` ï¼ˆç³»ç»Ÿé»˜è®¤ç›®æ ‡ï¼‰
- `/etc/systemd/system/`ï¼ˆç”¨æˆ·è‡ªå®šä¹‰ç›®æ ‡ï¼‰



##### ä¸‰ã€Target æ–‡ä»¶çš„ç»“æ„ç¤ºä¾‹

ä»¥ `multi-user.target` ä¸ºä¾‹ï¼š

```ini
[Unit]
Description=Multi-User System
Documentation=man:systemd.special(7)
Requires=basic.target
After=basic.target
AllowIsolate=yes
```

è§£é‡Šï¼š

| å­—æ®µ           | å«ä¹‰                                               |
| -------------- | -------------------------------------------------- |
| `Description`  | æè¿°                                               |
| `Requires`     | å¯åŠ¨æœ¬ target æ—¶å¿…é¡»å¯ç”¨çš„ç›®æ ‡ï¼ˆç¡¬ä¾èµ–ï¼‰           |
| `After`        | å¯åŠ¨é¡ºåºï¼Œå¿…é¡»åœ¨ basic.target ä¹‹åå¯åŠ¨             |
| `AllowIsolate` | å…è®¸ä½¿ç”¨ `systemctl isolate` å‘½ä»¤åˆ‡æ¢åˆ°è¿™ä¸ª target |



##### å››ã€Target æ˜¯å¦‚ä½•æ¨¡æ‹Ÿè¿è¡Œçº§åˆ«çš„ï¼Ÿ

åœ¨ä¼ ç»Ÿ SysV init ä¸­ï¼Œæœ‰å¦‚ä¸‹è¿è¡Œçº§åˆ«ï¼š

| è¿è¡Œçº§åˆ« | å«ä¹‰             |
| -------- | ---------------- |
| 0        | å…³æœº             |
| 1        | å•ç”¨æˆ·           |
| 3        | å¤šç”¨æˆ·ï¼ˆæ— å›¾å½¢ï¼‰ |
| 5        | å›¾å½¢ç•Œé¢         |
| 6        | é‡å¯             |

åœ¨ systemd ä¸­ï¼Œç”¨ `.target` æ¥æ¨¡æ‹Ÿè¿™äº›ï¼š

| è¿è¡Œçº§åˆ«  | å¯¹åº”çš„ target       |
| --------- | ------------------- |
| runlevel0 | `poweroff.target`   |
| runlevel1 | `rescue.target`     |
| runlevel3 | `multi-user.target` |
| runlevel5 | `graphical.target`  |
| runlevel6 | `reboot.target`     |

ä½ å¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤åˆ‡æ¢ï¼š

```bash
systemctl isolate multi-user.target
systemctl isolate graphical.target
```



##### äº”ã€ä¾‹å­ 1ï¼šmulti-user.target å¯åŠ¨å“ªäº›æœåŠ¡ï¼Ÿ

```bash
systemctl list-dependencies multi-user.target
```

è¾“å‡ºä¸­ä½ ä¼šçœ‹åˆ°ï¼š

```css
â— multi-user.target
â”œâ”€network.target
â”œâ”€sshd.service
â”œâ”€crond.service
â”œâ”€...
```

ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™äº›æœåŠ¡ä¼šéšç€ `multi-user.target` ä¸€èµ·å¯åŠ¨ã€‚

![image-20250627161606152](D:\git_repository\cyber_security_learning\markdown_img\image-20250627161606152.png)

**é¢œè‰²è¯´æ˜ï¼š**

| é¢œè‰²           | å«ä¹‰                                                         |
| -------------- | ------------------------------------------------------------ |
| ğŸŸ¢ **ç»¿è‰²åœ†ç‚¹** | è¯¥æœåŠ¡å½“å‰ **å·²å¯åŠ¨ï¼ˆactive/runningï¼‰**ï¼ŒçŠ¶æ€æ­£å¸¸            |
| ğŸ”´ **çº¢è‰²åœ†ç‚¹** | è¯¥æœåŠ¡å½“å‰ **å¯åŠ¨å¤±è´¥ï¼ˆfailedï¼‰**ã€**æœªå¯åŠ¨ï¼ˆinactive/deadï¼‰** æˆ– **æ¡ä»¶ä¸æ»¡è¶³æœªæ‰§è¡Œ** |



##### **å…­ã€systemd çš„å›ºå®šæœºåˆ¶ï¼ˆæ ‡å‡†è¯­æ³•è§„åˆ™ï¼‰**

systemd **ä½¿ç”¨ `.wants/` å’Œ `.requires/` å­ç›®å½•ä½œä¸ºä¸€ç§çº¦å®šå¼çš„ä¾èµ–æœºåˆ¶**ï¼Œæ¥è¡¨ç¤ºï¼š

> â€œè¿™ä¸ª target æƒ³è¦ï¼ˆwantsï¼‰æˆ–éœ€è¦ï¼ˆrequiresï¼‰å“ªäº› unitã€‚â€

**åŸç†è§£é‡Š**

**å‡è®¾ä½ æœ‰è¿™ä¸ªç›®å½•ç»“æ„ï¼š**

```
/etc/systemd/system/multi-user.target.wants/
â”œâ”€â”€ sshd.service  â†’  /usr/lib/systemd/system/sshd.service
â”œâ”€â”€ nginx.service â†’  /usr/lib/systemd/system/nginx.service
```

é‚£ä¹ˆ systemd å¯åŠ¨ `multi-user.target` æ—¶å°±ä¼šï¼š

> **è‡ªåŠ¨åŠ è½½è¿™äº› symlink æ‰€æŒ‡å‘çš„ unit æ–‡ä»¶**ï¼Œå°±å¥½åƒä½ åœ¨ `multi-user.target` æ–‡ä»¶é‡Œå†™äº†ï¼š

```ini
Wants=sshd.service nginx.service
```



 **`.wants/` å’Œ `.requires/` æ˜¯ systemd çš„å†…å»ºæœºåˆ¶**

- `multi-user.target.wants/`ï¼šè¡¨ç¤ºâ€œæ¨èä¾èµ–â€ï¼Œå³ä½¿æœåŠ¡å¯åŠ¨å¤±è´¥ä¹Ÿä¸ä¼šå½±å“ target å¯åŠ¨ã€‚
- `multi-user.target.requires/`ï¼šè¡¨ç¤ºâ€œå¼ºåˆ¶ä¾èµ–â€ï¼Œå¦‚æœä¾èµ–é¡¹å¤±è´¥åˆ™æ•´ä¸ª target ä¹Ÿå¤±è´¥ã€‚

è¿™ä¸¤ä¸ªç›®å½•éƒ½æ˜¯è‡ªåŠ¨å…³è”çš„ï¼Œåªè¦ä½ å‘½åæˆï¼š

```php+HTML
<unit>.wants/
<unit>.requires/
```



#### ç¤ºä¾‹ï¼šè‡ªå·±åˆ›å»ºä¸€ä¸ªæœåŠ¡å¹¶æŒ‚è½½åˆ° target ä¸Š

å‡è®¾ä½ æœ‰ä¸€ä¸ªè‡ªå®šä¹‰æœåŠ¡ï¼š

```ini
cat > /etc/systemd/system/myapp.service <<EOF
[Unit]
Description=My App

[Service]
ExecStart=/usr/local/bin/myapp
Restart=always

[Install]
WantedBy=multi-user.target
EOF
```

ç„¶åæ‰§è¡Œï¼š

```bash
systemctl enable myapp.service
```

å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªé“¾æ¥ï¼š

```swift
/etc/systemd/system/multi-user.target.wants/myapp.service â†’ /etc/systemd/system/myapp.service
```



æ€»ç»“ï¼š

| é¡¹ç›®                       | è¯´æ˜                                                         |
| -------------------------- | ------------------------------------------------------------ |
| `multi-user.target.wants/` | è¡¨ç¤ºâ€œæ¨èåŠ è½½çš„æœåŠ¡â€ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨åŠ è½½è¿™äº›è½¯é“¾æ¥æŒ‡å‘çš„ service |
| å‘½åè¯­æ³•                   | å›ºå®šå‘½åï¼š`<unit>.wants/`ã€`<unit>.requires/`                |
| è‡ªåŠ¨åˆ›å»º                   | `systemctl enable xxx.service` ä¼šè‡ªåŠ¨åˆ›å»ºè½¯é“¾æ¥åˆ°å¯¹åº”çš„ `.wants/` ç›®å½• |
| ä½œç”¨                       | å°†æŸä¸ª unit ç»‘å®šåˆ°å¦ä¸€ä¸ª target ä¸‹ä½œä¸ºä¾èµ–è¿è¡Œ               |





#### ä¸€æ­¥æ­¥å®ç°ä½ è¯´çš„éœ€æ±‚ï¼šè‡ªå®šä¹‰ Target + æ§åˆ¶æœåŠ¡ç»„

##### âœ… æ­¥éª¤ 1ï¼šå®šä¹‰è‡ªå®šä¹‰ target

```ini
# /etc/systemd/system/myenv.target
[Unit]
Description=My Custom Environment
Requires=basic.target
After=basic.target
```

è¯´æ˜ï¼š

- `Requires=basic.target` è¡¨ç¤ºå®ƒä¾èµ–åŸºæœ¬ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼ˆå½“ç„¶ä½ å¯ä»¥æ¢æˆåˆ«çš„ï¼Œæ¯”å¦‚ `network.target`ï¼‰ã€‚
- `Description` å¯è‡ªå®šä¹‰ã€‚



##### âœ… æ­¥éª¤ 2ï¼šå®šä¹‰ä¸€ä¸ªä½ æƒ³æ‰˜ç®¡çš„æœåŠ¡ï¼ˆæˆ–å·²æœ‰æœåŠ¡ï¼‰

å‡è®¾å·²æœ‰ä¸€ä¸ªæœåŠ¡å« `myapp.service`ï¼š

```ini
# /etc/systemd/system/myapp.service
[Unit]
Description=My Test App
After=network.target

[Service]
ExecStart=/usr/bin/python3 /opt/myapp/app.py
Restart=always

[Install]
WantedBy=myenv.target
```

è¿™é‡Œçš„ `WantedBy=myenv.target` ä¼šåœ¨ä½ æ‰§è¡Œ `systemctl enable myapp.service` æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºé“¾æ¥ï¼š

```swift
/etc/systemd/system/myenv.target.wants/myapp.service â†’ /etc/systemd/system/myapp.service
```

ä½ ä¹Ÿå¯ä»¥æ‰‹åŠ¨åˆ›å»ºï¼š

```bash
mkdir -p /etc/systemd/system/myenv.target.wants/
ln -s /etc/systemd/system/myapp.service /etc/systemd/system/myenv.target.wants/myapp.service
```



##### âœ… æ­¥éª¤ 3ï¼šå¯åŠ¨ä½ è‡ªå®šä¹‰çš„ Target

```bash
systemctl daemon-reload
systemctl start myenv.target
```

æ­¤æ—¶ï¼š

- `myenv.target` è¢«å½“ä½œâ€œè¿è¡Œçº§åˆ«ç›®æ ‡â€
- å®ƒä¼šå¯åŠ¨ `myenv.target.wants/` ç›®å½•ä¸­é“¾æ¥çš„æ‰€æœ‰æœåŠ¡ï¼ˆå¦‚ `myapp.service`ï¼‰



##### âœ… æ­¥éª¤ 4ï¼šè®¾ç½®ä¸ºå¼€æœºè‡ªåŠ¨è¿›å…¥ä½ å®šä¹‰çš„ç¯å¢ƒï¼ˆå¯é€‰ï¼‰

```
systemctl enable myenv.target
```

æˆ–è€…è®¾ä¸ºé»˜è®¤ targetï¼š

```bash
systemctl set-default myenv.target
```



**ğŸ” ç”¨é€”ä¸¾ä¾‹**

| ä½ å®šä¹‰çš„ Target   | ä½œç”¨                                        |
| ----------------- | ------------------------------------------- |
| `mydev.target`    | å¼€å‘ç¯å¢ƒæ‰€éœ€çš„æœåŠ¡é›†ï¼ˆDev DBã€Appã€Loggerï¼‰ |
| `mydebug.target`  | å¼€å¯ debug å·¥å…·ï¼ˆsshdã€strace æœåŠ¡ç­‰ï¼‰      |
| `mysecure.target` | ä»…åŠ è½½å®‰å…¨å®¡è®¡ã€sshd ç­‰æœåŠ¡                 |



##### å®é™…ä½œç”¨

å¯ä»¥è¿™æ ·ä½¿ç”¨ `target` å®ç°ç¯å¢ƒåˆ‡æ¢

åœºæ™¯ä¸¾ä¾‹

| ç¯å¢ƒå        | å¯åŠ¨å†…å®¹                                 |
| ------------- | ---------------------------------------- |
| `dev.target`  | å¯åŠ¨ï¼šMySQLã€Nginxã€Python App           |
| `test.target` | å¯åŠ¨ï¼šPostgreSQLã€Flask Appã€Mock Server |
| `ops.target`  | å¯åŠ¨ï¼šsshdã€Prometheusã€Grafana          |



**æ¡Œé¢æˆ–å¼€å‘ç»ˆç«¯ä¸€æœºå¤šç¯å¢ƒ**

- æ¯”å¦‚å¼€å‘éƒ¨é—¨è‡ªå·±ç»´æŠ¤ä¸€å¼ å®šåˆ¶ Linux é•œåƒï¼š
  - `frontend.target`ï¼šè‡ªåŠ¨å¼€å¯ GUI + Chrome + IDE + NodeJS æœåŠ¡
  - `backend.target`ï¼šåªå¼€å¯æ•°æ®åº“ + API ç½‘å…³ + SSH
  - `training.target`ï¼šåªå¯åŠ¨å½•å±ã€è¿œç¨‹æ§åˆ¶ç­‰å­¦ä¹ å·¥å…·

ğŸ”§ *å¾ˆå¤šå¤§å‹äº’è”ç½‘å…¬å¸ï¼ˆå¦‚è…¾è®¯ã€é˜¿é‡Œï¼‰åœ¨â€œæ–°å‘˜å·¥ç¯å¢ƒå¿«é€Ÿé…ç½®â€æ—¶ä¼šä½¿ç”¨ç±»ä¼¼æ–¹æ¡ˆï¼Œä»¥ä¾¿ä¸€å¼  ISO æ»¡è¶³å¤šä¸ªå¼€å‘ç»„çš„éœ€æ±‚*



#### âœ… 6.  `.path` ç±»å‹ Unit â€” æ–‡ä»¶æˆ–ç›®å½•çš„â€œç›‘æ§è§¦å‘å™¨â€

`path` unit å…è®¸ä½ ç›‘æ§æ–‡ä»¶æˆ–ç›®å½•çš„å˜åŒ–ï¼ˆå¦‚åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼‰ï¼Œå½“æ»¡è¶³æ¡ä»¶æ—¶ï¼Œ**è‡ªåŠ¨æ¿€æ´»æŒ‡å®šçš„ service unit**ã€‚

##### å¸¸è§åœºæ™¯ï¼ˆç”Ÿäº§ç”¨ä¾‹ï¼‰ï¼š

âœ… ç¤ºä¾‹1ï¼šè‡ªåŠ¨è§£å‹ä¸Šä¼ çš„å‹ç¼©åŒ…

ç”¨æˆ·å°† `.zip` æ–‡ä»¶ä¸Šä¼ åˆ° `/data/uploads/`ï¼Œä½ æƒ³è®©ç³»ç»Ÿè‡ªåŠ¨è§¦å‘è§£å‹ã€‚

```ini
# /etc/systemd/system/unzip.path
[Unit]
Description=Watch /data/uploads/*.zip

[Path]
PathModified=/data/uploads/
Unit=unzip.service

[Install]
WantedBy=multi-user.target
```

```ini
# /etc/systemd/system/unzip.service
[Unit]
Description=Auto-unzip uploaded files

[Service]
ExecStart=/usr/local/bin/unzip-latest.sh
```

è¿™æ ·ï¼Œå½“ `/data/uploads/` ç›®å½•æœ‰ä¿®æ”¹æ—¶ï¼ˆå¦‚ä¸Šä¼ äº† zipï¼‰ï¼Œ`unzip.service` å°±ä¼šè‡ªåŠ¨è¿è¡Œã€‚



##### âœ… ç¤ºä¾‹2ï¼šè‡ªåŠ¨åŒæ­¥ nginx é…ç½®å˜æ›´

```bash
# /etc/systemd/system/nginx-reload.path
[Path]
PathChanged=/etc/nginx/nginx.conf
Unit=nginx-reload.service

# /etc/systemd/system/nginx-reload.service
[Service]
ExecStart=/usr/bin/systemctl reload nginx
```

è¿™å¯ä»¥ä»£æ›¿æ‰‹åŠ¨ `inotify` è„šæœ¬ï¼Œéå¸¸é€‚åˆåšé…ç½®çƒ­æ›´æ–°ã€‚



**âœ… å¸¸è§å‚æ•°**

| å‚æ•°å            | å«ä¹‰                                   |
| ----------------- | -------------------------------------- |
| `PathExists=`     | æ–‡ä»¶å­˜åœ¨æ—¶è§¦å‘                         |
| `PathExistsGlob=` | ä½¿ç”¨é€šé…ç¬¦åŒ¹é…å¤šä¸ªæ–‡ä»¶                 |
| `PathChanged=`    | æ–‡ä»¶è¢«å†™å…¥æ—¶è§¦å‘ï¼ˆå«ä¿®æ”¹æƒé™ã€æ—¶é—´æˆ³ï¼‰ |
| `PathModified=`   | æ–‡ä»¶å†…å®¹å‘ç”Ÿä¿®æ”¹æ—¶è§¦å‘                 |
| `Unit=`           | å…³è”çš„ `.service`ï¼Œç›‘æ§è§¦å‘åæ‰§è¡Œå®ƒ    |





#### âœ… 7. `.slice` ç±»å‹ Unit â€” æ§åˆ¶èµ„æºä½¿ç”¨ï¼ˆCPU/å†…å­˜ï¼‰åˆ†ç»„

`slices` æ˜¯ `systemd` åŸºäº cgroups å®ç°çš„èµ„æºç®¡ç†æœºåˆ¶ã€‚ä½ å¯ä»¥æŠŠä¸åŒæœåŠ¡æˆ–ç”¨æˆ·å½’ç±»åˆ°æŸä¸ª `.slice` ä¸­ï¼Œå¯¹å…¶ **åˆ†é… CPUã€å†…å­˜ã€IO é™åˆ¶ç­‰èµ„æºé™åˆ¶**ã€‚



#####  å¸¸è§åœºæ™¯ï¼ˆç”Ÿäº§ç”¨ä¾‹ï¼‰ï¼š

**âœ… ç¤ºä¾‹1ï¼šé™åˆ¶æŸæœåŠ¡æœ€å¤šåªèƒ½ç”¨ 512MB å†…å­˜**

```ini
# /etc/systemd/system/myapp.slice
[Slice]
MemoryMax=512M
CPUQuota=50%
```

ç„¶ååœ¨ä½ çš„æœåŠ¡ä¸­æŒ‡å®šä½¿ç”¨å®ƒï¼š

```ini
# /etc/systemd/system/myapp.service
[Service]
Slice=myapp.slice
```

è¯¥æœåŠ¡å°±ä¼šè¢«æ§åˆ¶åœ¨ `myapp.slice` é™å®šçš„èµ„æºèŒƒå›´å†…ã€‚



**âœ… ç¤ºä¾‹2ï¼šç»™ä¸åŒç”¨æˆ·æˆ–ç§Ÿæˆ·åˆ’å®šèµ„æºç»„**

```ini
# user1.slice
[Slice]
MemoryMax=1G
CPUQuota=80%

# user2.slice
[Slice]
MemoryMax=500M
CPUQuota=20%
```



ä½ å¯ä»¥ç”¨ `systemd-run` å¯åŠ¨æŸä¸ªå‘½ä»¤ç»‘å®šç‰¹å®š sliceï¼š

```bash
systemd-run --slice=user1.slice /usr/bin/myapp
```



##### âœ… slice åˆ†çº§ç»“æ„ï¼ˆç»§æ‰¿ï¼‰ï¼š

- `-.slice`ï¼šæ ¹ sliceï¼Œç³»ç»Ÿçº§è¿›ç¨‹åœ¨æ­¤
- `system.slice`ï¼šé»˜è®¤æ‰€æœ‰æœåŠ¡å½’å±è¿™é‡Œ
- `user.slice`ï¼šç”¨æˆ·ç™»å½• session é»˜è®¤æŒ‚åœ¨æ­¤

ä½ å¯ä»¥åµŒå¥—ï¼Œä¾‹å¦‚ï¼š

```bash
Slice=system.mygroup.slice
```

è¿™ä¼šæ”¾åˆ° `system.slice â†’ mygroup.slice` ä¸‹ã€‚



##### âœ… æ”¯æŒçš„èµ„æºå‚æ•°ï¼ˆå¸¸è§ cgroup æ§åˆ¶ï¼‰ï¼š

| å‚æ•°å      | å«ä¹‰                |
| ----------- | ------------------- |
| `CPUQuota`  | é™åˆ¶ CPU å ç”¨ç™¾åˆ†æ¯” |
| `MemoryMax` | é™åˆ¶æœ€å¤§å†…å­˜        |
| `IOWeight`  | ç£ç›˜ IO æƒé‡        |
| `TasksMax`  | æœ€å¤§è¿›ç¨‹/çº¿ç¨‹æ•°     |





### systemdæ–‡ä»¶

åŠŸèƒ½ï¼šè®©systemdæ¥ç®¡è¯¥æœåŠ¡

serviceæ–‡ä»¶æ ¼å¼

```shell
#ç”±ä¸‰ä¸ªè¯­å¥å—ç»„æˆï¼Œåˆ†åˆ«æ˜¯[Unit][Service][Install]
# [Unit] é‡Œé¢æ˜¯å…³äºè¿™ä¸ªæœåŠ¡å•å…ƒçš„æè¿°ä¿¡æ¯ä¸ä¾èµ–å…³ç³»
# ä¿®æ”¹serviceä¿¡æ¯åï¼Œéœ€è¦æ‰§è¡Œsystemctl daemon=reloadæ‰èƒ½ä½¿å…¶ç”Ÿæ•ˆ
[Unit]
# æè¿°æ–‡æœ¬
Description=Job spooling tools
# Afterè¡¨æ˜ï¼Œè¯¥æœåŠ¡å¿…é¡»åœ¨ä¸‹åˆ—æœåŠ¡å¯åŠ¨åï¼Œæ‰èƒ½æ‰§è¡Œï¼Œå³å†™æ˜äº†è¯¥æœåŠ¡çš„ä¾èµ–å…³ç³»
After=syslog.target systemd-user-sessions.service

[Service]
# EnvironmentFileæŒ‡æ˜äº†å£°æ˜å˜é‡çš„æ–‡ä»¶ï¼ŒæŒ‡æ˜åå¯ä»¥ç›´æ¥è°ƒç”¨
EnvironmentFile=/etc/sysconfig/atd
# ExecStartè¿™ä¸ªæ‰æ˜¯æœåŠ¡å¯åŠ¨æ—¶ï¼Œè¿è¡Œçš„æŒ‡ä»¤
ExecStart=/usr/sbin/atd -f $OPTS
# è¡¨ç¤ºæ˜¯å¦æ”¯æŒä¿¡å·
IgnoreSIGPIPE=no

[Install]
WantedBy=multi-user.target
```

service unit fileæ–‡ä»¶é€šå¸¸ç”±ä¸‰éƒ¨åˆ†ç»„æˆ

- [Unit]: å®šä¹‰ä¸Unitç±»å‹æ— å…³çš„é€šç”¨é€‰é¡¹ï¼›ç”¨äºæä¾›unitçš„æè¿°ä¿¡æ¯ï¼Œunitè¡Œä¸ºåŠä¾èµ–å…³ç³»ç­‰

- [Service]ï¼šä¸ç‰¹å®šç±»å‹ç›¸å…³çš„ä¸“ç”¨é€‰é¡¹ï¼Œæ­¤å¤„ä¸ºServiceç±»å‹

- [Install]ï¼šå®šä¹‰ç”±"systemclt enable"ä»¥åŠ"systemctl disable"å‘½ä»¤åœ¨å®ç°æœåŠ¡å¯ç”¨æˆ–ç¦ç”¨æ—¶ç”¨åˆ°çš„ä¸€äº›é€‰é¡¹

Unitæ®µçš„å¸¸ç”¨é€‰é¡¹

- Descriptionï¼šæè¿°ä¿¡æ¯

- Afterï¼šå®šä¹‰Unitçš„å¯åŠ¨æ¬¡åºï¼Œè¡¨ç¤ºå½“å‰Unitåº”è¯¥æ™šäºå“ªäº›Unitå¯åŠ¨ï¼Œå…¶åŠŸèƒ½ä¸Beforeç›¸å

- Requiresï¼šä¾èµ–åˆ°çš„å…¶ä»–unitsï¼Œå¼ºä¾èµ–ï¼Œè¢«ä¾èµ–çš„unitesæ— æ³•æ¿€æ´»æ—¶ï¼Œå½“å‰unitä¹Ÿæ— æ³•æ¿€æ´»

- Wantsï¼šä¾èµ–åˆ°çš„å…¶å®ƒunitsï¼Œå¼±ä¾èµ–

- Conflictsï¼šå®šä¹‰unitsé—´çš„å†²çªå…³ç³»

  > æŒ‡å®šä¸å½“å‰ unit **å†²çª** çš„å…¶ä»– unitï¼Œ**ä¸€æ—¦å½“å‰ unit å¯åŠ¨ï¼Œå†²çªçš„ unit ä¼šè¢«è‡ªåŠ¨åœæ­¢ï¼›åä¹‹äº¦ç„¶**ã€‚
  >
  > å®ƒçš„æœ¬è´¨è¡Œä¸ºæ˜¯ï¼š**äº’æ–¥å¯åŠ¨**ã€‚

Serviceæ®µçš„å¸¸ç”¨é€‰é¡¹

- Typeï¼šå®šä¹‰å½±å“ExecStartåŠç›¸å…³å‚æ•°çš„åŠŸèƒ½çš„unitè¿›ç¨‹å¯åŠ¨ç±»å‹

  - simple: é»˜è®¤å€¼ï¼Œè¿™ä¸ªdaemonä¸»è¦ç”±ExecStartæ¥çš„æŒ‡ä»¤ä¸²æ¥å¯åŠ¨ï¼Œå¯åŠ¨åå¸¸é©»äºå†…å­˜ä¸­

    > simpleæ˜¯å½“å‰è¿›ç¨‹é€€å‡ºï¼Œsystemdå°±ç»“æŸé€€å‡ºäº†
    >
    > æ‰€ä»¥å¦‚æœç”¨è„šæœ¬å°è£…å¿…é¡»ä½¿ç”¨execï¼Œä½¿å…¶ä¿è¯å‰å°æŒç»­è¿è¡Œï¼Œå¦‚æœæ˜¯åå°è¿è¡Œï¼Œå°±æ˜¯ç”¨forking

  - forkingï¼šç”±ExecStartå¯åŠ¨çš„ç¨‹åºé€è¿‡spawnså»¶ä¼¸å‡ºå…¶ä»–å­ç¨‹åºæ¥ä½œä¸ºæ­¤daemonçš„ä¸»è¦æœåŠ¡ï¼ŒåŸç”Ÿçˆ¶è¿›ç¨‹åœ¨å¯åŠ¨ç»“æŸåå°±åœæ­¢

    > ä»¥ MySQL ä¸ºä¾‹
    >
    > ```bash
    > systemd
    > â””â”€â”€ ExecStart=/usr/bin/mysqld_safe   â† çˆ¶è¿›ç¨‹
    >    â””â”€â”€ fork å‡º /usr/sbin/mysqld  â† çœŸæ­£è¿è¡Œçš„ daemonï¼ˆå­è¿›ç¨‹ï¼‰
    > ```
    >
    > systemd æœ€åˆå¯åŠ¨çš„æ˜¯ `mysqld_safe`ï¼Œå®ƒåªæ˜¯ä¸ªè„šæœ¬ï¼Œä¸æ˜¯çœŸæ­£æœåŠ¡ï¼Œå®ƒ fork å‡º `mysqld` åå°±ç»“æŸäº†ã€‚
    >
    > ä½¿ç”¨forkingï¼Œå¿…é¡»åˆ›å»ºPIDï¼Œå¦åˆ™ systemd åªèƒ½ `GuessMainPID`ï¼Œå¸¸å¸¸ä¸å‡†

  - oneshotï¼šä¸simpleç±»ä¼¼ï¼Œä¸è¿‡è¿™ä¸ªç¨‹åºåœ¨å·¥ä½œå®Œæ¯•åå°±ç»“æŸäº†ï¼Œä¸ä¼šå¸¸é©»åœ¨å†…å­˜ä¸­ï¼Œé€šå¸¸ç”¨äºå®šæ—¶ä»»åŠ¡

    > åˆ›å»ºä¸¤ä¸ª unitï¼š
    >
    > `backup.service`ï¼ˆæ‰§è¡Œå†…å®¹ï¼‰ï¼š
    >
    > ```ini
    > [Unit]
    > Description=Backup MySQL database
    > 
    > [Service]
    > Type=oneshot
    > ExecStart=/usr/local/bin/backup.sh
    > ```
    >
    > ä¿å­˜ä¸º `/etc/systemd/system/backup.service`
    >
    > `backup.timer`ï¼ˆå®šæ—¶è§¦å‘ï¼‰ï¼š
    >
    > ```ini
    > [Unit]
    > Description=Run backup daily at 1am
    > 
    > [Timer]
    > OnCalendar=*-*-* 01:00:00
    > Persistent=true
    > 
    > [Install]
    > WantedBy=timers.target
    > ```
    >
    > ä¿å­˜ä¸º `/etc/systemd/system/backup.timer`

  - dbusï¼šä¸simpleç±»ä¼¼ï¼Œä½†è¿™ä¸ªdaemonå¿…é¡»åœ¨å–å¾—ä¸€ä¸ªD-Busçš„åç§°ä¹‹åï¼Œæ‰ä¼šç»§ç»­è¿ä½œï¼Œå› æ­¤é€šå¸¸ä¹Ÿè¦åŒæ—¶è®¾å®šBusName=æ‰è¡Œ

  - notifyï¼šåœ¨å¯åŠ¨å®Œæˆåä¼šå‘é€ä¸€ä¸ªé€šçŸ¥ä¿¡æ¯ï¼Œè¦éœ€è¦é…åˆNotifyAccessæ¥è®©Systemdæ¥æ”¶ä¿¡æ¯

    > åªè¦ä½ åœ¨ unit æ–‡ä»¶ä¸­ä½¿ç”¨äº† `Type=notify`ï¼Œä½ å°±å¿…é¡»ç¡®ä¿ç¨‹åºèƒ½å¤Ÿå‘å‡º `READY=1` çš„é€šçŸ¥ï¼Œå¦åˆ™ systemd æ— æ³•åˆ¤æ–­æœåŠ¡æ˜¯å¦å°±ç»ªï¼Œä¼šè¯¯åˆ¤ä¸ºå¯åŠ¨å¤±è´¥ã€‚
    >
    > **å®ç°æ–¹å¼ï¼ˆé€‰æ‹©å…¶ä¸€ï¼‰ï¼š**
    >
    > | æ–¹æ³•              | è¯´æ˜                                                         |
    > | ----------------- | ------------------------------------------------------------ |
    > | ä½¿ç”¨ C ç¼–å†™çš„ç¨‹åº | è°ƒç”¨ `sd_notify(0, "READY=1");`ï¼ˆæ¥è‡ª `<systemd/sd-daemon.h>`ï¼‰ |
    > | ä½¿ç”¨ CLI å·¥å…·     | `systemd-notify --ready`ï¼ˆé€‚åˆ shell è„šæœ¬ï¼‰                  |
    > | ä½¿ç”¨ Python       | ä½¿ç”¨ `python-systemd` åº“çš„ `sd_notify()` å‡½æ•°                |
    > | å…¶ä»–è¯­è¨€          | Goã€Rust ç­‰ä¹Ÿæœ‰ systemd çš„é€šçŸ¥åº“å¯ç”¨                         |

  - idleï¼šä¸simpleç±»ä¼¼ï¼Œè¦æ‰§è¡Œè¿™ä¸ªdaemonå¿…é¡»è¦æ‰€æœ‰çš„å·¥ä½œéƒ½é¡ºåˆ©è¿›è¡Œå®Œæ¯•åæ‰ä¼šæ‰§è¡Œã€‚è¿™ç±»çš„daemoné€šå¸¸æ˜¯å¼€æœºåˆ°æœ€åæ‰æ‰§è¡Œå³å¯çš„æœåŠ¡

- **EnvironmentFile**: ç¯å¢ƒé…ç½®æ–‡ä»¶

- **ExecStart**ï¼šæŒ‡æ˜å¯åŠ¨unitè¦è¿è¡Œå‘½ä»¤æˆ–è„šæœ¬çš„ç»å¯¹è·¯å¾„

- **ExecStartPre**: ExecStartå‰è¿è¡Œ

- **ExecStartpost**ï¼šExecStartåè¿è¡Œ

- **ExecStop**ï¼šæŒ‡æ˜åœæ­¢unitè¦è¿è¡Œçš„å‘½ä»¤æˆ–è„šæœ¬

- **Restart**ï¼šå½“è®¾å®šRestart=1æ—¶ï¼Œåˆ™å½“æ¬¡daemonæœåŠ¡ä»¥å¤–ç»ˆæ­¢åï¼Œä¼šå†æ¬¡è‡ªåŠ¨å¯åŠ¨æ­¤æœåŠ¡

Installæ®µçš„å¸¸ç”¨é€‰é¡¹

- Aliasï¼šåˆ«åï¼Œå¯ä½¿ç”¨systemctl commandAlias.service


socketæ–‡ä»¶æ ¼å¼

```shell
[Unit]
Description=Telnet Server Activation Socket
Documentation=man:telnetd(8)

[Socket]
ListenStream=23
Accept=true

[Install]
WantedBy=sockets.target
```

#### å†™serviceæ–‡ä»¶çš„æŠ€å·§

- å€Ÿé‰´rpmåŒ…å®‰è£…çš„æœåŠ¡ï¼ˆåœ¨å…¶ä»–æœåŠ¡å™¨ï¼Œä½¿ç”¨yumå®‰è£…ï¼Œçœ‹ä¸‹å®‰è£…åŒ…ç”Ÿæˆçš„serviceæ–‡ä»¶ï¼‰ï¼Œç„¶åçœ‹ä¸‹åˆ«äººçš„å†™æ³•ï¼Œç„¶åæ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œè°ƒæ•´









# ç³»ç»Ÿæ€§èƒ½

## CPUè´Ÿè½½ - top

å¹³å‡è´Ÿè½½æ˜¯æŒ‡å•ä½æ—¶é—´å†…ï¼Œç³»ç»Ÿå¤„äºå¯è¿è¡ŒçŠ¶æ€å’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„å¹³å‡è¿›ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯å¹³å‡æ´»è·ƒè¿›ç¨‹æ•°

å½“å¹³å‡è´Ÿè½½é«˜äº CPU æ•°é‡ 70% çš„æ—¶å€™ï¼Œä½ å°±åº”è¯¥åˆ†ææ’æŸ¥è´Ÿè½½é«˜çš„é—®é¢˜äº†ã€‚

å¹³å‡è´Ÿè½½æ˜¯æŒ‡å•ä½æ—¶é—´å†…ï¼Œå¤„äºå¯è¿è¡ŒçŠ¶æ€å’Œä¸å¯ä¸­æ–­çŠ¶æ€çš„è¿›ç¨‹æ•°ã€‚æ‰€ä»¥ï¼Œå®ƒä¸ä»…åŒ…æ‹¬äº†**æ­£åœ¨ä½¿ç”¨ CPU çš„è¿›ç¨‹**ï¼Œ**è¿˜åŒ…æ‹¬ç­‰å¾… CPU** å’Œ**ç­‰å¾… I/O çš„è¿›ç¨‹ã€‚**



R = è¿è¡Œä¸­è¿›ç¨‹ + å°±ç»ªæ€è¿›ç¨‹ï¼ˆä¸‡äº‹ä¿±å¤‡ï¼Œåªæ¬ CPUï¼‰



### **ä»€ä¹ˆæ˜¯ iowaitï¼Ÿ**

`iowait` æ˜¯ **ç³»ç»Ÿä¸­è‡³å°‘æœ‰è¿›ç¨‹åœ¨ç­‰å¾…å—è®¾å¤‡ I/O**ï¼ˆå¦‚ç£ç›˜ï¼‰ï¼Œ**è€Œå½“å‰ CPU æ ¸å¿ƒä¸Šæ²¡æœ‰å…¶ä»–å°±ç»ªä»»åŠ¡å¯è°ƒåº¦æ—¶çš„ç©ºè½¬ç­‰å¾…æ—¶é—´**ã€‚

å¦‚æœæœ‰åˆ«çš„è¿›ç¨‹ï¼ˆR çŠ¶æ€ï¼‰åœ¨ç­‰ç€è¿è¡Œï¼Œé‚£ä¹ˆï¼š

- CPU ä¸ä¼šâ€œç­‰ç€ I/Oâ€ï¼›
- å®ƒç›´æ¥å»è·‘å…¶ä»–è¿›ç¨‹ï¼›
- **è¿™ä¸ªâ€œç­‰å¾… I/O çš„æ—¶é—´â€å°±ä¸ä¼šè¢«ç»Ÿè®¡è¿› iowaitï¼Œè€Œæ˜¯è®©åˆ«çš„è¿›ç¨‹ç”¨ä¸Šäº† CPUã€‚**

```basic
åœ¨ä¸€ä¸ªâ€œCPU æ¯”è¾ƒç¹å¿™ã€ä»»åŠ¡å¯†é›†â€çš„æœåŠ¡å™¨ä¸Šï¼Œiowait å¾€å¾€å¾ˆä½ç”šè‡³æ¥è¿‘ 0ï¼Œå³ä½¿æœ‰å¤§é‡ I/O é˜»å¡çš„è¿›ç¨‹å­˜åœ¨ã€‚
```





**D çŠ¶æ€ â‰  iowait**

| é¡¹ç›®       | å«ä¹‰                                                     | å±äºè°            |
| ---------- | -------------------------------------------------------- | ----------------- |
| **D çŠ¶æ€** | è¿›ç¨‹çŠ¶æ€ç ä¹‹ä¸€ï¼šä¸å¯ä¸­æ–­çš„ç¡çœ ï¼ˆ`TASK_UNINTERRUPTIBLE`ï¼‰ | å±äºè¿›ç¨‹          |
| **iowait** | CPU èŠ±åœ¨ç­‰å¾… I/O å®Œæˆçš„æ—¶é—´ç™¾åˆ†æ¯”                        | å±äº CPU æ—¶é—´ç»Ÿè®¡ |

**æ€»ç»“**

| ç±»åˆ«                        | æ˜¯å¦ D çŠ¶æ€ | æ˜¯å¦è®¡å…¥ iowait | ä¸¾ä¾‹                |
| --------------------------- | ----------- | --------------- | ------------------- |
| é˜»å¡ç£ç›˜ I/O                | âœ…           | âœ…               | è¯»å–æ…¢ç›˜ã€fsync å¡  |
| ç½‘ç»œå­˜å‚¨æŒ‚èµ·                | âœ…           | âŒï¼ˆè§†é©±åŠ¨å®ç°ï¼‰ | NFS æ‰çº¿ã€CIFS å‡æ­» |
| è®¾å¤‡å“åº”é˜»å¡                | âœ…           | âŒ               | æ‘„åƒå¤´ã€ä¸²å£ç­‰      |
| å†…æ ¸é”ç­‰å¾…                  | âœ…           | âŒ               | å†…æ ¸çº¿ç¨‹åŒæ­¥é˜»å¡    |
| å†…å­˜å›æ”¶ã€flushã€jbd2       | âœ…           | âŒï¼ˆé€šå¸¸ï¼‰       | kswapdã€jbd2 å¡     |
| è¿›ç¨‹ `sleep()` / `select()` | âŒï¼ˆS çŠ¶æ€ï¼‰ | âŒ               | ç¡çœ ã€socket é˜»å¡   |







## å‹åŠ›æµ‹è¯•å·¥å…· stress

### mpstat

mpstat æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„**å¤šæ ¸ CPU æ€§èƒ½åˆ†æå·¥å…·**ï¼Œç”¨æ¥å®æ—¶æŸ¥çœ‹æ¯ä¸ª CPU çš„æ€§èƒ½æŒ‡æ ‡ï¼Œä»¥åŠæ‰€æœ‰ CPU çš„å¹³å‡æŒ‡æ ‡ã€‚

### pidstat

pidstat æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„**è¿›ç¨‹æ€§èƒ½åˆ†æå·¥å…·**ï¼Œç”¨æ¥å®æ—¶æŸ¥çœ‹è¿›ç¨‹çš„ CPUã€å†…å­˜ã€I/O ä»¥åŠä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰æ€§èƒ½æŒ‡æ ‡ã€‚



### åœºæ™¯ä¸€ï¼šCPU å¯†é›†å‹è¿›ç¨‹

æŸ¥çœ‹åˆå§‹uptimeå¹³å‡è´Ÿè½½æƒ…å†µ

```bash
[root@ubuntu2204 ~]#uptime
 22:27:48 up 10:43,  3 users,  load average: 0.14, 0.10, 0.03
```



ä½¿ç”¨ stress æ¨¡æ‹Ÿä¸€ä¸ª CPU ä½¿ç”¨ç‡ 100% çš„åœºæ™¯

```bash
[root@ubuntu2204 ~]#stress --cpu 1 --timeout 600
stress: info: [2767] dispatching hogs: 1 cpu, 0 io, 0 vm, 0 hdd
```

åœ¨ç¬¬äºŒä¸ªç»ˆç«¯è¿è¡Œ uptime æŸ¥çœ‹å¹³å‡è´Ÿè½½çš„å˜åŒ–æƒ…å†µï¼š

```bash
# -d å‚æ•°è¡¨ç¤ºé«˜äº®æ˜¾ç¤ºå˜åŒ–çš„åŒºåŸŸ
[root@ubuntu2204 ~]# watch -d uptime
```

![image-20250627222924276](D:\git_repository\cyber_security_learning\markdown_img\image-20250627222924276.png)

æœ€åï¼Œåœ¨ç¬¬ä¸‰ä¸ªç»ˆç«¯è¿è¡Œ mpstat æŸ¥çœ‹ CPU ä½¿ç”¨ç‡çš„å˜åŒ–æƒ…å†µï¼š

```bash
# -P ALL è¡¨ç¤ºç›‘æ§æ‰€æœ‰CPUï¼Œåé¢æ•°å­—5è¡¨ç¤ºé—´éš”5ç§’åè¾“å‡ºä¸€ç»„æ•°æ®
$ mpstat -P ALL 5
```

![image-20250627223047164](D:\git_repository\cyber_security_learning\markdown_img\image-20250627223047164.png)

ä»ç»ˆç«¯äºŒä¸­å¯ä»¥çœ‹åˆ°ï¼Œ1 åˆ†é’Ÿçš„å¹³å‡è´Ÿè½½ä¼šæ…¢æ…¢å¢åŠ åˆ° 1.00ï¼Œè€Œä»ç»ˆç«¯ä¸‰ä¸­è¿˜å¯ä»¥çœ‹åˆ°ï¼Œæ­£å¥½æœ‰ä¸€ä¸ª **CPU çš„ä½¿ç”¨ç‡ä¸º 100%**ï¼Œä½†å®ƒçš„ **iowait åªæœ‰ 0**ã€‚è¿™è¯´æ˜ï¼Œå¹³å‡è´Ÿè½½çš„å‡é«˜æ­£æ˜¯ç”±äº CPU ä½¿ç”¨ç‡ä¸º 100% ã€‚



æŸ¥çœ‹åˆ°åº•æ˜¯**å“ªä¸ªè¿›ç¨‹å¯¼è‡´äº† CPU ä½¿ç”¨ç‡ä¸º 100%** å‘¢ï¼Ÿä½¿ç”¨ pidstat æ¥æŸ¥è¯¢

```bash
# é—´éš”5ç§’åè¾“å‡ºä¸€ç»„æ•°æ®
pidstat -u 5 1
```

![image-20250627223913842](D:\git_repository\cyber_security_learning\markdown_img\image-20250627223913842.png)



### åœºæ™¯äºŒï¼šI/O å¯†é›†å‹è¿›ç¨‹

é¦–å…ˆè¿˜æ˜¯è¿è¡Œ stress å‘½ä»¤ï¼Œä½†è¿™æ¬¡æ¨¡æ‹Ÿ I/O å‹åŠ›ï¼Œå³ä¸åœåœ°æ‰§è¡Œ syncï¼š

```bash
[root@ubuntu2204 ~]#stress -i 1 --timeout 600
stress: info: [2872] dispatching hogs: 0 cpu, 1 io, 0 vm, 0 hd
```

è¿˜æ˜¯åœ¨ç¬¬äºŒä¸ªç»ˆç«¯è¿è¡Œ uptime æŸ¥çœ‹å¹³å‡è´Ÿè½½çš„å˜åŒ–æƒ…å†µï¼š

```bash
$ watch -d uptime
```

![image-20250627224936872](D:\git_repository\cyber_security_learning\markdown_img\image-20250627224936872.png)

ç¬¬ä¸‰ä¸ªç»ˆç«¯è¿è¡Œ mpstat æŸ¥çœ‹ CPU ä½¿ç”¨ç‡çš„å˜åŒ–æƒ…å†µï¼š

![image-20250627225018966](D:\git_repository\cyber_security_learning\markdown_img\image-20250627225018966.png)

ä¸ºä»€ä¹ˆ sys é«˜è€Œ iowait ä½
ç³»ç»Ÿè°ƒç”¨çš„é«˜é¢‘ç‡ï¼š

stress -i å¯åŠ¨çš„ I/O å·¥ä½œè€…é€šå¸¸ä¼šè¿›è¡Œå¤§é‡çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå¦‚ read() å’Œ write()ï¼Œè¿™äº›è°ƒç”¨ä¼šæ¶ˆè€—å¤§é‡çš„ç³»ç»Ÿæ€ CPU æ—¶é—´ã€‚å› æ­¤ï¼Œ%sys é«˜æ˜¯å› ä¸ºå¤§é‡çš„ CPU æ—¶é—´èŠ±è´¹åœ¨å¤„ç†ç³»ç»Ÿè°ƒç”¨ä¸Šã€‚
ä½ iowaitï¼š

%iowait ä½è¡¨ç¤º CPU å‡ ä¹æ²¡æœ‰åœ¨ç­‰å¾…å®é™…çš„ I/O æ“ä½œå®Œæˆã€‚è¿™æ˜¯å› ä¸º I/O å·¥ä½œè€…ä¸»è¦åœ¨æ‰§è¡Œå¿«é€Ÿçš„ I/O æ“ä½œï¼Œè¿™äº›æ“ä½œå¯èƒ½æ˜¯å†…å­˜åˆ°å†…å­˜çš„ I/Oï¼ˆå¦‚ç¼“å†²åŒºæ“ä½œï¼‰æˆ–è€…æ˜¯ä¸€äº›å°è€Œå¿«çš„ I/O æ“ä½œï¼Œè€Œä¸æ˜¯é•¿æ—¶é—´çš„ç£ç›˜ I/Oã€‚



ä½¿ç”¨straceè·Ÿè¸ªstressçš„ç³»ç»Ÿè°ƒç”¨å¹¶ç»Ÿè®¡

```bash
[root@ubuntu2204 ~]#strace -cp 2873
strace: Process 2873 attached
% time     seconds  usecs/call     calls    errors syscall
------ ----------- ----------- --------- --------- ----------------
100.00   57.669753          15   3749561           sync
------ ----------- ----------- --------- --------- ----------------
100.00   57.669753          15   3749561           total
```



è·Ÿè¸ªæœŸé—´ï¼Œå‘ç”ŸCPUåˆ‡æ¢ï¼Œå¹¶ä¸”%sysä¸‹é™



> strace ä¼šè®©æ¯ä¸ªç³»ç»Ÿè°ƒç”¨éƒ½è¢«ä¸­æ–­ã€è®°å½•ã€ç¡®è®¤åæ‰æ¢å¤æ‰§è¡Œï¼Œæå¤§é™ä½äº†è¿›ç¨‹å®é™…åœ¨å†…æ ¸æ€æ‰§è¡Œçš„æ•ˆç‡ï¼Œå› æ­¤è¡¨ç°ä¸º `%sys` æ˜æ˜¾ä¸‹é™ã€‚
>
> åŒæ—¶ **æ¯æ¬¡ `strace` æ‹¦æˆªçš„ç³»ç»Ÿè°ƒç”¨ï¼Œç¡®å®æœ‰å¯èƒ½å¯¼è‡´ CPU åˆ‡æ¢ï¼ˆä¸Šä¸‹æ–‡è¿ç§»ã€æ ¸é—´è¿ç§»ï¼‰**ï¼Œç‰¹åˆ«æ˜¯åœ¨é«˜é¢‘ç‡ç³»ç»Ÿè°ƒç”¨åœºæ™¯ä¸‹ï¼ˆå¦‚ `stress -i`ï¼‰ï¼Œæ›´å®¹æ˜“å‘ç”Ÿé¢‘ç¹çš„è°ƒåº¦å™¨å¹²é¢„ã€‚



### åœºæ™¯ä¸‰ï¼šå¤§é‡è¿›ç¨‹åœºæ™¯

ä½¿ç”¨stressæ¨¡æ‹Ÿ8ä¸ªè¿›ç¨‹

```shell
stress -c 8 --timeout 600
```

ç”±äºç³»ç»Ÿåªæœ‰2ä¸ªCPUï¼Œæ˜æ˜¾æ¯”8ä¸ªCPUå°‘çš„å¤šï¼Œå› è€Œç³»ç»Ÿçš„CPUå¤„äºä¸¥é‡è¿‡è½½çŠ¶æ€ï¼Œå¹³å‡è´Ÿè½½é«˜åº¦ä¸º8.17

è¿è¡Œpidstatæ¥çœ‹ä¸€ä¸‹æƒ…å†µ

```shell
root@mystical:~# pidstat -u 5 1
Linux 5.15.0-100-generic (mystical)     07/19/24        _x86_64_        (2 CPU)

17:18:00      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command
17:18:05        0      1774    0.00    0.20    0.00    0.20    0.20     0  kworker/0:0-events
17:18:05        0      6957   24.06    0.60    0.00   75.35   24.65     1  stress
17:18:05        0      6958   24.25    0.40    0.00   75.35   24.65     0  stress
17:18:05        0      6959   24.06    0.40    0.00   74.35   24.45     0  stress
17:18:05        0      6960   23.86    0.80    0.00   75.15   24.65     1  stress
17:18:05        0      6961   23.86    0.60    0.00   75.35   24.45     1  stress
17:18:05        0      6962   25.25    0.20    0.00   74.35   25.45     0  stress
17:18:05        0      6963   24.25    0.40    0.00   75.15   24.65     1  stress
17:18:05        0      6964   24.65    0.00    0.00   74.95   24.65     0  stress
17:18:05        0      7592    0.00    0.40    0.00    0.20    0.40     1  kworker/1:0-event
```

#### æ€»ç»“

- å¹³å‡è´Ÿè½½é«˜ï¼Œæœ‰å¯èƒ½æ˜¯CPUå¯†é›†å‹è¿›ç¨‹å¯¼è‡´çš„
- å¹³å‡è´Ÿè½½é«˜å¹¶ä¸ä¸€å®šæ˜¯CPUä½¿ç”¨ç‡é«˜ï¼Œè¿˜å¯èƒ½æ˜¯IOç¹å¿™
- å¤šä¸ªè¿›ç¨‹ç«äº‰CPUï¼Œå¯¼è‡´å¹³å‡è´Ÿè½½å‡é«˜





## å†…å­˜ - free





## ç½‘ç»œè¿æ¥æ•° ss















# DNS



- è®¡ç®—æœºåç§°ï¼šComputer Name

- ä¸»æœºåï¼šHost Name

- å…¨é™å®šåŸŸåï¼šFQDNï¼ˆFully Qualified Domain Nameï¼‰



![image-20250630150650198](D:\git_repository\cyber_security_learning\markdown_img\image-20250630150650198.png)





### DNSç³»ç»Ÿç»„æˆ

#### åŸŸåç©ºé—´

- æ ‡è¯†ä¸€ç»„ä¸»æœºå¹¶æä¾›å®ƒä»¬çš„æœ‰å…³ä¿¡æ¯çš„æ ‘å‹ç»“æ„



![image-20250829155911422](D:\git_repository\cyber_security_learning\markdown_img\image-20250829155911422.png)





åœ¨windowsä¸»æœºæŸ¥è¯¢ï¼Œè´Ÿè´£æŒ‡å®šåŸŸåç®¡ç†çš„DNSæœåŠ¡å™¨æœ‰å“ªäº›

```bat
C:\Users\31403>nslookup
é»˜è®¤æœåŠ¡å™¨:  public-dns-a.baidu.com
Address:  180.76.76.76

> set type=ns
> .
æœåŠ¡å™¨:  public-dns-a.baidu.com
Address:  180.76.76.76

éæƒå¨åº”ç­”:
(root)  nameserver = e.root-servers.net
(root)  nameserver = g.root-servers.net
(root)  nameserver = f.root-servers.net
(root)  nameserver = b.root-servers.net
(root)  nameserver = d.root-servers.net
......

> 51cto.com.
æœåŠ¡å™¨:  public-dns-a.baidu.com
Address:  180.76.76.76

éæƒå¨åº”ç­”:
51cto.com       nameserver = vip4.alidns.com
51cto.com       nameserver = vip3.alidns.com
```





#### åŸŸåæœåŠ¡å™¨

- ä¿æŒå’Œç»´æŠ¤åŸŸåç©ºé—´æ•°æ®çš„ç¨‹åº
- å“åº”è§£æå™¨çš„è¯·æ±‚



**åŸŸåæœåŠ¡å™¨çš„ç±»å‹**

- ç»´æŠ¤èµ„æºè®°å½•
  - ä¸»åŸŸåæœåŠ¡å™¨ï¼ˆprimary Name Serverï¼‰ã€å¯å†™ã€‘
  - è¾…åŠ©åŸŸåæœåŠ¡å™¨ï¼ˆSecondary Name Serverï¼‰ã€åªè¯»ã€‘



- ä¸ç»´æŠ¤èµ„æºè®°å½•
  - ä»…ç¼“å­˜æœåŠ¡å™¨ï¼ˆCache-only Serverï¼‰



è§£æå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰





å°†åŸŸåè§£ææˆIPçš„3ç§æ–¹æ³•



- hostsæ–‡ä»¶
  - æœ¬åœ°é™æ€æ–‡æœ¬æ–‡ä»¶
    - Unix/Linuxï¼š/etc/hosts
    - Windowsï¼š%windor%\system32\drivers\etc\hosts
  - ç®€å•æ˜“ç”¨
  - ä¸æ–¹ä¾¿é›†ä¸­ç®¡ç†



- DNS (Domain Name Server)
  - C/Sæ¶æ„
  - åˆ†å¸ƒå¼æ•°æ®åº“ï¼Œä¾¿äºæ‰©å±•ï¼ˆå­¦ä¹ æ•°æ®åº“è®°å½•å’Œå­—æ®µçš„å«ä¹‰ï¼‰



- - 



# æ—¶é—´åŒæ­¥

## å®éªŒï¼šæŸ¥çœ‹chronyæ—¶é—´åŒæ­¥

```bash
# é»˜è®¤ç­–ç•¥æŸ¥çœ‹
[root@ubuntu22 ~]#vim /etc/chrony/chrony.conf 
...
makestep 1 3
...
```



### makestep è§£æ

`makestep 1.0 3` é‡Œçš„â€œ**å‰ 3 æ¬¡æ›´æ–°**â€ï¼ŒæŒ‡çš„æ˜¯ **chronyd è‡ªå¯åŠ¨ä»¥æ¥çš„â€œæ—¶é’Ÿæ›´æ–°ï¼ˆclock updateï¼‰â€æ¬¡æ•°**ã€‚å½“ chronyd æ¯æ¬¡æ ¹æ®ä¸Šæ¸¸æµ‹é‡ç»“æœæ¥**æ›´æ–°/æ ¡æ­£ç³»ç»Ÿæ—¶é’Ÿ**æ—¶ï¼Œè®¡æ•°+1ã€‚åªè¦æ­¤æ—¶**åå·® > 1.0 ç§’å¹¶ä¸”ç´¯è®¡æ›´æ–°æ¬¡æ•° â‰¤ 3**ï¼Œå°±å…è®¸ç›´æ¥â€œè·³æ—¶ï¼ˆstepï¼‰â€ï¼›è¶…è¿‡ 3 æ¬¡ä¹‹åï¼Œå³ä½¿åå·®è¿˜>1 ç§’ï¼Œä¹Ÿåªä¼šâ€œæ…¢æ…¢æ‹¨ï¼ˆslewï¼‰â€ã€‚

```bat
chronyd ä¸€å¯åŠ¨é€šå¸¸ä¼š iburstï¼Œå‡ åç§’å†…å°±æŠŠè¿™ 3 æ¬¡æ›´æ–°èµ°å®Œã€‚å¦‚æœä½ å…ˆè£…å¥½/å¯åŠ¨äº† chronyï¼Œå®ƒå¾ˆå¿«åšäº†å‡ æ¬¡æ›´æ–°ï¼ˆå½“æ—¶åå·®ä¸å¤§ä¸éœ€è¦è·³ï¼‰
```



æŸ¥çœ‹chronyçš„åŒæ­¥è¿‡ç¨‹

```bash
[root@ubuntu22 ~]#apt install -y chrony

# æŸ¥çœ‹çŠ¶æ€
[root@etcd3 ~]#chronyc
chrony version 4.2
Copyright (C) 1997-2003, 2007, 2009-2021 Richard P. Curnow and others
chrony comes with ABSOLUTELY NO WARRANTY.  This is free software, and
you are welcome to redistribute it under certain conditions.  See the
GNU General Public License version 2 for details.

chronyc> tracking
Reference ID    : CB6B0658 (203.107.6.88)
Stratum         : 3
Ref time (UTC)  : Sat Sep 06 18:48:03 2025
System time     : 0.000064919 seconds fast of NTP time
Last offset     : +0.000067552 seconds
RMS offset      : 0.000067552 seconds
Frequency       : 16.756 ppm slow
Residual freq   : -2015.403 ppm
Skew            : 1.773 ppm
Root delay      : 0.067121126 seconds
Root dispersion : 0.054318056 seconds
Update interval : 2.1 seconds
Leap status     : Normal

# è°ƒæ•´æ—¶é—´ï¼Œæå‰1åˆ†é’Ÿ
[root@etcd3 ~]#date -s "-1 minute"

# å†æ¬¡æŸ¥çœ‹ï¼Œæ•°å€¼æ¸…0
[root@etcd3 ~]#chronyc
chrony version 4.2
Copyright (C) 1997-2003, 2007, 2009-2021 Richard P. Curnow and others
chrony comes with ABSOLUTELY NO WARRANTY.  This is free software, and
you are welcome to redistribute it under certain conditions.  See the
GNU General Public License version 2 for details.

chronyc> tracking
Reference ID    : 00000000 ()
Stratum         : 0
Ref time (UTC)  : Thu Jan 01 00:00:00 1970
System time     : 0.000000026 seconds slow of NTP time
Last offset     : +0.018060002 seconds
RMS offset      : 0.018060002 seconds
Frequency       : 16.756 ppm slow
Residual freq   : +0.000 ppm
Skew            : 0.000 ppm
Root delay      : 1.000000000 seconds
Root dispersion : 1.000000000 seconds
Update interval : 65.1 seconds
Leap status     : Not synchronised

# å¯¹ chronyd æ¥è¯´ï¼Œè¿™æ˜¯ä¸€æ¬¡â€œå¤–éƒ¨è·³æ—¶â€ã€‚chronyd æ£€æµ‹åˆ°æœ‰äººæŠŠæ—¶é’Ÿå¼ºè¡ŒæŒªäº†è¿™ä¹ˆå¤§ä¸€æ®µï¼Œä¼šç«‹åˆ»ä¸¢å¼ƒå½“å‰åŒæ­¥çŠ¶æ€ä¸å†å²æ»¤æ³¢æ•°æ®ï¼ŒæŠŠè‡ªå·±ç½®ä¸ºâ€œæœªåŒæ­¥â€ï¼ˆStratum=0ã€RefID=00000000ã€Ref time æ˜¾ç¤ºæˆ 1970 å ä½ï¼‰â€”â€”é˜²æ­¢ç»§ç»­åŸºäºè¿‡æ—¶/å¤±çœŸçš„æ ·æœ¬è®¡ç®—ã€‚è¿™æ˜¯è®¾è®¡ä½¿ç„¶ã€‚

# ç­‰å¾…1åˆ°2åˆ†é’Ÿï¼Œé‡æ–°è¿æ¥ä¸Šçº§æ—¶é—´åŒæ­¥æœåŠ¡å™¨
chronyc> tracking
Reference ID    : CB6B0658 (203.107.6.88)
Stratum         : 3
Ref time (UTC)  : Sat Sep 06 18:52:22 2025
System time     : 59.990074158 seconds slow of NTP time
Last offset     : -60.011508942 seconds
RMS offset      : 18.977312088 seconds
Frequency       : 16.756 ppm slow
Residual freq   : +4.196 ppm
Skew            : 1.773 ppm
Root delay      : 0.119826257 seconds
Root dispersion : 0.002006560 seconds
Update interval : 0.0 seconds
Leap status     : Normal

# è§‚å¯Ÿsystem timeï¼Œä¼šå‘ç°æ—¶é—´é€æ¸è¶‹è¿‘äº0ï¼Œè¿™å°±æ˜¯åœ¨æ…¢æ…¢æ—¶é—´åŒæ­¥ï¼Œé˜²æ­¢è·³æ—¶ï¼Œå½±å“ä¸šåŠ¡ã€‚
```







# å®‰å…¨åŠ å¯†

## CAä¸è¯ä¹¦

### **CN æ˜¯ä»€ä¹ˆï¼Ÿæœ€åˆçš„ä½¿ç”¨æ–¹å¼**

- CNï¼ˆCommon Nameï¼‰æ˜¯ X.509 v1/v2 è¯ä¹¦ä¸­çš„ **Subject å­—æ®µçš„ä¸€éƒ¨åˆ†**ï¼ŒåŸæœ¬ç”¨äºæè¿°ç»„ç»‡æˆ–äººçš„åç§°ã€‚
- åæ¥åœ¨ HTTPS ä¸­è¢«â€œçº¦å®šä¿—æˆâ€åœ°ç”¨äºå¡«å…¥åŸŸåï¼Œä½œä¸ºå®¢æˆ·ç«¯éªŒè¯çš„ç›®æ ‡ã€‚

#### ç¤ºä¾‹ï¼ˆä¼ ç»Ÿè¯ä¹¦ï¼‰ï¼š

```
makefileCopyEditSubject:
  CN = www.example.com
```

#### å®¢æˆ·ç«¯è¡Œä¸ºï¼ˆè€ç‰ˆæœ¬æµè§ˆå™¨ã€curl ç­‰ï¼‰ï¼š

- ç”¨æˆ·è®¿é—® `https://www.example.com`ï¼Œå®¢æˆ·ç«¯å–å‡ºè¯ä¹¦çš„ `Subject.CN`ï¼Œæ¯”å¯¹ç›®æ ‡åŸŸåã€‚
- åŒ¹é…æˆåŠŸåˆ™æ¡æ‰‹æˆåŠŸï¼Œå¦åˆ™æŠ¥é”™ï¼š`CN mismatch`ã€‚





### **CN çš„é—®é¢˜é€æ¸æš´éœ²**

#### âŒ 1. **æ— æ³•æ”¯æŒå¤šä¸ªåŸŸå**

CN åªèƒ½å¡«å†™ä¸€ä¸ªå€¼ï¼Œä¾‹å¦‚ `www.example.com`ï¼Œé‚£æˆ‘æƒ³åŒæ—¶æ”¯æŒ `api.example.com` å’Œ `example.cn` å°±æ²¡æ³•å®ç°ã€‚

> å¤šåŸŸåéƒ¨ç½²æ—¶ï¼Œéœ€è¦ä¸ºæ¯ä¸ªåŸŸåç”³è¯·ä¸€å¼ è¯ä¹¦ â†’ ç»´æŠ¤æˆæœ¬é«˜ï¼Œæ— æ³•ç»Ÿä¸€ç®¡ç†ã€‚



#### âŒ 2. **ä¸èƒ½å¡«å†™ IPã€Emailã€URI ç­‰é DNS ç±»å‹ä¿¡æ¯**

CN æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œä¸èƒ½æ˜ç¡®å‘Šè¯‰å®¢æˆ·ç«¯è¿™æ˜¯ IP è¿˜æ˜¯ DNS åã€‚



#### âŒ 3. **é€šé…ç¬¦æ”¯æŒå—é™ä¸”ä¸å®‰å…¨**

è™½ç„¶æ”¯æŒ `*.example.com` è¿™ç±»å†™æ³•ï¼Œä½†ä¸èƒ½è·¨å­åŸŸï¼ˆå¦‚ `*.*.example.com` ä¸åˆæ³•ï¼‰ï¼Œä¹Ÿå®¹æ˜“è¢«æ»¥ç”¨ã€‚



#### âŒ 4. **RFC ä¸å†æ¨èä½¿ç”¨ CN ä½œä¸ºæ ¡éªŒä¾æ®**

- RFC 2818ï¼ˆHTTPS æ ‡å‡†ï¼‰æ˜ç¡®æå‡ºï¼š

> If the subjectAltName extension of type dNSName is present, that MUST be used as the identity.

ä¹Ÿå°±æ˜¯è¯´ï¼š**å¦‚æœè¯ä¹¦æœ‰ SAN å­—æ®µï¼Œåˆ™å®¢æˆ·ç«¯å¿…é¡»åªä½¿ç”¨ SAN éªŒè¯ï¼Œå¿½ç•¥ CNã€‚**





### **SAN å‡ºç°ï¼Œä¸“é—¨è§£å†³ CN çš„å±€é™**

#### ğŸ” SANï¼ˆSubject Alternative Nameï¼‰æ˜¯ X.509 v3 æ‰©å±•å­—æ®µï¼Œè®¾è®¡ç”¨äºï¼š

| ç±»å‹       | ä¸¾ä¾‹                                                       |
| ---------- | ---------------------------------------------------------- |
| DNS        | `www.example.com`, `api.example.cn`                        |
| IP Address | `192.168.1.10`, `10.0.0.5`                                 |
| Email      | `admin@example.com`                                        |
| URI        | `spiffe://cluster.local/ns/default/sa/web`ï¼ˆæœåŠ¡ç½‘æ ¼èº«ä»½ï¼‰ |



#### âœ… ä¼˜åŠ¿ï¼š

| é—®é¢˜                    | SAN çš„è§£å†³æ–¹å¼                              |
| ----------------------- | ------------------------------------------- |
| ä¸€ä¸ªè¯ä¹¦åªèƒ½é…ä¸€ä¸ª CNï¼Ÿ | SAN å¯ä»¥åˆ—å¤šä¸ª DNS/IPï¼Œæ”¯æŒå¤šåŸŸå           |
| ä¸èƒ½æ”¾ IPï¼Ÿ             | SAN æ”¯æŒ `IP Address` ç±»å‹                  |
| æ— æ³•é€šé…å¤šæœåŠ¡ï¼Ÿ        | SAN å¯åˆ—å‡ºå¤šä¸ªåç§°ï¼Œé¿å…é€šé…æ»¥ç”¨            |
| å®¢æˆ·ç«¯åªçœ‹ CNï¼Ÿ         | æ–°æ ‡å‡†è¦æ±‚ï¼š**åªçœ‹ SANï¼Œä¸çœ‹ CN**ï¼ˆæ›´å®‰å…¨ï¼‰ |







### ä¸¾ä¾‹æ¯”è¾ƒ

##### âŒ ä½¿ç”¨ CNï¼ˆæ—§æ–¹å¼ï¼‰

```ini
Subject: CN=www.example.com
```

â†’ åªèƒ½è®¿é—® `www.example.com`ï¼Œå…¶ä»–éƒ½ä¸è¡Œã€‚



##### âœ… ä½¿ç”¨ SANï¼ˆæ–°æ–¹å¼ï¼‰

```ini
Subject: CN=www.example.com
X509v3 Subject Alternative Name:
    DNS:www.example.com
    DNS:api.example.com
    DNS:*.example.net
    IP Address:192.168.1.10
```





## ä½¿ç”¨ OpenSSL é…ç½® SAN

**å¯ä»¥å°†ä¸»é…ç½®æ–‡ä»¶ (`openssl.cnf`) ç”¨äºä¸»æµç¨‹ï¼ˆCAé…ç½®ã€å­—æ®µæ ¡éªŒã€ç›®å½•ç»“æ„ç­‰ï¼‰**ï¼Œè€Œ**ä»…æŠŠ SAN é…ç½®å•ç‹¬å†™åœ¨å¦ä¸€ä¸ªæ‰©å±•æ–‡ä»¶ä¸­ï¼ˆæˆ‘ä»¬ç§°ä¹‹ä¸ºâ€œå­é…ç½®â€æˆ– `extfile`ï¼‰**ï¼Œæœ€ç»ˆé€šè¿‡ `-extfile` å’Œ `-extensions` é…åˆä½¿ç”¨ â€”â€” è¿™æ˜¯ OpenSSL **æœ€å¸¸ç”¨ä¹Ÿæœ€æ¨èçš„æ–¹å¼**ã€‚



### æ€»ä½“æ–¹æ¡ˆç»“æ„ï¼ˆä¸»é…ç½® + å­é…ç½®ï¼‰

```bash
ä¸»é…ç½®ï¼š/etc/pki/CA/openssl.cnf     â†’ æä¾›å®Œæ•´ CA ç­¾å‘è§„åˆ™
å­é…ç½®ï¼š~/openssl-san-ext.cnf       â†’ åªå†™ [ v3_req ] å’Œ [ alt_names ]
```



### æ­¥éª¤è¯¦è§£

#### 1ï¸âƒ£ ä¸»é…ç½® `/etc/pki/CA/openssl.cnf`ï¼ˆä¿ç•™ä¸» CA é…ç½®ï¼‰

ä½ å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ç»“æ„ï¼ˆçœç•¥ä¸å˜çš„å†…å®¹ï¼‰ï¼š

```ini
[ CA_default ]
dir             = /etc/pki/CA
...
policy          = policy_strict
copy_extensions = copy
...

[ policy_strict ]
countryName             = supplied
stateOrProvinceName     = supplied
organizationName        = supplied
commonName              = supplied

[ req ]
distinguished_name = req_distinguished_name
prompt = no

[ req_distinguished_name ]
C = CN
ST = Shanghai
O = Magedu Ltd
CN = client.magedu.org
```

æ³¨æ„ï¼š

- ä¸éœ€è¦åœ¨ä¸»é…ç½®ä¸­æ·»åŠ  `subjectAltName`
- ä¹Ÿä¸éœ€è¦å†™ `[ alt_names ]`ï¼Œéƒ½æ”¾åˆ°å­é…ç½®æ–‡ä»¶é‡Œå»



#### 2ï¸âƒ£ å­é…ç½® `~/openssl-san-ext.cnf`ï¼ˆåªå†™æ‰©å±•å†…å®¹ï¼‰

```ini
[ v3_req ]
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = client.magedu.org
DNS.2 = api.magedu.org
IP.1  = 192.168.1.111
```



#### 3ï¸âƒ£ ä½¿ç”¨ä¸»é…ç½®ç”Ÿæˆ CSRï¼ˆä¸å« SANï¼‰

```bash
openssl req -new -key client.key -out client.csr \
  -config /etc/pki/CA/openssl.cnf
```



#### 4ï¸âƒ£ ç”¨ CA ç­¾å‘è¯ä¹¦ï¼Œç»“åˆå­é…ç½®æ·»åŠ  SAN

```
openssl ca -in client.csr -out certs/client.crt \
  -config /etc/pki/CA/openssl.cnf \
  -extfile ~/openssl-san-ext.cnf -extensions v3_req
```





## SSHå†…ç½‘ç©¿é€

### æ•´ä¸ªæ•°æ®åŒ…é€šä¿¡è¿‡ç¨‹ï¼ˆåˆ†é˜¶æ®µè¯¦ç»†è®²è§£ï¼‰



#### é˜¶æ®µä¸€ï¼šéš§é“å»ºç«‹

**ä¸»åŠ¨ç«¯ï¼šå†…ç½‘å®¢æˆ·ç«¯ `10.0.0.201`**

1. ä½ åœ¨å†…ç½‘ä¸»æœºä¸Šæ‰§è¡Œ `ssh -fN -R 11223:localhost:22 root@101.35.250.82`
2. è¯¥å‘½ä»¤ï¼š
   - å‘èµ· SSH TCP è¿æ¥ï¼š**`10.0.0.201:xxxxx â†’ 101.35.250.82:22`**
   - SSH è¿æ¥å»ºç«‹æˆåŠŸåï¼Œåœ¨è¿œç¨‹ä¸»æœºä¸Šç»‘å®šç›‘å¬ï¼š`0.0.0.0:11223`
   - SSH å®ˆæŠ¤è¿›ç¨‹å¼€å§‹ç›‘å¬å¤–éƒ¨å¯¹ `11223` çš„è¿æ¥è¯·æ±‚ï¼Œå¹¶å‡†å¤‡å°†è¿™äº›æµé‡é€šè¿‡éš§é“è½¬å‘å›æ¥

ğŸ‘‰ ç»“æœï¼š**å…¬ç½‘æœåŠ¡å™¨ `101.35.250.82` å¼€å§‹ç›‘å¬ 11223**ï¼Œä½œä¸ºè¿›å…¥å†…ç½‘çš„å…¥å£



#### é˜¶æ®µäºŒï¼šå¤–éƒ¨å®¢æˆ·ç«¯è®¿é—®å…¬ç½‘æœåŠ¡å™¨

**å¤–éƒ¨ä»»æ„ä¸€å°å…¬ç½‘ä¸»æœºï¼šæ¯”å¦‚ `222.222.222.222`**

1. ç”¨æˆ·æ‰§è¡Œå‘½ä»¤ï¼š

   ```bash
   ssh -p 11223 user@101.35.250.82
   ```

2. å»ºç«‹ TCP è¿æ¥ï¼š

   ```makefile
   222.222.222.222:yyyyy â†’ 101.35.250.82:11223
   ```

3. å…¬ç½‘æœåŠ¡å™¨æ¥æ”¶åˆ°è¿æ¥åï¼Œå°†å…¶è®¤ä¸ºæ˜¯è¿æ¥æœ¬åœ°çš„ `11223`ï¼Œäºæ˜¯å°†å…¶ï¼š

   - **æ‰“åŒ…æˆ SSH éš§é“ payload**
   - ä» `101.35.250.82` çš„ç°æœ‰ SSH è¿æ¥**å°è£…å‘é€ç»™ 10.0.0.201ï¼ˆä½ çš„å†…ç½‘ï¼‰**



#### é˜¶æ®µä¸‰ï¼šSSH æœåŠ¡å™¨åå‘è½¬å‘æ•°æ®åˆ°å†…ç½‘ç›®æ ‡

**åå‘æµåŠ¨çš„ TCP payload åˆ°è¾¾å†…ç½‘**

1. å…¬ç½‘æœåŠ¡å™¨å°†æ”¶åˆ°çš„æ•°æ®æ‰“åŒ…ï¼Œæ”¾å…¥å·²å»ºç«‹çš„ SSH éš§é“è¿æ¥

2. åœ¨éš§é“å¦ä¸€ç«¯ï¼ˆ`10.0.0.201`ï¼‰ï¼š

   - `ssh` å®¢æˆ·ç«¯è§£æ payloadï¼Œå‘ç°æ˜¯å¯¹ `localhost:22` çš„è®¿é—®è¯·æ±‚

   - æœ¬åœ°å¼€å¯ä¸€ä¸ª TCP è¿æ¥ï¼š

     ```makefile
     localhost:zzzzz â†’ localhost:22
     ```

3. å°† payload è½¬å‘ç»™æœ¬åœ° SSH æœåŠ¡ï¼ˆç›¸å½“äºå¤–éƒ¨ç”¨æˆ·è¿æ¥äº† `10.0.0.201:22`ï¼‰



#### é˜¶æ®µå››ï¼šå†…ç½‘è¿”å›æ•°æ®å›ä¼ 

1. å†…ç½‘æœºå™¨ `10.0.0.201` çš„ `sshd` å“åº”æ•°æ®ï¼Œå†™å› TCP socket
2. æ•°æ®è¢« `ssh` å®¢æˆ·ç«¯å°è£…ï¼Œé€šè¿‡éš§é“åå‘å‘é€åˆ° `101.35.250.82`
3. å…¬ç½‘æœåŠ¡å™¨å°†è§£å°çš„æ•°æ®å†™å›åˆ°åŸå§‹å®¢æˆ·ç«¯ TCP è¿æ¥ `11223`

æœ€ç»ˆï¼š

```css
[å…¬ç½‘å®¢æˆ·ç«¯] â†â†’ 101.35.250.82:11223 â†â†’ SSH éš§é“ â†â†’ 10.0.0.201:22
```



#### å›¾ç¤ºæ€»ç»“ï¼ˆæ•°æ®åŒ…æ–¹å‘ï¼‰

```css
     â¬‡ï¸ TCP: 222.222.222.222:YYYY â†’ 101.35.250.82:11223
å…¬ç½‘å®¢æˆ·ç«¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ å…¬ç½‘è·³æ¿æœº
                                                  â”‚
             SSHéš§é“                              â–¼
å…¬ç½‘è·³æ¿æœº â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TCP Payload over SSH â”€â”€â”€â”€â”€â”€â”€â”€ å†…ç½‘æœºå™¨
       â¬…ï¸ å›åº”æ•°æ®ï¼š10.0.0.201:22 â†’ 101.35.250.82 â†’ 222.222.222.222
```



#### è¡¥å……è¯´æ˜ï¼šä¸ºä»€ä¹ˆèƒ½ç©¿é€ NATï¼Ÿ

å› ä¸ºï¼š

- å†…ç½‘æœºå™¨æ˜¯ä¸»åŠ¨å‘èµ· SSH è¿æ¥ï¼ˆå…è®¸å‡ºç«™ NATï¼‰
- SSH éš§é“å»ºç«‹åï¼Œæ‰€æœ‰æµé‡éƒ½é€šè¿‡è¿™ä¸ªåå‘è¿æ¥å›æµ
- æ— éœ€å…¬ç½‘ IPï¼ŒNAT ä¸é˜»æ­¢ TCP å›ç¨‹









# APT è½¯ä»¶åº“





## æœ€ç®€â€œå¹³é¢ä»“åº“â€

**é€‚åˆå†…ç½‘ä¸´æ—¶ç”¨**

```bash
# 1) å‡†å¤‡ç›®å½•å¹¶æŠŠ .deb æ”¾è¿›æ¥
mkdir -p /srv/apt-repo
cp *.deb /srv/apt-repo/

# 2) ç”Ÿæˆç´¢å¼•ï¼ˆéœ€è¦å®‰è£… dpkg-devï¼‰
cd /srv/apt-repo
dpkg-scanpackages . /dev/null | gzip -9c > Packages.gz

# 3) å®¢æˆ·ç«¯ sources.list æŒ‡å‘è¿™ä¸ªç›®å½•ï¼ˆæœ¬æœºç¤ºä¾‹ï¼‰
echo "deb [trusted=yes] file:/srv/apt-repo ./" | sudo tee /etc/apt/sources.list.d/local.repo
apt update
```



**sources.list é…ç½®è§£è¯»**

```bash
deb [trusted=yes] http://10.0.0.202 ./ 
```

- **deb**ï¼šè¿™æ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶åŒ…ä»“åº“ï¼Œè€Œä¸æ˜¯æºä»£ç åŒ…ä»“åº“ï¼ˆ`deb-src`ï¼‰ã€‚

- **[trusted=yes]**ï¼šè·³è¿‡ GPG ç­¾åæ ¡éªŒï¼Œå³ä½¿æ²¡æœ‰ Release æ–‡ä»¶ç­¾åä¹Ÿç›´æ¥ä¿¡ä»»ã€‚

- **http://10.0.0.202**ï¼šä»“åº“æœåŠ¡å™¨åœ°å€ï¼ˆä½ åœ¨ 10.0.0.202 ä¸Šç”¨ HTTP å…±äº«äº† `/srv/apt-repo`ï¼‰ã€‚

- **./**ï¼šå‘Šè¯‰ aptï¼Œè½¯ä»¶åŒ…ç´¢å¼•æ–‡ä»¶ `Packages` å°±åœ¨è¿™ä¸ª HTTP ç›®å½•çš„å½“å‰å±‚çº§ï¼ˆflat repoï¼‰ï¼Œä¸æ˜¯ `dists/stable/...` è¿™ç§åˆ†å±‚ç»“æ„ã€‚







## è§„èŒƒç›®å½•ç»“æ„ä»“åº“ï¼ˆæ¨èï¼‰

æ›´æ¥è¿‘å®˜æ–¹ä»“åº“å¸ƒå±€ï¼Œä¾¿äºå¤šæ¶æ„/å¤šç»„ä»¶ã€‚

```bash
apt install dpkg-dev apt-utils

# 1) ç›®å½•
[root@ubuntu2204 srv]#mkdir -p /srv/repo/{pool/main,dists/stable/main/binary-amd64}
[root@ubuntu2204 srv]#tree /srv/repo
/srv/repo
â”œâ”€â”€ dists
â”‚   â””â”€â”€ stable
â”‚       â””â”€â”€ main
â”‚           â””â”€â”€ binary-amd64     # å…ƒæ•°æ®
â””â”€â”€ pool
    â””â”€â”€ main                     # æ”¾debåŒ…çš„ç›®å½•
    
[root@ubuntu2204 srv]#cp /mnt/pool/main/o/openvswitch/*.deb /srv/repo/pool/main/
[root@ubuntu2204 srv]#cp /mnt/pool/main/o/os-prober/*.deb /srv/repo/pool/main/
[root@ubuntu2204 srv]#cp /mnt/pool/main/o/openssh/*.deb /srv/repo/pool/main/

# æŸ¥çœ‹
[root@ubuntu2204 srv]#tree
.
â””â”€â”€ repo
    â”œâ”€â”€ dists
    â”‚   â””â”€â”€ stable
    â”‚       â””â”€â”€ main
    â”‚           â””â”€â”€ binary-amd64
    â””â”€â”€ pool
        â””â”€â”€ main
            â”œâ”€â”€ openssh-server_8.9p1-3ubuntu0.3_amd64.deb
            â”œâ”€â”€ openssh-sftp-server_8.9p1-3ubuntu0.3_amd64.deb
            â”œâ”€â”€ openvswitch-common_2.17.7-0ubuntu0.22.04.1_amd64.deb
            â”œâ”€â”€ openvswitch-switch_2.17.7-0ubuntu0.22.04.1_amd64.deb
            â”œâ”€â”€ os-prober_1.79ubuntu2_amd64.deb
            â””â”€â”€ python3-openvswitch_2.17.7-0ubuntu0.22.04.1_all.deb


# 2) ç”Ÿæˆ Packages
[root@ubuntu2204 srv]#cd /srv/repo/
[root@ubuntu2204 repo]#dpkg-scanpackages -m pool > dists/stable/main/binary-amd64/Packages
dpkg-scanpackages: info: Wrote 6 entries to output Packages file.
[root@ubuntu2204 repo]#gzip -kf dists/stable/main/binary-amd64/Packages 
[root@ubuntu2204 repo]#tree
.
â”œâ”€â”€ dists
â”‚   â””â”€â”€ stable
â”‚       â””â”€â”€ main
â”‚           â””â”€â”€ binary-amd64
â”‚               â”œâ”€â”€ Packages
â”‚               â””â”€â”€ Packages.gz
â””â”€â”€ pool
    â””â”€â”€ main
        â”œâ”€â”€ openssh-server_8.9p1-3ubuntu0.3_amd64.deb
        â”œâ”€â”€ openssh-sftp-server_8.9p1-3ubuntu0.3_amd64.deb
        â”œâ”€â”€ openvswitch-common_2.17.7-0ubuntu0.22.04.1_amd64.deb
        â”œâ”€â”€ openvswitch-switch_2.17.7-0ubuntu0.22.04.1_amd64.deb
        â”œâ”€â”€ os-prober_1.79ubuntu2_amd64.deb
        â””â”€â”€ python3-openvswitch_2.17.7-0ubuntu0.22.04.1_all.deb


# 3) ç”Ÿæˆ Releaseï¼ˆå¯é€‰ä½†æ¨èï¼‰
apt-ftparchive release dists/stable > dists/stable/Release

# 4) ï¼ˆå¯é€‰ï¼‰ç”¨ GPG ç»™ Release ç­¾å
gpg --default-key <ä½ çš„keyID> -abs -o dists/stable/Release.gpg dists/stable/Release

# 5) å®¢æˆ·ç«¯æ·»åŠ æº
# deb [arch=amd64] http://your-host-or-file-url/stable main
```





### GPG Key çš„ç”Ÿæˆæµç¨‹

#### å®‰è£… GPG

Rocky / Ubuntu éƒ½æ˜¯ï¼š

```bash
sudo yum install gnupg        # Rocky / RHEL
sudo apt install gnupg        # Ubuntu / Debian
```



#### ç”Ÿæˆæ–°çš„ GPG å¯†é’¥

```bash
[root@ubuntu2204 repo]#gpg --full-generate-key
gpg (GnuPG) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

gpg: ç›®å½•â€˜/root/.gnupgâ€™å·²åˆ›å»º
gpg: é’¥åŒ™ç®±â€˜/root/.gnupg/pubring.kbxâ€™å·²åˆ›å»º

# é€‰æ‹©å¯†é’¥ç±»å‹
è¯·é€‰æ‹©æ‚¨è¦ä½¿ç”¨çš„å¯†é’¥ç±»å‹ï¼š
   (1) RSA å’Œ RSA ï¼ˆé»˜è®¤ï¼‰
   (2) DSA å’Œ Elgamal
   (3) DSAï¼ˆä»…ç”¨äºç­¾åï¼‰
   (4) RSAï¼ˆä»…ç”¨äºç­¾åï¼‰
  ï¼ˆ14ï¼‰å¡ä¸­ç°æœ‰å¯†é’¥
æ‚¨çš„é€‰æ‹©æ˜¯ï¼Ÿ 1

# å¯†é’¥é•¿åº¦
RSA å¯†é’¥çš„é•¿åº¦åº”åœ¨ 1024 ä½ä¸ 4096 ä½ä¹‹é—´ã€‚
æ‚¨æƒ³è¦ä½¿ç”¨çš„å¯†é’¥é•¿åº¦ï¼Ÿ(3072) 4096
è¯·æ±‚çš„å¯†é’¥é•¿åº¦æ˜¯ 4096 ä½

# æœ‰æ•ˆæœŸ
è¯·è®¾å®šè¿™ä¸ªå¯†é’¥çš„æœ‰æ•ˆæœŸé™ã€‚
         0 = å¯†é’¥æ°¸ä¸è¿‡æœŸ
      <n>  = å¯†é’¥åœ¨ n å¤©åè¿‡æœŸ
      <n>w = å¯†é’¥åœ¨ n å‘¨åè¿‡æœŸ
      <n>m = å¯†é’¥åœ¨ n æœˆåè¿‡æœŸ
      <n>y = å¯†é’¥åœ¨ n å¹´åè¿‡æœŸ
å¯†é’¥çš„æœ‰æ•ˆæœŸé™æ˜¯ï¼Ÿ(0) 2y
å¯†é’¥äº 2027å¹´08æœˆ12æ—¥ æ˜ŸæœŸå›› 16æ—¶34åˆ†33ç§’ CST è¿‡æœŸ
è¿™äº›å†…å®¹æ­£ç¡®å—ï¼Ÿ (y/N) y

GnuPG éœ€è¦æ„å»ºç”¨æˆ·æ ‡è¯†ä»¥è¾¨è®¤æ‚¨çš„å¯†é’¥ã€‚

# ç”¨æˆ·ä¿¡æ¯
çœŸå®å§“åï¼š mystical
ç”µå­é‚®ä»¶åœ°å€ï¼š mysticalrecluse@gmail.com
æ³¨é‡Šï¼š APT Repository Signing Key
æ‚¨é€‰å®šäº†æ­¤ç”¨æˆ·æ ‡è¯†ï¼š
    â€œmystical (APT Repository Signing Key) <mysticalrecluse@gmail.com>â€

æ›´æ”¹å§“åï¼ˆNï¼‰ã€æ³¨é‡Šï¼ˆCï¼‰ã€ç”µå­é‚®ä»¶åœ°å€ï¼ˆEï¼‰æˆ–ç¡®å®šï¼ˆOï¼‰/é€€å‡ºï¼ˆQï¼‰ï¼Ÿ 
æ›´æ”¹å§“åï¼ˆNï¼‰ã€æ³¨é‡Šï¼ˆCï¼‰ã€ç”µå­é‚®ä»¶åœ°å€ï¼ˆEï¼‰æˆ–ç¡®å®šï¼ˆOï¼‰/é€€å‡ºï¼ˆQï¼‰ï¼Ÿ o
æˆ‘ä»¬éœ€è¦ç”Ÿæˆå¤§é‡çš„éšæœºå­—èŠ‚ã€‚åœ¨è´¨æ•°ç”ŸæˆæœŸé—´åšäº›å…¶ä»–æ“ä½œï¼ˆæ•²æ‰“é”®ç›˜
ã€ç§»åŠ¨é¼ æ ‡ã€è¯»å†™ç¡¬ç›˜ä¹‹ç±»çš„ï¼‰å°†ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼›è¿™ä¼šè®©éšæœºæ•°
å‘ç”Ÿå™¨æœ‰æ›´å¥½çš„æœºä¼šè·å¾—è¶³å¤Ÿçš„ç†µã€‚
æˆ‘ä»¬éœ€è¦ç”Ÿæˆå¤§é‡çš„éšæœºå­—èŠ‚ã€‚åœ¨è´¨æ•°ç”ŸæˆæœŸé—´åšäº›å…¶ä»–æ“ä½œï¼ˆæ•²æ‰“é”®ç›˜
ã€ç§»åŠ¨é¼ æ ‡ã€è¯»å†™ç¡¬ç›˜ä¹‹ç±»çš„ï¼‰å°†ä¼šæ˜¯ä¸€ä¸ªä¸é”™çš„ä¸»æ„ï¼›è¿™ä¼šè®©éšæœºæ•°
å‘ç”Ÿå™¨æœ‰æ›´å¥½çš„æœºä¼šè·å¾—è¶³å¤Ÿçš„ç†µã€‚
gpg: /root/.gnupg/trustdb.gpgï¼šå»ºç«‹äº†ä¿¡ä»»åº¦æ•°æ®åº“
gpg: å¯†é’¥ C864F5B6A546E10E è¢«æ ‡è®°ä¸ºç»å¯¹ä¿¡ä»»
gpg: ç›®å½•â€˜/root/.gnupg/openpgp-revocs.dâ€™å·²åˆ›å»º
gpg: åŠé”€è¯ä¹¦å·²è¢«å­˜å‚¨ä¸ºâ€˜/root/.gnupg/openpgp-revocs.d/4D261CAF3779D477A237DACBC864F5B6A546E10E.revâ€™
å…¬é’¥å’Œç§é’¥å·²ç»ç”Ÿæˆå¹¶è¢«ç­¾åã€‚

pub   rsa4096 2025-08-12 [SC] [æœ‰æ•ˆè‡³ï¼š2027-08-12]
      4D261CAF3779D477A237DACBC864F5B6A546E10E
uid                      mystical (APT Repository Signing Key) <mysticalrecluse@gmail.com>
sub   rsa4096 2025-08-12 [E] [æœ‰æ•ˆè‡³ï¼š2027-08-12]
```



#### æŸ¥çœ‹ Key ID

```bash
[root@ubuntu2204 repo]#gpg --list-keys
gpg: æ­£åœ¨æ£€æŸ¥ä¿¡ä»»åº¦æ•°æ®åº“
gpg: marginals needed: 3  completes needed: 1  trust model: pgp
gpg: æ·±åº¦ï¼š0  æœ‰æ•ˆæ€§ï¼š  1  å·²ç­¾åï¼š  0  ä¿¡ä»»åº¦ï¼š0-ï¼Œ0qï¼Œ0nï¼Œ0mï¼Œ0fï¼Œ1u
gpg: ä¸‹æ¬¡ä¿¡ä»»åº¦æ•°æ®åº“æ£€æŸ¥å°†äº 2027-08-12 è¿›è¡Œ
/root/.gnupg/pubring.kbx
------------------------
pub   rsa4096 2025-08-12 [SC] [æœ‰æ•ˆè‡³ï¼š2027-08-12]
      4D261CAF3779D477A237DACBC864F5B6A546E10E
uid             [ ç»å¯¹ ] mystical (APT Repository Signing Key) <mysticalrecluse@gmail.com>
sub   rsa4096 2025-08-12 [E] [æœ‰æ•ˆè‡³ï¼š2027-08-12]
```



#### ç”¨è¿™ä¸ª Key ç­¾å Release

```bash
[root@ubuntu2204 repo]#gpg --default-key 4D261CAF3779D477A237DACBC864F5B6A546E10E --clearsign -o dists/stable/InRelease dists/stable/Release 
gpg: ä½¿ç”¨ â€œ4D261CAF3779D477A237DACBC864F5B6A546E10Eâ€ ä½œä¸ºé»˜è®¤ç­¾åç”¨ç§é’¥
```



#### å‘å¸ƒå…¬é’¥ç»™å®¢æˆ·ç«¯

å®¢æˆ·ç«¯è¦éªŒè¯ç­¾åï¼Œå¿…é¡»å…ˆå¯¼å…¥å…¬é’¥

```bash
# ç”Ÿæˆå…¬é’¥
gpg --armor --export 1234ABCD5678EF90 > repo-public.key

# æœåŠ¡ç«¯è®²å…¬é’¥åˆ†å‘ç»™å®¢æˆ·ç«¯
[root@ubuntu2204 repo]#scp repo-public.key 10.0.0.204:

# å®¢æˆ·ç«¯æ‰§è¡Œï¼ˆä¸æ¨èï¼Œå»ºè®®ä½¿ç”¨æ–°åšæ³•ï¼‰
[root@ubuntu2204 ~]#apt-key add repo-public.key
Warning: apt-key is deprecated. Manage keyring files in trusted.gpg.d instead (see apt-key(8)).
OK
```

ä½† **apt-key å·²ç»è¢«åºŸå¼ƒï¼ˆdeprecatedï¼‰**ï¼Œå› ä¸ºå®ƒçš„å®‰å…¨æ¨¡å‹æœ‰ç¼ºé™·ï¼š

- `apt-key` æŠŠå¯¼å…¥çš„æ‰€æœ‰å…¬é’¥éƒ½æ”¾åœ¨ä¸€ä¸ªå…¨å±€å¯†é’¥ç¯ï¼ˆ`/etc/apt/trusted.gpg`ï¼‰ï¼Œè¿™æ„å‘³ç€**ä»»ä½•ä¸€ä¸ªè¢«ä¿¡ä»»çš„å…¬é’¥éƒ½èƒ½éªŒè¯æ‰€æœ‰ä»“åº“**ï¼Œå¢åŠ äº†å®‰å…¨é£é™©ï¼ˆå¦‚æœä¸€ä¸ªç¬¬ä¸‰æ–¹ä»“åº“çš„å…¬é’¥æ³„éœ²ï¼Œæ‰€æœ‰ä»“åº“éƒ½ä¼šå—å½±å“ï¼‰ã€‚
- ç°åœ¨æ›´æ¨è **æ¯ä¸ªä»“åº“å•ç‹¬ç®¡ç†è‡ªå·±çš„å¯†é’¥æ–‡ä»¶**ã€‚



 **æ–°çš„åšæ³•**

1. æŠŠå…¬é’¥æ–‡ä»¶æ”¾åˆ° `/etc/apt/trusted.gpg.d/` ç›®å½•é‡Œï¼ˆä¸€ä¸ªä»“åº“ä¸€ä¸ªå…¬é’¥æ–‡ä»¶ï¼‰ï¼Œæ¯”å¦‚ï¼š

```bash
#æŠŠæ–‡æœ¬å…¬é’¥â€œå»è£…ç”²â€ä¸ºäºŒè¿›åˆ¶ .gpg
gpg --dearmor -o /etc/apt/trusted.gpg.d/my-repo.gpg repo-public.key
```

ä½ çš„ä»“åº“ä¼šåœ¨ `Release.gpg`ï¼ˆæˆ–è€…å†…åµŒåœ¨ `InRelease`ï¼‰æ–‡ä»¶é‡Œé™„å¸¦ç­¾åã€‚

APT è¯»å–ä»“åº“æ—¶ï¼Œä¼šç”¨ `/etc/apt/trusted.gpg.d/` é‡Œçš„æ‰€æœ‰å…¬é’¥é€ä¸€å°è¯•éªŒè¯ç­¾åã€‚

åªè¦æŸä¸ªå…¬é’¥çš„æŒ‡çº¹èƒ½æ­£ç¡®éªŒè¯ç­¾åï¼ŒAPT å°±è®¤ä¸ºè¯¥ä»“åº“æ˜¯å¯ä¿¡çš„ã€‚





### æ›´æ–°

å»ºç«‹ `release.conf`ï¼š

```bash
APT::FTPArchive::Release {
  Origin "MyRepo";
  Label "MyRepo";
  Suite "stable";
  Codename "stable";
  Architectures "amd64";
  Components "main";
  Description "My local APT repo";
}
```

ç”Ÿæˆä¸ç­¾åï¼š

```bash
cd /srv/repo
apt-ftparchive -c release.conf release dists/stable > dists/stable/Release
gpg --default-key <ä½ çš„KEYID> --clearsign -o dists/stable/InRelease dists/stable/Release
```

ç”Ÿæˆååœ¨å®¢æˆ·ç«¯æ›´æ–°

```bash
apt update
```





å®¢æˆ·ç«¯é…ç½®

```bash
[root@ubuntu2204 ~]#vim /etc/apt/sources.list
deb http://10.0.0.202 stable main
```









## **1. Release æ–‡ä»¶çš„ä½œç”¨**

Release æ–‡ä»¶é‡ŒåŒ…å«äº†ï¼š

- **ä»“åº“ç‰ˆæœ¬ä¿¡æ¯**

  ```
  vbnetCopyEditOrigin: MyRepo
  Label: My Custom Repo
  Suite: stable
  Codename: stable
  Date: Mon, 12 Aug 2025 12:00:00 UTC
  Architectures: amd64 arm64
  Components: main
  ```

  è¿™äº›å‘Šè¯‰å®¢æˆ·ç«¯è¿™æ˜¯å“ªä¸ªå‘è¡Œç‰ˆã€å“ªä¸ªæ¶æ„ã€æœ‰ä»€ä¹ˆç»„ä»¶ã€‚

- **å“ˆå¸Œæ ¡éªŒ**

  ```
  vbnetCopyEditMD5Sum:
   d41d8cd98f00b204e9800998ecf8427e  1234 main/binary-amd64/Packages.gz
  SHA256:
   9f573b...   1234 main/binary-amd64/Packages.gz
  ```

  è¿™é‡Œåˆ—å‡ºäº† `Packages.gz` ç­‰å…ƒæ•°æ®æ–‡ä»¶çš„æ ¡éªŒå€¼ï¼ˆMD5ã€SHA256ï¼‰ï¼ŒAPT åœ¨æ›´æ–°æ—¶ä¼šéªŒè¯è¿™äº›å€¼ï¼Œç¡®ä¿å…ƒæ•°æ®æ²¡è¢«ç¯¡æ”¹ã€‚

- **ç»Ÿä¸€å…¥å£**
   å®¢æˆ·ç«¯åªè¦ä¸‹è½½è¿™ä¸ª `Release` æ–‡ä»¶ï¼Œå°±èƒ½çŸ¥é“ï¼š

  - è¿™ä¸ªä»“åº“æ”¯æŒå“ªäº›æ¶æ„ï¼ˆamd64ã€arm64...ï¼‰
  - æ¯ä¸ªæ¶æ„å¯¹åº”çš„ç´¢å¼•æ–‡ä»¶è·¯å¾„
  - è¿™äº›ç´¢å¼•æ–‡ä»¶çš„å¤§å°ä¸æ ¡éªŒå€¼

------

## **2. ä¸ºä»€ä¹ˆè¦åˆ›å»º Release æ–‡ä»¶**

1. **å®‰å…¨æ€§**ï¼ˆé‡è¦ï¼‰
    ç”Ÿæˆ `Release` åï¼Œå¯ä»¥ç”¨ GPG å¯¹å®ƒç­¾åï¼Œå¾—åˆ° `Release.gpg` æˆ– `InRelease`ï¼ˆå¸¦ç­¾åçš„ Releaseï¼‰ï¼Œå®¢æˆ·ç«¯ä¼šéªŒè¯ç­¾åï¼Œé˜²æ­¢ä¸‹è½½åˆ°è¢«ç¯¡æ”¹çš„åŒ…ã€‚
2. **å®Œæ•´æ€§æ ¡éªŒ**
    å³ä½¿ä½ ä¸ç­¾åï¼ŒAPT ä¹Ÿä¼šæ ¹æ® Release é‡Œçš„å“ˆå¸Œå€¼æ£€æŸ¥ `Packages.gz` æ˜¯å¦è¢«ç¯¡æ”¹æˆ–æŸåã€‚
3. **å®¢æˆ·ç«¯è¯†åˆ«ä»“åº“**
    æ²¡æœ‰ `Release` çš„ä»“åº“ä¼šè¢« APT å½“æˆâ€œä¸´æ—¶æºâ€å¯¹å¾…ï¼Œéƒ¨åˆ†å®‰å…¨ç­–ç•¥ï¼ˆå¦‚å¼ºåˆ¶ GPG æ ¡éªŒï¼‰ä¼šå¤±æ•ˆï¼Œè€Œä¸”æ›´æ–°æ—¶å®¹æ˜“å‡ºç° `InRelease not found` è­¦å‘Šã€‚









## Release æ–‡ä»¶çš„ä½œç”¨

`Release` æ–‡ä»¶æœ¬è´¨æ˜¯ä¸€ä¸ª **ç´¢å¼•æ–‡ä»¶çš„æ¸…å•+æ ¡éªŒè¡¨**ã€‚

å®ƒä¼šè®°å½•ä»“åº“ä¸­å„ä¸ª **å…ƒæ•°æ®æ–‡ä»¶**ï¼ˆæ¯”å¦‚ `Packages`, `Packages.gz`, `Sources`ï¼‰çš„ï¼š

- æ–‡ä»¶å
- å¤§å°ï¼ˆSizeï¼‰
- å“ˆå¸Œå€¼ï¼ˆMD5, SHA1, SHA256 ç­‰ï¼‰

ä¾‹å­

```yaml
MD5Sum:
 e3b0c44298fc1c149afbf4c8996fb924  0 Packages
 9e107d9d372bb6826bd81d3542a419d6  1234 Packages.gz
SHA256:
 cf83e1357eefb8bdf1542850d66d8007  0 Packages
 2d711642b726b04401627ca9fbac32f5  1234 Packages.gz
```

**æ„ä¹‰**ï¼š
 å®¢æˆ·ç«¯æ›´æ–°ä»“åº“æ—¶ï¼Œä¼šç”¨è¿™äº›å“ˆå¸Œå€¼å¯¹æ¯”ä¸‹è½½åˆ°çš„å…ƒæ•°æ®ï¼Œé˜²æ­¢ **å…ƒæ•°æ®æ–‡ä»¶è¢«ç¯¡æ”¹æˆ–æ›¿æ¢**ã€‚



## GPG ç­¾åçš„ä½œç”¨

- `Release` æ–‡ä»¶æœ¬èº«ä¹Ÿå¯èƒ½è¢«ç¯¡æ”¹ï¼ˆæ¯”å¦‚é»‘å®¢æ¢æ‰ä½ çš„æ ¡éªŒè¡¨ï¼‰ï¼Œæ‰€ä»¥ **ä¸èƒ½åªä¿¡ä»»å“ˆå¸Œå€¼**ã€‚
- GPG ç­¾åï¼ˆ`Release.gpg` æˆ– `InRelease`ï¼‰å°±æ˜¯ç”¨ç§é’¥å¯¹ `Release` æ–‡ä»¶å†…å®¹ç”Ÿæˆçš„ **æ•°å­—ç­¾å**ã€‚
- éªŒè¯æµç¨‹ï¼š
  1. å®¢æˆ·ç«¯æœ‰ä½ çš„ **å…¬é’¥**ï¼ˆæå‰å¯¼å…¥çš„ï¼‰ã€‚
  2. å®¢æˆ·ç«¯ä¸‹è½½ `Release` æ–‡ä»¶å’Œå¯¹åº”çš„ `Release.gpg` ç­¾åã€‚
  3. ç”¨å…¬é’¥è§£å¯†ç­¾åï¼ŒéªŒè¯ `Release` æ–‡ä»¶çš„å“ˆå¸ŒåŒ¹é…æ€§ï¼Œç¡®ä¿å®ƒç¡®å®æ˜¯ä½ å‘å¸ƒçš„ä¸”æœªè¢«ä¿®æ”¹ã€‚

ğŸ“Œ **æ„ä¹‰**ï¼š
 ä¿è¯ **Release æ–‡ä»¶æœ¬èº«çš„çœŸå®æ€§**ï¼ˆæ¥æºå¯ä¿¡ + æœªè¢«ç¯¡æ”¹ï¼‰ï¼Œé˜²æ­¢æ”»å‡»è€…åœ¨ä¸­é—´äººæ”»å‡»ä¸­ä¼ªé€  Releaseã€‚





![image-20250812174812418](D:\git_repository\cyber_security_learning\markdown_img\image-20250812174812418.png)











## APT è§£ç®—å™¨è¯¦è§£

### ä»€ä¹ˆæ˜¯è§£ç®—å™¨

**APT è§£ç®—å™¨**å°±æ˜¯ APT å†…éƒ¨è´Ÿè´£**å†³å®šå®‰è£…/å‡çº§å“ªäº›åŒ…å’Œç‰ˆæœ¬**çš„é‚£éƒ¨åˆ†é€»è¾‘ã€‚

- å½“ä½ æ‰§è¡Œï¼š

  ```bash
  sudo apt-get install bind9
  ```

  ä½ ä»¥ä¸ºåªæ˜¯â€œè£…ä¸€ä¸ªåŒ…â€ï¼Œä½†å®é™…ä¸Šå¯èƒ½è¦ï¼š

  - è£…ä¸Šå®ƒçš„ä¾èµ–ï¼ˆbind9-libsã€libuv1t64 ç­‰ï¼‰
  - ç§»é™¤å†²çªçš„æ—§åŒ…
  - å‡çº§æŸäº›åº“åˆ°æ–°ç‰ˆæœ¬
  - é¿å…ç ´åå·²å®‰è£…è½¯ä»¶

è¿™äº›**å†³ç­–**éƒ½æ˜¯è§£ç®—å™¨å®Œæˆçš„ã€‚



### è§£ç®—å™¨çš„ä½œç”¨

APT è§£ç®—å™¨çš„æ ¸å¿ƒä»»åŠ¡æœ‰ä¸‰ç‚¹ï¼š

1. **é€‰å€™é€‰ç‰ˆæœ¬**
   - æ¯ä¸ªåŒ…å¯èƒ½åœ¨å¤šä¸ªæºä¸­å­˜åœ¨å¤šä¸ªç‰ˆæœ¬ï¼ˆæ¯”å¦‚ main / universe / PPAï¼‰ã€‚
   - è§£ç®—å™¨è¦æŒ‰ç…§ä¼˜å…ˆçº§ï¼ˆPin-Priorityã€é»˜è®¤ç­–ç•¥ï¼‰æŒ‘ä¸€ä¸ªâ€œå€™é€‰ç‰ˆæœ¬â€ã€‚
2. **ä¾èµ–é—­åŒ…æ±‚è§£**
   - é€’å½’æ‰¾å‡ºæ‰€æœ‰ä¾èµ–ï¼Œå¹¶å½¢æˆä¸€ä¸ªä¸€è‡´çš„å®‰è£…é›†åˆã€‚
   - ä¾‹å¦‚ï¼šA â†’ B (>=2.0)ï¼ŒB â†’ C (=1.5)ã€‚è§£ç®—å™¨è¦ç¡®ä¿èƒ½æ‰¾åˆ° B=2.0 å’Œ C=1.5 çš„ç»„åˆã€‚
3. **å†²çªå¤„ç†**
   - å¦‚æœä¾èµ–æ¡ä»¶æ— æ³•åŒæ—¶æ»¡è¶³ï¼ˆæ¯”å¦‚ A éœ€è¦ C=1.5ï¼Œè€Œ D éœ€è¦ C=2.0ï¼‰ï¼Œå°±è¦å°è¯•ï¼š
     - å‡çº§ / é™çº§ / ç§»é™¤æŸäº›åŒ…
     - æˆ–è€…ç›´æ¥å¤±è´¥ï¼ˆæŠ¥â€œä¿æŒç°çŠ¶â€ï¼‰



### è§£ç®—å™¨çš„åŸç†ï¼ˆAPT çš„å®ç°ç‰¹ç‚¹ï¼‰

APT è§£ç®—å™¨ä¸æ˜¯ä¸€ä¸ªâ€œå®Œç¾æ±‚è§£å™¨â€ï¼ˆå¹¶é SAT/SMT å…¨é¢æœç´¢ï¼‰ï¼Œè€Œæ˜¯**è´ªå¿ƒ + å›é€€**ç­–ç•¥ï¼š

1. **ç”Ÿæˆå€™é€‰é›†åˆ**ï¼š

   - ç”¨ `apt-cache policy` å¯ä»¥çœ‹åˆ°å€™é€‰ã€‚

   - è§„åˆ™ï¼šPin ä¼˜å…ˆçº§ > ç‰ˆæœ¬å· > å·²å®‰è£…ã€‚

     > ```bash
     > [root@devops-custom ~]# apt-cache policy bind9
     > bind9:
     >   å·²å®‰è£…ï¼š(æ— )
     >   å€™é€‰ï¼š 1:9.18.30-0ubuntu0.22.04.2
     >   ç‰ˆæœ¬åˆ—è¡¨ï¼š
     >      1:9.18.30-0ubuntu0.22.04.2 500
     >         500 http://mirrors.aliyun.com/ubuntu jammy-security/main amd64 Packages
     >         500 http://mirrors.aliyun.com/ubuntu jammy-updates/main amd64 Packages
     >      1:9.18.1-1ubuntu1 500
     >         500 http://mirrors.aliyun.com/ubuntu jammy/main amd64 Packages
     > ```
     >
     > **å„å­—æ®µçš„å«ä¹‰**
     >
     > - **bind9:**
     >    æŸ¥è¯¢çš„åŒ…åã€‚
     > - **å·²å®‰è£…ï¼š(æ— )**
     >    è¯´æ˜ç³»ç»Ÿé‡Œç°åœ¨**æ²¡æœ‰å®‰è£… bind9**ã€‚
     > - **å€™é€‰ï¼š 1:9.18.30-0ubuntu0.22.04.2**
     >    è¿™æ˜¯ APT è§£ç®—å™¨æŒ‘å‡ºæ¥çš„**å€™é€‰ç‰ˆæœ¬**ï¼ˆCandidateï¼‰ï¼Œå³å¦‚æœä½ ç›´æ¥ `apt-get install bind9`ï¼Œä¼šè£…çš„ç‰ˆæœ¬ã€‚
     >   - å€™é€‰ç‰ˆæœ¬æ˜¯é€šè¿‡ **ä¼˜å…ˆçº§ (Pin-Priority)** + **ç‰ˆæœ¬å·** è§„åˆ™é€‰å‡ºæ¥çš„ã€‚
     >   - è¿™é‡Œé€‰ä¸­äº† `9.18.30-0ubuntu0.22.04.2`ã€‚
     > - **ç‰ˆæœ¬åˆ—è¡¨ (Version table)**
     >    ç³»ç»Ÿå¯è§çš„æ‰€æœ‰ç‰ˆæœ¬ï¼Œä»¥åŠå®ƒä»¬å„è‡ªçš„ä¼˜å…ˆçº§å’Œæ¥æºï¼š
     >   1. `1:9.18.30-0ubuntu0.22.04.2 500`
     >      - ç‰ˆæœ¬å·ï¼š`9.18.30-0ubuntu0.22.04.2`
     >         å‰é¢çš„ `1:` æ˜¯ **Debian/Ubuntu çš„ epoch**ï¼ˆç”¨æ¥åœ¨ç‰ˆæœ¬å·æ¯”è¾ƒæ—¶å¼ºåˆ¶æ›´é«˜ï¼‰ã€‚
     >      - ä¼˜å…ˆçº§ (Pin-Priority)ï¼š`500`
     >         é»˜è®¤å¯ç”¨çš„æºé‡Œï¼Œæ™®é€šåŒ…éƒ½æ˜¯ 500ã€‚
     >      - æ¥æºï¼šæ¥è‡ª `jammy-security` å’Œ `jammy-updates` ä¸¤ä¸ªæºï¼ˆUbuntu 22.04 çš„å®‰å…¨æ›´æ–°ä¸å¸¸è§„æ›´æ–°é€šé“ï¼‰ã€‚
     >   2. `1:9.18.1-1ubuntu1 500`
     >      - æ—§ç‰ˆæœ¬ï¼š`9.18.1-1ubuntu1`ã€‚
     >      - ä¹Ÿæœ‰ä¼˜å…ˆçº§ 500ã€‚
     >      - æ¥æºï¼š`jammy/main`ï¼ˆ22.04 çš„æœ€åˆç‰ˆæœ¬ï¼‰ã€‚



1. **å°è¯•æ„é€ ä¾èµ–é—­åŒ…**ï¼š
   - æŠŠè¯·æ±‚åŒ… + å®ƒçš„ä¾èµ–è£…è¿›é›†åˆï¼Œæ£€æŸ¥æ˜¯å¦æ»¡è¶³ã€‚
2. **é‡åˆ°å†²çªæ—¶çš„ç­–ç•¥**ï¼š
   - å¦‚æœèƒ½é€šè¿‡å‡çº§/é™çº§/ç§»é™¤è§£å†³ â†’ å°è¯•æ‰§è¡Œã€‚
   - å¦‚æœç”¨æˆ· hold/pin é˜»æ­¢äº†è§£ç®—å™¨åŠ¨æŸä¸ªåŒ… â†’ å°±ä¼šæŠ¥é”™ â€œè¦æ±‚ä¿æŒç°çŠ¶â€ã€‚
   - å¦‚æœå®Œå…¨æ— è§£ â†’ æŠ¥ â€œæ— æ³•å®‰è£…å®ƒâ€ã€‚

âš ï¸ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `apt-get` æœ‰æ—¶å¤±è´¥ï¼Œè€Œ `aptitude`ï¼ˆå¦ä¸€ä¸ªå‰ç«¯ï¼Œè§£ç®—æ›´æ™ºèƒ½ï¼‰èƒ½ç»™ä½ å¤šä¸ªâ€œæ–¹æ¡ˆâ€å¯é€‰ã€‚



#### æŸ¥çœ‹è§£ç®—å™¨æ‰§è¡Œè¿‡ç¨‹

```bash
# ä¼šæ˜¾ç¤ºè§£ç®—å™¨åœ¨å°è¯•å“ªäº›å‡çº§/é™çº§/ç§»é™¤ï¼Œä»¥åŠä¸ºä»€ä¹ˆå¤±è´¥ã€‚
sudo apt-get install bind9 -o Debug::pkgProblemResolver=1
```





### hold å’Œ pin çŠ¶æ€è§£æ

#### `hold` â€”â€” é”å®šåŒ…å½“å‰çŠ¶æ€

- **æ¥æº**ï¼š`apt-mark hold <pkg>` å‘½ä»¤ã€‚
- **ä½œç”¨**ï¼šå‘Šè¯‰ APT **ä¿æŒå½“å‰ç‰ˆæœ¬**ï¼Œä¸å…è®¸å‡çº§/é™çº§/è‡ªåŠ¨ç§»é™¤ã€‚
- **èŒƒå›´**ï¼šä»…é’ˆå¯¹â€œå·²å®‰è£…çš„åŒ…â€ã€‚
- **å­˜å‚¨ä½ç½®**ï¼šå†™å…¥ `/var/lib/apt/extended_states`ã€‚
- **å…¸å‹åœºæ™¯**ï¼š
  - ä½ ä¸æƒ³æŸä¸ªæ ¸å¿ƒåŒ…è¢«ç³»ç»Ÿæ›´æ–°åŠ¨ã€‚
  - ä¾‹å¦‚ï¼š`apt-mark hold nginx` â†’ ä»Šå `apt upgrade` ä¸ä¼šåŠ¨ nginxã€‚

ç¤ºä¾‹ï¼š

```bash
apt-mark hold nginx        # é”ä½
apt-mark showhold          # æŸ¥çœ‹
apt-mark unhold nginx      # è§£é”
```

æ‰€ä»¥æŠ¥é”™é‡Œæåˆ°çš„â€œè¦æ±‚æŸäº›è½¯ä»¶åŒ…ä¿æŒç°çŠ¶â€ï¼Œå°±æŒ‡ï¼šAPT å‘ç°è¦è§£å†³ä¾èµ–å¿…é¡»å‡çº§æŸä¸ªåŒ…ï¼Œä½†å®ƒåœ¨ hold çŠ¶æ€ â†’ APT ä¸æ•¢åŠ¨ï¼Œå°±ç›´æ¥æ”¾å¼ƒã€‚



#### `pin` â€”â€” æ”¹å˜å€™é€‰ç‰ˆæœ¬çš„ä¼˜å…ˆçº§ï¼ˆPin-Priorityï¼‰

- **æ¥æº**ï¼šAPT çš„ **Pinning æœºåˆ¶**ï¼Œé…ç½®åœ¨ `/etc/apt/preferences` æˆ– `/etc/apt/preferences.d/*.pref`ã€‚
- **ä½œç”¨**ï¼šæ§åˆ¶**æ¥è‡ªä¸åŒç‰ˆæœ¬/æ¥æºçš„åŒ…**çš„å€™é€‰ä¼˜å…ˆçº§ï¼Œä»è€Œå†³å®šè£…å“ªä¸ªç‰ˆæœ¬ã€‚
- **èŒƒå›´**ï¼šå½±å“æ‰€æœ‰ç‰ˆæœ¬ï¼ˆæ— è®ºæ˜¯å¦å®‰è£…ï¼‰ã€‚
- **å…¸å‹åœºæ™¯**ï¼š
  - ä½ æƒ³è®©ç³»ç»Ÿåªç”¨ `stable` æºçš„åŒ…ï¼Œå³ä½¿æœ‰ `testing` æºã€‚
  - ä½ æƒ³å¼ºåˆ¶æŸåŒ…ä½¿ç”¨ PPA æä¾›çš„æ›´æ–°ç‰ˆæœ¬ã€‚

é…ç½®ç¤ºä¾‹ï¼š

```ini
Package: nginx
Pin: release a=noble
Pin-Priority: 1001
```

- è¿™è¡¨ç¤ºï¼šå¯¹ `nginx` åŒ…ï¼Œä¼˜å…ˆä½¿ç”¨ noble å‘è¡Œç‰ˆçš„ç‰ˆæœ¬ï¼Œå¹¶ä¸”ä¼˜å…ˆçº§æé«˜ï¼ˆ>1000 è¡¨ç¤ºå³ä¾¿æ˜¯é™çº§ä¹Ÿå¼ºåˆ¶æ‰§è¡Œï¼‰ã€‚

APT çš„ä¼˜å…ˆçº§é˜ˆå€¼ï¼ˆå¸¸ç”¨è§„åˆ™ï¼‰ï¼š  

- **>1000**ï¼šå³ä½¿é™çº§ä¹Ÿè¦ç”¨
- **990â€“1000**ï¼šå¦‚æœæ¥æºç‰ˆæœ¬æ¯”å·²è£…æ–° â†’ å‡çº§
- **500**ï¼šæ™®é€šå€™é€‰ç‰ˆæœ¬
- **100**ï¼šä»…ä¿ç•™å·²å®‰è£…ç‰ˆæœ¬
- **<0**ï¼šæ°¸ä¸é€‰ç”¨



#### ä¸€å¥è¯è®°å¿†

```bat
hold = ä¸åŠ¨ â†’ â€œåˆ«å‡çº§/é™çº§è¿™ä¸ªåŒ…â€ã€‚
pin = å€¾å‘ â†’ â€œä»å“ªä¸ªæ¥æº/å“ªä¸ªç‰ˆæœ¬è£…è¿™ä¸ªåŒ…â€
```







## APTä»“åº“é—®é¢˜è§£æ

### é”™è¯¯ç¤ºä¾‹

```bash
[root@cbs0921 ~ ]# apt install -y bind9
æ­£åœ¨è¯»å–è½¯ä»¶åŒ…åˆ—è¡¨... å®Œæˆ
æ­£åœ¨åˆ†æè½¯ä»¶åŒ…çš„ä¾èµ–å…³ç³»æ ‘... å®Œæˆ
æ­£åœ¨è¯»å–çŠ¶æ€ä¿¡æ¯... å®Œæˆ
æœ‰ä¸€äº›è½¯ä»¶åŒ…æ— æ³•è¢«å®‰è£…ã€‚å¦‚æœæ‚¨ç”¨çš„æ˜¯ unstable å‘è¡Œç‰ˆï¼Œè¿™ä¹Ÿè®¸æ˜¯
å› ä¸ºç³»ç»Ÿæ— æ³•è¾¾åˆ°æ‚¨è¦æ±‚çš„çŠ¶æ€é€ æˆçš„ã€‚è¯¥ç‰ˆæœ¬ä¸­å¯èƒ½ä¼šæœ‰ä¸€äº›æ‚¨éœ€è¦çš„è½¯ä»¶
åŒ…å°šæœªè¢«åˆ›å»ºæˆ–æ˜¯å®ƒä»¬å·²è¢«ä»æ–°åˆ°(Incoming)ç›®å½•ç§»å‡ºã€‚
ä¸‹åˆ—ä¿¡æ¯å¯èƒ½ä¼šå¯¹è§£å†³é—®é¢˜æœ‰æ‰€å¸®åŠ©ï¼š

ä¸‹åˆ—è½¯ä»¶åŒ…æœ‰æœªæ»¡è¶³çš„ä¾èµ–å…³ç³»ï¼š
 bind9 : ä¾èµ–: bind9-libs (= 1:9.18.30-0ubuntu0.24.04.2) ä½†æ˜¯å®ƒå°†ä¸ä¼šè¢«å®‰è£…
         ä¾èµ–: bind9-utils (= 1:9.18.30-0ubuntu0.24.04.2) ä½†æ˜¯å®ƒå°†ä¸ä¼šè¢«å®‰è£…
         ä¾èµ–: liblmdb0 (>= 0.9.7) ä½†æ— æ³•å®‰è£…å®ƒ
         ä¾èµ–: libmaxminddb0 (>= 1.3.0) ä½†æ— æ³•å®‰è£…å®ƒ
         ä¾èµ–: libuv1t64 (>= 1.40.0) ä½†æ— æ³•å®‰è£…å®ƒ
E: æ— æ³•ä¿®æ­£é”™è¯¯ï¼Œå› ä¸ºæ‚¨è¦æ±‚æŸäº›è½¯ä»¶åŒ…ä¿æŒç°çŠ¶ï¼Œå°±æ˜¯å®ƒä»¬ç ´åäº†è½¯ä»¶åŒ…é—´çš„ä¾èµ–å…³ç³»
```



#### è§£å†³æ€è·¯

```bash
å…ˆåˆ¤æ–­è¿™ç§æƒ…å†µçš„å‡ ç§å¯èƒ½ï¼š
1. ç¼“å­˜å­˜åœ¨è„æ•°æ®ï¼Œæ¸…ç†ç¼“å­˜ï¼Œåˆ é™¤æ—§ç¼“å­˜æ–‡ä»¶ï¼Œé‡æ–°å»ºç«‹ç¼“å­˜ç´¢å¼•
	apt clean
	rm -rf /var/lib/apt/lists/*
	apt update
	
2. æœ‰è¢«holdçš„è½¯ä»¶ï¼Œæ— æ³•å‡çº§æˆ–æ›´æ–°ä¾èµ–ç»„ä»¶
   # æŸ¥çœ‹è¢«holdçš„ç¨‹åº
   # unhold
   apt-mark showhold
   apt-mark unhold bind9 bind9-libs bind9-utils liblmdb0 libmaxminddb0 libuv1t64
   
3. ç›´æ¥æŠŠä¾èµ–ä¸€èµ·è£…ä¸Šï¼ˆè®©è§£ç®—å™¨æ›´å®¹æ˜“ï¼‰ 
apt install \
  bind9=1:9.18.30-0ubuntu0.24.04.2 \
  bind9-libs=1:9.18.30-0ubuntu0.24.04.2 \
  bind9-utils=1:9.18.30-0ubuntu0.24.04.2 \
  liblmdb0 libmaxminddb0 libuv1t64
```















# Nginx



## ä»æ•´ä½“è®¤è¯†nginx



nginxçš„äº‹ä»¶é©±åŠ¨æ¡†æ¶





















## æ€§èƒ½ä¼˜åŒ–

### ä¼˜åŒ–æ–¹æ³•è®º

<img src="D:\git_repository\cyber_security_learning\markdown_img\image-20250814115918815.png" alt="image-20250814115918815" style="zoom:150%;" />



### å¦‚ä½•é«˜æ•ˆä½¿ç”¨CPU



#### å¦‚ä½•å¢å¤§Nginxä½¿ç”¨CPUçš„æœ‰æ•ˆæ—¶é•¿



- **èƒ½å¤Ÿä½¿ç”¨å…¨éƒ¨CPUèµ„æº**
  - master-workerå¤šè¿›ç¨‹æ¶æ„
  - workerè¿›ç¨‹æ•°åº”å½“å¤§äºç­‰äºCPUæ ¸æ•°



- **Nginxè¿›ç¨‹é—´ä¸åšæ— ç”¨åŠŸæµªè´¹CPUèµ„æº**

  - workerè¿›ç¨‹ä¸åº”åœ¨ç¹å¿™æ—¶ï¼Œä¸»åŠ¨è®©å‡ºCPU

    - workerè¿›ç¨‹ä¸åº”ç”±äºäº‰æŠ¢é€ æˆèµ„æºè€—æ•£

      > workerè¿›ç¨‹æ•°é‡åº”å½“ç­‰äºCPUæ ¸æ•°
      >
      > ```nginx
      > worker_processes number|auto
      > ```

    - workerè¿›ç¨‹ä¸åº”è°ƒç”¨ä¸€äº›APIå¯¼è‡´ä¸»åŠ¨è®©å‡ºCPU

      > æ‹’ç»ç±»ä¼¼çš„ç¬¬ä¸‰æ–¹æ¨¡å—



- **ä¸è¢«å…¶ä»–è¿›ç¨‹äº‰æŠ¢èµ„æº**
  - æå‡ä¼˜å…ˆçº§å ç”¨CPUæ›´é•¿çš„æ—¶é—´
  - å‡å°‘æ“ä½œç³»ç»Ÿä¸Šæ¶ˆè€—èµ„æºçš„éNginxè¿›ç¨‹





#### ç†è§£ä¸ºä½•ä¸€ä¸ªCPUå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹



**å®è§‚ä¸Šå¹¶è¡Œï¼Œå¾®è§‚ä¸Šä¸²è¡Œ**

- æŠŠè¿›ç¨‹çš„è¿è¡Œæ—¶é—´åˆ†ä¸ºä¸€æ®µæ®µçš„æ—¶é—´ç‰‡
- OSè°ƒåº¦ç³»ç»Ÿä¾æ¬¡é€‰æ‹©æ¯ä¸ªè¿›ç¨‹ï¼Œæœ€å¤šæ‰§è¡Œæ—¶é—´ç‰‡æŒ‡å®šçš„æ—¶é•¿



**é˜»å¡APIå¼•å‘çš„æ—¶é—´ç‰‡å†…ä¸»åŠ¨è®©å‡ºCPU**

- é€Ÿåº¦ä¸ä¸€è‡´å¼•å‘çš„é˜»å¡API
  - ç¡¬ä»¶æ‰§è¡Œé€Ÿåº¦ä¸ä¸€è‡´ï¼Œä¾‹å¦‚CPUå’Œç£ç›˜
- ä¸šåŠ¡åœºæ™¯äº§ç”Ÿçš„é˜»å¡API
  - ä¾‹å¦‚åŒæ­¥è¯»ç½‘ç»œæŠ¥æ–‡



#### ç¡®ä¿è¿›ç¨‹åœ¨è¿è¡Œæ€



- <span style="color:tomato">**Rè¿è¡Œ**ï¼šæ­£åœ¨è¿è¡Œæˆ–åœ¨è¿è¡Œé˜Ÿåˆ—ä¸­ç­‰å¾…ã€‚</span>

  > æˆ‘ä»¬åº”è¯¥ä¿æŒæˆ‘ä»¬çš„nginxè¿›ç¨‹å°½é‡å¤„äºRè¿è¡ŒçŠ¶æ€

- **Sä¸­æ–­**ï¼šä¼‘çœ ä¸­ï¼Œå—é˜»ï¼Œåœ¨ç­‰å¾…æŸä¸ªæ¡ä»¶çš„å½¢æˆæˆ–æ¥å—ä¿¡å·ã€‚

  > è¿›ç¨‹è¿›å…¥é˜»å¡é€šå¸¸æ˜¯Sçš„çŠ¶æ€

- **Dä¸å¯ä¸­æ–­**ï¼šæ”¶åˆ°ä¿¡å·ä¸å”¤é†’å’Œä¸å¯è¿è¡Œï¼Œè¿›ç¨‹å¿…é¡»ç­‰å¾…ç›´åˆ°æœ‰ä¸­æ–­å‘ç”Ÿã€‚





#### å°½é‡å‡å°‘è¿›ç¨‹é—´åˆ‡æ¢

**ä½•ä¸ºè¿›ç¨‹é—´åˆ‡æ¢**ï¼šæ˜¯æŒ‡CPUä»ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹æˆ–çº¿ç¨‹

ç±»åˆ«ï¼š

- ä¸»åŠ¨åˆ‡æ¢
- è¢«åŠ¨åˆ‡æ¢ï¼šæ—¶é—´ç‰‡è€—å°½

Cost: <5us



**è¾ƒå°‘ä¸»åŠ¨åˆ‡æ¢**ï¼š

- workerè¿›ç¨‹æ•°é‡åº”å½“ç­‰äºCPUæ ¸æ•°
- workerè¿›ç¨‹ä¸åº”è°ƒç”¨ä¸€äº›APIå¯¼è‡´ä¸»åŠ¨è®©å‡ºCPUï¼ˆæ‹’ç»ç±»ä¼¼çš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼‰

**å‡å°‘è¢«åŠ¨åˆ‡æ¢ï¼š**

- å¢å¤§è¿›ç¨‹ä¼˜å…ˆçº§(æœ¬è´¨ä¸Šæ˜¯å¢å¤§æ—¶é—´ç‰‡)

  > ```nginx
  > worker_priority -10
  > ```





**å¦‚ä½•æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°**

```bash
# æŸ¥çœ‹ç³»ç»Ÿè¿‡çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°
Vmstat   ---> æŸ¥çœ‹cs
Dstat    ---> æŸ¥çœ‹csw

# æŸ¥çœ‹è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°
# ç”Ÿäº§ç¯å¢ƒå°½é‡ä½¿cså°½é‡æ¯”è¾ƒä½
Pidstat -w -p <pid> ---> æŸ¥çœ‹cswch/s:ä¸»åŠ¨åˆ‡æ¢ï¼Œnscswch/s
```





### å¤šæ ¸é—´è´Ÿè½½å‡è¡¡







### æ§åˆ¶ä¸‰æ¬¡æ¡æ‰‹å‚æ•°



#### SYN_SENTçŠ¶æ€ï¼ˆnginxä½œä¸ºåå‘ä»£ç†ï¼Œå¯¹äºä¸Šæ¸¸æ˜¯å®¢æˆ·ç«¯ï¼‰

```bash
net.ipv4.tcp_syn_retries=6               # ä¸»åŠ¨å»ºç«‹è¿æ¥æ—¶ï¼Œå‘SYNçš„é‡è¯•æ¬¡æ•°
```

> `net.ipv4.tcp_syn_retries` å†³å®š **ä¸»åŠ¨å‘èµ·è¿æ¥ï¼ˆconnect()ï¼‰æ—¶**ï¼Œå†…æ ¸åœ¨**æ²¡æœ‰æ”¶åˆ° SYN+ACK** æ—¶ï¼ŒSYN æŠ¥æ–‡ä¼šé‡è¯•çš„æ¬¡æ•°ã€‚
>
> é»˜è®¤å€¼åœ¨å¾ˆå¤š Linux å‘è¡Œç‰ˆä¸Šæ˜¯ **6**ï¼Œè¿™æ„å‘³ç€ï¼š
>
> - ç¬¬ä¸€æ¬¡å‘ SYNï¼Œæ²¡æ”¶åˆ°å›åº” â†’ ç­‰ä¸€æ®µæ—¶é—´å†å‘ä¸€æ¬¡ï¼›
> - è¿™ä¸ªæ—¶é—´æ˜¯**æŒ‡æ•°é€€é¿**ï¼ˆRTO å€å¢ï¼‰ï¼Œæ€»å…±å‘ **1 æ¬¡åˆå§‹ SYN + 6 æ¬¡é‡è¯•**ï¼›
> - æ¯æ¬¡ç­‰å¾…æ—¶é—´å¤§è‡´æŒ‰ RFC6298 ç®—ï¼Œ6 æ¬¡ä¸‹æ¥å¤§çº¦ **63 ç§’å·¦å³æ‰æ”¾å¼ƒè¿æ¥**ï¼ˆä¸åŒå†…æ ¸ç•¥æœ‰å·®å¼‚ï¼‰ã€‚
>
> è¿™ä¸ªé€»è¾‘åœ¨ Nginx åœºæ™¯é‡Œå¯¹åº”ï¼š
>
> - Nginx ä½œä¸º**åå‘ä»£ç†**æˆ–**ä¸»åŠ¨å¥åº·æ£€æŸ¥**æ—¶ï¼Œworker è¿›ç¨‹è°ƒç”¨ `connect()` åˆ°ä¸Šæ¸¸ï¼ˆupstreamï¼‰ï¼›
> - å¦‚æœä¸Šæ¸¸ IP å¯è¾¾ä½†ç«¯å£æœªå“åº”ã€é“¾è·¯ä¸¢åŒ…ã€æˆ–è€… SYN è¢«é˜²ç«å¢™ä¸¢å¼ƒ â†’ å°±ä¼šè§¦å‘å†…æ ¸çš„ SYN é‡è¯•æœºåˆ¶ã€‚
>
> åœ¨**é«˜å¹¶å‘ã€ä½å»¶è¿Ÿè¦æ±‚**çš„åœºæ™¯ä¸‹ï¼š
>
> - **é»˜è®¤ 6 æ¬¡é‡è¯•ï¼ˆ>60 ç§’ï¼‰å¤ªé•¿**ï¼Œä¼šè®©â€œå·²ä¸å¯ç”¨â€çš„ä¸Šæ¸¸å ç€è¿æ¥èµ„æºå¾ˆä¹…ï¼›
> - å¯¹åä»£æ¥è¯´ï¼Œè¿™ç§è¿æ¥ä¼šå¡ä½ä¸€ä¸ª worker çš„ä¸Šæ¸¸è¿æ¥æ§½ä½ï¼ˆå èµ„æºï¼‰ã€å»¶è¿Ÿå“åº”ï¼›
> - ç‰¹åˆ«æ˜¯åœ¨**å¥åº·æ£€æŸ¥**æˆ–**çŸ­è¶…æ—¶ API**é‡Œï¼Œé•¿æ—¶é—´ç­‰ SYN è¶…æ—¶æ¯«æ— æ„ä¹‰ï¼Œå› ä¸ºï¼š
>   - ä¸šåŠ¡é€»è¾‘å·²ç»è¦æ±‚ 1~3 ç§’å†…è¿”å›å¤±è´¥ï¼›
>   - ä¸Šæ¸¸æŒ‚äº†å°±åº”è¯¥å°½å¿« failover æˆ–èµ°å¤‡æœºï¼›
>   - é•¿é‡è¯•åè€Œæµªè´¹è¿æ¥ã€æ‹–æ…¢å›é€€æœºåˆ¶ã€‚
>
> æ‰€ä»¥ä¼˜åŒ–å»ºè®®ä¹‹ä¸€æ˜¯ï¼š
>
> - **é™ä½ `tcp_syn_retries` åˆ° 2~3**ï¼ˆæ€»è¶…æ—¶ 3~7 ç§’å·¦å³ï¼‰ï¼Œè®© connect å°½å¿«å¤±è´¥ï¼›
> - è¿™æ · Nginx å¯ä»¥æ›´å¿«æŠŠè¯·æ±‚åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå¯ç”¨ upstream



```bash
net.ipv4.ip_local_range=32768 60999      # å»ºç«‹è¿æ¥æ—¶çš„æœ¬åœ°ç«¯å£å¯ç”¨èŒƒå›´
```

> å¯¹äºåå‘ä»£ç†çš„åœºæ™¯ï¼Œnginxçš„ä¸Šæ¸¸ipå’ŒPortæ˜¯ç¡®å®šçš„ï¼Œæœ¬åœ°IPä¹Ÿæ˜¯ç¡®å®šçš„ï¼Œå› æ­¤ç«¯å£èŒƒå›´å°±æˆäº†å¹¶å‘è¿æ¥çš„ç“¶é¢ˆã€‚
>
> å› æ­¤åœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œç«¯å£èŒƒå›´è¦æ”¾å¤§ã€‚



#### ä¸»åŠ¨å»ºç«‹è¿æ¥æ—¶åº”ç”¨å±‚è¶…æ—¶æ—¶é—´

```nginx
Syntax: proxy_connect_timeout time;
Default: proxy_connect_timeout 60s;
Context: http,server,location
```

```nginx
Syntax: proxy_connect_timeout time;
Default: proxy_connect_timeout 60s;
Context: stream,server
```

> ä¼˜åŒ–åŸå› å’Œä¸Šé¢ä¸€æ ·ï¼Œ**å¯ä»¥æ¦‚æ‹¬ä¸º**ï¼š**åŠ å¿«å¤±è´¥æ£€æµ‹ï¼Œé‡Šæ”¾èµ„æºï¼Œæå‡æ•…éšœåˆ‡æ¢é€Ÿåº¦**ã€‚



**ä¼˜å…ˆçº§**

å¦‚æœ **`proxy_connect_timeout` < å†…æ ¸ SYN è¶…æ—¶** â†’ Nginx æå‰æ”¾å¼ƒè¿æ¥ï¼ˆNginx ä¼˜å…ˆï¼‰ã€‚

å¦‚æœ **`proxy_connect_timeout` â‰¥ å†…æ ¸ SYN è¶…æ—¶** â†’ ç­‰å†…æ ¸è¶…æ—¶ï¼ŒNginx æ‰å¾—åˆ°å¤±è´¥ç»“æœï¼ˆå†…æ ¸ä¼˜å…ˆï¼‰ã€‚





#### SYN_RCVDçŠ¶æ€ï¼ˆæœåŠ¡å™¨ç«¯ï¼‰

```nginx
net.ipv4.tcp_max_syn_backlog                 # SYN_REVDçŠ¶æ€è¿æ¥çš„æœ€å¤§ä¸ªæ•°
```

```nginx
net.ipv4.tcp_synack_retries                  # è¢«åŠ¨å»ºç«‹è¿æ¥æ—¶ï¼Œå‘SYN/ACKçš„é‡è¯•æ¬¡æ•°
```







### å»ºç«‹TCPè¿æ¥çš„ä¼˜åŒ–

#### åŸºäºä¸‰æ¬¡æ¡æ‰‹åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­çš„ä¼˜åŒ–é…ç½®

```bash
# åŠè¿æ¥é‡è¯•æ¬¡æ•°
net.ipv4.tcp_synack_retries = 2        # 2 æ¬¡ï¼Œå¤§çº¦ 6 ç§’å·¦å³é‡Šæ”¾

# æ‰“å¼€ SYN cookiesï¼ˆé˜Ÿåˆ—æ»¡æ—¶æŠ— floodï¼‰
net.ipv4.tcp_syncookies = 1

# å¢å¤§åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦
net.ipv4.tcp_max_syn_backlog = 262144

# æé«˜å·²å®Œæˆè¿æ¥çš„ accept é˜Ÿåˆ—é•¿åº¦
net.core.somaxconn = 65535
```

**nginxç«¯**

```bash
listen 443 reuseport backlog=65535
```





#### ä¸€åˆ‡çš†æ–‡ä»¶ï¼šå¥æŸ„æ•°ä¸Šé™

**è°ƒæ•´ worker_rlimit_nofile** 

```bash
#nginxå¯åŠ¨åï¼Œæ¯ä¸ªworkerèƒ½å¤Ÿä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦ä¸Šé™
#ä½†å› ä¸ºæ–‡ä»¶æè¿°ç¬¦ï¼ˆFDï¼‰ä¸ä»…ç”¨äºè¿æ¥ï¼Œåœ¨ Nginx worker è¿›ç¨‹é‡Œï¼ŒFD æ¶ˆè€—æ¥æºä¸»è¦æœ‰ï¼š
#- ç½‘ç»œè¿æ¥ï¼ˆsocketï¼‰ï¼Œæ¯ä¸ªå®¢æˆ·ç«¯è¿æ¥å ç”¨ 1 ä¸ª FDï¼ˆæœ‰æ—¶é•¿è¿æ¥ã€åå‘ä»£ç†è¿˜ä¼šå æ›´å¤š FDï¼‰ã€‚
#- æ—¥å¿—æ–‡ä»¶ï¼ˆaccess.logã€error.logï¼‰ï¼Œæ¯ä¸ªæ‰“å¼€çš„æ—¥å¿—æ–‡ä»¶å ç”¨ 1 ä¸ª FDã€‚
#- é™æ€æ–‡ä»¶ï¼ˆHTMLã€å›¾ç‰‡ç­‰ï¼‰ï¼Œä¼ è¾“è¿‡ç¨‹ä¸­ä¼šæ‰“å¼€æ–‡ä»¶ FDã€‚
#- åå‘ä»£ç†/ä¸Šæ¸¸è¿æ¥ï¼Œå¦‚æœå¯ç”¨äº† upstreamï¼Œä¸€ä¸ªè¯·æ±‚å¯èƒ½å  2 ä¸ª FDï¼ˆå®¢æˆ·ç«¯ + upstream æœåŠ¡å™¨ï¼‰ã€‚
#- ä¸´æ—¶æ–‡ä»¶ï¼ˆå¤§æ–‡ä»¶ç¼“å­˜ã€proxy_temp ç­‰ï¼‰ï¼Œå ç”¨ä¸´æ—¶æ–‡ä»¶ FDã€‚

# å› æ­¤ worker_rlimit_nofile å¿…é¡»å¤§äº worker_connection

# æ“ä½œç³»ç»Ÿå…¨å±€
# åœ¨è€å†…æ ¸ä¸­ï¼Œfs.file-maxè¦ç»™å¤§ï¼Œä»–è¡¨ç¤ºæ“ä½œç³»ç»Ÿå…¨å±€èƒ½åŒæ—¶æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦æ€»æ•°ä¸Šé™ï¼ˆæ‰€æœ‰è¿›ç¨‹åŠ èµ·æ¥ï¼‰
# åœ¨æ–°å†…æ ¸ä¸­é»˜è®¤å€¼å¾ˆå¤§ï¼ŒåŸºæœ¬ä¸ç”¨ç®¡

echo "fs.file-max = 2097152" >> /etc/sysctl.conf
sysctl -p

#é™åˆ¶ç”¨æˆ·
# è¯¥æ•°æ®å—å†…æ ¸å‚æ•°`ulimit -n`æ•°é‡é™åˆ¶ï¼Œæ¥éœ€è¦è¯¥å¤–é¢çš„å…¶ä»–è®¾ç½®
# å¦‚æœæ˜¯nginxç›´æ¥å¯åŠ¨ï¼Œæ›´æ”¹/etc/security/limits.conf 
# æ›´æ”¹limits.conf
# æ·»åŠ  * hard nofile 10000
# * soft nofile 10000
# root hard nofile 10000
# root soft nofile 10000

# å¦‚æœæ˜¯systemctlå¯åŠ¨ï¼Œåˆ™æ›´æ”¹serviceæ–‡ä»¶ä¸­çš„å‚æ•°
# LimitNOFILE=100000

# é™åˆ¶è¿›ç¨‹
# ç™¾ä¸‡å¹¶å‘å»ºè®®
worker_rlimit_nofile 3200000
```



#### è®¾ç½®workerè¿›ç¨‹æœ€å¤§è¿æ¥æ•°é‡

```bash
worker_connection 65535 # è®¾ç½®å•ä¸ªå·¥ä½œè¿›ç¨‹çš„æœ€å¤§å¹¶å‘è¿æ¥æ•°,é»˜è®¤512ï¼Œå»ºè®®åŠ å¤§ï¼Œå¦åˆ™ï¼Œåªèƒ½æ¥å—æœ€å¤§æŒ‡å®šè¿æ¥æ•°ï¼Œè¶…å‡ºåˆ™ä¼šä¸¢å¼ƒè¯·æ±‚ï¼Œä¸ä¼šå¤„ç†ã€‚
```

> åŒ…æ‹¬Nginxä¸ä¸Šæ¸¸ã€ä¸‹æ¸¸é—´çš„è¿æ¥





#### æ»‘åŠ¨çª—å£ä¸ç¼“å†²åŒº

åœ¨å»ºç«‹TCPä¸‰æ¬¡æ¡æ‰‹ä¹‹åï¼Œå®¢æˆ·ç«¯å¼€å§‹ä¼ è¾“æ•°æ®ï¼Œåœ¨ä¼ è¾“æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç¬¬ä¸€ä¸ªå¿…é¡»ææ¸…æ¥šçš„å°±æ˜¯æ»‘åŠ¨çª—å£

æ»‘åŠ¨çª—å£ä¼šå½±å“åˆ°æ‰€æœ‰é™é€Ÿçš„æŒ‡ä»¤ï¼Œè€Œä¸”å®ƒä¼šå½±å“åˆ°æˆ‘ä»¬å¦‚ä½•è°ƒæ•´æˆ‘ä»¬çš„TCPè¯»å†™ç¼“å†²åŒºçš„å¤§å°ã€‚é€šè¿‡è®¾ç½®ç¼“å†²åŒºå¤§å°ï¼Œå¯ä»¥è®©å†…å­˜å’Œç½‘ç»œæ›´æœ‰æ•ˆç‡ã€‚



**åŠŸèƒ½**

- ç”¨äºé™åˆ¶è¿æ¥çš„ç½‘é€Ÿï¼Œè§£å†³æŠ¥æ–‡ä¹±åºå’Œå¯é ä¼ è¾“é—®é¢˜
- Nginxä¸­limit_rateç­‰é™é€ŸæŒ‡ä»¤çš†ä¾èµ–å®ƒå®ç°
- ç”±æ“ä½œç³»ç»Ÿå†…æ ¸å®ç°
- è¿æ¥ä¸¤ç«¯å„æœ‰å‘é€çª—å£å’Œæ¥æ”¶çª—



æš‚ç•¥



#### åŸºäºä¸‰æ¬¡æ¡æ‰‹åœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­çš„ä¼˜åŒ–é…ç½®

```bash
# åŠè¿æ¥é‡è¯•æ¬¡æ•°
net.ipv4.tcp_synack_retries = 2        # 2 æ¬¡ï¼Œå¤§çº¦ 6 ç§’å·¦å³é‡Šæ”¾

# æ‰“å¼€ SYN cookiesï¼ˆé˜Ÿåˆ—æ»¡æ—¶æŠ— floodï¼‰
net.ipv4.tcp_syncookies = 1

# å¢å¤§åŠè¿æ¥é˜Ÿåˆ—é•¿åº¦
net.ipv4.tcp_max_syn_backlog = 262144

# æé«˜å·²å®Œæˆè¿æ¥çš„ accept é˜Ÿåˆ—é•¿åº¦
net.core.somaxconn = 65535
```

**nginxç«¯**

```bash
listen 443 reuseport backlog=65535
```



**TCP çš„ Keepalive æœºåˆ¶**ï¼ˆä¸æ˜¯ LVS/VRRP é‚£ä¸ª Keepalived è½¯ä»¶ï¼‰

**ä¸»åŠ¨æ¢æµ‹å¹¶æ¸…ç†é‚£äº›å·²ç»â€œæ­»æ‰â€çš„ TCP è¿æ¥**ï¼Œé‡Šæ”¾èµ„æºï¼Œé¿å…å‡æ´»è¿æ¥å æ»¡ FD å’Œå†…å­˜ã€‚



##### èƒŒæ™¯ï¼šé«˜å¹¶å‘ Nginx å’Œâ€œå‡æ´»â€è¿æ¥

- åœ¨é«˜å¹¶å‘ç¯å¢ƒä¸‹ï¼ŒNginxï¼ˆå°¤å…¶æ˜¯åå‘ä»£ç†ï¼‰ä¼šç»´æŒå¤§é‡ TCP è¿æ¥ï¼š
  - **å®¢æˆ·ç«¯ â†” Nginx**ï¼ˆå‰ç«¯è¿æ¥ï¼‰
  - **Nginx â†” ä¸Šæ¸¸æœåŠ¡**ï¼ˆåç«¯è¿æ¥ï¼‰
- æœ‰äº›è¿æ¥çœ‹èµ·æ¥**çŠ¶æ€æ­£å¸¸**ï¼ˆå†…æ ¸ TCP çŠ¶æ€æ˜¯ ESTABLISHEDï¼‰ï¼Œä½†å®é™…ä¸Šå¯¹ç«¯æ—©å°±æ‰çº¿äº†ï¼š
  - å®¢æˆ·ç«¯è¿›ç¨‹å´©æºƒ / ç½‘ç»œæ–­äº†ï¼›
  - ä¸­é—´ NAT/é˜²ç«å¢™ä¸¢äº†æ˜ å°„ï¼›
  - ä¸Šæ¸¸æœåŠ¡å´©æºƒæ²¡å› RSTï¼›
  - åŠå¼€è¿æ¥ï¼ˆhalf-openï¼‰é•¿æ—¶é—´æ²¡äººç”¨ã€‚
- è¿™äº›â€œå‡æ´»â€è¿æ¥åœ¨å†…æ ¸é‡Œè¿˜å ç€æ–‡ä»¶æè¿°ç¬¦ã€å†…å­˜ç¼“å­˜ã€socket é˜Ÿåˆ—ï¼Œ
   **å¦‚æœæ•°é‡å¤šåˆ°æ¥è¿‘ Nginx çš„ FD ä¸Šé™ï¼Œå°±ä¼šé˜»å¡æ–°è¿æ¥å»ºç«‹**ã€‚



##### TCP Keepalive çš„ä½œç”¨

**TCP Keepalive** æ˜¯å†…æ ¸çº§çš„â€œå¿ƒè·³åŒ…â€æœºåˆ¶ï¼Œç”¨æ¥æ¢æµ‹ç©ºé—²è¿æ¥æ˜¯å¦è¿˜å­˜æ´»ï¼š

- è¿æ¥ç©ºé—²ä¸€æ®µæ—¶é—´åï¼Œå†…æ ¸ä¼šå‘ä¸€ä¸ª**ç©º ACK æ¢æµ‹åŒ…**ï¼›
- å¦‚æœå¯¹ç«¯æ— å“åº”ï¼ˆè¶…æ—¶ / RST / ICMP Unreachableï¼‰ï¼Œå†…æ ¸å°±ä¼šå…³é—­è¿™ä¸ªè¿æ¥ï¼›
- è¿™æ ·**æ­»è¿æ¥è¢«åŠæ—¶æ¸…ç†**ï¼Œèµ„æºé‡Šæ”¾å‡ºæ¥ç»™æ–°è¿æ¥ç”¨ã€‚



##### ä¸ºä»€ä¹ˆé«˜å¹¶å‘ Nginx è¦ç”¨ TCP Keepalive

åœ¨é«˜å¹¶å‘åœºæ™¯ï¼š

1. **è¿æ¥æ•°é‡å·¨å¤§**ï¼šå‡ ä¸‡åˆ°å‡ åä¸‡è¿æ¥åŒæ—¶å­˜åœ¨ï¼Œåªè¦æœ‰ 1~2% æ˜¯æ­»çš„ï¼Œå°±å¯èƒ½å æ‰ä¸Šåƒ FDã€‚
2. **åº”ç”¨å±‚æ„ŸçŸ¥ä¸åˆ°æ­»è¿æ¥**ï¼š
   - Nginx åªåœ¨æœ‰æ•°æ®äº¤äº’æ—¶æ‰èƒ½å‘ç°å¯¹ç«¯æ–­å¼€ï¼›
   - ç©ºé—²çš„é•¿è¿æ¥ï¼ˆæ¯”å¦‚ HTTP keep-aliveã€upstream keepaliveï¼‰å¯èƒ½ä¸€ç›´æ²¡æœ‰æ•°æ®äº¤æ¢ã€‚
3. **å†…æ ¸ Keepalive æ˜¯â€œæ‡’äººæ–¹æ¡ˆâ€**ï¼š
   - ä¸éœ€è¦ Nginx è‡ªå·±ç»´æŠ¤å¿ƒè·³é€»è¾‘ï¼›
   - å¯ä»¥ç»Ÿä¸€æ¢æµ‹ TCP å±‚æ‰€æœ‰è¿æ¥ï¼ˆå‰ç«¯ã€åç«¯ï¼‰ã€‚

**å¥½å¤„ï¼š**

- å¿«é€Ÿå‰”é™¤å¤±æ•ˆè¿æ¥ï¼Œé™ä½ FDã€å†…å­˜å ç”¨ï¼›
- é¿å…é•¿æ—¶é—´ç§¯å‹æ— æ•ˆè¿æ¥å¯¼è‡´ `accept()` / `connect()` å¤±è´¥ï¼›
- åœ¨ NAT ç¯å¢ƒä¸‹ï¼ŒåŠæ—¶æ¸…ç†å·²ç»è¿‡æœŸçš„æ˜ å°„è¿æ¥ï¼Œå‡å°‘â€œé»‘æ´â€é‡è¯•ã€‚



##### é…ç½®æ–¹æ³•ä¸æ—¶æœº

**å†…æ ¸å…¨å±€ï¼ˆå¯¹æ‰€æœ‰ TCP è¿æ¥ç”Ÿæ•ˆï¼‰**

```nginx
# å¼€å¯ TCP keepalive
sysctl -w net.ipv4.tcp_keepalive_time=600      # ç©ºé—² 600 ç§’åå‘æ¢æµ‹åŒ…
sysctl -w net.ipv4.tcp_keepalive_intvl=30      # æ¯éš” 30 ç§’é‡è¯•ä¸€æ¬¡
sysctl -w net.ipv4.tcp_keepalive_probes=5      # è¿ç»­ 5 æ¬¡å¤±è´¥å°±åˆ¤æ­»
```

> è¿™æ„å‘³ç€ï¼šä¸€ä¸ªè¿æ¥ç©ºé—² 10 åˆ†é’Ÿ â†’ å¼€å§‹å‘æ¢æµ‹ â†’ 2.5 åˆ†é’Ÿå†…æ²¡å›åº”å°±å…³é—­ã€‚

**Nginx åç«¯é•¿è¿æ¥ï¼ˆ`keepalive` æŒ‡ä»¤ï¼‰**

åœ¨ upstream é…ç½®ä¸­æ‰“å¼€åç«¯ TCP keepaliveï¼š

```nginx
upstream backend {
    server 10.0.0.1:8080;
    keepalive 1000;
    keepalive_timeout 60s;
    keepalive_requests 1000;
}
```

é…åˆï¼š

```nginx
proxy_socket_keepalive on;   # å¯ç”¨å†…æ ¸ TCP keepalive æ¢æµ‹
```





#### é«˜å¹¶å‘åœºæ™¯ä¸‹ä¸Šæ¸¸Keepaliveçš„è¿æ¥æ•°æ¨ç®—

1. å…ˆæŒ‰**å•å°ä¸Šæ¸¸ä¸»æœº**ä¼°ç®—éœ€è¦çš„å¹¶å‘è¿æ¥æ•°ï¼š

$$
\text{å¹¶å‘} \approx \text{è¯¥ä¸»æœºæ‰¿æ¥çš„ RPS} \times \text{ä¸Šæ¸¸å“åº”æ—¶é—´ï¼ˆå»ºè®®ç”¨ p95ï¼Œå•ä½ç§’ï¼‰}
$$

> ä¾‹å¦‚ï¼šå•å°ä¸Šæ¸¸æ‰¿ 2,000 RPSï¼Œp95=50msï¼ˆ0.05sï¼‰ â‡’ å¹¶å‘ â‰ˆ 2,000 Ã— 0.05 = **100 æ¡**ã€‚

1. å†æŠŠè¿™ä¸ªå¹¶å‘æŒ‰ **Nginx worker æ•°**å‡æ‘Šï¼ˆå› ä¸ºè¿æ¥æ± ä¸å…±äº«ï¼‰ï¼š

$$
\text{æ¯ worker çš„å¹¶å‘} \approx \frac{100}{\text{worker\_processes}}
$$

æ¯”å¦‚ 8 ä¸ª worker â‡’ æ¯ä¸ª worker â‰ˆ 12ï½13 æ¡ã€‚

1. **ç•™å‡º 20%ï½50% ä½™é‡**åšçªå‘ä¸æŠ–åŠ¨ï¼š
    æ¯ worker å¯¹è¯¥ä¸Šæ¸¸ä¸»æœºçš„ `keepalive` è®¾æˆ **å¹¶å‘Ã—(1.2ï½1.5)**ï¼Œå‘ä¸Šå–æ•´ã€‚

> ä¸Šä¾‹ï¼šæ¯ worker æ¯å°ä¸Šæ¸¸ä¸»æœºè®¾ **16ï½20** æ¯”è¾ƒç¨³å¦¥ã€‚
>  å¦‚æœä¸€ä¸ª upstream é‡Œæœ‰ 10 å°ä¸»æœºï¼Œä¸”æƒé‡å‡åŒ€ï¼Œå¤§ä½“å°±æŒ‰æ¯å°ä¸Šæ¸¸åˆ†åˆ«ç®—ã€‚

> ç²—ç•¥ç¼ºæ•°æ®æ—¶çš„ç»éªŒå€¼ï¼š
>
> - è½»é‡æ¥å£ï¼ˆp95 < 20msã€RPS å¾ˆé«˜ï¼‰ï¼š**10ï½50**/worker/host
> - å¸¸è§„ä¸šåŠ¡ï¼ˆp95 20â€“100msï¼‰ï¼š**20ï½100**/worker/host
> - é‡æ¥å£ï¼ˆp95 > 100msï¼‰ï¼šæŒ‰ä¸Šé¢å…¬å¼ç®—ï¼Œé€šå¸¸ä¼šæ˜æ˜¾ä¸Šæµ®





**æ³¨æ„äº‹é¡¹**

**ä¸Šæ¸¸ï¼ˆåº”ç”¨ä¾§ï¼‰**

- **keep-alive è¶…æ—¶**è¦ä¸ Nginx çš„è¯·æ±‚é—´éš”ç›¸åŒ¹é…ï¼ˆå¸¸è§è®¾ä¸º **60s å·¦å³**ï¼‰ã€‚è‹¥åç«¯ 15s å°±å…³è¿æ¥ï¼Œè€Œ Nginx è¿˜åœ¨æ± é‡Œï¼Œä¼šå¯¼è‡´**å¤ç”¨æ—¶è¢« RST**ã€‚
- é™åˆ¶æ¯è¿æ¥å¤„ç†çš„è¯·æ±‚æ•°ï¼ˆNginx ç«¯ `keepalive_requests`ã€ä¸Šæ¸¸å¦‚ Node/Gunicorn çš„ç›¸åº”å‚æ•°ï¼‰å¯è®¾ **100ï½1000**ï¼Œé¿å…â€œæ°¸ç”Ÿè¿æ¥â€å¯¼è‡´å¶å‘çŠ¶æ€æ³„æ¼/å†…å­˜ç¢ç‰‡é•¿æœŸç§¯ç´¯ã€‚
- ç¡®è®¤åç«¯**æœ€å¤§å¹¶å‘è¿æ¥**ä¸**æ–‡ä»¶æè¿°ç¬¦**è¶³å¤Ÿï¼ˆä¾‹å¦‚ `ulimit -n`ã€è¿›ç¨‹/çº¿ç¨‹æ± é…ç½®ï¼‰ã€‚



##### ç”Ÿäº§å»ºè®®

1. **å¯¹é½è¶…æ—¶**ï¼š
   - Nginx `proxy_read_timeout` å’Œ `keepalive_timeout` â‰¤ ä¸Šæ¸¸ç©ºé—²è¶…æ—¶
   - å¸¸è§åšæ³•æ˜¯ç»Ÿä¸€ 60sï¼Œæˆ–è€…æŒ‰ä¸šåŠ¡å‹åˆ° 15~30s
2. **TCP Keepalive æ¢æµ‹**ï¼ˆå¯é€‰ï¼‰ï¼š
   - å¦‚æœä¸Šæ¸¸å’Œ Nginx ä¹‹é—´ç½‘ç»œå®¹æ˜“è¢«é˜²ç«å¢™ä¸­æ–­ï¼Œå¯ä»¥å¯ç”¨ TCP keepaliveï¼ˆ`so_keepalive`ï¼‰ï¼Œæå‰æ¢æµ‹ç©ºé—²è¿æ¥æ˜¯å¦å¯ç”¨
   - ä½† TCP keepalive çš„æ¢æµ‹å‘¨æœŸé€šå¸¸æ˜¯åˆ†é’Ÿçº§ï¼Œä¸é€‚åˆçº¯ HTTP keepalive ç”¨é€”





### ç£ç›˜IOä¼˜åŒ–

ç›´æ¥IOï¼Œå¼‚æ­¥IOï¼Œçº¿ç¨‹æ± 



#### ç›´æ¥IOç»•è¿‡ç£ç›˜é«˜é€Ÿç¼“å­˜

![image-20250815003417107](D:\git_repository\cyber_security_learning\markdown_img\image-20250815003417107.png)





æ­£å¸¸é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨read()æ–¹æ³•ï¼Œä¼šå°†ç£ç›˜ä¸­çš„æ•°æ®å…ˆè¯»åˆ°å†…æ ¸ç¼“å†²åŒºä¸­ï¼Œç„¶åå†è®²å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºã€‚æ­¤æ—¶åšäº†ä¸¤æ¬¡æ•°æ®æ‹·è´ã€‚

è€Œå†™çš„æ—¶å€™è°ƒç”¨write()æ–¹æ³•ï¼Œæ­¤æ—¶ä¼šå°†ç”¨æˆ·ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œè¿™é‡Œä¼šæœ‰ä¸€äº›å‚æ•°å¯¹è¿™ä¸ªå†…æ ¸ç¼“å†²åŒºåšä¸€ä¸ªç­–ç•¥ï¼Œæ¯”å¦‚ï¼Œå¤šå°‘æ•°æ®ï¼Œå¤šå°‘æ—¶é—´ç»Ÿä¸€è½ç›˜ã€‚ä¹Ÿå°±æ˜¯è„é¡µå†™å›ã€‚å†™çš„è¿‡ç¨‹ï¼Œä¹Ÿå‘ç”Ÿäº†ä¸¤æ¬¡æ‹·è´ã€‚



è€Œåœ¨ç›´æ¥IOçš„è¿‡ç¨‹ä¸­ï¼Œçœç•¥äº†æ‹·è´åˆ°ç¼“å†²åŒºçš„è¿‡ç¨‹ï¼Œè€Œæ˜¯ç”¨æˆ·ç¼“å­˜åŒºç›´æ¥å’Œç£ç›˜è¿›è¡Œæ•°æ®æ‹·è´ã€‚



åœ¨æ­£äº§æ¨¡å¼ä¸‹ï¼Œå°†æ•°æ®å†™å…¥ç¼“å†²åŒºæ˜¯ç”±å¥½å¤„çš„ï¼Œä¹Ÿä¸ºå¦‚æœä¸‹æ¬¡è®¿é—®ç£ç›˜å‘½ä¸­ç¼“å­˜ï¼Œåˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨ç¼“å†²åŒºçš„æ•°æ®ï¼Œè€Œä¸ç”¨è®¿é—®ç£ç›˜ã€‚



#### é€‚ç”¨äºå¤§æ–‡ä»¶ï¼šç›´æ¥IO

å½“ç£ç›˜ä¸Šçš„æ–‡ä»¶å¤§å°è¶…è¿‡SIZEåï¼Œå¯ç”¨directIOåŠŸèƒ½ï¼Œé¿å…BufferedIOæ¨¡å¼ä¸‹ï¼Œç£ç›˜é¡µç¼“å­˜ä¸­çš„æ‹·è´æ¶ˆè€—ã€‚

```bash
Syntax:    directio size | off
Default:   directio off;
Context:   http;server;location
```

```bash
# ç›´æ¥IOçš„æ•°æ®å¯¹é½æ–¹å¼ï¼Œé€šå¸¸ä¸ç”¨æ”¹
Syntax:    directio_alignment size;
Default:   directio_alignment 512;
Context:   http;server;location
```



#### å¼‚æ­¥IO

![image-20250815004938055](D:\git_repository\cyber_security_learning\markdown_img\image-20250815004938055.png)



åœ¨ä¼ ç»Ÿæ–¹å¼ä¸­ï¼Œè¿›ç¨‹åœ¨ç”¨æˆ·ç©ºé—´è°ƒç”¨read()æ–¹æ³•ï¼Œread()åœ¨è¯»æ•°æ®çš„æ—¶å€™ï¼Œä¼šé˜»å¡ï¼Œç­‰åˆ°æ•°æ®åŠ è½½åˆ°ç”¨æˆ·ç¼“å†²åŒºåï¼Œåœ¨å”¤é†’è¿›ç¨‹ï¼Œç»§ç»­æ‰§è¡Œã€‚

è€Œåœ¨å¼‚æ­¥IOä¸­ï¼Œç”¨æˆ·è¿›ç¨‹åœ¨è¯»å–æ•°æ®ï¼Œé˜»å¡çš„è¿‡ç¨‹ä¸­ï¼Œç”¨æˆ·ç¨‹åºå¯ä»¥å¤„ç†å…¶ä»–ä»»åŠ¡ã€‚



```nginx
Syntax: aio on | off | threads[=pool]
Default: aio off;
Context: http,server,location
```



```nginx
# é€šå¸¸æƒ…å†µä¸‹ï¼Œaio_writeæ˜¯æ²¡æœ‰å¿…è¦æ‰“å¼€çš„ï¼Œå› ä¸ºå†™å…¥ç£ç›˜é«˜é€Ÿç¼“å­˜å¾ˆå¿«
# æ‰€ä»¥é€šå¸¸ï¼Œä»…åœ¨ä¸€ç§æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨aio_writeï¼Œæˆ‘ä»¬æ¥å—ä¸Šæ¸¸æœåŠ¡å‘æ¥çš„å“åº”ï¼Œè€Œä¸”æˆ‘ä»¬æŠŠä¸Šæ¸¸æœåŠ¡çš„å“åº”æ‰“å¼€äº†proxy_buffer,æŠŠå®ƒè®°å½•åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ï¼Œåªæœ‰åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬æ‰ä½¿ç”¨aio_write
Syntax: aio_write on|off
Default: aio_write off;
Context: http,server,location
```





#### å¼‚æ­¥è¯»IOçº¿ç¨‹æ± 

![image-20250815005850812](D:\git_repository\cyber_security_learning\markdown_img\image-20250815005850812.png)





è¦å¯ç”¨çº¿ç¨‹æ± ï¼Œå¿…é¡»ç¼–è¯‘çš„æ—¶å€™åŠ `--with-threads`



æ­£å¸¸æƒ…å†µä¸‹ï¼Œä»»åŠ¡ä¼šåœ¨äº‹ä»¶é©±åŠ¨æ¡†æ¶ä¸‹æ‰§è¡Œï¼Œä½†æ˜¯å¯¹äºä¸€äº›æœ‰çš„ä»»åŠ¡çš„æ‰§è¡Œï¼Œæˆ‘ä»¬è®¤ä¸ºå®ƒå¯èƒ½ä¼šé˜»å¡ä½ï¼Œæ—¢ç„¶å®ƒå¯èƒ½é˜»å¡ï¼Œå°±è¦é¿å…è®©å®ƒé˜»å¡åˆ°è¿›ç¨‹é‡Œã€‚æ‰€ä»¥æ´¾ç”Ÿå‡ºä¸€å †çº¿ç¨‹ã€‚

æ´¾ç”Ÿå‡ºä¸€å †çº¿ç¨‹åï¼Œæ¯”å¦‚å¦‚å›¾æ´¾ç”Ÿå‡ºä¸‰ä¸ªçº¿ç¨‹ã€‚æ´¾ç”Ÿå‡ºä¸‰ä¸ªçº¿ç¨‹åï¼Œä½¿ç”¨ä¸€ä¸ªç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ï¼Œç”Ÿäº§è€…æ˜¯å°±æ˜¯worker processesï¼Œç”Ÿäº§ä¸€ä¸ªNEW TASKï¼Œå¹¶å°†è¯¥TASKæ”¾åˆ°ä¸€ä¸ªTASK QUEUEï¼Œè¿™æ ·ä¸€ä¸ªå…ˆå…¥å…ˆå‡ºçš„æ¨¡å‹ã€‚çº¿ç¨‹ä¼šä»é˜Ÿåˆ—ä¸­æŠ¢å‡ºä¸€ä¸ªä»»åŠ¡å»æ‰§è¡Œã€‚æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šé˜»å¡ä½çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œåå°±ä¼šç»§ç»­å¾€ä¸‹èµ°ï¼Œæœ€åæ‰”åˆ°worker Processesè¿›è¡Œéé˜»å¡æ“ä½œã€‚



é¦–å…ˆä¸ºä»€ä¹ˆä¼šå­˜åœ¨Tread Poolåœºæ™¯ï¼Ÿ

æˆ‘ä»¬çŸ¥é“nginxä¸­ï¼Œå®˜æ–¹çš„æ¨¡å—éƒ½æ˜¯éé˜»å¡çš„ï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°é˜»å¡å‘¢ï¼Ÿ

è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬çš„nginxåšé™æ€èµ„æºçš„æ—¶å€™ï¼Œå¦‚æœå¤„ç†äº†å¤ªå¤šçš„æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ç”±äºç‰¹åˆ«å¤šï¼Œå¯¼è‡´ç¼“å­˜inodeå¤±æ•ˆï¼ˆå› ä¸ºå†…å­˜ä¸å¤Ÿå¤§ï¼‰ï¼Œæ‰€ä»¥ï¼Œå¤§éƒ¨åˆ†æ“ä½œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¼šå‘½ä¸­ç¼“å­˜ã€‚ä¸ä¼šé˜»å¡ï¼Œä½†åœ¨è¿™ç§åœºæ™¯ä¸‹ï¼Œä¼šå¯èƒ½å‡ºç°é˜»å¡ã€‚

åœ¨nginxçš„ä¸€ç¯‡å¾ˆæœ‰åçš„åšå®¢ä¸­ï¼Œä»‹ç»äº†è¿™é‡Œä¼šæœ‰ä¸€ä¸ª9å€çš„æ€§èƒ½æå‡ã€‚



#### å®šä¹‰çº¿ç¨‹æ± 

```bash
# ä»…ç”¨äºåœ¨å¤„ç†é™æ€èµ„æºçš„æ—¶å€™ï¼Œè¯»å–æ–‡ä»¶
Syntax:    tread_pool name threads=number [max_queue=number];
Default:   tread_pool default_threads=32 max_queue=65536;
Context    main
```



#### å¼‚æ­¥IOä¸­çš„ç¼“å­˜

å°†ç£ç›˜æ–‡ä»¶è¯»å…¥ç¼“å­˜ä¸­ç­‰å¾…å¤„ç†ï¼Œä¾‹å¦‚gzipæ¨¡å—ä¼šä½¿ç”¨ã€‚

```bash
Syntax: output_buffers number size;
Default: output_buffers 2 32k;
Context: http;server;location
```



#### æ¨èè½åœ°é…ç½®

```nginx
# å…¨å±€ï¼šçº¿ç¨‹æ± 
thread_pool default threads=32 max_queue=65536;

http {
    # å°/çƒ­æ–‡ä»¶è·¯å¾„ï¼ˆé»˜è®¤ï¼‰ï¼šé¡µç¼“å­˜ + sendfile
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    aio threads;                 # å‘½ä¸­ miss æˆ–éœ€æ–‡ä»¶è¯»æ—¶ç”¨çº¿ç¨‹æ± åšï¼Œé¿å…å¡ worker

    # é™æ€å°æ–‡ä»¶ä¼˜åŒ–ï¼ˆå…ƒä¿¡æ¯ï¼‰
    open_file_cache           max=200000 inactive=60s;
    open_file_cache_valid     120s;
    open_file_cache_min_uses  2;

    # å¤§/å†·æ–‡ä»¶ï¼ˆä¸‹è½½ã€è§†é¢‘ç­‰ï¼‰ä½ç½®
    server {
        listen 80 reuseport;

        location /download/ {
            root /data/www;
            # 1) å¤§æ–‡ä»¶æ‰ç›´è¯»ï¼Œé¿å…æ±¡æŸ“é¡µç¼“å­˜
            directio 4m;                     # è¶…è¿‡ 4MB å¯ç”¨ O_DIRECT
            directio_alignment 4096;         # 4K å¯¹é½æ›´é€šç”¨
            # 2) å¿…é…ï¼šçº¿ç¨‹æ± å¼‚æ­¥åŒ–
            aio threads=default;
            # 3) è¾“å‡ºç¼“å†²ï¼ˆå¯¹é½ä¸”è¶³å¤Ÿå¤§ï¼‰
            output_buffers 2 1m;
            # 4) é¡ºåºé¢„è¯» & åˆ†å—å‘é€ï¼ˆæ›´å¹³æ»‘ï¼‰
            read_ahead 1m;
            sendfile_max_chunk 4m;           # ä»…å½±å“é directio çš„åœºæ™¯ï¼›ç•™ç€ä¹Ÿæ— å®³
            # æ³¨ï¼šæœ¬ location å†…ï¼Œsendfile è‡ªåŠ¨å¤±æ•ˆï¼ˆå› ä¸º directio ç”Ÿæ•ˆï¼‰
        }
    }
}
```

å°çƒ­æ–‡ä»¶èµ° sendfile+é¡µç¼“å­˜ï¼›å¤§/å†·æ–‡ä»¶ç”¨ directioï¼›æ‰€æœ‰å¯èƒ½é˜»å¡çš„æ–‡ä»¶ I/O äº¤ç»™ `aio threads` çš„çº¿ç¨‹æ± å¤„ç†







# Tomcat
