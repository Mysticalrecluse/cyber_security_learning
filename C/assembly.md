# 汇编语言
- 学习汇编的两个根本目的

  - 充分获得底层编程的体验
  - 深刻理解机器运行程序的机理

## 基础知识
### 机器语言
- 概述：机器语言是机器指令的集合

- 机器指令：
  - 概述：机器指令展开来讲是一台机器可以正确执行命令。电子计算机的机器指令是一列二进制数字。计算机将之转变为一列高低电平，以使计算机的电子器件受到驱动，进行运算。
  - 每一种微处理器（CPU）由于硬件设计和内部结构的不同，就需要不同的电平脉冲来控制，使它工作。所以每一种微处理器都有自己的机器指令集，也就是机器语言。
  - 机器指令实例：
  ```
  8086CPU运算：s = 768 + 12288-1280,机器码如下：

  101110000000000000000011
  000001010000000000110000
  001011010000000000000101

  * 晦涩难懂，且不易查错
  ```

### 汇编语言的产生
- 汇编语言的主体是汇编指令
  - 汇编指令：是机器指令便于记忆的书写格式 
  ```
  操作：寄存器BX的内容送到AX中
  机器指令：1000100111011000
  汇编指令：mov ax, bx
  ```

- 汇编语言的执行过程：
  - 程序员用汇编语言写出程序
  - 汇编编译器将其编译为机器码
  - 最终计算机执行机器码，运行程序

### 汇编语言的组成
- 汇编语言的3类指令
  - 汇编指令：机器码的助记符，有对应的机器码
  - 伪指令：没有对应的机器码，由编译器执行，计算机并不执行
  - 其他符号：如+、-、*、/等，由编译器识别，没有对应的机器码

### CPU对存储器的读写
- CPU想进行数据的读写，必须和外部器件进行下面3类信息的交互
  - 存储单元的地址（地址信息）
  - 器件的选择，读或写的命令（控制信息）
  - 读或写的数据（数据信息）

- CPU通过总线（一根根导线的集合）将地址，数据和控制信息传到存储器芯片中

- 总线分类
  - 地址总线
    - 一个CPU有N根地址线，则可以说这个CPU的地址总线的宽度为N。这样的CPU最多可以寻找2的N次方个内存单元
  - 控制总线
  - 数据总线

- 通过总线CPU从3号单元中读取数据的过程：
```
1. CPU通过地址线将地址信息3发出
2. CPU通过控制线发出内存“读命令”，选中存储器芯片，并通知它，将要从中读取数据
3. 存储器将3号单元中的数据8通过数据线送入CPU

机器码：10100001 00000011 00000000
汇编指令：MOV AX,[3]
含义：传送3号单元的内容入AX
```

### 内存地址空间
- 主板
  - 在一台PC机中，都有一个主板，主板上有核心器件和一些主要器件，这些器件通过总线（地址总线、数据总线、控制总线）相连。这些器件有CPU、存储器、外围芯片组、扩展插槽等。扩展插槽上一般插有RAM内存条和各类接口卡

- 接口卡
  - CPU对外部设备都不能直接控制
  - 直接控制这些设备进行工作的是插在扩展插槽上的接口卡
  - 扩展插槽通过总线和CPU相连，所以接口卡也通过总线同CPU相连
  - CPU通过总线向接口卡发出命令，接口卡根据CPU的命令控制外设进行工作

- 内存地址空间
  - CPU在操作存储器时(如：RAM主存，RAM内存条，显卡，网卡，主板上的ROM，显卡的显存等)，CPU把它们都当作内存来对待，把它们总的看作一个由若干存储单元组成的逻辑存储器，这个逻辑存储器就是我们所说的内存地址空间
  - 所有物理存储器被看作一个由若干存储单元组成的逻辑存储器，每个物理存储器在这个逻辑存储器中占有一个地址段，及一段地址空间。CPU在这段地址空间中读写数据，实际上就是在相对应的物理存储器中读写数据
  - 内存地址空间的地址分段实例
  ```
  地址 0 ~ 7FFFH的32KB空间为主存的地址空间
  地址 8000H ~ 9FFFH的8KB空间为显存地址空间
  地址 A000H ~ FFFH的24KB空间为各ROM的地址空间

  CPU向内存地址1000H的内存单元写入数据，这个数据就会被写入主存中
  CPU向内存地址8000H的内存单元写入数据，这个数据就被写入显存中，然后被显卡输出到显示器上
  CPU向内存地址C000H的内存单元写入数据，操作没有结果，因为ROM只读
  ```

- 内存地址空间的大小受CPU地址总线宽度的限制

- 我们基于一个计算机硬件系统编程的时候，必须知道这个系统的内存地址空间分配情况。因为当我们想在某类存储器中读写数据的时候，必须知道<font color=tomato>它的第一个单元的地址和最后一个单元的地址</font>，才能保证读写操作在预期的存储器中进行。

```
内存地址空间

最终运行程序的是CPU，我们用汇编语言编程的时候，必须要从CPU的角度考虑问题。
对CPU来说，系统中的所有存储器中的存储单元都处于一个统一的逻辑存储器中，它的容量受CPU寻址能力的限制。这个逻辑存储器即是我们所说的内存地址空间
```

## 寄存器
- 一个典型的CPU由运算器、控制器、寄存器等器件构成，这些器件靠内部总线相连
  
- 内部总线实现CPU内部各个器件之间的联系，外部总线CPU和主板上其他器件的联系
  
- 在CPU中
  - 运算器进行信息处理
  - 寄存器进行信息存储
  - 控制器控制各种器件进行工作
  - 内部总线连接各个器件，在它们之间进行数据的传达
  
- 对于一个汇编程序员来说，CPU中的主要部件是寄存器。寄存器是CPU中程序员可以用指令读写的部件。程序员通过改变各种寄存器中的内容来实现对CPU的控制

- 不同的CPU，寄存器的个数、结构是不相同的。8086CPU有14个寄存器，这些寄存器的名字分别是
```
AX、BX、CX、DX、SI、DI、SP、BP、IP、CS、SS、DS、ES、PSW
```

### 通用寄存器
- 8086CPU的所有寄存器都是16位，可以存放两个字节。AX、BX、CX、DX这4个寄存器通常用来存放一般性数据，被称为<font color=tomato>通用寄存器</font>

- 8086的上一代CPU中的寄存器是8位，为了保证兼容，是原来基于上一代CPU编写的代码稍加修改就可以执行在8086之上，因此8086CPU的AX，BX，CX，DX这4个寄存器都可分为两个可独立使用的8位寄存器
```
AX 可分为 AH 和 AL (high, low)
BX 可分为 BH 和 BL
CX 可分为 CH 和 CL
DX 可分为 DH 和 DL
```

### 字在寄存器中的存储
- 字节：记为byte，一个字节由8个bit组成，可以存在8位寄存器中
- 字：word，一个字由2个字节组成，这两个字节分别称为这个字的高位字节和低位字节。

### 几条汇编指令
<table>
  <thead>
    <th style="background:darkred; color:white">汇编指令</th>
    <th style="background:darkred; color:white">控制CPU完成操作</th>
    <th style="background:darkred; color:white">用高级语言的语法描述</th>
  </thead>
  <tbody>
    <tr>
      <td>mov ax, 18</td>
      <td>将18送入寄存器AX</td>
      <td>AX=18</td>
    </tr>
    <tr>
      <td>mv ah, 78</td>
      <td>将78送入寄存器AH</td>
      <td>AH=78</td>
    </tr>
    <tr>
      <td>add ax, 8</td>
      <td>将寄存器AX中的数值加上8</td>
      <td>AX=AX+8</td>
    </tr>
    <tr>
      <td>mov ax, bx</td>
      <td>将寄存器BX中的数据送入寄存器AX</td>
      <td>AX=BX</td>
    </tr>
    <tr>
      <td>add ax, bx</td>
      <td>将AX和BX中的数值相加，结果存入AX中</td>
      <td>AX=AX+BX</td>
    </tr>
  </tbody>
</table>

### 物理地址
- 定义：CPU访问内存单元时，要给出内存单元的地址。所有的内存单元构成的存储空间是一个一维的线性空间，每个内存单元在这个空间都有唯一的地址，这个唯一的地址称为物理地址

### 8086给出物理地址的方法
- 方法：8086CPU有20位地址总线，可以传送20位地址，达到1MB的寻址能力，而8086CPU是16位结构，因此内部的处理传送暂存的地址为16位
  - 一次8086CPU要向20位地址总线传递地址需要有两个相关部件，提供2个16位地址
  - 一个称为段地址，一个称为偏移地址
  - 段地址和偏移地址通过内部总线传入地址加法器中
  - 地址加法器将两个16位地址合成20位地址<font color=tomato>（段地址*16+偏移地址）</font>
  - 地址加法器通过内部总线将20位物理地址送入输入输出控制电路
  - 输入输出控制电路将20位物理地址送上地址总线

### 内存单元地址小结
- CPU可以用不同的段地址和偏移地址形成同一个物理地址

- 如果给定一个段地址，仅通过变化偏移地址进行寻址，则最多定位64KB个内存单元

- 可以根据需要，将地址连续、起始地址为16的倍数的一组内存单元定义为一个段

### 段寄存器
- 段寄存器存放段地址，8086中段寄存器共有4个，分别是
```
CS、DS、SS、ES
```

### CS和IP
- 介绍：CS和IP是8086CPU中两个最关键的寄存器，它们指示了CPU当前要读取指令的地址。
  - CS是段寄存器，IP为指令指针寄存器（偏移地址）
  - 在8086PC机中，任意时刻，设CS中的内容为M，IP中的内容为N，则8086CPU将从内存M * 16 + N单元开始读取一条指令并执行
  - 也可以这样表述
    - 8086机中，任意时刻，CPU将CS:IP指向的内容当作指令执行

- 8086CPU工作过程简要描述
  - 从CS:IP指向的内存单元读取指令，读取的指令进入指令缓冲器
    - 指令缓冲器指令送入执行控制器，执行指令
  - 之后IP自动增加，IP=IP+所读取指令的长度，从而指向下一条指令
  - 执行指令（转到步骤1），重复这个过程

- 在8086加电启动或复位后（即CPU刚工作时），CS和IP被设置为CS=FFFFH, IP=0000H; 即在8086刚启动时，CPU从内存FFFF0H单元中读取指令执行，<font color=tomato>FFFF0H单元中的指令是8086PC机刚启动后执行的第一条指令</font>

- 问题1：CPU根据什么将内存中的信息看作指令：
  - 答：<font color=tomato>CPU将CS:IP指向的内存单元中的内容看作指令
</font>

- <font color=tomato>如果内存中的一段信息被CPU执行过，那么，它所在的内存单元必然被CS：IP指向过</font>

### 修改CS和IP的指令
- 在CPU中，程序员能够用指令读写的部件只有寄存器，程序员可以通过改变寄存器中的内容实现对CPU的控制。CPU从何处执行指令是由CS、IP中的内容决定的，程序员可以通过改变CS、IP中的内容来控制CPU执行目标指令。

- mov指令（被称为传送指令）
  - 可以用mov指令改变大多数寄存器的值（例如：ax,bx,cx,dx）但是不能用mov修改cs、ip

- jmp指令（转移指令）
  - 可以修改CS、IP的值
  - 同时修改CS、IP的值
  ```
  jmp 段地址: 偏移地址
  功能：用指令中的段地址修改CS，偏移地址修改IP

  jmp 2AE3:3, 执行后：CS=2AE3H, IP=0003H, CPU将从2AE33H处读取指令
  jmp 3:0B16, 执行后：CS=0003H, IP=0B16H, CPU将从00B46H处读取指令

  jump 某一合法寄存器
  功能：进修改IP

  jmp ax, 指令执行前：ax=1000H, CS=2000H, IP=0003H
          指令执行后：ax=1000H, CS=2000H, IP=1000H
          (类似于mov ip ax)
  ```

### CS，IP小结
- 段地址在8086CPU的段寄存器中存放，当8086CPU要访问内存时，由段寄存器提供内存单元的段地址。<font color=tomato>8086有4个段寄存器，其中CS用来存放指令的段地址</font>

- CS存放指令的段地址，IP存放指令的偏移地址

- 8086机中，任意时刻，CPU将CS:IP指向的内容当作指令执行

- 8086CPU提供转移指令修改CS、IP的内容（jmp）

## windows2000-debug的使用
- r命令：
  - 功能：查看和修改寄存器的状态

- d命令：
  - 功能：查看内存的状态

- e命令：
  - 功能：修改内存的数据(机器码)

- u命令：
  - 功能：查看内存单元中的机器指令和它们所对应的汇编指令

- t命令：
  - 功能：执行CS:IP指向的汇编命令，返回执行后的寄存器状态

- a命令：
  - 功能：在指定内存起始处，直接写入汇编指令，程序自动翻译成机器码，存储到内存中

